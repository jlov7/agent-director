const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-MrhOUbgC.js","assets/vendor-react-D4yGots9.js","assets/vendor-DClHNS3s.js","assets/vendor-B5DZHykP.css","assets/index-C6t_fIQh.js","assets/index-Dy4Ggd2B.js","assets/index-GxDP3Oyw.js","assets/index-BXRJTS9D.js"])))=>i.map(i=>d[i]);
import{j as t,r as l,a as Ao,R as $o}from"./vendor-react-D4yGots9.js";import{m as _o,d as ls}from"./vendor-DClHNS3s.js";(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const d of c.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&r(d)}).observe(document,{childList:!0,subtree:!0});function s(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function r(o){if(o.ep)return;o.ep=!0;const c=s(o);fetch(o.href,c)}})();const Ro="modulepreload",Oo=function(e){return"/agent-director/"+e},cs={},Gt=function(a,s,r){let o=Promise.resolve();if(s&&s.length>0){document.getElementsByTagName("link");const d=document.querySelector("meta[property=csp-nonce]"),p=(d==null?void 0:d.nonce)||(d==null?void 0:d.getAttribute("nonce"));o=Promise.allSettled(s.map(u=>{if(u=Oo(u),u in cs)return;cs[u]=!0;const f=u.endsWith(".css"),b=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${b}`))return;const y=document.createElement("link");if(y.rel=f?"stylesheet":Ro,f||(y.as="script"),y.crossOrigin="",y.href=u,p&&y.setAttribute("nonce",p),document.head.appendChild(y),f)return new Promise((x,w)=>{y.addEventListener("load",x),y.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${u}`)))})}))}function c(d){const p=new Event("vite:preloadError",{cancelable:!0});if(p.payload=d,window.dispatchEvent(p),!p.defaultPrevented)throw d}return o.then(d=>{for(const p of d||[])p.status==="rejected"&&c(p.reason);return a().catch(c)})},Po=()=>t.jsxs("svg",{className:"logo-mark",width:"54",height:"54",viewBox:"0 0 120 120",role:"img","aria-label":"Agent Director logo",children:[t.jsx("rect",{x:"8",y:"8",width:"104",height:"104",rx:"18",className:"logo-frame"}),t.jsx("rect",{x:"24",y:"28",width:"72",height:"16",rx:"6",className:"logo-bar logo-bar-a"}),t.jsx("rect",{x:"24",y:"52",width:"72",height:"16",rx:"6",className:"logo-bar logo-bar-b"}),t.jsx("rect",{x:"24",y:"76",width:"72",height:"16",rx:"6",className:"logo-bar logo-bar-c"}),t.jsx("circle",{cx:"96",cy:"36",r:"6",className:"logo-node logo-node-a"}),t.jsx("circle",{cx:"96",cy:"60",r:"6",className:"logo-node logo-node-b"}),t.jsx("circle",{cx:"96",cy:"84",r:"6",className:"logo-node logo-node-c"})]});function Lo({trace:e,traces:a=[],selectedTraceId:s,onSelectTrace:r,onReload:o,onStartTour:c,onToggleStory:d,onOpenPalette:p,onToggleExplain:u,onShareSession:f,onThemeChange:b,onMotionChange:y,themeMode:x="studio",motionMode:w="balanced",activeSessions:v=1,shareStatus:h=null,handoffStatus:k=null,explainMode:S=!1,storyActive:$=!1,mode:X="cinema",missionCompletion:E,runHealthScore:R=100,modeHotkeys:z="C / F / Space",onCreateHandoffDigest:L,onOpenSupport:q,workspaces:V=[],workspaceId:se,onWorkspaceChange:j,workspaceRole:I="operator",onWorkspaceRoleChange:O,sessionLabel:J="Active",sessionExpired:N=!1,onRenewSession:K}){const D=Math.max(0,Math.min(100,Math.round(R))),F=E?`${E.done}/${E.total} missions`:"Missions n/a";return t.jsxs("header",{className:"header","data-help":!0,"data-help-indicator":!0,"data-tour":"header","data-help-title":"Mission control","data-help-body":"Trace identity, status, and live controls live here. Use Story, Guide, or Explain to orient new viewers.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"header-title",children:[t.jsxs("div",{className:"header-logo",children:[t.jsx(Po,{}),t.jsx("span",{children:"Agent Director"})]}),t.jsx("div",{className:"header-tagline",children:"Cinematic trace intelligence for agent runs."}),t.jsxs("div",{className:"header-meta",children:[t.jsxs("span",{className:"header-run",children:["Run: ",(e==null?void 0:e.id)??"loading"]}),a.length>0?t.jsx("select",{className:"trace-select",value:s??(e==null?void 0:e.id)??"","aria-label":"Select trace",onChange:P=>r==null?void 0:r(P.target.value),"data-help":!0,"data-help-title":"Trace selector","data-help-body":"Switch between available runs to compare different sessions.","data-help-placement":"bottom",children:a.map(P=>t.jsxs("option",{value:P.id,children:[P.name," (",P.id,")"]},P.id))}):null,t.jsx("span",{className:`status-pill status-${(e==null?void 0:e.status)??"loading"}`,children:(e==null?void 0:e.status)??"loading"}),e!=null&&e.replay?t.jsxs("span",{className:"header-replay",title:`Replay from ${e.branchPointStepId??"unknown step"}`,children:["Replay: ",e.replay.strategy]}):null,t.jsxs("span",{className:"header-wall",children:["Wall: ",(e==null?void 0:e.metadata.wallTimeMs)??0,"ms"]}),t.jsxs("span",{className:"header-presence","aria-label":"Active sessions",children:["Live: ",v]}),t.jsxs("span",{className:"header-mode-pill","aria-label":"Current mode",children:["Mode: ",X]}),se?t.jsxs("span",{className:"header-workspace-pill","aria-label":"Current workspace",children:["Workspace: ",se]}):null,t.jsxs("span",{className:`header-role-pill role-${I}`,"aria-label":"Current workspace role",children:["Role: ",I]}),t.jsxs("span",{className:`header-session-pill ${N?"expired":""}`,"aria-label":"Session status",children:["Session: ",J]}),t.jsxs("span",{className:"header-hotkeys","aria-label":"Mode hotkeys",children:["Keys: ",z]}),t.jsx("span",{className:"header-mission","aria-label":"Mission completion",children:F}),t.jsxs("span",{className:"header-health","aria-label":`Run health score ${D}`,children:[t.jsx("span",{className:"header-health-bar",children:t.jsx("span",{className:"header-health-fill",style:{width:`${D}%`}})}),t.jsxs("span",{children:["Health ",D]})]}),h?t.jsx("span",{className:"header-share-status",children:h}):null,k?t.jsx("span",{className:"header-share-status",children:k}):null]})]}),t.jsxs("div",{className:"header-actions",children:[t.jsxs("label",{className:"theme-picker",children:["Workspace",t.jsx("select",{className:"trace-select",value:se,"aria-label":"Select workspace",onChange:P=>j==null?void 0:j(P.target.value),children:V.map(P=>t.jsx("option",{value:P.id,children:P.label},P.id))})]}),t.jsxs("label",{className:"theme-picker",children:["Role",t.jsxs("select",{className:"trace-select",value:I,"aria-label":"Select workspace role",onChange:P=>O==null?void 0:O(P.target.value),children:[t.jsx("option",{value:"viewer",children:"Viewer"}),t.jsx("option",{value:"operator",children:"Operator"}),t.jsx("option",{value:"admin",children:"Admin"})]})]}),t.jsxs("label",{className:"theme-picker",children:["Theme",t.jsxs("select",{className:"trace-select",value:x,"aria-label":"Select theme",onChange:P=>b==null?void 0:b(P.target.value),children:[t.jsx("option",{value:"studio",children:"Studio"}),t.jsx("option",{value:"focus",children:"Focus"}),t.jsx("option",{value:"contrast",children:"Contrast"})]})]}),t.jsxs("label",{className:"theme-picker",children:["Motion",t.jsxs("select",{className:"trace-select",value:w,"aria-label":"Select motion profile",onChange:P=>y==null?void 0:y(P.target.value),children:[t.jsx("option",{value:"cinematic",children:"Cinematic"}),t.jsx("option",{value:"balanced",children:"Balanced"}),t.jsx("option",{value:"minimal",children:"Minimal"})]})]}),t.jsx("button",{className:`ghost-button ${$?"active":""}`,type:"button",onClick:d,"aria-pressed":$,"aria-label":"Toggle story mode","data-help":!0,"data-help-title":"Story mode","data-help-body":"Auto-runs a cinematic walkthrough for demos.","data-help-placement":"bottom",children:"Story"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:c,"aria-label":"Start guided tour","data-help":!0,"data-help-title":"Guided tour","data-help-body":"Walk through the interface step by step.","data-help-placement":"bottom",children:"Guide"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:p,"aria-label":"Open command palette","data-help":!0,"data-help-title":"Command palette","data-help-body":"Search and trigger any action instantly.","data-help-placement":"bottom",children:"Command"}),t.jsx("button",{className:`ghost-button ${S?"active":""}`,type:"button",onClick:u,"aria-pressed":S,"aria-label":"Toggle explain mode","data-help":!0,"data-help-title":"Explain mode","data-help-body":"Hover any control to see contextual guidance.","data-help-placement":"bottom",children:"Explain"}),t.jsx("button",{className:"ghost-button",onClick:o,type:"button","aria-label":"Refresh traces",title:"Refresh traces","data-help":!0,"data-help-title":"Refresh","data-help-body":"Reload traces from the data store.","data-help-placement":"bottom",children:"Refresh"}),t.jsx("button",{className:`ghost-button ${N?"warn":""}`,type:"button",onClick:K,"aria-label":"Renew workspace session",title:"Renew workspace session",children:"Renew Session"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:f,"aria-label":"Copy live session link",title:"Copy live session link",children:"Share"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:L,"aria-label":"Copy session handoff digest",title:"Copy session handoff digest",children:"Handoff"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:q,"aria-label":"Open support diagnostics",title:"Open support diagnostics",children:"Support"}),t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer","data-help":!0,"data-help-title":"Help","data-help-body":"Open quick docs for first run, key flows, troubleshooting, and shortcuts.","data-help-placement":"bottom",children:"Help"}),null]})]})}function Fo({insights:e,investigation:a,onSelectStep:s,onJumpToBottleneck:r,onJumpToError:o}){var x,w,v,h,k;if(!e)return null;const c=e.timing,d=e.ioWarnings??[],p=e.concurrency,u=e.retryPatterns,f=e.costByTool??{},b=e.costByModel??{},y=((x=a==null?void 0:a.hypotheses)==null?void 0:x.slice(0,2))??[];return t.jsxs("section",{className:"insight-strip","data-help":!0,"data-help-indicator":!0,"data-tour":"insights","data-help-title":"Run insights","data-help-body":"Fast diagnostics for latency, cost, errors, and concurrency. Click chips to jump into the trace.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Top latency","data-help-body":"Largest steps by duration; jump straight to the slowest.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Top latency"}),t.jsxs("div",{className:"insight-items",children:[e.topLatencySteps.map(S=>t.jsxs("button",{className:"insight-chip",type:"button",title:`Jump to ${S.name}`,onClick:()=>s==null?void 0:s(S.stepId),children:[S.name," (",S.durationMs,"ms)"]},S.stepId)),e.topLatencySteps.length>0?t.jsx("button",{className:"insight-chip",type:"button",onClick:r,title:"Jump to longest step",children:"Jump to bottleneck"}):null]})]}),t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Cost by type","data-help-body":"Aggregated spend by step class.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Cost by type"}),t.jsx("div",{className:"insight-items",children:Object.entries(e.costByType).map(([S,$])=>t.jsxs("span",{className:"insight-chip",title:`Total cost for ${S}`,children:[S,": $",$.toFixed(3)]},S))})]}),Object.keys(f).length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Cost by tool","data-help-body":"Top tools by total spend.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Cost by tool"}),t.jsx("div",{className:"insight-items",children:Object.entries(f).sort((S,$)=>$[1]-S[1]).slice(0,3).map(([S,$])=>t.jsxs("span",{className:"insight-chip",title:`Total cost for ${S}`,children:[S,": $",$.toFixed(3)]},S))})]}):null,t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Errors & retries","data-help-body":"Instant visibility into failed or retried steps.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Errors / retries"}),t.jsxs("div",{className:"insight-items",children:[t.jsxs("span",{className:"insight-chip",children:["Errors: ",e.errors]}),t.jsxs("span",{className:"insight-chip",children:["Retries: ",e.retries]}),e.errors>0?t.jsx("button",{className:"insight-chip",type:"button",onClick:o,title:"Jump to first error",children:"Jump to first error"}):null,(w=u==null?void 0:u.topRetries)!=null&&w.length?t.jsxs("span",{className:"insight-chip",title:`Retry rate ${(u.retryRate*100).toFixed(1)}%`,children:["Top retries: ",u.topRetries.length]}):null]})]}),t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Wall vs work","data-help-body":"Wall time vs summed work to show parallelism.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Wall vs work"}),t.jsxs("div",{className:"insight-items",children:[t.jsxs("span",{className:"insight-chip",title:"Wall clock duration",children:["Wall: ",e.wallTimeMs,"ms"]}),t.jsxs("span",{className:"insight-chip",title:"Sum of step durations",children:["Work: ",e.workTimeMs,"ms"]}),e.criticalPathMs!=null?t.jsxs("span",{className:"insight-chip",title:"Longest parent-child chain",children:["Critical: ",e.criticalPathMs,"ms"]}):null]})]}),t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Health","data-help-body":"Timing and I/O anomalies detected in the trace.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Health"}),t.jsxs("div",{className:"insight-items",children:[c!=null&&c.degraded?t.jsx("span",{className:"insight-chip insight-warning",title:c.issues.join(" "),children:"Timing degraded"}):t.jsx("span",{className:"insight-chip",children:"Timing OK"}),d.length>0?t.jsxs("span",{className:"insight-chip insight-warning",title:d.map(S=>S.message).join(" "),children:["IO warnings: ",d.length]}):t.jsx("span",{className:"insight-chip",children:"IO OK"})]})]}),y.length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Investigator","data-help-body":"Automated root-cause hypotheses ranked by severity and confidence.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Investigator"}),t.jsxs("div",{className:"insight-items",children:[y.map(S=>t.jsxs("span",{className:"insight-chip",title:S.summary,children:[S.title," (",Math.round(S.confidence*100),"%)"]},S.id)),(h=(v=y[0])==null?void 0:v.evidenceStepIds)!=null&&h[0]?t.jsx("button",{className:"insight-chip",type:"button",onClick:()=>s==null?void 0:s(y[0].evidenceStepIds[0]),children:"Jump to evidence"}):null]})]}):null,(k=p==null?void 0:p.buckets)!=null&&k.length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Parallelism","data-help-body":"How many steps ran concurrently over time.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Parallelism"}),t.jsx("div",{className:"insight-items",children:t.jsx("div",{className:"insight-heatmap",title:`Peak concurrency: ${p.peak}`,children:p.buckets.map((S,$)=>t.jsx("span",{className:"heatmap-bar",style:{height:`${Math.max(20,S.active/Math.max(1,p.peak)*48)}px`},title:`Bucket ${$+1}: ${S.active} active`},`${S.startMs}-${S.endMs}`))})})]}):null,Object.keys(b).length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Model cost","data-help-body":"Spend by model family.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Model cost"}),t.jsx("div",{className:"insight-items",children:Object.entries(b).map(([S,$])=>t.jsxs("span",{className:"insight-chip",title:`Total cost for ${S}`,children:[S,": $",$.toFixed(3)]},S))})]}):null]})}const qo=["all","llm_call","tool_call","decision","handoff","guardrail"];function Go({query:e,typeFilter:a,onQueryChange:s,onTypeFilterChange:r}){return t.jsxs("div",{className:"search-bar",children:[t.jsx("input",{className:"search-input",placeholder:"Search steps, tools, previews...","aria-label":"Search steps",value:e,onChange:o=>s(o.target.value),"data-help":!0,"data-help-title":"Search","data-help-body":"Filter steps by name, tool, or payload preview. Great for fast recall.","data-help-placement":"bottom"}),t.jsx("select",{className:"search-select",value:a,"aria-label":"Filter by step type",onChange:o=>r(o.target.value),"data-help":!0,"data-help-title":"Type filter","data-help-body":"Narrow the timeline to a specific class of steps (LLM, tool, decision, handoff).","data-help-placement":"bottom",children:qo.map(o=>t.jsx("option",{value:o,children:o},o))})]})}function pa(e,a,s){const r=Date.parse(e),o=s.map(b=>Date.parse(b.endedAt??b.startedAt)).filter(b=>Number.isFinite(b)),c=a?Date.parse(a):o.length?Math.max(...o):r,d=Math.max(1,c-r),p=s.map(b=>{const y=Math.max(0,Date.parse(b.startedAt)-r),x=Math.max(y,Date.parse(b.endedAt??b.startedAt)-r);return{stepId:b.id,startMs:y,endMs:x}}).sort((b,y)=>b.startMs-y.startMs||b.endMs-y.endMs),u=[],f=[];for(const b of p){let y=u.findIndex(x=>x<=b.startMs);y===-1?(y=u.length,u.push(b.endMs)):u[y]=b.endMs,f.push({stepId:b.stepId,startMs:b.startMs,endMs:b.endMs,lane:y,xPct:b.startMs/d*100,wPct:Math.max(.75,(b.endMs-b.startMs)/d*100)})}return{wallTimeMs:d,intervals:f,laneCount:u.length}}function Bo(e){var v;const s=e.steps.map(h=>({stepId:h.id,name:h.name,durationMs:h.durationMs??0})).sort((h,k)=>k.durationMs-h.durationMs).slice(0,3),r={},o={};for(const h of e.steps)((v=h.metrics)==null?void 0:v.costUsd)!=null&&(r[h.type]=(r[h.type]??0)+h.metrics.costUsd,h.type==="tool_call"&&(o[h.name]=(o[h.name]??0)+h.metrics.costUsd));const c=e.steps.filter(h=>h.status==="failed").length,d=e.steps.filter(h=>!!h.retryOfStepId).length,p=e.metadata.wallTimeMs,u=e.metadata.workTimeMs??e.steps.reduce((h,k)=>h+(k.durationMs??0),0),f=Uo(e),b=Ho(e.steps),y=Wo(e.steps),x=Jo(e),w=Vo(e.steps);return{topLatencySteps:s,costByType:r,costByTool:o,costByModel:{[e.metadata.modelId]:e.metadata.totalCostUsd??0},errors:c,retries:d,wallTimeMs:p,workTimeMs:u,timing:f,ioWarnings:b,criticalPathMs:y,concurrency:x,retryPatterns:w}}function zo(e){var s;const a=(s=e.metrics)==null?void 0:s.costUsd;return a==null?null:`$${a.toFixed(3)}`}function He(e){if(!e)return null;const a=Date.parse(e);return Number.isNaN(a)?null:a}function Uo(e){const a=He(e.startedAt),s=He(e.endedAt??void 0),r=[],o=[],c=[];return a==null&&c.push("Trace start time missing or invalid."),e.steps.forEach(d=>{const p=He(d.startedAt),u=He(d.endedAt??d.startedAt);if(p==null||u==null){r.push(d.id);return}if(u<p){o.push(d.id);return}a!=null&&p<a&&o.push(d.id),s!=null&&u>s&&o.push(d.id)}),r.length&&c.push(`Missing timestamps on ${r.length} steps.`),o.length&&c.push(`Timestamp skew detected on ${o.length} steps.`),{degraded:!!(r.length||o.length||a==null),issues:c,missingStepIds:r,skewedStepIds:o}}function Ho(e){const a=new Map;e.forEach(c=>{c.type==="tool_call"&&c.toolCallId&&a.set(c.toolCallId,c)});const s=new Set,r=new Set,o=[];return e.forEach(c=>{c.type!=="llm_call"||!c.io||((c.io.emittedToolCallIds??[]).forEach(d=>{s.add(d),a.has(d)||o.push({kind:"missing_tool_step",message:`Emitted toolCallId ${d} has no tool step.`,stepId:c.id,toolCallId:d})}),(c.io.consumedToolCallIds??[]).forEach(d=>{r.add(d),a.has(d)||o.push({kind:"missing_tool_step",message:`Consumed toolCallId ${d} has no tool step.`,stepId:c.id,toolCallId:d}),s.has(d)||o.push({kind:"consume_without_emit",message:`Consumed toolCallId ${d} without emission.`,stepId:c.id,toolCallId:d})}))}),a.forEach((c,d)=>{s.has(d)||o.push({kind:"unemitted_tool",message:`Tool step ${c.id} has toolCallId ${d} never emitted.`,stepId:c.id,toolCallId:d}),r.has(d)||o.push({kind:"unconsumed_tool",message:`Tool step ${c.id} has toolCallId ${d} never consumed.`,stepId:c.id,toolCallId:d})}),o}function Wo(e){const a=new Map,s=new Map,r=[];e.forEach(d=>{if(a.set(d.id,d.durationMs??0),d.parentStepId){const p=s.get(d.parentStepId)??[];p.push(d.id),s.set(d.parentStepId,p)}else r.push(d.id)});const o=new Map,c=d=>{if(o.has(d))return o.get(d)??0;const u=(s.get(d)??[]).reduce((b,y)=>Math.max(b,c(y)),0),f=(a.get(d)??0)+u;return o.set(d,f),f};return r.length?Math.max(...r.map(d=>c(d))):0}function Jo(e){const a=He(e.startedAt);if(a==null)return{buckets:[],peak:0};const s=He(e.endedAt??void 0)??Math.max(...e.steps.map(u=>He(u.endedAt??u.startedAt)??a),a),r=Math.max(1,s-a),o=12,c=Math.max(1,Math.floor(r/o)),d=[];let p=0;for(let u=0;u<o;u+=1){const f=a+u*c,b=f+c;let y=0;e.steps.forEach(x=>{const w=He(x.startedAt),v=He(x.endedAt??x.startedAt);w==null||v==null||v>=f&&w<=b&&(y+=1)}),p=Math.max(p,y),d.push({startMs:u*c,endMs:(u+1)*c,active:y})}return{buckets:d,peak:p}}function Vo(e){const a={};e.forEach(o=>{o.retryOfStepId&&(a[o.retryOfStepId]=(a[o.retryOfStepId]??0)+1)});const s=Object.values(a).reduce((o,c)=>o+c,0),r=Object.entries(a).sort((o,c)=>c[1]-o[1]).slice(0,3);return{totalRetries:s,retryRate:e.length?s/e.length:0,topRetries:r.map(([o,c])=>({stepId:o,count:c}))}}const Ko={llm_call:{label:"LLM",icon:"LLM",description:"Model call"},tool_call:{label:"TOOL",icon:"TOOL",description:"Tool call"},decision:{label:"DEC",icon:"DEC",description:"Decision"},handoff:{label:"HAND",icon:"HAND",description:"Handoff"},guardrail:{label:"GUARD",icon:"GUARD",description:"Guardrail"}};function Qo(e){return Ko[e]}function Yo({type:e,size:a="sm",showLabel:s=!1}){const r=Qo(e);return t.jsxs("span",{className:`step-badge step-badge-${e} step-badge-${a}`,title:r.description,children:[t.jsx("span",{className:"step-badge-icon",children:r.icon}),s?t.jsx("span",{className:"step-badge-label",children:r.label}):null]})}function Bs({step:e,interval:a,playbackState:s,selected:r,onSelect:o,variant:c="base",diffStatus:d,disabled:p=!1,laneHeight:u=140}){var E,R,z,L,q,V;const f=zo(e),b=((E=e.preview)==null?void 0:E.subtitle)??((R=e.preview)==null?void 0:R.title)??"",y=((z=e.preview)==null?void 0:z.outputPreview)??((L=e.preview)==null?void 0:L.inputPreview)??"",x=d?`step-diff-${d}`:"",w=c==="ghost"?"step-ghost":"",v=a.wPct<8?"step-compact":"",h=e.type.replace("_"," ").toUpperCase(),k=((q=e.metrics)==null?void 0:q.tokensTotal)!=null?`${e.metrics.tokensTotal} tokens`:null,S=e.durationMs!=null?`${e.durationMs}ms`:null,$=[k,S,f].filter(Boolean).join(" · "),X=`Click to inspect inputs/outputs and replay from this moment.${$?` ${$}.`:""}`;return t.jsxs("button",{type:"button",className:`step-card step-${e.type} step-${s} ${r?"step-selected":""} ${x} ${w} ${v}`,"data-step-id":e.id,"aria-pressed":r,"aria-hidden":c==="ghost",disabled:p,"data-help":!0,"data-help-title":`${e.name} · ${h}`,"data-help-body":X,"data-help-placement":"top",style:{left:`${a.xPct}%`,width:`${a.wPct}%`,top:`${a.lane*u}px`},onClick:()=>{p||o(e.id)},children:[t.jsxs("div",{className:"step-card-header",children:[t.jsxs("div",{className:"step-title-group",children:[t.jsx(Yo,{type:e.type}),t.jsx("span",{className:"step-title",children:e.name})]}),t.jsx("span",{className:`status-pill status-${e.status}`,children:e.status})]}),b?t.jsx("div",{className:"step-subtitle",children:b}):null,t.jsxs("div",{className:"step-metrics",children:[((V=e.metrics)==null?void 0:V.tokensTotal)!=null?t.jsxs("span",{children:[e.metrics.tokensTotal," tok"]}):null,e.durationMs!=null?t.jsxs("span",{children:[e.durationMs,"ms"]}):null,f?t.jsx("span",{children:f}):null]}),y?t.jsx("div",{className:"step-preview",children:y}):null]})}function zs(e,a){return a<e.startMs?"future":a>e.endMs?"past":"active"}const Ft={type:{order:[],hidden:[]},status:{order:[],hidden:[]},parent:{order:[],hidden:[]}};function fn(e,a){return a==="type"?e.type:a==="status"?e.status:e.parentStepId??"root"}function Xo(e,a){const s=new Set;return e.forEach(r=>s.add(fn(r,a))),Array.from(s).sort((r,o)=>r.localeCompare(o))}function ds(e,a,s){const r=new Set(e),o=[...a.filter(d=>r.has(d))];e.forEach(d=>{o.includes(d)||o.push(d)});const c=Array.from(new Set(s.filter(d=>r.has(d))));return{order:o,hidden:c}}const Zo=140,ei=132,ti=96,us={llm_call:1,tool_call:2,decision:3,handoff:4,guardrail:5};function Us(e){return[...e].sort((a,s)=>(us[a.type]??9)-(us[s.type]??9))}function ai(e,a,s,r,o){const c=new Map;a.forEach(x=>{var v;const w=fn(x,s);c.has(w)||c.set(w,[]),(v=c.get(w))==null||v.push(x)});const d=Array.from(c.keys()),p=[...r.filter(x=>d.includes(x))];d.forEach(x=>{p.includes(x)||p.push(x)});const u=p.filter(x=>!o.includes(x)),f=new Map;let b=0,y=0;return u.forEach(x=>{const w=c.get(x)??[],v=pa(e.startedAt,e.endedAt,w);v.intervals.forEach(h=>{f.set(h.stepId,{...h,lane:h.lane+b})}),b+=Math.max(1,v.laneCount)}),y=Math.max(1,b),{intervalsByStepId:f,laneCount:y,visibleGroups:u}}function ni({trace:e,steps:a,selectedStepId:s,onSelectStep:r,playheadPct:o,playheadMs:c,windowRange:d,ghostTrace:p,diff:u,laneStrategy:f="type",laneGroupsOrder:b=[],hiddenLaneGroups:y=[],laneHeight:x=Zo,cardHeight:w=ei,compactHeight:v=ti}){const{intervalsByStepId:h,laneCount:k}=ai(e,a,f,b,y),S=Array.from(h.values()),$=new Map(S.map(j=>[j.stepId,j])),X=Us(a),E=e.metadata.wallTimeMs||1,R=new Set((u==null?void 0:u.removedSteps)??[]),z=new Set((u==null?void 0:u.changedSteps)??[]),L=new Set(((u==null?void 0:u.changedPairs)??[]).map(j=>j.rightId)),q=new Set((u==null?void 0:u.addedSteps)??[]);let V=S;if(d){const j=d.endMs-d.startMs,I=Math.max(1e3,j*.15),O=Math.max(0,d.startMs-I),J=d.endMs+I;if(V=S.filter(N=>N.endMs>=O&&N.startMs<=J),s&&!V.some(N=>N.stepId===s)){const N=$.get(s);N&&(V=[...V,N])}}const se=new Set(V.map(j=>j.stepId));return t.jsx("div",{className:"timeline",style:{"--step-card-height":`${w}px`,"--step-compact-height":`${v}px`},children:t.jsxs("div",{className:"timeline-grid",style:{height:`${k*x}px`},"data-help":!0,"data-help-title":"Timeline lanes","data-help-body":"Each lane stacks overlapping steps; width reflects duration.","data-help-placement":"top",children:[t.jsx("div",{className:"playback-cursor",style:{left:`${o}%`}}),X.filter(j=>se.has(j.id)).filter(j=>!y.includes(fn(j,f))).map(j=>{const I=$.get(j.id);if(!I)return null;const O=zs(I,c);return t.jsx(Bs,{step:j,interval:I,playbackState:O,selected:s===j.id,diffStatus:R.has(j.id)?"removed":z.has(j.id)?"changed":null,laneHeight:x,onSelect:r},j.id)}),p?t.jsx(si,{ghostTrace:p,baseWallTimeMs:E,playheadMs:c,windowRange:d,diffAdded:q,diffChanged:L,laneHeight:x}):null]})})}function si({ghostTrace:e,baseWallTimeMs:a,playheadMs:s,windowRange:r,diffAdded:o,diffChanged:c,laneHeight:d}){const{intervals:p,laneCount:u}=pa(e.startedAt,e.endedAt,e.steps),f=new Map(p.map(h=>[h.stepId,h])),b=e.metadata.wallTimeMs||1,y=s/a*b;let x=p;if(r){const h=r.endMs-r.startMs,k=Math.max(1e3,h*.15),S=b/a,$=Math.max(0,(r.startMs-k)*S),X=Math.min(b,(r.endMs+k)*S);x=p.filter(E=>E.endMs>=$&&E.startMs<=X)}const w=new Set(x.map(h=>h.stepId)),v=Us(e.steps);return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"ghost-lanes",style:{height:`${u*d}px`}}),v.filter(h=>w.has(h.id)).map(h=>{const k=f.get(h.id);if(!k)return null;const S=zs(k,y),$=o.has(h.id)?"added":c.has(h.id)?"changed":null;return t.jsx(Bs,{step:h,interval:k,playbackState:S,selected:!1,diffStatus:$,variant:"ghost",disabled:!0,laneHeight:d,onSelect:()=>{}},`ghost-${h.id}`)})]})}function ri({trace:e,steps:a,selectedStepId:s,onSelectStep:r,playheadMs:o,windowRange:c,timing:d,ghostTrace:p,diff:u,laneStrategy:f,laneGroupsOrder:b,hiddenLaneGroups:y,onLaneStrategyChange:x,onToggleLaneGroupVisibility:w,onMoveLaneGroup:v}){const h=e.metadata.wallTimeMs||1,k=Math.min(100,Math.max(0,o/h*100)),S=b.filter($=>!y.includes($)).length;return t.jsxs("section",{className:"cinema-mode","aria-label":"Cinema mode",children:[d!=null&&d.degraded?t.jsxs("div",{className:"timing-banner",title:d.issues.join(" "),children:["Timing degraded: ",d.issues[0]??"Check timestamps."]}):null,t.jsxs("div",{className:"timeline-studio-panel","data-help":!0,"data-help-title":"Timeline studio","data-help-body":"Regroup lanes by type/status/parent, hide noisy groups, and reorder emphasis.",children:[t.jsxs("label",{className:"timeline-studio-strategy",children:["Lane strategy",t.jsxs("select",{value:f,onChange:$=>x($.target.value),children:[t.jsx("option",{value:"type",children:"Type"}),t.jsx("option",{value:"status",children:"Status"}),t.jsx("option",{value:"parent",children:"Parent branch"})]})]}),t.jsxs("div",{className:"timeline-studio-summary",children:[S,"/",b.length," groups visible"]}),t.jsx("div",{className:"timeline-studio-groups",children:b.map(($,X)=>{const E=y.includes($);return t.jsxs("div",{className:`timeline-studio-group ${E?"is-hidden":""}`,children:[t.jsx("button",{type:"button",className:"ghost-button",onClick:()=>w($),children:E?"Show":"Hide"}),t.jsx("span",{className:"timeline-studio-group-name",children:$}),t.jsx("button",{type:"button",className:"ghost-button",onClick:()=>v($,"up"),disabled:X===0,children:"Up"}),t.jsx("button",{type:"button",className:"ghost-button",onClick:()=>v($,"down"),disabled:X===b.length-1,children:"Down"})]},$)})})]}),t.jsx(ni,{trace:e,steps:a,selectedStepId:s,onSelectStep:r,playheadPct:k,playheadMs:o,windowRange:c,ghostTrace:p,diff:u,laneStrategy:f,laneGroupsOrder:b,hiddenLaneGroups:y})]})}const oi=[.5,1,1.5,2,4];function ps({playheadMs:e,wallTimeMs:a,isPlaying:s,speed:r,onToggle:o,onScrub:c,onSpeedChange:d}){const p=u=>{c(Number(u.target.value))};return t.jsxs("div",{className:"playback-controls",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:o,"aria-label":s?"Pause playback":"Play playback","data-help":!0,"data-help-title":"Playhead","data-help-body":"Start or pause the run to experience timing as it unfolded.","data-help-placement":"bottom",children:s?"Pause":"Play"}),t.jsx("input",{className:"playback-slider",type:"range",min:0,max:a,value:e,"aria-label":"Playback position",onChange:p,"data-help":!0,"data-help-title":"Scrub timeline","data-help-body":"Drag to jump to any moment in the run.","data-help-placement":"bottom"}),t.jsx("select",{className:"playback-speed",value:r,"aria-label":"Playback speed",onChange:u=>d(Number(u.target.value)),"data-help":!0,"data-help-title":"Speed","data-help-body":"Slow down to inspect or speed up to skim.","data-help-placement":"bottom",children:oi.map(u=>t.jsxs("option",{value:u,children:[u,"x"]},u))})]})}function ii(e,a,s,r=60){const{wallTimeMs:o,intervals:c}=pa(e,a,s),d=new Array(r).fill(0);if(!o)return{buckets:d,wallTimeMs:0};const p=o/r;return!Number.isFinite(p)||p<=0?{buckets:d,wallTimeMs:o}:(c.forEach(u=>{const f=Math.max(0,Math.floor(u.startMs/p)),b=Math.min(r-1,Math.floor(u.endMs/p));for(let y=f;y<=b;y+=1)d[y]+=1}),{buckets:d,wallTimeMs:o})}function li(e,a){const s=new Blob([JSON.stringify(a,null,2)],{type:"application/json"}),r=URL.createObjectURL(s),o=document.createElement("a");o.href=r,o.download=e,document.body.appendChild(o),o.click(),o.remove(),URL.revokeObjectURL(r)}function an(e,a,s="text/plain"){const r=new Blob([a],{type:s}),o=URL.createObjectURL(r),c=document.createElement("a");c.href=o,c.download=e,document.body.appendChild(c),c.click(),c.remove(),URL.revokeObjectURL(o)}const qt=5e3,ci=32;function Ee(e,a,s){return Math.min(s,Math.max(a,e))}function wt(e,a){const s=new Set;return e.forEach(r=>{s.add(Ee(Math.round(r),0,a))}),Array.from(s).sort((r,o)=>r-o).slice(0,ci)}function di(e,a){if(!e)return{bookmarksMs:[],clipStartMs:null,clipEndMs:null,segments:[]};try{const s=JSON.parse(e),r=wt(Array.isArray(s.bookmarksMs)?s.bookmarksMs:[],a),o=typeof s.clipStartMs=="number"?Ee(s.clipStartMs,0,a):null,c=typeof s.clipEndMs=="number"?Ee(s.clipEndMs,0,a):null,d=Array.isArray(s.segments)?s.segments.filter(p=>typeof(p==null?void 0:p.id)=="string"&&typeof(p==null?void 0:p.startMs)=="number"&&typeof(p==null?void 0:p.endMs)=="number"&&typeof(p==null?void 0:p.label)=="string").map(p=>({...p,startMs:Ee(p.startMs,0,a),endMs:Ee(p.endMs,0,a)})):[];return{bookmarksMs:r,clipStartMs:o,clipEndMs:o!=null&&c!=null&&c<o?o:c,segments:d}}catch{return{bookmarksMs:[],clipStartMs:null,clipEndMs:null,segments:[]}}}function ms(e,a){const s=Date.parse(e);return Number.isNaN(s)?null:new Date(s+a).toISOString()}function ui({traceStart:e,traceEnd:a,steps:s,playheadMs:r,windowRange:o,windowed:c,spanMs:d,onSpanChange:p,onToggleWindowed:u,onScrub:f,persistenceKey:b,laneStrategy:y="type",visibleLaneGroups:x=[],remotePlayheads:w=[]}){const{buckets:v,wallTimeMs:h}=ii(e,a,s,64),k=Math.max(1,...v),S=Ee(d,qt,Math.max(qt,h)),$=(o==null?void 0:o.startMs)??0,X=(o==null?void 0:o.endMs)??h,E=l.useMemo(()=>`agentDirector.timelineStudio.${b??e}`,[b,e]),[R,z]=l.useState([]),[L,q]=l.useState(null),[V,se]=l.useState(null),[j,I]=l.useState([]),[O,J]=l.useState("");l.useEffect(()=>{const T=di(window.localStorage.getItem(E),h);z(T.bookmarksMs),q(T.clipStartMs),se(T.clipEndMs),I(T.segments)},[E,h]),l.useEffect(()=>{const T={bookmarksMs:wt(R,h),clipStartMs:L==null?null:Ee(L,0,h),clipEndMs:V==null?null:Ee(V,0,h),segments:j};window.localStorage.setItem(E,JSON.stringify(T))},[R,V,L,j,E,h]);const N=h?$/h*100:0,K=h?(X-$)/h*100:100,D=h?r/h*100:0,F=L!=null&&V!=null?Math.min(L,V):null,P=L!=null&&V!=null?Math.max(L,V):null,he=F!=null&&P!=null&&h?(P-F)/h*100:0,Ce=F!=null&&h?F/h*100:0,C=F!=null&&P!=null&&P>F,B=T=>{const ee=T.currentTarget.getBoundingClientRect(),be=(T.clientX-ee.left)/ee.width,je=Ee(Math.round(be*h),0,h);f(je)},fe=T=>{if(T.key==="ArrowLeft"){T.preventDefault(),f(Ee(r-Math.max(250,Math.round(h*.02)),0,h));return}if(T.key==="ArrowRight"){T.preventDefault(),f(Ee(r+Math.max(250,Math.round(h*.02)),0,h));return}if(T.key==="Home"){T.preventDefault(),f(0);return}if(T.key==="End"){T.preventDefault(),f(h);return}(T.key===" "||T.key==="Enter")&&(T.preventDefault(),f(r))},ye=()=>{z(T=>wt([...T,r],h))},A=T=>{if(R.length===0)return;const ee=wt(R,h);if(T==="previous"){const je=[...ee].reverse().find(jt=>jt<r)??ee[ee.length-1];f(je);return}const be=ee.find(je=>je>r)??ee[0];f(be)},Q=()=>{const T=Ee(r,0,h);q(T),V!=null&&V<T&&se(T)},we=()=>{const T=Ee(r,0,h);se(T),L!=null&&L>T&&q(T)},it=()=>{q(null),se(null)},Ae=()=>{if(!C||F==null||P==null)return;const T=O.trim()||`Scene ${j.length+1}`,ee=`segment-${Math.random().toString(36).slice(2,9)}`;I(be=>[...be,{id:ee,startMs:F,endMs:P,label:T}]),J("")},Fe=T=>{I(ee=>ee.filter(be=>be.id!==T))},Re=()=>{if(!C||F==null||P==null)return;const T={type:"agent-director-clip",traceStart:e,traceEnd:a,clip:{startMs:F,endMs:P,startAt:ms(e,F),endAt:ms(e,P)},bookmarksMs:wt(R,h).filter(ee=>ee>=F&&ee<=P),playheadMs:r,laneContext:{strategy:y,visibleGroups:x},segments:j.filter(ee=>ee.endMs>=F&&ee.startMs<=P),exportedAt:new Date().toISOString()};li(`agent-director-clip-${F}-${P}.json`,T)};return t.jsxs("div",{className:"mini-timeline",children:[t.jsxs("div",{className:"mini-track",onClick:B,role:"slider",tabIndex:0,"aria-label":"Timeline density map","aria-valuemin":0,"aria-valuemax":h,"aria-valuenow":r,"aria-valuetext":`${r} milliseconds`,onKeyDown:fe,"data-help":!0,"data-help-title":"Density map","data-help-body":"A compact view of activity density. Click to jump the playhead.","data-help-placement":"top",children:[t.jsx("div",{className:"mini-bars",children:v.map((T,ee)=>t.jsx("span",{className:"mini-bar",style:{height:`${T/k*100}%`}},`bucket-${ee}`))}),t.jsx("div",{className:"mini-window",style:{left:`${N}%`,width:`${K}%`,opacity:c?1:.4}}),C?t.jsx("div",{className:"mini-clip-window",style:{left:`${Ce}%`,width:`${he}%`}}):null,t.jsx("div",{className:"mini-bookmark-markers","data-testid":"timeline-bookmark-markers","aria-hidden":"true",children:wt(R,h).map(T=>{const ee=h?T/h*100:0;return t.jsx("button",{type:"button",className:"mini-bookmark-marker",style:{left:`${ee}%`},onClick:be=>{be.stopPropagation(),f(T)},title:`Jump to bookmark at ${T}ms`,"aria-label":`Bookmark ${T} milliseconds`},`bookmark-${T}`)})}),t.jsx("div",{className:"mini-remote-markers","aria-hidden":"true",children:w.map((T,ee)=>{const be=h?T/h*100:0;return t.jsx("span",{className:"mini-remote-marker",style:{left:`${be}%`}},`remote-${ee}`)})}),t.jsx("div",{className:"mini-segments","aria-hidden":"true",children:j.map(T=>{const ee=h?T.startMs/h*100:0,be=h?(T.endMs-T.startMs)/h*100:0;return t.jsx("span",{className:"mini-segment-bar",style:{left:`${ee}%`,width:`${Math.max(1,be)}%`},title:T.label},T.id)})}),t.jsx("div",{className:"mini-playhead",style:{left:`${D}%`}})]}),t.jsxs("div",{className:"mini-controls",children:[t.jsx("label",{className:"mini-label",children:"Zoom"}),t.jsx("input",{type:"range",min:qt,max:Math.max(qt,h),value:S,"aria-label":"Timeline zoom",onChange:T=>{u(!0),p(Number(T.target.value))},"data-help":!0,"data-help-title":"Zoom window","data-help-body":"Tighten the window to focus on hotspots.","data-help-placement":"top"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>u(!c),title:"Toggle windowed playback",children:c?"Full":"Window"}),t.jsx("button",{className:"ghost-button",type:"button",title:"Reset zoom",onClick:()=>{u(!0),p(Math.min(Math.max(h*.2,qt),6e4))},children:"Reset"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:ye,children:"Add bookmark"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>A("previous"),children:"Previous bookmark"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>A("next"),children:"Next bookmark"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:Q,children:"Set clip start"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:we,children:"Set clip end"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:it,children:"Clear clip"}),t.jsx("input",{className:"search-input mini-segment-input",placeholder:"Segment label",value:O,onChange:T=>J(T.target.value),"aria-label":"Segment label"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:Ae,disabled:!C,children:"Add segment"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:Re,disabled:!C,children:"Export clip"})]}),j.length?t.jsx("div",{className:"mini-segment-list",children:j.map(T=>t.jsxs("div",{className:"mini-segment-item",children:[t.jsxs("span",{children:[T.label," (",T.startMs,"ms - ",T.endMs,"ms)"]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Fe(T.id),children:"Remove"})]},T.id))}):null]})}const pi=[{keys:"Space",action:"Play / pause"},{keys:"← / →",action:"Step boundary back / forward"},{keys:"Shift + ← / →",action:"Jump to start / end"},{keys:"F",action:"Toggle Flow mode"},{keys:"I",action:"Toggle Inspector"},{keys:"S",action:"Story mode"},{keys:"E",action:"Explain mode"},{keys:"T",action:"Start tour"},{keys:"Cmd/Ctrl + K",action:"Open command palette"},{keys:"?",action:"Show shortcuts"},{keys:"Esc",action:"Close modal / inspector"}];function mi({open:e,onClose:a}){const s=l.useRef(null);if(l.useEffect(()=>{var o;e&&((o=s.current)==null||o.focus())},[e]),!e)return null;const r=o=>{var u;if(o.key==="Escape"){o.preventDefault(),a();return}if(o.key!=="Tab")return;const c=Array.from(o.currentTarget.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'));if(c.length===0)return;const d=c.indexOf(document.activeElement),p=o.shiftKey?d<=0?c.length-1:d-1:(d+1)%c.length;(u=c[p])==null||u.focus(),o.preventDefault()};return t.jsx("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true","aria-labelledby":"shortcuts-title",onKeyDown:r,children:t.jsxs("div",{className:"modal",tabIndex:-1,children:[t.jsxs("div",{className:"modal-header",children:[t.jsx("div",{className:"modal-title",id:"shortcuts-title",children:"Keyboard Shortcuts"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:a,ref:s,"aria-label":"Close shortcuts",children:"Close"})]}),t.jsx("div",{className:"modal-body",children:pi.map(o=>t.jsxs("div",{className:"modal-row",children:[t.jsx("span",{className:"modal-keys",children:o.keys}),t.jsx("span",{className:"modal-action",children:o.action})]},o.keys))})]})})}const hs="agentDirector.palette.recent.v1",fs="agentDirector.palette.pinned.v1",hi=8,fi=12,Hs=e=>e.trim().toLowerCase(),nn=(e,a)=>{if(!a)return 0;const s=Hs(e);return s?s===a?30:s.startsWith(a)?18:s.includes(a)?8:0:0};function ys(e){try{const a=JSON.parse(window.localStorage.getItem(e)??"[]");return Array.isArray(a)?a.filter(s=>typeof s=="string"):[]}catch{return[]}}function bs(e,a){window.localStorage.setItem(e,JSON.stringify(a))}function yi(e){const a=new Map;return e.forEach(s=>{var o;const r=s.section;a.has(r)||a.set(r,[]),(o=a.get(r))==null||o.push(s)}),a}function gs(e,a,s){var o;if(!e.length)return 0;let r=a;for(let c=0;c<e.length;c+=1)if(r=(r+s+e.length)%e.length,!((o=e[r])!=null&&o.disabled))return r;return a}function bi({open:e,onClose:a,actions:s,context:r,onActionRun:o}){var V,se;const[c,d]=l.useState(""),[p,u]=l.useState(0),[f,b]=l.useState([]),[y,x]=l.useState([]),w=l.useRef(null),v=l.useRef(null),h=l.useMemo(()=>{const j=Hs(c),I=new Set(f),O=new Set(y);return s.map((N,K)=>{var P;const D=[N.label,N.description,N.group,N.keys,...N.keywords??[]].filter(Boolean).join(" ").toLowerCase();if(j&&!D.includes(j))return null;let F=N.priority??0;return F+=nn(N.label,j),F+=nn(N.group??"",j),(N.keywords??[]).forEach(he=>{F+=nn(he,j)}),I.has(N.id)&&(F+=6),O.has(N.id)&&(F+=12),r!=null&&r.section&&((P=N.group)==null?void 0:P.toLowerCase())===r.section.toLowerCase()&&(F+=8),r!=null&&r.mode&&N.id.includes(`mode-${r.mode}`)&&(F+=8),{action:N,score:F,index:K}}).filter(N=>!!N).sort((N,K)=>K.score===N.score?N.index-K.index:K.score-N.score).map(N=>N.action)},[s,r==null?void 0:r.mode,r==null?void 0:r.section,y,c,f]),k=l.useMemo(()=>{const j=new Map(h.map(N=>[N.id,N])),I=y.map(N=>j.get(N)).filter(N=>!!N).map(N=>({...N,section:"Pinned"})),O=f.map(N=>j.get(N)).filter(N=>!!N).filter(N=>!I.some(K=>K.id===N.id)).map(N=>({...N,section:"Recent"})),J=h.filter(N=>!I.some(K=>K.id===N.id)).filter(N=>!O.some(K=>K.id===N.id)).map(N=>({...N,section:N.group??"General"}));if(!c.trim()&&r){const N=J.slice(0,4).map(K=>({...K,id:`recommended-${K.id}`,label:`Recommended: ${K.label}`,section:"Recommended"}));return[...I,...O,...N,...J]}return[...I,...O,...J]},[r,h,y,f,c]),S=l.useMemo(()=>yi(k),[k]),$=l.useMemo(()=>s.filter(j=>(j.group??"").toLowerCase()==="macros"||j.id.startsWith("macro-")),[s]);if(l.useEffect(()=>{if(!e)return;d(""),u(0),b(ys(hs)),x(ys(fs));const j=window.setTimeout(()=>{var I;return(I=w.current)==null?void 0:I.focus()},0);return()=>window.clearTimeout(j)},[e]),l.useEffect(()=>{p>=k.length&&u(0)},[p,k.length]),!e)return null;const X=j=>{b(I=>{const O=[j,...I.filter(J=>J!==j)].slice(0,hi);return bs(hs,O),O})},E=j=>{j.disabled||(X(j.id),o==null||o(j),j.onTrigger(),a())},R=j=>{x(I=>{const O=I.includes(j)?I.filter(J=>J!==j):[j,...I].slice(0,fi);return bs(fs,O),O})},z=j=>{var I,O;if(j.key==="Escape"){j.preventDefault(),a();return}if(j.key==="ArrowDown"){j.preventDefault(),u(J=>gs(k,J,1));return}if(j.key==="ArrowUp"){j.preventDefault(),u(J=>gs(k,J,-1));return}if(j.key==="Enter"){j.preventDefault();const J=k[p];J&&E(J);return}if(j.key==="Tab"){const J=Array.from(((I=v.current)==null?void 0:I.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'))??[]);if(!J.length)return;const N=J.indexOf(document.activeElement),K=j.shiftKey?N<=0?J.length-1:N-1:(N+1)%J.length;(O=J[K])==null||O.focus(),j.preventDefault()}},L=(V=k[p])!=null&&V.id?`palette-option-${(se=k[p])==null?void 0:se.id}`:void 0;let q=-1;return t.jsx("div",{className:"modal-backdrop palette-backdrop",role:"dialog","aria-modal":"true","aria-label":"Command palette",onKeyDown:z,onMouseDown:j=>{j.target===j.currentTarget&&a()},children:t.jsxs("div",{className:"palette",ref:v,children:[t.jsxs("div",{className:"palette-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"palette-title",children:"Command palette"}),t.jsx("div",{className:"palette-subtitle",children:"Search actions, modes, and playbook steps."})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:a,"aria-label":"Close command palette",children:"Close"})]}),t.jsx("input",{ref:w,className:"palette-input",value:c,onChange:j=>d(j.target.value),placeholder:"Type to filter actions…","aria-label":"Search commands",role:"combobox","aria-expanded":"true","aria-controls":"command-palette-list","aria-activedescendant":L,"aria-autocomplete":"list"}),!c.trim()&&$.length>0?t.jsxs("div",{className:"palette-macros",children:[t.jsx("div",{className:"palette-group-title",children:"Quick macros"}),t.jsx("div",{className:"palette-macro-list",children:$.slice(0,3).map(j=>t.jsx("button",{className:"ghost-button palette-macro-item",type:"button",onClick:()=>E(j),children:j.label},j.id))})]}):null,t.jsxs("div",{className:"palette-list",role:"listbox",id:"command-palette-list",children:[k.length===0?t.jsx("div",{className:"palette-empty",children:"No matching commands."}):null,Array.from(S.entries()).map(([j,I])=>t.jsxs("div",{className:"palette-group",children:[t.jsx("div",{className:"palette-group-title",children:j}),t.jsx("div",{className:"palette-group-list",children:I.map(O=>{q+=1;const J=q===p,N=y.includes(O.id);return t.jsxs("button",{id:`palette-option-${O.id}`,className:`palette-item ${J?"active":""}`,type:"button",role:"option","aria-selected":J,onMouseEnter:()=>u(q),onClick:()=>E(O),disabled:O.disabled,children:[t.jsxs("div",{className:"palette-item-main",children:[t.jsx("div",{className:"palette-item-title",children:O.label}),O.description?t.jsx("div",{className:"palette-item-description",children:O.description}):null]}),t.jsxs("div",{className:"palette-item-trailing",children:[O.keys?t.jsx("div",{className:"palette-item-keys",children:O.keys}):null,t.jsx("span",{className:`palette-pin ${N?"active":""}`,role:"button",tabIndex:0,onClick:K=>{K.stopPropagation(),R(O.id)},onKeyDown:K=>{K.key!=="Enter"&&K.key!==" "||(K.preventDefault(),K.stopPropagation(),R(O.id))},"aria-label":N?`Unpin ${O.label}`:`Pin ${O.label}`,title:N?"Unpin command":"Pin command",children:N?"★":"☆"})]})]},O.id)})})]},j))]})]})})}function gi(e){return e.length?e.reduce((a,s)=>(s.durationMs??0)>(a.durationMs??0)?s:a,e[0]):null}function xi({trace:e,mode:a,playheadMs:s,selectedStepId:r,compareTrace:o,collapsed:c,onToggleCollapsed:d,onModeChange:p,onSelectStep:u,onJumpToBottleneck:f,onReplay:b,onStartTour:y,priorityQueue:x=[]}){var j;const w=e.steps??[],v=gi(w),h=r??(v==null?void 0:v.id)??((j=w[0])==null?void 0:j.id)??null,k=a==="cinema"||s>0,S=!!r,$=!!o,X=[k,S,$].filter(Boolean).length,E=[k,S,$].findIndex(I=>!I),R=E===-1?2:E,z=[0,1,2].map(I=>[k,S,$][I]?"done":I===R?"active":"next"),L=[{id:"observe",title:"Act I: Observe",summary:"Scrub the timeline to feel the pacing, bottlenecks, and tool choreography.",status:z[0],actionLabel:"Enter cinema",action:()=>p("cinema"),tasks:[{label:"Scrub the timeline",done:s>0},{label:"Stay in Cinema mode",done:a==="cinema"}]},{id:"inspect",title:"Act II: Inspect",summary:"Open the most expensive or failed step and read the payload with context.",status:z[1],actionLabel:v?"Jump to bottleneck":"Select first step",action:()=>{if(r){p("cinema");return}if(v){f();return}h&&(u(h),p("cinema"))},disabled:!h,tasks:[{label:"Open the Inspector",done:!!r},{label:"Jump to the bottleneck",done:!!(v&&r===v.id)}]},{id:"direct",title:"Act III: Direct",summary:"Replay from a decisive step, then compare flows and diffs side-by-side.",status:z[2],actionLabel:o?"Open compare":"Replay from step",action:()=>{if(o){p("compare");return}h&&b(h)},disabled:!h,tasks:[{label:"Replay from a step",done:!!o},{label:"Compare runs side-by-side",done:!!(o&&a==="compare")}]}],q=L[R],se=x.filter(I=>!I.done)[0];return c?t.jsxs("section",{className:"journey-panel journey-collapsed","aria-label":"Director journey","data-help":!0,"data-help-indicator":!0,"data-tour":"journey","data-help-title":"Director journey","data-help-body":"A guided path from observation to replay. Use it to show newcomers what to do first.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"journey-collapsed-main",children:[t.jsx("div",{className:"journey-eyebrow",children:"Director journey"}),t.jsx("div",{className:"journey-collapsed-title",children:"From observe to direct"})]}),t.jsxs("div",{className:"journey-collapsed-actions",children:[t.jsxs("span",{className:"journey-progress-text",children:[X,"/3 complete"]}),se?t.jsxs("span",{className:`journey-priority-chip severity-${se.severity}`,children:["Next priority: ",se.title]}):null,q?t.jsxs("button",{className:"primary-button journey-next",type:"button",onClick:q.action,disabled:q.disabled,children:["Next: ",q.actionLabel]}):null,y?t.jsx("button",{className:"ghost-button",type:"button",onClick:y,children:"Tour"}):null,t.jsx("button",{className:"primary-button journey-expand",type:"button",onClick:d,children:"Expand"})]})]}):t.jsxs("section",{className:"journey-panel","aria-label":"Director journey","data-help":!0,"data-help-indicator":!0,"data-tour":"journey","data-help-title":"Director journey","data-help-body":"A three-act flow that teaches the story: observe, inspect, direct. Each act jumps to the right place.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"journey-head",children:[t.jsxs("div",{children:[t.jsx("div",{className:"journey-eyebrow",children:"Director journey"}),t.jsx("h2",{className:"journey-title",children:"Cut a perfect take in three acts."}),t.jsx("p",{className:"journey-subtitle",children:"Trace the performance, interrogate the moment, then direct a better run."})]}),t.jsxs("div",{className:"journey-head-actions",children:[y?t.jsx("button",{className:"ghost-button",type:"button",onClick:y,children:"Start tour"}):null,t.jsx("button",{className:"ghost-button",type:"button",onClick:d,children:"Collapse"})]})]}),t.jsx("div",{className:"journey-track",children:L.map((I,O)=>{var J;return t.jsxs("div",{className:"journey-card","data-status":I.status,children:[t.jsxs("div",{className:"journey-card-top",children:[t.jsxs("span",{className:"journey-index",children:["0",O+1]}),t.jsx("span",{className:"journey-status",children:I.status})]}),t.jsx("h3",{className:"journey-card-title",children:I.title}),t.jsx("p",{className:"journey-card-body",children:I.summary}),(J=I.tasks)!=null&&J.length?t.jsx("ul",{className:"journey-tasks",children:I.tasks.map(N=>t.jsxs("li",{className:`journey-task ${N.done?"done":""}`,children:[t.jsx("span",{className:"journey-task-icon","aria-hidden":"true",children:N.done?"✓":"○"}),t.jsx("span",{children:N.label})]},N.label))}):null,t.jsx("button",{className:"primary-button journey-action",type:"button",onClick:I.action,disabled:I.disabled,children:I.actionLabel})]},I.id)})}),t.jsxs("div",{className:"journey-footer",children:[t.jsxs("div",{children:[t.jsx("div",{className:"journey-progress-label",children:"Progress"}),t.jsx("div",{className:"journey-progress",children:t.jsx("span",{className:"journey-progress-bar",style:{width:`${X/3*100}%`}})})]}),t.jsx("div",{className:"journey-footnote",children:"Tip: Use Flow to spot fan-out, Compare to validate your changes."})]}),x.length?t.jsxs("div",{className:"journey-priority-queue",children:[t.jsxs("div",{className:"journey-priority-head",children:[t.jsx("div",{className:"journey-progress-label",children:"Priority queue"}),t.jsxs("span",{children:[x.filter(I=>I.done).length,"/",x.length," resolved"]})]}),t.jsx("div",{className:"journey-priority-list",children:x.map(I=>t.jsxs("article",{className:`journey-priority-item ${I.done?"done":""}`,children:[t.jsxs("div",{className:"journey-priority-main",children:[t.jsx("span",{className:`journey-priority-chip severity-${I.severity}`,children:I.severity}),t.jsxs("div",{children:[t.jsx("div",{className:"journey-priority-title",children:I.title}),t.jsx("div",{className:"journey-priority-body",children:I.detail})]})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:I.onAction,disabled:I.done,children:I.done?"Resolved":I.actionLabel})]},I.id))})]}):null]})}const vi=[],wi=[],ji=[],ki={};function Si(e){return e.length?e.reduce((a,s)=>(s.durationMs??0)>(a.durationMs??0)?s:a,e[0]):null}function Ni({trace:e,mode:a,selectedStepId:s,onModeChange:r,onSelectStep:o,onJumpToBottleneck:c,onReplay:d,recommendations:p=vi,persona:u="builder",annotations:f=wi,activityFeed:b=ji,onAddAnnotation:y,missionProgress:x=ki,missionCompletion:w,onResetMissions:v,narrative:h="",onAskDirector:k,onExportNarrative:S}){var ye;const $=e.steps??[],X=Si($),E=s??(X==null?void 0:X.id)??((ye=$[0])==null?void 0:ye.id)??null,R=e.metadata.wallTimeMs??0,z=u==="executive"?"Executive lens":u==="operator"?"Operator lens":"Builder lens",[L,q]=l.useState(""),[V,se]=l.useState(""),[j,I]=l.useState(""),[O,J]=l.useState("overview"),[N,K]=l.useState([]),D=l.useMemo(()=>b.slice(0,6),[b]),F=(w==null?void 0:w.done)??0,P=F>=3||!!x.inspect,he=F>=5||!!x.collaborate||D.length>0,Ce=l.useMemo(()=>p.slice(0,3).map((A,Q)=>({id:A.id,step:`${Q+1}. ${A.actionLabel} — ${A.title}`})),[p]);l.useEffect(()=>{K(A=>A.filter(Q=>p.some(we=>we.id===Q)))},[p]);const C=N.filter(A=>p.some(Q=>Q.id===A)).length,B=p.length?Math.round(C/p.length*100):0,fe=A=>{A.action(),K(Q=>Q.includes(A.id)?Q:[...Q,A.id])};return t.jsxs("aside",{className:"inspector inspector-empty","data-help":!0,"data-help-indicator":!0,"data-tour":"inspector","data-help-title":"Inspector panel","data-help-body":"Select a step to open detailed payloads, redaction controls, and replay actions.","data-help-placement":"left",children:[t.jsx("div",{className:"inspector-header",children:t.jsxs("div",{children:[t.jsx("div",{className:"inspector-title",children:"Director's notes"}),t.jsxs("div",{className:"inspector-subtitle",children:[z,". Select a step to open deep inspection."]})]})}),t.jsxs("div",{className:"director-tabs",role:"tablist","aria-label":"Director workspace tabs",children:[t.jsx("button",{className:`ghost-button ${O==="overview"?"active":""}`,type:"button",role:"tab","aria-selected":O==="overview",onClick:()=>J("overview"),children:"Overview"}),t.jsx("button",{className:`ghost-button ${O==="narrative"?"active":""}`,type:"button",role:"tab","aria-selected":O==="narrative",onClick:()=>J("narrative"),children:"Narrative"}),t.jsx("button",{className:`ghost-button ${O==="collab"?"active":""}`,type:"button",role:"tab","aria-selected":O==="collab",onClick:()=>J("collab"),children:"Collaboration"})]}),O==="overview"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Run summary"}),t.jsxs("div",{className:"inspector-row",children:[t.jsx("span",{children:"Steps"}),t.jsx("span",{children:$.length})]}),t.jsxs("div",{className:"inspector-row",children:[t.jsx("span",{children:"Wall time"}),t.jsxs("span",{children:[R,"ms"]})]}),t.jsxs("div",{className:"inspector-row",children:[t.jsx("span",{children:"Status"}),t.jsx("span",{children:e.status})]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Next actions"}),t.jsxs("div",{className:"director-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>r("cinema"),"data-help":!0,"data-help-title":"Open cinema","data-help-body":"Jump straight into the timeline.","data-help-placement":"right",children:"Open cinema"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>r("flow"),"data-help":!0,"data-help-title":"Open flow","data-help-body":"See the dependency graph of the run.","data-help-placement":"right",children:"Switch to flow"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{if(!s){if(X){c();return}E&&o(E)}},disabled:!E||!!s,"data-help":!0,"data-help-title":"Jump to bottleneck","data-help-body":"Select the slowest step for inspection.","data-help-placement":"right",children:s?"Inspector open":X?"Jump to bottleneck":"Select first step"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>E&&d(E),disabled:!E||!P,title:P?void 0:"Complete core missions to unlock replay guidance.","data-help":!0,"data-help-title":"Replay","data-help-body":"Branch a replay from a decisive step.","data-help-placement":"right",children:"Replay from step"})]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Mode"}),t.jsxs("div",{className:"director-modes",children:[t.jsx("button",{className:`ghost-button ${a==="cinema"?"active":""}`,type:"button",onClick:()=>r("cinema"),"data-help":!0,"data-help-title":"Cinema mode","data-help-body":"Timeline view for pacing and sequence.","data-help-placement":"right",children:"Cinema"}),t.jsx("button",{className:`ghost-button ${a==="flow"?"active":""}`,type:"button",onClick:()=>r("flow"),"data-help":!0,"data-help-title":"Flow mode","data-help-body":"Graph view for dependencies.","data-help-placement":"right",children:"Flow"}),t.jsx("button",{className:"ghost-button",type:"button",disabled:!0,children:"Compare"})]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Adaptive missions"}),t.jsxs("div",{className:"mission-summary",children:[(w==null?void 0:w.done)??0,"/",(w==null?void 0:w.total)??0," complete",t.jsxs("span",{children:[(w==null?void 0:w.pct)??0,"%"]})]}),t.jsxs("div",{className:"mission-stage",children:["Stage: ",he?"Collaboration":P?"Analysis":"Foundation"]}),t.jsx("div",{className:"mission-grid",children:Object.entries(x).map(([A,Q])=>t.jsxs("div",{className:`mission-chip ${Q?"done":""}`,children:[t.jsx("span",{children:A}),t.jsx("span",{children:Q?"Done":"Pending"})]},A))}),t.jsx("button",{className:"ghost-button",type:"button",onClick:v,children:"Reset missions"})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Action plan"}),P?p.length===0?t.jsx("div",{className:"annotation-empty",children:"No recommendations generated yet."}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"mission-summary",children:[C,"/",p.length," complete",t.jsxs("span",{children:[B,"%"]})]}),t.jsx("div",{className:"director-recommendations",children:p.map(A=>{const Q=N.includes(A.id);return t.jsxs("article",{className:`director-recommendation tone-${A.tone} ${Q?"done":""}`,children:[t.jsx("div",{className:"director-recommendation-title",children:A.title}),t.jsx("p",{className:"director-recommendation-body",children:A.body}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>fe(A),children:Q?"Completed":A.actionLabel})]},A.id)})})]}):t.jsx("div",{className:"annotation-empty",children:"Complete inspect/flow/replay missions to unlock AI narrative tools."}),he?null:t.jsx("div",{className:"annotation-empty",children:"Open another live session to unlock collaboration activity feed."})]})]}):null,O==="narrative"?t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"AI director narrative"}),P?t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"director-recommendation-body",children:h}),Ce.length?t.jsx("div",{className:"director-guided-plan",children:Ce.map(A=>t.jsx("div",{children:A.step},A.id))}):null,t.jsxs("div",{className:"director-ask-row",children:[t.jsx("input",{className:"search-input",value:V,onChange:A=>se(A.target.value),placeholder:"Ask Director (e.g. what is highest risk?)","aria-label":"Ask director question"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{V.trim()&&I((k==null?void 0:k(V))??"")},children:"Ask"})]}),j?t.jsx("div",{className:"director-answer",children:j}):null,t.jsx("button",{className:"ghost-button",type:"button",onClick:S,children:"Export narrative"})]}):t.jsx("div",{className:"annotation-empty",children:"Complete inspect/flow/replay missions to unlock AI narrative tools."})]}):null,O==="collab"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Shared annotations"}),t.jsx("textarea",{value:L,onChange:A=>q(A.target.value),rows:3,placeholder:s?"Add note for selected step...":"Add trace-level note...","aria-label":"Shared annotation"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{const A=L.trim();A&&(y==null||y(A,s),q(""))},children:"Add annotation"}),t.jsxs("div",{className:"annotation-list",children:[f.slice(-6).reverse().map(A=>t.jsxs("article",{className:"annotation-item",children:[t.jsxs("div",{className:"annotation-meta",children:[t.jsx("span",{children:A.stepId?`step ${A.stepId}`:"trace"}),t.jsx("span",{children:A.authorSessionId})]}),t.jsx("p",{children:A.body})]},A.id)),f.length===0?t.jsx("div",{className:"annotation-empty",children:"No shared annotations yet."}):null]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Collab activity"}),he?t.jsxs("div",{className:"activity-list",children:[D.map(A=>t.jsxs("div",{className:"activity-item",children:[t.jsx("span",{children:A.message}),t.jsx("span",{children:new Date(A.timestamp).toLocaleTimeString()})]},A.id)),D.length===0?t.jsx("div",{className:"annotation-empty",children:"No activity yet."}):null]}):t.jsx("div",{className:"annotation-empty",children:"Open another live session to unlock collaboration activity feed."})]})]}):null]})}const sn=(e,a,s)=>Math.min(s,Math.max(a,e));function rn(e){return Array.from((e==null?void 0:e.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'))??[]).filter(s=>!(s.hasAttribute("disabled")||s.getAttribute("aria-hidden")==="true"))}function Ci({steps:e,open:a,onClose:s,onComplete:r}){const[o,c]=l.useState(0),[d,p]=l.useState(null),[u,f]=l.useState(null),b=l.useRef(null),y=l.useRef(null),x=l.useRef(null),w=l.useMemo(()=>e[o],[e,o]),v=l.useCallback(()=>{if(!a)return;const E=document.querySelector(w.target);if(!E){y.current=null,p(null);return}y.current=E;const R=E.getBoundingClientRect();p(R)},[a,w.target]),h=l.useCallback(()=>{if(!d||!b.current){f(null);return}const E=b.current.offsetWidth,R=b.current.offsetHeight,z=16;let L=sn(d.left+d.width/2-E/2,z,window.innerWidth-E-z),q=d.bottom+16;w.placement==="top"&&(q=d.top-R-16),w.placement==="left"&&(L=d.left-E-16,q=d.top+d.height/2-R/2),w.placement==="right"&&(L=d.right+16,q=d.top+d.height/2-R/2),q+R>window.innerHeight-z&&(q=d.top-R-16),q<z&&(q=d.bottom+16),L=sn(L,z,window.innerWidth-E-z),q=sn(q,z,window.innerHeight-R-z),f({top:q,left:L})},[w.placement,d]);if(l.useEffect(()=>{a&&c(0)},[a]),l.useEffect(()=>{var R,z;if(!a){(z=(R=x.current)==null?void 0:R.focus)==null||z.call(R);return}x.current=document.activeElement;const E=window.setTimeout(()=>{var q;(q=rn(b.current)[0]??b.current)==null||q.focus()},0);return()=>window.clearTimeout(E)},[a]),l.useEffect(()=>{if(!a)return;const E=document.querySelector(w.target);E&&E.scrollIntoView({behavior:"smooth",block:"center",inline:"center"});const R=window.requestAnimationFrame(()=>v());return()=>window.cancelAnimationFrame(R)},[a,w.target,v]),l.useLayoutEffect(()=>{h()},[d,h,w.title]),l.useEffect(()=>{if(!a)return;const E=()=>{v(),h()};return window.addEventListener("resize",E),window.addEventListener("scroll",E,!0),()=>{window.removeEventListener("resize",E),window.removeEventListener("scroll",E,!0)}},[a,v,h]),l.useEffect(()=>{if(!a)return;const E=R=>{var se;if(R.key==="Escape"){R.preventDefault(),s();return}if(R.key!=="Tab")return;const z=rn(b.current);if(!z.length)return;const L=document.activeElement,q=z.indexOf(L),V=R.shiftKey?q<=0?z.length-1:q-1:(q+1)%z.length;(se=z[V])==null||se.focus(),R.preventDefault()};return document.addEventListener("keydown",E,!0),()=>document.removeEventListener("keydown",E,!0)},[s,a]),!a||!w)return null;const k=E=>{var V;if(E.key==="Escape"){E.preventDefault(),s();return}if(E.key!=="Tab")return;const R=rn(b.current);if(R.length===0)return;const z=document.activeElement,L=R.indexOf(z),q=E.shiftKey?L<=0?R.length-1:L-1:(L+1)%R.length;(V=R[q])==null||V.focus(),E.preventDefault()},S=`tour-title-${w.id}`,$=`tour-body-${w.id}`,X=d?{top:d.top-6,left:d.left-6,width:d.width+12,height:d.height+12}:void 0;return t.jsxs("div",{className:"tour-overlay",role:"dialog","aria-modal":"true","aria-label":"Guided tour","aria-labelledby":S,"aria-describedby":$,onKeyDown:k,children:[t.jsx("div",{className:"tour-backdrop",onClick:s}),d?t.jsx("div",{className:"tour-spotlight",style:X}):null,t.jsxs("div",{className:`tour-card ${u?"tour-card-anchored":""}`,ref:b,style:u??void 0,tabIndex:-1,children:[t.jsxs("div",{className:"tour-step",children:["Step ",o+1," of ",e.length]}),t.jsx("div",{className:"tour-title",id:S,children:w.title}),t.jsx("p",{className:"tour-body",id:$,children:w.body}),t.jsxs("div",{className:"tour-actions",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>c(E=>Math.max(0,E-1)),disabled:o===0,children:"Back"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:s,children:"Skip"}),o===e.length-1?t.jsx("button",{className:"primary-button",type:"button",onClick:r,children:"Finish tour"}):t.jsx("button",{className:"primary-button",type:"button",onClick:()=>c(E=>E+1),children:"Next"})]})]})]})}const xs=(e,a,s)=>Math.min(s,Math.max(a,e));function Mi({enabled:e}){const[a,s]=l.useState(null),[r,o]=l.useState(null),c=l.useRef(null),d=l.useRef(null),p=l.useCallback(()=>{const f=c.current;if(!f){s(null);return}const b=f.getBoundingClientRect(),y=f.dataset.helpTitle??"Context",x=f.dataset.helpBody??"",w=f.dataset.helpPlacement??"right";s({rect:b,title:y,body:x,placement:w})},[]);l.useEffect(()=>{if(!e){c.current=null,s(null);return}const f=v=>{var k,S;const h=(S=(k=v.target)==null?void 0:k.closest)==null?void 0:S.call(k,"[data-help]");if(!h){c.current||s(null);return}c.current!==h&&(c.current=h,p())},b=v=>{var k,S;const h=(S=(k=v.target)==null?void 0:k.closest)==null?void 0:S.call(k,"[data-help]");h&&(c.current=h,p())},y=v=>{var k;const h=v.relatedTarget;(k=h==null?void 0:h.closest)!=null&&k.call(h,"[data-help]")||(c.current=null,s(null))},x=v=>{var k,S;const h=(S=(k=v.target)==null?void 0:k.closest)==null?void 0:S.call(k,"[data-help]");if(!h){c.current=null,s(null);return}c.current=h,p()},w=()=>{c.current&&p()};return window.addEventListener("mousemove",f),window.addEventListener("focusin",b),window.addEventListener("focusout",y),window.addEventListener("pointerdown",x),window.addEventListener("scroll",w,!0),window.addEventListener("resize",w),()=>{window.removeEventListener("mousemove",f),window.removeEventListener("focusin",b),window.removeEventListener("focusout",y),window.removeEventListener("pointerdown",x),window.removeEventListener("scroll",w,!0),window.removeEventListener("resize",w)}},[e,p]);const u=l.useCallback(()=>{if(!a||!d.current){o(null);return}const f=12,b=d.current.offsetWidth,y=d.current.offsetHeight,{rect:x,placement:w}=a;let v=x.right+16,h=x.top+x.height/2-y/2;w==="left"&&(v=x.left-b-16,h=x.top+x.height/2-y/2),w==="top"&&(v=x.left+x.width/2-b/2,h=x.top-y-16),w==="bottom"&&(v=x.left+x.width/2-b/2,h=x.bottom+16),v=xs(v,f,window.innerWidth-b-f),h=xs(h,f,window.innerHeight-y-f),o({left:v,top:h})},[a]);return l.useLayoutEffect(()=>{u()},[u]),!e||!a?null:t.jsxs("div",{className:"help-overlay","aria-hidden":"true",children:[t.jsx("div",{className:"help-highlight",style:{top:a.rect.top-6,left:a.rect.left-6,width:a.rect.width+12,height:a.rect.height+12}}),t.jsxs("div",{className:"help-bubble",ref:d,style:r??void 0,"data-placement":a.placement,children:[t.jsx("div",{className:"help-title",children:a.title}),t.jsx("div",{className:"help-body",children:a.body})]})]})}const Ei=[{id:"builder",label:"Builder lens",body:"Focus on step payloads, execution paths, and replay control."},{id:"executive",label:"Executive lens",body:"Focus on bottlenecks, risk, and outcome-level run quality."},{id:"operator",label:"Operator lens",body:"Focus on failures, retries, and trace reliability posture."}],Ii=[{id:"rapid_triage",label:"Rapid triage",body:"Jump straight to the highest-risk step and start resolution.",estimate:"2-3 min"},{id:"deep_diagnosis",label:"Deep diagnosis",body:"Open flow and guided analysis for full root-cause exploration.",estimate:"8-12 min"},{id:"team_sync",label:"Team sync",body:"Open collaborative mode and prep a handoff workflow.",estimate:"4-6 min"}];function Ti({onComplete:e,onStartTour:a,onStartStory:s,persona:r="builder",onPersonaChange:o,launchPath:c="rapid_triage",onLaunchPathChange:d,onStartLaunchPath:p}){const u=()=>{a==null||a(),e()},f=()=>{s==null||s(),e()},b=y=>{d==null||d(y),p==null||p(y),e()};return t.jsx("div",{className:"intro-overlay",role:"dialog","aria-modal":"true","aria-label":"Agent Director intro",children:t.jsxs("div",{className:"intro-card",children:[t.jsx("div",{className:"intro-scan"}),t.jsx("div",{className:"intro-title",children:"Agent Director"}),t.jsx("div",{className:"intro-tagline",children:"Watch your agent think. Then direct it."}),t.jsxs("div",{className:"intro-steps",children:[t.jsxs("div",{className:"intro-step",children:[t.jsx("div",{className:"intro-step-label",children:"Observe"}),t.jsx("div",{className:"intro-step-body",children:"Scrub the timeline to feel pacing and parallelism."})]}),t.jsxs("div",{className:"intro-step",children:[t.jsx("div",{className:"intro-step-label",children:"Inspect"}),t.jsx("div",{className:"intro-step-body",children:"Open the bottleneck to read payloads and costs."})]}),t.jsxs("div",{className:"intro-step",children:[t.jsx("div",{className:"intro-step-label",children:"Direct"}),t.jsx("div",{className:"intro-step-body",children:"Replay from a decisive step and compare runs."})]})]}),t.jsx("div",{className:"intro-personas",role:"group","aria-label":"Select onboarding lens",children:Ei.map(y=>t.jsxs("button",{type:"button",className:`ghost-button intro-persona ${r===y.id?"active":""}`,onClick:()=>o==null?void 0:o(y.id),"aria-pressed":r===y.id,"aria-label":y.label,children:[t.jsx("span",{className:"intro-persona-label",children:y.label}),t.jsx("span",{className:"intro-persona-body",children:y.body})]},y.id))}),t.jsx("div",{className:"intro-launch-paths",role:"group","aria-label":"Select launch path",children:Ii.map(y=>t.jsxs("article",{className:`intro-path-card ${c===y.id?"active":""}`,children:[t.jsxs("button",{type:"button",className:`ghost-button intro-path-button ${c===y.id?"active":""}`,onClick:()=>d==null?void 0:d(y.id),"aria-pressed":c===y.id,"aria-label":y.label,children:[t.jsx("span",{className:"intro-path-label",children:y.label}),t.jsx("span",{className:"intro-path-estimate",children:y.estimate}),t.jsx("span",{className:"intro-path-body",children:y.body})]}),t.jsxs("button",{className:"primary-button intro-path-start",type:"button",onClick:()=>b(y.id),children:["Start ",y.label]})]},y.id))}),t.jsxs("div",{className:"intro-grid",children:[t.jsx("span",{}),t.jsx("span",{}),t.jsx("span",{}),t.jsx("span",{})]}),t.jsxs("div",{className:"intro-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:u,children:"Start guided tour"}),s?t.jsx("button",{className:"ghost-button",type:"button",onClick:f,children:"Play story mode"}):null,t.jsx("button",{className:"ghost-button",type:"button",onClick:e,children:"Skip intro"})]})]})})}function Di({explainMode:e,storyActive:a,onStartTour:s,onStartStory:r,onToggleExplain:o,onDismiss:c}){return t.jsxs("section",{className:"hero-ribbon","aria-label":"Director briefing","data-help":!0,"data-help-indicator":!0,"data-tour":"hero","data-help-title":"Director briefing","data-help-body":"Start the tour, play story mode, or enable explain to learn the interface instantly.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"hero-ribbon-top",children:[t.jsx("span",{className:"hero-eyebrow",children:"Director briefing"}),t.jsx("button",{className:"ghost-button hero-dismiss",type:"button",onClick:c,children:"Dismiss"})]}),t.jsx("div",{className:"hero-title",children:"Observe. Inspect. Direct."}),t.jsx("div",{className:"hero-subtitle",children:"A cinematic control room for agent traces. See time, read structure, then replay with confidence."}),t.jsxs("div",{className:"hero-pills",children:[t.jsx("span",{className:"hero-pill","data-tone":"observe",children:"Observe"}),t.jsx("span",{className:"hero-pill","data-tone":"inspect",children:"Inspect"}),t.jsx("span",{className:"hero-pill","data-tone":"direct",children:"Direct"})]}),t.jsxs("div",{className:"hero-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:s,children:"Start guided tour"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:r,disabled:a,children:a?"Story running":"Play story mode"}),t.jsxs("button",{className:`ghost-button ${e?"active":""}`,type:"button",onClick:o,"aria-pressed":e,children:["Explain ",e?"On":"Off"]})]})]})}function Ai({mode:e,isPlaying:a,storyActive:s,explainMode:r,hidden:o=!1,open:c,onToggleOpen:d,onTogglePlay:p,onStartStory:u,onStopStory:f,onStartTour:b,onOpenPalette:y,onShowShortcuts:x,onToggleExplain:w,onJumpToBottleneck:v}){if(o)return null;const h=a?"Pause":"Play",k=s?"Stop story":"Story mode";return c?t.jsxs("aside",{className:"quick-actions","aria-label":"Quick actions","data-help":!0,"data-help-indicator":!0,"data-tour":"quick-actions","data-help-title":"Quick actions","data-help-body":"Launch story mode, open the command palette, or jump to the bottleneck instantly.","data-help-placement":"left",children:[t.jsxs("div",{className:"quick-actions-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"quick-actions-title",children:"Quick actions"}),t.jsx("div",{className:"quick-actions-subtitle",children:"Pin demo controls close at hand."})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:d,"aria-label":"Collapse quick actions",children:"Collapse"})]}),t.jsxs("button",{className:`quick-action ${a?"active":""}`,type:"button",onClick:p,"aria-label":h,"data-help":!0,"data-help-title":"Play or pause","data-help-body":"Start or stop playback from anywhere.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:h}),t.jsx("span",{className:"quick-action-meta",children:e==="flow"?"Cinema":"Space"})]}),t.jsxs("button",{className:`quick-action ${s?"active":""}`,type:"button",onClick:s?f:u,"aria-label":k,"data-help":!0,"data-help-title":"Story mode","data-help-body":"Auto-runs a cinematic walkthrough of the run.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:k}),t.jsx("span",{className:"quick-action-meta",children:"S"})]}),t.jsxs("button",{className:"quick-action",type:"button",onClick:y,"aria-label":"Open command palette","data-help":!0,"data-help-title":"Command palette","data-help-body":"Search every action and jump instantly.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Command"}),t.jsx("span",{className:"quick-action-meta",children:"Cmd+K"})]}),t.jsxs("button",{className:"quick-action",type:"button",onClick:b,"aria-label":"Start guided tour","data-help":!0,"data-help-title":"Guided tour","data-help-body":"Walk the interface with a curated tour.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Tour"}),t.jsx("span",{className:"quick-action-meta",children:"Guide"})]}),t.jsxs("button",{className:`quick-action ${r?"active":""}`,type:"button",onClick:w,"aria-label":"Toggle explain mode","data-help":!0,"data-help-title":"Explain mode","data-help-body":"Toggle contextual overlays for every control.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Explain"}),t.jsx("span",{className:"quick-action-meta",children:r?"On":"Off"})]}),t.jsxs("button",{className:"quick-action",type:"button",onClick:v,"aria-label":"Jump to bottleneck","data-help":!0,"data-help-title":"Bottleneck jump","data-help-body":"Focus instantly on the slowest step.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Bottleneck"}),t.jsx("span",{className:"quick-action-meta",children:"Latency"})]}),t.jsxs("button",{className:"quick-action",type:"button",onClick:x,"aria-label":"Show shortcuts","data-help":!0,"data-help-title":"Shortcuts","data-help-body":"See the full keyboard map.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Shortcuts"}),t.jsx("span",{className:"quick-action-meta",children:"?"})]})]}):t.jsxs("button",{className:"quick-actions-toggle",type:"button",onClick:d,title:"Open quick actions","aria-expanded":"false","data-help":!0,"data-tour":"quick-actions","data-help-title":"Quick actions","data-help-body":"Open the dock to access demos, shortcuts, and instant actions.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-actions-toggle-label",children:"Actions"}),t.jsx("span",{className:"quick-actions-toggle-meta",children:"Dock"})]})}function $i({active:e,label:a,step:s,total:r,onStop:o,onRestart:c}){if(!e)return null;const d=r>0?(s+1)/r*100:0;return t.jsxs("div",{className:"story-banner",role:"status","aria-live":"polite",children:[t.jsxs("div",{className:"story-banner-main",children:[t.jsx("div",{className:"story-banner-title",children:"Story mode"}),t.jsx("div",{className:"story-banner-step",children:a})]}),t.jsxs("div",{className:"story-banner-actions",children:[t.jsxs("span",{className:"story-banner-count",children:[Math.min(s+1,r),"/",r]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:c,children:"Restart"}),t.jsx("button",{className:"primary-button",type:"button",onClick:o,children:"Stop"})]}),t.jsx("div",{className:"story-banner-progress",children:t.jsx("span",{style:{width:`${d}%`}})})]})}function on({variant:e,title:a,message:s,actions:r=[]}){return t.jsx("section",{className:`app-shell-state app-shell-${e}`,"aria-live":"polite",children:t.jsxs("div",{className:"app-shell-card",children:[e==="loading"?t.jsx("div",{className:"app-shell-spinner","aria-hidden":"true"}):null,t.jsx("h2",{children:a}),t.jsx("p",{children:s}),r.length?t.jsx("div",{className:"app-shell-actions",children:r.map(o=>t.jsx("span",{children:o.node},o.id))}):null]})})}function _i({notifications:e,onDismiss:a}){return e.length?t.jsx("aside",{className:"notification-center","aria-label":"System notifications","aria-live":"polite",children:e.map(s=>t.jsxs("article",{className:`notification-item level-${s.level}`,children:[t.jsx("p",{children:s.message}),t.jsx("button",{className:"ghost-button notification-dismiss",type:"button",onClick:()=>a(s.id),"aria-label":"Dismiss notification",children:"Dismiss"})]},s.id))}):null}function Ri({steps:e,fromRects:a,toRects:s,onComplete:r}){return l.useEffect(()=>{const o=window.setTimeout(r,550);return()=>window.clearTimeout(o)},[r]),t.jsx("div",{className:"morph-layer",children:e.map(o=>{var p;const c=a[o.id],d=s[o.id];return!c||!d?null:t.jsxs(_o.div,{className:`morph-card step-${o.type}`,initial:{left:c.left,top:c.top,width:c.width,height:c.height},animate:{left:d.left,top:d.top,width:d.width,height:d.height},transition:{duration:.5,ease:"easeInOut"},children:[t.jsx("div",{className:"morph-card-title",children:o.name}),t.jsx("div",{className:"morph-card-subtitle",children:((p=o.preview)==null?void 0:p.title)??o.type})]},o.id)})})}function Oi({morph:e,onComplete:a,children:s}){return t.jsxs("div",{className:"morph-orchestrator",children:[s,e?t.jsx(Ri,{steps:e.steps,fromRects:e.fromRects,toRects:e.toRects,onComplete:a}):null]})}const Pi="demo-trace-overlap-001",Li="Overlap + ToolCallId Demo",Fi="2026-01-27T10:00:00.000Z",qi="2026-01-27T10:00:05.000Z",Gi="completed",Bi={source:"openai_agents",agentName:"DemoAgent",modelId:"gpt-4o-2024-11-20",wallTimeMs:5e3,workTimeMs:7200,totalTokens:1400,totalCostUsd:.018},zi=[{id:"s1",index:0,type:"llm_call",name:"plan",startedAt:"2026-01-27T10:00:00.000Z",endedAt:"2026-01-27T10:00:01.000Z",durationMs:1e3,childStepIds:[],metrics:{tokensTotal:300,costUsd:.004},preview:{title:"LLM: plan",subtitle:"gpt-4o",outputPreview:"I'll fetch two sources..."},status:"completed"},{id:"s2",index:1,type:"llm_call",name:"call_tools",startedAt:"2026-01-27T10:00:01.000Z",endedAt:"2026-01-27T10:00:01.200Z",durationMs:200,childStepIds:[],metrics:{tokensTotal:120,costUsd:.002},preview:{title:"LLM: call tools",outputPreview:"Calling web_search + database_query"},io:{emittedToolCallIds:["tc-001","tc-002"]},status:"completed"},{id:"s3",index:2,type:"tool_call",name:"web_search",toolCallId:"tc-001",startedAt:"2026-01-27T10:00:01.200Z",endedAt:"2026-01-27T10:00:03.200Z",durationMs:2e3,childStepIds:[],metrics:{costUsd:0},preview:{title:"Tool: web_search",inputPreview:'{"q":"EU AI Act"}',outputPreview:"[3 results...]"},status:"completed"},{id:"s4",index:3,type:"tool_call",name:"database_query",toolCallId:"tc-002",startedAt:"2026-01-27T10:00:01.500Z",endedAt:"2026-01-27T10:00:02.700Z",durationMs:1200,childStepIds:[],preview:{title:"Tool: database_query",inputPreview:'{"sql":"SELECT..."}',outputPreview:'{"rows":42}'},status:"completed"},{id:"s5",index:4,type:"llm_call",name:"analyze",startedAt:"2026-01-27T10:00:03.200Z",endedAt:"2026-01-27T10:00:04.600Z",durationMs:1400,childStepIds:[],metrics:{tokensTotal:700,costUsd:.012},preview:{title:"LLM: analyze",outputPreview:"Synthesis based on tool outputs..."},io:{consumedToolCallIds:["tc-001","tc-002"]},status:"completed"}],ma={id:Pi,name:Li,startedAt:Fi,endedAt:qi,status:Gi,metadata:Bi,steps:zi};function Ws(e,a){const s=Ui(e,a),r=new Set(s.map(y=>y.leftId)),o=new Set(s.map(y=>y.rightId)),c=a.steps.filter(y=>!o.has(y.id)).map(y=>y.id),d=e.steps.filter(y=>!r.has(y.id)).map(y=>y.id),p=s.filter(y=>{const x=e.steps.find(v=>v.id===y.leftId),w=a.steps.find(v=>v.id===y.rightId);return!x||!w?!1:vs(x)!==vs(w)}),u=p.map(y=>y.leftId),f=(a.metadata.totalCostUsd??0)-(e.metadata.totalCostUsd??0),b=a.metadata.wallTimeMs-e.metadata.wallTimeMs;return{addedSteps:c,removedSteps:d,changedSteps:u,changedPairs:p,alignedSteps:s,costDeltaUsd:f,wallTimeDeltaMs:b}}function Ui(e,a){const s=[],r=new Set(e.steps.map(b=>b.id)),o=new Set(a.steps.map(b=>b.id));Array.from(r).forEach(b=>{o.has(b)&&(s.push({leftId:b,rightId:b}),r.delete(b),o.delete(b))});const c=new Map;a.steps.forEach(b=>{b.toolCallId&&c.set(b.toolCallId,b.id)}),e.steps.forEach(b=>{if(!b.toolCallId)return;const y=c.get(b.toolCallId);y&&o.has(y)&&(s.push({leftId:b.id,rightId:y}),r.delete(b.id),o.delete(y))});const d=ks(e),p=ks(a),u=Hi(e,a),f={};return o.forEach(b=>{const y=p.get(b);if(!y)return;const x=ws(y.step);x&&(f[x]||(f[x]=[]),f[x].push(b))}),Object.values(f).forEach(b=>{b.sort((y,x)=>{var w,v;return(((w=p.get(y))==null?void 0:w.startMs)??0)-(((v=p.get(x))==null?void 0:v.startMs)??0)})}),Array.from(r).forEach(b=>{var v;const y=d.get(b);if(!y)return;const x=ws(y.step);if(!x||!((v=f[x])!=null&&v.length))return;const w=Wi(y,f[x],p,u);w&&(s.push({leftId:b,rightId:w}),r.delete(b),o.delete(w),f[x]=f[x].filter(h=>h!==w))}),s}function vs(e){var r,o;const a=((r=e.preview)==null?void 0:r.outputPreview)??null,s=((o=e.metrics)==null?void 0:o.costUsd)??null;return`${e.status}|${a??""}|${s??""}`}function ws(e){return e.type?`${e.type}:${e.name??""}`:null}function js(e){if(!e)return null;const a=Date.parse(e);return Number.isNaN(a)?null:a}function ks(e){const a=js(e.startedAt),s=new Map;return e.steps.forEach(r=>{const o=js(r.startedAt),c=a!=null&&o!=null?o-a:null;s.set(r.id,{step:r,startMs:c})}),s}function Hi(e,a){const s=Math.max(e.metadata.wallTimeMs,a.metadata.wallTimeMs,1);return Math.max(1e3,Math.min(5e3,Math.round(s*.1)))}function Wi(e,a,s,r){const o=e.startMs;if(o==null)return null;let c=null,d=r+1;return a.forEach(p=>{const u=s.get(p);if(!u||u.startMs==null)return;const f=Math.abs(u.startMs-o);f<d&&(d=f,c=p)}),d<=r?c:null}const Ji=new Map,Vi=new Map,ot=new Map;async function Ki(){return[ma]}async function Js(e){return{trace:ma}}const Qi={s1:{role:"assistant",content:"I'll analyze the user's request and create a plan to fetch information from two sources: a web search for current EU AI Act updates and a database query for historical compliance data.",model:"gpt-4o-2024-11-20",usage:{prompt_tokens:150,completion_tokens:150,total_tokens:300},reasoning:"The user wants comprehensive information about AI regulations. I'll use parallel tool calls to maximize efficiency."},s2:{role:"assistant",content:null,tool_calls:[{id:"tc-001",type:"function",function:{name:"web_search",arguments:'{"q":"EU AI Act latest updates 2026"}'}},{id:"tc-002",type:"function",function:{name:"database_query",arguments:`{"sql":"SELECT * FROM compliance_records WHERE region='EU' ORDER BY date DESC LIMIT 10"}`}}],model:"gpt-4o-2024-11-20",usage:{prompt_tokens:80,completion_tokens:40,total_tokens:120}},s3:{tool_call_id:"tc-001",tool_name:"web_search",input:{q:"EU AI Act latest updates 2026"},output:{results:[{title:"EU AI Act Implementation Timeline",url:"https://example.com/ai-act",snippet:"The EU AI Act enters full force in 2026..."},{title:"High-Risk AI Systems Classification",url:"https://example.com/classification",snippet:"New guidance on high-risk categorization..."},{title:"Compliance Deadlines Approaching",url:"https://example.com/deadlines",snippet:"Organizations must comply by August 2026..."}],total_results:3,search_time_ms:1850},status:"success"},s4:{tool_call_id:"tc-002",tool_name:"database_query",input:{sql:"SELECT * FROM compliance_records WHERE region='EU' ORDER BY date DESC LIMIT 10"},output:{rows:[{id:1,company:"TechCorp",status:"compliant",date:"2026-01-15"},{id:2,company:"AIStartup",status:"in_progress",date:"2026-01-10"},{id:3,company:"DataCo",status:"compliant",date:"2026-01-05"}],row_count:42,query_time_ms:1100},status:"success"},s5:{role:"assistant",content:`Based on my analysis of the web search results and database records:

**Key Findings:**
1. The EU AI Act is now in full effect as of 2026
2. High-risk AI systems require specific compliance measures
3. 42 organizations in our database have compliance records

**Recommendations:**
- Review classification of AI systems
- Ensure documentation is complete
- Schedule compliance audit before August deadline`,model:"gpt-4o-2024-11-20",usage:{prompt_tokens:450,completion_tokens:250,total_tokens:700},reasoning:"Synthesized information from both the web search (3 relevant articles) and database query (42 compliance records) to provide actionable insights."}};function Yi(e,a){const s=ma.steps.find(c=>c.id===e);if(!s)return null;const r=Qi[e];if(!r)return null;const o=a?Xi(r):r;return{...s,data:o}}function Xi(e){var s,r;const a=JSON.parse(JSON.stringify(e));return(s=a.input)!=null&&s.sql&&(a.input.sql="[REDACTED]"),(r=a.output)!=null&&r.rows&&(a.output.rows=a.output.rows.map(o=>({...o,company:"[REDACTED]"}))),a.tool_calls&&(a.tool_calls=a.tool_calls.map(o=>({...o,function:{...o.function,arguments:"[REDACTED]"}}))),a}async function Zi(e,a,s,r=[],o=!1){return await new Promise(c=>setTimeout(c,150)),Yi(a,o)}async function el(e,a,s){await Zi(e,a,"redacted",[],s)}function tl(e,a){return()=>{}}function al(){Ji.clear(),Vi.clear()}async function nl(e,a){return null}async function sl(e){return null}async function vc(e,a){return[]}async function wc(e,a,s,r,o){return null}async function rl(){return[]}async function ol(e,a){return null}async function il(e,a,s,r,o){return o?Vs(o,a,s,r):null}function Vs(e,a,s,r){var v;const o=JSON.parse(JSON.stringify(e)),c=6e4,d=Date.parse("2024-01-01T00:00:00.000Z"),p=Date.parse(e.endedAt??e.startedAt??""),f=(Number.isNaN(p)?d:p)+c,b=new Date(f);o.id=`${e.id}-replay-${f}`,o.parentTraceId=e.id,o.branchPointStepId=a,o.replay={strategy:s,modifiedStepId:a,modifications:r,createdAt:b.toISOString()};const y=h=>{if(!h)return h;const k=Date.parse(h);return Number.isNaN(k)?h:new Date(k+c).toISOString()};o.startedAt=y(o.startedAt)??o.startedAt,o.endedAt=y(o.endedAt);const x=new Set,w=((v=o.steps.find(h=>h.id===a))==null?void 0:v.index)??-1;return s==="live"?o.steps.forEach(h=>{h.index>w&&x.add(h.id)}):s==="hybrid"&&o.steps.forEach(h=>{h.index>w&&x.add(h.id)}),o.steps=o.steps.map(h=>{var S;const k={...h};if(k.startedAt=y(h.startedAt)??h.startedAt,k.endedAt=y(h.endedAt),h.id===a){const $=((S=h.preview)==null?void 0:S.outputPreview)??"";k.preview={...h.preview,outputPreview:`${$} (modified)`.trim()}}return x.has(h.id)&&(k.status="pending",k.endedAt=null,k.durationMs=void 0,k.metrics=void 0,k.preview={...h.preview,outputPreview:"[invalidated for replay]"}),k}),o}async function ll(e){return ul(e)}async function cl(e){var a;return((a=ot.get(e))==null?void 0:a.job)??null}async function Ss(e){var a;return((a=ot.get(e))==null?void 0:a.matrix)??null}async function dl(e){{const a=ot.get(e);if(!a)return null;const s={...a.job,status:"canceled",scenarios:a.job.scenarios.map(r=>({...r,status:"canceled",endedAt:r.endedAt??new Date().toISOString()}))};return ot.set(e,{...a,job:s}),s}}function ul(e){const a=`demo-job-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,s=ma,r=new Date().toISOString(),o=e.scenarios.map((u,f)=>({id:`demo-scn-${f+1}`,name:u.name,strategy:u.strategy,modifications:u.modifications,status:"running",startedAt:r,endedAt:null,replayTraceId:`${a}-replay-${f+1}`})),c={id:a,traceId:e.traceId,stepId:e.stepId,status:"running",createdAt:r,startedAt:r,endedAt:null,scenarioCount:o.length,completedCount:0,failedCount:0,canceledCount:0,scenarios:o},d=o.map(u=>{const f=Vs(s,e.stepId,u.strategy,u.modifications);f.id=u.replayTraceId;const b=Ws(s,f),y=s.metadata.totalCostUsd??0,x=f.metadata.totalCostUsd??y,w=s.metadata.errorCount??0,v=f.metadata.errorCount??w,h=s.metadata.retryCount??0,k=f.metadata.retryCount??h,S=f.steps.filter($=>$.status==="pending").length;return{scenarioId:u.id,name:u.name,strategy:u.strategy,status:"completed",replayTraceId:u.replayTraceId,modifications:u.modifications,error:null,changedStepIds:b.changedSteps,addedStepIds:b.addedSteps,removedStepIds:b.removedSteps,metrics:{costDeltaUsd:x-y,wallTimeDeltaMs:(f.metadata.wallTimeMs??0)-(s.metadata.wallTimeMs??0),errorDelta:v-w,retryDelta:k-h,changedSteps:b.changedSteps.length,addedSteps:b.addedSteps.length,removedSteps:b.removedSteps.length,invalidatedStepCount:S}}}),p={jobId:a,traceId:e.traceId,stepId:e.stepId,rows:d,causalRanking:[]};return ot.set(a,{job:c,matrix:p}),window.setTimeout(()=>{const u=ot.get(a);if(!u)return;const f=new Date().toISOString(),b=u.job.scenarios.map(w=>({...w,status:"completed",endedAt:f})),y={...u.job,status:"completed",endedAt:f,completedCount:b.length,scenarios:b},x={...u.matrix,rows:u.matrix.rows.map(w=>({...w,status:"completed"}))};ot.set(a,{job:y,matrix:x})},600),c}async function pl(e){return null}async function ln(e){return null}async function ml(e){return null}async function hl(e){return null}async function fl(e){return null}async function Ns(e){return{session:null,conflict:!1,error:null}}async function Cs(e){return null}async function yl(e){return null}async function bl(e){return null}async function gl(e){return null}async function xl(e){return null}async function vl(e,a){return null}async function wl(e){return null}async function jl(e,a,s){return null}async function Ms(){return null}async function Es(){return null}function kl(e,a,s){return()=>{}}function Sl(){const[e,a]=l.useState(null),[s,r]=l.useState(null),[o,c]=l.useState(!0),[d,p]=l.useState(null),[u,f]=l.useState([]),[b,y]=l.useState(null),x=l.useCallback(async v=>{const h=await Js(),k=(h==null?void 0:h.trace)??null;a(k),r(k?(h==null?void 0:h.insights)??Bo(k):null)},[a,r]),w=l.useCallback(async()=>{var v;c(!0),p(null);try{const h=await Ki();f(h);const k=((v=h[h.length-1])==null?void 0:v.id)??null,S=b??k;if(!S){a(null),r(null);return}if(!b||b!==S){y(S);return}await x(S)}catch(h){p(h instanceof Error?h.message:"Failed to load trace")}finally{c(!1)}},[b,x]);return l.useEffect(()=>{w()},[w]),l.useEffect(()=>{b&&(c(!0),x(b).catch(v=>{p(v instanceof Error?v.message:"Failed to load trace")}).finally(()=>c(!1)))},[b,x]),l.useEffect(()=>tl(),[b,y]),{trace:e,insights:s,loading:o,error:d,reload:w,traces:u,selectedTraceId:b,setSelectedTraceId:y}}function Y(e,a){const[s,r]=l.useState(()=>{if(typeof window>"u")return a;try{const o=window.localStorage.getItem(e);return o==null?a:JSON.parse(o)}catch{return a}});return l.useEffect(()=>{try{window.localStorage.setItem(e,JSON.stringify(s))}catch{}},[e,s]),[s,r]}const Is=new Map;function Nl(e,a){const s=e.map(o=>o.id).join("|"),r=a.map(o=>`${o.source}->${o.target}`).join("|");return`${e.length}:${a.length}:${s}:${r}`}function Cl(e,a,s){if(s){const r=Nl(e,a),o=Is.get(s);if(o&&o.signature===r)return o.layout;const c=Ts(e,a);return Is.set(s,{signature:r,layout:c}),c}return Ts(e,a)}function Ts(e,a){if(e.length>2500){const r=Math.ceil(Math.sqrt(e.length));return e.map((o,c)=>{const d=Math.floor(c/r),p=c%r;return{id:o.id,position:{x:p*260,y:d*160}}})}const s=new ls.graphlib.Graph;return s.setGraph({rankdir:"LR",nodesep:48,ranksep:80}),s.setDefaultEdgeLabel(()=>({})),e.forEach(r=>{s.setNode(r.id,{width:220,height:120})}),a.forEach(r=>{s.setEdge(r.source,r.target)}),ls.layout(s),e.map(r=>{const o=s.node(r.id);return{id:r.id,position:{x:o.x-o.width/2,y:o.y-o.height/2}}})}const Ks="agentDirector.gameplayFunnel.v1";function Ml(){try{const e=window.localStorage.getItem(Ks);if(!e)return[];const a=JSON.parse(e);return Array.isArray(a)?a.filter(s=>{if(!s||typeof s!="object")return!1;const r=s;return typeof r.name=="string"&&typeof r.at=="number"&&!!r.metadata&&typeof r.metadata=="object"}):[]}catch{return[]}}function El(e,a={}){const s={name:e,at:Date.now(),metadata:a},o=[...Ml(),s].slice(-200);return window.localStorage.setItem(Ks,JSON.stringify(o)),s}function Il(e){const a=new Map;for(const r of e)r.type==="tool_call"&&r.toolCallId&&a.set(r.toolCallId,r.id);const s=[];for(const r of e)if(!(r.type!=="llm_call"||!r.io)){for(const o of r.io.emittedToolCallIds??[]){const c=a.get(o);c&&s.push({id:`io_emit_${r.id}_${c}`,source:r.id,target:c,kind:"io",toolCallId:o})}for(const o of r.io.consumedToolCallIds??[]){const c=a.get(o);c&&s.push({id:`io_consume_${c}_${r.id}`,source:c,target:r.id,kind:"io",toolCallId:o})}}return s}function Tl(e,a,s){const{intervals:r}=pa(e,a,s),o=new Set;return r.forEach(c=>{o.add(c.startMs),o.add(c.endMs)}),Array.from(o).sort((c,d)=>c-d)}function Dl(e,a,s){if(!e.length)return null;if(s===1){for(const r of e)if(r>a+1)return r;return e[e.length-1]}for(let r=e.length-1;r>=0;r-=1){const o=e[r];if(o<a-1)return o}return e[0]}const Al=300,$l=2e3,_l=1.5;function Rl(e){const a=Al*Math.pow(_l,Math.max(0,e));return Math.min($l,Math.round(a))}function Ze(e,a){if(!e)return a;try{return JSON.parse(e)}catch{return a}}function Ds(e,a){const s=new Map;return[...e,...a].forEach(r=>{const o=s.get(r.id);(!o||r.updatedAt>=o.updatedAt)&&s.set(r.id,r)}),Array.from(s.values()).sort((r,o)=>r.createdAt-o.createdAt)}function As(e,a=50){return[...e].sort((s,r)=>r.timestamp-s.timestamp).slice(0,a)}const Ol=[{minDepth:1,maxDepth:1,difficulty:1},{minDepth:2,maxDepth:3,difficulty:2},{minDepth:4,maxDepth:5,difficulty:3},{minDepth:6,maxDepth:7,difficulty:4},{minDepth:8,maxDepth:9,difficulty:5},{minDepth:10,maxDepth:12,difficulty:6},{minDepth:13,maxDepth:16,difficulty:7},{minDepth:17,maxDepth:20,difficulty:8},{minDepth:21,maxDepth:24,difficulty:9},{minDepth:25,maxDepth:Number.MAX_SAFE_INTEGER,difficulty:10}],da=["latency storm","cache divergence","tool timeout chain","stale prompt vector","schema mismatch surge"],$s=[{id:"seasonal-incident-sprint",title:"Resolve 3 raid objectives",goal:3,rewardCredits:120},{id:"boss-shutdown",title:"Defeat one boss encounter",goal:1,rewardCredits:200},{id:"guild-push",title:"Complete 2 guild operations",goal:2,rewardCredits:160},{id:"timeline-weaver",title:"Merge 2 timeline forks",goal:2,rewardCredits:150}],Pl={stability_patch:{credits:20,materials:12},precision_lens:{credits:28,materials:16},overclock_core:{credits:42,materials:24}};function oe(e,a,s){return Math.min(s,Math.max(a,e))}function Qs(e){let a=0;for(let s=0;s<e.length;s+=1)a=(a*31+e.charCodeAt(s))%1e5;return a}function Ll(e,a,s){const r=Qs(`${e}:${a}:${s.join("|")}`),o=da[r%da.length],c=da[Math.floor(r/7)%da.length],d=Array.from(new Set([o,c])),p=[...s].sort().slice(-2),u=`seed=${r};depth=${a};mutators=${p.join(",")||"none"}`;return{id:`mission-${a}-${(e+a)%997}`,title:`Scenario Depth ${a}`,difficulty:Fl(a),hazards:[...d,...p.slice(-1)],rewardCredits:60+a*15,missionSeed:r,blueprint:u}}function Ys(e,a,s){return Ll(e,a,s)}function Fl(e){var s;const a=Math.max(1,Math.floor(e));return((s=Ol.find(r=>a>=r.minDepth&&a<=r.maxDepth))==null?void 0:s.difficulty)??10}function ql(){return[{id:"node-alpha",title:"Signal Fracture",body:"Telemetry divergence emerges across parallel tool paths.",choices:[{id:"alpha-risk",label:"Push aggressive branch optimization",nextNodeId:"node-beta",tensionDelta:12,mutator:"risk-surge"},{id:"alpha-safe",label:"Stabilize and preserve deterministic flow",nextNodeId:"node-beta",tensionDelta:-5,mutator:"stability-first"}]},{id:"node-beta",title:"Protocol Fork",body:"The team must choose speed versus interpretability under pressure.",choices:[{id:"beta-speed",label:"Favor speed and absorb uncertainty",nextNodeId:"node-gamma",tensionDelta:8,mutator:"throughput-boost"},{id:"beta-clarity",label:"Favor clarity and route through guardrails",nextNodeId:"node-gamma",tensionDelta:-3,mutator:"clarity-path"}]},{id:"node-gamma",title:"Final Directive",body:"Command has one move left before the run locks in.",choices:[{id:"gamma-strike",label:"Launch decisive strike sequence",nextNodeId:"node-alpha",tensionDelta:10,mutator:"strike-loop"},{id:"gamma-reset",label:"Reset tempo and rebuild confidence",nextNodeId:"node-alpha",tensionDelta:-6,mutator:"tempo-reset"}]}]}function Xs(e,a){return{...$s[(e+a)%$s.length],progress:0,completed:!1}}function Zs(e,a){const s=[...e,a];return Array.from(new Set(s)).slice(-6)}function pn(e,a,s){return{...e,campaign:{...e.campaign,depth:a,mutators:s,currentMission:Ys(e.seed,a,s)}}}function _s(e){const a=Qs(e),s=["baseline"];return{seed:a,raid:{party:["director"],roles:{director:"strategist"},objectives:[{id:"obj-root-cause",label:"Identify root cause chain",progress:0,target:100,completed:!1},{id:"obj-recover",label:"Recover operational stability",progress:0,target:100,completed:!1},{id:"obj-harden",label:"Harden replay strategy",progress:0,target:100,completed:!1}],completed:!1},campaign:{depth:1,lives:3,completedMissionIds:[],mutators:s,currentMission:Ys(a,1,s)},narrative:{currentNodeId:"node-alpha",nodes:ql(),history:[],tension:35},skills:{points:6,nodes:[{id:"skill-focus",label:"Focus Matrix",cost:1,requires:[],minLevel:1,requiredMilestones:[],tier:1,loadoutSlot:"core",unlocked:!1},{id:"skill-resilience",label:"Resilience Mesh",cost:1,requires:[],minLevel:1,requiredMilestones:[],tier:1,loadoutSlot:"utility",unlocked:!1},{id:"skill-surge",label:"Surge Compiler",cost:2,requires:["skill-focus"],minLevel:2,requiredMilestones:[],tier:2,loadoutSlot:"power",unlocked:!1},{id:"skill-echo",label:"Echo Anticipator",cost:2,requires:["skill-resilience"],minLevel:2,requiredMilestones:[],tier:2,loadoutSlot:"utility",unlocked:!1},{id:"skill-ward",label:"Ward Lattice",cost:2,requires:["skill-resilience"],minLevel:3,requiredMilestones:["milestone-level-3"],tier:3,loadoutSlot:"power",unlocked:!1},{id:"skill-overclock",label:"Overclock Nexus",cost:3,requires:["skill-surge","skill-echo"],minLevel:4,requiredMilestones:["milestone-level-3"],tier:3,loadoutSlot:"power",unlocked:!1}],loadout:{capacity:3,equipped:[],slotCaps:{core:1,utility:1,power:1}}},pvp:{round:0,stability:72,sabotage:28,fog:40,winner:null},time:{activeForkId:"primary",forks:[{id:"primary",label:"Primary timeline",playheadMs:0,history:[0]}]},boss:{name:"The Causality Hydra",phase:1,hp:320,maxHp:320,enraged:!1,phaseMechanic:"Phase 1: Shield lattice destabilization",vulnerability:"exploit"},director:{risk:30,hint:"Start with the bottleneck path and branch cautiously.",recommendedModifier:"stability_patch",lastOutcome:"mixed"},economy:{credits:140,materials:90,crafted:[],inflationIndex:.438,reserveTarget:320},rewards:{dailyClaimedOn:null,streakDays:0,sessionClaimed:!1,streakClaimedFor:0,masteryClaims:[],history:[]},guild:{name:"Trace Guild",members:4,operationsScore:0,eventsCompleted:0},cinematic:{queue:[]},liveops:{season:`Season-${2026+a%2}`,week:1,challenge:Xs(a,1),difficultyFactor:1,rewardMultiplier:1,tuningHistory:[]},teamComms:{pings:[]},safety:{mutedPlayerIds:[],blockedPlayerIds:[],reports:[]},outcome:{status:"in_progress",reason:"Run started. Complete missions and stabilize the incident.",updatedAt:Date.now()},sandbox:{enabled:!1},progression:{xp:0,level:1,nextLevelXp:200,milestones:[]}}}function jc(e,a){return{...e,sandbox:{enabled:a},outcome:a?{status:"in_progress",reason:"Sandbox mode enabled. Penalties are disabled for safe practice runs.",updatedAt:Date.now()}:e.outcome}}function kc(e,a,s){if(!a.trim())return e;const r=e.raid.party.includes(a)?e.raid.party:[...e.raid.party,a];return{...e,raid:{...e.raid,party:r,roles:{...e.raid.roles,[a]:s}}}}function Sc(e,a,s){const r=gn(e),o=e.raid.objectives.map(u=>{if(u.id!==a)return u;const f=oe(u.progress+s,0,u.target);return{...u,progress:f,completed:f>=u.target}}),c=o.every(u=>u.completed),d=c&&!e.raid.completed?180:0,p={...e,raid:{...e.raid,objectives:o,completed:c},outcome:c&&!e.raid.completed?{status:"partial",reason:"Raid objectives completed. Push campaign and boss tracks to close the run.",updatedAt:Date.now()}:r};return!c||e.raid.completed?p:We(Bt(p,d),60)}function Nc(e,a){const s=Wl(e),r=e.campaign.currentMission;if(a){const u=e.campaign.depth+1,f=pn(e,u,e.campaign.mutators),b=u>=5?{status:"win",reason:"Campaign depth target reached. Incident run is stabilized.",updatedAt:Date.now()}:{status:"partial",reason:`Mission ${r.id} cleared. Advance deeper to secure the run.`,updatedAt:Date.now()},y={...f,campaign:{...f.campaign,completedMissionIds:[...f.campaign.completedMissionIds,r.id]},economy:{...f.economy,materials:f.economy.materials+14},director:{...f.director,lastOutcome:"success"},outcome:b};return We(Bt(y,r.rewardCredits),120)}const o=s.enabled?e.campaign.lives:oe(e.campaign.lives-1,0,3),c=pn(e,e.campaign.depth,Zs(e.campaign.mutators,"failure-loop")),d=s.enabled?{status:"partial",reason:"Sandbox mode active. Failure recorded with no life penalty.",updatedAt:Date.now()}:o<=0?{status:"loss",reason:"No campaign lives remaining. Incident run failed.",updatedAt:Date.now()}:{status:"partial",reason:`Mission failed. ${o} campaign lives remaining.`,updatedAt:Date.now()},p={...c,campaign:{...c.campaign,lives:o},director:{...c.director,lastOutcome:"failure"},outcome:d};return We(p,40)}function Cc(e,a){const s=e.narrative.nodes.find(p=>p.id===e.narrative.currentNodeId),r=s==null?void 0:s.choices.find(p=>p.id===a);if(!s||!r)return e;const o=oe(e.narrative.tension+r.tensionDelta,0,100),c=Zs(e.campaign.mutators,r.mutator),d=pn(e,e.campaign.depth,c);return{...d,narrative:{...d.narrative,currentNodeId:r.nextNodeId,history:[...d.narrative.history,{nodeId:s.id,choiceId:r.id}],tension:o}}}function Mc(e,a){const s=e.skills.nodes.find(o=>o.id===a);return!s||!Gl(e,a).allowed?e:{...e,skills:{...e.skills,points:e.skills.points-s.cost,nodes:e.skills.nodes.map(o=>o.id===a?{...o,unlocked:!0}:o)}}}function Ec(e,a){return Bl(e,a).allowed?{...e,skills:{...e.skills,loadout:{...e.skills.loadout,equipped:[...e.skills.loadout.equipped,a]}}}:e}function Gl(e,a){const s=e.skills.nodes.find(p=>p.id===a);if(!s)return{allowed:!1,reason:"Unknown skill node."};if(s.unlocked)return{allowed:!1,reason:"Skill already unlocked."};const r=new Set(e.skills.nodes.filter(p=>p.unlocked).map(p=>p.id)),o=s.requires.filter(p=>!r.has(p));if(o.length>0)return{allowed:!1,reason:`Requires: ${o.join(", ")}`};const c=tr(e);if(c.level<s.minLevel)return{allowed:!1,reason:`Requires level ${s.minLevel}`};const d=s.requiredMilestones.filter(p=>!c.milestones.includes(p));return d.length>0?{allowed:!1,reason:`Requires milestone ${d[0]}`}:e.skills.points<s.cost?{allowed:!1,reason:`Need ${s.cost} points`}:{allowed:!0,reason:"Unlock available"}}function Bl(e,a){const s=e.skills.nodes.find(c=>c.id===a);if(!s)return{allowed:!1,reason:"Unknown skill node."};if(!s.unlocked)return{allowed:!1,reason:"Unlock required before equip."};if(e.skills.loadout.equipped.includes(a))return{allowed:!1,reason:"Already equipped."};if(e.skills.loadout.equipped.length>=e.skills.loadout.capacity)return{allowed:!1,reason:"Loadout capacity reached."};const r=e.skills.loadout.slotCaps[s.loadoutSlot];return e.skills.loadout.equipped.reduce((c,d)=>{const p=e.skills.nodes.find(u=>u.id===d);return(p==null?void 0:p.loadoutSlot)===s.loadoutSlot?c+1:c},0)>=r?{allowed:!1,reason:`${s.loadoutSlot} slot limit reached.`}:{allowed:!0,reason:"Equip available"}}function Ic(e,a){const s=gn(e),r={...e.pvp};a==="sabotage"?(r.sabotage=oe(r.sabotage+13,0,100),r.stability=oe(r.stability-11,0,100),r.fog=oe(r.fog+9,0,100)):a==="stabilize"?(r.stability=oe(r.stability+14,0,100),r.sabotage=oe(r.sabotage-8,0,100),r.fog=oe(r.fog-6,0,100)):(r.fog=oe(r.fog-16,0,100),r.stability=oe(r.stability+3,0,100),r.sabotage=oe(r.sabotage-4,0,100)),r.round+=1,r.stability<=0?r.winner="saboteur":r.sabotage<=0?r.winner="operator":r.round>=10&&(r.winner=r.stability>=r.sabotage?"operator":"saboteur");const o=r.winner==="operator"?{status:"win",reason:"Operator side prevailed in the sabotage conflict.",updatedAt:Date.now()}:r.winner==="saboteur"?{status:"loss",reason:"Saboteur pressure overwhelmed system stability.",updatedAt:Date.now()}:s,c={...e,pvp:r,outcome:o};return We(c,r.winner?72:12)}function Tc(e,a,s){const r=`fork-${e.time.forks.length+1}`,o={id:r,label:a.trim()||r,playheadMs:oe(s,0,36e5),history:[oe(s,0,36e5)]};return{...e,time:{...e.time,activeForkId:r,forks:[...e.time.forks,o]}}}function Dc(e,a){const s=e.time.activeForkId,r=e.time.forks.map(o=>{if(o.id!==s)return o;const c=oe(o.playheadMs-Math.abs(a),0,36e5);return{...o,playheadMs:c,history:[...o.history,c]}});return{...e,time:{...e.time,forks:r}}}function Ac(e,a){if(a==="primary")return e;const s=e.time.forks.find(c=>c.id===a),r=e.time.forks.find(c=>c.id==="primary");if(!s||!r)return e;const o={...r,playheadMs:s.playheadMs,history:[...r.history,s.playheadMs]};return{...e,time:{activeForkId:"primary",forks:[o,...e.time.forks.filter(c=>c.id!=="primary"&&c.id!==a)]}}}function $c(e,a){const s=gn(e),o={1:{exploit:42,strike:24,shield:8},2:{exploit:34,strike:28,shield:10},3:{exploit:26,strike:18,shield:14}}[e.boss.phase][a],c=e.boss.vulnerability===a?8:0,d=o+c,p=oe(e.boss.hp-d,0,e.boss.maxHp),u=p/e.boss.maxHp,f=u<=.33?3:u<=.66?2:1,b=f===1?"Phase 1: Shield lattice destabilization":f===2?"Phase 2: Mirror clones absorb exploit damage":"Phase 3: Enrage pulse; shield counters become lethal",y=f===1?"exploit":f===2?"strike":"shield",x={...e,boss:{...e.boss,hp:p,phase:f,enraged:f===3||p<=e.boss.maxHp*.2,phaseMechanic:b,vulnerability:y},outcome:p<=0?{status:"win",reason:"Boss encounter cleared. Run secured.",updatedAt:Date.now()}:s};return We(x,p<=0?180:10)}function _c(e,a){const s=a.failures*12+a.retries*4+(a.latencyMs>1400?8:0),r=oe(e.director.risk+s,0,100),o=a.failures>0?"Prioritize failure triage and run a stabilizing replay branch.":a.latencyMs>1400?"Latency pressure detected. Reduce fan-out and tighten tool boundaries.":"Momentum is stable. Push a high-confidence optimization branch.",c=a.failures>1?"stability_patch":a.latencyMs>1400?"precision_lens":"overclock_core",d=a.failures>0?"failure":"success";return{...e,director:{risk:r,hint:o,recommendedModifier:c,lastOutcome:d}}}function Rc(e,a){const s=Pl[a];if(!s||e.economy.credits<s.credits||e.economy.materials<s.materials)return e;const r=e.economy.crafted.includes(a)?e.economy.crafted:[...e.economy.crafted,a],o=e.economy.reserveTarget||320,c=e.economy.credits-s.credits;let d={...e,economy:{...e.economy,credits:c,materials:e.economy.materials-s.materials,crafted:r,inflationIndex:Number((c/o).toFixed(3))}};return a==="stability_patch"&&(d={...d,pvp:{...d.pvp,stability:oe(d.pvp.stability+8,0,100)}}),a==="precision_lens"&&(d={...d,raid:{...d.raid,objectives:d.raid.objectives.map((p,u)=>u===0?{...p,progress:oe(p.progress+10,0,p.target),completed:oe(p.progress+10,0,p.target)>=p.target}:p)}}),a==="overclock_core"&&(d={...d,boss:{...d.boss,hp:oe(d.boss.hp-16,0,d.boss.maxHp)}}),We(d,10)}function Oc(e,a){const s=Math.round(a),r={...e,guild:{...e.guild,operationsScore:e.guild.operationsScore+s,eventsCompleted:e.guild.eventsCompleted+(s>0?1:0)}},o=s>0?Bt(r,s*3):r;return We(o,Math.max(0,s*6))}function Pc(e,a,s,r){const o={id:`event-${e.cinematic.queue.length+1}-${e.seed%1e3}`,type:a,message:s,intensity:r,at:Date.now()};return{...e,cinematic:{queue:[o,...e.cinematic.queue].slice(0,12)}}}function Lc(e){const a=yn(e),s=a.week+1,r=Xs(e.seed,s),o=oe(a.difficultyFactor??1,.6,1.6),c=oe(a.rewardMultiplier??1,.5,2),d={...r,goal:Math.max(1,Math.round(r.goal*o)),rewardCredits:Math.max(1,Math.round(r.rewardCredits*c))},p={...e,liveops:{...a,week:s,challenge:d}};return Ul(p)}function Fc(e,a){const s=yn(e),r=s.challenge,o=oe(a,0,20),c=oe(r.progress+o,0,r.goal),d=c>=r.goal,p={...e,liveops:{...s,challenge:{...r,progress:c,completed:d}}};return!d||r.completed?p:We(Bt(p,r.rewardCredits),80)}function zl(e,a,s="raid_mastery"){const r=er(e),o=new Date().toISOString().slice(0,10);return a==="daily"?r.dailyClaimedOn===o?{allowed:!1,reason:"Daily reward already claimed today."}:{allowed:!0,reason:"Daily reward available."}:a==="session"?r.sessionClaimed?{allowed:!1,reason:"Session reward already claimed."}:e.raid.objectives.some(p=>p.progress>0)||e.campaign.depth>1||e.pvp.round>0?{allowed:!0,reason:"Session reward available."}:{allowed:!1,reason:"Session reward requires gameplay activity."}:a==="streak"?r.streakDays<3?{allowed:!1,reason:"Streak reward requires 3+ daily claims."}:r.streakClaimedFor>=r.streakDays?{allowed:!1,reason:"Streak reward already claimed for current streak."}:{allowed:!0,reason:"Streak reward available."}:r.masteryClaims.includes(s)?{allowed:!1,reason:"Mastery reward already claimed."}:(s==="raid_mastery"?e.raid.completed:s==="campaign_mastery"?e.campaign.depth>=4:e.boss.hp<=0)?{allowed:!0,reason:"Mastery reward available."}:{allowed:!1,reason:"Mastery requirement not met."}}function qc(e,a,s="raid_mastery"){if(!zl(e,a,s).allowed)return e;const o=er(e),c=new Date().toISOString().slice(0,10);let d=o,p=0,u={};if(a==="daily"){const x=o.dailyClaimedOn===c?o.streakDays:o.streakDays+1;d={...o,dailyClaimedOn:c,streakDays:x},p=90+Math.min(7,x)*10,u={streakDays:x}}else a==="session"?(d={...o,sessionClaimed:!0},p=140,u={actions:e.pvp.round+e.narrative.history.length+e.campaign.depth}):a==="streak"?(d={...o,streakClaimedFor:o.streakDays},p=170+o.streakDays*5,u={streakDays:o.streakDays}):(d={...o,masteryClaims:[...o.masteryClaims,s]},p=s==="boss_mastery"?260:s==="campaign_mastery"?220:180,u={masteryId:s});const f=Bt({...e,rewards:d},p),b=Math.max(1,f.economy.credits-e.economy.credits),y={id:`reward-${d.history.length+1}-${e.seed%1e3}`,kind:a,amount:b,at:Date.now(),details:u};return We({...f,rewards:{...d,history:[y,...d.history].slice(0,60)}},30+Math.max(1,Math.round(b/10)))}function Gc(e,a){const s=yn(e),r=oe(a.difficultyFactor,.6,1.6),o=oe(a.rewardMultiplier,.5,2),c=s.difficultyFactor||1,d=s.rewardMultiplier||1,p=a.note.trim()||"Operator tuning update",u={...s.challenge,goal:Math.max(1,Math.round(s.challenge.goal/c*r)),rewardCredits:Math.max(1,Math.round(s.challenge.rewardCredits/d*o))},f={id:`tuning-${s.tuningHistory.length+1}-${e.seed%1e3}`,changedAt:Date.now(),difficultyFactor:r,rewardMultiplier:o,note:p};return{...e,liveops:{...s,challenge:u,difficultyFactor:r,rewardMultiplier:o,tuningHistory:[f,...s.tuningHistory].slice(0,20)}}}function Bt(e,a){if(a<=0)return e;const s=e.economy.reserveTarget||320,r=e.economy.credits;let o=1;if(r<=s){const b=Math.min(.12,(s-r)/s*.12);o=Math.min(1.12,1+b)}else{const b=(r-s)/s;o=Math.max(.45,1-b*.35)}const c=Math.max(1,Math.round(a*o)),d=Math.round(s*1.7),p=r+c,u=p>d?Math.max(1,Math.round((p-d)*.22)):0,f=p-u;return{...e,economy:{...e.economy,credits:f,inflationIndex:Number((f/s).toFixed(3))}}}function Ul(e){const a=e.economy.reserveTarget||320;if(e.economy.credits<=a)return{...e,economy:{...e.economy,inflationIndex:Number((e.economy.credits/a).toFixed(3))}};const s=Math.max(6,Math.round((e.economy.credits-a)*.08)),r=Math.max(0,e.economy.credits-s);return{...e,economy:{...e.economy,credits:r,inflationIndex:Number((r/a).toFixed(3))}}}function yn(e){var a,s,r,o,c,d;return{season:((a=e.liveops)==null?void 0:a.season)??"Season-2026",week:((s=e.liveops)==null?void 0:s.week)??1,challenge:((r=e.liveops)==null?void 0:r.challenge)??{id:"fallback-liveops",title:"Complete one objective",goal:1,progress:0,rewardCredits:100,completed:!1},difficultyFactor:((o=e.liveops)==null?void 0:o.difficultyFactor)??1,rewardMultiplier:((c=e.liveops)==null?void 0:c.rewardMultiplier)??1,tuningHistory:((d=e.liveops)==null?void 0:d.tuningHistory)??[]}}function er(e){return e.rewards??{dailyClaimedOn:null,streakDays:0,sessionClaimed:!1,streakClaimedFor:0,masteryClaims:[],history:[]}}function Hl(e){return e.teamComms??{pings:[]}}function ha(e){return e.trim().toLowerCase()}function bn(e){return e.safety??{mutedPlayerIds:[],blockedPlayerIds:[],reports:[]}}function Bc(e,a,s,r="director"){const o=a,c=(s??"").trim(),d=c.length>0;if(d&&!e.raid.objectives.some(f=>f.id===c))return e;const p=Hl(e),u={id:`ping-${p.pings.length+1}-${e.seed%1e3}`,fromPlayerId:ha(r)||"director",intent:o,targetObjectiveId:d?c:null,createdAt:Date.now()};return{...e,teamComms:{pings:[u,...p.pings].slice(0,50)}}}function gn(e){return e.outcome??{status:"in_progress",reason:"Run in progress.",updatedAt:Date.now()}}function Wl(e){return e.sandbox??{enabled:!1}}function tr(e){return e.progression??{xp:0,level:1,nextLevelXp:200,milestones:[]}}function We(e,a){if(a<=0)return e;const s=tr(e);let r=s.xp+a,o=s.level,c=s.nextLevelXp,d=0;for(;r>=c;)r-=c,o+=1,d+=1,c=o*200;const p=[...s.milestones];return[3,5,10].forEach(u=>{const f=`milestone-level-${u}`;o>=u&&!p.includes(f)&&p.push(f)}),{...e,progression:{xp:r,level:o,nextLevelXp:c,milestones:p},skills:{...e.skills,points:e.skills.points+d}}}function zc(e,a,s){const r=ha(a),o=s.trim();if(!r||!o)return e;const c=bn(e),d={id:`report-${c.reports.length+1}-${e.seed%1e3}`,targetPlayerId:r,reason:o,createdAt:Date.now()};return{...e,safety:{...c,reports:[d,...c.reports].slice(0,40)}}}function Uc(e,a){const s=ha(a),r=bn(e);return!s||r.mutedPlayerIds.includes(s)?e:{...e,safety:{...r,mutedPlayerIds:[...r.mutedPlayerIds,s]}}}function Hc(e,a){const s=ha(a),r=bn(e);return!s||r.blockedPlayerIds.includes(s)?e:{...e,safety:{...r,blockedPlayerIds:[...r.blockedPlayerIds,s],mutedPlayerIds:r.mutedPlayerIds.includes(s)?r.mutedPlayerIds:[...r.mutedPlayerIds,s]}}}const Jl=new Set(["cinema","flow","compare","matrix","gameplay"]);function cn(e){if(!e)return;const a=e.trim();return a.length?a:void 0}function Rs(e){const a=new URLSearchParams(e),s=cn(a.get("mode")),r=cn(a.get("trace")),o=cn(a.get("step")),c={};return s&&Jl.has(s)&&(c.mode=s),r&&(c.traceId=r),o&&(c.stepId=o),c}function Vl(e,a){const s=new URL(e);return a.mode?s.searchParams.set("mode",a.mode):s.searchParams.delete("mode"),a.traceId?s.searchParams.set("trace",a.traceId):s.searchParams.delete("trace"),a.stepId?s.searchParams.set("step",a.stepId):s.searchParams.delete("step"),s.toString()}const mn={setupWizardV1:!0,supportPanelV1:!0,exportCenterV1:!0,ownershipPanelV1:!0},ar="agentDirector.analytics.events.v1",nr="agentDirector.featureFlags.v1",Kl=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;function Ql(e){const a=e.dataSource.trim(),s=e.importPath.trim(),o=e.inviteEmails.split(",").map(u=>u.trim()).filter(Boolean).filter(u=>!Kl.test(u)),c=a?null:"Select a data source.",d=s?null:"Import path is required.",p=o.length?`Invalid invite email(s): ${o.join(", ")}`:null;return{dataSourceError:c,importPathError:d,inviteEmailsError:p,isValid:!c&&!d&&!p}}function Yl(e,a){const s=a.updatedAt??Date.now(),r={...a,updatedAt:s},o=e.findIndex(d=>d.id===r.id);if(o===-1)return[r,...e].slice(0,12);const c=[...e];return c[o]={...c[o],...r},c.sort((d,p)=>p.updatedAt-d.updatedAt),c.slice(0,12)}function Xl(e){try{const a=JSON.parse(e.getItem(ar)??"[]");return Array.isArray(a)?a.filter(s=>{if(!s||typeof s!="object")return!1;const r=s;return typeof r.name=="string"&&typeof r.at=="string"&&typeof r.metadata=="object"}).slice(-250):[]}catch{return[]}}function Zl(e,a){const r=[...Xl(e),a].slice(-250);return e.setItem(ar,JSON.stringify(r)),r}function ec(e){var a,s;return{capturedAt:new Date().toISOString(),app:"agent-director",mode:e.mode,traceId:((a=e.trace)==null?void 0:a.id)??null,traceStatus:((s=e.trace)==null?void 0:s.status)??null,stepCount:e.stepCount,selectedStepId:e.selectedStepId,workspaceId:e.workspaceId,workspaceRole:e.workspaceRole,safeExport:e.safeExport,userAgent:typeof navigator<"u"?navigator.userAgent:"unknown",online:typeof navigator<"u"?navigator.onLine:!0,recentNotifications:e.notifications.slice(-6),asyncActions:e.actions.slice(0,8)}}function tc(e){try{const a=JSON.parse(e.getItem(nr)??"{}");if(!a||typeof a!="object")return{...mn};const s=a;return{setupWizardV1:s.setupWizardV1!==!1,supportPanelV1:s.supportPanelV1!==!1,exportCenterV1:s.exportCenterV1!==!1,ownershipPanelV1:s.ownershipPanelV1!==!1}}catch{return{...mn}}}function ac(e,a){e.setItem(nr,JSON.stringify(a))}const Os=220,Ps=120,hn="agentDirector.presence.v1",nc=2e4,sc=5e3,vt="agentDirector.collab.cursors.v1",dn="agentDirector.collab.annotations.v1",un="agentDirector.collab.activity.v1",rc=6e3,Ls=[{id:"personal",label:"Personal"},{id:"operations",label:"Operations"},{id:"executive",label:"Executive"}],oc=l.lazy(()=>Gt(()=>import("./index-MrhOUbgC.js"),__vite__mapDeps([0,1,2,3]))),ic=l.lazy(()=>Gt(()=>import("./index-C6t_fIQh.js"),__vite__mapDeps([4,1,2,3]))),lc=l.lazy(()=>Gt(()=>import("./index-Dy4Ggd2B.js"),__vite__mapDeps([5,1,2,3]))),cc=l.lazy(()=>Gt(()=>import("./index-GxDP3Oyw.js"),__vite__mapDeps([6,1,2,3]))),dc=l.lazy(()=>Gt(()=>import("./index-BXRJTS9D.js"),__vite__mapDeps([7,1,2,3])));function ua(){return`scenario-${Math.random().toString(36).slice(2,9)}`}function uc(e){return e.filter(a=>a.parentStepId).map(a=>({source:a.parentStepId,target:a.id}))}function pc(e){const a=[...e].sort((s,r)=>s.index-r.index);return a.slice(1).map((s,r)=>({source:a[r].id,target:s.id}))}function mc(e){const a={},s=e.getBoundingClientRect();return e.querySelectorAll(".step-card").forEach(o=>{const c=o.dataset.stepId;if(!c)return;const d=o.getBoundingClientRect();a[c]={left:d.left-s.left,top:d.top-s.top,width:d.width,height:d.height}}),a}function hc(e,a,s){const r=[...uc(e),...pc(e),...Il(e).map(v=>({source:v.source,target:v.target}))],o=Cl(e,r,s),c=a.getBoundingClientRect(),d=Math.min(...o.map(v=>v.position.x)),p=Math.min(...o.map(v=>v.position.y)),u=Math.max(...o.map(v=>v.position.x)),f=Math.max(...o.map(v=>v.position.y)),b=u-d+Os,y=f-p+Ps,x=Math.max(32,(c.width-b)/2),w=Math.max(24,(c.height-y)/2);return o.reduce((v,h)=>(v[h.id]={left:h.position.x-d+x,top:h.position.y-p+w,width:Os,height:Ps},v),{})}function Fs(e,a,s){const r=a.trim().toLowerCase();return e.filter(o=>{var d,p,u;return s!=="all"&&o.type!==s?!1:r?[o.name,(d=o.preview)==null?void 0:d.title,(p=o.preview)==null?void 0:p.outputPreview,(u=o.preview)==null?void 0:u.inputPreview].filter(Boolean).join(" ").toLowerCase().includes(r):!0})}function fc(e,a,s){var f,b,y,x,w,v,h,k,S,$,X,E,R,z,L,q,V,se,j,I,O,J,N,K,D,F,P,he,Ce;const r=e.profiles[a]??e.profiles[((f=e.players[0])==null?void 0:f.player_id)??""]??Object.values(e.profiles)[0],o=e.players.reduce((C,B)=>(C[B.player_id]=B.role,C),{}),c=Object.entries(e.narrative.nodes).map(([C,B])=>({id:C,title:B.title,body:B.title,choices:B.choices.map(fe=>({id:fe.id,label:fe.id,nextNodeId:fe.next,tensionDelta:fe.tension,mutator:fe.modifier}))})),d=e.pvp.winner??null,u=e.telemetry.failures>0?"failure":d?"success":"mixed";return{seed:e.seed,raid:{party:e.players.map(C=>C.player_id),roles:o,objectives:e.raid.objectives.map(C=>({id:C.id,label:C.label,progress:C.progress,target:C.target,completed:C.completed})),completed:e.raid.completed},campaign:{depth:e.campaign.depth,lives:e.campaign.lives,currentMission:{id:e.campaign.current_mission.id,title:e.campaign.current_mission.title,difficulty:e.campaign.current_mission.difficulty,hazards:e.campaign.current_mission.hazards,rewardCredits:e.campaign.current_mission.reward_tokens,missionSeed:e.campaign.current_mission.mission_seed??s.campaign.currentMission.missionSeed??e.seed,blueprint:e.campaign.current_mission.blueprint??s.campaign.currentMission.blueprint??`seed=${e.seed};depth=${e.campaign.depth}`},completedMissionIds:e.campaign.completed_missions,mutators:[...e.campaign.modifiers,...e.campaign.unlocked_modifiers]},narrative:{currentNodeId:e.narrative.current_node_id,nodes:c.length>0?c:s.narrative.nodes,history:e.narrative.history.map(C=>({nodeId:C.node_id,choiceId:C.choice_id})),tension:e.narrative.tension},skills:{points:(r==null?void 0:r.skill_points)??s.skills.points,nodes:s.skills.nodes.map(C=>({...C,unlocked:!!(r!=null&&r.unlocked_skills.includes(C.id))})),loadout:{capacity:(r==null?void 0:r.loadout_capacity)??s.skills.loadout.capacity,equipped:(r==null?void 0:r.loadout)??[],slotCaps:s.skills.loadout.slotCaps}},pvp:{round:e.pvp.round,stability:e.pvp.operator_stability,sabotage:e.pvp.sabotage_pressure,fog:e.pvp.fog,winner:d},time:{activeForkId:e.time.active_fork_id,forks:e.time.forks.map(C=>({id:C.id,label:C.label,playheadMs:C.playhead_ms,history:C.history}))},boss:{name:e.boss.name,phase:e.boss.phase,hp:e.boss.hp,maxHp:e.boss.max_hp,enraged:e.boss.enraged,phaseMechanic:e.boss.phase_mechanic??(e.boss.phase===1?"Phase 1: Shield lattice destabilization":e.boss.phase===2?"Phase 2: Mirror clones absorb exploit damage":"Phase 3: Enrage pulse; shield counters become lethal"),vulnerability:e.boss.vulnerability==="strike"||e.boss.vulnerability==="shield"||e.boss.vulnerability==="exploit"?e.boss.vulnerability:e.boss.phase===1?"exploit":e.boss.phase===2?"strike":"shield"},director:{risk:e.director.risk,hint:e.director.hint,recommendedModifier:e.director.hazard_bias,lastOutcome:u},economy:{credits:e.economy.tokens,materials:e.economy.materials,crafted:e.economy.crafted,reserveTarget:((b=e.economy.policy)==null?void 0:b.target_reserve)??s.economy.reserveTarget??320,inflationIndex:e.economy.inflation_index??Number((e.economy.tokens/(((y=e.economy.policy)==null?void 0:y.target_reserve)??s.economy.reserveTarget??320)).toFixed(3))},rewards:{dailyClaimedOn:((x=e.rewards)==null?void 0:x.daily_claimed_date)??((w=s.rewards)==null?void 0:w.dailyClaimedOn)??null,streakDays:((v=e.rewards)==null?void 0:v.streak_days)??((h=s.rewards)==null?void 0:h.streakDays)??0,sessionClaimed:((k=e.rewards)==null?void 0:k.session_claimed)??((S=s.rewards)==null?void 0:S.sessionClaimed)??!1,streakClaimedFor:(($=e.rewards)==null?void 0:$.streak_claimed_for)??((X=s.rewards)==null?void 0:X.streakClaimedFor)??0,masteryClaims:((E=e.rewards)==null?void 0:E.mastery_claims)??((R=s.rewards)==null?void 0:R.masteryClaims)??[],history:((L=(z=e.rewards)==null?void 0:z.history)==null?void 0:L.map(C=>({id:C.id,kind:C.kind==="daily"||C.kind==="session"||C.kind==="streak"||C.kind==="mastery"?C.kind:"daily",amount:C.amount,at:Date.parse(C.at)||Date.now(),details:C.details?Object.fromEntries(Object.entries(C.details).map(([B,fe])=>[B,String(fe)])):{}})))??((q=s.rewards)==null?void 0:q.history)??[]},guild:{name:e.guild.guild_id??"Trace Guild",members:e.players.length,operationsScore:e.guild.operations_score,eventsCompleted:e.guild.events_completed},cinematic:{queue:e.cinematic.events.map(C=>({id:C.id,type:C.type==="critical"||C.type==="success"||C.type==="warning"||C.type==="twist"?C.type:"warning",message:C.message,intensity:C.intensity||1,at:Date.parse(C.at)||Date.now()}))},liveops:{season:e.liveops.season,week:e.liveops.week,challenge:{id:e.liveops.challenge.id,title:e.liveops.challenge.title,goal:e.liveops.challenge.goal,progress:e.liveops.challenge.progress,rewardCredits:e.liveops.challenge.reward,completed:e.liveops.challenge.completed},difficultyFactor:e.liveops.telemetry.difficultyFactor??s.liveops.difficultyFactor??1,rewardMultiplier:e.liveops.telemetry.rewardMultiplier??s.liveops.rewardMultiplier??1,tuningHistory:((V=e.liveops.tuning_history)==null?void 0:V.map(C=>({id:C.id,changedAt:Date.parse(C.changed_at)||Date.now(),difficultyFactor:C.difficultyFactor,rewardMultiplier:C.rewardMultiplier,note:C.note})))??s.liveops.tuningHistory??[]},teamComms:{pings:((j=(se=e.team_comms)==null?void 0:se.pings)==null?void 0:j.map(C=>({id:C.id,fromPlayerId:C.from_player_id,intent:C.intent==="focus"||C.intent==="assist"||C.intent==="defend"||C.intent==="rotate"?C.intent:"focus",targetObjectiveId:C.target_objective_id??null,createdAt:Date.parse(C.created_at)||Date.now()})))??s.teamComms.pings??[]},safety:{mutedPlayerIds:((I=e.safety)==null?void 0:I.muted_player_ids)??s.safety.mutedPlayerIds??[],blockedPlayerIds:((O=e.safety)==null?void 0:O.blocked_player_ids)??s.safety.blockedPlayerIds??[],reports:((N=(J=e.safety)==null?void 0:J.reports)==null?void 0:N.map(C=>({id:C.id,targetPlayerId:C.target_player_id,reason:C.reason,createdAt:Date.parse(C.created_at)||Date.now()})))??s.safety.reports??[]},outcome:e.status==="completed"?{status:e.telemetry.successes>=e.telemetry.failures?"win":"loss",reason:e.telemetry.successes>=e.telemetry.failures?"Session completed with positive outcomes.":"Session completed with unresolved failures.",updatedAt:Date.now()}:e.telemetry.failures>0?{status:"partial",reason:`${e.telemetry.failures} failure signals observed; run still active.`,updatedAt:Date.now()}:s.outcome??{status:"in_progress",reason:"Run in progress.",updatedAt:Date.now()},sandbox:{enabled:((K=e.sandbox)==null?void 0:K.enabled)??((D=s.sandbox)==null?void 0:D.enabled)??!1},progression:{xp:(r==null?void 0:r.xp)??((F=s.progression)==null?void 0:F.xp)??0,level:(r==null?void 0:r.level)??((P=s.progression)==null?void 0:P.level)??1,nextLevelXp:((r==null?void 0:r.level)??((he=s.progression)==null?void 0:he.level)??1)*200,milestones:(r==null?void 0:r.milestones)??((Ce=s.progression)==null?void 0:Ce.milestones)??[]}}}function yc(){const e=window.sessionStorage.getItem("agentDirector.sessionId");if(e)return e;const a=`session-${Math.random().toString(36).slice(2,10)}`;return window.sessionStorage.setItem("agentDirector.sessionId",a),a}function qs(){try{const e=window.localStorage.getItem(hn);if(!e)return{};const a=JSON.parse(e),s={};return Object.entries(a).forEach(([r,o])=>{typeof o=="number"&&(s[r]=o)}),s}catch{return{}}}function Gs(e,a=Date.now()){return Object.fromEntries(Object.entries(e).filter(([,s])=>a-s<nc))}function bc(){var rs,os;const{trace:e,insights:a,loading:s,error:r,reload:o,traces:c,selectedTraceId:d,setSelectedTraceId:p}=Sl(),[u,f]=Y("agentDirector.mode","cinema"),[b,y]=Y("agentDirector.workspaceSection.v1","journey"),[x,w]=l.useState(""),v=l.useDeferredValue(x),[h,k]=l.useState("all"),[S,$]=l.useState(""),[X,E]=l.useState(null),[R,z]=l.useState(null),[L,q]=l.useState(null),[V,se]=l.useState([]),[j,I]=l.useState(""),[O,J]=l.useState(null),[N,K]=l.useState(!1),[D,F]=l.useState(null),[P,he]=Y("agentDirector.safeExport",!1),[Ce,C]=Y("agentDirector.syncPlayback",!0),[B,fe]=l.useState(null),[ye,A]=l.useState(!1),[Q,we]=l.useState(0),[it,Ae]=Y("agentDirector.speed",1),[Fe,Re]=Y("agentDirector.windowed",!1),[T,ee]=l.useState(2e4),[be,je]=l.useState(!1),[jt,Oe]=l.useState(!1),[kt,Me]=Y("agentDirector.overlayEnabled",!1),[sr,rr]=Y("agentDirector.onboarded",!1),[,lt]=Y("agentDirector.tourCompleted",!1),[$e,ke]=Y("agentDirector.explainMode",!0),[fa,ya]=Y("agentDirector.heroDismissed",!1),[or,ba]=Y("agentDirector.dockOpen",!1),[ge,ir]=Y("agentDirector.introPersona","builder"),[ga,xa]=Y("agentDirector.launchPath","rapid_triage"),[zt,lr]=Y("agentDirector.themeMode","studio"),[va,cr]=Y("agentDirector.motionMode","balanced"),[wa,dr]=Y("agentDirector.workspaceId.v1",Ls[0].id),[Ut,ur]=Y("agentDirector.workspaceRole.v1","operator"),[xn,vn]=Y("agentDirector.sessionExpiresAt.v1",Date.now()+1e3*60*60*4),[pe,wn]=Y("agentDirector.timelineLaneStrategy","type"),[jn,ct]=Y("agentDirector.timelineStudioConfig",Ft),[Ht,xe]=Y("agentDirector.missions",{playback:!1,flow:!1,inspect:!1,matrix:!1,replay:!1,annotate:!1,collaborate:!1}),Wt=!1,[dt,Jt]=Y("agentDirector.introDismissed",Wt),[ja,ut]=l.useState(!1),[Je,ka]=l.useState("source"),[Ve,Sa]=Y("agentDirector.setupWizardDraft.v1",{dataSource:"",importPath:"",inviteEmails:""}),[kn,Sn]=Y("agentDirector.setupWizardComplete.v1",!1),[Nn,Cn]=Y("agentDirector.setupWizardPrompted.v1",!1),[Na,me]=l.useState(!1),[te,Vt]=l.useState(null),[Kt,Ca]=l.useState([]),[Ma,Ea]=l.useState(null),[pr,Mn]=l.useState(null),[Ia,Ta]=l.useState(""),[Da,et]=l.useState([{id:ua(),name:"Prompt tighter",strategy:"hybrid",modificationsText:'{"prompt":"Return concise response"}'},{id:ua(),name:"Recorded baseline",strategy:"recorded",modificationsText:"{}"}]),[Ke,Aa]=l.useState(null),[Se,En]=l.useState(null),[mr,Qt]=l.useState(!1),[Yt,St]=l.useState(null),[ne,Nt]=Y("agentDirector.gameplayState.v1",_s("bootstrap")),[de,In]=Y("agentDirector.gameplayTraceId.v1",""),[Ie]=Y("agentDirector.gameplayPlayerId.v1",`player-${Math.random().toString(36).slice(2,8)}`),[Ne,pt]=Y("agentDirector.gameplaySessionId.v1",""),[ce,Pe]=l.useState(null),[Xt,Z]=l.useState(null),[hr,mt]=l.useState(null),[fr,Zt]=l.useState(null),[yr,br]=Y("agentDirector.gameplayLocale.v1","en"),[$a,gr]=Y("agentDirector.gamepad.enabled.v1",!0),[_a,xr]=Y("agentDirector.gamepad.preset.v1","standard"),[vr,Tn]=l.useState(typeof navigator>"u"?!0:navigator.onLine),[wr,Dn]=l.useState(null),[jr,An]=l.useState(null),[Ra,$n]=l.useState(1),[ea,Oa]=l.useState(null),[ht,Pa]=l.useState(null),[Ct,La]=l.useState([]),[ta,kr]=l.useState([]),[_n,Fa]=l.useState([]),[_e,aa]=Y("agentDirector.savedViews.v1",[]),[tt,Rn]=l.useState(""),[qe,na]=l.useState(""),[qa,Mt]=l.useState(!1),[Et,Sr]=l.useState(""),[It,Nr]=Y("agentDirector.runOwner.v1","on-call-operator"),[Tt,Cr]=Y("agentDirector.handoffOwner.v1",""),[ue,On]=l.useState(mn),[sa,Ga]=l.useState(null),[Dt,Ba]=l.useState(null),[Pn,za]=l.useState({}),[Ln,Ua]=l.useState([]),[Ha,Wa]=l.useState([]),[At,Ja]=l.useState(800),[Mr,Er]=l.useState(0),Va=l.useRef(null),Fn=l.useRef(null),ft=l.useRef(yc()),qn=l.useRef(0),Gn=l.useRef(0),Ka=l.useRef(!1),Bn=l.useRef({}),ra=l.useRef({}),zn=l.useRef({}),Un=l.useRef({}),Hn=l.useRef({}),Qa=l.useRef({}),Wn=l.useRef({}),Ir=l.useRef(Rs(typeof window>"u"?"":window.location.search)),Ya=l.useRef(!1),Ge=l.useMemo(()=>{if(!e)return[];const n=performance.now(),i=Fs(e.steps,v,h);return Gn.current=performance.now()-n,i},[e,v,h]),Xa=l.useMemo(()=>Ge.slice(0,Math.min(Ge.length,At)),[At,Ge]),Jn=l.useMemo(()=>{if(!X)return Xa;const n=new Set(X.matchedStepIds);return Xa.filter(i=>n.has(i.id))},[Xa,X]),Tr=l.useMemo(()=>B?Fs(B.steps,v,h).slice(0,Math.min(B.steps.length,At)):[],[B,v,h,At]),Vn=l.useMemo(()=>e?Tl(e.startedAt,e.endedAt,e.steps):[],[e]),Dr=l.useMemo(()=>!e||!B?null:Ws(e,B),[e,B]),Kn=l.useMemo(()=>e?e.steps.find(n=>n.id===D)??null:null,[e,D]),$t=l.useMemo(()=>e?Xo(e.steps,pe):[],[e,pe]),yt=l.useMemo(()=>{const n=jn[pe]??Ft[pe];return ds($t,n.order,n.hidden)},[$t,pe,jn]),Ar=l.useMemo(()=>yt.order.filter(n=>!yt.hidden.includes(n)),[yt.hidden,yt.order]),oa=l.useMemo(()=>{const n=ft.current;return Object.values(Pn).filter(i=>i.sessionId!==n).filter(i=>i.traceId===((e==null?void 0:e.id)??"none")).sort((i,m)=>m.updatedAt-i.updatedAt)},[Pn,e==null?void 0:e.id]),$r=l.useMemo(()=>oa.map(n=>n.playheadMs),[oa]),_r=l.useMemo(()=>Ln.filter(n=>n.traceId===(e==null?void 0:e.id)),[Ln,e==null?void 0:e.id]),Qn=l.useMemo(()=>{const n=Object.keys(Ht).length,i=Object.values(Ht).filter(Boolean).length;return{done:i,total:n,pct:n>0?Math.round(i/n*100):0}},[Ht]),_t=l.useMemo(()=>{var _;if(!e)return 100;const n=100,i=Math.min(60,((a==null?void 0:a.errors)??0)*16),m=Math.min(24,((a==null?void 0:a.retries)??0)*6),g=e.metadata.wallTimeMs>6e4?12:e.metadata.wallTimeMs>3e4?6:0,M=(_=a==null?void 0:a.timing)!=null&&_.degraded?8:0;return Math.max(0,Math.min(100,Math.round(n-i-m-g-M)))},[a==null?void 0:a.errors,a==null?void 0:a.retries,(rs=a==null?void 0:a.timing)==null?void 0:rs.degraded,e]),Rr=l.useMemo(()=>u==="flow"?"F / C / Space":u==="compare"?"C / Space / ← →":u==="matrix"?"G / C / Cmd+K":u==="gameplay"?"G / S / Cmd+K":"C / F / Space",[u]),at=l.useMemo(()=>{const n=xn-Date.now(),i=Math.max(0,Math.ceil(n/6e4));return{expired:n<=0,remainingMinutes:i,label:n<=0?"Expired":`${i}m left`}},[xn]),Be=l.useMemo(()=>Ql(Ve),[Ve]),Rt=l.useMemo(()=>tt.trim()?_e.some(i=>i.name.toLowerCase()===tt.trim().toLowerCase())?"Saved view name already exists.":null:"Saved view name is required.",[tt,_e]),ia=l.useMemo(()=>ec({trace:e,selectedStepId:D,mode:u,workspaceId:wa,workspaceRole:Ut,safeExport:P,notifications:Ct.map(n=>({message:n.message,level:n.level})),actions:ta,stepCount:(e==null?void 0:e.steps.length)??0}),[ta,u,Ct,P,D,e,wa,Ut]),ae=l.useCallback((n,i="info")=>{const m=n.trim();if(!m)return;const g=Date.now();La(M=>M.some(H=>H.message===m&&H.level===i)?M:[...M,{id:`notif-${g}-${Math.random().toString(36).slice(2,8)}`,message:m,level:i,expiresAt:g+rc}].slice(-6))},[]),U=l.useCallback((n,i={})=>{try{Zl(window.localStorage,{name:n,at:new Date().toISOString(),metadata:i})}catch{}},[]),bt=l.useCallback(n=>{kr(i=>Yl(i,n))},[]),Ot=l.useCallback(async n=>{Hn.current[n.id]=()=>{Ot(n)},Fa(i=>{const m=i.find(M=>M.id===n.id),g={id:n.id,label:n.label,status:"running",detail:"Running",updatedAt:Date.now(),retryable:!1};return m?[g,...i.filter(M=>M.id!==n.id)].slice(0,8):[g,...i].slice(0,8)}),U("ux.export.queued",{taskId:n.id,label:n.label});try{n.run(),Fa(i=>i.map(m=>m.id===n.id?{...m,status:"success",detail:"Completed",updatedAt:Date.now(),retryable:!1}:m)),U("ux.export.completed",{taskId:n.id,label:n.label})}catch(i){const m=i instanceof Error?i.message:"Export failed";Fa(g=>g.map(M=>M.id===n.id?{...M,status:"error",detail:m,updatedAt:Date.now(),retryable:!0}:M)),ae(`Export failed: ${n.label}`,"error"),U("ux.export.failed",{taskId:n.id,label:n.label,detail:m})}},[ae,U]),Qe=l.useCallback((n,i,m)=>{const g=`confirm-${Math.random().toString(36).slice(2,9)}`;Qa.current[g]=m,Ga({id:g,title:n,message:i})},[]),Yn=l.useCallback((n,i)=>{const m=`undo-${Math.random().toString(36).slice(2,9)}`;Wn.current[m]=i,Ba({id:m,label:n})},[]),Xn=Ut!=="viewer"&&!at.expired,ie=l.useCallback(n=>Xn?!0:(at.expired?ae(`Session expired. Renew session to ${n}.`,"warning"):ae(`Viewer role cannot ${n}. Switch role to operator or admin.`,"warning"),!1),[ae,Xn,at.expired]),Or=l.useCallback(n=>{La(i=>i.filter(m=>m.id!==n))},[]),Pr=l.useCallback(()=>{vn(Date.now()+1e3*60*60*4),ae("Session renewed for 4 hours.","success")},[ae,vn]);l.useEffect(()=>{On(tc(window.localStorage))},[]),l.useEffect(()=>{ue.setupWizardV1&&window.localStorage.getItem("agentDirector.setupWizardAuto")==="1"&&(!dt||kn||ja||Nn||(ut(!0),Cn(!0),U("ux.setup.opened",{source:"auto"})))},[ue.setupWizardV1,dt,Cn,kn,ja,Nn,U]),l.useEffect(()=>{if(!Dt)return;const n=window.setTimeout(()=>{Ba(null)},6e3);return()=>window.clearTimeout(n)},[Dt]),l.useEffect(()=>{const n=m=>{U("ux.error.window",{message:m.message,filename:m.filename,line:m.lineno})},i=m=>{const g=m.reason instanceof Error?m.reason.message:String(m.reason??"unknown");U("ux.error.window",{kind:"unhandledrejection",reason:g})};return window.addEventListener("error",n),window.addEventListener("unhandledrejection",i),()=>{window.removeEventListener("error",n),window.removeEventListener("unhandledrejection",i)}},[U]),l.useEffect(()=>{if(Ya.current)return;const n=Ir.current;if(!n.mode&&!n.traceId&&!n.stepId){Ya.current=!0;return}if(n.mode&&n.mode!==u&&f(n.mode),n.traceId){if(!c.some(m=>m.id===n.traceId))return;if(d!==n.traceId){p(n.traceId);return}}n.stepId&&(e!=null&&e.steps.some(i=>i.id===n.stepId))&&D!==n.stepId&&F(n.stepId),Ya.current=!0},[u,D,d,f,p,e==null?void 0:e.steps,c]),l.useEffect(()=>{if(typeof window>"u")return;const n=Vl(window.location.href,{mode:u,traceId:d??void 0,stepId:D??void 0});n!==window.location.href&&window.history.replaceState(null,"",n)},[u,D,d]),l.useEffect(()=>{if(!Ct.length)return;const n=window.setInterval(()=>{const i=Date.now();La(m=>m.filter(g=>g.expiresAt>i))},1e3);return()=>{window.clearInterval(n)}},[Ct.length]),l.useEffect(()=>{ea&&ae(ea,"success")},[ae,ea]),l.useEffect(()=>{jt&&U("ux.palette.opened",{section:b,mode:u})},[b,u,jt,U]),l.useEffect(()=>{ht&&ae(ht,"success")},[ae,ht]),l.useEffect(()=>{Yt&&ae(Yt,"error")},[ae,Yt]),l.useEffect(()=>{R&&ae(R,"warning")},[ae,R]),l.useEffect(()=>{Xt&&ae(Xt,"warning")},[ae,Xt]),l.useEffect(()=>{at.expired&&ae("Workspace session expired. Renew to continue write actions.","warning")},[ae,at.expired]),l.useEffect(()=>{e&&e.id!==de&&(Nt(_s(e.id)),In(e.id))},[de,Nt,In,e]),l.useEffect(()=>{let n=!1;if(!Ne){Pe(null);return}return ln().then(i=>{n||(Pe(i),i||Z("Gameplay session not found."))}),()=>{n=!0}},[Ne]),l.useEffect(()=>{if(!Ne)return;const n=kl();return()=>n()},[Ne]),l.useEffect(()=>{ce&&Nt(n=>fc(ce,Ie,n))},[Ie,ce,Nt]),l.useEffect(()=>{let n=!1;if(!(ce==null?void 0:ce.guild.guild_id)){mt(null);return}return xl().then(m=>{n||mt(m)}),()=>{n=!0}},[ce==null?void 0:ce.guild.guild_id]),l.useEffect(()=>{let n=!1;return Cs().then(i=>{n||i&&Zt(i)}),()=>{n=!0}},[Ie,ce==null?void 0:ce.id]),l.useEffect(()=>{if(typeof window>"u")return;const n=()=>Tn(!0),i=()=>Tn(!1);return window.addEventListener("online",n),window.addEventListener("offline",i),()=>{window.removeEventListener("online",n),window.removeEventListener("offline",i)}},[]),l.useEffect(()=>{if(!$a){ra.current={};return}if(typeof navigator>"u"||typeof navigator.getGamepads!="function")return;const n=_a==="lefty"?{playPause:1,palette:3,modeCycle:2,speedDown:6,speedUp:7}:{playPause:0,palette:2,modeCycle:3,speedDown:4,speedUp:5},i=["cinema","flow","compare","matrix","gameplay"];let m=0;const g=(_,H,W)=>{const re=!!ra.current[H];_&&!re&&W(),ra.current[H]=_},M=()=>{var H,W,re,De,is;const _=navigator.getGamepads()[0];_&&(g(!!((H=_.buttons[n.playPause])!=null&&H.pressed),"playPause",()=>A(rt=>!rt)),g(!!((W=_.buttons[n.palette])!=null&&W.pressed),"palette",()=>Oe(!0)),g(!!((re=_.buttons[n.modeCycle])!=null&&re.pressed),"modeCycle",()=>{f(rt=>{const Do=i.indexOf(rt);return i[(Do+1)%i.length]})}),g(!!((De=_.buttons[n.speedDown])!=null&&De.pressed),"speedDown",()=>{Ae(rt=>Math.max(.25,Number((rt-.25).toFixed(2))))}),g(!!((is=_.buttons[n.speedUp])!=null&&is.pressed),"speedUp",()=>{Ae(rt=>Math.min(3,Number((rt+.25).toFixed(2))))})),m=window.requestAnimationFrame(M)};return m=window.requestAnimationFrame(M),()=>{window.cancelAnimationFrame(m),ra.current={}}},[$a,_a,f,Ae]),l.useEffect(()=>{let n=!1;const i=async()=>{const[g,M]=await Promise.all([Ms(),Es()]);n||(g&&Dn(g),M&&An(M))};i();const m=window.setInterval(()=>{i()},3e4);return()=>{n=!0,window.clearInterval(m)}},[]),l.useEffect(()=>{E(null),z(null)},[e==null?void 0:e.id]),l.useEffect(()=>{const n=Math.round(Gn.current);Er(n),n>0&&U("ux.perf.filter_ms",{ms:n,steps:Ge.length})},[Ge,U]),l.useEffect(()=>{if(!e)return;const n=Ge.length;if(n<=1200){Ja(n);return}Ja(800);const i=window.setInterval(()=>{Ja(m=>m>=n?(window.clearInterval(i),n):Math.min(n,m+1e3))},70);return()=>window.clearInterval(i)},[Ge.length,e]),l.useEffect(()=>{let n=!1;if(!(e!=null&&e.id)){q(null);return}return sl(e.id).then(i=>{n||q(i)}),()=>{n=!0}},[e==null?void 0:e.id]),l.useEffect(()=>{let n=!1;return rl().then(i=>{n||(se(i),!j&&i.length>0&&I(i[0].id))}),()=>{n=!0}},[j]),l.useEffect(()=>{Fn.current=B},[B]),l.useEffect(()=>(document.body.dataset.theme=zt,()=>{delete document.body.dataset.theme}),[zt]),l.useEffect(()=>(document.body.dataset.motion=va,()=>{delete document.body.dataset.motion}),[va]),l.useEffect(()=>{const n=ft.current,i=(W=!1)=>{const re=Date.now(),De=Gs(qs(),re);W?delete De[n]:De[n]=re,window.localStorage.setItem(hn,JSON.stringify(De)),$n(Math.max(1,Object.keys(De).length))},m=()=>{const W=Gs(qs(),Date.now());$n(Math.max(1,Object.keys(W).length))};i();const g=window.setInterval(()=>i(),sc),M=W=>{W.key===hn&&m()},_=()=>{document.visibilityState==="visible"&&i()},H=()=>i(!0);return window.addEventListener("storage",M),document.addEventListener("visibilitychange",_),window.addEventListener("beforeunload",H),()=>{window.clearInterval(g),i(!0),window.removeEventListener("storage",M),document.removeEventListener("visibilitychange",_),window.removeEventListener("beforeunload",H)}},[]),l.useEffect(()=>{u==="compare"&&ba(!1)},[u,ba]),l.useEffect(()=>{$t.length!==0&&ct(n=>{const i=n[pe]??Ft[pe],m=ds($t,i.order,i.hidden);return m.order.join("|")===i.order.join("|")&&m.hidden.join("|")===i.hidden.join("|")?n:{...n,[pe]:m}})},[$t,pe,ct]),l.useEffect(()=>{za(Ze(window.localStorage.getItem(vt),{})),Ua(Ze(window.localStorage.getItem(dn),[])),Wa(Ze(window.localStorage.getItem(un),[]))},[]),l.useEffect(()=>{const n=Date.now();if(n-qn.current<120&&ye)return;qn.current=n;const i=ft.current,m={sessionId:i,traceId:(e==null?void 0:e.id)??"none",mode:u,playheadMs:Math.round(Q),selectedStepId:D,updatedAt:n},M={...Ze(window.localStorage.getItem(vt),{}),[i]:m};window.localStorage.setItem(vt,JSON.stringify(M)),za(M)},[ye,u,Q,D,e==null?void 0:e.id]),l.useEffect(()=>{const n=ft.current;return()=>{const i=Ze(window.localStorage.getItem(vt),{});if(!i[n])return;const m={...i};delete m[n],window.localStorage.setItem(vt,JSON.stringify(m))}},[]),l.useEffect(()=>{const n=i=>{if(i.key===vt&&za(Ze(i.newValue,{})),i.key===dn){const m=Ze(i.newValue,[]);Ua(g=>Ds(g,m))}i.key===un&&Wa(As(Ze(i.newValue,[])))};return window.addEventListener("storage",n),()=>window.removeEventListener("storage",n)},[]);const G=l.useCallback(n=>{const i={id:`activity-${Math.random().toString(36).slice(2,9)}`,sessionId:ft.current,message:n,timestamp:Date.now()};Wa(m=>{const g=As([i,...m]);return window.localStorage.setItem(un,JSON.stringify(g)),g})},[]),ve=l.useCallback((n,i,m)=>{Bn.current[n]||(Bn.current[n]=!0,El(i,m))},[]),Ye=l.useCallback(async function(i){i.retry&&(zn.current[i.id]=i.retry),i.resume&&(Un.current[i.id]=i.resume),bt({id:i.id,label:i.label,status:"running",detail:"Running",retryable:!1,resumable:!1});try{const m=await i.run();return bt({id:i.id,label:i.label,status:"success",detail:i.successDetail??"Completed",retryable:!1,resumable:!1}),m}catch(m){const g=m instanceof Error?m.message:"Action failed";throw bt({id:i.id,label:i.label,status:"error",detail:g,retryable:!!i.retry,resumable:!!i.resume}),m}},[bt]),Lr=l.useCallback(n=>{const i=zn.current[n];i&&(U("ux.action.retry",{id:n}),i())},[U]),Fr=l.useCallback(n=>{const i=Un.current[n];i&&(U("ux.action.resume",{id:n}),i())},[U]),ze=l.useCallback(async n=>{if(!e||!ie("run replay"))return;const i=await il(e.id,n,"hybrid",{note:"UI replay"},e);i&&(fe(i),Me(!0),f("flow"),xe(m=>m.replay?m:{...m,replay:!0}),G(`Created replay from ${n}`))},[G,ie,xe,e,fe,f,Me]),qr=l.useCallback(async()=>{if(e){if(!S.trim()){E(null),z(null);return}try{const n=await Ye({id:"trace-query",label:"TraceQL query",run:async()=>nl(e.id,S.trim()),successDetail:"Query complete"});if(!n){z("TraceQL query failed"),E(null);return}E(n),z(null);const i=n.matchedStepIds[0];i&&(F(i),u!=="cinema"&&f("cinema"))}catch{z("TraceQL query failed"),E(null)}}},[Ye,u,f,e,S]),Gr=l.useCallback(async()=>{if(!(!e||!j)){K(!0);try{const n=await Ye({id:"run-extension",label:"Run extension",run:async()=>ol(j,e.id),successDetail:"Extension output ready"});if(!n)return;J(n.result)}finally{K(!1)}}},[Ye,j,e]),Te=l.useCallback(()=>{if(!e)return;const n=[...e.steps].sort((i,m)=>(m.durationMs??0)-(i.durationMs??0))[0];n&&(F(n.id),f("cinema"))},[e,f]),Zn=l.useCallback(()=>{if(!e||e.steps.length===0)return null;const n=[...e.steps].sort((i,m)=>(m.durationMs??0)-(i.durationMs??0))[0];return(n==null?void 0:n.id)??null},[e]),nt=l.useCallback(()=>{if(!e)return;const n=e.steps.find(i=>i.status==="failed");n&&(F(n.id),f("cinema"))},[e,f]),la=l.useCallback(async()=>{if(!e)return;const n=new URL(window.location.href);n.searchParams.set("trace",d??e.id),n.searchParams.set("mode",u),D?n.searchParams.set("step",D):n.searchParams.delete("step");try{await navigator.clipboard.writeText(n.toString()),Oa("Live link copied")}catch{window.prompt("Copy live session link",n.toString()),Oa("Live link ready")}window.setTimeout(()=>Oa(null),1800)},[u,D,d,e]),Br=l.useCallback(n=>{wn(n),G(`Switched lane strategy to ${n}`)},[G,wn]),zr=l.useCallback(n=>{ct(i=>{const m=i[pe]??Ft[pe],g=m.hidden.includes(n)?m.hidden.filter(M=>M!==n):[...m.hidden,n];return{...i,[pe]:{...m,hidden:g}}}),G(`Toggled lane visibility for ${n}`)},[G,pe,ct]),Ur=l.useCallback(async n=>{if(!e||!ie("create gameplay sessions"))return;const i=await pl({traceId:e.id,name:n.trim()||"Night Ops"});if(!i){Z("Failed to create gameplay session.");return}Pe(i),pt(i.id),Z(null),G(`Created gameplay session ${i.id}`)},[G,Ie,ie,pt,e]),Hr=l.useCallback(async(n,i,m)=>{if(!ie("join gameplay sessions"))return;if(!n.trim()){Z("Session id is required.");return}const g=await ml({sessionId:n.trim(),playerId:i.trim()});if(!g){Z("Failed to join gameplay session.");return}Pe(g),pt(g.id),Z(null),G(`Joined gameplay session ${g.id} as ${i}`)},[G,ie,pt]),Wr=l.useCallback(async()=>{Ne&&ie("leave gameplay sessions")&&Qe("Leave gameplay session",`Leave session ${Ne}?`,()=>{(async()=>{if(!await hl()){Z("Failed to leave gameplay session.");return}Pe(null),pt(""),Z(null),G(`Left gameplay session ${Ne}`),U("ux.action.confirmed",{action:"leave_gameplay_session",sessionId:Ne})})()})},[G,Ie,Ne,Qe,ie,pt,U]),Jr=l.useCallback(async()=>{if(!Ne)return;const n=await fl();if(!n){Z("Failed to reconnect gameplay session.");return}Pe(n),Z(null),G(`Reconnected gameplay session ${Ne}`)},[G,Ie,Ne]),Vr=l.useCallback(async(n,i)=>{if(!(ce!=null&&ce.id)||!ie(`run gameplay action ${n}`))return;const m=await Ns({sessionId:ce.id,expectedVersion:ce.version});if(m.session){Pe(m.session),Z(null),G(`Gameplay action: ${n}`);return}if(m.conflict){const g=await ln(ce.id);g&&Pe(g),Z("Session changed by another player. Synced latest state.");return}Z(m.error??"Gameplay action failed.")},[G,Ie,ce,ie]),Kr=l.useCallback(async(n,i)=>{if(!ie("create guilds"))return;if(!n.trim()||!i.trim()){Z("Guild id and name are required.");return}const m=await gl({guildId:n.trim(),name:i.trim()});if(!m){Z("Failed to create guild.");return}if(mt(m),ce){const g=await Ns({sessionId:ce.id,payload:{guild_id:m.id},expectedVersion:ce.version});g.session&&Pe(g.session)}Z(null),G(`Created guild ${m.id}`)},[G,Ie,ce,ie]),Qr=l.useCallback(async(n,i)=>{if(!ie("join guilds"))return;if(!n.trim()||!i.trim()){Z("Guild id and player id are required.");return}const m=await vl(n.trim(),i.trim());if(!m){Z("Failed to join guild.");return}mt(m),Z(null),G(`Joined guild ${m.id} as ${i}`)},[G,ie]),Yr=l.useCallback(async(n,i,m)=>{if(!ie("schedule guild events"))return;if(!n.trim()||!i.trim()||!m.trim()){Z("Guild id, title, and schedule are required.");return}const g=await wl({guildId:n.trim(),title:i.trim(),scheduledAt:m.trim()});if(!g){Z("Failed to schedule guild event.");return}mt(g.guild),Z(null),G(`Scheduled guild event ${g.event.id}`)},[G,ie]),Xr=l.useCallback(async(n,i,m)=>{if(!ie("complete guild events"))return;const g=await jl();if(!g){Z("Failed to complete guild event.");return}mt(g),Z(null),G(`Completed guild event ${i}`)},[G,ie]),Zr=l.useCallback(async n=>{if(!ie("send friend invites"))return;const i=await yl({toPlayerId:n.trim().toLowerCase()});if(!i){Z("Failed to send friend invite.");return}Zt(i.social),Z(null),G(`Sent friend invite to ${n}`)},[G,Ie,ie]),eo=l.useCallback(async n=>{if(!ie("accept friend invites"))return;const i=await bl();if(!i){Z("Failed to accept friend invite.");return}Zt(i),Z(null),G(`Accepted friend invite ${n}`)},[G,Ie,ie]),es=l.useCallback(()=>{Ye({id:"retry-connectivity",label:"Retry connectivity",retry:()=>es(),run:async()=>{if(Z(null),o(),Ne){const g=await ln();g&&Pe(g)}const[n,i,m]=await Promise.all([Cs(),Ms(),Es()]);return n&&Zt(n),i&&Dn(i),m&&An(m),G("Retried connectivity sync"),!0},successDetail:"Connectivity synced"}).catch(()=>{Z("Retry connectivity failed.")})},[G,Ye,Ie,Ne,o]),to=l.useCallback((n,i)=>{ct(m=>{const g=m[pe]??Ft[pe],M=[...g.order],_=M.indexOf(n);if(_===-1)return m;const H=i==="up"?_-1:_+1;if(H<0||H>=M.length)return m;const[W]=M.splice(_,1);return M.splice(H,0,W),{...m,[pe]:{...g,order:M}}}),G(`Moved lane group ${n} ${i}`)},[G,pe,ct]),ao=l.useCallback(()=>{xe({playback:!1,flow:!1,inspect:!1,matrix:!1,replay:!1,annotate:!1,collaborate:!1}),G("Reset onboarding missions")},[G,xe]),no=l.useCallback((n,i)=>{if(!e||!n.trim())return;const m=Date.now(),g={id:`annotation-${Math.random().toString(36).slice(2,9)}`,traceId:e.id,stepId:i,body:n.trim(),authorSessionId:ft.current,createdAt:m,updatedAt:m};Ua(M=>{const _=Ds(M,[g]);return window.localStorage.setItem(dn,JSON.stringify(_)),_}),xe(M=>M.annotate?M:{...M,annotate:!0}),G(i?`Added annotation on step ${i}`:"Added trace annotation")},[G,xe,e]),so=l.useCallback((n,i)=>{et(m=>m.map(g=>g.id===n?{...g,...i}:g))},[]),ro=l.useCallback(n=>{et(n)},[]),oo=l.useCallback(()=>{et(n=>[...n,{id:ua(),name:`Scenario ${n.length+1}`,strategy:"hybrid",modificationsText:"{}"}])},[]),io=l.useCallback(n=>{Da.length<=1||Qe("Remove scenario","Remove this scenario from the matrix run?",()=>{let i=null,m=-1;et(g=>(m=g.findIndex(M=>M.id===n),m===-1||g.length<=1?g:(i=g[m]??null,g.filter(M=>M.id!==n)))),!(!i||m===-1)&&(Yn("Scenario removed",()=>{et(g=>{const M=[...g];return M.splice(Math.min(m,M.length),0,i),M}),U("ux.action.undone",{action:"matrix_scenario_remove",scenarioId:n})}),U("ux.action.confirmed",{action:"matrix_scenario_remove",scenarioId:n}))})},[Da.length,Yn,Qe,U]),lo=l.useCallback(n=>{et(i=>{const m=i.findIndex(H=>H.id===n);if(m===-1)return i;const g=i[m],M={...g,id:ua(),name:`${g.name} copy`},_=[...i];return _.splice(m+1,0,M),_})},[]),co=l.useCallback((n,i)=>{et(m=>{const g=m.findIndex(W=>W.id===n);if(g===-1)return m;const M=i==="up"?g-1:g+1;if(M<0||M>=m.length)return m;const _=[...m],[H]=_.splice(g,1);return _.splice(M,0,H),_})},[]),Za=l.useCallback(async n=>{var m;if(!e||!ie("run replay matrix"))return;const i=Ia||D||((m=e.steps[0])==null?void 0:m.id);if(!i){St("Select an anchor step before running the matrix.");return}try{Qt(!0),St(null),await Ye({id:"matrix-run",label:"Replay matrix run",retry:()=>{Za(n)},resume:()=>{Za(n)},run:async()=>{const g=await ll({traceId:e.id,stepId:i,scenarios:n});if(!g)throw new Error("Failed to create replay job.");Aa(g);let M=g;for(let H=0;H<30&&!(M.status!=="queued"&&M.status!=="running");H+=1){const W=Rl(H);await new Promise(De=>window.setTimeout(De,W));const re=await cl(g.id);if(!re)break;M=re,Aa(re)}const _=await Ss(g.id);if(!_)throw new Error("Replay job finished but matrix summary is unavailable.");return En(_),f("matrix"),G(`Ran matrix with ${n.length} scenario(s) from ${i}`),_},successDetail:`${n.length} scenario(s) complete`})}catch(g){St(g instanceof Error?g.message:"Failed to run replay matrix.")}finally{Qt(!1)}},[G,Ye,Ia,ie,D,e,f]),uo=l.useCallback(async()=>{Ke&&ie("cancel replay matrix jobs")&&Qe("Cancel matrix job",`Cancel replay job ${Ke.id}?`,()=>{(async()=>{Qt(!0);try{const n=await dl(Ke.id);if(!n){St("Failed to cancel replay job.");return}Aa(n),bt({id:"matrix-run",label:"Replay matrix run",status:"canceled",detail:`Canceled ${Ke.id}`,resumable:!0,retryable:!0});const i=await Ss(n.id);i&&En(i),G(`Canceled matrix job ${Ke.id}`),U("ux.action.cancel",{id:Ke.id})}finally{Qt(!1)}})()})},[G,Ke,Qe,ie,bt,U]),po=l.useCallback(async n=>{const i=await Js();if(!(i!=null&&i.trace)){St("Could not load replay trace for compare view.");return}fe(i.trace),Me(!0),f("compare"),G(`Opened matrix compare trace ${n}`)},[G,f,Me]),le=l.useCallback(n=>{if(!(n===u||!e)){if((n==="flow"||n==="matrix"||n==="gameplay")&&A(!1),n==="flow"&&u==="cinema"&&Va.current){const i=Va.current,m=mc(i),g=hc(e.steps,i,e.id);Mn({steps:e.steps,fromRects:m,toRects:g}),G("Morphed cinema to flow");return}f(n),G(`Switched mode to ${n}`)}},[G,u,e,A,f]),Pt=l.useCallback(async n=>{if(xa(n),n==="rapid_triage"){ke(!0),le("cinema"),nt(),e!=null&&e.steps.some(i=>i.status==="failed")||Te(),G("Started rapid triage launch path");return}if(n==="deep_diagnosis"){ke(!0),le("flow"),me(!0),G("Started deep diagnosis launch path");return}C(!0),le("matrix"),await la(),G("Started team sync launch path")},[G,le,Te,nt,ke,xa,C,la,e]),en=l.useCallback(()=>{u==="flow"&&le("cinema"),A(n=>!n)},[u,le]),Xe=l.useCallback(()=>{Vt(null),Ca([]),Ea(null),A(!1)},[A]),ts=l.useCallback(n=>[{id:"setup",label:"Opening the reel",duration:1100,action:()=>{ke(!0),A(!1),we(0),F(null),Me(!1),Ae(1),e&&e.steps.length<500&&Re(!1),le("cinema")}},{id:"pace",label:"Pacing the timeline",duration:2200,action:()=>{le("cinema"),A(!0),Ae(1.1)}},{id:"bottleneck",label:"Freeze on the bottleneck",duration:1600,action:()=>{A(!1),Te()}},{id:"inspect",label:"Inspect the moment",duration:1600,action:()=>{n&&F(n)}},{id:"flow",label:"Morph into flow",duration:2100,action:()=>{le("flow")}},{id:"replay",label:"Director’s Cut replay",duration:2200,action:async()=>{if(!e)return;!Fn.current&&n&&await ze(n),Me(!0),f("compare")}},{id:"compare",label:"Compare the cut",duration:2e3,action:()=>{A(!0),Ae(1)}},{id:"finale",label:"Final frame",duration:1100,action:()=>{A(!1)}}],[le,ze,Te,ke,A,f,Me,we,F,Ae,Re,e]),gt=l.useCallback(()=>{var i;if(!e)return;const n=D??Zn()??((i=e.steps[0])==null?void 0:i.id)??null;Ca(ts(n)),Vt({active:!0,step:0}),Ea(e.id),me(!1),je(!1),Oe(!1)},[ts,Zn,D,e,Oe,je,Ca,Vt,Ea,me]),xt=l.useCallback(()=>{if(te!=null&&te.active){Xe();return}gt()},[gt,Xe,te==null?void 0:te.active]),mo=l.useMemo(()=>{const i=[{id:"header",title:"Mission control",body:`Confirm run status and metadata. ${{builder:"Focus on payload flow, tool-call sequencing, and replay-ready steps.",executive:"Focus on bottlenecks, risk signals, and run-level outcome changes.",operator:"Focus on failure patterns, retries, and runtime reliability posture."}[ge]}`,target:'[data-tour="header"]',placement:"bottom"}];return fa||i.push({id:"hero",title:"Director briefing",body:"Choose Tour, Story mode, or Explain to ramp up quickly.",target:'[data-tour="hero"]',placement:"bottom"}),i.push({id:"insights",title:"Fast diagnosis",body:ge==="executive"?"Jump straight to bottlenecks and high-cost segments for fast executive readouts.":ge==="operator"?"Jump to failures and retries first, then inspect impacted steps.":"Jump straight to bottlenecks, errors, and high-cost steps with one click.",target:'[data-tour="insights"]',placement:"bottom"},{id:"journey",title:"Director journey",body:"A narrative path that teaches how to watch, inspect, and direct a better run.",target:'[data-tour="journey"]',placement:"bottom"},{id:"toolbar",title:"Filters + modes",body:"Search, filter, and switch between Cinema, Flow, and Compare as the story evolves.",target:'[data-tour="toolbar"]',placement:"bottom"},{id:"quick-actions",title:"Quick actions",body:"Launch Story Mode, open the command palette, or jump to bottlenecks instantly.",target:'[data-tour="quick-actions"]',placement:"left"},{id:"stage",title:"Cinema stage",body:"The timeline shows every step as a scene. Scrub to see pacing and concurrency.",target:'[data-tour="stage"]',placement:"top"},{id:"inspector",title:"Inspector",body:ge==="executive"?"Open key moments to validate outcome impact and communication-ready summaries.":"Open any step to read payloads, apply redaction, and replay from that moment.",target:'[data-tour="inspector"]',placement:"left"},{id:"compare",title:"Compare runs",body:B?"Compare is live. Review deltas in cost, steps, and wall time side by side.":"Replay from a step to unlock compare mode and validate improvements.",target:'[data-tour="compare"]',placement:"top"}),i},[B,fa,ge]),ho=l.useCallback(()=>{Mn(null),f("flow")},[f]),Le=l.useMemo(()=>{var g,M,_,H;if(!e)return[];const n=[],i=[...e.steps].sort((W,re)=>(re.durationMs??0)-(W.durationMs??0))[0],m=e.steps.find(W=>W.status==="failed");if(m&&D!==m.id&&n.push({id:"jump-error",title:"Investigate first failure",body:`${m.name} failed and should be inspected before optimization work.`,actionLabel:"Open failed step",tone:"warning",action:nt}),i&&D!==i.id&&n.push({id:"jump-bottleneck",title:"Tackle latency bottleneck",body:`${i.name} is the slowest scene in this run and the best optimization target.`,actionLabel:"Open bottleneck",tone:"priority",action:Te}),(g=L==null?void 0:L.hypotheses)!=null&&g[0]){const W=L.hypotheses[0];n.push({id:"investigate-hypothesis",title:W.title,body:W.summary,actionLabel:"Inspect evidence",tone:"info",action:()=>{const re=W.evidenceStepIds[0];re&&(F(re),u!=="cinema"&&f("cinema"))}})}if(u!=="matrix"&&n.push({id:"matrix-experiment",title:"Run scenario matrix",body:"Compare prompt and strategy alternatives from one anchor step to rank causal impact.",actionLabel:"Open matrix",tone:"info",action:()=>{var W;Ta(D??((W=e.steps[0])==null?void 0:W.id)??""),f("matrix")}}),!B&&(D||(M=e.steps[0])!=null&&M.id)){const W=D??((_=e.steps[0])==null?void 0:_.id)??null;W&&n.push({id:"run-replay",title:"Create director replay",body:"Branch a replay trace and validate whether your change improves the run.",actionLabel:"Replay from step",tone:"info",action:()=>{ze(W)}})}if((H=Se==null?void 0:Se.causalRanking)!=null&&H.length){const W=Se.causalRanking[0];n.push({id:"causal-factor",title:`Top causal factor: ${W.factor}`,body:`Confidence ${(W.confidence*100).toFixed(0)}% across ${W.evidence.samples} sample(s).`,actionLabel:"View matrix",tone:"priority",action:()=>f("matrix")})}return n.slice(0,4)},[B,ze,L,Te,nt,u,Se,D,e,f]),fo=l.useMemo(()=>Le.map((n,i)=>{const m=n.tone==="warning"?"high":n.tone==="priority"?"medium":"low";return{id:`priority-${n.id}`,title:n.title,detail:n.body,severity:m,actionLabel:n.actionLabel,onAction:n.action,done:i===0?n.id==="jump-error"&&!!D||n.id==="jump-bottleneck"&&!!D:!1}}),[Le,D]),st=l.useMemo(()=>{var _,H;if(!e)return"No trace loaded.";const n=[...e.steps].sort((W,re)=>(re.durationMs??0)-(W.durationMs??0))[0],i=e.steps.filter(W=>W.status==="failed").length,m=(_=L==null?void 0:L.hypotheses)==null?void 0:_[0],g=(H=Se==null?void 0:Se.causalRanking)==null?void 0:H[0];return[`Run ${e.id} completed with ${e.steps.length} steps across ${e.metadata.wallTimeMs}ms.`,n?`Primary latency driver: ${n.name} (${n.durationMs??0}ms).`:null,i>0?`Observed ${i} failed step(s), indicating reliability risk.`:"No failed steps observed.",m?`Top investigation hypothesis: ${m.title} (${m.severity}).`:null,g?`Highest ranked causal factor from matrix: ${g.factor} (${(g.confidence*100).toFixed(0)}% confidence).`:null,"Recommended plan: inspect bottleneck evidence, validate with replay matrix, and lock in mitigations."].filter(Boolean).join(" ")},[L,Se==null?void 0:Se.causalRanking,e]),yo=l.useCallback(n=>{var m,g;const i=n.toLowerCase();if(!e)return"No trace is loaded yet.";if(i.includes("bottleneck")||i.includes("slow")){const M=[...e.steps].sort((_,H)=>(H.durationMs??0)-(_.durationMs??0))[0];return M?`The primary bottleneck is ${M.name} at ${M.durationMs??0}ms. Prioritize this step for optimization and replay validation.`:"No bottleneck could be determined from current trace data."}if(i.includes("risk")||i.includes("failure")||i.includes("error")){const M=e.steps.filter(_=>_.status==="failed");return M.length?`Risk is concentrated in ${M.length} failed step(s), starting at ${((m=M[0])==null?void 0:m.name)??"unknown"}.`:"Failure risk appears low for this run; no failed steps were observed."}return i.includes("cost")?`Recorded run cost is ${(e.metadata.totalCostUsd??0).toFixed(4)} USD. Use matrix scenarios to evaluate cheaper prompt/strategy options.`:i.includes("next")||i.includes("action")?Le.length?`Next action: ${((g=Le[0])==null?void 0:g.title)??"Open matrix"}.`:"Next action: open Cinema mode, inspect bottleneck, then run the matrix.":st},[st,Le,e]),as=l.useCallback(()=>{e&&Ot({id:"export-director-narrative",label:"Director narrative markdown",run:()=>{const n=`# Director Narrative

${st}

## Recommended Actions
${Le.map(i=>`- ${i.title}: ${i.body}`).join(`
`)}`;an(`agent-director-narrative-${e.id}.md`,n,"text/markdown")}})},[st,Le,Ot,e]),Lt=l.useCallback(async()=>{if(!e)return;const n=Le[0],i=e.steps.filter(M=>M.status==="failed").length,g=[`Session handoff (${new Date().toISOString()})`,`Trace: ${e.id}`,`Owner: ${It}`,`Handoff owner: ${Tt||"unassigned"}`,`Mode: ${u}`,`Selected step: ${D??"none"}`,`Run health: ${_t}/100`,`Failures: ${i}`,`Wall time: ${e.metadata.wallTimeMs}ms`,`Top recommendation: ${n?`${n.title} -> ${n.actionLabel}`:"None"}`,`Narrative: ${st}`].join(`
`);try{await navigator.clipboard.writeText(g),Pa("Handoff digest copied"),U("ux.support.payload_copied",{kind:"handoff_digest"})}catch{window.prompt("Copy handoff digest",g),Pa("Handoff digest ready")}window.setTimeout(()=>Pa(null),2200)},[st,Le,Tt,u,_t,It,D,e,U]),ca=l.useCallback(n=>{On(i=>{const m={...i,[n]:!i[n]};return ac(window.localStorage,m),U("ux.feature_flag.toggled",{flag:n,enabled:m[n]}),m})},[U]),bo=l.useCallback(()=>{Be.isValid&&(Sn(!0),ut(!1),ka("source"),ae("Workspace setup complete.","success"),U("ux.setup.completed",{dataSource:Ve.dataSource,hasInvites:!!Ve.inviteEmails.trim()}))},[ae,Be.isValid,Ve,U,Sn]),go=l.useCallback(async()=>{const n=JSON.stringify({diagnostics:ia,note:Et,owner:It,handoffOwner:Tt||null},null,2);try{await navigator.clipboard.writeText(n),ae("Support payload copied.","success"),U("ux.support.payload_copied",{bytes:n.length})}catch{window.prompt("Copy support payload",n)}},[ae,Tt,It,ia,Et,U]),xo=l.useCallback(()=>{const n=tt.trim();if(!n||Rt)return;const i={id:`view-${Math.random().toString(36).slice(2,9)}`,name:n,state:{mode:u,query:x,typeFilter:h,selectedStepId:D,safeExport:P,windowed:Fe,syncPlayback:Ce,explainMode:$e,section:b}};aa(m=>[i,...m].slice(0,20)),Rn(""),na(i.id),U("ux.saved_view.created",{viewId:i.id,name:n}),ae(`Saved view: ${n}`,"success")},[b,ae,$e,u,x,P,tt,Rt,D,aa,Ce,U,h,Fe]),tn=l.useCallback(n=>{const i=_e.find(m=>m.id===n);i&&(f(i.state.mode),w(i.state.query),k(i.state.typeFilter),F(i.state.selectedStepId),he(i.state.safeExport),Re(i.state.windowed),C(i.state.syncPlayback),ke(i.state.explainMode),y(i.state.section),na(i.id),U("ux.saved_view.applied",{viewId:i.id,name:i.name}),ae(`Applied view: ${i.name}`,"info"))},[ae,_e,y,ke,f,he,C,Re,U]),vo=l.useCallback(()=>{if(!qe)return;const n=_e.find(i=>i.id===qe);n&&Qe("Delete saved view",`Delete saved view "${n.name}"?`,()=>{aa(i=>i.filter(m=>m.id!==qe)),na(""),U("ux.saved_view.deleted",{viewId:n.id,name:n.name}),ae(`Deleted view: ${n.name}`,"warning")})},[ae,Qe,_e,qe,aa,U]);l.useEffect(()=>{var m;if(!e)return;al(),we(0),A(!1);const n=Math.min(Math.max((e.metadata.wallTimeMs||1)*.2,5e3),6e4);ee(n),e.steps.length>500&&Re(!0),B||Me(!1),u==="compare"&&!B&&f("cinema");const i=D&&e.steps.some(g=>g.id===D)?D:((m=e.steps[0])==null?void 0:m.id)??"";Ta(g=>g&&e.steps.some(M=>M.id===g)?g:i)},[e,B,u,D,f,Re,Me]),l.useEffect(()=>(document.body.classList.toggle("explain-mode",$e),()=>{document.body.classList.remove("explain-mode")}),[$e]),l.useEffect(()=>(document.body.classList.toggle("story-mode",!!(te!=null&&te.active)),()=>{document.body.classList.remove("story-mode")}),[te==null?void 0:te.active]),l.useEffect(()=>{if(!(te!=null&&te.active))return;const n=Kt[te.step];if(!n){Xe();return}Promise.resolve(n.action());const i=window.setTimeout(()=>{Vt(m=>m&&m.active?{...m,step:m.step+1}:m)},n.duration);return()=>window.clearTimeout(i)},[Kt,Xe,te]),l.useEffect(()=>{te!=null&&te.active&&(!e||!Ma||e.id!==Ma&&Xe())},[te==null?void 0:te.active,e,Ma,Xe]),l.useEffect(()=>{dt||Wt||ve(`tutorial_start:${(e==null?void 0:e.id)||de||ne.seed}`,"funnel.tutorial_start",{traceId:(e==null?void 0:e.id)||de||"unknown",persona:ge,launchPath:ga})},[ve,ne.seed,de,dt,ge,ga,Wt,e==null?void 0:e.id]),l.useEffect(()=>{Q>0&&xe(n=>n.playback?n:{...n,playback:!0})},[Q,xe]),l.useEffect(()=>{u==="flow"&&xe(n=>n.flow?n:{...n,flow:!0}),u==="matrix"&&xe(n=>n.matrix?n:{...n,matrix:!0})},[u,xe]),l.useEffect(()=>{D&&xe(n=>n.inspect?n:{...n,inspect:!0})},[D,xe]),l.useEffect(()=>{Ra>1&&xe(n=>n.collaborate?n:{...n,collaborate:!0})},[Ra,xe]),l.useEffect(()=>{ve(`session_start:${de||ne.seed}`,"funnel.session_start",{traceId:de||(e==null?void 0:e.id)||"unknown",seed:ne.seed})},[ve,ne.seed,de,e==null?void 0:e.id]),l.useEffect(()=>{ne.raid.objectives.some(i=>i.progress>0)&&ve(`objective_progress:${de||ne.seed}`,"funnel.first_objective_progress",{traceId:de||(e==null?void 0:e.id)||"unknown"})},[ve,ne.raid.objectives,ne.seed,de,e==null?void 0:e.id]),l.useEffect(()=>{ne.outcome.status!=="in_progress"&&(ve(`first_outcome:${de||ne.seed}`,"funnel.first_mission_outcome",{status:ne.outcome.status,reason:ne.outcome.reason}),(ne.outcome.status==="win"||ne.outcome.status==="loss")&&ve(`run_outcome:${de||ne.seed}`,"funnel.run_outcome",{status:ne.outcome.status,reason:ne.outcome.reason}))},[ve,ne.outcome.reason,ne.outcome.status,ne.seed,de]),l.useEffect(()=>{if(!Ce||ye||Ka.current)return;const n=oa[0];if(!n||n.traceId!==(e==null?void 0:e.id))return;const i=Math.abs(n.playheadMs-Q),m=n.mode!==u,g=(n.selectedStepId??null)!==(D??null);i<600&&!m&&!g||(Ka.current=!0,we(n.playheadMs),(n.mode==="cinema"||n.mode==="flow"||n.mode==="compare"||n.mode==="matrix"||n.mode==="gameplay")&&f(n.mode),F(n.selectedStepId??null),window.setTimeout(()=>{Ka.current=!1},180))},[ye,u,Q,oa,D,f,Ce,e==null?void 0:e.id]),l.useEffect(()=>{if(!e)return;const i=Date.parse(e.startedAt)+Q;let m=0,g=Number.POSITIVE_INFINITY;e.steps.forEach((_,H)=>{const W=Date.parse(_.startedAt),re=Date.parse(_.endedAt??_.startedAt);if(i>=W&&i<=re){m=H,g=0;return}const De=Math.min(Math.abs(i-W),Math.abs(i-re));De<g&&(g=De,m=H)}),[m,m-1,m+1].filter(_=>_>=0&&_<e.steps.length).forEach(_=>{const H=e.steps[_];H&&el(e.id,H.id,P)})},[e,Q,P]),l.useEffect(()=>{if(!e||!ye||u!=="cinema"&&u!=="compare")return;const n=(B==null?void 0:B.metadata.wallTimeMs)??0,i=u==="compare"?Math.max(e.metadata.wallTimeMs||1,n||1):e.metadata.wallTimeMs||1;let m=0,g=performance.now();const M=_=>{const H=(_-g)*it;g=_,we(W=>{const re=W+H;return re>=i?(A(!1),i):re}),m=requestAnimationFrame(M)};return m=requestAnimationFrame(M),()=>cancelAnimationFrame(m)},[e,B,ye,it,u]),l.useEffect(()=>{const n=i=>{var _;const m=i.target,g=(_=m==null?void 0:m.tagName)==null?void 0:_.toLowerCase();if(!(g==="input"||g==="textarea"||g==="select"||m!=null&&m.isContentEditable)){if((i.metaKey||i.ctrlKey)&&i.key.toLowerCase()==="k"){i.preventDefault(),Oe(H=>!H);return}if(i.key==="?"||i.key==="/"&&i.shiftKey){i.preventDefault(),je(!0);return}if(i.key.toLowerCase()==="s"){i.preventDefault(),xt();return}if(i.key.toLowerCase()==="e"){i.preventDefault(),ke(H=>!H);return}if(i.key.toLowerCase()==="t"){i.preventDefault(),me(!0);return}if(i.key==="Escape"){if(Na){me(!1),lt(!0);return}je(!1),Oe(!1),F(null);return}if(i.key===" "){i.preventDefault(),(u==="cinema"||u==="compare")&&A(H=>!H);return}if(i.key.toLowerCase()==="f"){i.preventDefault(),u==="flow"?f("cinema"):u==="cinema"&&le("flow");return}if(i.key.toLowerCase()==="c"){i.preventDefault(),u!=="cinema"&&f("cinema");return}if(i.key.toLowerCase()==="g"){i.preventDefault(),le("gameplay");return}if(i.key.toLowerCase()==="i"){i.preventDefault(),D?F(null):e!=null&&e.steps.length&&F(e.steps[0].id);return}if(i.key==="ArrowLeft"||i.key==="ArrowRight"){if(i.preventDefault(),!e)return;const H=e.metadata.wallTimeMs||1;if(i.shiftKey){we(i.key==="ArrowLeft"?0:H),A(!1),f("cinema");return}const W=i.key==="ArrowRight"?1:-1,re=Dl(Vn,Q,W);re!=null&&(we(re),A(!1),f("cinema"))}}};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[u,D,e,Q,Vn,le,f,ke,Oe,me,lt,Na,xt]);const ns=l.useMemo(()=>{if(!e||!Fe||x)return null;const n=e.metadata.wallTimeMs||1,i=Math.min(Math.max(T,5e3),n);let m=Math.max(0,Q-i/2);const g=Math.min(n,m+i);return g-m<i&&(m=Math.max(0,g-i)),{startMs:m,endMs:g}},[e,Fe,Q,x,T]),Ue=!!(te!=null&&te.active),ss=(te==null?void 0:te.step)??0,wo=((os=Kt[ss])==null?void 0:os.label)??"Wrapping up",jo=Kt.length,ko=x!==v,So=`${Math.min(Ge.length,At)}/${Ge.length}`,No=l.useMemo(()=>ge==="executive"?[{label:"Review run health",done:_t>=80},{label:"Inspect top risk",done:!!D},{label:"Share handoff digest",done:!!ht}]:ge==="operator"?[{label:"Open failed step",done:!!D},{label:"Run replay",done:!!B},{label:"Use support diagnostics",done:qa||!!Et.trim()}]:[{label:"Open flow graph",done:u==="flow"},{label:"Run matrix scenario",done:!!Se},{label:"Save a reusable view",done:_e.length>0}],[B,ht,ge,u,Se,_t,_e.length,D,Et,qa]),Co=l.useMemo(()=>[{id:"macro-rapid-triage",label:"Run rapid triage launch path",description:"Jump to the highest-risk step and start mitigation.",group:"Macros",onTrigger:()=>{Pt("rapid_triage")}},{id:"macro-deep-diagnosis",label:"Run deep diagnosis launch path",description:"Open flow analysis and guided tour.",group:"Macros",onTrigger:()=>{Pt("deep_diagnosis")}},{id:"macro-team-sync",label:"Run team sync launch path",description:"Enable sync mode and generate shareable context.",group:"Macros",onTrigger:()=>{Pt("team_sync")}},{id:"story-toggle",label:Ue?"Stop story mode":"Start story mode",description:"Auto-runs a cinematic walkthrough.",group:"Story",keys:"S",onTrigger:xt},{id:"tour-start",label:"Start guided tour",description:"Walk the interface step by step.",group:"Onboarding",keys:"T",onTrigger:()=>me(!0)},{id:"explain-toggle",label:$e?"Disable explain mode":"Enable explain mode",description:"Toggle contextual overlays.",group:"Onboarding",keys:"E",onTrigger:()=>ke(n=>!n)},{id:"shortcuts",label:"Show shortcuts",description:"Open the keyboard map.",group:"Onboarding",keys:"?",onTrigger:()=>je(!0)},{id:"playback-toggle",label:ye?"Pause playback":"Play playback",description:"Start or stop the run.",group:"Playback",keys:"Space",onTrigger:en},{id:"mode-cinema",label:"Switch to Cinema",description:"Timeline playback view.",group:"Modes",keys:"C",onTrigger:()=>le("cinema")},{id:"mode-flow",label:"Switch to Flow",description:"Graph dependency view.",group:"Modes",keys:"F",onTrigger:()=>le("flow")},{id:"mode-compare",label:"Open Compare",description:"Side-by-side diff view.",group:"Modes",onTrigger:()=>le("compare"),disabled:!B},{id:"mode-matrix",label:"Open Matrix",description:"Counterfactual replay matrix view.",group:"Modes",onTrigger:()=>le("matrix")},{id:"mode-gameplay",label:"Open Gameplay",description:"World-class gameplay mechanics control center.",group:"Modes",keys:"G",onTrigger:()=>le("gameplay")},{id:"jump-bottleneck",label:"Jump to bottleneck",description:"Select the slowest step.",group:"Navigation",onTrigger:Te},{id:"jump-error",label:"Jump to error",description:"Select the first failed step.",group:"Navigation",onTrigger:nt},{id:"replay-step",label:"Replay from selected step",description:"Branch a Director’s Cut.",group:"Tools",onTrigger:()=>D&&ze(D),disabled:!D},{id:"overlay-toggle",label:kt?"Hide overlay":"Show overlay",description:"Ghost diff in Cinema/Flow.",group:"Tools",onTrigger:()=>Me(n=>!n),disabled:!B},{id:"safe-export",label:P?"Disable safe export":"Enable safe export",description:"Redact sensitive payloads.",group:"Safety",onTrigger:()=>he(n=>!n)},{id:"reload",label:"Reload traces",description:"Refresh trace data.",group:"Meta",onTrigger:o},{id:"handoff-digest",label:"Copy handoff digest",description:"Capture mode, risk summary, and next actions for teammates.",group:"Meta",keys:"H",onTrigger:()=>{Lt()}},{id:"section-journey",label:"Open journey workspace",description:"Show journey presets and persona progression.",group:"Workspace",onTrigger:()=>y("journey")},{id:"section-analysis",label:"Open analysis workspace",description:"Show async action health and export queue.",group:"Workspace",onTrigger:()=>y("analysis")},{id:"section-collaboration",label:"Open collaboration workspace",description:"Ownership, handoff, and activity timeline.",group:"Workspace",onTrigger:()=>y("collaboration")},{id:"section-operations",label:"Open operations workspace",description:"Setup, support, and feature flags.",group:"Workspace",onTrigger:()=>y("operations")},{id:"open-setup-wizard",label:"Open setup wizard",description:"Connect source, import context, and invite teammates.",group:"Workspace",onTrigger:()=>{ut(!0),U("ux.setup.opened",{source:"command_palette"})},disabled:!ue.setupWizardV1},{id:"open-support-panel",label:"Open support diagnostics",description:"Collect support payload and copy handoff diagnostics.",group:"Workspace",onTrigger:()=>{Mt(!0),U("ux.support.opened",{source:"command_palette"})},disabled:!ue.supportPanelV1},..._e.slice(0,5).map(n=>({id:`saved-view-${n.id}`,label:`Apply saved view: ${n.name}`,description:"Restore a saved journey configuration.",group:"Workspace",onTrigger:()=>tn(n.id)}))],[tn,Lt,ue.setupWizardV1,ue.supportPanelV1,Ue,xt,$e,ye,en,le,B,Te,nt,D,ze,kt,P,o,ke,Me,he,je,Mt,ut,me,y,_e,Pt,U]),Mo=l.useCallback(()=>{ve(`tutorial_skip:intro:${(e==null?void 0:e.id)||de||ne.seed}`,"funnel.tutorial_skip",{traceId:(e==null?void 0:e.id)||de||"unknown",source:"intro_overlay"}),Jt(!0)},[ve,ne.seed,de,Jt,e==null?void 0:e.id]),Eo=l.useCallback(()=>{Jt(!0),me(!0)},[Jt,me]),Io=l.useCallback(()=>{ve(`tutorial_skip:tour:${(e==null?void 0:e.id)||de||ne.seed}`,"funnel.tutorial_skip",{traceId:(e==null?void 0:e.id)||de||"unknown",source:"guided_tour"}),me(!1),lt(!0)},[ve,ne.seed,de,lt,e==null?void 0:e.id]),To=l.useCallback(()=>{ve(`tutorial_complete:${(e==null?void 0:e.id)||de||ne.seed}`,"funnel.tutorial_complete",{traceId:(e==null?void 0:e.id)||de||"unknown"}),me(!1),lt(!0)},[ve,ne.seed,de,lt,e==null?void 0:e.id]);return s?t.jsx(on,{variant:"loading",title:"Loading trace...",message:"Preparing timeline, graph, and replay context."}):!r&&!e&&c.length===0?t.jsx(on,{variant:"empty",title:"No traces yet",message:"Ingest your first trace, then reload to begin the Observe → Inspect → Direct workflow.",actions:[{id:"retry",label:"Retry",node:t.jsx("button",{className:"primary-button",type:"button",onClick:o,children:"Retry"})},{id:"help",label:"Open help",node:t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer",children:"Open help"})}]}):r||!e?t.jsx(on,{variant:"error",title:"Trace load failed",message:r??"Failed to load trace.",actions:[{id:"retry",label:"Retry",node:t.jsx("button",{className:"primary-button",type:"button",onClick:o,children:"Retry"})},{id:"help",label:"Open help",node:t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer",children:"Open help"})}]}):t.jsxs("div",{className:`app theme-${zt} ${$e?"explain-mode":""} ${u==="compare"?"mode-compare":""} ${u==="matrix"?"mode-matrix":""} ${u==="gameplay"?"mode-gameplay":""}`,children:[t.jsx(Lo,{trace:e,traces:c,selectedTraceId:d,onSelectTrace:p,onReload:o,onStartTour:()=>me(!0),onToggleStory:xt,onOpenPalette:()=>Oe(!0),onToggleExplain:()=>ke(n=>!n),onShareSession:la,onCreateHandoffDigest:()=>void Lt(),onOpenSupport:()=>{Mt(!0),U("ux.support.opened",{source:"header"})},onThemeChange:lr,onMotionChange:cr,themeMode:zt,motionMode:va,activeSessions:Ra,shareStatus:ea,handoffStatus:ht,explainMode:$e,storyActive:Ue,mode:u,missionCompletion:Qn,runHealthScore:_t,modeHotkeys:Rr,workspaces:Ls,workspaceId:wa,onWorkspaceChange:dr,workspaceRole:Ut,onWorkspaceRoleChange:ur,sessionLabel:at.label,sessionExpired:at.expired,onRenewSession:Pr}),t.jsx(_i,{notifications:Ct.map(({id:n,message:i,level:m})=>({id:n,message:i,level:m})),onDismiss:Or}),Dt?t.jsxs("div",{className:"undo-banner",role:"status","aria-live":"polite",children:[t.jsx("span",{children:Dt.label}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{var n,i;(i=(n=Wn.current)[Dt.id])==null||i.call(n),Ba(null)},children:"Undo"})]}):null,sa?t.jsx("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true","aria-label":"Confirm action",children:t.jsxs("div",{className:"palette confirm-dialog",children:[t.jsx("div",{className:"palette-header",children:t.jsxs("div",{children:[t.jsx("div",{className:"palette-title",children:sa.title}),t.jsx("div",{className:"palette-subtitle",children:sa.message})]})}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Ga(null),children:"Cancel"}),t.jsx("button",{className:"primary-button",type:"button",onClick:()=>{var i,m;const n=sa.id;U("ux.action.confirmed",{confirmationId:n}),(m=(i=Qa.current)[n])==null||m.call(i),delete Qa.current[n],Ga(null)},children:"Confirm"})]})]})}):null,ja&&ue.setupWizardV1?t.jsx("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true","aria-label":"First-run setup wizard",children:t.jsxs("div",{className:"palette setup-wizard",children:[t.jsxs("div",{className:"palette-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"palette-title",children:"First-run setup wizard"}),t.jsx("div",{className:"palette-subtitle",children:"Connect source, import context, invite teammates."})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>ut(!1),children:"Close"})]}),t.jsxs("div",{className:"setup-stepper",children:[t.jsx("span",{className:Je==="source"?"active":"",children:"1. Source"}),t.jsx("span",{className:Je==="import"?"active":"",children:"2. Import"}),t.jsx("span",{className:Je==="invite"?"active":"",children:"3. Invite"})]}),Je==="source"?t.jsxs("div",{className:"workspace-card",children:[t.jsxs("label",{children:["Data source",t.jsxs("select",{className:"search-select",value:Ve.dataSource,onChange:n=>Sa(i=>({...i,dataSource:n.target.value})),children:[t.jsx("option",{value:"",children:"Select source"}),t.jsx("option",{value:"api",children:"Live API"}),t.jsx("option",{value:"file",children:"Trace file import"}),t.jsx("option",{value:"hybrid",children:"Hybrid replay baseline"})]})]}),Be.dataSourceError?t.jsx("p",{className:"workspace-error",children:Be.dataSourceError}):null]}):null,Je==="import"?t.jsxs("div",{className:"workspace-card",children:[t.jsxs("label",{children:["Import path or URI",t.jsx("input",{className:"search-input",value:Ve.importPath,onChange:n=>Sa(i=>({...i,importPath:n.target.value})),placeholder:"/data/traces/latest.json"})]}),Be.importPathError?t.jsx("p",{className:"workspace-error",children:Be.importPathError}):null]}):null,Je==="invite"?t.jsxs("div",{className:"workspace-card",children:[t.jsxs("label",{children:["Invite emails (comma-separated)",t.jsx("input",{className:"search-input",value:Ve.inviteEmails,onChange:n=>Sa(i=>({...i,inviteEmails:n.target.value})),placeholder:"ops@example.com, qa@example.com"})]}),Be.inviteEmailsError?t.jsx("p",{className:"workspace-error",children:Be.inviteEmailsError}):null]}):null,t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>ka(n=>n==="invite"?"import":"source"),disabled:Je==="source",children:"Back"}),Je!=="invite"?t.jsx("button",{className:"primary-button",type:"button",onClick:()=>ka(n=>n==="source"?"import":"invite"),children:"Continue"}):t.jsx("button",{className:"primary-button",type:"button",disabled:!Be.isValid,onClick:bo,children:"Complete setup"})]})]})}):null,qa&&ue.supportPanelV1?t.jsx("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true","aria-label":"Support diagnostics",children:t.jsxs("div",{className:"palette support-panel",children:[t.jsxs("div",{className:"palette-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"palette-title",children:"Support diagnostics"}),t.jsx("div",{className:"palette-subtitle",children:"Capture environment and handoff payload for support triage."})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Mt(!1),children:"Close"})]}),t.jsxs("label",{children:["Support note",t.jsx("textarea",{className:"search-input",value:Et,onChange:n=>Sr(n.target.value),rows:3,placeholder:"Describe the issue, reproduction, and expected behavior."})]}),t.jsx("pre",{className:"support-diagnostics-preview",children:JSON.stringify(ia,null,2)}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>void go(),children:"Copy diagnostics payload"}),t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer",children:"Open help"})]})]})}):null,!dt&&!Wt?t.jsx(Ti,{onComplete:Mo,onStartTour:Eo,onStartStory:gt,persona:ge,onPersonaChange:ir,launchPath:ga,onLaunchPathChange:xa,onStartLaunchPath:n=>void Pt(n)}):null,dt&&!fa?t.jsx(Di,{explainMode:$e,storyActive:Ue,onStartTour:()=>{ya(!0),me(!0)},onStartStory:()=>{ya(!0),gt()},onToggleExplain:()=>ke(n=>!n),onDismiss:()=>ya(!0)}):null,t.jsx(Ci,{steps:mo,open:Na,onClose:Io,onComplete:To}),t.jsx(Mi,{enabled:$e}),t.jsx($i,{active:Ue,label:wo,step:ss,total:jo,onStop:Xe,onRestart:gt}),t.jsx(Fo,{insights:a,investigation:L,onSelectStep:n=>{F(n),u!=="cinema"&&f("cinema")},onJumpToError:nt,onJumpToBottleneck:Te}),t.jsx(xi,{trace:e,mode:u==="matrix"||u==="gameplay"?"cinema":u,playheadMs:Q,selectedStepId:D,compareTrace:B,collapsed:sr,onToggleCollapsed:()=>rr(n=>!n),onModeChange:le,onSelectStep:n=>{F(n),u!=="cinema"&&f("cinema")},onJumpToBottleneck:Te,onReplay:ze,onStartTour:()=>me(!0),priorityQueue:fo}),t.jsxs("nav",{className:"workspace-nav","aria-label":"Workspace navigation",children:[t.jsx("button",{className:`ghost-button ${b==="journey"?"active":""}`,type:"button",onClick:()=>y("journey"),children:"Journey"}),t.jsx("button",{className:`ghost-button ${b==="analysis"?"active":""}`,type:"button",onClick:()=>y("analysis"),children:"Analysis"}),t.jsx("button",{className:`ghost-button ${b==="collaboration"?"active":""}`,type:"button",onClick:()=>y("collaboration"),children:"Collaboration"}),t.jsx("button",{className:`ghost-button ${b==="operations"?"active":""}`,type:"button",onClick:()=>y("operations"),children:"Operations"})]}),t.jsxs("section",{className:"workspace-context-panel","aria-label":"Contextual workspace tools",children:[b==="journey"?t.jsxs("div",{className:"workspace-context-grid",children:[t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Persona progression"}),t.jsx("p",{children:ge==="executive"?"Executive mission path":ge==="operator"?"Operator mission path":"Builder mission path"}),t.jsx("div",{className:"workspace-checklist",children:No.map(n=>t.jsxs("div",{className:`workspace-check ${n.done?"done":""}`,children:[t.jsx("span",{children:n.done?"✓":"○"}),t.jsx("span",{children:n.label})]},n.label))})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Saved views"}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("input",{className:"search-input",placeholder:"Saved view name",value:tt,onChange:n=>Rn(n.target.value),"aria-label":"Saved view name"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:xo,disabled:!!Rt,children:"Save view"})]}),Rt&&tt.trim()?t.jsx("p",{className:"workspace-error",children:Rt}):null,t.jsxs("div",{className:"workspace-inline-form",children:[t.jsxs("select",{className:"search-select",value:qe,onChange:n=>na(n.target.value),"aria-label":"Saved views",children:[t.jsx("option",{value:"",children:"Select saved view"}),_e.map(n=>t.jsx("option",{value:n.id,children:n.name},n.id))]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>qe&&tn(qe),disabled:!qe,children:"Apply"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:vo,disabled:!qe,children:"Delete"})]})]})]}):null,b==="analysis"?t.jsxs("div",{className:"workspace-context-grid",children:[t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Async actions"}),ta.length===0?t.jsx("p",{children:"No tracked async actions yet."}):null,ta.map(n=>t.jsxs("div",{className:`async-action-row status-${n.status}`,children:[t.jsxs("div",{children:[t.jsx("strong",{children:n.label}),t.jsx("p",{children:n.detail})]}),t.jsxs("div",{className:"async-action-actions",children:[n.retryable?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Lr(n.id),children:"Retry"}):null,n.resumable?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Fr(n.id),children:"Resume"}):null]})]},n.id))]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Export center"}),ue.exportCenterV1?null:t.jsx("p",{children:"Export center is disabled by feature flag."}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>as(),disabled:!e||!ue.exportCenterV1,children:"Queue narrative export"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{Ot({id:"export-support-diagnostics",label:"Support diagnostics JSON",run:()=>an("agent-director-support-diagnostics.json",JSON.stringify(ia,null,2),"application/json")})},disabled:!ue.exportCenterV1,children:"Queue diagnostics export"})]}),ue.exportCenterV1&&_n.length===0?t.jsx("p",{children:"No exports queued."}):null,_n.map(n=>t.jsxs("div",{className:`export-task-row status-${n.status}`,children:[t.jsx("span",{children:n.label}),t.jsx("span",{children:n.detail}),n.retryable?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{var i,m;U("ux.export.retried",{taskId:n.id}),(m=(i=Hn.current)[n.id])==null||m.call(i)},children:"Retry"}):null]},n.id))]})]}):null,b==="collaboration"?t.jsxs("div",{className:"workspace-context-grid",children:[ue.ownershipPanelV1?null:t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Ownership panel disabled"}),t.jsx("p",{children:"Enable the ownership panel feature flag in Operations to configure handoff ownership."})]}),ue.ownershipPanelV1?t.jsxs(t.Fragment,{children:[t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Ownership and handoff"}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("input",{className:"search-input",value:It,onChange:n=>Nr(n.target.value),"aria-label":"Run owner",placeholder:"Run owner"}),t.jsx("input",{className:"search-input",value:Tt,onChange:n=>Cr(n.target.value),"aria-label":"Handoff owner",placeholder:"Handoff owner"})]}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void la(),children:"Share live link"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void Lt(),children:"Copy handoff digest"})]})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Collaboration activity"}),Ha.length===0?t.jsx("p",{children:"No collaboration activity yet."}):null,t.jsx("div",{className:"workspace-feed",children:Ha.slice(0,8).map(n=>t.jsxs("div",{className:"workspace-feed-item",children:[t.jsx("span",{children:new Date(n.timestamp).toLocaleTimeString()}),t.jsx("span",{children:n.message})]},n.id))})]})]}):null]}):null,b==="operations"?t.jsxs("div",{className:"workspace-context-grid",children:[t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Setup + support"}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{ut(!0),U("ux.setup.opened",{source:"operations_panel"})},disabled:!ue.setupWizardV1,children:"Open setup wizard"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{Mt(!0),U("ux.support.opened",{source:"operations_panel"})},disabled:!ue.supportPanelV1,children:"Open support panel"})]}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:ue.setupWizardV1,onChange:()=>ca("setupWizardV1")}),"Setup wizard flag"]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:ue.supportPanelV1,onChange:()=>ca("supportPanelV1")}),"Support panel flag"]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:ue.exportCenterV1,onChange:()=>ca("exportCenterV1")}),"Export center flag"]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:ue.ownershipPanelV1,onChange:()=>ca("ownershipPanelV1")}),"Ownership panel flag"]})]})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Telemetry summary"}),t.jsx("p",{children:"Product events are captured in local analytics queue for pre-release UX audits."}),t.jsx("div",{className:"workspace-inline-form",children:t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{const n=window.localStorage.getItem("agentDirector.analytics.events.v1")??"[]";Ot({id:"export-analytics-events",label:"Frontend analytics events",run:()=>an("agent-director-frontend-events.json",n,"application/json")})},children:"Export event queue"})})]})]}):null]}),t.jsxs("div",{className:"toolbar","data-help":!0,"data-help-indicator":!0,"data-tour":"toolbar","data-help-title":"Search + filters","data-help-body":"Filter by step type, enable Safe export, and jump between Cinema, Flow, Compare, and Matrix.","data-help-placement":"bottom",children:[t.jsx(Go,{query:x,typeFilter:h,onQueryChange:w,onTypeFilterChange:k}),t.jsxs("div",{className:"toolbar-actions",children:[t.jsx("input",{className:"search-input",value:S,onChange:n=>$(n.target.value),placeholder:"TraceQL (example: type=tool_call and duration_ms>800)","aria-label":"TraceQL query"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void qr(),children:"Run TraceQL"}),X?t.jsxs("span",{className:"status-badge",children:[X.matchCount," match(es)"]}):null,ko?t.jsx("span",{className:"status-badge",children:"Filtering..."}):null,t.jsxs("span",{className:"status-badge",children:["Hydration ",So]}),t.jsxs("span",{className:"status-badge",children:["Filter ",Mr,"ms"]}),X?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{$(""),E(null),z(null)},children:"Clear TraceQL"}):null,R?t.jsx("span",{className:"status-badge warn",children:R}):null,t.jsxs("select",{className:"search-select",value:j,onChange:n=>I(n.target.value),"aria-label":"Extension selector",children:[t.jsx("option",{value:"",children:"Select extension"}),V.map(n=>t.jsx("option",{value:n.id,children:n.name},n.id))]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void Gr(),disabled:!e||!j||N,children:N?"Running extension...":"Run extension"}),t.jsx("button",{className:`ghost-button ${u==="cinema"?"active":""}`,type:"button","aria-pressed":u==="cinema",title:"Timeline playback",onClick:()=>le("cinema"),"data-help":!0,"data-help-title":"Cinema mode","data-help-body":"Timeline view with step cards ordered by time.","data-help-placement":"bottom",children:"Cinema"}),t.jsx("button",{className:`ghost-button ${u==="flow"?"active":""}`,type:"button","aria-pressed":u==="flow",title:"Graph view",onClick:()=>le("flow"),"data-help":!0,"data-help-title":"Flow mode","data-help-body":"Dependency graph of steps and tool calls.","data-help-placement":"bottom",children:"Flow"}),t.jsx("button",{className:`ghost-button ${u==="compare"?"active":""}`,type:"button","aria-pressed":u==="compare",title:B?"Side-by-side compare":"Run a replay to enable compare",onClick:()=>le("compare"),disabled:!B,"data-tour":"compare","data-help":!0,"data-help-title":"Compare mode","data-help-body":"Side-by-side view after a replay. Enabled once you replay.","data-help-placement":"bottom",children:"Compare"}),t.jsx("button",{className:`ghost-button ${u==="matrix"?"active":""}`,type:"button","aria-pressed":u==="matrix",title:"Counterfactual replay matrix",onClick:()=>le("matrix"),"data-help":!0,"data-help-title":"Matrix mode","data-help-body":"Run multiple replay scenarios and rank likely causal factors.","data-help-placement":"bottom",children:"Matrix"}),t.jsx("button",{className:`ghost-button ${u==="gameplay"?"active":""}`,type:"button","aria-pressed":u==="gameplay",title:"Gameplay mechanics command center",onClick:()=>le("gameplay"),"data-help":!0,"data-help-title":"Gameplay mode","data-help-body":"Command raids, campaign, pvp, time forks, boss runs, economy, and liveops.","data-help-placement":"bottom",children:"Gameplay"}),t.jsxs("label",{className:"toggle",title:"Redact payloads and disable raw views for safe sharing","data-help":!0,"data-help-title":"Safe export","data-help-body":"Redacts secrets and disables raw payload views for safe sharing.","data-help-placement":"bottom",children:[t.jsx("input",{type:"checkbox",checked:P,onChange:()=>he(n=>!n)}),"Safe export"]}),e.steps.length>200||Fe?t.jsxs("label",{className:"toggle",title:"Window steps around the playhead for large traces","data-help":!0,"data-help-title":"Windowed mode","data-help-body":"Limits rendering to a playhead window for large traces.","data-help-placement":"bottom",children:[t.jsx("input",{type:"checkbox",checked:Fe,onChange:()=>Re(n=>!n)}),"Windowed"]}):null,B?t.jsxs("label",{className:"toggle",title:"Show ghost overlay of replay in Cinema/Flow","data-help":!0,"data-help-title":"Overlay replay","data-help-body":"Layer the replay over the base run to spot differences.","data-help-placement":"bottom",children:[t.jsx("input",{type:"checkbox",checked:kt,onChange:()=>Me(n=>!n)}),"Overlay"]}):null,t.jsxs("label",{className:"toggle",title:"Follow active collaborator cursor and mode updates",children:[t.jsx("input",{type:"checkbox",checked:Ce,onChange:()=>C(n=>!n)}),"Sync playback"]})]})]}),O?t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Extension output"}),t.jsx("pre",{className:"inspector-json",children:JSON.stringify(O,null,2)})]}):null,u==="cinema"?t.jsxs("div",{className:"playback-stack","data-tour":"playback",children:[t.jsx("div",{"data-help":!0,"data-help-title":"Playback controls","data-help-body":"Play, pause, scrub, and adjust speed to feel the rhythm of the run.","data-help-placement":"bottom",children:t.jsx(ps,{playheadMs:Q,wallTimeMs:e.metadata.wallTimeMs||1,isPlaying:ye,speed:it,onToggle:()=>A(n=>!n),onScrub:n=>we(n),onSpeedChange:Ae})}),t.jsx("div",{"data-help":!0,"data-help-title":"Density map","data-help-body":"Zoom into hotspots and keep long traces readable with windowing.","data-help-placement":"bottom",children:t.jsx(ui,{traceStart:e.startedAt,traceEnd:e.endedAt,steps:e.steps,playheadMs:Q,windowRange:ns,windowed:Fe,spanMs:T,onSpanChange:ee,onToggleWindowed:Re,onScrub:n=>we(n),persistenceKey:e.id,laneStrategy:pe,visibleLaneGroups:Ar,remotePlayheads:$r})})]}):null,u==="compare"&&B?t.jsx("div",{"data-help":!0,"data-help-title":"Compare playback","data-help-body":"Sync both runs to evaluate improvements at identical timestamps.","data-help-placement":"bottom",children:t.jsx(ps,{playheadMs:Q,wallTimeMs:Math.max(e.metadata.wallTimeMs||1,B.metadata.wallTimeMs||1),isPlaying:ye,speed:it,onToggle:()=>A(n=>!n),onScrub:n=>we(n),onSpeedChange:Ae})}):null,t.jsxs("main",{className:`stage ${u==="compare"?"stage-compare":""} motion-fade-in`,role:"main",children:[t.jsx("div",{className:"main motion-slide-up",ref:Va,"data-help":!0,"data-help-indicator":!0,"data-tour":"stage","data-help-title":"Trace stage","data-help-body":"Every step becomes a scene. Hover or click to open deep inspection.","data-help-placement":"top",children:t.jsx(Oi,{morph:pr,onComplete:ho,children:t.jsxs(l.Suspense,{fallback:t.jsx("div",{className:"loading",children:"Loading view..."}),children:[u==="cinema"?t.jsx(ri,{trace:e,steps:Jn,selectedStepId:D,onSelectStep:n=>F(n),playheadMs:Q,windowRange:ns,timing:a==null?void 0:a.timing,ghostTrace:kt?B:null,diff:Dr,laneStrategy:pe,laneGroupsOrder:yt.order,hiddenLaneGroups:yt.hidden,onLaneStrategyChange:Br,onToggleLaneGroupVisibility:zr,onMoveLaneGroup:to}):null,u==="flow"?t.jsx(oc,{steps:Jn,selectedStepId:D,onSelectStep:n=>F(n),baseTrace:e,compareTrace:B,compareSteps:Tr,overlayEnabled:kt,onToggleOverlay:()=>Me(n=>!n)}):null,u==="compare"&&B?t.jsx(ic,{baseTrace:e,compareTrace:B,playheadMs:Q,safeExport:P,onExit:()=>{f("cinema"),fe(null)}}):null,u==="matrix"?t.jsx(cc,{steps:e.steps,anchorStepId:Ia,onAnchorStepChange:Ta,scenarios:Da,onScenarioChange:so,onDuplicateScenario:lo,onMoveScenario:co,onAddScenario:oo,onRemoveScenario:io,onRun:Za,onCancel:uo,onReplaceScenarios:ro,loading:mr,error:Yt,job:Ke,matrix:Se,safeExport:P,onOpenCompare:po}):null,u==="gameplay"?t.jsx(dc,{state:ne,playheadMs:Q,onUpdate:n=>Nt(i=>n(i)),session:ce,playerId:Ie,sessionError:Xt,onCreateSession:Ur,onJoinSession:Hr,onLeaveSession:Wr,onReconnectSession:Jr,onDispatchAction:Vr,guild:hr,social:fr,onInviteFriend:Zr,onAcceptFriendInvite:eo,locale:yr,onLocaleChange:br,gamepadEnabled:$a,onToggleGamepad:gr,gamepadPreset:_a,onGamepadPresetChange:xr,isOnline:vr,onRetryConnectivity:es,onCreateGuild:Kr,onJoinGuild:Qr,onScheduleGuildEvent:Yr,onCompleteGuildEvent:Xr,observability:wr,analytics:jr}):null]})})}),t.jsx(l.Suspense,{fallback:t.jsx("div",{className:"loading",children:"Loading panel..."}),children:u==="compare"||u==="matrix"||u==="gameplay"?null:Kn?t.jsx(lc,{traceId:e.id,step:Kn,safeExport:P,onClose:()=>F(null),onReplay:ze}):t.jsx(Ni,{trace:e,mode:u,selectedStepId:D,onModeChange:le,onSelectStep:n=>F(n),onJumpToBottleneck:Te,onReplay:ze,recommendations:Le,persona:ge,annotations:_r,activityFeed:Ha,onAddAnnotation:no,missionProgress:Ht,missionCompletion:Qn,onResetMissions:ao,narrative:st,onAskDirector:yo,onExportNarrative:as})})]}),t.jsxs("div",{className:"mobile-quick-rail","aria-label":"Mobile quick actions",children:[t.jsx("button",{className:`ghost-button ${Ue?"active":""}`,type:"button",onClick:xt,"aria-label":Ue?"Stop story mode":"Start story mode",children:Ue?"Stop Story":"Story"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>me(!0),"aria-label":"Start guided tour",children:"Guide"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Oe(!0),"aria-label":"Open command palette",children:"Command"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void Lt(),"aria-label":"Copy handoff digest",children:"Handoff"})]}),t.jsx(Ai,{mode:u==="matrix"||u==="gameplay"?"cinema":u,isPlaying:ye,storyActive:Ue,explainMode:$e,hidden:u==="compare",open:or,onToggleOpen:()=>ba(n=>!n),onTogglePlay:en,onStartStory:gt,onStopStory:Xe,onStartTour:()=>me(!0),onOpenPalette:()=>Oe(!0),onShowShortcuts:()=>je(!0),onToggleExplain:()=>ke(n=>!n),onJumpToBottleneck:Te}),t.jsx(bi,{open:jt,onClose:()=>Oe(!1),actions:Co,context:{section:b,mode:u,persona:ge},onActionRun:n=>U("ux.palette.command_run",{id:n.id,group:n.group??null})}),t.jsx(mi,{open:be,onClose:()=>je(!1)})]})}Ao.createRoot(document.getElementById("root")).render(t.jsx($o.StrictMode,{children:t.jsx(bc,{})}));"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js")});export{Rc as A,qc as B,Oc as C,Pc as D,Lc as E,Fc as F,Gc as G,Uc as H,Hc as I,zc as J,Yo as S,ni as T,Cl as a,Il as b,li as c,Ws as d,wc as e,vc as f,Zi as g,an as h,Gl as i,kc as j,Bl as k,zl as l,jc as m,Sc as n,Bc as o,Nc as p,Cc as q,Ec as r,zo as s,Ic as t,Mc as u,Tc as v,Dc as w,Ac as x,$c as y,_c as z};
