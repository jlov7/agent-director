const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-C-CcVsd3.js","assets/vendor-react-D4yGots9.js","assets/vendor-DClHNS3s.js","assets/vendor-B5DZHykP.css","assets/index-CnXjrZZD.js","assets/index-CFo8RPdd.js","assets/index-CsPjrfjF.js","assets/index-BS0oCvFz.js"])))=>i.map(i=>d[i]);
import{j as t,r as c,a as Vi,R as Ki}from"./vendor-react-D4yGots9.js";import{m as Qi,d as Ss}from"./vendor-DClHNS3s.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const d of i)if(d.type==="childList")for(const l of d.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function s(i){const d={};return i.integrity&&(d.integrity=i.integrity),i.referrerPolicy&&(d.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?d.credentials="include":i.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function r(i){if(i.ep)return;i.ep=!0;const d=s(i);fetch(i.href,d)}})();const Yi="modulepreload",Xi=function(e){return"/agent-director/"+e},Ns={},Ht=function(n,s,r){let i=Promise.resolve();if(s&&s.length>0){document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),p=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));i=Promise.allSettled(s.map(u=>{if(u=Xi(u),u in Ns)return;Ns[u]=!0;const m=u.endsWith(".css"),g=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${g}`))return;const f=document.createElement("link");if(f.rel=m?"stylesheet":Yi,m||(f.as="script"),f.crossOrigin="",f.href=u,p&&f.setAttribute("nonce",p),document.head.appendChild(f),m)return new Promise((x,v)=>{f.addEventListener("load",x),f.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${u}`)))})}))}function d(l){const p=new Event("vite:preloadError",{cancelable:!0});if(p.payload=l,window.dispatchEvent(p),!p.defaultPrevented)throw l}return i.then(l=>{for(const p of l||[])p.status==="rejected"&&d(p.reason);return n().catch(d)})},Zi=()=>t.jsxs("svg",{className:"logo-mark",width:"54",height:"54",viewBox:"0 0 120 120",role:"img","aria-label":"Agent Director logo",children:[t.jsx("rect",{x:"8",y:"8",width:"104",height:"104",rx:"18",className:"logo-frame"}),t.jsx("rect",{x:"24",y:"28",width:"72",height:"16",rx:"6",className:"logo-bar logo-bar-a"}),t.jsx("rect",{x:"24",y:"52",width:"72",height:"16",rx:"6",className:"logo-bar logo-bar-b"}),t.jsx("rect",{x:"24",y:"76",width:"72",height:"16",rx:"6",className:"logo-bar logo-bar-c"}),t.jsx("circle",{cx:"96",cy:"36",r:"6",className:"logo-node logo-node-a"}),t.jsx("circle",{cx:"96",cy:"60",r:"6",className:"logo-node logo-node-b"}),t.jsx("circle",{cx:"96",cy:"84",r:"6",className:"logo-node logo-node-c"})]});function eo({trace:e,traces:n=[],selectedTraceId:s,onSelectTrace:r,onReload:i,onStartTour:d,onToggleStory:l,onOpenPalette:p,onToggleExplain:u,onShareSession:m,onThemeChange:g,onMotionChange:f,themeMode:x="studio",motionMode:v="balanced",activeSessions:w=1,shareStatus:y=null,handoffStatus:S=null,explainMode:N=!1,storyActive:D=!1,mode:J="cinema",missionCompletion:I,runHealthScore:$=100,modeHotkeys:H="C / F / Space",onCreateHandoffDigest:F,onOpenSupport:z,workspaces:V=[],workspaceId:ie,onWorkspaceChange:k,workspaceRole:E="operator",onWorkspaceRoleChange:R,sessionLabel:U="Active",sessionExpired:C=!1,onRenewSession:Q}){const T=Math.max(0,Math.min(100,Math.round($))),q=I?`${I.done}/${I.total} missions`:"Missions n/a";return t.jsxs("header",{className:"header","data-help":!0,"data-help-indicator":!0,"data-tour":"header","data-help-title":"Mission control","data-help-body":"Trace identity, status, and live controls live here. Use Story, Guide, or Explain to orient new viewers.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"header-title",children:[t.jsxs("div",{className:"header-logo",children:[t.jsx(Zi,{}),t.jsx("span",{children:"Agent Director"})]}),t.jsx("div",{className:"header-tagline",children:"Cinematic trace intelligence for agent runs."}),t.jsxs("div",{className:"header-meta",children:[t.jsxs("span",{className:"header-run",children:["Run: ",(e==null?void 0:e.id)??"loading"]}),n.length>0?t.jsx("select",{className:"trace-select",value:s??(e==null?void 0:e.id)??"","aria-label":"Select trace",onChange:P=>r==null?void 0:r(P.target.value),"data-help":!0,"data-help-title":"Trace selector","data-help-body":"Switch between available runs to compare different sessions.","data-help-placement":"bottom",children:n.map(P=>t.jsxs("option",{value:P.id,children:[P.name," (",P.id,")"]},P.id))}):null,t.jsx("span",{className:`status-pill status-${(e==null?void 0:e.status)??"loading"}`,children:(e==null?void 0:e.status)??"loading"}),e!=null&&e.replay?t.jsxs("span",{className:"header-replay",title:`Replay from ${e.branchPointStepId??"unknown step"}`,children:["Replay: ",e.replay.strategy]}):null,t.jsxs("span",{className:"header-wall",children:["Wall: ",(e==null?void 0:e.metadata.wallTimeMs)??0,"ms"]}),t.jsxs("span",{className:"header-presence","aria-label":"Active sessions",children:["Live: ",w]}),t.jsxs("span",{className:"header-mode-pill","aria-label":"Current mode",children:["Mode: ",J]}),ie?t.jsxs("span",{className:"header-workspace-pill","aria-label":"Current workspace",children:["Workspace: ",ie]}):null,t.jsxs("span",{className:`header-role-pill role-${E}`,"aria-label":"Current workspace role",children:["Role: ",E]}),t.jsxs("span",{className:`header-session-pill ${C?"expired":""}`,"aria-label":"Session status",children:["Session: ",U]}),t.jsxs("span",{className:"header-hotkeys","aria-label":"Mode hotkeys",children:["Keys: ",H]}),t.jsx("span",{className:"header-mission","aria-label":"Mission completion",children:q}),t.jsxs("span",{className:"header-health","aria-label":`Run health score ${T}`,children:[t.jsx("span",{className:"header-health-bar",children:t.jsx("span",{className:"header-health-fill",style:{width:`${T}%`}})}),t.jsxs("span",{children:["Health ",T]})]}),y?t.jsx("span",{className:"header-share-status",children:y}):null,S?t.jsx("span",{className:"header-share-status",children:S}):null]})]}),t.jsxs("div",{className:"header-actions",children:[t.jsxs("label",{className:"theme-picker",children:["Workspace",t.jsx("select",{className:"trace-select",value:ie,"aria-label":"Select workspace",onChange:P=>k==null?void 0:k(P.target.value),children:V.map(P=>t.jsx("option",{value:P.id,children:P.label},P.id))})]}),t.jsxs("label",{className:"theme-picker",children:["Role",t.jsxs("select",{className:"trace-select",value:E,"aria-label":"Select workspace role",onChange:P=>R==null?void 0:R(P.target.value),children:[t.jsx("option",{value:"viewer",children:"Viewer"}),t.jsx("option",{value:"operator",children:"Operator"}),t.jsx("option",{value:"admin",children:"Admin"})]})]}),t.jsxs("label",{className:"theme-picker",children:["Theme",t.jsxs("select",{className:"trace-select",value:x,"aria-label":"Select theme",onChange:P=>g==null?void 0:g(P.target.value),children:[t.jsx("option",{value:"studio",children:"Studio"}),t.jsx("option",{value:"focus",children:"Focus"}),t.jsx("option",{value:"contrast",children:"Contrast"})]})]}),t.jsxs("label",{className:"theme-picker",children:["Motion",t.jsxs("select",{className:"trace-select",value:v,"aria-label":"Select motion profile",onChange:P=>f==null?void 0:f(P.target.value),children:[t.jsx("option",{value:"cinematic",children:"Cinematic"}),t.jsx("option",{value:"balanced",children:"Balanced"}),t.jsx("option",{value:"minimal",children:"Minimal"})]})]}),t.jsx("button",{className:`ghost-button ${D?"active":""}`,type:"button",onClick:l,"aria-pressed":D,"aria-label":"Toggle story mode","data-help":!0,"data-help-title":"Story mode","data-help-body":"Auto-runs a cinematic walkthrough for demos.","data-help-placement":"bottom",children:"Story"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:d,"aria-label":"Start guided tour","data-help":!0,"data-help-title":"Guided tour","data-help-body":"Walk through the interface step by step.","data-help-placement":"bottom",children:"Guide"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:p,"aria-label":"Open command palette","data-help":!0,"data-help-title":"Command palette","data-help-body":"Search and trigger any action instantly.","data-help-placement":"bottom",children:"Command"}),t.jsx("button",{className:`ghost-button ${N?"active":""}`,type:"button",onClick:u,"aria-pressed":N,"aria-label":"Toggle explain mode","data-help":!0,"data-help-title":"Explain mode","data-help-body":"Hover any control to see contextual guidance.","data-help-placement":"bottom",children:"Explain"}),t.jsx("button",{className:"ghost-button",onClick:i,type:"button","aria-label":"Refresh traces",title:"Refresh traces","data-help":!0,"data-help-title":"Refresh","data-help-body":"Reload traces from the data store.","data-help-placement":"bottom",children:"Refresh"}),t.jsx("button",{className:`ghost-button ${C?"warn":""}`,type:"button",onClick:Q,"aria-label":"Renew workspace session",title:"Renew workspace session",children:"Renew Session"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:m,"aria-label":"Copy live session link",title:"Copy live session link",children:"Share"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:F,"aria-label":"Copy session handoff digest",title:"Copy session handoff digest",children:"Handoff"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:z,"aria-label":"Open support diagnostics",title:"Open support diagnostics",children:"Support"}),t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer","data-help":!0,"data-help-title":"Help","data-help-body":"Open quick docs for first run, key flows, troubleshooting, and shortcuts.","data-help-placement":"bottom",children:"Help"}),null]})]})}function to({insights:e,investigation:n,onSelectStep:s,onJumpToBottleneck:r,onJumpToError:i}){var x,v,w,y,S;if(!e)return null;const d=e.timing,l=e.ioWarnings??[],p=e.concurrency,u=e.retryPatterns,m=e.costByTool??{},g=e.costByModel??{},f=((x=n==null?void 0:n.hypotheses)==null?void 0:x.slice(0,2))??[];return t.jsxs("section",{className:"insight-strip","data-help":!0,"data-help-indicator":!0,"data-tour":"insights","data-help-title":"Run insights","data-help-body":"Fast diagnostics for latency, cost, errors, and concurrency. Click chips to jump into the trace.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Top latency","data-help-body":"Largest steps by duration; jump straight to the slowest.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Top latency"}),t.jsxs("div",{className:"insight-items",children:[e.topLatencySteps.map(N=>t.jsxs("button",{className:"insight-chip",type:"button",title:`Jump to ${N.name}`,onClick:()=>s==null?void 0:s(N.stepId),children:[N.name," (",N.durationMs,"ms)"]},N.stepId)),e.topLatencySteps.length>0?t.jsx("button",{className:"insight-chip",type:"button",onClick:r,title:"Jump to longest step",children:"Jump to bottleneck"}):null]})]}),t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Cost by type","data-help-body":"Aggregated spend by step class.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Cost by type"}),t.jsx("div",{className:"insight-items",children:Object.entries(e.costByType).map(([N,D])=>t.jsxs("span",{className:"insight-chip",title:`Total cost for ${N}`,children:[N,": $",D.toFixed(3)]},N))})]}),Object.keys(m).length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Cost by tool","data-help-body":"Top tools by total spend.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Cost by tool"}),t.jsx("div",{className:"insight-items",children:Object.entries(m).sort((N,D)=>D[1]-N[1]).slice(0,3).map(([N,D])=>t.jsxs("span",{className:"insight-chip",title:`Total cost for ${N}`,children:[N,": $",D.toFixed(3)]},N))})]}):null,t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Errors & retries","data-help-body":"Instant visibility into failed or retried steps.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Errors / retries"}),t.jsxs("div",{className:"insight-items",children:[t.jsxs("span",{className:"insight-chip",children:["Errors: ",e.errors]}),t.jsxs("span",{className:"insight-chip",children:["Retries: ",e.retries]}),e.errors>0?t.jsx("button",{className:"insight-chip",type:"button",onClick:i,title:"Jump to first error",children:"Jump to first error"}):null,(v=u==null?void 0:u.topRetries)!=null&&v.length?t.jsxs("span",{className:"insight-chip",title:`Retry rate ${(u.retryRate*100).toFixed(1)}%`,children:["Top retries: ",u.topRetries.length]}):null]})]}),t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Wall vs work","data-help-body":"Wall time vs summed work to show parallelism.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Wall vs work"}),t.jsxs("div",{className:"insight-items",children:[t.jsxs("span",{className:"insight-chip",title:"Wall clock duration",children:["Wall: ",e.wallTimeMs,"ms"]}),t.jsxs("span",{className:"insight-chip",title:"Sum of step durations",children:["Work: ",e.workTimeMs,"ms"]}),e.criticalPathMs!=null?t.jsxs("span",{className:"insight-chip",title:"Longest parent-child chain",children:["Critical: ",e.criticalPathMs,"ms"]}):null]})]}),t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Health","data-help-body":"Timing and I/O anomalies detected in the trace.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Health"}),t.jsxs("div",{className:"insight-items",children:[d!=null&&d.degraded?t.jsx("span",{className:"insight-chip insight-warning",title:d.issues.join(" "),children:"Timing degraded"}):t.jsx("span",{className:"insight-chip",children:"Timing OK"}),l.length>0?t.jsxs("span",{className:"insight-chip insight-warning",title:l.map(N=>N.message).join(" "),children:["IO warnings: ",l.length]}):t.jsx("span",{className:"insight-chip",children:"IO OK"})]})]}),f.length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Investigator","data-help-body":"Automated root-cause hypotheses ranked by severity and confidence.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Investigator"}),t.jsxs("div",{className:"insight-items",children:[f.map(N=>t.jsxs("span",{className:"insight-chip",title:N.summary,children:[N.title," (",Math.round(N.confidence*100),"%)"]},N.id)),(y=(w=f[0])==null?void 0:w.evidenceStepIds)!=null&&y[0]?t.jsx("button",{className:"insight-chip",type:"button",onClick:()=>s==null?void 0:s(f[0].evidenceStepIds[0]),children:"Jump to evidence"}):null]})]}):null,(S=p==null?void 0:p.buckets)!=null&&S.length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Parallelism","data-help-body":"How many steps ran concurrently over time.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Parallelism"}),t.jsx("div",{className:"insight-items",children:t.jsx("div",{className:"insight-heatmap",title:`Peak concurrency: ${p.peak}`,children:p.buckets.map((N,D)=>t.jsx("span",{className:"heatmap-bar",style:{height:`${Math.max(20,N.active/Math.max(1,p.peak)*48)}px`},title:`Bucket ${D+1}: ${N.active} active`},`${N.startMs}-${N.endMs}`))})})]}):null,Object.keys(g).length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Model cost","data-help-body":"Spend by model family.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Model cost"}),t.jsx("div",{className:"insight-items",children:Object.entries(g).map(([N,D])=>t.jsxs("span",{className:"insight-chip",title:`Total cost for ${N}`,children:[N,": $",D.toFixed(3)]},N))})]}):null]})}const ao=["all","llm_call","tool_call","decision","handoff","guardrail"];function no({query:e,typeFilter:n,onQueryChange:s,onTypeFilterChange:r}){return t.jsxs("div",{className:"search-bar",children:[t.jsx("input",{className:"search-input",placeholder:"Search steps, tools, previews...","aria-label":"Search steps",value:e,onChange:i=>s(i.target.value),"data-help":!0,"data-help-title":"Search","data-help-body":"Filter steps by name, tool, or payload preview. Great for fast recall.","data-help-placement":"bottom"}),t.jsx("select",{className:"search-select",value:n,"aria-label":"Filter by step type",onChange:i=>r(i.target.value),"data-help":!0,"data-help-title":"Type filter","data-help-body":"Narrow the timeline to a specific class of steps (LLM, tool, decision, handoff).","data-help-placement":"bottom",children:ao.map(i=>t.jsx("option",{value:i,children:i},i))})]})}function xa(e,n,s){const r=Date.parse(e),i=s.map(g=>Date.parse(g.endedAt??g.startedAt)).filter(g=>Number.isFinite(g)),d=n?Date.parse(n):i.length?Math.max(...i):r,l=Math.max(1,d-r),p=s.map(g=>{const f=Math.max(0,Date.parse(g.startedAt)-r),x=Math.max(f,Date.parse(g.endedAt??g.startedAt)-r);return{stepId:g.id,startMs:f,endMs:x}}).sort((g,f)=>g.startMs-f.startMs||g.endMs-f.endMs),u=[],m=[];for(const g of p){let f=u.findIndex(x=>x<=g.startMs);f===-1?(f=u.length,u.push(g.endMs)):u[f]=g.endMs,m.push({stepId:g.stepId,startMs:g.startMs,endMs:g.endMs,lane:f,xPct:g.startMs/l*100,wPct:Math.max(.75,(g.endMs-g.startMs)/l*100)})}return{wallTimeMs:l,intervals:m,laneCount:u.length}}function so(e){var w;const s=e.steps.map(y=>({stepId:y.id,name:y.name,durationMs:y.durationMs??0})).sort((y,S)=>S.durationMs-y.durationMs).slice(0,3),r={},i={};for(const y of e.steps)((w=y.metrics)==null?void 0:w.costUsd)!=null&&(r[y.type]=(r[y.type]??0)+y.metrics.costUsd,y.type==="tool_call"&&(i[y.name]=(i[y.name]??0)+y.metrics.costUsd));const d=e.steps.filter(y=>y.status==="failed").length,l=e.steps.filter(y=>!!y.retryOfStepId).length,p=e.metadata.wallTimeMs,u=e.metadata.workTimeMs??e.steps.reduce((y,S)=>y+(S.durationMs??0),0),m=io(e),g=oo(e.steps),f=lo(e.steps),x=co(e),v=uo(e.steps);return{topLatencySteps:s,costByType:r,costByTool:i,costByModel:{[e.metadata.modelId]:e.metadata.totalCostUsd??0},errors:d,retries:l,wallTimeMs:p,workTimeMs:u,timing:m,ioWarnings:g,criticalPathMs:f,concurrency:x,retryPatterns:v}}function ro(e){var s;const n=(s=e.metrics)==null?void 0:s.costUsd;return n==null?null:`$${n.toFixed(3)}`}function We(e){if(!e)return null;const n=Date.parse(e);return Number.isNaN(n)?null:n}function io(e){const n=We(e.startedAt),s=We(e.endedAt??void 0),r=[],i=[],d=[];return n==null&&d.push("Trace start time missing or invalid."),e.steps.forEach(l=>{const p=We(l.startedAt),u=We(l.endedAt??l.startedAt);if(p==null||u==null){r.push(l.id);return}if(u<p){i.push(l.id);return}n!=null&&p<n&&i.push(l.id),s!=null&&u>s&&i.push(l.id)}),r.length&&d.push(`Missing timestamps on ${r.length} steps.`),i.length&&d.push(`Timestamp skew detected on ${i.length} steps.`),{degraded:!!(r.length||i.length||n==null),issues:d,missingStepIds:r,skewedStepIds:i}}function oo(e){const n=new Map;e.forEach(d=>{d.type==="tool_call"&&d.toolCallId&&n.set(d.toolCallId,d)});const s=new Set,r=new Set,i=[];return e.forEach(d=>{d.type!=="llm_call"||!d.io||((d.io.emittedToolCallIds??[]).forEach(l=>{s.add(l),n.has(l)||i.push({kind:"missing_tool_step",message:`Emitted toolCallId ${l} has no tool step.`,stepId:d.id,toolCallId:l})}),(d.io.consumedToolCallIds??[]).forEach(l=>{r.add(l),n.has(l)||i.push({kind:"missing_tool_step",message:`Consumed toolCallId ${l} has no tool step.`,stepId:d.id,toolCallId:l}),s.has(l)||i.push({kind:"consume_without_emit",message:`Consumed toolCallId ${l} without emission.`,stepId:d.id,toolCallId:l})}))}),n.forEach((d,l)=>{s.has(l)||i.push({kind:"unemitted_tool",message:`Tool step ${d.id} has toolCallId ${l} never emitted.`,stepId:d.id,toolCallId:l}),r.has(l)||i.push({kind:"unconsumed_tool",message:`Tool step ${d.id} has toolCallId ${l} never consumed.`,stepId:d.id,toolCallId:l})}),i}function lo(e){const n=new Map,s=new Map,r=[];e.forEach(l=>{if(n.set(l.id,l.durationMs??0),l.parentStepId){const p=s.get(l.parentStepId)??[];p.push(l.id),s.set(l.parentStepId,p)}else r.push(l.id)});const i=new Map,d=l=>{if(i.has(l))return i.get(l)??0;const u=(s.get(l)??[]).reduce((g,f)=>Math.max(g,d(f)),0),m=(n.get(l)??0)+u;return i.set(l,m),m};return r.length?Math.max(...r.map(l=>d(l))):0}function co(e){const n=We(e.startedAt);if(n==null)return{buckets:[],peak:0};const s=We(e.endedAt??void 0)??Math.max(...e.steps.map(u=>We(u.endedAt??u.startedAt)??n),n),r=Math.max(1,s-n),i=12,d=Math.max(1,Math.floor(r/i)),l=[];let p=0;for(let u=0;u<i;u+=1){const m=n+u*d,g=m+d;let f=0;e.steps.forEach(x=>{const v=We(x.startedAt),w=We(x.endedAt??x.startedAt);v==null||w==null||w>=m&&v<=g&&(f+=1)}),p=Math.max(p,f),l.push({startMs:u*d,endMs:(u+1)*d,active:f})}return{buckets:l,peak:p}}function uo(e){const n={};e.forEach(i=>{i.retryOfStepId&&(n[i.retryOfStepId]=(n[i.retryOfStepId]??0)+1)});const s=Object.values(n).reduce((i,d)=>i+d,0),r=Object.entries(n).sort((i,d)=>d[1]-i[1]).slice(0,3);return{totalRetries:s,retryRate:e.length?s/e.length:0,topRetries:r.map(([i,d])=>({stepId:i,count:d}))}}const po={llm_call:{label:"LLM",icon:"LLM",description:"Model call"},tool_call:{label:"TOOL",icon:"TOOL",description:"Tool call"},decision:{label:"DEC",icon:"DEC",description:"Decision"},handoff:{label:"HAND",icon:"HAND",description:"Handoff"},guardrail:{label:"GUARD",icon:"GUARD",description:"Guardrail"}};function mo(e){return po[e]}function ho({type:e,size:n="sm",showLabel:s=!1}){const r=mo(e);return t.jsxs("span",{className:`step-badge step-badge-${e} step-badge-${n}`,title:r.description,children:[t.jsx("span",{className:"step-badge-icon",children:r.icon}),s?t.jsx("span",{className:"step-badge-label",children:r.label}):null]})}function or({step:e,interval:n,playbackState:s,selected:r,onSelect:i,variant:d="base",diffStatus:l,disabled:p=!1,laneHeight:u=140}){var I,$,H,F,z,V;const m=ro(e),g=((I=e.preview)==null?void 0:I.subtitle)??(($=e.preview)==null?void 0:$.title)??"",f=((H=e.preview)==null?void 0:H.outputPreview)??((F=e.preview)==null?void 0:F.inputPreview)??"",x=l?`step-diff-${l}`:"",v=d==="ghost"?"step-ghost":"",w=n.wPct<8?"step-compact":"",y=e.type.replace("_"," ").toUpperCase(),S=((z=e.metrics)==null?void 0:z.tokensTotal)!=null?`${e.metrics.tokensTotal} tokens`:null,N=e.durationMs!=null?`${e.durationMs}ms`:null,D=[S,N,m].filter(Boolean).join(" · "),J=`Click to inspect inputs/outputs and replay from this moment.${D?` ${D}.`:""}`;return t.jsxs("button",{type:"button",className:`step-card step-${e.type} step-${s} ${r?"step-selected":""} ${x} ${v} ${w}`,"data-step-id":e.id,"aria-pressed":r,"aria-hidden":d==="ghost",disabled:p,"data-help":!0,"data-help-title":`${e.name} · ${y}`,"data-help-body":J,"data-help-placement":"top",style:{left:`${n.xPct}%`,width:`${n.wPct}%`,top:`${n.lane*u}px`},onClick:()=>{p||i(e.id)},children:[t.jsxs("div",{className:"step-card-header",children:[t.jsxs("div",{className:"step-title-group",children:[t.jsx(ho,{type:e.type}),t.jsx("span",{className:"step-title",children:e.name})]}),t.jsx("span",{className:`status-pill status-${e.status}`,children:e.status})]}),g?t.jsx("div",{className:"step-subtitle",children:g}):null,t.jsxs("div",{className:"step-metrics",children:[((V=e.metrics)==null?void 0:V.tokensTotal)!=null?t.jsxs("span",{children:[e.metrics.tokensTotal," tok"]}):null,e.durationMs!=null?t.jsxs("span",{children:[e.durationMs,"ms"]}):null,m?t.jsx("span",{children:m}):null]}),f?t.jsx("div",{className:"step-preview",children:f}):null]})}function lr(e,n){return n<e.startMs?"future":n>e.endMs?"past":"active"}const zt={type:{order:[],hidden:[]},status:{order:[],hidden:[]},parent:{order:[],hidden:[]}};function Sn(e,n){return n==="type"?e.type:n==="status"?e.status:e.parentStepId??"root"}function fo(e,n){const s=new Set;return e.forEach(r=>s.add(Sn(r,n))),Array.from(s).sort((r,i)=>r.localeCompare(i))}function Cs(e,n,s){const r=new Set(e),i=[...n.filter(l=>r.has(l))];e.forEach(l=>{i.includes(l)||i.push(l)});const d=Array.from(new Set(s.filter(l=>r.has(l))));return{order:i,hidden:d}}const yo=140,go=132,bo=96,Ms={llm_call:1,tool_call:2,decision:3,handoff:4,guardrail:5};function cr(e){return[...e].sort((n,s)=>(Ms[n.type]??9)-(Ms[s.type]??9))}function xo(e,n,s,r,i){const d=new Map;n.forEach(x=>{var w;const v=Sn(x,s);d.has(v)||d.set(v,[]),(w=d.get(v))==null||w.push(x)});const l=Array.from(d.keys()),p=[...r.filter(x=>l.includes(x))];l.forEach(x=>{p.includes(x)||p.push(x)});const u=p.filter(x=>!i.includes(x)),m=new Map;let g=0,f=0;return u.forEach(x=>{const v=d.get(x)??[],w=xa(e.startedAt,e.endedAt,v);w.intervals.forEach(y=>{m.set(y.stepId,{...y,lane:y.lane+g})}),g+=Math.max(1,w.laneCount)}),f=Math.max(1,g),{intervalsByStepId:m,laneCount:f,visibleGroups:u}}function vo({trace:e,steps:n,selectedStepId:s,onSelectStep:r,playheadPct:i,playheadMs:d,windowRange:l,ghostTrace:p,diff:u,laneStrategy:m="type",laneGroupsOrder:g=[],hiddenLaneGroups:f=[],laneHeight:x=yo,cardHeight:v=go,compactHeight:w=bo}){const{intervalsByStepId:y,laneCount:S}=xo(e,n,m,g,f),N=Array.from(y.values()),D=new Map(N.map(k=>[k.stepId,k])),J=cr(n),I=e.metadata.wallTimeMs||1,$=new Set((u==null?void 0:u.removedSteps)??[]),H=new Set((u==null?void 0:u.changedSteps)??[]),F=new Set(((u==null?void 0:u.changedPairs)??[]).map(k=>k.rightId)),z=new Set((u==null?void 0:u.addedSteps)??[]);let V=N;if(l){const k=l.endMs-l.startMs,E=Math.max(1e3,k*.15),R=Math.max(0,l.startMs-E),U=l.endMs+E;if(V=N.filter(C=>C.endMs>=R&&C.startMs<=U),s&&!V.some(C=>C.stepId===s)){const C=D.get(s);C&&(V=[...V,C])}}const ie=new Set(V.map(k=>k.stepId));return t.jsx("div",{className:"timeline",style:{"--step-card-height":`${v}px`,"--step-compact-height":`${w}px`},children:t.jsxs("div",{className:"timeline-grid",style:{height:`${S*x}px`},"data-help":!0,"data-help-title":"Timeline lanes","data-help-body":"Each lane stacks overlapping steps; width reflects duration.","data-help-placement":"top",children:[t.jsx("div",{className:"playback-cursor",style:{left:`${i}%`}}),J.filter(k=>ie.has(k.id)).filter(k=>!f.includes(Sn(k,m))).map(k=>{const E=D.get(k.id);if(!E)return null;const R=lr(E,d);return t.jsx(or,{step:k,interval:E,playbackState:R,selected:s===k.id,diffStatus:$.has(k.id)?"removed":H.has(k.id)?"changed":null,laneHeight:x,onSelect:r},k.id)}),p?t.jsx(wo,{ghostTrace:p,baseWallTimeMs:I,playheadMs:d,windowRange:l,diffAdded:z,diffChanged:F,laneHeight:x}):null]})})}function wo({ghostTrace:e,baseWallTimeMs:n,playheadMs:s,windowRange:r,diffAdded:i,diffChanged:d,laneHeight:l}){const{intervals:p,laneCount:u}=xa(e.startedAt,e.endedAt,e.steps),m=new Map(p.map(y=>[y.stepId,y])),g=e.metadata.wallTimeMs||1,f=s/n*g;let x=p;if(r){const y=r.endMs-r.startMs,S=Math.max(1e3,y*.15),N=g/n,D=Math.max(0,(r.startMs-S)*N),J=Math.min(g,(r.endMs+S)*N);x=p.filter(I=>I.endMs>=D&&I.startMs<=J)}const v=new Set(x.map(y=>y.stepId)),w=cr(e.steps);return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"ghost-lanes",style:{height:`${u*l}px`}}),w.filter(y=>v.has(y.id)).map(y=>{const S=m.get(y.id);if(!S)return null;const N=lr(S,f),D=i.has(y.id)?"added":d.has(y.id)?"changed":null;return t.jsx(or,{step:y,interval:S,playbackState:N,selected:!1,diffStatus:D,variant:"ghost",disabled:!0,laneHeight:l,onSelect:()=>{}},`ghost-${y.id}`)})]})}function jo({trace:e,steps:n,selectedStepId:s,onSelectStep:r,playheadMs:i,windowRange:d,timing:l,ghostTrace:p,diff:u,laneStrategy:m,laneGroupsOrder:g,hiddenLaneGroups:f,onLaneStrategyChange:x,onToggleLaneGroupVisibility:v,onMoveLaneGroup:w}){const y=e.metadata.wallTimeMs||1,S=Math.min(100,Math.max(0,i/y*100)),N=g.filter(D=>!f.includes(D)).length;return t.jsxs("section",{className:"cinema-mode","aria-label":"Cinema mode",children:[l!=null&&l.degraded?t.jsxs("div",{className:"timing-banner",title:l.issues.join(" "),children:["Timing degraded: ",l.issues[0]??"Check timestamps."]}):null,t.jsxs("div",{className:"timeline-studio-panel","data-help":!0,"data-help-title":"Timeline studio","data-help-body":"Regroup lanes by type/status/parent, hide noisy groups, and reorder emphasis.",children:[t.jsxs("label",{className:"timeline-studio-strategy",children:["Lane strategy",t.jsxs("select",{value:m,onChange:D=>x(D.target.value),children:[t.jsx("option",{value:"type",children:"Type"}),t.jsx("option",{value:"status",children:"Status"}),t.jsx("option",{value:"parent",children:"Parent branch"})]})]}),t.jsxs("div",{className:"timeline-studio-summary",children:[N,"/",g.length," groups visible"]}),t.jsx("div",{className:"timeline-studio-groups",children:g.map((D,J)=>{const I=f.includes(D);return t.jsxs("div",{className:`timeline-studio-group ${I?"is-hidden":""}`,children:[t.jsx("button",{type:"button",className:"ghost-button",onClick:()=>v(D),children:I?"Show":"Hide"}),t.jsx("span",{className:"timeline-studio-group-name",children:D}),t.jsx("button",{type:"button",className:"ghost-button",onClick:()=>w(D,"up"),disabled:J===0,children:"Up"}),t.jsx("button",{type:"button",className:"ghost-button",onClick:()=>w(D,"down"),disabled:J===g.length-1,children:"Down"})]},D)})})]}),t.jsx(vo,{trace:e,steps:n,selectedStepId:s,onSelectStep:r,playheadPct:S,playheadMs:i,windowRange:d,ghostTrace:p,diff:u,laneStrategy:m,laneGroupsOrder:g,hiddenLaneGroups:f})]})}const ko=[.5,1,1.5,2,4];function Is({playheadMs:e,wallTimeMs:n,isPlaying:s,speed:r,onToggle:i,onScrub:d,onSpeedChange:l}){const p=u=>{d(Number(u.target.value))};return t.jsxs("div",{className:"playback-controls",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:i,"aria-label":s?"Pause playback":"Play playback","data-help":!0,"data-help-title":"Playhead","data-help-body":"Start or pause the run to experience timing as it unfolded.","data-help-placement":"bottom",children:s?"Pause":"Play"}),t.jsx("input",{className:"playback-slider",type:"range",min:0,max:n,value:e,"aria-label":"Playback position",onChange:p,"data-help":!0,"data-help-title":"Scrub timeline","data-help-body":"Drag to jump to any moment in the run.","data-help-placement":"bottom"}),t.jsx("select",{className:"playback-speed",value:r,"aria-label":"Playback speed",onChange:u=>l(Number(u.target.value)),"data-help":!0,"data-help-title":"Speed","data-help-body":"Slow down to inspect or speed up to skim.","data-help-placement":"bottom",children:ko.map(u=>t.jsxs("option",{value:u,children:[u,"x"]},u))})]})}function So(e,n,s,r=60){const{wallTimeMs:i,intervals:d}=xa(e,n,s),l=new Array(r).fill(0);if(!i)return{buckets:l,wallTimeMs:0};const p=i/r;return!Number.isFinite(p)||p<=0?{buckets:l,wallTimeMs:i}:(d.forEach(u=>{const m=Math.max(0,Math.floor(u.startMs/p)),g=Math.min(r-1,Math.floor(u.endMs/p));for(let f=m;f<=g;f+=1)l[f]+=1}),{buckets:l,wallTimeMs:i})}function No(e,n){const s=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),r=URL.createObjectURL(s),i=document.createElement("a");i.href=r,i.download=e,document.body.appendChild(i),i.click(),i.remove(),URL.revokeObjectURL(r)}function cn(e,n,s="text/plain"){const r=new Blob([n],{type:s}),i=URL.createObjectURL(r),d=document.createElement("a");d.href=i,d.download=e,document.body.appendChild(d),d.click(),d.remove(),URL.revokeObjectURL(i)}const Bt=5e3,Co=32;function Te(e,n,s){return Math.min(s,Math.max(n,e))}function kt(e,n){const s=new Set;return e.forEach(r=>{s.add(Te(Math.round(r),0,n))}),Array.from(s).sort((r,i)=>r-i).slice(0,Co)}function Mo(e,n){if(!e)return{bookmarksMs:[],clipStartMs:null,clipEndMs:null,segments:[]};try{const s=JSON.parse(e),r=kt(Array.isArray(s.bookmarksMs)?s.bookmarksMs:[],n),i=typeof s.clipStartMs=="number"?Te(s.clipStartMs,0,n):null,d=typeof s.clipEndMs=="number"?Te(s.clipEndMs,0,n):null,l=Array.isArray(s.segments)?s.segments.filter(p=>typeof(p==null?void 0:p.id)=="string"&&typeof(p==null?void 0:p.startMs)=="number"&&typeof(p==null?void 0:p.endMs)=="number"&&typeof(p==null?void 0:p.label)=="string").map(p=>({...p,startMs:Te(p.startMs,0,n),endMs:Te(p.endMs,0,n)})):[];return{bookmarksMs:r,clipStartMs:i,clipEndMs:i!=null&&d!=null&&d<i?i:d,segments:l}}catch{return{bookmarksMs:[],clipStartMs:null,clipEndMs:null,segments:[]}}}function Es(e,n){const s=Date.parse(e);return Number.isNaN(s)?null:new Date(s+n).toISOString()}function Io({traceStart:e,traceEnd:n,steps:s,playheadMs:r,windowRange:i,windowed:d,spanMs:l,onSpanChange:p,onToggleWindowed:u,onScrub:m,persistenceKey:g,laneStrategy:f="type",visibleLaneGroups:x=[],remotePlayheads:v=[]}){const{buckets:w,wallTimeMs:y}=So(e,n,s,64),S=Math.max(1,...w),N=Te(l,Bt,Math.max(Bt,y)),D=(i==null?void 0:i.startMs)??0,J=(i==null?void 0:i.endMs)??y,I=c.useMemo(()=>`agentDirector.timelineStudio.${g??e}`,[g,e]),[$,H]=c.useState([]),[F,z]=c.useState(null),[V,ie]=c.useState(null),[k,E]=c.useState([]),[R,U]=c.useState("");c.useEffect(()=>{const _=Mo(window.localStorage.getItem(I),y);H(_.bookmarksMs),z(_.clipStartMs),ie(_.clipEndMs),E(_.segments)},[I,y]),c.useEffect(()=>{const _={bookmarksMs:kt($,y),clipStartMs:F==null?null:Te(F,0,y),clipEndMs:V==null?null:Te(V,0,y),segments:k};window.localStorage.setItem(I,JSON.stringify(_))},[$,V,F,k,I,y]);const C=y?D/y*100:0,Q=y?(J-D)/y*100:100,T=y?r/y*100:0,q=F!=null&&V!=null?Math.min(F,V):null,P=F!=null&&V!=null?Math.max(F,V):null,he=q!=null&&P!=null&&y?(P-q)/y*100:0,Ie=q!=null&&y?q/y*100:0,fe=q!=null&&P!=null&&P>q,j=_=>{const te=_.currentTarget.getBoundingClientRect(),be=(_.clientX-te.left)/te.width,Se=Te(Math.round(be*y),0,y);m(Se)},ye=_=>{if(_.key==="ArrowLeft"){_.preventDefault(),m(Te(r-Math.max(250,Math.round(y*.02)),0,y));return}if(_.key==="ArrowRight"){_.preventDefault(),m(Te(r+Math.max(250,Math.round(y*.02)),0,y));return}if(_.key==="Home"){_.preventDefault(),m(0);return}if(_.key==="End"){_.preventDefault(),m(y);return}(_.key===" "||_.key==="Enter")&&(_.preventDefault(),m(r))},ce=()=>{H(_=>kt([..._,r],y))},A=_=>{if($.length===0)return;const te=kt($,y);if(_==="previous"){const Se=[...te].reverse().find(St=>St<r)??te[te.length-1];m(Se);return}const be=te.find(Se=>Se>r)??te[0];m(be)},Y=()=>{const _=Te(r,0,y);z(_),V!=null&&V<_&&ie(_)},ke=()=>{const _=Te(r,0,y);ie(_),F!=null&&F>_&&z(_)},dt=()=>{z(null),ie(null)},De=()=>{if(!fe||q==null||P==null)return;const _=R.trim()||`Scene ${k.length+1}`,te=`segment-${Math.random().toString(36).slice(2,9)}`;E(be=>[...be,{id:te,startMs:q,endMs:P,label:_}]),U("")},Le=_=>{E(te=>te.filter(be=>be.id!==_))},$e=()=>{if(!fe||q==null||P==null)return;const _={type:"agent-director-clip",traceStart:e,traceEnd:n,clip:{startMs:q,endMs:P,startAt:Es(e,q),endAt:Es(e,P)},bookmarksMs:kt($,y).filter(te=>te>=q&&te<=P),playheadMs:r,laneContext:{strategy:f,visibleGroups:x},segments:k.filter(te=>te.endMs>=q&&te.startMs<=P),exportedAt:new Date().toISOString()};No(`agent-director-clip-${q}-${P}.json`,_)};return t.jsxs("div",{className:"mini-timeline",children:[t.jsxs("div",{className:"mini-track",onClick:j,role:"slider",tabIndex:0,"aria-label":"Timeline density map","aria-valuemin":0,"aria-valuemax":y,"aria-valuenow":r,"aria-valuetext":`${r} milliseconds`,onKeyDown:ye,"data-help":!0,"data-help-title":"Density map","data-help-body":"A compact view of activity density. Click to jump the playhead.","data-help-placement":"top",children:[t.jsx("div",{className:"mini-bars",children:w.map((_,te)=>t.jsx("span",{className:"mini-bar",style:{height:`${_/S*100}%`}},`bucket-${te}`))}),t.jsx("div",{className:"mini-window",style:{left:`${C}%`,width:`${Q}%`,opacity:d?1:.4}}),fe?t.jsx("div",{className:"mini-clip-window",style:{left:`${Ie}%`,width:`${he}%`}}):null,t.jsx("div",{className:"mini-bookmark-markers","data-testid":"timeline-bookmark-markers","aria-hidden":"true",children:kt($,y).map(_=>{const te=y?_/y*100:0;return t.jsx("button",{type:"button",className:"mini-bookmark-marker",style:{left:`${te}%`},onClick:be=>{be.stopPropagation(),m(_)},title:`Jump to bookmark at ${_}ms`,"aria-label":`Bookmark ${_} milliseconds`},`bookmark-${_}`)})}),t.jsx("div",{className:"mini-remote-markers","aria-hidden":"true",children:v.map((_,te)=>{const be=y?_/y*100:0;return t.jsx("span",{className:"mini-remote-marker",style:{left:`${be}%`}},`remote-${te}`)})}),t.jsx("div",{className:"mini-segments","aria-hidden":"true",children:k.map(_=>{const te=y?_.startMs/y*100:0,be=y?(_.endMs-_.startMs)/y*100:0;return t.jsx("span",{className:"mini-segment-bar",style:{left:`${te}%`,width:`${Math.max(1,be)}%`},title:_.label},_.id)})}),t.jsx("div",{className:"mini-playhead",style:{left:`${T}%`}})]}),t.jsxs("div",{className:"mini-controls",children:[t.jsx("label",{className:"mini-label",children:"Zoom"}),t.jsx("input",{type:"range",min:Bt,max:Math.max(Bt,y),value:N,"aria-label":"Timeline zoom",onChange:_=>{u(!0),p(Number(_.target.value))},"data-help":!0,"data-help-title":"Zoom window","data-help-body":"Tighten the window to focus on hotspots.","data-help-placement":"top"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>u(!d),title:"Toggle windowed playback",children:d?"Full":"Window"}),t.jsx("button",{className:"ghost-button",type:"button",title:"Reset zoom",onClick:()=>{u(!0),p(Math.min(Math.max(y*.2,Bt),6e4))},children:"Reset"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:ce,children:"Add bookmark"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>A("previous"),children:"Previous bookmark"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>A("next"),children:"Next bookmark"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:Y,children:"Set clip start"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:ke,children:"Set clip end"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:dt,children:"Clear clip"}),t.jsx("input",{className:"search-input mini-segment-input",placeholder:"Segment label",value:R,onChange:_=>U(_.target.value),"aria-label":"Segment label"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:De,disabled:!fe,children:"Add segment"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:$e,disabled:!fe,children:"Export clip"})]}),k.length?t.jsx("div",{className:"mini-segment-list",children:k.map(_=>t.jsxs("div",{className:"mini-segment-item",children:[t.jsxs("span",{children:[_.label," (",_.startMs,"ms - ",_.endMs,"ms)"]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Le(_.id),children:"Remove"})]},_.id))}):null]})}const Ut=[{id:"toggleStory",label:"Story mode",defaultKey:"s"},{id:"toggleExplain",label:"Explain mode",defaultKey:"e"},{id:"startTour",label:"Start guided tour",defaultKey:"t"},{id:"toggleFlow",label:"Toggle Flow mode",defaultKey:"f"},{id:"toggleCinema",label:"Switch to Cinema mode",defaultKey:"c"},{id:"toggleGameplay",label:"Switch to Gameplay mode",defaultKey:"g"},{id:"toggleInspector",label:"Toggle inspector",defaultKey:"i"}],Nn="abcdefghijklmnopqrstuvwxyz".split(""),Eo=Ut.reduce((e,n)=>(e[n.id]=n.defaultKey,e),{}),_o={...Eo};function dr(e,n){const s=String(e??"").trim().toLowerCase();return Nn.includes(s)?s:n}function To(e){return Nn.find(s=>!e.has(s))??"z"}function xn(e){const n={},s=new Set;for(const r of Ut){const i=dr(e==null?void 0:e[r.id],r.defaultKey),d=s.has(i)?To(s):i;n[r.id]=d,s.add(d)}return n}function Ao(e,n,s){const r=xn(e),i=dr(s,r[n]);if(r[n]===i)return r;const d={...r,[n]:i},l=Ut.find(p=>p.id!==n&&d[p.id]===i);return l&&(d[l.id]=r[n]),xn(d)}function Do(e){return e.trim().toUpperCase()}function $o({open:e,onClose:n,bindings:s}){const r=c.useRef(null),i=[{keys:"Space",action:"Play / pause"},{keys:"← / →",action:"Step boundary back / forward"},{keys:"Shift + ← / →",action:"Jump to start / end"},...Ut.map(l=>({keys:Do(s[l.id]),action:l.label})),{keys:"Cmd/Ctrl + K",action:"Open command palette"},{keys:"?",action:"Show shortcuts"},{keys:"Esc",action:"Close modal / inspector"}];if(c.useEffect(()=>{var l;e&&((l=r.current)==null||l.focus())},[e]),!e)return null;const d=l=>{var g;if(l.key==="Escape"){l.preventDefault(),n();return}if(l.key!=="Tab")return;const p=Array.from(l.currentTarget.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'));if(p.length===0)return;const u=p.indexOf(document.activeElement),m=l.shiftKey?u<=0?p.length-1:u-1:(u+1)%p.length;(g=p[m])==null||g.focus(),l.preventDefault()};return t.jsx("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true","aria-labelledby":"shortcuts-title",onKeyDown:d,children:t.jsxs("div",{className:"modal",tabIndex:-1,children:[t.jsxs("div",{className:"modal-header",children:[t.jsx("div",{className:"modal-title",id:"shortcuts-title",children:"Keyboard Shortcuts"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:n,ref:r,"aria-label":"Close shortcuts",children:"Close"})]}),t.jsx("div",{className:"modal-body",children:i.map(l=>t.jsxs("div",{className:"modal-row",children:[t.jsx("span",{className:"modal-keys",children:l.keys}),t.jsx("span",{className:"modal-action",children:l.action})]},l.keys))})]})})}const _s="agentDirector.palette.recent.v1",Ts="agentDirector.palette.pinned.v1",Ro=8,Oo=12,ur=e=>e.trim().toLowerCase(),dn=(e,n)=>{if(!n)return 0;const s=ur(e);return s?s===n?30:s.startsWith(n)?18:s.includes(n)?8:0:0};function As(e){try{const n=JSON.parse(window.localStorage.getItem(e)??"[]");return Array.isArray(n)?n.filter(s=>typeof s=="string"):[]}catch{return[]}}function Ds(e,n){window.localStorage.setItem(e,JSON.stringify(n))}function Po(e){const n=new Map;return e.forEach(s=>{var i;const r=s.section;n.has(r)||n.set(r,[]),(i=n.get(r))==null||i.push(s)}),n}function $s(e,n,s){var i;if(!e.length)return 0;let r=n;for(let d=0;d<e.length;d+=1)if(r=(r+s+e.length)%e.length,!((i=e[r])!=null&&i.disabled))return r;return n}function Lo({open:e,onClose:n,actions:s,context:r,onActionRun:i}){var V,ie;const[d,l]=c.useState(""),[p,u]=c.useState(0),[m,g]=c.useState([]),[f,x]=c.useState([]),v=c.useRef(null),w=c.useRef(null),y=c.useMemo(()=>{const k=ur(d),E=new Set(m),R=new Set(f);return s.map((C,Q)=>{var P;const T=[C.label,C.description,C.group,C.keys,...C.keywords??[]].filter(Boolean).join(" ").toLowerCase();if(k&&!T.includes(k))return null;let q=C.priority??0;return q+=dn(C.label,k),q+=dn(C.group??"",k),(C.keywords??[]).forEach(he=>{q+=dn(he,k)}),E.has(C.id)&&(q+=6),R.has(C.id)&&(q+=12),r!=null&&r.section&&((P=C.group)==null?void 0:P.toLowerCase())===r.section.toLowerCase()&&(q+=8),r!=null&&r.mode&&C.id.includes(`mode-${r.mode}`)&&(q+=8),{action:C,score:q,index:Q}}).filter(C=>!!C).sort((C,Q)=>Q.score===C.score?C.index-Q.index:Q.score-C.score).map(C=>C.action)},[s,r==null?void 0:r.mode,r==null?void 0:r.section,f,d,m]),S=c.useMemo(()=>{const k=new Map(y.map(C=>[C.id,C])),E=f.map(C=>k.get(C)).filter(C=>!!C).map(C=>({...C,section:"Pinned"})),R=m.map(C=>k.get(C)).filter(C=>!!C).filter(C=>!E.some(Q=>Q.id===C.id)).map(C=>({...C,section:"Recent"})),U=y.filter(C=>!E.some(Q=>Q.id===C.id)).filter(C=>!R.some(Q=>Q.id===C.id)).map(C=>({...C,section:C.group??"General"}));if(!d.trim()&&r){const C=U.slice(0,4).map(Q=>({...Q,id:`recommended-${Q.id}`,label:`Recommended: ${Q.label}`,section:"Recommended"}));return[...E,...R,...C,...U]}return[...E,...R,...U]},[r,y,f,m,d]),N=c.useMemo(()=>Po(S),[S]),D=c.useMemo(()=>s.filter(k=>(k.group??"").toLowerCase()==="macros"||k.id.startsWith("macro-")),[s]);if(c.useEffect(()=>{if(!e)return;l(""),u(0),g(As(_s)),x(As(Ts));const k=window.setTimeout(()=>{var E;return(E=v.current)==null?void 0:E.focus()},0);return()=>window.clearTimeout(k)},[e]),c.useEffect(()=>{p>=S.length&&u(0)},[p,S.length]),!e)return null;const J=k=>{g(E=>{const R=[k,...E.filter(U=>U!==k)].slice(0,Ro);return Ds(_s,R),R})},I=k=>{k.disabled||(J(k.id),i==null||i(k),k.onTrigger(),n())},$=k=>{x(E=>{const R=E.includes(k)?E.filter(U=>U!==k):[k,...E].slice(0,Oo);return Ds(Ts,R),R})},H=k=>{var E,R;if(k.key==="Escape"){k.preventDefault(),n();return}if(k.key==="ArrowDown"){k.preventDefault(),u(U=>$s(S,U,1));return}if(k.key==="ArrowUp"){k.preventDefault(),u(U=>$s(S,U,-1));return}if(k.key==="Enter"){k.preventDefault();const U=S[p];U&&I(U);return}if(k.key==="Tab"){const U=Array.from(((E=w.current)==null?void 0:E.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'))??[]);if(!U.length)return;const C=U.indexOf(document.activeElement),Q=k.shiftKey?C<=0?U.length-1:C-1:(C+1)%U.length;(R=U[Q])==null||R.focus(),k.preventDefault()}},F=(V=S[p])!=null&&V.id?`palette-option-${(ie=S[p])==null?void 0:ie.id}`:void 0;let z=-1;return t.jsx("div",{className:"modal-backdrop palette-backdrop",role:"dialog","aria-modal":"true","aria-label":"Command palette",onKeyDown:H,onMouseDown:k=>{k.target===k.currentTarget&&n()},children:t.jsxs("div",{className:"palette",ref:w,children:[t.jsxs("div",{className:"palette-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"palette-title",children:"Command palette"}),t.jsx("div",{className:"palette-subtitle",children:"Search actions, modes, and playbook steps."})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:n,"aria-label":"Close command palette",children:"Close"})]}),t.jsx("input",{ref:v,className:"palette-input",value:d,onChange:k=>l(k.target.value),placeholder:"Type to filter actions…","aria-label":"Search commands",role:"combobox","aria-expanded":"true","aria-controls":"command-palette-list","aria-activedescendant":F,"aria-autocomplete":"list"}),!d.trim()&&D.length>0?t.jsxs("div",{className:"palette-macros",children:[t.jsx("div",{className:"palette-group-title",children:"Quick macros"}),t.jsx("div",{className:"palette-macro-list",children:D.slice(0,3).map(k=>t.jsx("button",{className:"ghost-button palette-macro-item",type:"button",onClick:()=>I(k),children:k.label},k.id))})]}):null,t.jsxs("div",{className:"palette-list",role:"listbox",id:"command-palette-list",children:[S.length===0?t.jsx("div",{className:"palette-empty",children:"No matching commands."}):null,Array.from(N.entries()).map(([k,E])=>t.jsxs("div",{className:"palette-group",children:[t.jsx("div",{className:"palette-group-title",children:k}),t.jsx("div",{className:"palette-group-list",children:E.map(R=>{z+=1;const U=z===p,C=f.includes(R.id);return t.jsxs("button",{id:`palette-option-${R.id}`,className:`palette-item ${U?"active":""}`,type:"button",role:"option","aria-selected":U,onMouseEnter:()=>u(z),onClick:()=>I(R),disabled:R.disabled,children:[t.jsxs("div",{className:"palette-item-main",children:[t.jsx("div",{className:"palette-item-title",children:R.label}),R.description?t.jsx("div",{className:"palette-item-description",children:R.description}):null]}),t.jsxs("div",{className:"palette-item-trailing",children:[R.keys?t.jsx("div",{className:"palette-item-keys",children:R.keys}):null,t.jsx("span",{className:`palette-pin ${C?"active":""}`,role:"button",tabIndex:0,onClick:Q=>{Q.stopPropagation(),$(R.id)},onKeyDown:Q=>{Q.key!=="Enter"&&Q.key!==" "||(Q.preventDefault(),Q.stopPropagation(),$(R.id))},"aria-label":C?`Unpin ${R.label}`:`Pin ${R.label}`,title:C?"Unpin command":"Pin command",children:C?"★":"☆"})]})]},R.id)})})]},k))]})]})})}function Fo(e){return e.length?e.reduce((n,s)=>(s.durationMs??0)>(n.durationMs??0)?s:n,e[0]):null}function qo({trace:e,mode:n,playheadMs:s,selectedStepId:r,compareTrace:i,collapsed:d,onToggleCollapsed:l,onModeChange:p,onSelectStep:u,onJumpToBottleneck:m,onReplay:g,onStartTour:f,priorityQueue:x=[]}){var k;const v=e.steps??[],w=Fo(v),y=r??(w==null?void 0:w.id)??((k=v[0])==null?void 0:k.id)??null,S=n==="cinema"||s>0,N=!!r,D=!!i,J=[S,N,D].filter(Boolean).length,I=[S,N,D].findIndex(E=>!E),$=I===-1?2:I,H=[0,1,2].map(E=>[S,N,D][E]?"done":E===$?"active":"next"),F=[{id:"observe",title:"Act I: Observe",summary:"Scrub the timeline to feel the pacing, bottlenecks, and tool choreography.",status:H[0],actionLabel:"Enter cinema",action:()=>p("cinema"),tasks:[{label:"Scrub the timeline",done:s>0},{label:"Stay in Cinema mode",done:n==="cinema"}]},{id:"inspect",title:"Act II: Inspect",summary:"Open the most expensive or failed step and read the payload with context.",status:H[1],actionLabel:w?"Jump to bottleneck":"Select first step",action:()=>{if(r){p("cinema");return}if(w){m();return}y&&(u(y),p("cinema"))},disabled:!y,tasks:[{label:"Open the Inspector",done:!!r},{label:"Jump to the bottleneck",done:!!(w&&r===w.id)}]},{id:"direct",title:"Act III: Direct",summary:"Replay from a decisive step, then compare flows and diffs side-by-side.",status:H[2],actionLabel:i?"Open compare":"Replay from step",action:()=>{if(i){p("compare");return}y&&g(y)},disabled:!y,tasks:[{label:"Replay from a step",done:!!i},{label:"Compare runs side-by-side",done:!!(i&&n==="compare")}]}],z=F[$],ie=x.filter(E=>!E.done)[0];return d?t.jsxs("section",{className:"journey-panel journey-collapsed","aria-label":"Director journey","data-help":!0,"data-help-indicator":!0,"data-tour":"journey","data-help-title":"Director journey","data-help-body":"A guided path from observation to replay. Use it to show newcomers what to do first.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"journey-collapsed-main",children:[t.jsx("div",{className:"journey-eyebrow",children:"Director journey"}),t.jsx("div",{className:"journey-collapsed-title",children:"From observe to direct"})]}),t.jsxs("div",{className:"journey-collapsed-actions",children:[t.jsxs("span",{className:"journey-progress-text",children:[J,"/3 complete"]}),ie?t.jsxs("span",{className:`journey-priority-chip severity-${ie.severity}`,children:["Next priority: ",ie.title]}):null,z?t.jsxs("button",{className:"primary-button journey-next",type:"button",onClick:z.action,disabled:z.disabled,children:["Next: ",z.actionLabel]}):null,f?t.jsx("button",{className:"ghost-button",type:"button",onClick:f,children:"Tour"}):null,t.jsx("button",{className:"primary-button journey-expand",type:"button",onClick:l,children:"Expand"})]})]}):t.jsxs("section",{className:"journey-panel","aria-label":"Director journey","data-help":!0,"data-help-indicator":!0,"data-tour":"journey","data-help-title":"Director journey","data-help-body":"A three-act flow that teaches the story: observe, inspect, direct. Each act jumps to the right place.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"journey-head",children:[t.jsxs("div",{children:[t.jsx("div",{className:"journey-eyebrow",children:"Director journey"}),t.jsx("h2",{className:"journey-title",children:"Cut a perfect take in three acts."}),t.jsx("p",{className:"journey-subtitle",children:"Trace the performance, interrogate the moment, then direct a better run."})]}),t.jsxs("div",{className:"journey-head-actions",children:[f?t.jsx("button",{className:"ghost-button",type:"button",onClick:f,children:"Start tour"}):null,t.jsx("button",{className:"ghost-button",type:"button",onClick:l,children:"Collapse"})]})]}),t.jsx("div",{className:"journey-track",children:F.map((E,R)=>{var U;return t.jsxs("div",{className:"journey-card","data-status":E.status,children:[t.jsxs("div",{className:"journey-card-top",children:[t.jsxs("span",{className:"journey-index",children:["0",R+1]}),t.jsx("span",{className:"journey-status",children:E.status})]}),t.jsx("h3",{className:"journey-card-title",children:E.title}),t.jsx("p",{className:"journey-card-body",children:E.summary}),(U=E.tasks)!=null&&U.length?t.jsx("ul",{className:"journey-tasks",children:E.tasks.map(C=>t.jsxs("li",{className:`journey-task ${C.done?"done":""}`,children:[t.jsx("span",{className:"journey-task-icon","aria-hidden":"true",children:C.done?"✓":"○"}),t.jsx("span",{children:C.label})]},C.label))}):null,t.jsx("button",{className:"primary-button journey-action",type:"button",onClick:E.action,disabled:E.disabled,children:E.actionLabel})]},E.id)})}),t.jsxs("div",{className:"journey-footer",children:[t.jsxs("div",{children:[t.jsx("div",{className:"journey-progress-label",children:"Progress"}),t.jsx("div",{className:"journey-progress",children:t.jsx("span",{className:"journey-progress-bar",style:{width:`${J/3*100}%`}})})]}),t.jsx("div",{className:"journey-footnote",children:"Tip: Use Flow to spot fan-out, Compare to validate your changes."})]}),x.length?t.jsxs("div",{className:"journey-priority-queue",children:[t.jsxs("div",{className:"journey-priority-head",children:[t.jsx("div",{className:"journey-progress-label",children:"Priority queue"}),t.jsxs("span",{children:[x.filter(E=>E.done).length,"/",x.length," resolved"]})]}),t.jsx("div",{className:"journey-priority-list",children:x.map(E=>t.jsxs("article",{className:`journey-priority-item ${E.done?"done":""}`,children:[t.jsxs("div",{className:"journey-priority-main",children:[t.jsx("span",{className:`journey-priority-chip severity-${E.severity}`,children:E.severity}),t.jsxs("div",{children:[t.jsx("div",{className:"journey-priority-title",children:E.title}),t.jsx("div",{className:"journey-priority-body",children:E.detail})]})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:E.onAction,disabled:E.done,children:E.done?"Resolved":E.actionLabel})]},E.id))})]}):null]})}const Go=[],zo=[],Bo=[],Ho={};function Uo(e){return e.length?e.reduce((n,s)=>(s.durationMs??0)>(n.durationMs??0)?s:n,e[0]):null}function Wo({trace:e,mode:n,selectedStepId:s,onModeChange:r,onSelectStep:i,onJumpToBottleneck:d,onReplay:l,recommendations:p=Go,persona:u="builder",annotations:m=zo,activityFeed:g=Bo,onAddAnnotation:f,missionProgress:x=Ho,missionCompletion:v,onResetMissions:w,narrative:y="",onAskDirector:S,onExportNarrative:N}){var ce;const D=e.steps??[],J=Uo(D),I=s??(J==null?void 0:J.id)??((ce=D[0])==null?void 0:ce.id)??null,$=e.metadata.wallTimeMs??0,H=u==="executive"?"Executive lens":u==="operator"?"Operator lens":"Builder lens",[F,z]=c.useState(""),[V,ie]=c.useState(""),[k,E]=c.useState(""),[R,U]=c.useState("overview"),[C,Q]=c.useState([]),T=c.useMemo(()=>g.slice(0,6),[g]),q=(v==null?void 0:v.done)??0,P=q>=3||!!x.inspect,he=q>=5||!!x.collaborate||T.length>0,Ie=c.useMemo(()=>p.slice(0,3).map((A,Y)=>({id:A.id,step:`${Y+1}. ${A.actionLabel} — ${A.title}`})),[p]);c.useEffect(()=>{Q(A=>A.filter(Y=>p.some(ke=>ke.id===Y)))},[p]);const fe=C.filter(A=>p.some(Y=>Y.id===A)).length,j=p.length?Math.round(fe/p.length*100):0,ye=A=>{A.action(),Q(Y=>Y.includes(A.id)?Y:[...Y,A.id])};return t.jsxs("aside",{className:"inspector inspector-empty","data-help":!0,"data-help-indicator":!0,"data-tour":"inspector","data-help-title":"Inspector panel","data-help-body":"Select a step to open detailed payloads, redaction controls, and replay actions.","data-help-placement":"left",children:[t.jsx("div",{className:"inspector-header",children:t.jsxs("div",{children:[t.jsx("div",{className:"inspector-title",children:"Director's notes"}),t.jsxs("div",{className:"inspector-subtitle",children:[H,". Select a step to open deep inspection."]})]})}),t.jsxs("div",{className:"director-tabs",role:"tablist","aria-label":"Director workspace tabs",children:[t.jsx("button",{className:`ghost-button ${R==="overview"?"active":""}`,type:"button",role:"tab","aria-selected":R==="overview",onClick:()=>U("overview"),children:"Overview"}),t.jsx("button",{className:`ghost-button ${R==="narrative"?"active":""}`,type:"button",role:"tab","aria-selected":R==="narrative",onClick:()=>U("narrative"),children:"Narrative"}),t.jsx("button",{className:`ghost-button ${R==="collab"?"active":""}`,type:"button",role:"tab","aria-selected":R==="collab",onClick:()=>U("collab"),children:"Collaboration"})]}),R==="overview"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Run summary"}),t.jsxs("div",{className:"inspector-row",children:[t.jsx("span",{children:"Steps"}),t.jsx("span",{children:D.length})]}),t.jsxs("div",{className:"inspector-row",children:[t.jsx("span",{children:"Wall time"}),t.jsxs("span",{children:[$,"ms"]})]}),t.jsxs("div",{className:"inspector-row",children:[t.jsx("span",{children:"Status"}),t.jsx("span",{children:e.status})]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Next actions"}),t.jsxs("div",{className:"director-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>r("cinema"),"data-help":!0,"data-help-title":"Open cinema","data-help-body":"Jump straight into the timeline.","data-help-placement":"right",children:"Open cinema"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>r("flow"),"data-help":!0,"data-help-title":"Open flow","data-help-body":"See the dependency graph of the run.","data-help-placement":"right",children:"Switch to flow"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{if(!s){if(J){d();return}I&&i(I)}},disabled:!I||!!s,"data-help":!0,"data-help-title":"Jump to bottleneck","data-help-body":"Select the slowest step for inspection.","data-help-placement":"right",children:s?"Inspector open":J?"Jump to bottleneck":"Select first step"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>I&&l(I),disabled:!I||!P,title:P?void 0:"Complete core missions to unlock replay guidance.","data-help":!0,"data-help-title":"Replay","data-help-body":"Branch a replay from a decisive step.","data-help-placement":"right",children:"Replay from step"})]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Mode"}),t.jsxs("div",{className:"director-modes",children:[t.jsx("button",{className:`ghost-button ${n==="cinema"?"active":""}`,type:"button",onClick:()=>r("cinema"),"data-help":!0,"data-help-title":"Cinema mode","data-help-body":"Timeline view for pacing and sequence.","data-help-placement":"right",children:"Cinema"}),t.jsx("button",{className:`ghost-button ${n==="flow"?"active":""}`,type:"button",onClick:()=>r("flow"),"data-help":!0,"data-help-title":"Flow mode","data-help-body":"Graph view for dependencies.","data-help-placement":"right",children:"Flow"}),t.jsx("button",{className:"ghost-button",type:"button",disabled:!0,children:"Compare"})]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Adaptive missions"}),t.jsxs("div",{className:"mission-summary",children:[(v==null?void 0:v.done)??0,"/",(v==null?void 0:v.total)??0," complete",t.jsxs("span",{children:[(v==null?void 0:v.pct)??0,"%"]})]}),t.jsxs("div",{className:"mission-stage",children:["Stage: ",he?"Collaboration":P?"Analysis":"Foundation"]}),t.jsx("div",{className:"mission-grid",children:Object.entries(x).map(([A,Y])=>t.jsxs("div",{className:`mission-chip ${Y?"done":""}`,children:[t.jsx("span",{children:A}),t.jsx("span",{children:Y?"Done":"Pending"})]},A))}),t.jsx("button",{className:"ghost-button",type:"button",onClick:w,children:"Reset missions"})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Action plan"}),P?p.length===0?t.jsx("div",{className:"annotation-empty",children:"No recommendations generated yet."}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"mission-summary",children:[fe,"/",p.length," complete",t.jsxs("span",{children:[j,"%"]})]}),t.jsx("div",{className:"director-recommendations",children:p.map(A=>{const Y=C.includes(A.id);return t.jsxs("article",{className:`director-recommendation tone-${A.tone} ${Y?"done":""}`,children:[t.jsx("div",{className:"director-recommendation-title",children:A.title}),t.jsx("p",{className:"director-recommendation-body",children:A.body}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>ye(A),children:Y?"Completed":A.actionLabel})]},A.id)})})]}):t.jsx("div",{className:"annotation-empty",children:"Complete inspect/flow/replay missions to unlock AI narrative tools."}),he?null:t.jsx("div",{className:"annotation-empty",children:"Open another live session to unlock collaboration activity feed."})]})]}):null,R==="narrative"?t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"AI director narrative"}),P?t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"director-recommendation-body",children:y}),Ie.length?t.jsx("div",{className:"director-guided-plan",children:Ie.map(A=>t.jsx("div",{children:A.step},A.id))}):null,t.jsxs("div",{className:"director-ask-row",children:[t.jsx("input",{className:"search-input",value:V,onChange:A=>ie(A.target.value),placeholder:"Ask Director (e.g. what is highest risk?)","aria-label":"Ask director question"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{V.trim()&&E((S==null?void 0:S(V))??"")},children:"Ask"})]}),k?t.jsx("div",{className:"director-answer",children:k}):null,t.jsx("button",{className:"ghost-button",type:"button",onClick:N,children:"Export narrative"})]}):t.jsx("div",{className:"annotation-empty",children:"Complete inspect/flow/replay missions to unlock AI narrative tools."})]}):null,R==="collab"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Shared annotations"}),t.jsx("textarea",{value:F,onChange:A=>z(A.target.value),rows:3,placeholder:s?"Add note for selected step...":"Add trace-level note...","aria-label":"Shared annotation"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{const A=F.trim();A&&(f==null||f(A,s),z(""))},children:"Add annotation"}),t.jsxs("div",{className:"annotation-list",children:[m.slice(-6).reverse().map(A=>t.jsxs("article",{className:"annotation-item",children:[t.jsxs("div",{className:"annotation-meta",children:[t.jsx("span",{children:A.stepId?`step ${A.stepId}`:"trace"}),t.jsx("span",{children:A.authorSessionId})]}),t.jsx("p",{children:A.body})]},A.id)),m.length===0?t.jsx("div",{className:"annotation-empty",children:"No shared annotations yet."}):null]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Collab activity"}),he?t.jsxs("div",{className:"activity-list",children:[T.map(A=>t.jsxs("div",{className:"activity-item",children:[t.jsx("span",{children:A.message}),t.jsx("span",{children:new Date(A.timestamp).toLocaleTimeString()})]},A.id)),T.length===0?t.jsx("div",{className:"annotation-empty",children:"No activity yet."}):null]}):t.jsx("div",{className:"annotation-empty",children:"Open another live session to unlock collaboration activity feed."})]})]}):null]})}const un=(e,n,s)=>Math.min(s,Math.max(n,e));function pn(e){return Array.from((e==null?void 0:e.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'))??[]).filter(s=>!(s.hasAttribute("disabled")||s.getAttribute("aria-hidden")==="true"))}function Jo({steps:e,open:n,onClose:s,onComplete:r}){const[i,d]=c.useState(0),[l,p]=c.useState(null),[u,m]=c.useState(null),g=c.useRef(null),f=c.useRef(null),x=c.useRef(null),v=c.useMemo(()=>e[i],[e,i]),w=c.useCallback(()=>{if(!n)return;const I=document.querySelector(v.target);if(!I){f.current=null,p(null);return}f.current=I;const $=I.getBoundingClientRect();p($)},[n,v.target]),y=c.useCallback(()=>{if(!l||!g.current){m(null);return}const I=g.current.offsetWidth,$=g.current.offsetHeight,H=16;let F=un(l.left+l.width/2-I/2,H,window.innerWidth-I-H),z=l.bottom+16;v.placement==="top"&&(z=l.top-$-16),v.placement==="left"&&(F=l.left-I-16,z=l.top+l.height/2-$/2),v.placement==="right"&&(F=l.right+16,z=l.top+l.height/2-$/2),z+$>window.innerHeight-H&&(z=l.top-$-16),z<H&&(z=l.bottom+16),F=un(F,H,window.innerWidth-I-H),z=un(z,H,window.innerHeight-$-H),m({top:z,left:F})},[v.placement,l]);if(c.useEffect(()=>{n&&d(0)},[n]),c.useEffect(()=>{var $,H;if(!n){(H=($=x.current)==null?void 0:$.focus)==null||H.call($);return}x.current=document.activeElement;const I=window.setTimeout(()=>{var z;(z=pn(g.current)[0]??g.current)==null||z.focus()},0);return()=>window.clearTimeout(I)},[n]),c.useEffect(()=>{if(!n)return;const I=document.querySelector(v.target);I&&I.scrollIntoView({behavior:"smooth",block:"center",inline:"center"});const $=window.requestAnimationFrame(()=>w());return()=>window.cancelAnimationFrame($)},[n,v.target,w]),c.useLayoutEffect(()=>{y()},[l,y,v.title]),c.useEffect(()=>{if(!n)return;const I=()=>{w(),y()};return window.addEventListener("resize",I),window.addEventListener("scroll",I,!0),()=>{window.removeEventListener("resize",I),window.removeEventListener("scroll",I,!0)}},[n,w,y]),c.useEffect(()=>{if(!n)return;const I=$=>{var ie;if($.key==="Escape"){$.preventDefault(),s();return}if($.key!=="Tab")return;const H=pn(g.current);if(!H.length)return;const F=document.activeElement,z=H.indexOf(F),V=$.shiftKey?z<=0?H.length-1:z-1:(z+1)%H.length;(ie=H[V])==null||ie.focus(),$.preventDefault()};return document.addEventListener("keydown",I,!0),()=>document.removeEventListener("keydown",I,!0)},[s,n]),!n||!v)return null;const S=I=>{var V;if(I.key==="Escape"){I.preventDefault(),s();return}if(I.key!=="Tab")return;const $=pn(g.current);if($.length===0)return;const H=document.activeElement,F=$.indexOf(H),z=I.shiftKey?F<=0?$.length-1:F-1:(F+1)%$.length;(V=$[z])==null||V.focus(),I.preventDefault()},N=`tour-title-${v.id}`,D=`tour-body-${v.id}`,J=l?{top:l.top-6,left:l.left-6,width:l.width+12,height:l.height+12}:void 0;return t.jsxs("div",{className:"tour-overlay",role:"dialog","aria-modal":"true","aria-label":"Guided tour","aria-labelledby":N,"aria-describedby":D,onKeyDown:S,children:[t.jsx("div",{className:"tour-backdrop",onClick:s}),l?t.jsx("div",{className:"tour-spotlight",style:J}):null,t.jsxs("div",{className:`tour-card ${u?"tour-card-anchored":""}`,ref:g,style:u??void 0,tabIndex:-1,children:[t.jsxs("div",{className:"tour-step",children:["Step ",i+1," of ",e.length]}),t.jsx("div",{className:"tour-title",id:N,children:v.title}),t.jsx("p",{className:"tour-body",id:D,children:v.body}),t.jsxs("div",{className:"tour-actions",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>d(I=>Math.max(0,I-1)),disabled:i===0,children:"Back"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:s,children:"Skip"}),i===e.length-1?t.jsx("button",{className:"primary-button",type:"button",onClick:r,children:"Finish tour"}):t.jsx("button",{className:"primary-button",type:"button",onClick:()=>d(I=>I+1),children:"Next"})]})]})]})}const Rs=(e,n,s)=>Math.min(s,Math.max(n,e));function Vo({enabled:e}){const[n,s]=c.useState(null),[r,i]=c.useState(null),d=c.useRef(null),l=c.useRef(null),p=c.useCallback(()=>{const m=d.current;if(!m){s(null);return}const g=m.getBoundingClientRect(),f=m.dataset.helpTitle??"Context",x=m.dataset.helpBody??"",v=m.dataset.helpPlacement??"right";s({rect:g,title:f,body:x,placement:v})},[]);c.useEffect(()=>{if(!e){d.current=null,s(null);return}const m=w=>{var S,N;const y=(N=(S=w.target)==null?void 0:S.closest)==null?void 0:N.call(S,"[data-help]");if(!y){d.current||s(null);return}d.current!==y&&(d.current=y,p())},g=w=>{var S,N;const y=(N=(S=w.target)==null?void 0:S.closest)==null?void 0:N.call(S,"[data-help]");y&&(d.current=y,p())},f=w=>{var S;const y=w.relatedTarget;(S=y==null?void 0:y.closest)!=null&&S.call(y,"[data-help]")||(d.current=null,s(null))},x=w=>{var S,N;const y=(N=(S=w.target)==null?void 0:S.closest)==null?void 0:N.call(S,"[data-help]");if(!y){d.current=null,s(null);return}d.current=y,p()},v=()=>{d.current&&p()};return window.addEventListener("mousemove",m),window.addEventListener("focusin",g),window.addEventListener("focusout",f),window.addEventListener("pointerdown",x),window.addEventListener("scroll",v,!0),window.addEventListener("resize",v),()=>{window.removeEventListener("mousemove",m),window.removeEventListener("focusin",g),window.removeEventListener("focusout",f),window.removeEventListener("pointerdown",x),window.removeEventListener("scroll",v,!0),window.removeEventListener("resize",v)}},[e,p]);const u=c.useCallback(()=>{if(!n||!l.current){i(null);return}const m=12,g=l.current.offsetWidth,f=l.current.offsetHeight,{rect:x,placement:v}=n;let w=x.right+16,y=x.top+x.height/2-f/2;v==="left"&&(w=x.left-g-16,y=x.top+x.height/2-f/2),v==="top"&&(w=x.left+x.width/2-g/2,y=x.top-f-16),v==="bottom"&&(w=x.left+x.width/2-g/2,y=x.bottom+16),w=Rs(w,m,window.innerWidth-g-m),y=Rs(y,m,window.innerHeight-f-m),i({left:w,top:y})},[n]);return c.useLayoutEffect(()=>{u()},[u]),!e||!n?null:t.jsxs("div",{className:"help-overlay","aria-hidden":"true",children:[t.jsx("div",{className:"help-highlight",style:{top:n.rect.top-6,left:n.rect.left-6,width:n.rect.width+12,height:n.rect.height+12}}),t.jsxs("div",{className:"help-bubble",ref:l,style:r??void 0,"data-placement":n.placement,children:[t.jsx("div",{className:"help-title",children:n.title}),t.jsx("div",{className:"help-body",children:n.body})]})]})}const Ko=[{id:"builder",label:"Builder lens",body:"Focus on step payloads, execution paths, and replay control."},{id:"executive",label:"Executive lens",body:"Focus on bottlenecks, risk, and outcome-level run quality."},{id:"operator",label:"Operator lens",body:"Focus on failures, retries, and trace reliability posture."}],Qo=[{id:"rapid_triage",label:"Rapid triage",body:"Jump straight to the highest-risk step and start resolution.",estimate:"2-3 min"},{id:"deep_diagnosis",label:"Deep diagnosis",body:"Open flow and guided analysis for full root-cause exploration.",estimate:"8-12 min"},{id:"team_sync",label:"Team sync",body:"Open collaborative mode and prep a handoff workflow.",estimate:"4-6 min"}];function Yo({onComplete:e,onStartTour:n,onStartStory:s,persona:r="builder",onPersonaChange:i,launchPath:d="rapid_triage",onLaunchPathChange:l,onStartLaunchPath:p}){const u=()=>{n==null||n(),e()},m=()=>{s==null||s(),e()},g=f=>{l==null||l(f),p==null||p(f),e()};return t.jsx("div",{className:"intro-overlay",role:"dialog","aria-modal":"true","aria-label":"Agent Director intro",children:t.jsxs("div",{className:"intro-card",children:[t.jsx("div",{className:"intro-scan"}),t.jsx("div",{className:"intro-title",children:"Agent Director"}),t.jsx("div",{className:"intro-tagline",children:"Watch your agent think. Then direct it."}),t.jsxs("div",{className:"intro-steps",children:[t.jsxs("div",{className:"intro-step",children:[t.jsx("div",{className:"intro-step-label",children:"Observe"}),t.jsx("div",{className:"intro-step-body",children:"Scrub the timeline to feel pacing and parallelism."})]}),t.jsxs("div",{className:"intro-step",children:[t.jsx("div",{className:"intro-step-label",children:"Inspect"}),t.jsx("div",{className:"intro-step-body",children:"Open the bottleneck to read payloads and costs."})]}),t.jsxs("div",{className:"intro-step",children:[t.jsx("div",{className:"intro-step-label",children:"Direct"}),t.jsx("div",{className:"intro-step-body",children:"Replay from a decisive step and compare runs."})]})]}),t.jsx("div",{className:"intro-personas",role:"group","aria-label":"Select onboarding lens",children:Ko.map(f=>t.jsxs("button",{type:"button",className:`ghost-button intro-persona ${r===f.id?"active":""}`,onClick:()=>i==null?void 0:i(f.id),"aria-pressed":r===f.id,"aria-label":f.label,children:[t.jsx("span",{className:"intro-persona-label",children:f.label}),t.jsx("span",{className:"intro-persona-body",children:f.body})]},f.id))}),t.jsx("div",{className:"intro-launch-paths",role:"group","aria-label":"Select launch path",children:Qo.map(f=>t.jsxs("article",{className:`intro-path-card ${d===f.id?"active":""}`,children:[t.jsxs("button",{type:"button",className:`ghost-button intro-path-button ${d===f.id?"active":""}`,onClick:()=>l==null?void 0:l(f.id),"aria-pressed":d===f.id,"aria-label":f.label,children:[t.jsx("span",{className:"intro-path-label",children:f.label}),t.jsx("span",{className:"intro-path-estimate",children:f.estimate}),t.jsx("span",{className:"intro-path-body",children:f.body})]}),t.jsxs("button",{className:"primary-button intro-path-start",type:"button",onClick:()=>g(f.id),children:["Start ",f.label]})]},f.id))}),t.jsxs("div",{className:"intro-grid",children:[t.jsx("span",{}),t.jsx("span",{}),t.jsx("span",{}),t.jsx("span",{})]}),t.jsxs("div",{className:"intro-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:u,children:"Start guided tour"}),s?t.jsx("button",{className:"ghost-button",type:"button",onClick:m,children:"Play story mode"}):null,t.jsx("button",{className:"ghost-button",type:"button",onClick:e,children:"Skip intro"})]})]})})}function Xo({explainMode:e,storyActive:n,onStartTour:s,onStartStory:r,onToggleExplain:i,onDismiss:d}){return t.jsxs("section",{className:"hero-ribbon","aria-label":"Director briefing","data-help":!0,"data-help-indicator":!0,"data-tour":"hero","data-help-title":"Director briefing","data-help-body":"Start the tour, play story mode, or enable explain to learn the interface instantly.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"hero-ribbon-top",children:[t.jsx("span",{className:"hero-eyebrow",children:"Director briefing"}),t.jsx("button",{className:"ghost-button hero-dismiss",type:"button",onClick:d,children:"Dismiss"})]}),t.jsx("div",{className:"hero-title",children:"Observe. Inspect. Direct."}),t.jsx("div",{className:"hero-subtitle",children:"A cinematic control room for agent traces. See time, read structure, then replay with confidence."}),t.jsxs("div",{className:"hero-pills",children:[t.jsx("span",{className:"hero-pill","data-tone":"observe",children:"Observe"}),t.jsx("span",{className:"hero-pill","data-tone":"inspect",children:"Inspect"}),t.jsx("span",{className:"hero-pill","data-tone":"direct",children:"Direct"})]}),t.jsxs("div",{className:"hero-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:s,children:"Start guided tour"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:r,disabled:n,children:n?"Story running":"Play story mode"}),t.jsxs("button",{className:`ghost-button ${e?"active":""}`,type:"button",onClick:i,"aria-pressed":e,children:["Explain ",e?"On":"Off"]})]})]})}function Zo({mode:e,isPlaying:n,storyActive:s,explainMode:r,hidden:i=!1,open:d,onToggleOpen:l,onTogglePlay:p,onStartStory:u,onStopStory:m,onStartTour:g,onOpenPalette:f,onShowShortcuts:x,onToggleExplain:v,onJumpToBottleneck:w}){if(i)return null;const y=n?"Pause":"Play",S=s?"Stop story":"Story mode";return d?t.jsxs("aside",{className:"quick-actions","aria-label":"Quick actions","data-help":!0,"data-help-indicator":!0,"data-tour":"quick-actions","data-help-title":"Quick actions","data-help-body":"Launch story mode, open the command palette, or jump to the bottleneck instantly.","data-help-placement":"left",children:[t.jsxs("div",{className:"quick-actions-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"quick-actions-title",children:"Quick actions"}),t.jsx("div",{className:"quick-actions-subtitle",children:"Pin demo controls close at hand."})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:l,"aria-label":"Collapse quick actions",children:"Collapse"})]}),t.jsxs("button",{className:`quick-action ${n?"active":""}`,type:"button",onClick:p,"aria-label":y,"data-help":!0,"data-help-title":"Play or pause","data-help-body":"Start or stop playback from anywhere.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:y}),t.jsx("span",{className:"quick-action-meta",children:e==="flow"?"Cinema":"Space"})]}),t.jsxs("button",{className:`quick-action ${s?"active":""}`,type:"button",onClick:s?m:u,"aria-label":S,"data-help":!0,"data-help-title":"Story mode","data-help-body":"Auto-runs a cinematic walkthrough of the run.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:S}),t.jsx("span",{className:"quick-action-meta",children:"S"})]}),t.jsxs("button",{className:"quick-action",type:"button",onClick:f,"aria-label":"Open command palette","data-help":!0,"data-help-title":"Command palette","data-help-body":"Search every action and jump instantly.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Command"}),t.jsx("span",{className:"quick-action-meta",children:"Cmd+K"})]}),t.jsxs("button",{className:"quick-action",type:"button",onClick:g,"aria-label":"Start guided tour","data-help":!0,"data-help-title":"Guided tour","data-help-body":"Walk the interface with a curated tour.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Tour"}),t.jsx("span",{className:"quick-action-meta",children:"Guide"})]}),t.jsxs("button",{className:`quick-action ${r?"active":""}`,type:"button",onClick:v,"aria-label":"Toggle explain mode","data-help":!0,"data-help-title":"Explain mode","data-help-body":"Toggle contextual overlays for every control.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Explain"}),t.jsx("span",{className:"quick-action-meta",children:r?"On":"Off"})]}),t.jsxs("button",{className:"quick-action",type:"button",onClick:w,"aria-label":"Jump to bottleneck","data-help":!0,"data-help-title":"Bottleneck jump","data-help-body":"Focus instantly on the slowest step.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Bottleneck"}),t.jsx("span",{className:"quick-action-meta",children:"Latency"})]}),t.jsxs("button",{className:"quick-action",type:"button",onClick:x,"aria-label":"Show shortcuts","data-help":!0,"data-help-title":"Shortcuts","data-help-body":"See the full keyboard map.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Shortcuts"}),t.jsx("span",{className:"quick-action-meta",children:"?"})]})]}):t.jsxs("button",{className:"quick-actions-toggle",type:"button",onClick:l,title:"Open quick actions","aria-expanded":"false","data-help":!0,"data-tour":"quick-actions","data-help-title":"Quick actions","data-help-body":"Open the dock to access demos, shortcuts, and instant actions.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-actions-toggle-label",children:"Actions"}),t.jsx("span",{className:"quick-actions-toggle-meta",children:"Dock"})]})}function el({active:e,label:n,step:s,total:r,onStop:i,onRestart:d}){if(!e)return null;const l=r>0?(s+1)/r*100:0;return t.jsxs("div",{className:"story-banner",role:"status","aria-live":"polite",children:[t.jsxs("div",{className:"story-banner-main",children:[t.jsx("div",{className:"story-banner-title",children:"Story mode"}),t.jsx("div",{className:"story-banner-step",children:n})]}),t.jsxs("div",{className:"story-banner-actions",children:[t.jsxs("span",{className:"story-banner-count",children:[Math.min(s+1,r),"/",r]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:d,children:"Restart"}),t.jsx("button",{className:"primary-button",type:"button",onClick:i,children:"Stop"})]}),t.jsx("div",{className:"story-banner-progress",children:t.jsx("span",{style:{width:`${l}%`}})})]})}function mn({variant:e,title:n,message:s,actions:r=[]}){return t.jsx("section",{className:`app-shell-state app-shell-${e}`,"aria-live":"polite",children:t.jsxs("div",{className:"app-shell-card",children:[e==="loading"?t.jsx("div",{className:"app-shell-spinner","aria-hidden":"true"}):null,t.jsx("h2",{children:n}),t.jsx("p",{children:s}),r.length?t.jsx("div",{className:"app-shell-actions",children:r.map(i=>t.jsx("span",{children:i.node},i.id))}):null]})})}function tl({notifications:e,onDismiss:n}){return e.length?t.jsx("aside",{className:"notification-center","aria-label":"System notifications","aria-live":"polite",children:e.map(s=>t.jsxs("article",{className:`notification-item level-${s.level}`,children:[t.jsx("p",{children:s.message}),t.jsx("button",{className:"ghost-button notification-dismiss",type:"button",onClick:()=>n(s.id),"aria-label":"Dismiss notification",children:"Dismiss"})]},s.id))}):null}function al({steps:e,fromRects:n,toRects:s,onComplete:r}){return c.useEffect(()=>{const i=window.setTimeout(r,550);return()=>window.clearTimeout(i)},[r]),t.jsx("div",{className:"morph-layer",children:e.map(i=>{var p;const d=n[i.id],l=s[i.id];return!d||!l?null:t.jsxs(Qi.div,{className:`morph-card step-${i.type}`,initial:{left:d.left,top:d.top,width:d.width,height:d.height},animate:{left:l.left,top:l.top,width:l.width,height:l.height},transition:{duration:.5,ease:"easeInOut"},children:[t.jsx("div",{className:"morph-card-title",children:i.name}),t.jsx("div",{className:"morph-card-subtitle",children:((p=i.preview)==null?void 0:p.title)??i.type})]},i.id)})})}function nl({morph:e,onComplete:n,children:s}){return t.jsxs("div",{className:"morph-orchestrator",children:[s,e?t.jsx(al,{steps:e.steps,fromRects:e.fromRects,toRects:e.toRects,onComplete:n}):null]})}const sl="demo-trace-overlap-001",rl="Overlap + ToolCallId Demo",il="2026-01-27T10:00:00.000Z",ol="2026-01-27T10:00:05.000Z",ll="completed",cl={source:"openai_agents",agentName:"DemoAgent",modelId:"gpt-4o-2024-11-20",wallTimeMs:5e3,workTimeMs:7200,totalTokens:1400,totalCostUsd:.018},dl=[{id:"s1",index:0,type:"llm_call",name:"plan",startedAt:"2026-01-27T10:00:00.000Z",endedAt:"2026-01-27T10:00:01.000Z",durationMs:1e3,childStepIds:[],metrics:{tokensTotal:300,costUsd:.004},preview:{title:"LLM: plan",subtitle:"gpt-4o",outputPreview:"I'll fetch two sources..."},status:"completed"},{id:"s2",index:1,type:"llm_call",name:"call_tools",startedAt:"2026-01-27T10:00:01.000Z",endedAt:"2026-01-27T10:00:01.200Z",durationMs:200,childStepIds:[],metrics:{tokensTotal:120,costUsd:.002},preview:{title:"LLM: call tools",outputPreview:"Calling web_search + database_query"},io:{emittedToolCallIds:["tc-001","tc-002"]},status:"completed"},{id:"s3",index:2,type:"tool_call",name:"web_search",toolCallId:"tc-001",startedAt:"2026-01-27T10:00:01.200Z",endedAt:"2026-01-27T10:00:03.200Z",durationMs:2e3,childStepIds:[],metrics:{costUsd:0},preview:{title:"Tool: web_search",inputPreview:'{"q":"EU AI Act"}',outputPreview:"[3 results...]"},status:"completed"},{id:"s4",index:3,type:"tool_call",name:"database_query",toolCallId:"tc-002",startedAt:"2026-01-27T10:00:01.500Z",endedAt:"2026-01-27T10:00:02.700Z",durationMs:1200,childStepIds:[],preview:{title:"Tool: database_query",inputPreview:'{"sql":"SELECT..."}',outputPreview:'{"rows":42}'},status:"completed"},{id:"s5",index:4,type:"llm_call",name:"analyze",startedAt:"2026-01-27T10:00:03.200Z",endedAt:"2026-01-27T10:00:04.600Z",durationMs:1400,childStepIds:[],metrics:{tokensTotal:700,costUsd:.012},preview:{title:"LLM: analyze",outputPreview:"Synthesis based on tool outputs..."},io:{consumedToolCallIds:["tc-001","tc-002"]},status:"completed"}],va={id:sl,name:rl,startedAt:il,endedAt:ol,status:ll,metadata:cl,steps:dl};function pr(e,n){const s=ul(e,n),r=new Set(s.map(f=>f.leftId)),i=new Set(s.map(f=>f.rightId)),d=n.steps.filter(f=>!i.has(f.id)).map(f=>f.id),l=e.steps.filter(f=>!r.has(f.id)).map(f=>f.id),p=s.filter(f=>{const x=e.steps.find(w=>w.id===f.leftId),v=n.steps.find(w=>w.id===f.rightId);return!x||!v?!1:Os(x)!==Os(v)}),u=p.map(f=>f.leftId),m=(n.metadata.totalCostUsd??0)-(e.metadata.totalCostUsd??0),g=n.metadata.wallTimeMs-e.metadata.wallTimeMs;return{addedSteps:d,removedSteps:l,changedSteps:u,changedPairs:p,alignedSteps:s,costDeltaUsd:m,wallTimeDeltaMs:g}}function ul(e,n){const s=[],r=new Set(e.steps.map(g=>g.id)),i=new Set(n.steps.map(g=>g.id));Array.from(r).forEach(g=>{i.has(g)&&(s.push({leftId:g,rightId:g}),r.delete(g),i.delete(g))});const d=new Map;n.steps.forEach(g=>{g.toolCallId&&d.set(g.toolCallId,g.id)}),e.steps.forEach(g=>{if(!g.toolCallId)return;const f=d.get(g.toolCallId);f&&i.has(f)&&(s.push({leftId:g.id,rightId:f}),r.delete(g.id),i.delete(f))});const l=Fs(e),p=Fs(n),u=pl(e,n),m={};return i.forEach(g=>{const f=p.get(g);if(!f)return;const x=Ps(f.step);x&&(m[x]||(m[x]=[]),m[x].push(g))}),Object.values(m).forEach(g=>{g.sort((f,x)=>{var v,w;return(((v=p.get(f))==null?void 0:v.startMs)??0)-(((w=p.get(x))==null?void 0:w.startMs)??0)})}),Array.from(r).forEach(g=>{var w;const f=l.get(g);if(!f)return;const x=Ps(f.step);if(!x||!((w=m[x])!=null&&w.length))return;const v=ml(f,m[x],p,u);v&&(s.push({leftId:g,rightId:v}),r.delete(g),i.delete(v),m[x]=m[x].filter(y=>y!==v))}),s}function Os(e){var r,i;const n=((r=e.preview)==null?void 0:r.outputPreview)??null,s=((i=e.metrics)==null?void 0:i.costUsd)??null;return`${e.status}|${n??""}|${s??""}`}function Ps(e){return e.type?`${e.type}:${e.name??""}`:null}function Ls(e){if(!e)return null;const n=Date.parse(e);return Number.isNaN(n)?null:n}function Fs(e){const n=Ls(e.startedAt),s=new Map;return e.steps.forEach(r=>{const i=Ls(r.startedAt),d=n!=null&&i!=null?i-n:null;s.set(r.id,{step:r,startMs:d})}),s}function pl(e,n){const s=Math.max(e.metadata.wallTimeMs,n.metadata.wallTimeMs,1);return Math.max(1e3,Math.min(5e3,Math.round(s*.1)))}function ml(e,n,s,r){const i=e.startMs;if(i==null)return null;let d=null,l=r+1;return n.forEach(p=>{const u=s.get(p);if(!u||u.startMs==null)return;const m=Math.abs(u.startMs-i);m<l&&(l=m,d=p)}),l<=r?d:null}const hl=new Map,fl=new Map,ct=new Map;async function yl(){return[va]}async function mr(e){return{trace:va}}const gl={s1:{role:"assistant",content:"I'll analyze the user's request and create a plan to fetch information from two sources: a web search for current EU AI Act updates and a database query for historical compliance data.",model:"gpt-4o-2024-11-20",usage:{prompt_tokens:150,completion_tokens:150,total_tokens:300},reasoning:"The user wants comprehensive information about AI regulations. I'll use parallel tool calls to maximize efficiency."},s2:{role:"assistant",content:null,tool_calls:[{id:"tc-001",type:"function",function:{name:"web_search",arguments:'{"q":"EU AI Act latest updates 2026"}'}},{id:"tc-002",type:"function",function:{name:"database_query",arguments:`{"sql":"SELECT * FROM compliance_records WHERE region='EU' ORDER BY date DESC LIMIT 10"}`}}],model:"gpt-4o-2024-11-20",usage:{prompt_tokens:80,completion_tokens:40,total_tokens:120}},s3:{tool_call_id:"tc-001",tool_name:"web_search",input:{q:"EU AI Act latest updates 2026"},output:{results:[{title:"EU AI Act Implementation Timeline",url:"https://example.com/ai-act",snippet:"The EU AI Act enters full force in 2026..."},{title:"High-Risk AI Systems Classification",url:"https://example.com/classification",snippet:"New guidance on high-risk categorization..."},{title:"Compliance Deadlines Approaching",url:"https://example.com/deadlines",snippet:"Organizations must comply by August 2026..."}],total_results:3,search_time_ms:1850},status:"success"},s4:{tool_call_id:"tc-002",tool_name:"database_query",input:{sql:"SELECT * FROM compliance_records WHERE region='EU' ORDER BY date DESC LIMIT 10"},output:{rows:[{id:1,company:"TechCorp",status:"compliant",date:"2026-01-15"},{id:2,company:"AIStartup",status:"in_progress",date:"2026-01-10"},{id:3,company:"DataCo",status:"compliant",date:"2026-01-05"}],row_count:42,query_time_ms:1100},status:"success"},s5:{role:"assistant",content:`Based on my analysis of the web search results and database records:

**Key Findings:**
1. The EU AI Act is now in full effect as of 2026
2. High-risk AI systems require specific compliance measures
3. 42 organizations in our database have compliance records

**Recommendations:**
- Review classification of AI systems
- Ensure documentation is complete
- Schedule compliance audit before August deadline`,model:"gpt-4o-2024-11-20",usage:{prompt_tokens:450,completion_tokens:250,total_tokens:700},reasoning:"Synthesized information from both the web search (3 relevant articles) and database query (42 compliance records) to provide actionable insights."}};function bl(e,n){const s=va.steps.find(d=>d.id===e);if(!s)return null;const r=gl[e];if(!r)return null;const i=n?xl(r):r;return{...s,data:i}}function xl(e){var s,r;const n=JSON.parse(JSON.stringify(e));return(s=n.input)!=null&&s.sql&&(n.input.sql="[REDACTED]"),(r=n.output)!=null&&r.rows&&(n.output.rows=n.output.rows.map(i=>({...i,company:"[REDACTED]"}))),n.tool_calls&&(n.tool_calls=n.tool_calls.map(i=>({...i,function:{...i.function,arguments:"[REDACTED]"}}))),n}async function vl(e,n,s,r=[],i=!1){return await new Promise(d=>setTimeout(d,150)),bl(n,i)}async function wl(e,n,s){await vl(e,n,"redacted",[],s)}function jl(e,n){return()=>{}}function kl(){hl.clear(),fl.clear()}async function Sl(e,n){return null}async function Nl(e){return null}async function Hc(e,n){return[]}async function Uc(e,n,s,r,i){return null}async function Cl(){return[]}async function Ml(e,n){return null}async function Il(e,n,s,r,i){return i?hr(i,n,s,r):null}function hr(e,n,s,r){var w;const i=JSON.parse(JSON.stringify(e)),d=6e4,l=Date.parse("2024-01-01T00:00:00.000Z"),p=Date.parse(e.endedAt??e.startedAt??""),m=(Number.isNaN(p)?l:p)+d,g=new Date(m);i.id=`${e.id}-replay-${m}`,i.parentTraceId=e.id,i.branchPointStepId=n,i.replay={strategy:s,modifiedStepId:n,modifications:r,createdAt:g.toISOString()};const f=y=>{if(!y)return y;const S=Date.parse(y);return Number.isNaN(S)?y:new Date(S+d).toISOString()};i.startedAt=f(i.startedAt)??i.startedAt,i.endedAt=f(i.endedAt);const x=new Set,v=((w=i.steps.find(y=>y.id===n))==null?void 0:w.index)??-1;return s==="live"?i.steps.forEach(y=>{y.index>v&&x.add(y.id)}):s==="hybrid"&&i.steps.forEach(y=>{y.index>v&&x.add(y.id)}),i.steps=i.steps.map(y=>{var N;const S={...y};if(S.startedAt=f(y.startedAt)??y.startedAt,S.endedAt=f(y.endedAt),y.id===n){const D=((N=y.preview)==null?void 0:N.outputPreview)??"";S.preview={...y.preview,outputPreview:`${D} (modified)`.trim()}}return x.has(y.id)&&(S.status="pending",S.endedAt=null,S.durationMs=void 0,S.metrics=void 0,S.preview={...y.preview,outputPreview:"[invalidated for replay]"}),S}),i}async function El(e){return Al(e)}async function _l(e){var n;return((n=ct.get(e))==null?void 0:n.job)??null}async function qs(e){var n;return((n=ct.get(e))==null?void 0:n.matrix)??null}async function Tl(e){{const n=ct.get(e);if(!n)return null;const s={...n.job,status:"canceled",scenarios:n.job.scenarios.map(r=>({...r,status:"canceled",endedAt:r.endedAt??new Date().toISOString()}))};return ct.set(e,{...n,job:s}),s}}function Al(e){const n=`demo-job-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,s=va,r=new Date().toISOString(),i=e.scenarios.map((u,m)=>({id:`demo-scn-${m+1}`,name:u.name,strategy:u.strategy,modifications:u.modifications,status:"running",startedAt:r,endedAt:null,replayTraceId:`${n}-replay-${m+1}`})),d={id:n,traceId:e.traceId,stepId:e.stepId,status:"running",createdAt:r,startedAt:r,endedAt:null,scenarioCount:i.length,completedCount:0,failedCount:0,canceledCount:0,scenarios:i},l=i.map(u=>{const m=hr(s,e.stepId,u.strategy,u.modifications);m.id=u.replayTraceId;const g=pr(s,m),f=s.metadata.totalCostUsd??0,x=m.metadata.totalCostUsd??f,v=s.metadata.errorCount??0,w=m.metadata.errorCount??v,y=s.metadata.retryCount??0,S=m.metadata.retryCount??y,N=m.steps.filter(D=>D.status==="pending").length;return{scenarioId:u.id,name:u.name,strategy:u.strategy,status:"completed",replayTraceId:u.replayTraceId,modifications:u.modifications,error:null,changedStepIds:g.changedSteps,addedStepIds:g.addedSteps,removedStepIds:g.removedSteps,metrics:{costDeltaUsd:x-f,wallTimeDeltaMs:(m.metadata.wallTimeMs??0)-(s.metadata.wallTimeMs??0),errorDelta:w-v,retryDelta:S-y,changedSteps:g.changedSteps.length,addedSteps:g.addedSteps.length,removedSteps:g.removedSteps.length,invalidatedStepCount:N}}}),p={jobId:n,traceId:e.traceId,stepId:e.stepId,rows:l,causalRanking:[]};return ct.set(n,{job:d,matrix:p}),window.setTimeout(()=>{const u=ct.get(n);if(!u)return;const m=new Date().toISOString(),g=u.job.scenarios.map(v=>({...v,status:"completed",endedAt:m})),f={...u.job,status:"completed",endedAt:m,completedCount:g.length,scenarios:g},x={...u.matrix,rows:u.matrix.rows.map(v=>({...v,status:"completed"}))};ct.set(n,{job:f,matrix:x})},600),d}async function Dl(e){return null}async function $l(e){return null}async function hn(e){return null}async function Rl(e){return null}async function Ol(e){return null}async function Pl(e){return null}async function Gs(e){return{session:null,conflict:!1,error:null}}async function zs(e){return null}async function Ll(e){return null}async function Fl(e){return null}async function ql(e){return null}async function Gl(e){return null}async function zl(e,n){return null}async function Bl(e){return null}async function Hl(e,n,s){return null}async function Bs(){return null}async function Hs(){return null}function Ul(e,n,s){return()=>{}}function Wl(){const[e,n]=c.useState(null),[s,r]=c.useState(null),[i,d]=c.useState(!0),[l,p]=c.useState(null),[u,m]=c.useState([]),[g,f]=c.useState(null),x=c.useCallback(async w=>{const y=await mr(),S=(y==null?void 0:y.trace)??null;n(S),r(S?(y==null?void 0:y.insights)??so(S):null)},[n,r]),v=c.useCallback(async()=>{var w;d(!0),p(null);try{const y=await yl();m(y);const S=((w=y[y.length-1])==null?void 0:w.id)??null,N=g??S;if(!N){n(null),r(null);return}if(!g||g!==N){f(N);return}await x(N)}catch(y){p(y instanceof Error?y.message:"Failed to load trace")}finally{d(!1)}},[g,x]);return c.useEffect(()=>{v()},[v]),c.useEffect(()=>{g&&(d(!0),x(g).catch(w=>{p(w instanceof Error?w.message:"Failed to load trace")}).finally(()=>d(!1)))},[g,x]),c.useEffect(()=>jl(),[g,f]),{trace:e,insights:s,loading:i,error:l,reload:v,traces:u,selectedTraceId:g,setSelectedTraceId:f}}function K(e,n){const[s,r]=c.useState(()=>{if(typeof window>"u")return n;try{const i=window.localStorage.getItem(e);return i==null?n:JSON.parse(i)}catch{return n}});return c.useEffect(()=>{try{window.localStorage.setItem(e,JSON.stringify(s))}catch{}},[e,s]),[s,r]}const Us=new Map;function Jl(e,n){const s=e.map(i=>i.id).join("|"),r=n.map(i=>`${i.source}->${i.target}`).join("|");return`${e.length}:${n.length}:${s}:${r}`}function Vl(e,n,s){if(s){const r=Jl(e,n),i=Us.get(s);if(i&&i.signature===r)return i.layout;const d=Ws(e,n);return Us.set(s,{signature:r,layout:d}),d}return Ws(e,n)}function Ws(e,n){if(e.length>2500){const r=Math.ceil(Math.sqrt(e.length));return e.map((i,d)=>{const l=Math.floor(d/r),p=d%r;return{id:i.id,position:{x:p*260,y:l*160}}})}const s=new Ss.graphlib.Graph;return s.setGraph({rankdir:"LR",nodesep:48,ranksep:80}),s.setDefaultEdgeLabel(()=>({})),e.forEach(r=>{s.setNode(r.id,{width:220,height:120})}),n.forEach(r=>{s.setEdge(r.source,r.target)}),Ss.layout(s),e.map(r=>{const i=s.node(r.id);return{id:r.id,position:{x:i.x-i.width/2,y:i.y-i.height/2}}})}const fr="agentDirector.gameplayFunnel.v1";function Kl(){try{const e=window.localStorage.getItem(fr);if(!e)return[];const n=JSON.parse(e);return Array.isArray(n)?n.filter(s=>{if(!s||typeof s!="object")return!1;const r=s;return typeof r.name=="string"&&typeof r.at=="number"&&!!r.metadata&&typeof r.metadata=="object"}):[]}catch{return[]}}function Ql(e,n={}){const s={name:e,at:Date.now(),metadata:n},i=[...Kl(),s].slice(-200);return window.localStorage.setItem(fr,JSON.stringify(i)),s}function Yl(e){const n=new Map;for(const r of e)r.type==="tool_call"&&r.toolCallId&&n.set(r.toolCallId,r.id);const s=[];for(const r of e)if(!(r.type!=="llm_call"||!r.io)){for(const i of r.io.emittedToolCallIds??[]){const d=n.get(i);d&&s.push({id:`io_emit_${r.id}_${d}`,source:r.id,target:d,kind:"io",toolCallId:i})}for(const i of r.io.consumedToolCallIds??[]){const d=n.get(i);d&&s.push({id:`io_consume_${d}_${r.id}`,source:d,target:r.id,kind:"io",toolCallId:i})}}return s}function Xl(e,n,s){const{intervals:r}=xa(e,n,s),i=new Set;return r.forEach(d=>{i.add(d.startMs),i.add(d.endMs)}),Array.from(i).sort((d,l)=>d-l)}function Zl(e,n,s){if(!e.length)return null;if(s===1){for(const r of e)if(r>n+1)return r;return e[e.length-1]}for(let r=e.length-1;r>=0;r-=1){const i=e[r];if(i<n-1)return i}return e[0]}const ec=300,tc=2e3,ac=1.5;function nc(e){const n=ec*Math.pow(ac,Math.max(0,e));return Math.min(tc,Math.round(n))}function tt(e,n){if(!e)return n;try{return JSON.parse(e)}catch{return n}}function Js(e,n){const s=new Map;return[...e,...n].forEach(r=>{const i=s.get(r.id);(!i||r.updatedAt>=i.updatedAt)&&s.set(r.id,r)}),Array.from(s.values()).sort((r,i)=>r.createdAt-i.createdAt)}function Vs(e,n=50){return[...e].sort((s,r)=>r.timestamp-s.timestamp).slice(0,n)}const Ks=["latency storm","cache divergence","tool timeout chain","stale prompt vector","schema mismatch surge"],fn=[{templateId:"pack-stability-bootstrap",title:"Stability Bootstrap",archetype:"stability",depthMin:1,depthMax:3,baseDifficulty:2,hazards:["latency storm","cache divergence"],rewardCredits:78},{templateId:"pack-drift-containment",title:"Drift Containment",archetype:"containment",depthMin:1,depthMax:4,baseDifficulty:2,hazards:["stale prompt vector","schema mismatch surge"],rewardCredits:82},{templateId:"pack-timeout-circuit-breaker",title:"Timeout Circuit Breaker",archetype:"resilience",depthMin:2,depthMax:5,baseDifficulty:3,hazards:["tool timeout chain","schema mismatch surge"],rewardCredits:90},{templateId:"pack-cache-realignment",title:"Cache Realignment",archetype:"forensics",depthMin:2,depthMax:6,baseDifficulty:3,hazards:["cache divergence","schema mismatch surge"],rewardCredits:96},{templateId:"pack-pipeline-quarantine",title:"Pipeline Quarantine",archetype:"containment",depthMin:3,depthMax:7,baseDifficulty:4,hazards:["stale prompt vector","tool timeout chain"],rewardCredits:102},{templateId:"pack-latency-decoupling",title:"Latency Decoupling",archetype:"throughput",depthMin:3,depthMax:8,baseDifficulty:4,hazards:["latency storm","tool timeout chain"],rewardCredits:108},{templateId:"pack-spec-reconciliation",title:"Spec Reconciliation",archetype:"forensics",depthMin:4,depthMax:9,baseDifficulty:5,hazards:["schema mismatch surge","cache divergence"],rewardCredits:114},{templateId:"pack-fault-isolation-grid",title:"Fault Isolation Grid",archetype:"diagnostics",depthMin:4,depthMax:10,baseDifficulty:5,hazards:["schema mismatch surge","stale prompt vector"],rewardCredits:120},{templateId:"pack-shadow-fork-audit",title:"Shadow Fork Audit",archetype:"timelines",depthMin:5,depthMax:11,baseDifficulty:6,hazards:["stale prompt vector","latency storm"],rewardCredits:126},{templateId:"pack-signal-recovery-run",title:"Signal Recovery Run",archetype:"recovery",depthMin:5,depthMax:12,baseDifficulty:6,hazards:["tool timeout chain","cache divergence"],rewardCredits:132},{templateId:"pack-entropy-firebreak",title:"Entropy Firebreak",archetype:"stability",depthMin:6,depthMax:13,baseDifficulty:7,hazards:["schema mismatch surge","tool timeout chain"],rewardCredits:138},{templateId:"pack-pressure-release",title:"Pressure Release",archetype:"throughput",depthMin:6,depthMax:14,baseDifficulty:7,hazards:["latency storm","stale prompt vector"],rewardCredits:144},{templateId:"pack-replay-integrity-probe",title:"Replay Integrity Probe",archetype:"diagnostics",depthMin:7,depthMax:15,baseDifficulty:8,hazards:["cache divergence","tool timeout chain"],rewardCredits:150},{templateId:"pack-phased-countermeasure",title:"Phased Countermeasure",archetype:"boss",depthMin:7,depthMax:16,baseDifficulty:8,hazards:["tool timeout chain","schema mismatch surge"],rewardCredits:156},{templateId:"pack-cascade-rollup",title:"Cascade Rollup",archetype:"recovery",depthMin:8,depthMax:18,baseDifficulty:9,hazards:["schema mismatch surge","latency storm"],rewardCredits:162},{templateId:"pack-hyperlane-retune",title:"Hyperlane Retune",archetype:"timelines",depthMin:8,depthMax:20,baseDifficulty:9,hazards:["stale prompt vector","cache divergence"],rewardCredits:168},{templateId:"pack-guardian-gambit",title:"Guardian Gambit",archetype:"stability",depthMin:9,depthMax:24,baseDifficulty:10,hazards:["schema mismatch surge","latency storm"],rewardCredits:176},{templateId:"pack-final-lockdown",title:"Final Lockdown",archetype:"boss",depthMin:10,depthMax:Number.MAX_SAFE_INTEGER,baseDifficulty:10,hazards:["tool timeout chain","cache divergence"],rewardCredits:184}],vn=5,Qs=[{id:"seasonal-incident-sprint",title:"Resolve 3 raid objectives",goal:3,rewardCredits:120},{id:"boss-shutdown",title:"Defeat one boss encounter",goal:1,rewardCredits:200},{id:"guild-push",title:"Complete 2 guild operations",goal:2,rewardCredits:160},{id:"timeline-weaver",title:"Merge 2 timeline forks",goal:2,rewardCredits:150}],sc={stability_patch:{credits:20,materials:12},precision_lens:{credits:28,materials:16},overclock_core:{credits:42,materials:24}};function ee(e,n,s){return Math.min(s,Math.max(n,e))}function ba(e){let n=0;for(let s=0;s<e.length;s+=1)n=(n*31+e.charCodeAt(s))%1e5;return n}function rc(e,n,s,r){if(r.length===0)return 96;const i=r.slice(-vn),d=new Set(i.map(f=>f.templateId)),l=new Set(i.map(f=>f.archetype)),p=new Set(i.flatMap(f=>f.hazards.map(x=>x.toLowerCase())));let g=58+[...new Set(e.map(f=>f.toLowerCase()))].filter(f=>!p.has(f)).length*12;return d.has(n)?g-=10:g+=14,l.has(s)||(g+=10),ee(g,20,100)}function ic(e,n,s,r){const i=r.slice(-vn);if(i.length===0)return 0;const d=new Set(e.map(p=>p.toLowerCase()));let l=0;return[...i].reverse().forEach((p,u)=>{const m=Math.max(1,vn-u),g=p.hazards.filter(f=>d.has(f.toLowerCase())).length;l+=g*4*m,p.templateId===n&&(l+=8*m),p.archetype===s&&(l+=4*m)}),ee(l,0,72)}function oc(e,n,s,r){const i=ba(`${e}:${n}:${s.join("|")}`),d=[...new Set(s.map(v=>v.trim()).filter(Boolean))].sort().slice(-2),l=fn.filter(v=>n>=v.depthMin&&n<=v.depthMax),u=(l.length>0?l:fn).map(v=>{const w=ba(`${i}:${v.templateId}`),y=Ks[w%Ks.length],S=[...new Set([...v.hazards,y,...d.slice(-1)])].slice(0,4),N=rc(S,v.templateId,v.archetype,r),D=ic(S,v.templateId,v.archetype,r),J=ee(v.baseDifficulty+Math.floor(n/4),1,10),I=ee(Math.round(46+N*.5-D*.45+J*3),0,100),$=ba(`${w}:${r.length}:${n}`);return{template:v,candidateSeed:w,hazards:S,noveltyScore:N,repetitionPenalty:D,qualityScore:I,difficulty:J,tieBreaker:$}});u.sort((v,w)=>v.qualityScore!==w.qualityScore?v.qualityScore-w.qualityScore:v.noveltyScore!==w.noveltyScore?v.noveltyScore-w.noveltyScore:v.repetitionPenalty!==w.repetitionPenalty?w.repetitionPenalty-v.repetitionPenalty:v.tieBreaker-w.tieBreaker);const m=u[u.length-1],g=1+Math.min(n,12)*.04,f=Math.round(m.template.rewardCredits*g),x=[`seed=${m.candidateSeed}`,`depth=${n}`,`mutators=${d.join(",")||"none"}`,`template=${m.template.templateId}`,`archetype=${m.template.archetype}`].join(";");return{id:`mission-${n}-${m.template.templateId.replace("pack-","")}-${(e+n)%997}`,title:m.template.title,difficulty:m.difficulty,hazards:m.hazards,rewardCredits:f,missionSeed:m.candidateSeed,blueprint:x,templateId:m.template.templateId,archetype:m.template.archetype,qualityScore:m.qualityScore,noveltyScore:m.noveltyScore,repetitionPenalty:m.repetitionPenalty,launchPackSize:fn.length}}function yr(e,n,s,r){return oc(e,n,s,r)}function lc(){return[{id:"node-alpha",title:"Signal Fracture",body:"Telemetry divergence emerges across parallel tool paths.",choices:[{id:"alpha-risk",label:"Push aggressive branch optimization",nextNodeId:"node-beta",tensionDelta:12,mutator:"risk-surge"},{id:"alpha-safe",label:"Stabilize and preserve deterministic flow",nextNodeId:"node-beta",tensionDelta:-5,mutator:"stability-first"}]},{id:"node-beta",title:"Protocol Fork",body:"The team must choose speed versus interpretability under pressure.",choices:[{id:"beta-speed",label:"Favor speed and absorb uncertainty",nextNodeId:"node-gamma",tensionDelta:8,mutator:"throughput-boost"},{id:"beta-clarity",label:"Favor clarity and route through guardrails",nextNodeId:"node-gamma",tensionDelta:-3,mutator:"clarity-path"}]},{id:"node-gamma",title:"Final Directive",body:"Command has one move left before the run locks in.",choices:[{id:"gamma-strike",label:"Launch decisive strike sequence",nextNodeId:"node-alpha",tensionDelta:10,mutator:"strike-loop"},{id:"gamma-reset",label:"Reset tempo and rebuild confidence",nextNodeId:"node-alpha",tensionDelta:-6,mutator:"tempo-reset"}]}]}function gr(e,n){return{...Qs[(e+n)%Qs.length],progress:0,completed:!1}}function br(e,n){const s=[...e,n];return Array.from(new Set(s)).slice(-6)}function wn(e,n,s,r){return{...e,campaign:{...e.campaign,depth:n,mutators:s,missionHistory:r,currentMission:yr(e.seed,n,s,r)}}}function Ys(e){const n=ba(e),s=["baseline"];return{seed:n,raid:{party:["director"],roles:{director:"strategist"},objectives:[{id:"obj-root-cause",label:"Identify root cause chain",progress:0,target:100,completed:!1},{id:"obj-recover",label:"Recover operational stability",progress:0,target:100,completed:!1},{id:"obj-harden",label:"Harden replay strategy",progress:0,target:100,completed:!1}],completed:!1},campaign:{depth:1,lives:3,completedMissionIds:[],missionHistory:[],mutators:s,currentMission:yr(n,1,s,[])},narrative:{currentNodeId:"node-alpha",nodes:lc(),history:[],tension:35},skills:{points:6,nodes:[{id:"skill-focus",label:"Focus Matrix",cost:1,requires:[],minLevel:1,requiredMilestones:[],tier:1,loadoutSlot:"core",unlocked:!1},{id:"skill-resilience",label:"Resilience Mesh",cost:1,requires:[],minLevel:1,requiredMilestones:[],tier:1,loadoutSlot:"utility",unlocked:!1},{id:"skill-surge",label:"Surge Compiler",cost:2,requires:["skill-focus"],minLevel:2,requiredMilestones:[],tier:2,loadoutSlot:"power",unlocked:!1},{id:"skill-echo",label:"Echo Anticipator",cost:2,requires:["skill-resilience"],minLevel:2,requiredMilestones:[],tier:2,loadoutSlot:"utility",unlocked:!1},{id:"skill-ward",label:"Ward Lattice",cost:2,requires:["skill-resilience"],minLevel:3,requiredMilestones:["milestone-level-3"],tier:3,loadoutSlot:"power",unlocked:!1},{id:"skill-overclock",label:"Overclock Nexus",cost:3,requires:["skill-surge","skill-echo"],minLevel:4,requiredMilestones:["milestone-level-3"],tier:3,loadoutSlot:"power",unlocked:!1}],loadout:{capacity:3,equipped:[],slotCaps:{core:1,utility:1,power:1}}},pvp:{round:0,stability:72,sabotage:28,fog:40,winner:null},time:{activeForkId:"primary",forks:[{id:"primary",label:"Primary timeline",playheadMs:0,history:[0]}]},boss:{name:"The Causality Hydra",phase:1,hp:320,maxHp:320,enraged:!1,phaseMechanic:"Phase 1: Shield lattice destabilization",vulnerability:"exploit"},director:{risk:30,hint:"Start with the bottleneck path and branch cautiously.",recommendedModifier:"stability_patch",lastOutcome:"mixed"},economy:{credits:140,materials:90,crafted:[],inflationIndex:.438,reserveTarget:320},rewards:{dailyClaimedOn:null,streakDays:0,sessionClaimed:!1,streakClaimedFor:0,masteryClaims:[],history:[]},guild:{name:"Trace Guild",members:4,operationsScore:0,eventsCompleted:0},cinematic:{queue:[]},liveops:{season:`Season-${2026+n%2}`,week:1,challenge:gr(n,1),difficultyFactor:1,rewardMultiplier:1,tuningHistory:[]},teamComms:{pings:[]},safety:{mutedPlayerIds:[],blockedPlayerIds:[],reports:[]},outcome:{status:"in_progress",reason:"Run started. Complete missions and stabilize the incident.",updatedAt:Date.now()},sandbox:{enabled:!1},progression:{xp:0,level:1,nextLevelXp:200,milestones:[]}}}function Wc(e,n){return{...e,sandbox:{enabled:n},outcome:n?{status:"in_progress",reason:"Sandbox mode enabled. Penalties are disabled for safe practice runs.",updatedAt:Date.now()}:e.outcome}}function Jc(e,n,s){if(!n.trim())return e;const r=e.raid.party.includes(n)?e.raid.party:[...e.raid.party,n];return{...e,raid:{...e.raid,party:r,roles:{...e.raid.roles,[n]:s}}}}function Vc(e,n,s){const r=In(e),i=e.raid.objectives.map(u=>{if(u.id!==n)return u;const m=ee(u.progress+s,0,u.target);return{...u,progress:m,completed:m>=u.target}}),d=i.every(u=>u.completed),l=d&&!e.raid.completed?180:0,p={...e,raid:{...e.raid,objectives:i,completed:d},outcome:d&&!e.raid.completed?{status:"partial",reason:"Raid objectives completed. Push campaign and boss tracks to close the run.",updatedAt:Date.now()}:r};return!d||e.raid.completed?p:Je(Wt(p,l),60)}function Kc(e,n){const s=hc(e),r=e.campaign.currentMission,i=n?"success":"failure",d=[...e.campaign.missionHistory,{missionId:r.id,templateId:r.templateId??"legacy-template",archetype:r.archetype??"legacy",hazards:r.hazards,qualityScore:r.qualityScore??50,noveltyScore:r.noveltyScore??50,repetitionPenalty:r.repetitionPenalty??0,outcome:i}].slice(-30);if(n){const g=e.campaign.depth+1,f=wn(e,g,e.campaign.mutators,d),x=g>=5?{status:"win",reason:"Campaign depth target reached. Incident run is stabilized.",updatedAt:Date.now()}:{status:"partial",reason:`Mission ${r.id} cleared. Advance deeper to secure the run.`,updatedAt:Date.now()},v={...f,campaign:{...f.campaign,completedMissionIds:[...f.campaign.completedMissionIds,r.id]},economy:{...f.economy,materials:f.economy.materials+14},director:{...f.director,lastOutcome:"success"},outcome:x};return Je(Wt(v,r.rewardCredits),120)}const l=s.enabled?e.campaign.lives:ee(e.campaign.lives-1,0,3),p=wn(e,e.campaign.depth,br(e.campaign.mutators,"failure-loop"),d),u=s.enabled?{status:"partial",reason:"Sandbox mode active. Failure recorded with no life penalty.",updatedAt:Date.now()}:l<=0?{status:"loss",reason:"No campaign lives remaining. Incident run failed.",updatedAt:Date.now()}:{status:"partial",reason:`Mission failed. ${l} campaign lives remaining.`,updatedAt:Date.now()},m={...p,campaign:{...p.campaign,lives:l},director:{...p.director,lastOutcome:"failure"},outcome:u};return Je(m,40)}function Qc(e,n){const s=e.narrative.nodes.find(p=>p.id===e.narrative.currentNodeId),r=s==null?void 0:s.choices.find(p=>p.id===n);if(!s||!r)return e;const i=ee(e.narrative.tension+r.tensionDelta,0,100),d=br(e.campaign.mutators,r.mutator),l=wn(e,e.campaign.depth,d,e.campaign.missionHistory);return{...l,narrative:{...l.narrative,currentNodeId:r.nextNodeId,history:[...l.narrative.history,{nodeId:s.id,choiceId:r.id}],tension:i}}}function Yc(e,n){const s=e.skills.nodes.find(i=>i.id===n);return!s||!cc(e,n).allowed?e:{...e,skills:{...e.skills,points:e.skills.points-s.cost,nodes:e.skills.nodes.map(i=>i.id===n?{...i,unlocked:!0}:i)}}}function Xc(e,n){return dc(e,n).allowed?{...e,skills:{...e.skills,loadout:{...e.skills.loadout,equipped:[...e.skills.loadout.equipped,n]}}}:e}function cc(e,n){const s=e.skills.nodes.find(p=>p.id===n);if(!s)return{allowed:!1,reason:"Unknown skill node."};if(s.unlocked)return{allowed:!1,reason:"Skill already unlocked."};const r=new Set(e.skills.nodes.filter(p=>p.unlocked).map(p=>p.id)),i=s.requires.filter(p=>!r.has(p));if(i.length>0)return{allowed:!1,reason:`Requires: ${i.join(", ")}`};const d=vr(e);if(d.level<s.minLevel)return{allowed:!1,reason:`Requires level ${s.minLevel}`};const l=s.requiredMilestones.filter(p=>!d.milestones.includes(p));return l.length>0?{allowed:!1,reason:`Requires milestone ${l[0]}`}:e.skills.points<s.cost?{allowed:!1,reason:`Need ${s.cost} points`}:{allowed:!0,reason:"Unlock available"}}function dc(e,n){const s=e.skills.nodes.find(d=>d.id===n);if(!s)return{allowed:!1,reason:"Unknown skill node."};if(!s.unlocked)return{allowed:!1,reason:"Unlock required before equip."};if(e.skills.loadout.equipped.includes(n))return{allowed:!1,reason:"Already equipped."};if(e.skills.loadout.equipped.length>=e.skills.loadout.capacity)return{allowed:!1,reason:"Loadout capacity reached."};const r=e.skills.loadout.slotCaps[s.loadoutSlot];return e.skills.loadout.equipped.reduce((d,l)=>{const p=e.skills.nodes.find(u=>u.id===l);return(p==null?void 0:p.loadoutSlot)===s.loadoutSlot?d+1:d},0)>=r?{allowed:!1,reason:`${s.loadoutSlot} slot limit reached.`}:{allowed:!0,reason:"Equip available"}}function Zc(e,n){const s=In(e),r={...e.pvp};n==="sabotage"?(r.sabotage=ee(r.sabotage+13,0,100),r.stability=ee(r.stability-11,0,100),r.fog=ee(r.fog+9,0,100)):n==="stabilize"?(r.stability=ee(r.stability+14,0,100),r.sabotage=ee(r.sabotage-8,0,100),r.fog=ee(r.fog-6,0,100)):(r.fog=ee(r.fog-16,0,100),r.stability=ee(r.stability+3,0,100),r.sabotage=ee(r.sabotage-4,0,100)),r.round+=1,r.stability<=0?r.winner="saboteur":r.sabotage<=0?r.winner="operator":r.round>=10&&(r.winner=r.stability>=r.sabotage?"operator":"saboteur");const i=r.winner==="operator"?{status:"win",reason:"Operator side prevailed in the sabotage conflict.",updatedAt:Date.now()}:r.winner==="saboteur"?{status:"loss",reason:"Saboteur pressure overwhelmed system stability.",updatedAt:Date.now()}:s,d={...e,pvp:r,outcome:i};return Je(d,r.winner?72:12)}function ed(e,n,s){const r=`fork-${e.time.forks.length+1}`,i={id:r,label:n.trim()||r,playheadMs:ee(s,0,36e5),history:[ee(s,0,36e5)]};return{...e,time:{...e.time,activeForkId:r,forks:[...e.time.forks,i]}}}function td(e,n){const s=e.time.activeForkId,r=e.time.forks.map(i=>{if(i.id!==s)return i;const d=ee(i.playheadMs-Math.abs(n),0,36e5);return{...i,playheadMs:d,history:[...i.history,d]}});return{...e,time:{...e.time,forks:r}}}function ad(e,n){if(n==="primary")return e;const s=e.time.forks.find(d=>d.id===n),r=e.time.forks.find(d=>d.id==="primary");if(!s||!r)return e;const i={...r,playheadMs:s.playheadMs,history:[...r.history,s.playheadMs]};return{...e,time:{activeForkId:"primary",forks:[i,...e.time.forks.filter(d=>d.id!=="primary"&&d.id!==n)]}}}function nd(e,n){const s=In(e),i={1:{exploit:42,strike:24,shield:8},2:{exploit:34,strike:28,shield:10},3:{exploit:26,strike:18,shield:14}}[e.boss.phase][n],d=e.boss.vulnerability===n?8:0,l=i+d,p=ee(e.boss.hp-l,0,e.boss.maxHp),u=p/e.boss.maxHp,m=u<=.33?3:u<=.66?2:1,g=m===1?"Phase 1: Shield lattice destabilization":m===2?"Phase 2: Mirror clones absorb exploit damage":"Phase 3: Enrage pulse; shield counters become lethal",f=m===1?"exploit":m===2?"strike":"shield",x={...e,boss:{...e.boss,hp:p,phase:m,enraged:m===3||p<=e.boss.maxHp*.2,phaseMechanic:g,vulnerability:f},outcome:p<=0?{status:"win",reason:"Boss encounter cleared. Run secured.",updatedAt:Date.now()}:s};return Je(x,p<=0?180:10)}function sd(e,n){const s=n.failures*12+n.retries*4+(n.latencyMs>1400?8:0),r=ee(e.director.risk+s,0,100),i=n.failures>0?"Prioritize failure triage and run a stabilizing replay branch.":n.latencyMs>1400?"Latency pressure detected. Reduce fan-out and tighten tool boundaries.":"Momentum is stable. Push a high-confidence optimization branch.",d=n.failures>1?"stability_patch":n.latencyMs>1400?"precision_lens":"overclock_core",l=n.failures>0?"failure":"success";return{...e,director:{risk:r,hint:i,recommendedModifier:d,lastOutcome:l}}}function rd(e,n){const s=sc[n];if(!s||e.economy.credits<s.credits||e.economy.materials<s.materials)return e;const r=e.economy.crafted.includes(n)?e.economy.crafted:[...e.economy.crafted,n],i=e.economy.reserveTarget||320,d=e.economy.credits-s.credits;let l={...e,economy:{...e.economy,credits:d,materials:e.economy.materials-s.materials,crafted:r,inflationIndex:Number((d/i).toFixed(3))}};return n==="stability_patch"&&(l={...l,pvp:{...l.pvp,stability:ee(l.pvp.stability+8,0,100)}}),n==="precision_lens"&&(l={...l,raid:{...l.raid,objectives:l.raid.objectives.map((p,u)=>u===0?{...p,progress:ee(p.progress+10,0,p.target),completed:ee(p.progress+10,0,p.target)>=p.target}:p)}}),n==="overclock_core"&&(l={...l,boss:{...l.boss,hp:ee(l.boss.hp-16,0,l.boss.maxHp)}}),Je(l,10)}function id(e,n){const s=Math.round(n),r={...e,guild:{...e.guild,operationsScore:e.guild.operationsScore+s,eventsCompleted:e.guild.eventsCompleted+(s>0?1:0)}},i=s>0?Wt(r,s*3):r;return Je(i,Math.max(0,s*6))}function od(e,n,s,r){const i={id:`event-${e.cinematic.queue.length+1}-${e.seed%1e3}`,type:n,message:s,intensity:r,at:Date.now()};return{...e,cinematic:{queue:[i,...e.cinematic.queue].slice(0,12)}}}function ld(e){const n=Cn(e),s=n.week+1,r=gr(e.seed,s),i=ee(n.difficultyFactor??1,.6,1.6),d=ee(n.rewardMultiplier??1,.5,2),l={...r,goal:Math.max(1,Math.round(r.goal*i)),rewardCredits:Math.max(1,Math.round(r.rewardCredits*d))},p={...e,liveops:{...n,week:s,challenge:l}};return pc(p)}function cd(e,n){const s=Cn(e),r=s.challenge,i=ee(n,0,20),d=ee(r.progress+i,0,r.goal),l=d>=r.goal,p={...e,liveops:{...s,challenge:{...r,progress:d,completed:l}}};return!l||r.completed?p:Je(Wt(p,r.rewardCredits),80)}function uc(e,n,s="raid_mastery"){const r=xr(e),i=new Date().toISOString().slice(0,10);return n==="daily"?r.dailyClaimedOn===i?{allowed:!1,reason:"Daily reward already claimed today."}:{allowed:!0,reason:"Daily reward available."}:n==="session"?r.sessionClaimed?{allowed:!1,reason:"Session reward already claimed."}:e.raid.objectives.some(p=>p.progress>0)||e.campaign.depth>1||e.pvp.round>0?{allowed:!0,reason:"Session reward available."}:{allowed:!1,reason:"Session reward requires gameplay activity."}:n==="streak"?r.streakDays<3?{allowed:!1,reason:"Streak reward requires 3+ daily claims."}:r.streakClaimedFor>=r.streakDays?{allowed:!1,reason:"Streak reward already claimed for current streak."}:{allowed:!0,reason:"Streak reward available."}:r.masteryClaims.includes(s)?{allowed:!1,reason:"Mastery reward already claimed."}:(s==="raid_mastery"?e.raid.completed:s==="campaign_mastery"?e.campaign.depth>=4:e.boss.hp<=0)?{allowed:!0,reason:"Mastery reward available."}:{allowed:!1,reason:"Mastery requirement not met."}}function dd(e,n,s="raid_mastery"){if(!uc(e,n,s).allowed)return e;const i=xr(e),d=new Date().toISOString().slice(0,10);let l=i,p=0,u={};if(n==="daily"){const x=i.dailyClaimedOn===d?i.streakDays:i.streakDays+1;l={...i,dailyClaimedOn:d,streakDays:x},p=90+Math.min(7,x)*10,u={streakDays:x}}else n==="session"?(l={...i,sessionClaimed:!0},p=140,u={actions:e.pvp.round+e.narrative.history.length+e.campaign.depth}):n==="streak"?(l={...i,streakClaimedFor:i.streakDays},p=170+i.streakDays*5,u={streakDays:i.streakDays}):(l={...i,masteryClaims:[...i.masteryClaims,s]},p=s==="boss_mastery"?260:s==="campaign_mastery"?220:180,u={masteryId:s});const m=Wt({...e,rewards:l},p),g=Math.max(1,m.economy.credits-e.economy.credits),f={id:`reward-${l.history.length+1}-${e.seed%1e3}`,kind:n,amount:g,at:Date.now(),details:u};return Je({...m,rewards:{...l,history:[f,...l.history].slice(0,60)}},30+Math.max(1,Math.round(g/10)))}function ud(e,n){const s=Cn(e),r=ee(n.difficultyFactor,.6,1.6),i=ee(n.rewardMultiplier,.5,2),d=s.difficultyFactor||1,l=s.rewardMultiplier||1,p=n.note.trim()||"Operator tuning update",u={...s.challenge,goal:Math.max(1,Math.round(s.challenge.goal/d*r)),rewardCredits:Math.max(1,Math.round(s.challenge.rewardCredits/l*i))},m={id:`tuning-${s.tuningHistory.length+1}-${e.seed%1e3}`,changedAt:Date.now(),difficultyFactor:r,rewardMultiplier:i,note:p};return{...e,liveops:{...s,challenge:u,difficultyFactor:r,rewardMultiplier:i,tuningHistory:[m,...s.tuningHistory].slice(0,20)}}}function Wt(e,n){if(n<=0)return e;const s=e.economy.reserveTarget||320,r=e.economy.credits;let i=1;if(r<=s){const g=Math.min(.12,(s-r)/s*.12);i=Math.min(1.12,1+g)}else{const g=(r-s)/s;i=Math.max(.45,1-g*.35)}const d=Math.max(1,Math.round(n*i)),l=Math.round(s*1.7),p=r+d,u=p>l?Math.max(1,Math.round((p-l)*.22)):0,m=p-u;return{...e,economy:{...e.economy,credits:m,inflationIndex:Number((m/s).toFixed(3))}}}function pc(e){const n=e.economy.reserveTarget||320;if(e.economy.credits<=n)return{...e,economy:{...e.economy,inflationIndex:Number((e.economy.credits/n).toFixed(3))}};const s=Math.max(6,Math.round((e.economy.credits-n)*.08)),r=Math.max(0,e.economy.credits-s);return{...e,economy:{...e.economy,credits:r,inflationIndex:Number((r/n).toFixed(3))}}}function Cn(e){var n,s,r,i,d,l;return{season:((n=e.liveops)==null?void 0:n.season)??"Season-2026",week:((s=e.liveops)==null?void 0:s.week)??1,challenge:((r=e.liveops)==null?void 0:r.challenge)??{id:"fallback-liveops",title:"Complete one objective",goal:1,progress:0,rewardCredits:100,completed:!1},difficultyFactor:((i=e.liveops)==null?void 0:i.difficultyFactor)??1,rewardMultiplier:((d=e.liveops)==null?void 0:d.rewardMultiplier)??1,tuningHistory:((l=e.liveops)==null?void 0:l.tuningHistory)??[]}}function xr(e){return e.rewards??{dailyClaimedOn:null,streakDays:0,sessionClaimed:!1,streakClaimedFor:0,masteryClaims:[],history:[]}}function mc(e){return e.teamComms??{pings:[]}}function wa(e){return e.trim().toLowerCase()}function Mn(e){return e.safety??{mutedPlayerIds:[],blockedPlayerIds:[],reports:[]}}function pd(e,n,s,r="director"){const i=n,d=(s??"").trim(),l=d.length>0;if(l&&!e.raid.objectives.some(m=>m.id===d))return e;const p=mc(e),u={id:`ping-${p.pings.length+1}-${e.seed%1e3}`,fromPlayerId:wa(r)||"director",intent:i,targetObjectiveId:l?d:null,createdAt:Date.now()};return{...e,teamComms:{pings:[u,...p.pings].slice(0,50)}}}function In(e){return e.outcome??{status:"in_progress",reason:"Run in progress.",updatedAt:Date.now()}}function hc(e){return e.sandbox??{enabled:!1}}function vr(e){return e.progression??{xp:0,level:1,nextLevelXp:200,milestones:[]}}function Je(e,n){if(n<=0)return e;const s=vr(e);let r=s.xp+n,i=s.level,d=s.nextLevelXp,l=0;for(;r>=d;)r-=d,i+=1,l+=1,d=i*200;const p=[...s.milestones];return[3,5,10].forEach(u=>{const m=`milestone-level-${u}`;i>=u&&!p.includes(m)&&p.push(m)}),{...e,progression:{xp:r,level:i,nextLevelXp:d,milestones:p},skills:{...e.skills,points:e.skills.points+l}}}function md(e,n,s){const r=wa(n),i=s.trim();if(!r||!i)return e;const d=Mn(e),l={id:`report-${d.reports.length+1}-${e.seed%1e3}`,targetPlayerId:r,reason:i,createdAt:Date.now()};return{...e,safety:{...d,reports:[l,...d.reports].slice(0,40)}}}function hd(e,n){const s=wa(n),r=Mn(e);return!s||r.mutedPlayerIds.includes(s)?e:{...e,safety:{...r,mutedPlayerIds:[...r.mutedPlayerIds,s]}}}function fd(e,n){const s=wa(n),r=Mn(e);return!s||r.blockedPlayerIds.includes(s)?e:{...e,safety:{...r,blockedPlayerIds:[...r.blockedPlayerIds,s],mutedPlayerIds:r.mutedPlayerIds.includes(s)?r.mutedPlayerIds:[...r.mutedPlayerIds,s]}}}const Xs={en:{setup_support_title:"Setup + support",open_setup_wizard:"Open setup wizard",open_support_panel:"Open support panel",telemetry_summary_title:"Telemetry summary",telemetry_summary_body:"Product events are captured in local analytics queue for pre-release UX audits.",export_event_queue:"Export event queue",settings_center_title:"Settings center",settings_center_body:"Centralized controls for input, UX behavior, and safe sharing defaults.",safe_export:"Safe export",gamepad_enabled:"Gamepad enabled",timeline_windowing:"Timeline windowing",theme_label:"Theme",motion_label:"Motion",app_language_label:"App language",gameplay_locale_label:"Gameplay locale",traceql_placeholder:"TraceQL (example: type=tool_call and duration_ms>800)",run_traceql:"Run TraceQL",clear_traceql:"Clear TraceQL",select_extension:"Select extension",run_extension:"Run extension",running_extension:"Running extension...",mode_cinema:"Cinema",mode_flow:"Flow",mode_compare:"Compare",mode_matrix:"Matrix",mode_gameplay:"Gameplay",windowed:"Windowed",overlay:"Overlay",sync_playback:"Sync playback",loading_view:"Loading view...",loading_panel:"Loading panel..."},es:{setup_support_title:"Configuracion y soporte",open_setup_wizard:"Abrir asistente de configuracion",open_support_panel:"Abrir panel de soporte",telemetry_summary_title:"Resumen de telemetria",telemetry_summary_body:"Los eventos de producto se guardan en una cola local para auditorias UX de pre-lanzamiento.",export_event_queue:"Exportar cola de eventos",settings_center_title:"Centro de configuracion",settings_center_body:"Controles centralizados para entradas, UX y opciones seguras de comparticion.",safe_export:"Exportacion segura",gamepad_enabled:"Gamepad habilitado",timeline_windowing:"Ventana de timeline",theme_label:"Tema",motion_label:"Movimiento",app_language_label:"Idioma de la app",gameplay_locale_label:"Idioma de gameplay",traceql_placeholder:"TraceQL (ejemplo: type=tool_call and duration_ms>800)",run_traceql:"Ejecutar TraceQL",clear_traceql:"Limpiar TraceQL",select_extension:"Seleccionar extension",run_extension:"Ejecutar extension",running_extension:"Ejecutando extension...",mode_cinema:"Cine",mode_flow:"Flujo",mode_compare:"Comparar",mode_matrix:"Matriz",mode_gameplay:"Gameplay",windowed:"En ventana",overlay:"Superposicion",sync_playback:"Sincronizar reproduccion",loading_view:"Cargando vista...",loading_panel:"Cargando panel..."}},fc=[{value:"en",label:"English"},{value:"es",label:"Espanol"}];function Zs(e){return e==="es"?"es":"en"}function yc(e,n){var s;return((s=Xs[e])==null?void 0:s[n])??Xs.en[n]}const gc=new Set(["cinema","flow","compare","matrix","gameplay"]);function yn(e){if(!e)return;const n=e.trim();return n.length?n:void 0}function er(e){const n=new URLSearchParams(e),s=yn(n.get("mode")),r=yn(n.get("trace")),i=yn(n.get("step")),d={};return s&&gc.has(s)&&(d.mode=s),r&&(d.traceId=r),i&&(d.stepId=i),d}function bc(e,n){const s=new URL(e);return n.mode?s.searchParams.set("mode",n.mode):s.searchParams.delete("mode"),n.traceId?s.searchParams.set("trace",n.traceId):s.searchParams.delete("trace"),n.stepId?s.searchParams.set("step",n.stepId):s.searchParams.delete("step"),s.toString()}const jn={setupWizardV1:!0,supportPanelV1:!0,exportCenterV1:!0,ownershipPanelV1:!0},wr="agentDirector.analytics.events.v1",jr="agentDirector.featureFlags.v1",xc=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;function vc(e){const n=e.dataSource.trim(),s=e.importPath.trim(),i=e.inviteEmails.split(",").map(u=>u.trim()).filter(Boolean).filter(u=>!xc.test(u)),d=n?null:"Select a data source.",l=s?null:"Import path is required.",p=i.length?`Invalid invite email(s): ${i.join(", ")}`:null;return{dataSourceError:d,importPathError:l,inviteEmailsError:p,isValid:!d&&!l&&!p}}function wc(e,n){const s=n.updatedAt??Date.now(),r={...n,updatedAt:s},i=e.findIndex(l=>l.id===r.id);if(i===-1)return[r,...e].slice(0,12);const d=[...e];return d[i]={...d[i],...r},d.sort((l,p)=>p.updatedAt-l.updatedAt),d.slice(0,12)}function jc(e){try{const n=JSON.parse(e.getItem(wr)??"[]");return Array.isArray(n)?n.filter(s=>{if(!s||typeof s!="object")return!1;const r=s;return typeof r.name=="string"&&typeof r.at=="string"&&typeof r.metadata=="object"}).slice(-250):[]}catch{return[]}}function kc(e,n){const r=[...jc(e),n].slice(-250);return e.setItem(wr,JSON.stringify(r)),r}function Sc(e){var n,s;return{capturedAt:new Date().toISOString(),app:"agent-director",mode:e.mode,traceId:((n=e.trace)==null?void 0:n.id)??null,traceStatus:((s=e.trace)==null?void 0:s.status)??null,stepCount:e.stepCount,selectedStepId:e.selectedStepId,workspaceId:e.workspaceId,workspaceRole:e.workspaceRole,safeExport:e.safeExport,userAgent:typeof navigator<"u"?navigator.userAgent:"unknown",online:typeof navigator<"u"?navigator.onLine:!0,recentNotifications:e.notifications.slice(-6),asyncActions:e.actions.slice(0,8)}}function Nc(e){try{const n=JSON.parse(e.getItem(jr)??"{}");if(!n||typeof n!="object")return{...jn};const s=n;return{setupWizardV1:s.setupWizardV1!==!1,supportPanelV1:s.supportPanelV1!==!1,exportCenterV1:s.exportCenterV1!==!1,ownershipPanelV1:s.ownershipPanelV1!==!1}}catch{return{...jn}}}function Cc(e,n){e.setItem(jr,JSON.stringify(n))}const tr=220,ar=120,kn="agentDirector.presence.v1",Mc=2e4,Ic=5e3,jt="agentDirector.collab.cursors.v1",gn="agentDirector.collab.annotations.v1",bn="agentDirector.collab.activity.v1",Ec=6e3,nr=[{id:"personal",label:"Personal"},{id:"operations",label:"Operations"},{id:"executive",label:"Executive"}],_c=c.lazy(()=>Ht(()=>import("./index-C-CcVsd3.js"),__vite__mapDeps([0,1,2,3]))),Tc=c.lazy(()=>Ht(()=>import("./index-CnXjrZZD.js"),__vite__mapDeps([4,1,2,3]))),Ac=c.lazy(()=>Ht(()=>import("./index-CFo8RPdd.js"),__vite__mapDeps([5,1,2,3]))),Dc=c.lazy(()=>Ht(()=>import("./index-CsPjrfjF.js"),__vite__mapDeps([6,1,2,3]))),$c=c.lazy(()=>Ht(()=>import("./index-BS0oCvFz.js"),__vite__mapDeps([7,1,2,3])));function ga(){return`scenario-${Math.random().toString(36).slice(2,9)}`}function Rc(e){return e.filter(n=>n.parentStepId).map(n=>({source:n.parentStepId,target:n.id}))}function Oc(e){const n=[...e].sort((s,r)=>s.index-r.index);return n.slice(1).map((s,r)=>({source:n[r].id,target:s.id}))}function Pc(e){const n={},s=e.getBoundingClientRect();return e.querySelectorAll(".step-card").forEach(i=>{const d=i.dataset.stepId;if(!d)return;const l=i.getBoundingClientRect();n[d]={left:l.left-s.left,top:l.top-s.top,width:l.width,height:l.height}}),n}function Lc(e,n,s){const r=[...Rc(e),...Oc(e),...Yl(e).map(w=>({source:w.source,target:w.target}))],i=Vl(e,r,s),d=n.getBoundingClientRect(),l=Math.min(...i.map(w=>w.position.x)),p=Math.min(...i.map(w=>w.position.y)),u=Math.max(...i.map(w=>w.position.x)),m=Math.max(...i.map(w=>w.position.y)),g=u-l+tr,f=m-p+ar,x=Math.max(32,(d.width-g)/2),v=Math.max(24,(d.height-f)/2);return i.reduce((w,y)=>(w[y.id]={left:y.position.x-l+x,top:y.position.y-p+v,width:tr,height:ar},w),{})}function sr(e,n,s){const r=n.trim().toLowerCase();return e.filter(i=>{var l,p,u;return s!=="all"&&i.type!==s?!1:r?[i.name,(l=i.preview)==null?void 0:l.title,(p=i.preview)==null?void 0:p.outputPreview,(u=i.preview)==null?void 0:u.inputPreview].filter(Boolean).join(" ").toLowerCase().includes(r):!0})}function Fc(e,n,s){var m,g,f,x,v,w,y,S,N,D,J,I,$,H,F,z,V,ie,k,E,R,U,C,Q,T,q,P,he,Ie,fe;const r=e.profiles[n]??e.profiles[((m=e.players[0])==null?void 0:m.player_id)??""]??Object.values(e.profiles)[0],i=e.players.reduce((j,ye)=>(j[ye.player_id]=ye.role,j),{}),d=Object.entries(e.narrative.nodes).map(([j,ye])=>({id:j,title:ye.title,body:ye.title,choices:ye.choices.map(ce=>({id:ce.id,label:ce.id,nextNodeId:ce.next,tensionDelta:ce.tension,mutator:ce.modifier}))})),l=e.pvp.winner??null,u=e.telemetry.failures>0?"failure":l?"success":"mixed";return{seed:e.seed,raid:{party:e.players.map(j=>j.player_id),roles:i,objectives:e.raid.objectives.map(j=>({id:j.id,label:j.label,progress:j.progress,target:j.target,completed:j.completed})),completed:e.raid.completed},campaign:{depth:e.campaign.depth,lives:e.campaign.lives,currentMission:{id:e.campaign.current_mission.id,title:e.campaign.current_mission.title,difficulty:e.campaign.current_mission.difficulty,hazards:e.campaign.current_mission.hazards,rewardCredits:e.campaign.current_mission.reward_tokens,missionSeed:e.campaign.current_mission.mission_seed??s.campaign.currentMission.missionSeed??e.seed,blueprint:e.campaign.current_mission.blueprint??s.campaign.currentMission.blueprint??`seed=${e.seed};depth=${e.campaign.depth}`,templateId:e.campaign.current_mission.template_id??s.campaign.currentMission.templateId,archetype:e.campaign.current_mission.archetype??s.campaign.currentMission.archetype,qualityScore:e.campaign.current_mission.quality_score??s.campaign.currentMission.qualityScore,noveltyScore:e.campaign.current_mission.novelty_score??s.campaign.currentMission.noveltyScore,repetitionPenalty:e.campaign.current_mission.repetition_penalty??s.campaign.currentMission.repetitionPenalty,launchPackSize:e.campaign.current_mission.launch_pack_size??s.campaign.currentMission.launchPackSize},completedMissionIds:e.campaign.completed_missions,missionHistory:((g=e.campaign.mission_history)==null?void 0:g.map(j=>({missionId:j.mission_id,templateId:j.template_id??"legacy-template",archetype:j.archetype??"legacy",hazards:j.hazards??[],qualityScore:j.quality_score??50,noveltyScore:j.novelty_score??50,repetitionPenalty:j.repetition_penalty??0,outcome:j.outcome==="success"||j.outcome==="failure"?j.outcome:"unknown"})))??s.campaign.missionHistory,mutators:[...e.campaign.modifiers,...e.campaign.unlocked_modifiers]},narrative:{currentNodeId:e.narrative.current_node_id,nodes:d.length>0?d:s.narrative.nodes,history:e.narrative.history.map(j=>({nodeId:j.node_id,choiceId:j.choice_id})),tension:e.narrative.tension},skills:{points:(r==null?void 0:r.skill_points)??s.skills.points,nodes:s.skills.nodes.map(j=>({...j,unlocked:!!(r!=null&&r.unlocked_skills.includes(j.id))})),loadout:{capacity:(r==null?void 0:r.loadout_capacity)??s.skills.loadout.capacity,equipped:(r==null?void 0:r.loadout)??[],slotCaps:s.skills.loadout.slotCaps}},pvp:{round:e.pvp.round,stability:e.pvp.operator_stability,sabotage:e.pvp.sabotage_pressure,fog:e.pvp.fog,winner:l},time:{activeForkId:e.time.active_fork_id,forks:e.time.forks.map(j=>({id:j.id,label:j.label,playheadMs:j.playhead_ms,history:j.history}))},boss:{name:e.boss.name,phase:e.boss.phase,hp:e.boss.hp,maxHp:e.boss.max_hp,enraged:e.boss.enraged,phaseMechanic:e.boss.phase_mechanic??(e.boss.phase===1?"Phase 1: Shield lattice destabilization":e.boss.phase===2?"Phase 2: Mirror clones absorb exploit damage":"Phase 3: Enrage pulse; shield counters become lethal"),vulnerability:e.boss.vulnerability==="strike"||e.boss.vulnerability==="shield"||e.boss.vulnerability==="exploit"?e.boss.vulnerability:e.boss.phase===1?"exploit":e.boss.phase===2?"strike":"shield"},director:{risk:e.director.risk,hint:e.director.hint,recommendedModifier:e.director.hazard_bias,lastOutcome:u},economy:{credits:e.economy.tokens,materials:e.economy.materials,crafted:e.economy.crafted,reserveTarget:((f=e.economy.policy)==null?void 0:f.target_reserve)??s.economy.reserveTarget??320,inflationIndex:e.economy.inflation_index??Number((e.economy.tokens/(((x=e.economy.policy)==null?void 0:x.target_reserve)??s.economy.reserveTarget??320)).toFixed(3))},rewards:{dailyClaimedOn:((v=e.rewards)==null?void 0:v.daily_claimed_date)??((w=s.rewards)==null?void 0:w.dailyClaimedOn)??null,streakDays:((y=e.rewards)==null?void 0:y.streak_days)??((S=s.rewards)==null?void 0:S.streakDays)??0,sessionClaimed:((N=e.rewards)==null?void 0:N.session_claimed)??((D=s.rewards)==null?void 0:D.sessionClaimed)??!1,streakClaimedFor:((J=e.rewards)==null?void 0:J.streak_claimed_for)??((I=s.rewards)==null?void 0:I.streakClaimedFor)??0,masteryClaims:(($=e.rewards)==null?void 0:$.mastery_claims)??((H=s.rewards)==null?void 0:H.masteryClaims)??[],history:((z=(F=e.rewards)==null?void 0:F.history)==null?void 0:z.map(j=>({id:j.id,kind:j.kind==="daily"||j.kind==="session"||j.kind==="streak"||j.kind==="mastery"?j.kind:"daily",amount:j.amount,at:Date.parse(j.at)||Date.now(),details:j.details?Object.fromEntries(Object.entries(j.details).map(([ye,ce])=>[ye,String(ce)])):{}})))??((V=s.rewards)==null?void 0:V.history)??[]},guild:{name:e.guild.guild_id??"Trace Guild",members:e.players.length,operationsScore:e.guild.operations_score,eventsCompleted:e.guild.events_completed},cinematic:{queue:e.cinematic.events.map(j=>({id:j.id,type:j.type==="critical"||j.type==="success"||j.type==="warning"||j.type==="twist"?j.type:"warning",message:j.message,intensity:j.intensity||1,at:Date.parse(j.at)||Date.now()}))},liveops:{season:e.liveops.season,week:e.liveops.week,challenge:{id:e.liveops.challenge.id,title:e.liveops.challenge.title,goal:e.liveops.challenge.goal,progress:e.liveops.challenge.progress,rewardCredits:e.liveops.challenge.reward,completed:e.liveops.challenge.completed},difficultyFactor:e.liveops.telemetry.difficultyFactor??s.liveops.difficultyFactor??1,rewardMultiplier:e.liveops.telemetry.rewardMultiplier??s.liveops.rewardMultiplier??1,tuningHistory:((ie=e.liveops.tuning_history)==null?void 0:ie.map(j=>({id:j.id,changedAt:Date.parse(j.changed_at)||Date.now(),difficultyFactor:j.difficultyFactor,rewardMultiplier:j.rewardMultiplier,note:j.note})))??s.liveops.tuningHistory??[]},teamComms:{pings:((E=(k=e.team_comms)==null?void 0:k.pings)==null?void 0:E.map(j=>({id:j.id,fromPlayerId:j.from_player_id,intent:j.intent==="focus"||j.intent==="assist"||j.intent==="defend"||j.intent==="rotate"?j.intent:"focus",targetObjectiveId:j.target_objective_id??null,createdAt:Date.parse(j.created_at)||Date.now()})))??s.teamComms.pings??[]},safety:{mutedPlayerIds:((R=e.safety)==null?void 0:R.muted_player_ids)??s.safety.mutedPlayerIds??[],blockedPlayerIds:((U=e.safety)==null?void 0:U.blocked_player_ids)??s.safety.blockedPlayerIds??[],reports:((Q=(C=e.safety)==null?void 0:C.reports)==null?void 0:Q.map(j=>({id:j.id,targetPlayerId:j.target_player_id,reason:j.reason,createdAt:Date.parse(j.created_at)||Date.now()})))??s.safety.reports??[]},outcome:e.status==="completed"?{status:e.telemetry.successes>=e.telemetry.failures?"win":"loss",reason:e.telemetry.successes>=e.telemetry.failures?"Session completed with positive outcomes.":"Session completed with unresolved failures.",updatedAt:Date.now()}:e.telemetry.failures>0?{status:"partial",reason:`${e.telemetry.failures} failure signals observed; run still active.`,updatedAt:Date.now()}:s.outcome??{status:"in_progress",reason:"Run in progress.",updatedAt:Date.now()},sandbox:{enabled:((T=e.sandbox)==null?void 0:T.enabled)??((q=s.sandbox)==null?void 0:q.enabled)??!1},progression:{xp:(r==null?void 0:r.xp)??((P=s.progression)==null?void 0:P.xp)??0,level:(r==null?void 0:r.level)??((he=s.progression)==null?void 0:he.level)??1,nextLevelXp:((r==null?void 0:r.level)??((Ie=s.progression)==null?void 0:Ie.level)??1)*200,milestones:(r==null?void 0:r.milestones)??((fe=s.progression)==null?void 0:fe.milestones)??[]}}}function qc(){const e=window.sessionStorage.getItem("agentDirector.sessionId");if(e)return e;const n=`session-${Math.random().toString(36).slice(2,10)}`;return window.sessionStorage.setItem("agentDirector.sessionId",n),n}function rr(){try{const e=window.localStorage.getItem(kn);if(!e)return{};const n=JSON.parse(e),s={};return Object.entries(n).forEach(([r,i])=>{typeof i=="number"&&(s[r]=i)}),s}catch{return{}}}function ir(e,n=Date.now()){return Object.fromEntries(Object.entries(e).filter(([,s])=>n-s<Mc))}function Gc(){var ws,js;const{trace:e,insights:n,loading:s,error:r,reload:i,traces:d,selectedTraceId:l,setSelectedTraceId:p}=Wl(),[u,m]=K("agentDirector.mode","cinema"),[g,f]=K("agentDirector.workspaceSection.v1","journey"),[x,v]=c.useState(""),w=c.useDeferredValue(x),[y,S]=c.useState("all"),[N,D]=c.useState(""),[J,I]=c.useState(null),[$,H]=c.useState(null),[F,z]=c.useState(null),[V,ie]=c.useState([]),[k,E]=c.useState(""),[R,U]=c.useState(null),[C,Q]=c.useState(!1),[T,q]=c.useState(null),[P,he]=K("agentDirector.safeExport",!1),[Ie,fe]=K("agentDirector.syncPlayback",!0),[j,ye]=c.useState(null),[ce,A]=c.useState(!1),[Y,ke]=c.useState(0),[dt,De]=K("agentDirector.speed",1),[Le,$e]=K("agentDirector.windowed",!1),[_,te]=c.useState(2e4),[be,Se]=c.useState(!1),[St,Fe]=c.useState(!1),[Nt,Ee]=K("agentDirector.overlayEnabled",!1),[kr,Sr]=K("agentDirector.onboarded",!1),[,ut]=K("agentDirector.tourCompleted",!1),[Re,Ne]=K("agentDirector.explainMode",!0),[ja,ka]=K("agentDirector.heroDismissed",!1),[Nr,Sa]=K("agentDirector.dockOpen",!1),[xe,Cr]=K("agentDirector.introPersona","builder"),[Na,Ca]=K("agentDirector.launchPath","rapid_triage"),[Ct,En]=K("agentDirector.themeMode","studio"),[Jt,_n]=K("agentDirector.motionMode","balanced"),[Ma,Mr]=K("agentDirector.workspaceId.v1",nr[0].id),[Vt,Ir]=K("agentDirector.workspaceRole.v1","operator"),[Tn,An]=K("agentDirector.sessionExpiresAt.v1",Date.now()+1e3*60*60*4),[me,Dn]=K("agentDirector.timelineLaneStrategy","type"),[$n,pt]=K("agentDirector.timelineStudioConfig",zt),[Kt,ve]=K("agentDirector.missions",{playback:!1,flow:!1,inspect:!1,matrix:!1,replay:!1,annotate:!1,collaborate:!1}),Qt=!1,[mt,Yt]=K("agentDirector.introDismissed",Qt),[Ia,ht]=c.useState(!1),[Ve,Ea]=c.useState("source"),[Ke,_a]=K("agentDirector.setupWizardDraft.v1",{dataSource:"",importPath:"",inviteEmails:""}),[Rn,On]=K("agentDirector.setupWizardComplete.v1",!1),[Pn,Ln]=K("agentDirector.setupWizardPrompted.v1",!1),[Ta,ge]=c.useState(!1),[ae,Xt]=c.useState(null),[Zt,Aa]=c.useState([]),[Da,$a]=c.useState(null),[Er,Fn]=c.useState(null),[Ra,Oa]=c.useState(""),[Pa,at]=c.useState([{id:ga(),name:"Prompt tighter",strategy:"hybrid",modificationsText:'{"prompt":"Return concise response"}'},{id:ga(),name:"Recorded baseline",strategy:"recorded",modificationsText:"{}"}]),[Qe,La]=c.useState(null),[Ce,qn]=c.useState(null),[_r,ea]=c.useState(!1),[ta,Mt]=c.useState(null),[se,It]=K("agentDirector.gameplayState.v1",Ys("bootstrap")),[ue,Gn]=K("agentDirector.gameplayTraceId.v1",""),[_e]=K("agentDirector.gameplayPlayerId.v1",`player-${Math.random().toString(36).slice(2,8)}`),[Me,Ye]=K("agentDirector.gameplaySessionId.v1",""),[de,Oe]=c.useState(null),[aa,X]=c.useState(null),[Tr,ft]=c.useState(null),[Ar,na]=c.useState(null),[zn,Dr]=K("agentDirector.locale.v1","en"),[Bn,Hn]=K("agentDirector.gameplayLocale.v1","en"),[sa,Un]=K("agentDirector.gamepad.enabled.v1",!0),[Fa,$r]=K("agentDirector.gamepad.preset.v1","standard"),[ra,ia]=K("agentDirector.shortcuts.bindings.v1",_o),[Rr,Wn]=c.useState(typeof navigator>"u"?!0:navigator.onLine),[Or,Jn]=c.useState(null),[Pr,Vn]=c.useState(null),[qa,Kn]=c.useState(1),[oa,Ga]=c.useState(null),[yt,za]=c.useState(null),[Et,Ba]=c.useState([]),[la,Lr]=c.useState([]),[Qn,Ha]=c.useState([]),[Pe,ca]=K("agentDirector.savedViews.v1",[]),[nt,Yn]=c.useState(""),[Ge,da]=c.useState(""),[Ua,_t]=c.useState(!1),[Tt,Fr]=c.useState(""),[At,qr]=K("agentDirector.runOwner.v1","on-call-operator"),[Dt,Gr]=K("agentDirector.handoffOwner.v1",""),[pe,Xn]=c.useState(jn),[ua,Wa]=c.useState(null),[$t,Ja]=c.useState(null),[Zn,Va]=c.useState({}),[es,Ka]=c.useState([]),[Qa,Ya]=c.useState([]),[Rt,Xa]=c.useState(800),[zr,Br]=c.useState(0),Za=c.useRef(null),ts=c.useRef(null),gt=c.useRef(qc()),as=c.useRef(0),ns=c.useRef(0),en=c.useRef(!1),ss=c.useRef({}),pa=c.useRef({}),rs=c.useRef({}),is=c.useRef({}),os=c.useRef({}),tn=c.useRef({}),ls=c.useRef({}),Hr=c.useRef(er(typeof window>"u"?"":window.location.search)),an=c.useRef(!1),st=c.useMemo(()=>xn(ra),[ra]),nn=c.useMemo(()=>Zs(zn),[zn]),Z=c.useCallback(a=>yc(nn,a),[nn]),ze=c.useMemo(()=>{if(!e)return[];const a=performance.now(),o=sr(e.steps,w,y);return ns.current=performance.now()-a,o},[e,w,y]),sn=c.useMemo(()=>ze.slice(0,Math.min(ze.length,Rt)),[Rt,ze]),cs=c.useMemo(()=>{if(!J)return sn;const a=new Set(J.matchedStepIds);return sn.filter(o=>a.has(o.id))},[sn,J]),Ur=c.useMemo(()=>j?sr(j.steps,w,y).slice(0,Math.min(j.steps.length,Rt)):[],[j,w,y,Rt]),ds=c.useMemo(()=>e?Xl(e.startedAt,e.endedAt,e.steps):[],[e]),Wr=c.useMemo(()=>!e||!j?null:pr(e,j),[e,j]),us=c.useMemo(()=>e?e.steps.find(a=>a.id===T)??null:null,[e,T]),Ot=c.useMemo(()=>e?fo(e.steps,me):[],[e,me]),bt=c.useMemo(()=>{const a=$n[me]??zt[me];return Cs(Ot,a.order,a.hidden)},[Ot,me,$n]),Jr=c.useMemo(()=>bt.order.filter(a=>!bt.hidden.includes(a)),[bt.hidden,bt.order]),ma=c.useMemo(()=>{const a=gt.current;return Object.values(Zn).filter(o=>o.sessionId!==a).filter(o=>o.traceId===((e==null?void 0:e.id)??"none")).sort((o,h)=>h.updatedAt-o.updatedAt)},[Zn,e==null?void 0:e.id]),Vr=c.useMemo(()=>ma.map(a=>a.playheadMs),[ma]),Kr=c.useMemo(()=>es.filter(a=>a.traceId===(e==null?void 0:e.id)),[es,e==null?void 0:e.id]),ps=c.useMemo(()=>{const a=Object.keys(Kt).length,o=Object.values(Kt).filter(Boolean).length;return{done:o,total:a,pct:a>0?Math.round(o/a*100):0}},[Kt]),Pt=c.useMemo(()=>{var O;if(!e)return 100;const a=100,o=Math.min(60,((n==null?void 0:n.errors)??0)*16),h=Math.min(24,((n==null?void 0:n.retries)??0)*6),b=e.metadata.wallTimeMs>6e4?12:e.metadata.wallTimeMs>3e4?6:0,M=(O=n==null?void 0:n.timing)!=null&&O.degraded?8:0;return Math.max(0,Math.min(100,Math.round(a-o-h-b-M)))},[n==null?void 0:n.errors,n==null?void 0:n.retries,(ws=n==null?void 0:n.timing)==null?void 0:ws.degraded,e]),Qr=c.useMemo(()=>u==="flow"?"F / C / Space":u==="compare"?"C / Space / ← →":u==="matrix"?"G / C / Cmd+K":u==="gameplay"?"G / S / Cmd+K":"C / F / Space",[u]),rt=c.useMemo(()=>{const a=Tn-Date.now(),o=Math.max(0,Math.ceil(a/6e4));return{expired:a<=0,remainingMinutes:o,label:a<=0?"Expired":`${o}m left`}},[Tn]),Be=c.useMemo(()=>vc(Ke),[Ke]),Lt=c.useMemo(()=>nt.trim()?Pe.some(o=>o.name.toLowerCase()===nt.trim().toLowerCase())?"Saved view name already exists.":null:"Saved view name is required.",[nt,Pe]),ha=c.useMemo(()=>Sc({trace:e,selectedStepId:T,mode:u,workspaceId:Ma,workspaceRole:Vt,safeExport:P,notifications:Et.map(a=>({message:a.message,level:a.level})),actions:la,stepCount:(e==null?void 0:e.steps.length)??0}),[la,u,Et,P,T,e,Ma,Vt]),ne=c.useCallback((a,o="info")=>{const h=a.trim();if(!h)return;const b=Date.now();Ba(M=>M.some(W=>W.message===h&&W.level===o)?M:[...M,{id:`notif-${b}-${Math.random().toString(36).slice(2,8)}`,message:h,level:o,expiresAt:b+Ec}].slice(-6))},[]),B=c.useCallback((a,o={})=>{try{kc(window.localStorage,{name:a,at:new Date().toISOString(),metadata:o})}catch{}},[]),xt=c.useCallback(a=>{Lr(o=>wc(o,a))},[]),Ft=c.useCallback(async a=>{os.current[a.id]=()=>{Ft(a)},Ha(o=>{const h=o.find(M=>M.id===a.id),b={id:a.id,label:a.label,status:"running",detail:"Running",updatedAt:Date.now(),retryable:!1};return h?[b,...o.filter(M=>M.id!==a.id)].slice(0,8):[b,...o].slice(0,8)}),B("ux.export.queued",{taskId:a.id,label:a.label});try{a.run(),Ha(o=>o.map(h=>h.id===a.id?{...h,status:"success",detail:"Completed",updatedAt:Date.now(),retryable:!1}:h)),B("ux.export.completed",{taskId:a.id,label:a.label})}catch(o){const h=o instanceof Error?o.message:"Export failed";Ha(b=>b.map(M=>M.id===a.id?{...M,status:"error",detail:h,updatedAt:Date.now(),retryable:!0}:M)),ne(`Export failed: ${a.label}`,"error"),B("ux.export.failed",{taskId:a.id,label:a.label,detail:h})}},[ne,B]),Xe=c.useCallback((a,o,h)=>{const b=`confirm-${Math.random().toString(36).slice(2,9)}`;tn.current[b]=h,Wa({id:b,title:a,message:o})},[]),ms=c.useCallback((a,o)=>{const h=`undo-${Math.random().toString(36).slice(2,9)}`;ls.current[h]=o,Ja({id:h,label:a})},[]),hs=Vt!=="viewer"&&!rt.expired,re=c.useCallback(a=>hs?!0:(rt.expired?ne(`Session expired. Renew session to ${a}.`,"warning"):ne(`Viewer role cannot ${a}. Switch role to operator or admin.`,"warning"),!1),[ne,hs,rt.expired]),Yr=c.useCallback(a=>{Ba(o=>o.filter(h=>h.id!==a))},[]),Xr=c.useCallback(()=>{An(Date.now()+1e3*60*60*4),ne("Session renewed for 4 hours.","success")},[ne,An]);c.useEffect(()=>{Xn(Nc(window.localStorage))},[]),c.useEffect(()=>{pe.setupWizardV1&&window.localStorage.getItem("agentDirector.setupWizardAuto")==="1"&&(!mt||Rn||Ia||Pn||(ht(!0),Ln(!0),B("ux.setup.opened",{source:"auto"})))},[pe.setupWizardV1,mt,Ln,Rn,Ia,Pn,B]),c.useEffect(()=>{if(!$t)return;const a=window.setTimeout(()=>{Ja(null)},6e3);return()=>window.clearTimeout(a)},[$t]),c.useEffect(()=>{const a=h=>{B("ux.error.window",{message:h.message,filename:h.filename,line:h.lineno})},o=h=>{const b=h.reason instanceof Error?h.reason.message:String(h.reason??"unknown");B("ux.error.window",{kind:"unhandledrejection",reason:b})};return window.addEventListener("error",a),window.addEventListener("unhandledrejection",o),()=>{window.removeEventListener("error",a),window.removeEventListener("unhandledrejection",o)}},[B]),c.useEffect(()=>{if(an.current)return;const a=Hr.current;if(!a.mode&&!a.traceId&&!a.stepId){an.current=!0;return}if(a.mode&&a.mode!==u&&m(a.mode),a.traceId){if(!d.some(h=>h.id===a.traceId))return;if(l!==a.traceId){p(a.traceId);return}}a.stepId&&(e!=null&&e.steps.some(o=>o.id===a.stepId))&&T!==a.stepId&&q(a.stepId),an.current=!0},[u,T,l,m,p,e==null?void 0:e.steps,d]),c.useEffect(()=>{if(typeof window>"u")return;const a=bc(window.location.href,{mode:u,traceId:l??void 0,stepId:T??void 0});a!==window.location.href&&window.history.replaceState(null,"",a)},[u,T,l]),c.useEffect(()=>{if(!Et.length)return;const a=window.setInterval(()=>{const o=Date.now();Ba(h=>h.filter(b=>b.expiresAt>o))},1e3);return()=>{window.clearInterval(a)}},[Et.length]),c.useEffect(()=>{oa&&ne(oa,"success")},[ne,oa]),c.useEffect(()=>{St&&B("ux.palette.opened",{section:g,mode:u})},[g,u,St,B]),c.useEffect(()=>{yt&&ne(yt,"success")},[ne,yt]),c.useEffect(()=>{ta&&ne(ta,"error")},[ne,ta]),c.useEffect(()=>{$&&ne($,"warning")},[ne,$]),c.useEffect(()=>{aa&&ne(aa,"warning")},[ne,aa]),c.useEffect(()=>{rt.expired&&ne("Workspace session expired. Renew to continue write actions.","warning")},[ne,rt.expired]),c.useEffect(()=>{e&&e.id!==ue&&(It(Ys(e.id)),Gn(e.id))},[ue,It,Gn,e]),c.useEffect(()=>{let a=!1;if(!Me){Oe(null);return}return hn().then(o=>{a||(Oe(o),o||X("Gameplay session not found."))}),()=>{a=!0}},[Me]),c.useEffect(()=>{if(!Me)return;const a=Ul();return()=>a()},[Me]),c.useEffect(()=>{de&&It(a=>Fc(de,_e,a))},[_e,de,It]),c.useEffect(()=>{let a=!1;if(!(de==null?void 0:de.guild.guild_id)){ft(null);return}return Gl().then(h=>{a||ft(h)}),()=>{a=!0}},[de==null?void 0:de.guild.guild_id]),c.useEffect(()=>{let a=!1;return zs().then(o=>{a||o&&na(o)}),()=>{a=!0}},[_e,de==null?void 0:de.id]),c.useEffect(()=>{if(typeof window>"u")return;const a=()=>Wn(!0),o=()=>Wn(!1);return window.addEventListener("online",a),window.addEventListener("offline",o),()=>{window.removeEventListener("online",a),window.removeEventListener("offline",o)}},[]),c.useEffect(()=>{if(!sa){pa.current={};return}if(typeof navigator>"u"||typeof navigator.getGamepads!="function")return;const a=Fa==="lefty"?{playPause:1,palette:3,modeCycle:2,speedDown:6,speedUp:7}:{playPause:0,palette:2,modeCycle:3,speedDown:4,speedUp:5},o=["cinema","flow","compare","matrix","gameplay"];let h=0;const b=(O,W,L)=>{const le=!!pa.current[W];O&&!le&&L(),pa.current[W]=O},M=()=>{var W,L,le,je,ks;const O=navigator.getGamepads()[0];O&&(b(!!((W=O.buttons[a.playPause])!=null&&W.pressed),"playPause",()=>A(lt=>!lt)),b(!!((L=O.buttons[a.palette])!=null&&L.pressed),"palette",()=>Fe(!0)),b(!!((le=O.buttons[a.modeCycle])!=null&&le.pressed),"modeCycle",()=>{m(lt=>{const Ji=o.indexOf(lt);return o[(Ji+1)%o.length]})}),b(!!((je=O.buttons[a.speedDown])!=null&&je.pressed),"speedDown",()=>{De(lt=>Math.max(.25,Number((lt-.25).toFixed(2))))}),b(!!((ks=O.buttons[a.speedUp])!=null&&ks.pressed),"speedUp",()=>{De(lt=>Math.min(3,Number((lt+.25).toFixed(2))))})),h=window.requestAnimationFrame(M)};return h=window.requestAnimationFrame(M),()=>{window.cancelAnimationFrame(h),pa.current={}}},[sa,Fa,m,De]),c.useEffect(()=>{let a=!1;const o=async()=>{const[b,M]=await Promise.all([Bs(),Hs()]);a||(b&&Jn(b),M&&Vn(M))};o();const h=window.setInterval(()=>{o()},3e4);return()=>{a=!0,window.clearInterval(h)}},[]),c.useEffect(()=>{I(null),H(null)},[e==null?void 0:e.id]),c.useEffect(()=>{const a=Math.round(ns.current);Br(a),a>0&&B("ux.perf.filter_ms",{ms:a,steps:ze.length})},[ze,B]),c.useEffect(()=>{if(!e)return;const a=ze.length;if(a<=1200){Xa(a);return}Xa(800);const o=window.setInterval(()=>{Xa(h=>h>=a?(window.clearInterval(o),a):Math.min(a,h+1e3))},70);return()=>window.clearInterval(o)},[ze.length,e]),c.useEffect(()=>{let a=!1;if(!(e!=null&&e.id)){z(null);return}return Nl(e.id).then(o=>{a||z(o)}),()=>{a=!0}},[e==null?void 0:e.id]),c.useEffect(()=>{let a=!1;return Cl().then(o=>{a||(ie(o),!k&&o.length>0&&E(o[0].id))}),()=>{a=!0}},[k]),c.useEffect(()=>{ts.current=j},[j]),c.useEffect(()=>(document.body.dataset.theme=Ct,()=>{delete document.body.dataset.theme}),[Ct]),c.useEffect(()=>(document.body.dataset.motion=Jt,()=>{delete document.body.dataset.motion}),[Jt]),c.useEffect(()=>{const a=gt.current,o=(L=!1)=>{const le=Date.now(),je=ir(rr(),le);L?delete je[a]:je[a]=le,window.localStorage.setItem(kn,JSON.stringify(je)),Kn(Math.max(1,Object.keys(je).length))},h=()=>{const L=ir(rr(),Date.now());Kn(Math.max(1,Object.keys(L).length))};o();const b=window.setInterval(()=>o(),Ic),M=L=>{L.key===kn&&h()},O=()=>{document.visibilityState==="visible"&&o()},W=()=>o(!0);return window.addEventListener("storage",M),document.addEventListener("visibilitychange",O),window.addEventListener("beforeunload",W),()=>{window.clearInterval(b),o(!0),window.removeEventListener("storage",M),document.removeEventListener("visibilitychange",O),window.removeEventListener("beforeunload",W)}},[]),c.useEffect(()=>{u==="compare"&&Sa(!1)},[u,Sa]),c.useEffect(()=>{Ot.length!==0&&pt(a=>{const o=a[me]??zt[me],h=Cs(Ot,o.order,o.hidden);return h.order.join("|")===o.order.join("|")&&h.hidden.join("|")===o.hidden.join("|")?a:{...a,[me]:h}})},[Ot,me,pt]),c.useEffect(()=>{Va(tt(window.localStorage.getItem(jt),{})),Ka(tt(window.localStorage.getItem(gn),[])),Ya(tt(window.localStorage.getItem(bn),[]))},[]),c.useEffect(()=>{const a=Date.now();if(a-as.current<120&&ce)return;as.current=a;const o=gt.current,h={sessionId:o,traceId:(e==null?void 0:e.id)??"none",mode:u,playheadMs:Math.round(Y),selectedStepId:T,updatedAt:a},M={...tt(window.localStorage.getItem(jt),{}),[o]:h};window.localStorage.setItem(jt,JSON.stringify(M)),Va(M)},[ce,u,Y,T,e==null?void 0:e.id]),c.useEffect(()=>{const a=gt.current;return()=>{const o=tt(window.localStorage.getItem(jt),{});if(!o[a])return;const h={...o};delete h[a],window.localStorage.setItem(jt,JSON.stringify(h))}},[]),c.useEffect(()=>{const a=o=>{if(o.key===jt&&Va(tt(o.newValue,{})),o.key===gn){const h=tt(o.newValue,[]);Ka(b=>Js(b,h))}o.key===bn&&Ya(Vs(tt(o.newValue,[])))};return window.addEventListener("storage",a),()=>window.removeEventListener("storage",a)},[]);const G=c.useCallback(a=>{const o={id:`activity-${Math.random().toString(36).slice(2,9)}`,sessionId:gt.current,message:a,timestamp:Date.now()};Ya(h=>{const b=Vs([o,...h]);return window.localStorage.setItem(bn,JSON.stringify(b)),b})},[]),we=c.useCallback((a,o,h)=>{ss.current[a]||(ss.current[a]=!0,Ql(o,h))},[]),Ze=c.useCallback(async function(o){o.retry&&(rs.current[o.id]=o.retry),o.resume&&(is.current[o.id]=o.resume),xt({id:o.id,label:o.label,status:"running",detail:"Running",retryable:!1,resumable:!1});try{const h=await o.run();return xt({id:o.id,label:o.label,status:"success",detail:o.successDetail??"Completed",retryable:!1,resumable:!1}),h}catch(h){const b=h instanceof Error?h.message:"Action failed";throw xt({id:o.id,label:o.label,status:"error",detail:b,retryable:!!o.retry,resumable:!!o.resume}),h}},[xt]),Zr=c.useCallback(a=>{const o=rs.current[a];o&&(B("ux.action.retry",{id:a}),o())},[B]),ei=c.useCallback(a=>{const o=is.current[a];o&&(B("ux.action.resume",{id:a}),o())},[B]),He=c.useCallback(async a=>{if(!e||!re("run replay"))return;const o=await Il(e.id,a,"hybrid",{note:"UI replay"},e);o&&(ye(o),Ee(!0),m("flow"),ve(h=>h.replay?h:{...h,replay:!0}),G(`Created replay from ${a}`))},[G,re,ve,e,ye,m,Ee]),ti=c.useCallback(async()=>{if(e){if(!N.trim()){I(null),H(null);return}try{const a=await Ze({id:"trace-query",label:"TraceQL query",run:async()=>Sl(e.id,N.trim()),successDetail:"Query complete"});if(!a){H("TraceQL query failed"),I(null);return}I(a),H(null);const o=a.matchedStepIds[0];o&&(q(o),u!=="cinema"&&m("cinema"))}catch{H("TraceQL query failed"),I(null)}}},[Ze,u,m,e,N]),ai=c.useCallback(async()=>{if(!(!e||!k)){Q(!0);try{const a=await Ze({id:"run-extension",label:"Run extension",run:async()=>Ml(k,e.id),successDetail:"Extension output ready"});if(!a)return;U(a.result)}finally{Q(!1)}}},[Ze,k,e]),Ae=c.useCallback(()=>{if(!e)return;const a=[...e.steps].sort((o,h)=>(h.durationMs??0)-(o.durationMs??0))[0];a&&(q(a.id),m("cinema"))},[e,m]),fs=c.useCallback(()=>{if(!e||e.steps.length===0)return null;const a=[...e.steps].sort((o,h)=>(h.durationMs??0)-(o.durationMs??0))[0];return(a==null?void 0:a.id)??null},[e]),it=c.useCallback(()=>{if(!e)return;const a=e.steps.find(o=>o.status==="failed");a&&(q(a.id),m("cinema"))},[e,m]),fa=c.useCallback(async()=>{if(!e)return;const a=new URL(window.location.href);a.searchParams.set("trace",l??e.id),a.searchParams.set("mode",u),T?a.searchParams.set("step",T):a.searchParams.delete("step");try{await navigator.clipboard.writeText(a.toString()),Ga("Live link copied")}catch{window.prompt("Copy live session link",a.toString()),Ga("Live link ready")}window.setTimeout(()=>Ga(null),1800)},[u,T,l,e]),ni=c.useCallback(a=>{Dn(a),G(`Switched lane strategy to ${a}`)},[G,Dn]),si=c.useCallback(a=>{pt(o=>{const h=o[me]??zt[me],b=h.hidden.includes(a)?h.hidden.filter(M=>M!==a):[...h.hidden,a];return{...o,[me]:{...h,hidden:b}}}),G(`Toggled lane visibility for ${a}`)},[G,me,pt]),ri=c.useCallback(async a=>{if(!e||!re("create gameplay sessions"))return;const o=await Dl({traceId:e.id,name:a.trim()||"Night Ops"});if(!o){X("Failed to create gameplay session.");return}Oe(o),Ye(o.id),X(null),G(`Created gameplay session ${o.id}`)},[G,_e,re,Ye,e]),ii=c.useCallback(async()=>{if(!e||!re("matchmake gameplay sessions"))return;const a=await $l({traceId:e.id});if(!a){X("Failed to matchmake gameplay session.");return}Oe(a.session),Ye(a.session.id),X(null),G(`${a.match.type==="created"?"Created":"Matched"} gameplay session ${a.session.id} as ${a.match.assigned_role}`)},[G,_e,re,Ye,e]),oi=c.useCallback(async(a,o,h)=>{if(!re("join gameplay sessions"))return;if(!a.trim()){X("Session id is required.");return}const b=await Rl({sessionId:a.trim(),playerId:o.trim()});if(!b){X("Failed to join gameplay session.");return}Oe(b),Ye(b.id),X(null),G(`Joined gameplay session ${b.id} as ${o}`)},[G,re,Ye]),li=c.useCallback(async()=>{Me&&re("leave gameplay sessions")&&Xe("Leave gameplay session",`Leave session ${Me}?`,()=>{(async()=>{if(!await Ol()){X("Failed to leave gameplay session.");return}Oe(null),Ye(""),X(null),G(`Left gameplay session ${Me}`),B("ux.action.confirmed",{action:"leave_gameplay_session",sessionId:Me})})()})},[G,_e,Me,Xe,re,Ye,B]),ci=c.useCallback(async()=>{if(!Me)return;const a=await Pl();if(!a){X("Failed to reconnect gameplay session.");return}Oe(a),X(null),G(`Reconnected gameplay session ${Me}`)},[G,_e,Me]),di=c.useCallback(async(a,o)=>{if(!(de!=null&&de.id)||!re(`run gameplay action ${a}`))return;const h=await Gs({sessionId:de.id,expectedVersion:de.version});if(h.session){Oe(h.session),X(null),G(`Gameplay action: ${a}`);return}if(h.conflict){const b=await hn(de.id);b&&Oe(b),X("Session changed by another player. Synced latest state.");return}X(h.error??"Gameplay action failed.")},[G,_e,de,re]),ui=c.useCallback(async(a,o)=>{if(!re("create guilds"))return;if(!a.trim()||!o.trim()){X("Guild id and name are required.");return}const h=await ql({guildId:a.trim(),name:o.trim()});if(!h){X("Failed to create guild.");return}if(ft(h),de){const b=await Gs({sessionId:de.id,payload:{guild_id:h.id},expectedVersion:de.version});b.session&&Oe(b.session)}X(null),G(`Created guild ${h.id}`)},[G,_e,de,re]),pi=c.useCallback(async(a,o)=>{if(!re("join guilds"))return;if(!a.trim()||!o.trim()){X("Guild id and player id are required.");return}const h=await zl(a.trim(),o.trim());if(!h){X("Failed to join guild.");return}ft(h),X(null),G(`Joined guild ${h.id} as ${o}`)},[G,re]),mi=c.useCallback(async(a,o,h)=>{if(!re("schedule guild events"))return;if(!a.trim()||!o.trim()||!h.trim()){X("Guild id, title, and schedule are required.");return}const b=await Bl({guildId:a.trim(),title:o.trim(),scheduledAt:h.trim()});if(!b){X("Failed to schedule guild event.");return}ft(b.guild),X(null),G(`Scheduled guild event ${b.event.id}`)},[G,re]),hi=c.useCallback(async(a,o,h)=>{if(!re("complete guild events"))return;const b=await Hl();if(!b){X("Failed to complete guild event.");return}ft(b),X(null),G(`Completed guild event ${o}`)},[G,re]),fi=c.useCallback(async a=>{if(!re("send friend invites"))return;const o=await Ll({toPlayerId:a.trim().toLowerCase()});if(!o){X("Failed to send friend invite.");return}na(o.social),X(null),G(`Sent friend invite to ${a}`)},[G,_e,re]),yi=c.useCallback(async a=>{if(!re("accept friend invites"))return;const o=await Fl();if(!o){X("Failed to accept friend invite.");return}na(o),X(null),G(`Accepted friend invite ${a}`)},[G,_e,re]),ys=c.useCallback(()=>{Ze({id:"retry-connectivity",label:"Retry connectivity",retry:()=>ys(),run:async()=>{if(X(null),i(),Me){const b=await hn();b&&Oe(b)}const[a,o,h]=await Promise.all([zs(),Bs(),Hs()]);return a&&na(a),o&&Jn(o),h&&Vn(h),G("Retried connectivity sync"),!0},successDetail:"Connectivity synced"}).catch(()=>{X("Retry connectivity failed.")})},[G,Ze,_e,Me,i]),gi=c.useCallback((a,o)=>{pt(h=>{const b=h[me]??zt[me],M=[...b.order],O=M.indexOf(a);if(O===-1)return h;const W=o==="up"?O-1:O+1;if(W<0||W>=M.length)return h;const[L]=M.splice(O,1);return M.splice(W,0,L),{...h,[me]:{...b,order:M}}}),G(`Moved lane group ${a} ${o}`)},[G,me,pt]),bi=c.useCallback(()=>{ve({playback:!1,flow:!1,inspect:!1,matrix:!1,replay:!1,annotate:!1,collaborate:!1}),G("Reset onboarding missions")},[G,ve]),xi=c.useCallback((a,o)=>{if(!e||!a.trim())return;const h=Date.now(),b={id:`annotation-${Math.random().toString(36).slice(2,9)}`,traceId:e.id,stepId:o,body:a.trim(),authorSessionId:gt.current,createdAt:h,updatedAt:h};Ka(M=>{const O=Js(M,[b]);return window.localStorage.setItem(gn,JSON.stringify(O)),O}),ve(M=>M.annotate?M:{...M,annotate:!0}),G(o?`Added annotation on step ${o}`:"Added trace annotation")},[G,ve,e]),vi=c.useCallback((a,o)=>{at(h=>h.map(b=>b.id===a?{...b,...o}:b))},[]),wi=c.useCallback(a=>{at(a)},[]),ji=c.useCallback(()=>{at(a=>[...a,{id:ga(),name:`Scenario ${a.length+1}`,strategy:"hybrid",modificationsText:"{}"}])},[]),ki=c.useCallback(a=>{Pa.length<=1||Xe("Remove scenario","Remove this scenario from the matrix run?",()=>{let o=null,h=-1;at(b=>(h=b.findIndex(M=>M.id===a),h===-1||b.length<=1?b:(o=b[h]??null,b.filter(M=>M.id!==a)))),!(!o||h===-1)&&(ms("Scenario removed",()=>{at(b=>{const M=[...b];return M.splice(Math.min(h,M.length),0,o),M}),B("ux.action.undone",{action:"matrix_scenario_remove",scenarioId:a})}),B("ux.action.confirmed",{action:"matrix_scenario_remove",scenarioId:a}))})},[Pa.length,ms,Xe,B]),Si=c.useCallback(a=>{at(o=>{const h=o.findIndex(W=>W.id===a);if(h===-1)return o;const b=o[h],M={...b,id:ga(),name:`${b.name} copy`},O=[...o];return O.splice(h+1,0,M),O})},[]),Ni=c.useCallback((a,o)=>{at(h=>{const b=h.findIndex(L=>L.id===a);if(b===-1)return h;const M=o==="up"?b-1:b+1;if(M<0||M>=h.length)return h;const O=[...h],[W]=O.splice(b,1);return O.splice(M,0,W),O})},[]),rn=c.useCallback(async a=>{var h;if(!e||!re("run replay matrix"))return;const o=Ra||T||((h=e.steps[0])==null?void 0:h.id);if(!o){Mt("Select an anchor step before running the matrix.");return}try{ea(!0),Mt(null),await Ze({id:"matrix-run",label:"Replay matrix run",retry:()=>{rn(a)},resume:()=>{rn(a)},run:async()=>{const b=await El({traceId:e.id,stepId:o,scenarios:a});if(!b)throw new Error("Failed to create replay job.");La(b);let M=b;for(let W=0;W<30&&!(M.status!=="queued"&&M.status!=="running");W+=1){const L=nc(W);await new Promise(je=>window.setTimeout(je,L));const le=await _l(b.id);if(!le)break;M=le,La(le)}const O=await qs(b.id);if(!O)throw new Error("Replay job finished but matrix summary is unavailable.");return qn(O),m("matrix"),G(`Ran matrix with ${a.length} scenario(s) from ${o}`),O},successDetail:`${a.length} scenario(s) complete`})}catch(b){Mt(b instanceof Error?b.message:"Failed to run replay matrix.")}finally{ea(!1)}},[G,Ze,Ra,re,T,e,m]),Ci=c.useCallback(async()=>{Qe&&re("cancel replay matrix jobs")&&Xe("Cancel matrix job",`Cancel replay job ${Qe.id}?`,()=>{(async()=>{ea(!0);try{const a=await Tl(Qe.id);if(!a){Mt("Failed to cancel replay job.");return}La(a),xt({id:"matrix-run",label:"Replay matrix run",status:"canceled",detail:`Canceled ${Qe.id}`,resumable:!0,retryable:!0});const o=await qs(a.id);o&&qn(o),G(`Canceled matrix job ${Qe.id}`),B("ux.action.cancel",{id:Qe.id})}finally{ea(!1)}})()})},[G,Qe,Xe,re,xt,B]),Mi=c.useCallback(async a=>{const o=await mr();if(!(o!=null&&o.trace)){Mt("Could not load replay trace for compare view.");return}ye(o.trace),Ee(!0),m("compare"),G(`Opened matrix compare trace ${a}`)},[G,m,Ee]),oe=c.useCallback(a=>{if(!(a===u||!e)){if((a==="flow"||a==="matrix"||a==="gameplay")&&A(!1),a==="flow"&&u==="cinema"&&Za.current){const o=Za.current,h=Pc(o),b=Lc(e.steps,o,e.id);Fn({steps:e.steps,fromRects:h,toRects:b}),G("Morphed cinema to flow");return}m(a),G(`Switched mode to ${a}`)}},[G,u,e,A,m]),qt=c.useCallback(async a=>{if(Ca(a),a==="rapid_triage"){Ne(!0),oe("cinema"),it(),e!=null&&e.steps.some(o=>o.status==="failed")||Ae(),G("Started rapid triage launch path");return}if(a==="deep_diagnosis"){Ne(!0),oe("flow"),ge(!0),G("Started deep diagnosis launch path");return}fe(!0),oe("matrix"),await fa(),G("Started team sync launch path")},[G,oe,Ae,it,Ne,Ca,fe,fa,e]),on=c.useCallback(()=>{u==="flow"&&oe("cinema"),A(a=>!a)},[u,oe]),et=c.useCallback(()=>{Xt(null),Aa([]),$a(null),A(!1)},[A]),gs=c.useCallback(a=>[{id:"setup",label:"Opening the reel",duration:1100,action:()=>{Ne(!0),A(!1),ke(0),q(null),Ee(!1),De(1),e&&e.steps.length<500&&$e(!1),oe("cinema")}},{id:"pace",label:"Pacing the timeline",duration:2200,action:()=>{oe("cinema"),A(!0),De(1.1)}},{id:"bottleneck",label:"Freeze on the bottleneck",duration:1600,action:()=>{A(!1),Ae()}},{id:"inspect",label:"Inspect the moment",duration:1600,action:()=>{a&&q(a)}},{id:"flow",label:"Morph into flow",duration:2100,action:()=>{oe("flow")}},{id:"replay",label:"Director’s Cut replay",duration:2200,action:async()=>{if(!e)return;!ts.current&&a&&await He(a),Ee(!0),m("compare")}},{id:"compare",label:"Compare the cut",duration:2e3,action:()=>{A(!0),De(1)}},{id:"finale",label:"Final frame",duration:1100,action:()=>{A(!1)}}],[oe,He,Ae,Ne,A,m,Ee,ke,q,De,$e,e]),vt=c.useCallback(()=>{var o;if(!e)return;const a=T??fs()??((o=e.steps[0])==null?void 0:o.id)??null;Aa(gs(a)),Xt({active:!0,step:0}),$a(e.id),ge(!1),Se(!1),Fe(!1)},[gs,fs,T,e,Fe,Se,Aa,Xt,$a,ge]),wt=c.useCallback(()=>{if(ae!=null&&ae.active){et();return}vt()},[vt,et,ae==null?void 0:ae.active]),Ii=c.useMemo(()=>{const o=[{id:"header",title:"Mission control",body:`Confirm run status and metadata. ${{builder:"Focus on payload flow, tool-call sequencing, and replay-ready steps.",executive:"Focus on bottlenecks, risk signals, and run-level outcome changes.",operator:"Focus on failure patterns, retries, and runtime reliability posture."}[xe]}`,target:'[data-tour="header"]',placement:"bottom"}];return ja||o.push({id:"hero",title:"Director briefing",body:"Choose Tour, Story mode, or Explain to ramp up quickly.",target:'[data-tour="hero"]',placement:"bottom"}),o.push({id:"insights",title:"Fast diagnosis",body:xe==="executive"?"Jump straight to bottlenecks and high-cost segments for fast executive readouts.":xe==="operator"?"Jump to failures and retries first, then inspect impacted steps.":"Jump straight to bottlenecks, errors, and high-cost steps with one click.",target:'[data-tour="insights"]',placement:"bottom"},{id:"journey",title:"Director journey",body:"A narrative path that teaches how to watch, inspect, and direct a better run.",target:'[data-tour="journey"]',placement:"bottom"},{id:"toolbar",title:"Filters + modes",body:"Search, filter, and switch between Cinema, Flow, and Compare as the story evolves.",target:'[data-tour="toolbar"]',placement:"bottom"},{id:"quick-actions",title:"Quick actions",body:"Launch Story Mode, open the command palette, or jump to bottlenecks instantly.",target:'[data-tour="quick-actions"]',placement:"left"},{id:"stage",title:"Cinema stage",body:"The timeline shows every step as a scene. Scrub to see pacing and concurrency.",target:'[data-tour="stage"]',placement:"top"},{id:"inspector",title:"Inspector",body:xe==="executive"?"Open key moments to validate outcome impact and communication-ready summaries.":"Open any step to read payloads, apply redaction, and replay from that moment.",target:'[data-tour="inspector"]',placement:"left"},{id:"compare",title:"Compare runs",body:j?"Compare is live. Review deltas in cost, steps, and wall time side by side.":"Replay from a step to unlock compare mode and validate improvements.",target:'[data-tour="compare"]',placement:"top"}),o},[j,ja,xe]),Ei=c.useCallback(()=>{Fn(null),m("flow")},[m]),qe=c.useMemo(()=>{var b,M,O,W;if(!e)return[];const a=[],o=[...e.steps].sort((L,le)=>(le.durationMs??0)-(L.durationMs??0))[0],h=e.steps.find(L=>L.status==="failed");if(h&&T!==h.id&&a.push({id:"jump-error",title:"Investigate first failure",body:`${h.name} failed and should be inspected before optimization work.`,actionLabel:"Open failed step",tone:"warning",action:it}),o&&T!==o.id&&a.push({id:"jump-bottleneck",title:"Tackle latency bottleneck",body:`${o.name} is the slowest scene in this run and the best optimization target.`,actionLabel:"Open bottleneck",tone:"priority",action:Ae}),(b=F==null?void 0:F.hypotheses)!=null&&b[0]){const L=F.hypotheses[0];a.push({id:"investigate-hypothesis",title:L.title,body:L.summary,actionLabel:"Inspect evidence",tone:"info",action:()=>{const le=L.evidenceStepIds[0];le&&(q(le),u!=="cinema"&&m("cinema"))}})}if(u!=="matrix"&&a.push({id:"matrix-experiment",title:"Run scenario matrix",body:"Compare prompt and strategy alternatives from one anchor step to rank causal impact.",actionLabel:"Open matrix",tone:"info",action:()=>{var L;Oa(T??((L=e.steps[0])==null?void 0:L.id)??""),m("matrix")}}),!j&&(T||(M=e.steps[0])!=null&&M.id)){const L=T??((O=e.steps[0])==null?void 0:O.id)??null;L&&a.push({id:"run-replay",title:"Create director replay",body:"Branch a replay trace and validate whether your change improves the run.",actionLabel:"Replay from step",tone:"info",action:()=>{He(L)}})}if((W=Ce==null?void 0:Ce.causalRanking)!=null&&W.length){const L=Ce.causalRanking[0];a.push({id:"causal-factor",title:`Top causal factor: ${L.factor}`,body:`Confidence ${(L.confidence*100).toFixed(0)}% across ${L.evidence.samples} sample(s).`,actionLabel:"View matrix",tone:"priority",action:()=>m("matrix")})}return a.slice(0,4)},[j,He,F,Ae,it,u,Ce,T,e,m]),_i=c.useMemo(()=>qe.map((a,o)=>{const h=a.tone==="warning"?"high":a.tone==="priority"?"medium":"low";return{id:`priority-${a.id}`,title:a.title,detail:a.body,severity:h,actionLabel:a.actionLabel,onAction:a.action,done:o===0?a.id==="jump-error"&&!!T||a.id==="jump-bottleneck"&&!!T:!1}}),[qe,T]),ot=c.useMemo(()=>{var O,W;if(!e)return"No trace loaded.";const a=[...e.steps].sort((L,le)=>(le.durationMs??0)-(L.durationMs??0))[0],o=e.steps.filter(L=>L.status==="failed").length,h=(O=F==null?void 0:F.hypotheses)==null?void 0:O[0],b=(W=Ce==null?void 0:Ce.causalRanking)==null?void 0:W[0];return[`Run ${e.id} completed with ${e.steps.length} steps across ${e.metadata.wallTimeMs}ms.`,a?`Primary latency driver: ${a.name} (${a.durationMs??0}ms).`:null,o>0?`Observed ${o} failed step(s), indicating reliability risk.`:"No failed steps observed.",h?`Top investigation hypothesis: ${h.title} (${h.severity}).`:null,b?`Highest ranked causal factor from matrix: ${b.factor} (${(b.confidence*100).toFixed(0)}% confidence).`:null,"Recommended plan: inspect bottleneck evidence, validate with replay matrix, and lock in mitigations."].filter(Boolean).join(" ")},[F,Ce==null?void 0:Ce.causalRanking,e]),Ti=c.useCallback(a=>{var h,b;const o=a.toLowerCase();if(!e)return"No trace is loaded yet.";if(o.includes("bottleneck")||o.includes("slow")){const M=[...e.steps].sort((O,W)=>(W.durationMs??0)-(O.durationMs??0))[0];return M?`The primary bottleneck is ${M.name} at ${M.durationMs??0}ms. Prioritize this step for optimization and replay validation.`:"No bottleneck could be determined from current trace data."}if(o.includes("risk")||o.includes("failure")||o.includes("error")){const M=e.steps.filter(O=>O.status==="failed");return M.length?`Risk is concentrated in ${M.length} failed step(s), starting at ${((h=M[0])==null?void 0:h.name)??"unknown"}.`:"Failure risk appears low for this run; no failed steps were observed."}return o.includes("cost")?`Recorded run cost is ${(e.metadata.totalCostUsd??0).toFixed(4)} USD. Use matrix scenarios to evaluate cheaper prompt/strategy options.`:o.includes("next")||o.includes("action")?qe.length?`Next action: ${((b=qe[0])==null?void 0:b.title)??"Open matrix"}.`:"Next action: open Cinema mode, inspect bottleneck, then run the matrix.":ot},[ot,qe,e]),bs=c.useCallback(()=>{e&&Ft({id:"export-director-narrative",label:"Director narrative markdown",run:()=>{const a=`# Director Narrative

${ot}

## Recommended Actions
${qe.map(o=>`- ${o.title}: ${o.body}`).join(`
`)}`;cn(`agent-director-narrative-${e.id}.md`,a,"text/markdown")}})},[ot,qe,Ft,e]),Gt=c.useCallback(async()=>{if(!e)return;const a=qe[0],o=e.steps.filter(M=>M.status==="failed").length,b=[`Session handoff (${new Date().toISOString()})`,`Trace: ${e.id}`,`Owner: ${At}`,`Handoff owner: ${Dt||"unassigned"}`,`Mode: ${u}`,`Selected step: ${T??"none"}`,`Run health: ${Pt}/100`,`Failures: ${o}`,`Wall time: ${e.metadata.wallTimeMs}ms`,`Top recommendation: ${a?`${a.title} -> ${a.actionLabel}`:"None"}`,`Narrative: ${ot}`].join(`
`);try{await navigator.clipboard.writeText(b),za("Handoff digest copied"),B("ux.support.payload_copied",{kind:"handoff_digest"})}catch{window.prompt("Copy handoff digest",b),za("Handoff digest ready")}window.setTimeout(()=>za(null),2200)},[ot,qe,Dt,u,Pt,At,T,e,B]),ya=c.useCallback(a=>{Xn(o=>{const h={...o,[a]:!o[a]};return Cc(window.localStorage,h),B("ux.feature_flag.toggled",{flag:a,enabled:h[a]}),h})},[B]),Ai=c.useCallback(()=>{Be.isValid&&(On(!0),ht(!1),Ea("source"),ne("Workspace setup complete.","success"),B("ux.setup.completed",{dataSource:Ke.dataSource,hasInvites:!!Ke.inviteEmails.trim()}))},[ne,Be.isValid,Ke,B,On]),Di=c.useCallback(async()=>{const a=JSON.stringify({diagnostics:ha,note:Tt,owner:At,handoffOwner:Dt||null},null,2);try{await navigator.clipboard.writeText(a),ne("Support payload copied.","success"),B("ux.support.payload_copied",{bytes:a.length})}catch{window.prompt("Copy support payload",a)}},[ne,Dt,At,ha,Tt,B]),$i=c.useCallback(()=>{const a=nt.trim();if(!a||Lt)return;const o={id:`view-${Math.random().toString(36).slice(2,9)}`,name:a,state:{mode:u,query:x,typeFilter:y,selectedStepId:T,safeExport:P,windowed:Le,syncPlayback:Ie,explainMode:Re,section:g}};ca(h=>[o,...h].slice(0,20)),Yn(""),da(o.id),B("ux.saved_view.created",{viewId:o.id,name:a}),ne(`Saved view: ${a}`,"success")},[g,ne,Re,u,x,P,nt,Lt,T,ca,Ie,B,y,Le]),ln=c.useCallback(a=>{const o=Pe.find(h=>h.id===a);o&&(m(o.state.mode),v(o.state.query),S(o.state.typeFilter),q(o.state.selectedStepId),he(o.state.safeExport),$e(o.state.windowed),fe(o.state.syncPlayback),Ne(o.state.explainMode),f(o.state.section),da(o.id),B("ux.saved_view.applied",{viewId:o.id,name:o.name}),ne(`Applied view: ${o.name}`,"info"))},[ne,Pe,f,Ne,m,he,fe,$e,B]),Ri=c.useCallback(()=>{if(!Ge)return;const a=Pe.find(o=>o.id===Ge);a&&Xe("Delete saved view",`Delete saved view "${a.name}"?`,()=>{ca(o=>o.filter(h=>h.id!==Ge)),da(""),B("ux.saved_view.deleted",{viewId:a.id,name:a.name}),ne(`Deleted view: ${a.name}`,"warning")})},[ne,Xe,Pe,Ge,ca,B]);c.useEffect(()=>{var h;if(!e)return;kl(),ke(0),A(!1);const a=Math.min(Math.max((e.metadata.wallTimeMs||1)*.2,5e3),6e4);te(a),e.steps.length>500&&$e(!0),j||Ee(!1),u==="compare"&&!j&&m("cinema");const o=T&&e.steps.some(b=>b.id===T)?T:((h=e.steps[0])==null?void 0:h.id)??"";Oa(b=>b&&e.steps.some(M=>M.id===b)?b:o)},[e,j,u,T,m,$e,Ee]),c.useEffect(()=>(document.body.classList.toggle("explain-mode",Re),()=>{document.body.classList.remove("explain-mode")}),[Re]),c.useEffect(()=>(document.body.classList.toggle("story-mode",!!(ae!=null&&ae.active)),()=>{document.body.classList.remove("story-mode")}),[ae==null?void 0:ae.active]),c.useEffect(()=>{if(!(ae!=null&&ae.active))return;const a=Zt[ae.step];if(!a){et();return}Promise.resolve(a.action());const o=window.setTimeout(()=>{Xt(h=>h&&h.active?{...h,step:h.step+1}:h)},a.duration);return()=>window.clearTimeout(o)},[Zt,et,ae]),c.useEffect(()=>{ae!=null&&ae.active&&(!e||!Da||e.id!==Da&&et())},[ae==null?void 0:ae.active,e,Da,et]),c.useEffect(()=>{mt||Qt||we(`tutorial_start:${(e==null?void 0:e.id)||ue||se.seed}`,"funnel.tutorial_start",{traceId:(e==null?void 0:e.id)||ue||"unknown",persona:xe,launchPath:Na})},[we,se.seed,ue,mt,xe,Na,Qt,e==null?void 0:e.id]),c.useEffect(()=>{Y>0&&ve(a=>a.playback?a:{...a,playback:!0})},[Y,ve]),c.useEffect(()=>{u==="flow"&&ve(a=>a.flow?a:{...a,flow:!0}),u==="matrix"&&ve(a=>a.matrix?a:{...a,matrix:!0})},[u,ve]),c.useEffect(()=>{T&&ve(a=>a.inspect?a:{...a,inspect:!0})},[T,ve]),c.useEffect(()=>{qa>1&&ve(a=>a.collaborate?a:{...a,collaborate:!0})},[qa,ve]),c.useEffect(()=>{we(`session_start:${ue||se.seed}`,"funnel.session_start",{traceId:ue||(e==null?void 0:e.id)||"unknown",seed:se.seed})},[we,se.seed,ue,e==null?void 0:e.id]),c.useEffect(()=>{se.raid.objectives.some(o=>o.progress>0)&&we(`objective_progress:${ue||se.seed}`,"funnel.first_objective_progress",{traceId:ue||(e==null?void 0:e.id)||"unknown"})},[we,se.raid.objectives,se.seed,ue,e==null?void 0:e.id]),c.useEffect(()=>{se.outcome.status!=="in_progress"&&(we(`first_outcome:${ue||se.seed}`,"funnel.first_mission_outcome",{status:se.outcome.status,reason:se.outcome.reason}),(se.outcome.status==="win"||se.outcome.status==="loss")&&we(`run_outcome:${ue||se.seed}`,"funnel.run_outcome",{status:se.outcome.status,reason:se.outcome.reason}))},[we,se.outcome.reason,se.outcome.status,se.seed,ue]),c.useEffect(()=>{if(!Ie||ce||en.current)return;const a=ma[0];if(!a||a.traceId!==(e==null?void 0:e.id))return;const o=Math.abs(a.playheadMs-Y),h=a.mode!==u,b=(a.selectedStepId??null)!==(T??null);o<600&&!h&&!b||(en.current=!0,ke(a.playheadMs),(a.mode==="cinema"||a.mode==="flow"||a.mode==="compare"||a.mode==="matrix"||a.mode==="gameplay")&&m(a.mode),q(a.selectedStepId??null),window.setTimeout(()=>{en.current=!1},180))},[ce,u,Y,ma,T,m,Ie,e==null?void 0:e.id]),c.useEffect(()=>{if(!e)return;const o=Date.parse(e.startedAt)+Y;let h=0,b=Number.POSITIVE_INFINITY;e.steps.forEach((O,W)=>{const L=Date.parse(O.startedAt),le=Date.parse(O.endedAt??O.startedAt);if(o>=L&&o<=le){h=W,b=0;return}const je=Math.min(Math.abs(o-L),Math.abs(o-le));je<b&&(b=je,h=W)}),[h,h-1,h+1].filter(O=>O>=0&&O<e.steps.length).forEach(O=>{const W=e.steps[O];W&&wl(e.id,W.id,P)})},[e,Y,P]),c.useEffect(()=>{if(!e||!ce||u!=="cinema"&&u!=="compare")return;const a=(j==null?void 0:j.metadata.wallTimeMs)??0,o=u==="compare"?Math.max(e.metadata.wallTimeMs||1,a||1):e.metadata.wallTimeMs||1;let h=0,b=performance.now();const M=O=>{const W=(O-b)*dt;b=O,ke(L=>{const le=L+W;return le>=o?(A(!1),o):le}),h=requestAnimationFrame(M)};return h=requestAnimationFrame(M),()=>cancelAnimationFrame(h)},[e,j,ce,dt,u]),c.useEffect(()=>{const a=JSON.stringify(ra),o=JSON.stringify(st);a!==o&&ia(st)},[st,ia,ra]);const Oi=c.useCallback((a,o)=>{ia(h=>Ao(h,a,o)),B("ux.settings.shortcut.updated",{shortcut:a,key:o.toLowerCase()})},[ia,B]);c.useEffect(()=>{const a=o=>{var W;const h=L=>!o.metaKey&&!o.ctrlKey&&!o.altKey&&o.key.toLowerCase()===st[L],b=o.target,M=(W=b==null?void 0:b.tagName)==null?void 0:W.toLowerCase();if(!(M==="input"||M==="textarea"||M==="select"||b!=null&&b.isContentEditable)){if((o.metaKey||o.ctrlKey)&&o.key.toLowerCase()==="k"){o.preventDefault(),Fe(L=>!L);return}if(o.key==="?"||o.key==="/"&&o.shiftKey){o.preventDefault(),Se(!0);return}if(h("toggleStory")){o.preventDefault(),wt();return}if(h("toggleExplain")){o.preventDefault(),Ne(L=>!L);return}if(h("startTour")){o.preventDefault(),ge(!0);return}if(o.key==="Escape"){if(Ta){ge(!1),ut(!0);return}Se(!1),Fe(!1),q(null);return}if(o.key===" "){o.preventDefault(),(u==="cinema"||u==="compare")&&A(L=>!L);return}if(h("toggleFlow")){o.preventDefault(),u==="flow"?m("cinema"):u==="cinema"&&oe("flow");return}if(h("toggleCinema")){o.preventDefault(),u!=="cinema"&&m("cinema");return}if(h("toggleGameplay")){o.preventDefault(),oe("gameplay");return}if(h("toggleInspector")){o.preventDefault(),T?q(null):e!=null&&e.steps.length&&q(e.steps[0].id);return}if(o.key==="ArrowLeft"||o.key==="ArrowRight"){if(o.preventDefault(),!e)return;const L=e.metadata.wallTimeMs||1;if(o.shiftKey){ke(o.key==="ArrowLeft"?0:L),A(!1),m("cinema");return}const le=o.key==="ArrowRight"?1:-1,je=Zl(ds,Y,le);je!=null&&(ke(je),A(!1),m("cinema"))}}};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[u,st,T,e,Y,ds,oe,m,Ne,Fe,ge,ut,Ta,wt]);const xs=c.useMemo(()=>{if(!e||!Le||x)return null;const a=e.metadata.wallTimeMs||1,o=Math.min(Math.max(_,5e3),a);let h=Math.max(0,Y-o/2);const b=Math.min(a,h+o);return b-h<o&&(h=Math.max(0,b-o)),{startMs:h,endMs:b}},[e,Le,Y,x,_]),Ue=!!(ae!=null&&ae.active),vs=(ae==null?void 0:ae.step)??0,Pi=((js=Zt[vs])==null?void 0:js.label)??"Wrapping up",Li=Zt.length,Fi=x!==w,qi=`${Math.min(ze.length,Rt)}/${ze.length}`,Gi=c.useMemo(()=>xe==="executive"?[{label:"Review run health",done:Pt>=80},{label:"Inspect top risk",done:!!T},{label:"Share handoff digest",done:!!yt}]:xe==="operator"?[{label:"Open failed step",done:!!T},{label:"Run replay",done:!!j},{label:"Use support diagnostics",done:Ua||!!Tt.trim()}]:[{label:"Open flow graph",done:u==="flow"},{label:"Run matrix scenario",done:!!Ce},{label:"Save a reusable view",done:Pe.length>0}],[j,yt,xe,u,Ce,Pt,Pe.length,T,Tt,Ua]),zi=c.useMemo(()=>[{id:"macro-rapid-triage",label:"Run rapid triage launch path",description:"Jump to the highest-risk step and start mitigation.",group:"Macros",onTrigger:()=>{qt("rapid_triage")}},{id:"macro-deep-diagnosis",label:"Run deep diagnosis launch path",description:"Open flow analysis and guided tour.",group:"Macros",onTrigger:()=>{qt("deep_diagnosis")}},{id:"macro-team-sync",label:"Run team sync launch path",description:"Enable sync mode and generate shareable context.",group:"Macros",onTrigger:()=>{qt("team_sync")}},{id:"story-toggle",label:Ue?"Stop story mode":"Start story mode",description:"Auto-runs a cinematic walkthrough.",group:"Story",keys:"S",onTrigger:wt},{id:"tour-start",label:"Start guided tour",description:"Walk the interface step by step.",group:"Onboarding",keys:"T",onTrigger:()=>ge(!0)},{id:"explain-toggle",label:Re?"Disable explain mode":"Enable explain mode",description:"Toggle contextual overlays.",group:"Onboarding",keys:"E",onTrigger:()=>Ne(a=>!a)},{id:"shortcuts",label:"Show shortcuts",description:"Open the keyboard map.",group:"Onboarding",keys:"?",onTrigger:()=>Se(!0)},{id:"playback-toggle",label:ce?"Pause playback":"Play playback",description:"Start or stop the run.",group:"Playback",keys:"Space",onTrigger:on},{id:"mode-cinema",label:"Switch to Cinema",description:"Timeline playback view.",group:"Modes",keys:"C",onTrigger:()=>oe("cinema")},{id:"mode-flow",label:"Switch to Flow",description:"Graph dependency view.",group:"Modes",keys:"F",onTrigger:()=>oe("flow")},{id:"mode-compare",label:"Open Compare",description:"Side-by-side diff view.",group:"Modes",onTrigger:()=>oe("compare"),disabled:!j},{id:"mode-matrix",label:"Open Matrix",description:"Counterfactual replay matrix view.",group:"Modes",onTrigger:()=>oe("matrix")},{id:"mode-gameplay",label:"Open Gameplay",description:"World-class gameplay mechanics control center.",group:"Modes",keys:"G",onTrigger:()=>oe("gameplay")},{id:"jump-bottleneck",label:"Jump to bottleneck",description:"Select the slowest step.",group:"Navigation",onTrigger:Ae},{id:"jump-error",label:"Jump to error",description:"Select the first failed step.",group:"Navigation",onTrigger:it},{id:"replay-step",label:"Replay from selected step",description:"Branch a Director’s Cut.",group:"Tools",onTrigger:()=>T&&He(T),disabled:!T},{id:"overlay-toggle",label:Nt?"Hide overlay":"Show overlay",description:"Ghost diff in Cinema/Flow.",group:"Tools",onTrigger:()=>Ee(a=>!a),disabled:!j},{id:"safe-export",label:P?"Disable safe export":"Enable safe export",description:"Redact sensitive payloads.",group:"Safety",onTrigger:()=>he(a=>!a)},{id:"reload",label:"Reload traces",description:"Refresh trace data.",group:"Meta",onTrigger:i},{id:"handoff-digest",label:"Copy handoff digest",description:"Capture mode, risk summary, and next actions for teammates.",group:"Meta",keys:"H",onTrigger:()=>{Gt()}},{id:"section-journey",label:"Open journey workspace",description:"Show journey presets and persona progression.",group:"Workspace",onTrigger:()=>f("journey")},{id:"section-analysis",label:"Open analysis workspace",description:"Show async action health and export queue.",group:"Workspace",onTrigger:()=>f("analysis")},{id:"section-collaboration",label:"Open collaboration workspace",description:"Ownership, handoff, and activity timeline.",group:"Workspace",onTrigger:()=>f("collaboration")},{id:"section-operations",label:"Open operations workspace",description:"Setup, support, and feature flags.",group:"Workspace",onTrigger:()=>f("operations")},{id:"open-setup-wizard",label:"Open setup wizard",description:"Connect source, import context, and invite teammates.",group:"Workspace",onTrigger:()=>{ht(!0),B("ux.setup.opened",{source:"command_palette"})},disabled:!pe.setupWizardV1},{id:"open-support-panel",label:"Open support diagnostics",description:"Collect support payload and copy handoff diagnostics.",group:"Workspace",onTrigger:()=>{_t(!0),B("ux.support.opened",{source:"command_palette"})},disabled:!pe.supportPanelV1},...Pe.slice(0,5).map(a=>({id:`saved-view-${a.id}`,label:`Apply saved view: ${a.name}`,description:"Restore a saved journey configuration.",group:"Workspace",onTrigger:()=>ln(a.id)}))],[ln,Gt,pe.setupWizardV1,pe.supportPanelV1,Ue,wt,Re,ce,on,oe,j,Ae,it,T,He,Nt,P,i,Ne,Ee,he,Se,_t,ht,ge,f,Pe,qt,B]),Bi=c.useCallback(()=>{we(`tutorial_skip:intro:${(e==null?void 0:e.id)||ue||se.seed}`,"funnel.tutorial_skip",{traceId:(e==null?void 0:e.id)||ue||"unknown",source:"intro_overlay"}),Yt(!0)},[we,se.seed,ue,Yt,e==null?void 0:e.id]),Hi=c.useCallback(()=>{Yt(!0),ge(!0)},[Yt,ge]),Ui=c.useCallback(()=>{we(`tutorial_skip:tour:${(e==null?void 0:e.id)||ue||se.seed}`,"funnel.tutorial_skip",{traceId:(e==null?void 0:e.id)||ue||"unknown",source:"guided_tour"}),ge(!1),ut(!0)},[we,se.seed,ue,ut,e==null?void 0:e.id]),Wi=c.useCallback(()=>{we(`tutorial_complete:${(e==null?void 0:e.id)||ue||se.seed}`,"funnel.tutorial_complete",{traceId:(e==null?void 0:e.id)||ue||"unknown"}),ge(!1),ut(!0)},[we,se.seed,ue,ut,e==null?void 0:e.id]);return s?t.jsx(mn,{variant:"loading",title:"Loading trace...",message:"Preparing timeline, graph, and replay context."}):!r&&!e&&d.length===0?t.jsx(mn,{variant:"empty",title:"No traces yet",message:"Ingest your first trace, then reload to begin the Observe → Inspect → Direct workflow.",actions:[{id:"retry",label:"Retry",node:t.jsx("button",{className:"primary-button",type:"button",onClick:i,children:"Retry"})},{id:"help",label:"Open help",node:t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer",children:"Open help"})}]}):r||!e?t.jsx(mn,{variant:"error",title:"Trace load failed",message:r??"Failed to load trace.",actions:[{id:"retry",label:"Retry",node:t.jsx("button",{className:"primary-button",type:"button",onClick:i,children:"Retry"})},{id:"help",label:"Open help",node:t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer",children:"Open help"})}]}):t.jsxs("div",{className:`app theme-${Ct} ${Re?"explain-mode":""} ${u==="compare"?"mode-compare":""} ${u==="matrix"?"mode-matrix":""} ${u==="gameplay"?"mode-gameplay":""}`,children:[t.jsx(eo,{trace:e,traces:d,selectedTraceId:l,onSelectTrace:p,onReload:i,onStartTour:()=>ge(!0),onToggleStory:wt,onOpenPalette:()=>Fe(!0),onToggleExplain:()=>Ne(a=>!a),onShareSession:fa,onCreateHandoffDigest:()=>void Gt(),onOpenSupport:()=>{_t(!0),B("ux.support.opened",{source:"header"})},onThemeChange:En,onMotionChange:_n,themeMode:Ct,motionMode:Jt,activeSessions:qa,shareStatus:oa,handoffStatus:yt,explainMode:Re,storyActive:Ue,mode:u,missionCompletion:ps,runHealthScore:Pt,modeHotkeys:Qr,workspaces:nr,workspaceId:Ma,onWorkspaceChange:Mr,workspaceRole:Vt,onWorkspaceRoleChange:Ir,sessionLabel:rt.label,sessionExpired:rt.expired,onRenewSession:Xr}),t.jsx(tl,{notifications:Et.map(({id:a,message:o,level:h})=>({id:a,message:o,level:h})),onDismiss:Yr}),$t?t.jsxs("div",{className:"undo-banner",role:"status","aria-live":"polite",children:[t.jsx("span",{children:$t.label}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{var a,o;(o=(a=ls.current)[$t.id])==null||o.call(a),Ja(null)},children:"Undo"})]}):null,ua?t.jsx("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true","aria-label":"Confirm action",children:t.jsxs("div",{className:"palette confirm-dialog",children:[t.jsx("div",{className:"palette-header",children:t.jsxs("div",{children:[t.jsx("div",{className:"palette-title",children:ua.title}),t.jsx("div",{className:"palette-subtitle",children:ua.message})]})}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Wa(null),children:"Cancel"}),t.jsx("button",{className:"primary-button",type:"button",onClick:()=>{var o,h;const a=ua.id;B("ux.action.confirmed",{confirmationId:a}),(h=(o=tn.current)[a])==null||h.call(o),delete tn.current[a],Wa(null)},children:"Confirm"})]})]})}):null,Ia&&pe.setupWizardV1?t.jsx("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true","aria-label":"First-run setup wizard",children:t.jsxs("div",{className:"palette setup-wizard",children:[t.jsxs("div",{className:"palette-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"palette-title",children:"First-run setup wizard"}),t.jsx("div",{className:"palette-subtitle",children:"Connect source, import context, invite teammates."})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>ht(!1),children:"Close"})]}),t.jsxs("div",{className:"setup-stepper",children:[t.jsx("span",{className:Ve==="source"?"active":"",children:"1. Source"}),t.jsx("span",{className:Ve==="import"?"active":"",children:"2. Import"}),t.jsx("span",{className:Ve==="invite"?"active":"",children:"3. Invite"})]}),Ve==="source"?t.jsxs("div",{className:"workspace-card",children:[t.jsxs("label",{children:["Data source",t.jsxs("select",{className:"search-select",value:Ke.dataSource,onChange:a=>_a(o=>({...o,dataSource:a.target.value})),children:[t.jsx("option",{value:"",children:"Select source"}),t.jsx("option",{value:"api",children:"Live API"}),t.jsx("option",{value:"file",children:"Trace file import"}),t.jsx("option",{value:"hybrid",children:"Hybrid replay baseline"})]})]}),Be.dataSourceError?t.jsx("p",{className:"workspace-error",children:Be.dataSourceError}):null]}):null,Ve==="import"?t.jsxs("div",{className:"workspace-card",children:[t.jsxs("label",{children:["Import path or URI",t.jsx("input",{className:"search-input",value:Ke.importPath,onChange:a=>_a(o=>({...o,importPath:a.target.value})),placeholder:"/data/traces/latest.json"})]}),Be.importPathError?t.jsx("p",{className:"workspace-error",children:Be.importPathError}):null]}):null,Ve==="invite"?t.jsxs("div",{className:"workspace-card",children:[t.jsxs("label",{children:["Invite emails (comma-separated)",t.jsx("input",{className:"search-input",value:Ke.inviteEmails,onChange:a=>_a(o=>({...o,inviteEmails:a.target.value})),placeholder:"ops@example.com, qa@example.com"})]}),Be.inviteEmailsError?t.jsx("p",{className:"workspace-error",children:Be.inviteEmailsError}):null]}):null,t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Ea(a=>a==="invite"?"import":"source"),disabled:Ve==="source",children:"Back"}),Ve!=="invite"?t.jsx("button",{className:"primary-button",type:"button",onClick:()=>Ea(a=>a==="source"?"import":"invite"),children:"Continue"}):t.jsx("button",{className:"primary-button",type:"button",disabled:!Be.isValid,onClick:Ai,children:"Complete setup"})]})]})}):null,Ua&&pe.supportPanelV1?t.jsx("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true","aria-label":"Support diagnostics",children:t.jsxs("div",{className:"palette support-panel",children:[t.jsxs("div",{className:"palette-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"palette-title",children:"Support diagnostics"}),t.jsx("div",{className:"palette-subtitle",children:"Capture environment and handoff payload for support triage."})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>_t(!1),children:"Close"})]}),t.jsxs("label",{children:["Support note",t.jsx("textarea",{className:"search-input",value:Tt,onChange:a=>Fr(a.target.value),rows:3,placeholder:"Describe the issue, reproduction, and expected behavior."})]}),t.jsx("pre",{className:"support-diagnostics-preview",children:JSON.stringify(ha,null,2)}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>void Di(),children:"Copy diagnostics payload"}),t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer",children:"Open help"})]})]})}):null,!mt&&!Qt?t.jsx(Yo,{onComplete:Bi,onStartTour:Hi,onStartStory:vt,persona:xe,onPersonaChange:Cr,launchPath:Na,onLaunchPathChange:Ca,onStartLaunchPath:a=>void qt(a)}):null,mt&&!ja?t.jsx(Xo,{explainMode:Re,storyActive:Ue,onStartTour:()=>{ka(!0),ge(!0)},onStartStory:()=>{ka(!0),vt()},onToggleExplain:()=>Ne(a=>!a),onDismiss:()=>ka(!0)}):null,t.jsx(Jo,{steps:Ii,open:Ta,onClose:Ui,onComplete:Wi}),t.jsx(Vo,{enabled:Re}),t.jsx(el,{active:Ue,label:Pi,step:vs,total:Li,onStop:et,onRestart:vt}),t.jsx(to,{insights:n,investigation:F,onSelectStep:a=>{q(a),u!=="cinema"&&m("cinema")},onJumpToError:it,onJumpToBottleneck:Ae}),t.jsx(qo,{trace:e,mode:u==="matrix"||u==="gameplay"?"cinema":u,playheadMs:Y,selectedStepId:T,compareTrace:j,collapsed:kr,onToggleCollapsed:()=>Sr(a=>!a),onModeChange:oe,onSelectStep:a=>{q(a),u!=="cinema"&&m("cinema")},onJumpToBottleneck:Ae,onReplay:He,onStartTour:()=>ge(!0),priorityQueue:_i}),t.jsxs("nav",{className:"workspace-nav","aria-label":"Workspace navigation",children:[t.jsx("button",{className:`ghost-button ${g==="journey"?"active":""}`,type:"button",onClick:()=>f("journey"),children:"Journey"}),t.jsx("button",{className:`ghost-button ${g==="analysis"?"active":""}`,type:"button",onClick:()=>f("analysis"),children:"Analysis"}),t.jsx("button",{className:`ghost-button ${g==="collaboration"?"active":""}`,type:"button",onClick:()=>f("collaboration"),children:"Collaboration"}),t.jsx("button",{className:`ghost-button ${g==="operations"?"active":""}`,type:"button",onClick:()=>f("operations"),children:"Operations"})]}),t.jsxs("section",{className:"workspace-context-panel","aria-label":"Contextual workspace tools",children:[g==="journey"?t.jsxs("div",{className:"workspace-context-grid",children:[t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Persona progression"}),t.jsx("p",{children:xe==="executive"?"Executive mission path":xe==="operator"?"Operator mission path":"Builder mission path"}),t.jsx("div",{className:"workspace-checklist",children:Gi.map(a=>t.jsxs("div",{className:`workspace-check ${a.done?"done":""}`,children:[t.jsx("span",{children:a.done?"✓":"○"}),t.jsx("span",{children:a.label})]},a.label))})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Saved views"}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("input",{className:"search-input",placeholder:"Saved view name",value:nt,onChange:a=>Yn(a.target.value),"aria-label":"Saved view name"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:$i,disabled:!!Lt,children:"Save view"})]}),Lt&&nt.trim()?t.jsx("p",{className:"workspace-error",children:Lt}):null,t.jsxs("div",{className:"workspace-inline-form",children:[t.jsxs("select",{className:"search-select",value:Ge,onChange:a=>da(a.target.value),"aria-label":"Saved views",children:[t.jsx("option",{value:"",children:"Select saved view"}),Pe.map(a=>t.jsx("option",{value:a.id,children:a.name},a.id))]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Ge&&ln(Ge),disabled:!Ge,children:"Apply"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:Ri,disabled:!Ge,children:"Delete"})]})]})]}):null,g==="analysis"?t.jsxs("div",{className:"workspace-context-grid",children:[t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Async actions"}),la.length===0?t.jsx("p",{children:"No tracked async actions yet."}):null,la.map(a=>t.jsxs("div",{className:`async-action-row status-${a.status}`,children:[t.jsxs("div",{children:[t.jsx("strong",{children:a.label}),t.jsx("p",{children:a.detail})]}),t.jsxs("div",{className:"async-action-actions",children:[a.retryable?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Zr(a.id),children:"Retry"}):null,a.resumable?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>ei(a.id),children:"Resume"}):null]})]},a.id))]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Export center"}),pe.exportCenterV1?null:t.jsx("p",{children:"Export center is disabled by feature flag."}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>bs(),disabled:!e||!pe.exportCenterV1,children:"Queue narrative export"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{Ft({id:"export-support-diagnostics",label:"Support diagnostics JSON",run:()=>cn("agent-director-support-diagnostics.json",JSON.stringify(ha,null,2),"application/json")})},disabled:!pe.exportCenterV1,children:"Queue diagnostics export"})]}),pe.exportCenterV1&&Qn.length===0?t.jsx("p",{children:"No exports queued."}):null,Qn.map(a=>t.jsxs("div",{className:`export-task-row status-${a.status}`,children:[t.jsx("span",{children:a.label}),t.jsx("span",{children:a.detail}),a.retryable?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{var o,h;B("ux.export.retried",{taskId:a.id}),(h=(o=os.current)[a.id])==null||h.call(o)},children:"Retry"}):null]},a.id))]})]}):null,g==="collaboration"?t.jsxs("div",{className:"workspace-context-grid",children:[pe.ownershipPanelV1?null:t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Ownership panel disabled"}),t.jsx("p",{children:"Enable the ownership panel feature flag in Operations to configure handoff ownership."})]}),pe.ownershipPanelV1?t.jsxs(t.Fragment,{children:[t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Ownership and handoff"}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("input",{className:"search-input",value:At,onChange:a=>qr(a.target.value),"aria-label":"Run owner",placeholder:"Run owner"}),t.jsx("input",{className:"search-input",value:Dt,onChange:a=>Gr(a.target.value),"aria-label":"Handoff owner",placeholder:"Handoff owner"})]}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void fa(),children:"Share live link"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void Gt(),children:"Copy handoff digest"})]})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Collaboration activity"}),Qa.length===0?t.jsx("p",{children:"No collaboration activity yet."}):null,t.jsx("div",{className:"workspace-feed",children:Qa.slice(0,8).map(a=>t.jsxs("div",{className:"workspace-feed-item",children:[t.jsx("span",{children:new Date(a.timestamp).toLocaleTimeString()}),t.jsx("span",{children:a.message})]},a.id))})]})]}):null]}):null,g==="operations"?t.jsxs("div",{className:"workspace-context-grid",children:[t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:Z("setup_support_title")}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{ht(!0),B("ux.setup.opened",{source:"operations_panel"})},disabled:!pe.setupWizardV1,children:Z("open_setup_wizard")}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{_t(!0),B("ux.support.opened",{source:"operations_panel"})},disabled:!pe.supportPanelV1,children:Z("open_support_panel")})]}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:pe.setupWizardV1,onChange:()=>ya("setupWizardV1")}),"Setup wizard flag"]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:pe.supportPanelV1,onChange:()=>ya("supportPanelV1")}),"Support panel flag"]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:pe.exportCenterV1,onChange:()=>ya("exportCenterV1")}),"Export center flag"]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:pe.ownershipPanelV1,onChange:()=>ya("ownershipPanelV1")}),"Ownership panel flag"]})]})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:Z("telemetry_summary_title")}),t.jsx("p",{children:Z("telemetry_summary_body")}),t.jsx("div",{className:"workspace-inline-form",children:t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{const a=window.localStorage.getItem("agentDirector.analytics.events.v1")??"[]";Ft({id:"export-analytics-events",label:"Frontend analytics events",run:()=>cn("agent-director-frontend-events.json",a,"application/json")})},children:Z("export_event_queue")})})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:Z("settings_center_title")}),t.jsx("p",{children:Z("settings_center_body")}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:P,onChange:()=>he(a=>!a)}),Z("safe_export")]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:sa,onChange:()=>Un(a=>!a)}),Z("gamepad_enabled")]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:Le,onChange:()=>$e(a=>!a)}),Z("timeline_windowing")]})]}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsxs("label",{children:[Z("theme_label"),t.jsxs("select",{className:"search-select",value:Ct,onChange:a=>En(a.target.value),children:[t.jsx("option",{value:"studio",children:"Studio"}),t.jsx("option",{value:"focus",children:"Focus"}),t.jsx("option",{value:"contrast",children:"Contrast"})]})]}),t.jsxs("label",{children:[Z("motion_label"),t.jsxs("select",{className:"search-select",value:Jt,onChange:a=>_n(a.target.value),children:[t.jsx("option",{value:"cinematic",children:"Cinematic"}),t.jsx("option",{value:"balanced",children:"Balanced"}),t.jsx("option",{value:"minimal",children:"Minimal"})]})]}),t.jsxs("label",{children:[Z("app_language_label"),t.jsx("select",{className:"search-select",value:nn,onChange:a=>Dr(Zs(a.target.value)),children:fc.map(a=>t.jsx("option",{value:a.value,children:a.label},a.value))})]}),t.jsxs("label",{children:[Z("gameplay_locale_label"),t.jsxs("select",{className:"search-select",value:Bn,onChange:a=>Hn(a.target.value),children:[t.jsx("option",{value:"en",children:"English"}),t.jsx("option",{value:"es",children:"Espanol"})]})]})]}),t.jsx("div",{className:"workspace-feed",children:Ut.map(a=>t.jsxs("label",{className:"workspace-inline-form",children:[t.jsx("span",{children:a.label}),t.jsx("select",{className:"search-select",value:st[a.id],onChange:o=>Oi(a.id,o.target.value),"aria-label":`${a.label} shortcut`,children:Nn.map(o=>t.jsx("option",{value:o,children:o.toUpperCase()},o))})]},a.id))})]})]}):null]}),t.jsxs("div",{className:"toolbar","data-help":!0,"data-help-indicator":!0,"data-tour":"toolbar","data-help-title":"Search + filters","data-help-body":"Filter by step type, enable Safe export, and jump between Cinema, Flow, Compare, and Matrix.","data-help-placement":"bottom",children:[t.jsx(no,{query:x,typeFilter:y,onQueryChange:v,onTypeFilterChange:S}),t.jsxs("div",{className:"toolbar-actions",children:[t.jsx("input",{className:"search-input",value:N,onChange:a=>D(a.target.value),placeholder:Z("traceql_placeholder"),"aria-label":"TraceQL query"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void ti(),children:Z("run_traceql")}),J?t.jsxs("span",{className:"status-badge",children:[J.matchCount," match(es)"]}):null,Fi?t.jsx("span",{className:"status-badge",children:"Filtering..."}):null,t.jsxs("span",{className:"status-badge",children:["Hydration ",qi]}),t.jsxs("span",{className:"status-badge",children:["Filter ",zr,"ms"]}),J?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{D(""),I(null),H(null)},children:Z("clear_traceql")}):null,$?t.jsx("span",{className:"status-badge warn",children:$}):null,t.jsxs("select",{className:"search-select",value:k,onChange:a=>E(a.target.value),"aria-label":"Extension selector",children:[t.jsx("option",{value:"",children:Z("select_extension")}),V.map(a=>t.jsx("option",{value:a.id,children:a.name},a.id))]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void ai(),disabled:!e||!k||C,children:Z(C?"running_extension":"run_extension")}),t.jsx("button",{className:`ghost-button ${u==="cinema"?"active":""}`,type:"button","aria-pressed":u==="cinema",title:"Timeline playback",onClick:()=>oe("cinema"),"data-help":!0,"data-help-title":"Cinema mode","data-help-body":"Timeline view with step cards ordered by time.","data-help-placement":"bottom",children:Z("mode_cinema")}),t.jsx("button",{className:`ghost-button ${u==="flow"?"active":""}`,type:"button","aria-pressed":u==="flow",title:"Graph view",onClick:()=>oe("flow"),"data-help":!0,"data-help-title":"Flow mode","data-help-body":"Dependency graph of steps and tool calls.","data-help-placement":"bottom",children:Z("mode_flow")}),t.jsx("button",{className:`ghost-button ${u==="compare"?"active":""}`,type:"button","aria-pressed":u==="compare",title:j?"Side-by-side compare":"Run a replay to enable compare",onClick:()=>oe("compare"),disabled:!j,"data-tour":"compare","data-help":!0,"data-help-title":"Compare mode","data-help-body":"Side-by-side view after a replay. Enabled once you replay.","data-help-placement":"bottom",children:Z("mode_compare")}),t.jsx("button",{className:`ghost-button ${u==="matrix"?"active":""}`,type:"button","aria-pressed":u==="matrix",title:"Counterfactual replay matrix",onClick:()=>oe("matrix"),"data-help":!0,"data-help-title":"Matrix mode","data-help-body":"Run multiple replay scenarios and rank likely causal factors.","data-help-placement":"bottom",children:Z("mode_matrix")}),t.jsx("button",{className:`ghost-button ${u==="gameplay"?"active":""}`,type:"button","aria-pressed":u==="gameplay",title:"Gameplay mechanics command center",onClick:()=>oe("gameplay"),"data-help":!0,"data-help-title":"Gameplay mode","data-help-body":"Command raids, campaign, pvp, time forks, boss runs, economy, and liveops.","data-help-placement":"bottom",children:Z("mode_gameplay")}),t.jsxs("label",{className:"toggle",title:"Redact payloads and disable raw views for safe sharing","data-help":!0,"data-help-title":"Safe export","data-help-body":"Redacts secrets and disables raw payload views for safe sharing.","data-help-placement":"bottom",children:[t.jsx("input",{type:"checkbox",checked:P,onChange:()=>he(a=>!a)}),Z("safe_export")]}),e.steps.length>200||Le?t.jsxs("label",{className:"toggle",title:"Window steps around the playhead for large traces","data-help":!0,"data-help-title":"Windowed mode","data-help-body":"Limits rendering to a playhead window for large traces.","data-help-placement":"bottom",children:[t.jsx("input",{type:"checkbox",checked:Le,onChange:()=>$e(a=>!a)}),Z("windowed")]}):null,j?t.jsxs("label",{className:"toggle",title:"Show ghost overlay of replay in Cinema/Flow","data-help":!0,"data-help-title":"Overlay replay","data-help-body":"Layer the replay over the base run to spot differences.","data-help-placement":"bottom",children:[t.jsx("input",{type:"checkbox",checked:Nt,onChange:()=>Ee(a=>!a)}),Z("overlay")]}):null,t.jsxs("label",{className:"toggle",title:"Follow active collaborator cursor and mode updates",children:[t.jsx("input",{type:"checkbox",checked:Ie,onChange:()=>fe(a=>!a)}),Z("sync_playback")]})]})]}),R?t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Extension output"}),t.jsx("pre",{className:"inspector-json",children:JSON.stringify(R,null,2)})]}):null,u==="cinema"?t.jsxs("div",{className:"playback-stack","data-tour":"playback",children:[t.jsx("div",{"data-help":!0,"data-help-title":"Playback controls","data-help-body":"Play, pause, scrub, and adjust speed to feel the rhythm of the run.","data-help-placement":"bottom",children:t.jsx(Is,{playheadMs:Y,wallTimeMs:e.metadata.wallTimeMs||1,isPlaying:ce,speed:dt,onToggle:()=>A(a=>!a),onScrub:a=>ke(a),onSpeedChange:De})}),t.jsx("div",{"data-help":!0,"data-help-title":"Density map","data-help-body":"Zoom into hotspots and keep long traces readable with windowing.","data-help-placement":"bottom",children:t.jsx(Io,{traceStart:e.startedAt,traceEnd:e.endedAt,steps:e.steps,playheadMs:Y,windowRange:xs,windowed:Le,spanMs:_,onSpanChange:te,onToggleWindowed:$e,onScrub:a=>ke(a),persistenceKey:e.id,laneStrategy:me,visibleLaneGroups:Jr,remotePlayheads:Vr})})]}):null,u==="compare"&&j?t.jsx("div",{"data-help":!0,"data-help-title":"Compare playback","data-help-body":"Sync both runs to evaluate improvements at identical timestamps.","data-help-placement":"bottom",children:t.jsx(Is,{playheadMs:Y,wallTimeMs:Math.max(e.metadata.wallTimeMs||1,j.metadata.wallTimeMs||1),isPlaying:ce,speed:dt,onToggle:()=>A(a=>!a),onScrub:a=>ke(a),onSpeedChange:De})}):null,t.jsxs("main",{className:`stage ${u==="compare"?"stage-compare":""} motion-fade-in`,role:"main",children:[t.jsx("div",{className:"main motion-slide-up",ref:Za,"data-help":!0,"data-help-indicator":!0,"data-tour":"stage","data-help-title":"Trace stage","data-help-body":"Every step becomes a scene. Hover or click to open deep inspection.","data-help-placement":"top",children:t.jsx(nl,{morph:Er,onComplete:Ei,children:t.jsxs(c.Suspense,{fallback:t.jsx("div",{className:"loading",children:Z("loading_view")}),children:[u==="cinema"?t.jsx(jo,{trace:e,steps:cs,selectedStepId:T,onSelectStep:a=>q(a),playheadMs:Y,windowRange:xs,timing:n==null?void 0:n.timing,ghostTrace:Nt?j:null,diff:Wr,laneStrategy:me,laneGroupsOrder:bt.order,hiddenLaneGroups:bt.hidden,onLaneStrategyChange:ni,onToggleLaneGroupVisibility:si,onMoveLaneGroup:gi}):null,u==="flow"?t.jsx(_c,{steps:cs,selectedStepId:T,onSelectStep:a=>q(a),baseTrace:e,compareTrace:j,compareSteps:Ur,overlayEnabled:Nt,onToggleOverlay:()=>Ee(a=>!a)}):null,u==="compare"&&j?t.jsx(Tc,{baseTrace:e,compareTrace:j,playheadMs:Y,safeExport:P,onExit:()=>{m("cinema"),ye(null)}}):null,u==="matrix"?t.jsx(Dc,{steps:e.steps,anchorStepId:Ra,onAnchorStepChange:Oa,scenarios:Pa,onScenarioChange:vi,onDuplicateScenario:Si,onMoveScenario:Ni,onAddScenario:ji,onRemoveScenario:ki,onRun:rn,onCancel:Ci,onReplaceScenarios:wi,loading:_r,error:ta,job:Qe,matrix:Ce,safeExport:P,onOpenCompare:Mi}):null,u==="gameplay"?t.jsx($c,{state:se,playheadMs:Y,onUpdate:a=>It(o=>a(o)),session:de,playerId:_e,sessionError:aa,onCreateSession:ri,onQuickMatchSession:ii,onJoinSession:oi,onLeaveSession:li,onReconnectSession:ci,onDispatchAction:di,guild:Tr,social:Ar,onInviteFriend:fi,onAcceptFriendInvite:yi,locale:Bn,onLocaleChange:Hn,gamepadEnabled:sa,onToggleGamepad:Un,gamepadPreset:Fa,onGamepadPresetChange:$r,isOnline:Rr,onRetryConnectivity:ys,onCreateGuild:ui,onJoinGuild:pi,onScheduleGuildEvent:mi,onCompleteGuildEvent:hi,observability:Or,analytics:Pr}):null]})})}),t.jsx(c.Suspense,{fallback:t.jsx("div",{className:"loading",children:Z("loading_panel")}),children:u==="compare"||u==="matrix"||u==="gameplay"?null:us?t.jsx(Ac,{traceId:e.id,step:us,safeExport:P,onClose:()=>q(null),onReplay:He}):t.jsx(Wo,{trace:e,mode:u,selectedStepId:T,onModeChange:oe,onSelectStep:a=>q(a),onJumpToBottleneck:Ae,onReplay:He,recommendations:qe,persona:xe,annotations:Kr,activityFeed:Qa,onAddAnnotation:xi,missionProgress:Kt,missionCompletion:ps,onResetMissions:bi,narrative:ot,onAskDirector:Ti,onExportNarrative:bs})})]}),t.jsxs("div",{className:"mobile-quick-rail","aria-label":"Mobile quick actions",children:[t.jsx("button",{className:`ghost-button ${Ue?"active":""}`,type:"button",onClick:wt,"aria-label":Ue?"Stop story mode":"Start story mode",children:Ue?"Stop Story":"Story"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>ge(!0),"aria-label":"Start guided tour",children:"Guide"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Fe(!0),"aria-label":"Open command palette",children:"Command"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void Gt(),"aria-label":"Copy handoff digest",children:"Handoff"})]}),t.jsx(Zo,{mode:u==="matrix"||u==="gameplay"?"cinema":u,isPlaying:ce,storyActive:Ue,explainMode:Re,hidden:u==="compare",open:Nr,onToggleOpen:()=>Sa(a=>!a),onTogglePlay:on,onStartStory:vt,onStopStory:et,onStartTour:()=>ge(!0),onOpenPalette:()=>Fe(!0),onShowShortcuts:()=>Se(!0),onToggleExplain:()=>Ne(a=>!a),onJumpToBottleneck:Ae}),t.jsx(Lo,{open:St,onClose:()=>Fe(!1),actions:zi,context:{section:g,mode:u,persona:xe},onActionRun:a=>B("ux.palette.command_run",{id:a.id,group:a.group??null})}),t.jsx($o,{open:be,onClose:()=>Se(!1),bindings:st})]})}Vi.createRoot(document.getElementById("root")).render(t.jsx(Ki.StrictMode,{children:t.jsx(Gc,{})}));"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js")});export{rd as A,dd as B,id as C,od as D,ld as E,cd as F,ud as G,hd as H,fd as I,md as J,ho as S,vo as T,Vl as a,Yl as b,No as c,pr as d,Uc as e,Hc as f,vl as g,cn as h,cc as i,Jc as j,dc as k,uc as l,Wc as m,Vc as n,pd as o,Kc as p,Qc as q,Xc as r,ro as s,Zc as t,Yc as u,ed as v,td as w,ad as x,nd as y,sd as z};
