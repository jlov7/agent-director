const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DV4ABu7r.js","assets/vendor-react-D4yGots9.js","assets/vendor-DClHNS3s.js","assets/vendor-B5DZHykP.css","assets/index-B64owC2L.js","assets/index-CE2CPFBw.js","assets/index-Cmv7wfhp.js","assets/index-KpyKW-ng.js"])))=>i.map(i=>d[i]);
import{j as t,r as l,a as Po,R as Lo}from"./vendor-react-D4yGots9.js";import{m as Fo,d as er}from"./vendor-DClHNS3s.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const d of i)if(d.type==="childList")for(const c of d.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function s(i){const d={};return i.integrity&&(d.integrity=i.integrity),i.referrerPolicy&&(d.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?d.credentials="include":i.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function r(i){if(i.ep)return;i.ep=!0;const d=s(i);fetch(i.href,d)}})();const qo="modulepreload",zo=function(e){return"/agent-director/"+e},tr={},Qe=function(n,s,r){let i=Promise.resolve();if(s&&s.length>0){document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),p=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));i=Promise.allSettled(s.map(u=>{if(u=zo(u),u in tr)return;tr[u]=!0;const h=u.endsWith(".css"),f=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${f}`))return;const y=document.createElement("link");if(y.rel=h?"stylesheet":qo,h||(y.as="script"),y.crossOrigin="",y.href=u,p&&y.setAttribute("nonce",p),document.head.appendChild(y),h)return new Promise((w,x)=>{y.addEventListener("load",w),y.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${u}`)))})}))}function d(c){const p=new Event("vite:preloadError",{cancelable:!0});if(p.payload=c,window.dispatchEvent(p),!p.defaultPrevented)throw c}return i.then(c=>{for(const p of c||[])p.status==="rejected"&&d(p.reason);return n().catch(d)})},Go=()=>t.jsxs("svg",{className:"logo-mark",width:"54",height:"54",viewBox:"0 0 120 120",role:"img","aria-label":"Agent Director logo",children:[t.jsx("rect",{x:"8",y:"8",width:"104",height:"104",rx:"18",className:"logo-frame"}),t.jsx("rect",{x:"24",y:"28",width:"72",height:"16",rx:"6",className:"logo-bar logo-bar-a"}),t.jsx("rect",{x:"24",y:"52",width:"72",height:"16",rx:"6",className:"logo-bar logo-bar-b"}),t.jsx("rect",{x:"24",y:"76",width:"72",height:"16",rx:"6",className:"logo-bar logo-bar-c"}),t.jsx("circle",{cx:"96",cy:"36",r:"6",className:"logo-node logo-node-a"}),t.jsx("circle",{cx:"96",cy:"60",r:"6",className:"logo-node logo-node-b"}),t.jsx("circle",{cx:"96",cy:"84",r:"6",className:"logo-node logo-node-c"})]});function Bo({trace:e,traces:n=[],selectedTraceId:s,onSelectTrace:r,onReload:i,onStartTour:d,onToggleStory:c,onOpenPalette:p,onToggleExplain:u,onShareSession:h,onThemeChange:f,onMotionChange:y,densityMode:w="auto",onDensityChange:x,themeMode:k="studio",motionMode:b="balanced",activeSessions:j=1,shareStatus:C=null,handoffStatus:D=null,explainMode:V=!1,storyActive:T=!1,mode:R="cinema",missionCompletion:W,runHealthScore:q=100,modeHotkeys:L="C / F / Space",onCreateHandoffDigest:H,onOpenSupport:re,workspaces:S=[],workspaceId:_,onWorkspaceChange:$,workspaceRole:B="operator",onWorkspaceRoleChange:E,sessionLabel:K="Active",sessionExpired:he=!1,onRenewSession:Y}){const[te,Ce]=l.useState(!1),[we,ve]=l.useState(!1),v=Math.max(0,Math.min(100,Math.round(q))),X=W?`${W.done}/${W.total} missions`:"Missions n/a",ae=(e==null?void 0:e.status)==="completed"?"completed ✓":(e==null?void 0:e.status)==="running"?"running ↻":(e==null?void 0:e.status)==="failed"?"failed !":"loading …";return l.useEffect(()=>{const I=()=>{typeof window>"u"||Ce(window.innerWidth<=980)};return I(),window.addEventListener("resize",I),()=>window.removeEventListener("resize",I)},[]),l.useEffect(()=>{te||ve(!1)},[te]),t.jsxs("header",{className:"header","data-help":!0,"data-help-indicator":!0,"data-tour":"header","data-help-title":"Mission control","data-help-body":"Trace identity, status, and live controls live here. Use Story, Guide, or Explain to orient new viewers.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"header-title",children:[t.jsxs("div",{className:"header-logo",children:[t.jsx(Go,{}),t.jsx("span",{children:"Agent Director"})]}),t.jsx("div",{className:"header-tagline",children:"Cinematic trace intelligence for agent runs."}),t.jsxs("div",{className:"header-meta",children:[t.jsxs("span",{className:"header-run",children:["Run: ",(e==null?void 0:e.id)??"loading"]}),n.length>0?t.jsx("select",{className:"trace-select",value:s??(e==null?void 0:e.id)??"","aria-label":"Select trace",onChange:I=>r==null?void 0:r(I.target.value),"data-help":!0,"data-help-title":"Trace selector","data-help-body":"Switch between available runs to compare different sessions.","data-help-placement":"bottom",children:n.map(I=>t.jsxs("option",{value:I.id,children:[I.name," (",I.id,")"]},I.id))}):null,t.jsx("span",{className:`status-pill status-${(e==null?void 0:e.status)??"loading"}`,children:ae}),e!=null&&e.replay?t.jsxs("span",{className:"header-replay header-meta-secondary",title:`Replay from ${e.branchPointStepId??"unknown step"}`,children:["Replay: ",e.replay.strategy]}):null,t.jsxs("span",{className:"header-wall",children:["Wall: ",(e==null?void 0:e.metadata.wallTimeMs)??0,"ms"]}),t.jsxs("span",{className:"header-presence header-meta-secondary","aria-label":"Active sessions",children:["Live: ",j]}),t.jsxs("span",{className:"header-mode-pill header-meta-secondary","aria-label":"Current mode",children:["Mode: ",R]}),_?t.jsxs("span",{className:"header-workspace-pill header-meta-secondary","aria-label":"Current workspace",children:["Workspace: ",_]}):null,t.jsxs("span",{className:`header-role-pill role-${B} header-meta-secondary`,"aria-label":"Current workspace role",children:["Role: ",B]}),t.jsxs("span",{className:`header-session-pill ${he?"expired":""} header-meta-secondary`,"aria-label":"Session status",children:["Session: ",K]}),t.jsxs("span",{className:"header-hotkeys header-meta-secondary","aria-label":"Mode hotkeys",children:["Keys: ",L]}),t.jsx("span",{className:"header-mission header-meta-secondary","aria-label":"Mission completion",children:X}),t.jsxs("span",{className:"header-health","aria-label":`Run health score ${v}`,children:[t.jsx("span",{className:"header-health-bar",children:t.jsx("span",{className:"header-health-fill",style:{width:`${v}%`}})}),t.jsxs("span",{children:["Health ",v]})]}),C?t.jsx("span",{className:"header-share-status header-meta-secondary",children:C}):null,D?t.jsx("span",{className:"header-share-status header-meta-secondary",children:D}):null]})]}),t.jsxs("div",{className:"header-actions",children:[t.jsxs("div",{className:"header-actions-primary",children:[t.jsxs("label",{className:"theme-picker",children:["Workspace",t.jsx("select",{className:"trace-select",value:_,"aria-label":"Select workspace",onChange:I=>$==null?void 0:$(I.target.value),children:S.map(I=>t.jsx("option",{value:I.id,children:I.label},I.id))})]}),t.jsxs("label",{className:"theme-picker",children:["Role",t.jsxs("select",{className:"trace-select",value:B,"aria-label":"Select workspace role",onChange:I=>E==null?void 0:E(I.target.value),children:[t.jsx("option",{value:"viewer",children:"Viewer"}),t.jsx("option",{value:"operator",children:"Operator"}),t.jsx("option",{value:"admin",children:"Admin"})]})]}),t.jsx("button",{className:`ghost-button ${T?"active":""}`,type:"button",onClick:c,"aria-pressed":T,"aria-label":"Toggle story mode","data-help":!0,"data-help-title":"Story mode","data-help-body":"Auto-runs a cinematic walkthrough for demos.","data-help-placement":"bottom",children:"Story"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:d,"aria-label":"Start guided tour","data-help":!0,"data-help-title":"Guided tour","data-help-body":"Walk through the interface step by step.","data-help-placement":"bottom",children:"Guide"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:p,"aria-label":"Open command palette","data-help":!0,"data-help-title":"Command palette","data-help-body":"Search and trigger any action instantly.","data-help-placement":"bottom",children:"Command"}),t.jsx("button",{className:`ghost-button ${V?"active":""}`,type:"button",onClick:u,"aria-pressed":V,"aria-label":"Toggle explain mode","data-help":!0,"data-help-title":"Explain mode","data-help-body":"Hover any control to see contextual guidance.","data-help-placement":"bottom",children:"Explain"}),te?t.jsx("button",{className:`ghost-button header-actions-toggle ${we?"active":""}`,type:"button","aria-expanded":we,"aria-controls":"header-secondary-actions",onClick:()=>ve(I=>!I),children:we?"Fewer actions":"More actions"}):null]}),t.jsxs("div",{id:"header-secondary-actions",className:`header-actions-secondary ${!te||we?"open":""}`,children:[t.jsxs("label",{className:"theme-picker",children:["Theme",t.jsxs("select",{className:"trace-select",value:k,"aria-label":"Select theme",onChange:I=>f==null?void 0:f(I.target.value),children:[t.jsx("option",{value:"studio",children:"Studio"}),t.jsx("option",{value:"focus",children:"Focus"}),t.jsx("option",{value:"contrast",children:"Contrast"})]})]}),t.jsxs("label",{className:"theme-picker",children:["Motion",t.jsxs("select",{className:"trace-select",value:b,"aria-label":"Select motion profile",onChange:I=>y==null?void 0:y(I.target.value),children:[t.jsx("option",{value:"cinematic",children:"Cinematic"}),t.jsx("option",{value:"balanced",children:"Balanced"}),t.jsx("option",{value:"minimal",children:"Minimal"})]})]}),t.jsxs("label",{className:"theme-picker",children:["Density",t.jsxs("select",{className:"trace-select",value:w,"aria-label":"Select density profile",onChange:I=>x==null?void 0:x(I.target.value),children:[t.jsx("option",{value:"auto",children:"Auto"}),t.jsx("option",{value:"comfortable",children:"Comfortable"}),t.jsx("option",{value:"compact",children:"Compact"})]})]}),t.jsx("button",{className:"ghost-button",onClick:i,type:"button","aria-label":"Refresh traces",title:"Refresh traces","data-help":!0,"data-help-title":"Refresh","data-help-body":"Reload traces from the data store.","data-help-placement":"bottom",children:"Refresh"}),t.jsx("button",{className:`ghost-button ${he?"warn":""}`,type:"button",onClick:Y,"aria-label":"Renew workspace session",title:"Renew workspace session",children:"Renew Session"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:h,"aria-label":"Copy live session link",title:"Copy live session link",children:"Share"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:H,"aria-label":"Copy session handoff digest",title:"Copy session handoff digest",children:"Handoff"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:re,"aria-label":"Open support diagnostics",title:"Open support diagnostics",children:"Support"}),t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer","data-help":!0,"data-help-title":"Help","data-help-body":"Open quick docs for first run, key flows, troubleshooting, and shortcuts.","data-help-placement":"bottom",children:"Help"}),null]})]})]})}function Wo({insights:e,investigation:n,onSelectStep:s,onJumpToBottleneck:r,onJumpToError:i}){var w,x,k,b,j;if(!e)return null;const d=e.timing,c=e.ioWarnings??[],p=e.concurrency,u=e.retryPatterns,h=e.costByTool??{},f=e.costByModel??{},y=((w=n==null?void 0:n.hypotheses)==null?void 0:w.slice(0,2))??[];return t.jsxs("section",{className:"insight-strip","data-help":!0,"data-help-indicator":!0,"data-tour":"insights","data-help-title":"Run insights","data-help-body":"Fast diagnostics for latency, cost, errors, and concurrency. Click chips to jump into the trace.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Top latency","data-help-body":"Largest steps by duration; jump straight to the slowest.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Top latency"}),t.jsxs("div",{className:"insight-items",children:[e.topLatencySteps.map(C=>t.jsxs("button",{className:"insight-chip",type:"button",title:`Jump to ${C.name}`,onClick:()=>s==null?void 0:s(C.stepId),children:[C.name," (",C.durationMs,"ms)"]},C.stepId)),e.topLatencySteps.length>0?t.jsx("button",{className:"insight-chip",type:"button",onClick:r,title:"Jump to longest step",children:"Jump to bottleneck"}):null]})]}),t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Cost by type","data-help-body":"Aggregated spend by step class.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Cost by type"}),t.jsx("div",{className:"insight-items",children:Object.entries(e.costByType).map(([C,D])=>t.jsxs("span",{className:"insight-chip",title:`Total cost for ${C}`,children:[C,": $",D.toFixed(3)]},C))})]}),Object.keys(h).length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Cost by tool","data-help-body":"Top tools by total spend.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Cost by tool"}),t.jsx("div",{className:"insight-items",children:Object.entries(h).sort((C,D)=>D[1]-C[1]).slice(0,3).map(([C,D])=>t.jsxs("span",{className:"insight-chip",title:`Total cost for ${C}`,children:[C,": $",D.toFixed(3)]},C))})]}):null,t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Errors & retries","data-help-body":"Instant visibility into failed or retried steps.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Errors / retries"}),t.jsxs("div",{className:"insight-items",children:[t.jsxs("span",{className:"insight-chip",children:["Errors: ",e.errors]}),t.jsxs("span",{className:"insight-chip",children:["Retries: ",e.retries]}),e.errors>0?t.jsx("button",{className:"insight-chip",type:"button",onClick:i,title:"Jump to first error",children:"Jump to first error"}):null,(x=u==null?void 0:u.topRetries)!=null&&x.length?t.jsxs("span",{className:"insight-chip",title:`Retry rate ${(u.retryRate*100).toFixed(1)}%`,children:["Top retries: ",u.topRetries.length]}):null]})]}),t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Wall vs work","data-help-body":"Wall time vs summed work to show parallelism.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Wall vs work"}),t.jsxs("div",{className:"insight-items",children:[t.jsxs("span",{className:"insight-chip",title:"Wall clock duration",children:["Wall: ",e.wallTimeMs,"ms"]}),t.jsxs("span",{className:"insight-chip",title:"Sum of step durations",children:["Work: ",e.workTimeMs,"ms"]}),e.criticalPathMs!=null?t.jsxs("span",{className:"insight-chip",title:"Longest parent-child chain",children:["Critical: ",e.criticalPathMs,"ms"]}):null]})]}),t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Health","data-help-body":"Timing and I/O anomalies detected in the trace.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Health"}),t.jsxs("div",{className:"insight-items",children:[d!=null&&d.degraded?t.jsx("span",{className:"insight-chip insight-warning",title:d.issues.join(" "),children:"Timing degraded"}):t.jsx("span",{className:"insight-chip",children:"Timing OK"}),c.length>0?t.jsxs("span",{className:"insight-chip insight-warning",title:c.map(C=>C.message).join(" "),children:["IO warnings: ",c.length]}):t.jsx("span",{className:"insight-chip",children:"IO OK"})]})]}),y.length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Investigator","data-help-body":"Automated root-cause hypotheses ranked by severity and confidence.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Investigator"}),t.jsxs("div",{className:"insight-items",children:[y.map(C=>t.jsxs("span",{className:"insight-chip",title:C.summary,children:[C.title," (",Math.round(C.confidence*100),"%)"]},C.id)),(b=(k=y[0])==null?void 0:k.evidenceStepIds)!=null&&b[0]?t.jsx("button",{className:"insight-chip",type:"button",onClick:()=>s==null?void 0:s(y[0].evidenceStepIds[0]),children:"Jump to evidence"}):null]})]}):null,(j=p==null?void 0:p.buckets)!=null&&j.length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Parallelism","data-help-body":"How many steps ran concurrently over time.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Parallelism"}),t.jsx("div",{className:"insight-items",children:t.jsx("div",{className:"insight-heatmap",title:`Peak concurrency: ${p.peak}`,children:p.buckets.map((C,D)=>t.jsx("span",{className:"heatmap-bar",style:{height:`${Math.max(20,C.active/Math.max(1,p.peak)*48)}px`},title:`Bucket ${D+1}: ${C.active} active`},`${C.startMs}-${C.endMs}`))})})]}):null,Object.keys(f).length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Model cost","data-help-body":"Spend by model family.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Model cost"}),t.jsx("div",{className:"insight-items",children:Object.entries(f).map(([C,D])=>t.jsxs("span",{className:"insight-chip",title:`Total cost for ${C}`,children:[C,": $",D.toFixed(3)]},C))})]}):null]})}const Ho=["all","llm_call","tool_call","decision","handoff","guardrail"];function Uo({query:e,typeFilter:n,onQueryChange:s,onTypeFilterChange:r}){return t.jsxs("div",{className:"search-bar",children:[t.jsx("input",{className:"search-input",placeholder:"Search steps, tools, previews...","aria-label":"Search steps",value:e,onChange:i=>s(i.target.value),"data-help":!0,"data-help-title":"Search","data-help-body":"Filter steps by name, tool, or payload preview. Great for fast recall.","data-help-placement":"bottom"}),t.jsx("select",{className:"search-select",value:n,"aria-label":"Filter by step type",onChange:i=>r(i.target.value),"data-help":!0,"data-help-title":"Type filter","data-help-body":"Narrow the timeline to a specific class of steps (LLM, tool, decision, handoff).","data-help-placement":"bottom",children:Ho.map(i=>t.jsx("option",{value:i,children:i},i))})]})}function Ia(e,n,s){const r=Date.parse(e),i=s.map(f=>Date.parse(f.endedAt??f.startedAt)).filter(f=>Number.isFinite(f)),d=n?Date.parse(n):i.length?Math.max(...i):r,c=Math.max(1,d-r),p=s.map(f=>{const y=Math.max(0,Date.parse(f.startedAt)-r),w=Math.max(y,Date.parse(f.endedAt??f.startedAt)-r);return{stepId:f.id,startMs:y,endMs:w}}).sort((f,y)=>f.startMs-y.startMs||f.endMs-y.endMs),u=[],h=[];for(const f of p){let y=u.findIndex(w=>w<=f.startMs);y===-1?(y=u.length,u.push(f.endMs)):u[y]=f.endMs,h.push({stepId:f.stepId,startMs:f.startMs,endMs:f.endMs,lane:y,xPct:f.startMs/c*100,wPct:Math.max(.75,(f.endMs-f.startMs)/c*100)})}return{wallTimeMs:c,intervals:h,laneCount:u.length}}function Vo(e){var k;const s=e.steps.map(b=>({stepId:b.id,name:b.name,durationMs:b.durationMs??0})).sort((b,j)=>j.durationMs-b.durationMs).slice(0,3),r={},i={};for(const b of e.steps)((k=b.metrics)==null?void 0:k.costUsd)!=null&&(r[b.type]=(r[b.type]??0)+b.metrics.costUsd,b.type==="tool_call"&&(i[b.name]=(i[b.name]??0)+b.metrics.costUsd));const d=e.steps.filter(b=>b.status==="failed").length,c=e.steps.filter(b=>!!b.retryOfStepId).length,p=e.metadata.wallTimeMs,u=e.metadata.workTimeMs??e.steps.reduce((b,j)=>b+(j.durationMs??0),0),h=Ko(e),f=Qo(e.steps),y=Yo(e.steps),w=Xo(e),x=Zo(e.steps);return{topLatencySteps:s,costByType:r,costByTool:i,costByModel:{[e.metadata.modelId]:e.metadata.totalCostUsd??0},errors:d,retries:c,wallTimeMs:p,workTimeMs:u,timing:h,ioWarnings:f,criticalPathMs:y,concurrency:w,retryPatterns:x}}function Jo(e){var s;const n=(s=e.metrics)==null?void 0:s.costUsd;return n==null?null:`$${n.toFixed(3)}`}function Ke(e){if(!e)return null;const n=Date.parse(e);return Number.isNaN(n)?null:n}function Ko(e){const n=Ke(e.startedAt),s=Ke(e.endedAt??void 0),r=[],i=[],d=[];return n==null&&d.push("Trace start time missing or invalid."),e.steps.forEach(c=>{const p=Ke(c.startedAt),u=Ke(c.endedAt??c.startedAt);if(p==null||u==null){r.push(c.id);return}if(u<p){i.push(c.id);return}n!=null&&p<n&&i.push(c.id),s!=null&&u>s&&i.push(c.id)}),r.length&&d.push(`Missing timestamps on ${r.length} steps.`),i.length&&d.push(`Timestamp skew detected on ${i.length} steps.`),{degraded:!!(r.length||i.length||n==null),issues:d,missingStepIds:r,skewedStepIds:i}}function Qo(e){const n=new Map;e.forEach(d=>{d.type==="tool_call"&&d.toolCallId&&n.set(d.toolCallId,d)});const s=new Set,r=new Set,i=[];return e.forEach(d=>{d.type!=="llm_call"||!d.io||((d.io.emittedToolCallIds??[]).forEach(c=>{s.add(c),n.has(c)||i.push({kind:"missing_tool_step",message:`Emitted toolCallId ${c} has no tool step.`,stepId:d.id,toolCallId:c})}),(d.io.consumedToolCallIds??[]).forEach(c=>{r.add(c),n.has(c)||i.push({kind:"missing_tool_step",message:`Consumed toolCallId ${c} has no tool step.`,stepId:d.id,toolCallId:c}),s.has(c)||i.push({kind:"consume_without_emit",message:`Consumed toolCallId ${c} without emission.`,stepId:d.id,toolCallId:c})}))}),n.forEach((d,c)=>{s.has(c)||i.push({kind:"unemitted_tool",message:`Tool step ${d.id} has toolCallId ${c} never emitted.`,stepId:d.id,toolCallId:c}),r.has(c)||i.push({kind:"unconsumed_tool",message:`Tool step ${d.id} has toolCallId ${c} never consumed.`,stepId:d.id,toolCallId:c})}),i}function Yo(e){const n=new Map,s=new Map,r=[];e.forEach(c=>{if(n.set(c.id,c.durationMs??0),c.parentStepId){const p=s.get(c.parentStepId)??[];p.push(c.id),s.set(c.parentStepId,p)}else r.push(c.id)});const i=new Map,d=c=>{if(i.has(c))return i.get(c)??0;const u=(s.get(c)??[]).reduce((f,y)=>Math.max(f,d(y)),0),h=(n.get(c)??0)+u;return i.set(c,h),h};return r.length?Math.max(...r.map(c=>d(c))):0}function Xo(e){const n=Ke(e.startedAt);if(n==null)return{buckets:[],peak:0};const s=Ke(e.endedAt??void 0)??Math.max(...e.steps.map(u=>Ke(u.endedAt??u.startedAt)??n),n),r=Math.max(1,s-n),i=12,d=Math.max(1,Math.floor(r/i)),c=[];let p=0;for(let u=0;u<i;u+=1){const h=n+u*d,f=h+d;let y=0;e.steps.forEach(w=>{const x=Ke(w.startedAt),k=Ke(w.endedAt??w.startedAt);x==null||k==null||k>=h&&x<=f&&(y+=1)}),p=Math.max(p,y),c.push({startMs:u*d,endMs:(u+1)*d,active:y})}return{buckets:c,peak:p}}function Zo(e){const n={};e.forEach(i=>{i.retryOfStepId&&(n[i.retryOfStepId]=(n[i.retryOfStepId]??0)+1)});const s=Object.values(n).reduce((i,d)=>i+d,0),r=Object.entries(n).sort((i,d)=>d[1]-i[1]).slice(0,3);return{totalRetries:s,retryRate:e.length?s/e.length:0,topRetries:r.map(([i,d])=>({stepId:i,count:d}))}}const el={llm_call:{label:"LLM",icon:"LLM",description:"Model call"},tool_call:{label:"TOOL",icon:"TOOL",description:"Tool call"},decision:{label:"DEC",icon:"DEC",description:"Decision"},handoff:{label:"HAND",icon:"HAND",description:"Handoff"},guardrail:{label:"GUARD",icon:"GUARD",description:"Guardrail"}};function tl(e){return el[e]}function al({type:e,size:n="sm",showLabel:s=!1}){const r=tl(e);return t.jsxs("span",{className:`step-badge step-badge-${e} step-badge-${n}`,title:r.description,children:[t.jsx("span",{className:"step-badge-icon",children:r.icon}),s?t.jsx("span",{className:"step-badge-label",children:r.label}):null]})}function Fr({step:e,interval:n,playbackState:s,selected:r,onSelect:i,variant:d="base",diffStatus:c,disabled:p=!1,laneHeight:u=140}){var T,R,W,q,L,H;const h=Jo(e),f=((T=e.preview)==null?void 0:T.subtitle)??((R=e.preview)==null?void 0:R.title)??"",y=((W=e.preview)==null?void 0:W.outputPreview)??((q=e.preview)==null?void 0:q.inputPreview)??"",w=c?`step-diff-${c}`:"",x=d==="ghost"?"step-ghost":"",k=n.wPct<8?"step-compact":"",b=e.type.replace("_"," ").toUpperCase(),j=((L=e.metrics)==null?void 0:L.tokensTotal)!=null?`${e.metrics.tokensTotal} tokens`:null,C=e.durationMs!=null?`${e.durationMs}ms`:null,D=[j,C,h].filter(Boolean).join(" · "),V=`Click to inspect inputs/outputs and replay from this moment.${D?` ${D}.`:""}`;return t.jsxs("button",{type:"button",className:`step-card step-${e.type} step-${s} ${r?"step-selected":""} ${w} ${x} ${k}`,"data-step-id":e.id,"aria-pressed":r,"aria-hidden":d==="ghost",disabled:p,"data-help":!0,"data-help-title":`${e.name} · ${b}`,"data-help-body":V,"data-help-placement":"top",style:{left:`${n.xPct}%`,width:`${n.wPct}%`,top:`${n.lane*u}px`},onClick:()=>{p||i(e.id)},children:[t.jsxs("div",{className:"step-card-header",children:[t.jsxs("div",{className:"step-title-group",children:[t.jsx(al,{type:e.type}),t.jsx("span",{className:"step-title",children:e.name})]}),t.jsx("span",{className:`status-pill status-${e.status}`,children:e.status})]}),f?t.jsx("div",{className:"step-subtitle",children:f}):null,t.jsxs("div",{className:"step-metrics",children:[((H=e.metrics)==null?void 0:H.tokensTotal)!=null?t.jsxs("span",{children:[e.metrics.tokensTotal," tok"]}):null,e.durationMs!=null?t.jsxs("span",{children:[e.durationMs,"ms"]}):null,h?t.jsx("span",{children:h}):null]}),y?t.jsx("div",{className:"step-preview",children:y}):null]})}function qr(e,n){return n<e.startMs?"future":n>e.endMs?"past":"active"}const Yt={type:{order:[],hidden:[]},status:{order:[],hidden:[]},parent:{order:[],hidden:[]}};function Gn(e,n){return n==="type"?e.type:n==="status"?e.status:e.parentStepId??"root"}function nl(e,n){const s=new Set;return e.forEach(r=>s.add(Gn(r,n))),Array.from(s).sort((r,i)=>r.localeCompare(i))}function ar(e,n,s){const r=new Set(e),i=[...n.filter(c=>r.has(c))];e.forEach(c=>{i.includes(c)||i.push(c)});const d=Array.from(new Set(s.filter(c=>r.has(c))));return{order:i,hidden:d}}const sl=140,rl=132,il=96,nr={llm_call:1,tool_call:2,decision:3,handoff:4,guardrail:5};function zr(e){return[...e].sort((n,s)=>(nr[n.type]??9)-(nr[s.type]??9))}function ol(e,n,s,r,i){const d=new Map;n.forEach(w=>{var k;const x=Gn(w,s);d.has(x)||d.set(x,[]),(k=d.get(x))==null||k.push(w)});const c=Array.from(d.keys()),p=[...r.filter(w=>c.includes(w))];c.forEach(w=>{p.includes(w)||p.push(w)});const u=p.filter(w=>!i.includes(w)),h=new Map;let f=0,y=0;return u.forEach(w=>{const x=d.get(w)??[],k=Ia(e.startedAt,e.endedAt,x);k.intervals.forEach(b=>{h.set(b.stepId,{...b,lane:b.lane+f})}),f+=Math.max(1,k.laneCount)}),y=Math.max(1,f),{intervalsByStepId:h,laneCount:y,visibleGroups:u}}function ll({trace:e,steps:n,selectedStepId:s,onSelectStep:r,playheadPct:i,playheadMs:d,windowRange:c,ghostTrace:p,diff:u,laneStrategy:h="type",laneGroupsOrder:f=[],hiddenLaneGroups:y=[],laneHeight:w=sl,cardHeight:x=rl,compactHeight:k=il}){const{intervalsByStepId:b,laneCount:j}=ol(e,n,h,f,y),C=Array.from(b.values()),D=new Map(C.map(S=>[S.stepId,S])),V=zr(n),T=e.metadata.wallTimeMs||1,R=new Set((u==null?void 0:u.removedSteps)??[]),W=new Set((u==null?void 0:u.changedSteps)??[]),q=new Set(((u==null?void 0:u.changedPairs)??[]).map(S=>S.rightId)),L=new Set((u==null?void 0:u.addedSteps)??[]);let H=C;if(c){const S=c.endMs-c.startMs,_=Math.max(1e3,S*.15),$=Math.max(0,c.startMs-_),B=c.endMs+_;if(H=C.filter(E=>E.endMs>=$&&E.startMs<=B),s&&!H.some(E=>E.stepId===s)){const E=D.get(s);E&&(H=[...H,E])}}const re=new Set(H.map(S=>S.stepId));return t.jsx("div",{className:"timeline",style:{"--step-card-height":`${x}px`,"--step-compact-height":`${k}px`},children:t.jsxs("div",{className:"timeline-grid",style:{height:`${j*w}px`},"data-help":!0,"data-help-title":"Timeline lanes","data-help-body":"Each lane stacks overlapping steps; width reflects duration.","data-help-placement":"top",children:[t.jsx("div",{className:"playback-cursor",style:{left:`${i}%`}}),V.filter(S=>re.has(S.id)).filter(S=>!y.includes(Gn(S,h))).map(S=>{const _=D.get(S.id);if(!_)return null;const $=qr(_,d);return t.jsx(Fr,{step:S,interval:_,playbackState:$,selected:s===S.id,diffStatus:R.has(S.id)?"removed":W.has(S.id)?"changed":null,laneHeight:w,onSelect:r},S.id)}),p?t.jsx(cl,{ghostTrace:p,baseWallTimeMs:T,playheadMs:d,windowRange:c,diffAdded:L,diffChanged:q,laneHeight:w}):null]})})}function cl({ghostTrace:e,baseWallTimeMs:n,playheadMs:s,windowRange:r,diffAdded:i,diffChanged:d,laneHeight:c}){const{intervals:p,laneCount:u}=Ia(e.startedAt,e.endedAt,e.steps),h=new Map(p.map(b=>[b.stepId,b])),f=e.metadata.wallTimeMs||1,y=s/n*f;let w=p;if(r){const b=r.endMs-r.startMs,j=Math.max(1e3,b*.15),C=f/n,D=Math.max(0,(r.startMs-j)*C),V=Math.min(f,(r.endMs+j)*C);w=p.filter(T=>T.endMs>=D&&T.startMs<=V)}const x=new Set(w.map(b=>b.stepId)),k=zr(e.steps);return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"ghost-lanes",style:{height:`${u*c}px`}}),k.filter(b=>x.has(b.id)).map(b=>{const j=h.get(b.id);if(!j)return null;const C=qr(j,y),D=i.has(b.id)?"added":d.has(b.id)?"changed":null;return t.jsx(Fr,{step:b,interval:j,playbackState:C,selected:!1,diffStatus:D,variant:"ghost",disabled:!0,laneHeight:c,onSelect:()=>{}},`ghost-${b.id}`)})]})}function dl({trace:e,steps:n,selectedStepId:s,onSelectStep:r,playheadMs:i,windowRange:d,timing:c,ghostTrace:p,diff:u,laneStrategy:h,laneGroupsOrder:f,hiddenLaneGroups:y,onLaneStrategyChange:w,onToggleLaneGroupVisibility:x,onMoveLaneGroup:k}){const b=e.metadata.wallTimeMs||1,j=Math.min(100,Math.max(0,i/b*100)),C=f.filter(D=>!y.includes(D)).length;return t.jsxs("section",{className:"cinema-mode","aria-label":"Cinema mode",children:[c!=null&&c.degraded?t.jsxs("div",{className:"timing-banner",title:c.issues.join(" "),children:["Timing degraded: ",c.issues[0]??"Check timestamps."]}):null,t.jsxs("div",{className:"timeline-studio-panel","data-help":!0,"data-help-title":"Timeline studio","data-help-body":"Regroup lanes by type/status/parent, hide noisy groups, and reorder emphasis.",children:[t.jsxs("label",{className:"timeline-studio-strategy",children:["Lane strategy",t.jsxs("select",{value:h,onChange:D=>w(D.target.value),children:[t.jsx("option",{value:"type",children:"Type"}),t.jsx("option",{value:"status",children:"Status"}),t.jsx("option",{value:"parent",children:"Parent branch"})]})]}),t.jsxs("div",{className:"timeline-studio-summary",children:[C,"/",f.length," groups visible"]}),t.jsx("div",{className:"timeline-studio-groups",children:f.map((D,V)=>{const T=y.includes(D);return t.jsxs("div",{className:`timeline-studio-group ${T?"is-hidden":""}`,children:[t.jsx("button",{type:"button",className:"ghost-button",onClick:()=>x(D),children:T?"Show":"Hide"}),t.jsx("span",{className:"timeline-studio-group-name",children:D}),t.jsx("button",{type:"button",className:"ghost-button",onClick:()=>k(D,"up"),disabled:V===0,children:"Up"}),t.jsx("button",{type:"button",className:"ghost-button",onClick:()=>k(D,"down"),disabled:V===f.length-1,children:"Down"})]},D)})})]}),t.jsx(ll,{trace:e,steps:n,selectedStepId:s,onSelectStep:r,playheadPct:j,playheadMs:i,windowRange:d,ghostTrace:p,diff:u,laneStrategy:h,laneGroupsOrder:f,hiddenLaneGroups:y})]})}const ul=[.5,1,1.5,2,4];function sr({playheadMs:e,wallTimeMs:n,isPlaying:s,speed:r,onToggle:i,onScrub:d,onSpeedChange:c}){const p=u=>{d(Number(u.target.value))};return t.jsxs("div",{className:"playback-controls",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:i,"aria-label":s?"Pause playback":"Play playback","data-help":!0,"data-help-title":"Playhead","data-help-body":"Start or pause the run to experience timing as it unfolded.","data-help-placement":"bottom",children:s?"Pause":"Play"}),t.jsx("input",{className:"playback-slider",type:"range",min:0,max:n,value:e,"aria-label":"Playback position",onChange:p,"data-help":!0,"data-help-title":"Scrub timeline","data-help-body":"Drag to jump to any moment in the run.","data-help-placement":"bottom"}),t.jsx("select",{className:"playback-speed",value:r,"aria-label":"Playback speed",onChange:u=>c(Number(u.target.value)),"data-help":!0,"data-help-title":"Speed","data-help-body":"Slow down to inspect or speed up to skim.","data-help-placement":"bottom",children:ul.map(u=>t.jsxs("option",{value:u,children:[u,"x"]},u))})]})}function pl(e,n,s,r=60){const{wallTimeMs:i,intervals:d}=Ia(e,n,s),c=new Array(r).fill(0);if(!i)return{buckets:c,wallTimeMs:0};const p=i/r;return!Number.isFinite(p)||p<=0?{buckets:c,wallTimeMs:i}:(d.forEach(u=>{const h=Math.max(0,Math.floor(u.startMs/p)),f=Math.min(r-1,Math.floor(u.endMs/p));for(let y=h;y<=f;y+=1)c[y]+=1}),{buckets:c,wallTimeMs:i})}function ml(e,n){const s=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),r=URL.createObjectURL(s),i=document.createElement("a");i.href=r,i.download=e,document.body.appendChild(i),i.click(),i.remove(),URL.revokeObjectURL(r)}function Cn(e,n,s="text/plain"){const r=new Blob([n],{type:s}),i=URL.createObjectURL(r),d=document.createElement("a");d.href=i,d.download=e,document.body.appendChild(d),d.click(),d.remove(),URL.revokeObjectURL(i)}const Xt=5e3,hl=32;function De(e,n,s){return Math.min(s,Math.max(n,e))}function Dt(e,n){const s=new Set;return e.forEach(r=>{s.add(De(Math.round(r),0,n))}),Array.from(s).sort((r,i)=>r-i).slice(0,hl)}function fl(e,n){if(!e)return{bookmarksMs:[],clipStartMs:null,clipEndMs:null,segments:[]};try{const s=JSON.parse(e),r=Dt(Array.isArray(s.bookmarksMs)?s.bookmarksMs:[],n),i=typeof s.clipStartMs=="number"?De(s.clipStartMs,0,n):null,d=typeof s.clipEndMs=="number"?De(s.clipEndMs,0,n):null,c=Array.isArray(s.segments)?s.segments.filter(p=>typeof(p==null?void 0:p.id)=="string"&&typeof(p==null?void 0:p.startMs)=="number"&&typeof(p==null?void 0:p.endMs)=="number"&&typeof(p==null?void 0:p.label)=="string").map(p=>({...p,startMs:De(p.startMs,0,n),endMs:De(p.endMs,0,n)})):[];return{bookmarksMs:r,clipStartMs:i,clipEndMs:i!=null&&d!=null&&d<i?i:d,segments:c}}catch{return{bookmarksMs:[],clipStartMs:null,clipEndMs:null,segments:[]}}}function rr(e,n){const s=Date.parse(e);return Number.isNaN(s)?null:new Date(s+n).toISOString()}function yl({traceStart:e,traceEnd:n,steps:s,playheadMs:r,windowRange:i,windowed:d,spanMs:c,onSpanChange:p,onToggleWindowed:u,onScrub:h,persistenceKey:f,laneStrategy:y="type",visibleLaneGroups:w=[],remotePlayheads:x=[]}){const{buckets:k,wallTimeMs:b}=pl(e,n,s,64),j=Math.max(1,...k),C=De(c,Xt,Math.max(Xt,b)),D=(i==null?void 0:i.startMs)??0,V=(i==null?void 0:i.endMs)??b,T=l.useMemo(()=>`agentDirector.timelineStudio.${f??e}`,[f,e]),[R,W]=l.useState([]),[q,L]=l.useState(null),[H,re]=l.useState(null),[S,_]=l.useState([]),[$,B]=l.useState("");l.useEffect(()=>{const M=fl(window.localStorage.getItem(T),b);W(M.bookmarksMs),L(M.clipStartMs),re(M.clipEndMs),_(M.segments)},[T,b]),l.useEffect(()=>{const M={bookmarksMs:Dt(R,b),clipStartMs:q==null?null:De(q,0,b),clipEndMs:H==null?null:De(H,0,b),segments:S};window.localStorage.setItem(T,JSON.stringify(M))},[R,H,q,S,T,b]);const E=b?D/b*100:0,K=b?(V-D)/b*100:100,he=b?r/b*100:0,Y=q!=null&&H!=null?Math.min(q,H):null,te=q!=null&&H!=null?Math.max(q,H):null,Ce=Y!=null&&te!=null&&b?(te-Y)/b*100:0,we=Y!=null&&b?Y/b*100:0,ve=Y!=null&&te!=null&&te>Y,v=M=>{const J=M.currentTarget.getBoundingClientRect(),ge=(M.clientX-J.left)/J.width,ke=De(Math.round(ge*b),0,b);h(ke)},X=M=>{if(M.key==="ArrowLeft"){M.preventDefault(),h(De(r-Math.max(250,Math.round(b*.02)),0,b));return}if(M.key==="ArrowRight"){M.preventDefault(),h(De(r+Math.max(250,Math.round(b*.02)),0,b));return}if(M.key==="Home"){M.preventDefault(),h(0);return}if(M.key==="End"){M.preventDefault(),h(b);return}(M.key===" "||M.key==="Enter")&&(M.preventDefault(),h(r))},ae=()=>{W(M=>Dt([...M,r],b))},I=M=>{if(R.length===0)return;const J=Dt(R,b);if(M==="previous"){const ke=[...J].reverse().find($e=>$e<r)??J[J.length-1];h(ke);return}const ge=J.find(ke=>ke>r)??J[0];h(ge)},ue=()=>{const M=De(r,0,b);L(M),H!=null&&H<M&&re(M)},Ge=()=>{const M=De(r,0,b);re(M),q!=null&&q>M&&L(M)},z=()=>{L(null),re(null)},xt=()=>{if(!ve||Y==null||te==null)return;const M=$.trim()||`Scene ${S.length+1}`,J=`segment-${Math.random().toString(36).slice(2,9)}`;_(ge=>[...ge,{id:J,startMs:Y,endMs:te,label:M}]),B("")},_e=M=>{_(J=>J.filter(ge=>ge.id!==M))},fe=()=>{if(!ve||Y==null||te==null)return;const M={type:"agent-director-clip",traceStart:e,traceEnd:n,clip:{startMs:Y,endMs:te,startAt:rr(e,Y),endAt:rr(e,te)},bookmarksMs:Dt(R,b).filter(J=>J>=Y&&J<=te),playheadMs:r,laneContext:{strategy:y,visibleGroups:w},segments:S.filter(J=>J.endMs>=Y&&J.startMs<=te),exportedAt:new Date().toISOString()};ml(`agent-director-clip-${Y}-${te}.json`,M)};return t.jsxs("div",{className:"mini-timeline",children:[t.jsxs("div",{className:"mini-track",onClick:v,role:"slider",tabIndex:0,"aria-label":"Timeline density map","aria-valuemin":0,"aria-valuemax":b,"aria-valuenow":r,"aria-valuetext":`${r} milliseconds`,onKeyDown:X,"data-help":!0,"data-help-title":"Density map","data-help-body":"A compact view of activity density. Click to jump the playhead.","data-help-placement":"top",children:[t.jsx("div",{className:"mini-bars",children:k.map((M,J)=>t.jsx("span",{className:"mini-bar",style:{height:`${M/j*100}%`}},`bucket-${J}`))}),t.jsx("div",{className:"mini-window",style:{left:`${E}%`,width:`${K}%`,opacity:d?1:.4}}),ve?t.jsx("div",{className:"mini-clip-window",style:{left:`${we}%`,width:`${Ce}%`}}):null,t.jsx("div",{className:"mini-bookmark-markers","data-testid":"timeline-bookmark-markers","aria-hidden":"true",children:Dt(R,b).map(M=>{const J=b?M/b*100:0;return t.jsx("button",{type:"button",className:"mini-bookmark-marker",style:{left:`${J}%`},onClick:ge=>{ge.stopPropagation(),h(M)},title:`Jump to bookmark at ${M}ms`,"aria-label":`Bookmark ${M} milliseconds`},`bookmark-${M}`)})}),t.jsx("div",{className:"mini-remote-markers","aria-hidden":"true",children:x.map((M,J)=>{const ge=b?M/b*100:0;return t.jsx("span",{className:"mini-remote-marker",style:{left:`${ge}%`}},`remote-${J}`)})}),t.jsx("div",{className:"mini-segments","aria-hidden":"true",children:S.map(M=>{const J=b?M.startMs/b*100:0,ge=b?(M.endMs-M.startMs)/b*100:0;return t.jsx("span",{className:"mini-segment-bar",style:{left:`${J}%`,width:`${Math.max(1,ge)}%`},title:M.label},M.id)})}),t.jsx("div",{className:"mini-playhead",style:{left:`${he}%`}})]}),t.jsxs("div",{className:"mini-controls",children:[t.jsx("label",{className:"mini-label",children:"Zoom"}),t.jsx("input",{type:"range",min:Xt,max:Math.max(Xt,b),value:C,"aria-label":"Timeline zoom",onChange:M=>{u(!0),p(Number(M.target.value))},"data-help":!0,"data-help-title":"Zoom window","data-help-body":"Tighten the window to focus on hotspots.","data-help-placement":"top"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>u(!d),title:"Toggle windowed playback",children:d?"Full":"Window"}),t.jsx("button",{className:"ghost-button",type:"button",title:"Reset zoom",onClick:()=>{u(!0),p(Math.min(Math.max(b*.2,Xt),6e4))},children:"Reset"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:ae,children:"Add bookmark"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>I("previous"),children:"Previous bookmark"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>I("next"),children:"Next bookmark"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:ue,children:"Set clip start"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:Ge,children:"Set clip end"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:z,children:"Clear clip"}),t.jsx("input",{className:"search-input mini-segment-input",placeholder:"Segment label",value:$,onChange:M=>B(M.target.value),"aria-label":"Segment label"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:xt,disabled:!ve,children:"Add segment"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:fe,disabled:!ve,children:"Export clip"})]}),S.length?t.jsx("div",{className:"mini-segment-list",children:S.map(M=>t.jsxs("div",{className:"mini-segment-item",children:[t.jsxs("span",{children:[M.label," (",M.startMs,"ms - ",M.endMs,"ms)"]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>_e(M.id),children:"Remove"})]},M.id))}):null]})}const Zt=[{id:"toggleStory",label:"Story mode",defaultKey:"s"},{id:"toggleExplain",label:"Explain mode",defaultKey:"e"},{id:"startTour",label:"Start guided tour",defaultKey:"t"},{id:"toggleFlow",label:"Toggle Flow mode",defaultKey:"f"},{id:"toggleCinema",label:"Switch to Cinema mode",defaultKey:"c"},{id:"toggleGameplay",label:"Switch to Gameplay mode",defaultKey:"g"},{id:"toggleInspector",label:"Toggle inspector",defaultKey:"i"}],Bn="abcdefghijklmnopqrstuvwxyz".split(""),bl=Zt.reduce((e,n)=>(e[n.id]=n.defaultKey,e),{}),gl={...bl};function Gr(e,n){const s=String(e??"").trim().toLowerCase();return Bn.includes(s)?s:n}function xl(e){return Bn.find(s=>!e.has(s))??"z"}function Pn(e){const n={},s=new Set;for(const r of Zt){const i=Gr(e==null?void 0:e[r.id],r.defaultKey),d=s.has(i)?xl(s):i;n[r.id]=d,s.add(d)}return n}function vl(e,n,s){const r=Pn(e),i=Gr(s,r[n]);if(r[n]===i)return r;const d={...r,[n]:i},c=Zt.find(p=>p.id!==n&&d[p.id]===i);return c&&(d[c.id]=r[n]),Pn(d)}function wl(e){return e.trim().toUpperCase()}function kl({open:e,onClose:n,bindings:s}){const r=l.useRef(null),i=[{keys:"Space",action:"Play / pause"},{keys:"← / →",action:"Step boundary back / forward"},{keys:"Shift + ← / →",action:"Jump to start / end"},...Zt.map(c=>({keys:wl(s[c.id]),action:c.label})),{keys:"Cmd/Ctrl + K",action:"Open command palette"},{keys:"?",action:"Show shortcuts"},{keys:"Esc",action:"Close modal / inspector"}];if(l.useEffect(()=>{var c;e&&((c=r.current)==null||c.focus())},[e]),!e)return null;const d=c=>{var f;if(c.key==="Escape"){c.preventDefault(),n();return}if(c.key!=="Tab")return;const p=Array.from(c.currentTarget.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'));if(p.length===0)return;const u=p.indexOf(document.activeElement),h=c.shiftKey?u<=0?p.length-1:u-1:(u+1)%p.length;(f=p[h])==null||f.focus(),c.preventDefault()};return t.jsx("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true","aria-labelledby":"shortcuts-title",onKeyDown:d,children:t.jsxs("div",{className:"modal",tabIndex:-1,children:[t.jsxs("div",{className:"modal-header",children:[t.jsx("div",{className:"modal-title",id:"shortcuts-title",children:"Keyboard Shortcuts"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:n,ref:r,"aria-label":"Close shortcuts",children:"Close"})]}),t.jsx("div",{className:"modal-body",children:i.map(c=>t.jsxs("div",{className:"modal-row",children:[t.jsx("span",{className:"modal-keys",children:c.keys}),t.jsx("span",{className:"modal-action",children:c.action})]},c.keys))})]})})}const ir="agentDirector.palette.recent.v1",or="agentDirector.palette.pinned.v1",jl=8,Sl=12,Br=e=>e.trim().toLowerCase(),Mn=(e,n)=>{if(!n)return 0;const s=Br(e);return s?s===n?30:s.startsWith(n)?18:s.includes(n)?8:0:0};function lr(e){try{const n=JSON.parse(window.localStorage.getItem(e)??"[]");return Array.isArray(n)?n.filter(s=>typeof s=="string"):[]}catch{return[]}}function cr(e,n){window.localStorage.setItem(e,JSON.stringify(n))}function Nl(e){const n=new Map;return e.forEach(s=>{var i;const r=s.section;n.has(r)||n.set(r,[]),(i=n.get(r))==null||i.push(s)}),n}function dr(e,n,s){var i;if(!e.length)return 0;let r=n;for(let d=0;d<e.length;d+=1)if(r=(r+s+e.length)%e.length,!((i=e[r])!=null&&i.disabled))return r;return n}function Cl({open:e,onClose:n,actions:s,context:r,onActionRun:i}){var H,re;const[d,c]=l.useState(""),[p,u]=l.useState(0),[h,f]=l.useState([]),[y,w]=l.useState([]),x=l.useRef(null),k=l.useRef(null),b=l.useMemo(()=>{const S=Br(d),_=new Set(h),$=new Set(y);return s.map((E,K)=>{var te;const he=[E.label,E.description,E.group,E.keys,...E.keywords??[]].filter(Boolean).join(" ").toLowerCase();if(S&&!he.includes(S))return null;let Y=E.priority??0;return Y+=Mn(E.label,S),Y+=Mn(E.group??"",S),(E.keywords??[]).forEach(Ce=>{Y+=Mn(Ce,S)}),_.has(E.id)&&(Y+=6),$.has(E.id)&&(Y+=12),r!=null&&r.section&&((te=E.group)==null?void 0:te.toLowerCase())===r.section.toLowerCase()&&(Y+=8),r!=null&&r.mode&&E.id.includes(`mode-${r.mode}`)&&(Y+=8),{action:E,score:Y,index:K}}).filter(E=>!!E).sort((E,K)=>K.score===E.score?E.index-K.index:K.score-E.score).map(E=>E.action)},[s,r==null?void 0:r.mode,r==null?void 0:r.section,y,d,h]),j=l.useMemo(()=>{const S=new Map(b.map(E=>[E.id,E])),_=y.map(E=>S.get(E)).filter(E=>!!E).map(E=>({...E,section:"Pinned"})),$=h.map(E=>S.get(E)).filter(E=>!!E).filter(E=>!_.some(K=>K.id===E.id)).map(E=>({...E,section:"Recent"})),B=b.filter(E=>!_.some(K=>K.id===E.id)).filter(E=>!$.some(K=>K.id===E.id)).map(E=>({...E,section:E.group??"General"}));if(!d.trim()&&r){const E=B.slice(0,4).map(K=>({...K,id:`recommended-${K.id}`,label:`Recommended: ${K.label}`,section:"Recommended"}));return[..._,...$,...E,...B]}return[..._,...$,...B]},[r,b,y,h,d]),C=l.useMemo(()=>Nl(j),[j]),D=l.useMemo(()=>s.filter(S=>(S.group??"").toLowerCase()==="macros"||S.id.startsWith("macro-")),[s]);if(l.useEffect(()=>{if(!e)return;c(""),u(0),f(lr(ir)),w(lr(or));const S=window.setTimeout(()=>{var _;return(_=x.current)==null?void 0:_.focus()},0);return()=>window.clearTimeout(S)},[e]),l.useEffect(()=>{p>=j.length&&u(0)},[p,j.length]),!e)return null;const V=S=>{f(_=>{const $=[S,..._.filter(B=>B!==S)].slice(0,jl);return cr(ir,$),$})},T=S=>{S.disabled||(V(S.id),i==null||i(S),S.onTrigger(),n())},R=S=>{w(_=>{const $=_.includes(S)?_.filter(B=>B!==S):[S,..._].slice(0,Sl);return cr(or,$),$})},W=S=>{var _,$;if(S.key==="Escape"){S.preventDefault(),n();return}if(S.key==="ArrowDown"){S.preventDefault(),u(B=>dr(j,B,1));return}if(S.key==="ArrowUp"){S.preventDefault(),u(B=>dr(j,B,-1));return}if(S.key==="Enter"){S.preventDefault();const B=j[p];B&&T(B);return}if(S.key==="Tab"){const B=Array.from(((_=k.current)==null?void 0:_.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'))??[]);if(!B.length)return;const E=B.indexOf(document.activeElement),K=S.shiftKey?E<=0?B.length-1:E-1:(E+1)%B.length;($=B[K])==null||$.focus(),S.preventDefault()}},q=(H=j[p])!=null&&H.id?`palette-option-${(re=j[p])==null?void 0:re.id}`:void 0;let L=-1;return t.jsx("div",{className:"modal-backdrop palette-backdrop",role:"dialog","aria-modal":"true","aria-label":"Command palette",onKeyDown:W,onMouseDown:S=>{S.target===S.currentTarget&&n()},children:t.jsxs("div",{className:"palette",ref:k,children:[t.jsxs("div",{className:"palette-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"palette-title",children:"Command palette"}),t.jsx("div",{className:"palette-subtitle",children:"Search actions, modes, and playbook steps."})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:n,"aria-label":"Close command palette",children:"Close"})]}),t.jsx("input",{ref:x,className:"palette-input",value:d,onChange:S=>c(S.target.value),placeholder:"Type to filter actions…","aria-label":"Search commands",role:"combobox","aria-expanded":"true","aria-controls":"command-palette-list","aria-activedescendant":q,"aria-autocomplete":"list"}),!d.trim()&&D.length>0?t.jsxs("div",{className:"palette-macros",children:[t.jsx("div",{className:"palette-group-title",children:"Quick macros"}),t.jsx("div",{className:"palette-macro-list",children:D.slice(0,3).map(S=>t.jsx("button",{className:"ghost-button palette-macro-item",type:"button",onClick:()=>T(S),children:S.label},S.id))})]}):null,t.jsxs("div",{className:"palette-list",role:"listbox",id:"command-palette-list",children:[j.length===0?t.jsx("div",{className:"palette-empty",children:"No matching commands."}):null,Array.from(C.entries()).map(([S,_])=>t.jsxs("div",{className:"palette-group",children:[t.jsx("div",{className:"palette-group-title",children:S}),t.jsx("div",{className:"palette-group-list",children:_.map($=>{L+=1;const B=L===p,E=y.includes($.id);return t.jsxs("button",{id:`palette-option-${$.id}`,className:`palette-item ${B?"active":""}`,type:"button",role:"option","aria-selected":B,onMouseEnter:()=>u(L),onClick:()=>T($),disabled:$.disabled,children:[t.jsxs("div",{className:"palette-item-main",children:[t.jsx("div",{className:"palette-item-title",children:$.label}),$.description?t.jsx("div",{className:"palette-item-description",children:$.description}):null]}),t.jsxs("div",{className:"palette-item-trailing",children:[$.keys?t.jsx("div",{className:"palette-item-keys",children:$.keys}):null,t.jsx("span",{className:`palette-pin ${E?"active":""}`,role:"button",tabIndex:0,onClick:K=>{K.stopPropagation(),R($.id)},onKeyDown:K=>{K.key!=="Enter"&&K.key!==" "||(K.preventDefault(),K.stopPropagation(),R($.id))},"aria-label":E?`Unpin ${$.label}`:`Pin ${$.label}`,title:E?"Unpin command":"Pin command",children:E?"★":"☆"})]})]},$.id)})})]},S))]})]})})}function Ml(e){return e.length?e.reduce((n,s)=>(s.durationMs??0)>(n.durationMs??0)?s:n,e[0]):null}function El({trace:e,mode:n,playheadMs:s,selectedStepId:r,compareTrace:i,collapsed:d,onToggleCollapsed:c,onModeChange:p,onSelectStep:u,onJumpToBottleneck:h,onReplay:f,onStartTour:y,priorityQueue:w=[]}){var S;const x=e.steps??[],k=Ml(x),b=r??(k==null?void 0:k.id)??((S=x[0])==null?void 0:S.id)??null,j=n==="cinema"||s>0,C=!!r,D=!!i,V=[j,C,D].filter(Boolean).length,T=[j,C,D].findIndex(_=>!_),R=T===-1?2:T,W=[0,1,2].map(_=>[j,C,D][_]?"done":_===R?"active":"next"),q=[{id:"observe",title:"Act I: Observe",summary:"Scrub the timeline to feel the pacing, bottlenecks, and tool choreography.",status:W[0],actionLabel:"Enter cinema",action:()=>p("cinema"),tasks:[{label:"Scrub the timeline",done:s>0},{label:"Stay in Cinema mode",done:n==="cinema"}]},{id:"inspect",title:"Act II: Inspect",summary:"Open the most expensive or failed step and read the payload with context.",status:W[1],actionLabel:k?"Jump to bottleneck":"Select first step",action:()=>{if(r){p("cinema");return}if(k){h();return}b&&(u(b),p("cinema"))},disabled:!b,tasks:[{label:"Open the Inspector",done:!!r},{label:"Jump to the bottleneck",done:!!(k&&r===k.id)}]},{id:"direct",title:"Act III: Direct",summary:"Replay from a decisive step, then compare flows and diffs side-by-side.",status:W[2],actionLabel:i?"Open compare":"Replay from step",action:()=>{if(i){p("compare");return}b&&f(b)},disabled:!b,tasks:[{label:"Replay from a step",done:!!i},{label:"Compare runs side-by-side",done:!!(i&&n==="compare")}]}],L=q[R],re=w.filter(_=>!_.done)[0];return d?t.jsxs("section",{className:"journey-panel journey-collapsed","aria-label":"Director journey","data-help":!0,"data-help-indicator":!0,"data-tour":"journey","data-help-title":"Director journey","data-help-body":"A guided path from observation to replay. Use it to show newcomers what to do first.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"journey-collapsed-main",children:[t.jsx("div",{className:"journey-eyebrow",children:"Director journey"}),t.jsx("div",{className:"journey-collapsed-title",children:"From observe to direct"})]}),t.jsxs("div",{className:"journey-collapsed-actions",children:[t.jsxs("span",{className:"journey-progress-text",children:[V,"/3 complete"]}),re?t.jsxs("span",{className:`journey-priority-chip severity-${re.severity}`,children:["Next priority: ",re.title]}):null,L?t.jsxs("button",{className:"primary-button journey-next",type:"button",onClick:L.action,disabled:L.disabled,children:["Next: ",L.actionLabel]}):null,y?t.jsx("button",{className:"ghost-button",type:"button",onClick:y,children:"Tour"}):null,t.jsx("button",{className:"primary-button journey-expand",type:"button",onClick:c,children:"Expand"})]})]}):t.jsxs("section",{className:"journey-panel","aria-label":"Director journey","data-help":!0,"data-help-indicator":!0,"data-tour":"journey","data-help-title":"Director journey","data-help-body":"A three-act flow that teaches the story: observe, inspect, direct. Each act jumps to the right place.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"journey-head",children:[t.jsxs("div",{children:[t.jsx("div",{className:"journey-eyebrow",children:"Director journey"}),t.jsx("h2",{className:"journey-title",children:"Cut a perfect take in three acts."}),t.jsx("p",{className:"journey-subtitle",children:"Trace the performance, interrogate the moment, then direct a better run."})]}),t.jsxs("div",{className:"journey-head-actions",children:[y?t.jsx("button",{className:"ghost-button",type:"button",onClick:y,children:"Start tour"}):null,t.jsx("button",{className:"ghost-button",type:"button",onClick:c,children:"Collapse"})]})]}),t.jsx("div",{className:"journey-track",children:q.map((_,$)=>{var B;return t.jsxs("div",{className:"journey-card","data-status":_.status,children:[t.jsxs("div",{className:"journey-card-top",children:[t.jsxs("span",{className:"journey-index",children:["0",$+1]}),t.jsx("span",{className:"journey-status",children:_.status})]}),t.jsx("h3",{className:"journey-card-title",children:_.title}),t.jsx("p",{className:"journey-card-body",children:_.summary}),(B=_.tasks)!=null&&B.length?t.jsx("ul",{className:"journey-tasks",children:_.tasks.map(E=>t.jsxs("li",{className:`journey-task ${E.done?"done":""}`,children:[t.jsx("span",{className:"journey-task-icon","aria-hidden":"true",children:E.done?"✓":"○"}),t.jsx("span",{children:E.label})]},E.label))}):null,t.jsx("button",{className:"primary-button journey-action",type:"button",onClick:_.action,disabled:_.disabled,children:_.actionLabel})]},_.id)})}),t.jsxs("div",{className:"journey-footer",children:[t.jsxs("div",{children:[t.jsx("div",{className:"journey-progress-label",children:"Progress"}),t.jsx("div",{className:"journey-progress",children:t.jsx("span",{className:"journey-progress-bar",style:{width:`${V/3*100}%`}})})]}),t.jsx("div",{className:"journey-footnote",children:"Tip: Use Flow to spot fan-out, Compare to validate your changes."})]}),w.length?t.jsxs("div",{className:"journey-priority-queue",children:[t.jsxs("div",{className:"journey-priority-head",children:[t.jsx("div",{className:"journey-progress-label",children:"Priority queue"}),t.jsxs("span",{children:[w.filter(_=>_.done).length,"/",w.length," resolved"]})]}),t.jsx("div",{className:"journey-priority-list",children:w.map(_=>t.jsxs("article",{className:`journey-priority-item ${_.done?"done":""}`,children:[t.jsxs("div",{className:"journey-priority-main",children:[t.jsx("span",{className:`journey-priority-chip severity-${_.severity}`,children:_.severity}),t.jsxs("div",{children:[t.jsx("div",{className:"journey-priority-title",children:_.title}),t.jsx("div",{className:"journey-priority-body",children:_.detail})]})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:_.onAction,disabled:_.done,children:_.done?"Resolved":_.actionLabel})]},_.id))})]}):null]})}const Il=[],_l=[],Tl=[],Al={};function Dl(e){return e.length?e.reduce((n,s)=>(s.durationMs??0)>(n.durationMs??0)?s:n,e[0]):null}function $l({trace:e,mode:n,selectedStepId:s,onModeChange:r,onSelectStep:i,onJumpToBottleneck:d,onReplay:c,recommendations:p=Il,persona:u="builder",annotations:h=_l,activityFeed:f=Tl,onAddAnnotation:y,missionProgress:w=Al,missionCompletion:x,onResetMissions:k,narrative:b="",onAskDirector:j,onExportNarrative:C}){var ae;const D=e.steps??[],V=Dl(D),T=s??(V==null?void 0:V.id)??((ae=D[0])==null?void 0:ae.id)??null,R=e.metadata.wallTimeMs??0,W=u==="executive"?"Executive lens":u==="operator"?"Operator lens":"Builder lens",[q,L]=l.useState(""),[H,re]=l.useState(""),[S,_]=l.useState(""),[$,B]=l.useState("overview"),[E,K]=l.useState([]),he=l.useMemo(()=>f.slice(0,6),[f]),Y=(x==null?void 0:x.done)??0,te=Y>=3||!!w.inspect,Ce=Y>=5||!!w.collaborate||he.length>0,we=l.useMemo(()=>p.slice(0,3).map((I,ue)=>({id:I.id,step:`${ue+1}. ${I.actionLabel} — ${I.title}`})),[p]);l.useEffect(()=>{K(I=>I.filter(ue=>p.some(Ge=>Ge.id===ue)))},[p]);const ve=E.filter(I=>p.some(ue=>ue.id===I)).length,v=p.length?Math.round(ve/p.length*100):0,X=I=>{I.action(),K(ue=>ue.includes(I.id)?ue:[...ue,I.id])};return t.jsxs("aside",{className:"inspector inspector-empty","data-help":!0,"data-help-indicator":!0,"data-tour":"inspector","data-help-title":"Inspector panel","data-help-body":"Select a step to open detailed payloads, redaction controls, and replay actions.","data-help-placement":"left",children:[t.jsx("div",{className:"inspector-header",children:t.jsxs("div",{children:[t.jsx("div",{className:"inspector-title",children:"Director's notes"}),t.jsxs("div",{className:"inspector-subtitle",children:[W,". Select a step to open deep inspection."]})]})}),t.jsxs("div",{className:"director-tabs",role:"tablist","aria-label":"Director workspace tabs",children:[t.jsx("button",{className:`ghost-button ${$==="overview"?"active":""}`,type:"button",role:"tab","aria-selected":$==="overview",onClick:()=>B("overview"),children:"Overview"}),t.jsx("button",{className:`ghost-button ${$==="narrative"?"active":""}`,type:"button",role:"tab","aria-selected":$==="narrative",onClick:()=>B("narrative"),children:"Narrative"}),t.jsx("button",{className:`ghost-button ${$==="collab"?"active":""}`,type:"button",role:"tab","aria-selected":$==="collab",onClick:()=>B("collab"),children:"Collaboration"})]}),$==="overview"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Run summary"}),t.jsxs("div",{className:"inspector-row",children:[t.jsx("span",{children:"Steps"}),t.jsx("span",{children:D.length})]}),t.jsxs("div",{className:"inspector-row",children:[t.jsx("span",{children:"Wall time"}),t.jsxs("span",{children:[R,"ms"]})]}),t.jsxs("div",{className:"inspector-row",children:[t.jsx("span",{children:"Status"}),t.jsx("span",{children:e.status})]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Next actions"}),t.jsxs("div",{className:"director-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>r("cinema"),"data-help":!0,"data-help-title":"Open cinema","data-help-body":"Jump straight into the timeline.","data-help-placement":"right",children:"Open cinema"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>r("flow"),"data-help":!0,"data-help-title":"Open flow","data-help-body":"See the dependency graph of the run.","data-help-placement":"right",children:"Switch to flow"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{if(!s){if(V){d();return}T&&i(T)}},disabled:!T||!!s,"data-help":!0,"data-help-title":"Jump to bottleneck","data-help-body":"Select the slowest step for inspection.","data-help-placement":"right",children:s?"Inspector open":V?"Jump to bottleneck":"Select first step"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>T&&c(T),disabled:!T||!te,title:te?void 0:"Complete core missions to unlock replay guidance.","data-help":!0,"data-help-title":"Replay","data-help-body":"Branch a replay from a decisive step.","data-help-placement":"right",children:"Replay from step"})]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Mode"}),t.jsxs("div",{className:"director-modes",children:[t.jsx("button",{className:`ghost-button ${n==="cinema"?"active":""}`,type:"button",onClick:()=>r("cinema"),"data-help":!0,"data-help-title":"Cinema mode","data-help-body":"Timeline view for pacing and sequence.","data-help-placement":"right",children:"Cinema"}),t.jsx("button",{className:`ghost-button ${n==="flow"?"active":""}`,type:"button",onClick:()=>r("flow"),"data-help":!0,"data-help-title":"Flow mode","data-help-body":"Graph view for dependencies.","data-help-placement":"right",children:"Flow"}),t.jsx("button",{className:"ghost-button",type:"button",disabled:!0,children:"Compare"})]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Adaptive missions"}),t.jsxs("div",{className:"mission-summary",children:[(x==null?void 0:x.done)??0,"/",(x==null?void 0:x.total)??0," complete",t.jsxs("span",{children:[(x==null?void 0:x.pct)??0,"%"]})]}),t.jsxs("div",{className:"mission-stage",children:["Stage: ",Ce?"Collaboration":te?"Analysis":"Foundation"]}),t.jsx("div",{className:"mission-grid",children:Object.entries(w).map(([I,ue])=>t.jsxs("div",{className:`mission-chip ${ue?"done":""}`,children:[t.jsx("span",{children:I}),t.jsx("span",{children:ue?"Done":"Pending"})]},I))}),t.jsx("button",{className:"ghost-button",type:"button",onClick:k,children:"Reset missions"})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Action plan"}),te?p.length===0?t.jsx("div",{className:"annotation-empty",children:"No recommendations generated yet."}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"mission-summary",children:[ve,"/",p.length," complete",t.jsxs("span",{children:[v,"%"]})]}),t.jsx("div",{className:"director-recommendations",children:p.map(I=>{const ue=E.includes(I.id);return t.jsxs("article",{className:`director-recommendation tone-${I.tone} ${ue?"done":""}`,children:[t.jsx("div",{className:"director-recommendation-title",children:I.title}),t.jsx("p",{className:"director-recommendation-body",children:I.body}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>X(I),children:ue?"Completed":I.actionLabel})]},I.id)})})]}):t.jsx("div",{className:"annotation-empty",children:"Complete inspect/flow/replay missions to unlock AI narrative tools."}),Ce?null:t.jsx("div",{className:"annotation-empty",children:"Open another live session to unlock collaboration activity feed."})]})]}):null,$==="narrative"?t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"AI director narrative"}),te?t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"director-recommendation-body",children:b}),we.length?t.jsx("div",{className:"director-guided-plan",children:we.map(I=>t.jsx("div",{children:I.step},I.id))}):null,t.jsxs("div",{className:"director-ask-row",children:[t.jsx("input",{className:"search-input",value:H,onChange:I=>re(I.target.value),placeholder:"Ask Director (e.g. what is highest risk?)","aria-label":"Ask director question"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{H.trim()&&_((j==null?void 0:j(H))??"")},children:"Ask"})]}),S?t.jsx("div",{className:"director-answer",children:S}):null,t.jsx("button",{className:"ghost-button",type:"button",onClick:C,children:"Export narrative"})]}):t.jsx("div",{className:"annotation-empty",children:"Complete inspect/flow/replay missions to unlock AI narrative tools."})]}):null,$==="collab"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Shared annotations"}),t.jsx("textarea",{value:q,onChange:I=>L(I.target.value),rows:3,placeholder:s?"Add note for selected step...":"Add trace-level note...","aria-label":"Shared annotation"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{const I=q.trim();I&&(y==null||y(I,s),L(""))},children:"Add annotation"}),t.jsxs("div",{className:"annotation-list",children:[h.slice(-6).reverse().map(I=>t.jsxs("article",{className:"annotation-item",children:[t.jsxs("div",{className:"annotation-meta",children:[t.jsx("span",{children:I.stepId?`step ${I.stepId}`:"trace"}),t.jsx("span",{children:I.authorSessionId})]}),t.jsx("p",{children:I.body})]},I.id)),h.length===0?t.jsx("div",{className:"annotation-empty",children:"No shared annotations yet."}):null]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Collab activity"}),Ce?t.jsxs("div",{className:"activity-list",children:[he.map(I=>t.jsxs("div",{className:"activity-item",children:[t.jsx("span",{children:I.message}),t.jsx("span",{children:new Date(I.timestamp).toLocaleTimeString()})]},I.id)),he.length===0?t.jsx("div",{className:"annotation-empty",children:"No activity yet."}):null]}):t.jsx("div",{className:"annotation-empty",children:"Open another live session to unlock collaboration activity feed."})]})]}):null]})}const En=(e,n,s)=>Math.min(s,Math.max(n,e));function In(e){return Array.from((e==null?void 0:e.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'))??[]).filter(s=>!(s.hasAttribute("disabled")||s.getAttribute("aria-hidden")==="true"))}function Rl({steps:e,open:n,onClose:s,onComplete:r}){const[i,d]=l.useState(0),[c,p]=l.useState(null),[u,h]=l.useState(null),f=l.useRef(null),y=l.useRef(null),w=l.useRef(null),x=l.useMemo(()=>e[i],[e,i]),k=l.useCallback(()=>{if(!n)return;const T=document.querySelector(x.target);if(!T){y.current=null,p(null);return}y.current=T;const R=T.getBoundingClientRect();p(R)},[n,x.target]),b=l.useCallback(()=>{if(!c||!f.current){h(null);return}const T=f.current.offsetWidth,R=f.current.offsetHeight,W=16;let q=En(c.left+c.width/2-T/2,W,window.innerWidth-T-W),L=c.bottom+16;x.placement==="top"&&(L=c.top-R-16),x.placement==="left"&&(q=c.left-T-16,L=c.top+c.height/2-R/2),x.placement==="right"&&(q=c.right+16,L=c.top+c.height/2-R/2),L+R>window.innerHeight-W&&(L=c.top-R-16),L<W&&(L=c.bottom+16),q=En(q,W,window.innerWidth-T-W),L=En(L,W,window.innerHeight-R-W),h({top:L,left:q})},[x.placement,c]);if(l.useEffect(()=>{n&&d(0)},[n]),l.useEffect(()=>{var R,W;if(!n){(W=(R=w.current)==null?void 0:R.focus)==null||W.call(R);return}w.current=document.activeElement;const T=window.setTimeout(()=>{var L;(L=In(f.current)[0]??f.current)==null||L.focus()},0);return()=>window.clearTimeout(T)},[n]),l.useEffect(()=>{if(!n)return;const T=document.querySelector(x.target);T&&T.scrollIntoView({behavior:"smooth",block:"center",inline:"center"});const R=window.requestAnimationFrame(()=>k());return()=>window.cancelAnimationFrame(R)},[n,x.target,k]),l.useLayoutEffect(()=>{b()},[c,b,x.title]),l.useEffect(()=>{if(!n)return;const T=()=>{k(),b()};return window.addEventListener("resize",T),window.addEventListener("scroll",T,!0),()=>{window.removeEventListener("resize",T),window.removeEventListener("scroll",T,!0)}},[n,k,b]),l.useEffect(()=>{if(!n)return;const T=R=>{var re;if(R.key==="Escape"){R.preventDefault(),s();return}if(R.key!=="Tab")return;const W=In(f.current);if(!W.length)return;const q=document.activeElement,L=W.indexOf(q),H=R.shiftKey?L<=0?W.length-1:L-1:(L+1)%W.length;(re=W[H])==null||re.focus(),R.preventDefault()};return document.addEventListener("keydown",T,!0),()=>document.removeEventListener("keydown",T,!0)},[s,n]),!n||!x)return null;const j=T=>{var H;if(T.key==="Escape"){T.preventDefault(),s();return}if(T.key!=="Tab")return;const R=In(f.current);if(R.length===0)return;const W=document.activeElement,q=R.indexOf(W),L=T.shiftKey?q<=0?R.length-1:q-1:(q+1)%R.length;(H=R[L])==null||H.focus(),T.preventDefault()},C=`tour-title-${x.id}`,D=`tour-body-${x.id}`,V=c?{top:c.top-6,left:c.left-6,width:c.width+12,height:c.height+12}:void 0;return t.jsxs("div",{className:"tour-overlay",role:"dialog","aria-modal":"true","aria-label":"Guided tour","aria-labelledby":C,"aria-describedby":D,onKeyDown:j,children:[t.jsx("div",{className:"tour-backdrop",onClick:s}),c?t.jsx("div",{className:"tour-spotlight",style:V}):null,t.jsxs("div",{className:`tour-card ${u?"tour-card-anchored":""}`,ref:f,style:u??void 0,tabIndex:-1,children:[t.jsxs("div",{className:"tour-step",children:["Step ",i+1," of ",e.length]}),t.jsx("div",{className:"tour-title",id:C,children:x.title}),t.jsx("p",{className:"tour-body",id:D,children:x.body}),t.jsxs("div",{className:"tour-actions",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>d(T=>Math.max(0,T-1)),disabled:i===0,children:"Back"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:s,children:"Skip"}),i===e.length-1?t.jsx("button",{className:"primary-button",type:"button",onClick:r,children:"Finish tour"}):t.jsx("button",{className:"primary-button",type:"button",onClick:()=>d(T=>T+1),children:"Next"})]})]})]})}const ur=(e,n,s)=>Math.min(s,Math.max(n,e));function Ol({enabled:e}){const[n,s]=l.useState(null),[r,i]=l.useState(null),d=l.useRef(null),c=l.useRef(null),p=l.useCallback(()=>{const h=d.current;if(!h){s(null);return}const f=h.getBoundingClientRect(),y=h.dataset.helpTitle??"Context",w=h.dataset.helpBody??"",x=h.dataset.helpPlacement??"right";s({rect:f,title:y,body:w,placement:x})},[]);l.useEffect(()=>{if(!e){d.current=null,s(null);return}const h=k=>{var j,C;const b=(C=(j=k.target)==null?void 0:j.closest)==null?void 0:C.call(j,"[data-help]");if(!b){d.current||s(null);return}d.current!==b&&(d.current=b,p())},f=k=>{var j,C;const b=(C=(j=k.target)==null?void 0:j.closest)==null?void 0:C.call(j,"[data-help]");b&&(d.current=b,p())},y=k=>{var j;const b=k.relatedTarget;(j=b==null?void 0:b.closest)!=null&&j.call(b,"[data-help]")||(d.current=null,s(null))},w=k=>{var j,C;const b=(C=(j=k.target)==null?void 0:j.closest)==null?void 0:C.call(j,"[data-help]");if(!b){d.current=null,s(null);return}d.current=b,p()},x=()=>{d.current&&p()};return window.addEventListener("mousemove",h),window.addEventListener("focusin",f),window.addEventListener("focusout",y),window.addEventListener("pointerdown",w),window.addEventListener("scroll",x,!0),window.addEventListener("resize",x),()=>{window.removeEventListener("mousemove",h),window.removeEventListener("focusin",f),window.removeEventListener("focusout",y),window.removeEventListener("pointerdown",w),window.removeEventListener("scroll",x,!0),window.removeEventListener("resize",x)}},[e,p]);const u=l.useCallback(()=>{if(!n||!c.current){i(null);return}const h=12,f=c.current.offsetWidth,y=c.current.offsetHeight,{rect:w,placement:x}=n;let k=w.right+16,b=w.top+w.height/2-y/2;x==="left"&&(k=w.left-f-16,b=w.top+w.height/2-y/2),x==="top"&&(k=w.left+w.width/2-f/2,b=w.top-y-16),x==="bottom"&&(k=w.left+w.width/2-f/2,b=w.bottom+16),k=ur(k,h,window.innerWidth-f-h),b=ur(b,h,window.innerHeight-y-h),i({left:k,top:b})},[n]);return l.useLayoutEffect(()=>{u()},[u]),!e||!n?null:t.jsxs("div",{className:"help-overlay","aria-hidden":"true",children:[t.jsx("div",{className:"help-highlight",style:{top:n.rect.top-6,left:n.rect.left-6,width:n.rect.width+12,height:n.rect.height+12}}),t.jsxs("div",{className:"help-bubble",ref:c,style:r??void 0,"data-placement":n.placement,children:[t.jsx("div",{className:"help-title",children:n.title}),t.jsx("div",{className:"help-body",children:n.body})]})]})}const Pl=[{id:"builder",label:"Builder lens",body:"Focus on step payloads, execution paths, and replay control."},{id:"executive",label:"Executive lens",body:"Focus on bottlenecks, risk, and outcome-level run quality."},{id:"operator",label:"Operator lens",body:"Focus on failures, retries, and trace reliability posture."}],Ll=[{id:"rapid_triage",label:"Rapid triage",body:"Jump straight to the highest-risk step and start resolution.",estimate:"2-3 min"},{id:"deep_diagnosis",label:"Deep diagnosis",body:"Open flow and guided analysis for full root-cause exploration.",estimate:"8-12 min"},{id:"team_sync",label:"Team sync",body:"Open collaborative mode and prep a handoff workflow.",estimate:"4-6 min"}];function Fl({onComplete:e,onStartTour:n,onStartStory:s,persona:r="builder",onPersonaChange:i,launchPath:d="rapid_triage",onLaunchPathChange:c,onStartLaunchPath:p}){const u=()=>{n==null||n(),e()},h=()=>{s==null||s(),e()},f=y=>{c==null||c(y),p==null||p(y),e()};return t.jsx("div",{className:"intro-overlay",role:"dialog","aria-modal":"true","aria-label":"Agent Director intro",children:t.jsxs("div",{className:"intro-card",children:[t.jsx("div",{className:"intro-scan"}),t.jsx("div",{className:"intro-title",children:"Agent Director"}),t.jsx("div",{className:"intro-tagline",children:"Watch your agent think. Then direct it."}),t.jsxs("div",{className:"intro-steps",children:[t.jsxs("div",{className:"intro-step",children:[t.jsx("div",{className:"intro-step-label",children:"Observe"}),t.jsx("div",{className:"intro-step-body",children:"Scrub the timeline to feel pacing and parallelism."})]}),t.jsxs("div",{className:"intro-step",children:[t.jsx("div",{className:"intro-step-label",children:"Inspect"}),t.jsx("div",{className:"intro-step-body",children:"Open the bottleneck to read payloads and costs."})]}),t.jsxs("div",{className:"intro-step",children:[t.jsx("div",{className:"intro-step-label",children:"Direct"}),t.jsx("div",{className:"intro-step-body",children:"Replay from a decisive step and compare runs."})]})]}),t.jsx("div",{className:"intro-personas",role:"group","aria-label":"Select onboarding lens",children:Pl.map(y=>t.jsxs("button",{type:"button",className:`ghost-button intro-persona ${r===y.id?"active":""}`,onClick:()=>i==null?void 0:i(y.id),"aria-pressed":r===y.id,"aria-label":y.label,children:[t.jsx("span",{className:"intro-persona-label",children:y.label}),t.jsx("span",{className:"intro-persona-body",children:y.body})]},y.id))}),t.jsx("div",{className:"intro-launch-paths",role:"group","aria-label":"Select launch path",children:Ll.map(y=>t.jsxs("article",{className:`intro-path-card ${d===y.id?"active":""}`,children:[t.jsxs("button",{type:"button",className:`ghost-button intro-path-button ${d===y.id?"active":""}`,onClick:()=>c==null?void 0:c(y.id),"aria-pressed":d===y.id,"aria-label":y.label,children:[t.jsx("span",{className:"intro-path-label",children:y.label}),t.jsx("span",{className:"intro-path-estimate",children:y.estimate}),t.jsx("span",{className:"intro-path-body",children:y.body})]}),t.jsxs("button",{className:"primary-button intro-path-start",type:"button",onClick:()=>f(y.id),children:["Start ",y.label]})]},y.id))}),t.jsxs("div",{className:"intro-grid",children:[t.jsx("span",{}),t.jsx("span",{}),t.jsx("span",{}),t.jsx("span",{})]}),t.jsxs("div",{className:"intro-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:u,children:"Start guided tour"}),s?t.jsx("button",{className:"ghost-button",type:"button",onClick:h,children:"Play story mode"}):null,t.jsx("button",{className:"ghost-button",type:"button",onClick:e,children:"Skip intro"})]})]})})}function ql({explainMode:e,storyActive:n,onStartTour:s,onStartStory:r,onToggleExplain:i,onDismiss:d}){return t.jsxs("section",{className:"hero-ribbon","aria-label":"Director briefing","data-help":!0,"data-help-indicator":!0,"data-tour":"hero","data-help-title":"Director briefing","data-help-body":"Start the tour, play story mode, or enable explain to learn the interface instantly.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"hero-ribbon-top",children:[t.jsx("span",{className:"hero-eyebrow",children:"Director briefing"}),t.jsx("button",{className:"ghost-button hero-dismiss",type:"button",onClick:d,children:"Dismiss"})]}),t.jsx("div",{className:"hero-title",children:"Observe. Inspect. Direct."}),t.jsx("div",{className:"hero-subtitle",children:"A cinematic control room for agent traces. See time, read structure, then replay with confidence."}),t.jsxs("div",{className:"hero-pills",children:[t.jsx("span",{className:"hero-pill","data-tone":"observe",children:"Observe"}),t.jsx("span",{className:"hero-pill","data-tone":"inspect",children:"Inspect"}),t.jsx("span",{className:"hero-pill","data-tone":"direct",children:"Direct"})]}),t.jsxs("div",{className:"hero-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:s,children:"Start guided tour"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:r,disabled:n,children:n?"Story running":"Play story mode"}),t.jsxs("button",{className:`ghost-button ${e?"active":""}`,type:"button",onClick:i,"aria-pressed":e,children:["Explain ",e?"On":"Off"]})]})]})}function zl({mode:e,isPlaying:n,storyActive:s,explainMode:r,hidden:i=!1,open:d,onToggleOpen:c,onTogglePlay:p,onStartStory:u,onStopStory:h,onStartTour:f,onOpenPalette:y,onShowShortcuts:w,onToggleExplain:x,onJumpToBottleneck:k}){if(i)return null;const b=n?"Pause":"Play",j=s?"Stop story":"Story mode";return d?t.jsxs("aside",{className:"quick-actions","aria-label":"Quick actions","data-help":!0,"data-help-indicator":!0,"data-tour":"quick-actions","data-help-title":"Quick actions","data-help-body":"Launch story mode, open the command palette, or jump to the bottleneck instantly.","data-help-placement":"left",children:[t.jsxs("div",{className:"quick-actions-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"quick-actions-title",children:"Quick actions"}),t.jsx("div",{className:"quick-actions-subtitle",children:"Pin demo controls close at hand."})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:c,"aria-label":"Collapse quick actions",children:"Collapse"})]}),t.jsxs("button",{className:`quick-action ${n?"active":""}`,type:"button",onClick:p,"aria-label":b,"data-help":!0,"data-help-title":"Play or pause","data-help-body":"Start or stop playback from anywhere.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:b}),t.jsx("span",{className:"quick-action-meta",children:e==="flow"?"Cinema":"Space"})]}),t.jsxs("button",{className:`quick-action ${s?"active":""}`,type:"button",onClick:s?h:u,"aria-label":j,"data-help":!0,"data-help-title":"Story mode","data-help-body":"Auto-runs a cinematic walkthrough of the run.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:j}),t.jsx("span",{className:"quick-action-meta",children:"S"})]}),t.jsxs("button",{className:"quick-action",type:"button",onClick:y,"aria-label":"Open command palette","data-help":!0,"data-help-title":"Command palette","data-help-body":"Search every action and jump instantly.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Command"}),t.jsx("span",{className:"quick-action-meta",children:"Cmd+K"})]}),t.jsxs("button",{className:"quick-action",type:"button",onClick:f,"aria-label":"Start guided tour","data-help":!0,"data-help-title":"Guided tour","data-help-body":"Walk the interface with a curated tour.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Tour"}),t.jsx("span",{className:"quick-action-meta",children:"Guide"})]}),t.jsxs("button",{className:`quick-action ${r?"active":""}`,type:"button",onClick:x,"aria-label":"Toggle explain mode","data-help":!0,"data-help-title":"Explain mode","data-help-body":"Toggle contextual overlays for every control.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Explain"}),t.jsx("span",{className:"quick-action-meta",children:r?"On":"Off"})]}),t.jsxs("button",{className:"quick-action",type:"button",onClick:k,"aria-label":"Jump to bottleneck","data-help":!0,"data-help-title":"Bottleneck jump","data-help-body":"Focus instantly on the slowest step.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Bottleneck"}),t.jsx("span",{className:"quick-action-meta",children:"Latency"})]}),t.jsxs("button",{className:"quick-action",type:"button",onClick:w,"aria-label":"Show shortcuts","data-help":!0,"data-help-title":"Shortcuts","data-help-body":"See the full keyboard map.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Shortcuts"}),t.jsx("span",{className:"quick-action-meta",children:"?"})]})]}):t.jsxs("button",{className:"quick-actions-toggle",type:"button",onClick:c,title:"Open quick actions","aria-expanded":"false","data-help":!0,"data-tour":"quick-actions","data-help-title":"Quick actions","data-help-body":"Open the dock to access demos, shortcuts, and instant actions.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-actions-toggle-label",children:"Actions"}),t.jsx("span",{className:"quick-actions-toggle-meta",children:"Dock"})]})}function Gl({active:e,label:n,step:s,total:r,onStop:i,onRestart:d}){if(!e)return null;const c=r>0?(s+1)/r*100:0;return t.jsxs("div",{className:"story-banner",role:"status","aria-live":"polite",children:[t.jsxs("div",{className:"story-banner-main",children:[t.jsx("div",{className:"story-banner-title",children:"Story mode"}),t.jsx("div",{className:"story-banner-step",children:n})]}),t.jsxs("div",{className:"story-banner-actions",children:[t.jsxs("span",{className:"story-banner-count",children:[Math.min(s+1,r),"/",r]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:d,children:"Restart"}),t.jsx("button",{className:"primary-button",type:"button",onClick:i,children:"Stop"})]}),t.jsx("div",{className:"story-banner-progress",children:t.jsx("span",{style:{width:`${c}%`}})})]})}function _n({variant:e,title:n,message:s,actions:r=[]}){return t.jsx("section",{className:`app-shell-state app-shell-${e}`,"aria-live":"polite",children:t.jsxs("div",{className:"app-shell-card",children:[e==="loading"?t.jsx("div",{className:"app-shell-spinner","aria-hidden":"true"}):null,t.jsx("h2",{children:n}),t.jsx("p",{children:s}),r.length?t.jsx("div",{className:"app-shell-actions",children:r.map(i=>t.jsx("span",{children:i.node},i.id))}):null]})})}function Bl({notifications:e,onDismiss:n}){return e.length?t.jsx("aside",{className:"notification-center","aria-label":"System notifications","aria-live":"polite",children:e.map(s=>t.jsxs("article",{className:`notification-item level-${s.level}`,children:[t.jsx("p",{children:s.message}),t.jsx("button",{className:"ghost-button notification-dismiss",type:"button",onClick:()=>n(s.id),"aria-label":"Dismiss notification",children:"Dismiss"})]},s.id))}):null}function Wl({steps:e,fromRects:n,toRects:s,onComplete:r}){return l.useEffect(()=>{const i=window.setTimeout(r,550);return()=>window.clearTimeout(i)},[r]),t.jsx("div",{className:"morph-layer",children:e.map(i=>{var p;const d=n[i.id],c=s[i.id];return!d||!c?null:t.jsxs(Fo.div,{className:`morph-card step-${i.type}`,initial:{left:d.left,top:d.top,width:d.width,height:d.height},animate:{left:c.left,top:c.top,width:c.width,height:c.height},transition:{duration:.5,ease:"easeInOut"},children:[t.jsx("div",{className:"morph-card-title",children:i.name}),t.jsx("div",{className:"morph-card-subtitle",children:((p=i.preview)==null?void 0:p.title)??i.type})]},i.id)})})}function Hl({morph:e,onComplete:n,children:s}){return t.jsxs("div",{className:"morph-orchestrator",children:[s,e?t.jsx(Wl,{steps:e.steps,fromRects:e.fromRects,toRects:e.toRects,onComplete:n}):null]})}const Ul="demo-trace-overlap-001",Vl="Overlap + ToolCallId Demo",Jl="2026-01-27T10:00:00.000Z",Kl="2026-01-27T10:00:05.000Z",Ql="completed",Yl={source:"openai_agents",agentName:"DemoAgent",modelId:"gpt-4o-2024-11-20",wallTimeMs:5e3,workTimeMs:7200,totalTokens:1400,totalCostUsd:.018},Xl=[{id:"s1",index:0,type:"llm_call",name:"plan",startedAt:"2026-01-27T10:00:00.000Z",endedAt:"2026-01-27T10:00:01.000Z",durationMs:1e3,childStepIds:[],metrics:{tokensTotal:300,costUsd:.004},preview:{title:"LLM: plan",subtitle:"gpt-4o",outputPreview:"I'll fetch two sources..."},status:"completed"},{id:"s2",index:1,type:"llm_call",name:"call_tools",startedAt:"2026-01-27T10:00:01.000Z",endedAt:"2026-01-27T10:00:01.200Z",durationMs:200,childStepIds:[],metrics:{tokensTotal:120,costUsd:.002},preview:{title:"LLM: call tools",outputPreview:"Calling web_search + database_query"},io:{emittedToolCallIds:["tc-001","tc-002"]},status:"completed"},{id:"s3",index:2,type:"tool_call",name:"web_search",toolCallId:"tc-001",startedAt:"2026-01-27T10:00:01.200Z",endedAt:"2026-01-27T10:00:03.200Z",durationMs:2e3,childStepIds:[],metrics:{costUsd:0},preview:{title:"Tool: web_search",inputPreview:'{"q":"EU AI Act"}',outputPreview:"[3 results...]"},status:"completed"},{id:"s4",index:3,type:"tool_call",name:"database_query",toolCallId:"tc-002",startedAt:"2026-01-27T10:00:01.500Z",endedAt:"2026-01-27T10:00:02.700Z",durationMs:1200,childStepIds:[],preview:{title:"Tool: database_query",inputPreview:'{"sql":"SELECT..."}',outputPreview:'{"rows":42}'},status:"completed"},{id:"s5",index:4,type:"llm_call",name:"analyze",startedAt:"2026-01-27T10:00:03.200Z",endedAt:"2026-01-27T10:00:04.600Z",durationMs:1400,childStepIds:[],metrics:{tokensTotal:700,costUsd:.012},preview:{title:"LLM: analyze",outputPreview:"Synthesis based on tool outputs..."},io:{consumedToolCallIds:["tc-001","tc-002"]},status:"completed"}],_a={id:Ul,name:Vl,startedAt:Jl,endedAt:Kl,status:Ql,metadata:Yl,steps:Xl};function Wr(e,n){const s=Zl(e,n),r=new Set(s.map(y=>y.leftId)),i=new Set(s.map(y=>y.rightId)),d=n.steps.filter(y=>!i.has(y.id)).map(y=>y.id),c=e.steps.filter(y=>!r.has(y.id)).map(y=>y.id),p=s.filter(y=>{const w=e.steps.find(k=>k.id===y.leftId),x=n.steps.find(k=>k.id===y.rightId);return!w||!x?!1:pr(w)!==pr(x)}),u=p.map(y=>y.leftId),h=(n.metadata.totalCostUsd??0)-(e.metadata.totalCostUsd??0),f=n.metadata.wallTimeMs-e.metadata.wallTimeMs;return{addedSteps:d,removedSteps:c,changedSteps:u,changedPairs:p,alignedSteps:s,costDeltaUsd:h,wallTimeDeltaMs:f}}function Zl(e,n){const s=[],r=new Set(e.steps.map(f=>f.id)),i=new Set(n.steps.map(f=>f.id));Array.from(r).forEach(f=>{i.has(f)&&(s.push({leftId:f,rightId:f}),r.delete(f),i.delete(f))});const d=new Map;n.steps.forEach(f=>{f.toolCallId&&d.set(f.toolCallId,f.id)}),e.steps.forEach(f=>{if(!f.toolCallId)return;const y=d.get(f.toolCallId);y&&i.has(y)&&(s.push({leftId:f.id,rightId:y}),r.delete(f.id),i.delete(y))});const c=fr(e),p=fr(n),u=ec(e,n),h={};return i.forEach(f=>{const y=p.get(f);if(!y)return;const w=mr(y.step);w&&(h[w]||(h[w]=[]),h[w].push(f))}),Object.values(h).forEach(f=>{f.sort((y,w)=>{var x,k;return(((x=p.get(y))==null?void 0:x.startMs)??0)-(((k=p.get(w))==null?void 0:k.startMs)??0)})}),Array.from(r).forEach(f=>{var k;const y=c.get(f);if(!y)return;const w=mr(y.step);if(!w||!((k=h[w])!=null&&k.length))return;const x=tc(y,h[w],p,u);x&&(s.push({leftId:f,rightId:x}),r.delete(f),i.delete(x),h[w]=h[w].filter(b=>b!==x))}),s}function pr(e){var r,i;const n=((r=e.preview)==null?void 0:r.outputPreview)??null,s=((i=e.metrics)==null?void 0:i.costUsd)??null;return`${e.status}|${n??""}|${s??""}`}function mr(e){return e.type?`${e.type}:${e.name??""}`:null}function hr(e){if(!e)return null;const n=Date.parse(e);return Number.isNaN(n)?null:n}function fr(e){const n=hr(e.startedAt),s=new Map;return e.steps.forEach(r=>{const i=hr(r.startedAt),d=n!=null&&i!=null?i-n:null;s.set(r.id,{step:r,startMs:d})}),s}function ec(e,n){const s=Math.max(e.metadata.wallTimeMs,n.metadata.wallTimeMs,1);return Math.max(1e3,Math.min(5e3,Math.round(s*.1)))}function tc(e,n,s,r){const i=e.startMs;if(i==null)return null;let d=null,c=r+1;return n.forEach(p=>{const u=s.get(p);if(!u||u.startMs==null)return;const h=Math.abs(u.startMs-i);h<c&&(c=h,d=p)}),c<=r?d:null}const ac=new Map,nc=new Map,gt=new Map;async function sc(){return[_a]}async function Hr(e){return{trace:_a}}const rc={s1:{role:"assistant",content:"I'll analyze the user's request and create a plan to fetch information from two sources: a web search for current EU AI Act updates and a database query for historical compliance data.",model:"gpt-4o-2024-11-20",usage:{prompt_tokens:150,completion_tokens:150,total_tokens:300},reasoning:"The user wants comprehensive information about AI regulations. I'll use parallel tool calls to maximize efficiency."},s2:{role:"assistant",content:null,tool_calls:[{id:"tc-001",type:"function",function:{name:"web_search",arguments:'{"q":"EU AI Act latest updates 2026"}'}},{id:"tc-002",type:"function",function:{name:"database_query",arguments:`{"sql":"SELECT * FROM compliance_records WHERE region='EU' ORDER BY date DESC LIMIT 10"}`}}],model:"gpt-4o-2024-11-20",usage:{prompt_tokens:80,completion_tokens:40,total_tokens:120}},s3:{tool_call_id:"tc-001",tool_name:"web_search",input:{q:"EU AI Act latest updates 2026"},output:{results:[{title:"EU AI Act Implementation Timeline",url:"https://example.com/ai-act",snippet:"The EU AI Act enters full force in 2026..."},{title:"High-Risk AI Systems Classification",url:"https://example.com/classification",snippet:"New guidance on high-risk categorization..."},{title:"Compliance Deadlines Approaching",url:"https://example.com/deadlines",snippet:"Organizations must comply by August 2026..."}],total_results:3,search_time_ms:1850},status:"success"},s4:{tool_call_id:"tc-002",tool_name:"database_query",input:{sql:"SELECT * FROM compliance_records WHERE region='EU' ORDER BY date DESC LIMIT 10"},output:{rows:[{id:1,company:"TechCorp",status:"compliant",date:"2026-01-15"},{id:2,company:"AIStartup",status:"in_progress",date:"2026-01-10"},{id:3,company:"DataCo",status:"compliant",date:"2026-01-05"}],row_count:42,query_time_ms:1100},status:"success"},s5:{role:"assistant",content:`Based on my analysis of the web search results and database records:

**Key Findings:**
1. The EU AI Act is now in full effect as of 2026
2. High-risk AI systems require specific compliance measures
3. 42 organizations in our database have compliance records

**Recommendations:**
- Review classification of AI systems
- Ensure documentation is complete
- Schedule compliance audit before August deadline`,model:"gpt-4o-2024-11-20",usage:{prompt_tokens:450,completion_tokens:250,total_tokens:700},reasoning:"Synthesized information from both the web search (3 relevant articles) and database query (42 compliance records) to provide actionable insights."}};function ic(e,n){const s=_a.steps.find(d=>d.id===e);if(!s)return null;const r=rc[e];if(!r)return null;const i=n?oc(r):r;return{...s,data:i}}function oc(e){var s,r;const n=JSON.parse(JSON.stringify(e));return(s=n.input)!=null&&s.sql&&(n.input.sql="[REDACTED]"),(r=n.output)!=null&&r.rows&&(n.output.rows=n.output.rows.map(i=>({...i,company:"[REDACTED]"}))),n.tool_calls&&(n.tool_calls=n.tool_calls.map(i=>({...i,function:{...i.function,arguments:"[REDACTED]"}}))),n}async function lc(e,n,s,r=[],i=!1){return await new Promise(d=>setTimeout(d,150)),ic(n,i)}async function Tn(e,n,s){await lc(e,n,"redacted",[],s)}function cc(e,n){return()=>{}}function dc(){ac.clear(),nc.clear()}async function uc(e,n){return null}async function pc(e){return null}async function Gd(e,n){return[]}async function Bd(e,n,s,r,i){return null}async function mc(){return[]}async function hc(e,n){return null}async function fc(e,n,s,r,i){return i?Ur(i,n,s,r):null}function Ur(e,n,s,r){var k;const i=JSON.parse(JSON.stringify(e)),d=6e4,c=Date.parse("2024-01-01T00:00:00.000Z"),p=Date.parse(e.endedAt??e.startedAt??""),h=(Number.isNaN(p)?c:p)+d,f=new Date(h);i.id=`${e.id}-replay-${h}`,i.parentTraceId=e.id,i.branchPointStepId=n,i.replay={strategy:s,modifiedStepId:n,modifications:r,createdAt:f.toISOString()};const y=b=>{if(!b)return b;const j=Date.parse(b);return Number.isNaN(j)?b:new Date(j+d).toISOString()};i.startedAt=y(i.startedAt)??i.startedAt,i.endedAt=y(i.endedAt);const w=new Set,x=((k=i.steps.find(b=>b.id===n))==null?void 0:k.index)??-1;return s==="live"?i.steps.forEach(b=>{b.index>x&&w.add(b.id)}):s==="hybrid"&&i.steps.forEach(b=>{b.index>x&&w.add(b.id)}),i.steps=i.steps.map(b=>{var C;const j={...b};if(j.startedAt=y(b.startedAt)??b.startedAt,j.endedAt=y(b.endedAt),b.id===n){const D=((C=b.preview)==null?void 0:C.outputPreview)??"";j.preview={...b.preview,outputPreview:`${D} (modified)`.trim()}}return w.has(b.id)&&(j.status="pending",j.endedAt=null,j.durationMs=void 0,j.metrics=void 0,j.preview={...b.preview,outputPreview:"[invalidated for replay]"}),j}),i}async function yc(e){return xc(e)}async function bc(e){var n;return((n=gt.get(e))==null?void 0:n.job)??null}async function yr(e){var n;return((n=gt.get(e))==null?void 0:n.matrix)??null}async function gc(e){{const n=gt.get(e);if(!n)return null;const s={...n.job,status:"canceled",scenarios:n.job.scenarios.map(r=>({...r,status:"canceled",endedAt:r.endedAt??new Date().toISOString()}))};return gt.set(e,{...n,job:s}),s}}function xc(e){const n=`demo-job-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,s=_a,r=new Date().toISOString(),i=e.scenarios.map((u,h)=>({id:`demo-scn-${h+1}`,name:u.name,strategy:u.strategy,modifications:u.modifications,status:"running",startedAt:r,endedAt:null,replayTraceId:`${n}-replay-${h+1}`})),d={id:n,traceId:e.traceId,stepId:e.stepId,status:"running",createdAt:r,startedAt:r,endedAt:null,scenarioCount:i.length,completedCount:0,failedCount:0,canceledCount:0,scenarios:i},c=i.map(u=>{const h=Ur(s,e.stepId,u.strategy,u.modifications);h.id=u.replayTraceId;const f=Wr(s,h),y=s.metadata.totalCostUsd??0,w=h.metadata.totalCostUsd??y,x=s.metadata.errorCount??0,k=h.metadata.errorCount??x,b=s.metadata.retryCount??0,j=h.metadata.retryCount??b,C=h.steps.filter(D=>D.status==="pending").length;return{scenarioId:u.id,name:u.name,strategy:u.strategy,status:"completed",replayTraceId:u.replayTraceId,modifications:u.modifications,error:null,changedStepIds:f.changedSteps,addedStepIds:f.addedSteps,removedStepIds:f.removedSteps,metrics:{costDeltaUsd:w-y,wallTimeDeltaMs:(h.metadata.wallTimeMs??0)-(s.metadata.wallTimeMs??0),errorDelta:k-x,retryDelta:j-b,changedSteps:f.changedSteps.length,addedSteps:f.addedSteps.length,removedSteps:f.removedSteps.length,invalidatedStepCount:C}}}),p={jobId:n,traceId:e.traceId,stepId:e.stepId,rows:c,causalRanking:[]};return gt.set(n,{job:d,matrix:p}),window.setTimeout(()=>{const u=gt.get(n);if(!u)return;const h=new Date().toISOString(),f=u.job.scenarios.map(x=>({...x,status:"completed",endedAt:h})),y={...u.job,status:"completed",endedAt:h,completedCount:f.length,scenarios:f},w={...u.matrix,rows:u.matrix.rows.map(x=>({...x,status:"completed"}))};gt.set(n,{job:y,matrix:w})},600),d}async function vc(e){return null}async function wc(e){return null}async function An(e){return null}async function kc(e){return null}async function jc(e){return null}async function Sc(e){return null}async function br(e){return{session:null,conflict:!1,error:null}}async function gr(e){return null}async function Nc(e){return null}async function Cc(e){return null}async function Mc(e){return null}async function Ec(e){return null}async function Ic(e,n){return null}async function _c(e){return null}async function Tc(e,n,s){return null}async function xr(){return null}async function vr(){return null}function Ac(e,n,s){return()=>{}}function Dc(){const[e,n]=l.useState(null),[s,r]=l.useState(null),[i,d]=l.useState(!0),[c,p]=l.useState(null),[u,h]=l.useState([]),[f,y]=l.useState(null),w=l.useCallback(async k=>{const b=await Hr(),j=(b==null?void 0:b.trace)??null;n(j),r(j?(b==null?void 0:b.insights)??Vo(j):null)},[n,r]),x=l.useCallback(async()=>{var k;d(!0),p(null);try{const b=await sc();h(b);const j=((k=b[b.length-1])==null?void 0:k.id)??null,C=f??j;if(!C){n(null),r(null);return}if(!f||f!==C){y(C);return}await w(C)}catch(b){p(b instanceof Error?b.message:"Failed to load trace")}finally{d(!1)}},[f,w]);return l.useEffect(()=>{x()},[x]),l.useEffect(()=>{f&&(d(!0),w(f).catch(k=>{p(k instanceof Error?k.message:"Failed to load trace")}).finally(()=>d(!1)))},[f,w]),l.useEffect(()=>cc(),[f,y]),{trace:e,insights:s,loading:i,error:c,reload:x,traces:u,selectedTraceId:f,setSelectedTraceId:y}}function U(e,n){const[s,r]=l.useState(()=>{if(typeof window>"u")return n;try{const i=window.localStorage.getItem(e);return i==null?n:JSON.parse(i)}catch{return n}});return l.useEffect(()=>{try{window.localStorage.setItem(e,JSON.stringify(s))}catch{}},[e,s]),[s,r]}const wr=new Map;function $c(e,n){const s=e.map(i=>i.id).join("|"),r=n.map(i=>`${i.source}->${i.target}`).join("|");return`${e.length}:${n.length}:${s}:${r}`}function Rc(e,n,s){if(s){const r=$c(e,n),i=wr.get(s);if(i&&i.signature===r)return i.layout;const d=kr(e,n);return wr.set(s,{signature:r,layout:d}),d}return kr(e,n)}function kr(e,n){if(e.length>2500){const r=Math.ceil(Math.sqrt(e.length));return e.map((i,d)=>{const c=Math.floor(d/r),p=d%r;return{id:i.id,position:{x:p*260,y:c*160}}})}const s=new er.graphlib.Graph;return s.setGraph({rankdir:"LR",nodesep:48,ranksep:80}),s.setDefaultEdgeLabel(()=>({})),e.forEach(r=>{s.setNode(r.id,{width:220,height:120})}),n.forEach(r=>{s.setEdge(r.source,r.target)}),er.layout(s),e.map(r=>{const i=s.node(r.id);return{id:r.id,position:{x:i.x-i.width/2,y:i.y-i.height/2}}})}const Vr="agentDirector.gameplayFunnel.v1";function Oc(){try{const e=window.localStorage.getItem(Vr);if(!e)return[];const n=JSON.parse(e);return Array.isArray(n)?n.filter(s=>{if(!s||typeof s!="object")return!1;const r=s;return typeof r.name=="string"&&typeof r.at=="number"&&!!r.metadata&&typeof r.metadata=="object"}):[]}catch{return[]}}function Pc(e,n={}){const s={name:e,at:Date.now(),metadata:n},i=[...Oc(),s].slice(-200);return window.localStorage.setItem(Vr,JSON.stringify(i)),s}function Lc(e){const n=new Map;for(const r of e)r.type==="tool_call"&&r.toolCallId&&n.set(r.toolCallId,r.id);const s=[];for(const r of e)if(!(r.type!=="llm_call"||!r.io)){for(const i of r.io.emittedToolCallIds??[]){const d=n.get(i);d&&s.push({id:`io_emit_${r.id}_${d}`,source:r.id,target:d,kind:"io",toolCallId:i})}for(const i of r.io.consumedToolCallIds??[]){const d=n.get(i);d&&s.push({id:`io_consume_${d}_${r.id}`,source:d,target:r.id,kind:"io",toolCallId:i})}}return s}function Fc(e,n,s){const{intervals:r}=Ia(e,n,s),i=new Set;return r.forEach(d=>{i.add(d.startMs),i.add(d.endMs)}),Array.from(i).sort((d,c)=>d-c)}function qc(e,n,s){if(!e.length)return null;if(s===1){for(const r of e)if(r>n+1)return r;return e[e.length-1]}for(let r=e.length-1;r>=0;r-=1){const i=e[r];if(i<n-1)return i}return e[0]}const zc=300,Gc=2e3,Bc=1.5;function Wc(e){const n=zc*Math.pow(Bc,Math.max(0,e));return Math.min(Gc,Math.round(n))}function lt(e,n){if(!e)return n;try{return JSON.parse(e)}catch{return n}}function jr(e,n){const s=new Map;return[...e,...n].forEach(r=>{const i=s.get(r.id);(!i||r.updatedAt>=i.updatedAt)&&s.set(r.id,r)}),Array.from(s.values()).sort((r,i)=>r.createdAt-i.createdAt)}function Sr(e,n=50){return[...e].sort((s,r)=>r.timestamp-s.timestamp).slice(0,n)}const Nr=["latency storm","cache divergence","tool timeout chain","stale prompt vector","schema mismatch surge"],Dn=[{templateId:"pack-stability-bootstrap",title:"Stability Bootstrap",archetype:"stability",depthMin:1,depthMax:3,baseDifficulty:2,hazards:["latency storm","cache divergence"],rewardCredits:78},{templateId:"pack-drift-containment",title:"Drift Containment",archetype:"containment",depthMin:1,depthMax:4,baseDifficulty:2,hazards:["stale prompt vector","schema mismatch surge"],rewardCredits:82},{templateId:"pack-timeout-circuit-breaker",title:"Timeout Circuit Breaker",archetype:"resilience",depthMin:2,depthMax:5,baseDifficulty:3,hazards:["tool timeout chain","schema mismatch surge"],rewardCredits:90},{templateId:"pack-cache-realignment",title:"Cache Realignment",archetype:"forensics",depthMin:2,depthMax:6,baseDifficulty:3,hazards:["cache divergence","schema mismatch surge"],rewardCredits:96},{templateId:"pack-pipeline-quarantine",title:"Pipeline Quarantine",archetype:"containment",depthMin:3,depthMax:7,baseDifficulty:4,hazards:["stale prompt vector","tool timeout chain"],rewardCredits:102},{templateId:"pack-latency-decoupling",title:"Latency Decoupling",archetype:"throughput",depthMin:3,depthMax:8,baseDifficulty:4,hazards:["latency storm","tool timeout chain"],rewardCredits:108},{templateId:"pack-spec-reconciliation",title:"Spec Reconciliation",archetype:"forensics",depthMin:4,depthMax:9,baseDifficulty:5,hazards:["schema mismatch surge","cache divergence"],rewardCredits:114},{templateId:"pack-fault-isolation-grid",title:"Fault Isolation Grid",archetype:"diagnostics",depthMin:4,depthMax:10,baseDifficulty:5,hazards:["schema mismatch surge","stale prompt vector"],rewardCredits:120},{templateId:"pack-shadow-fork-audit",title:"Shadow Fork Audit",archetype:"timelines",depthMin:5,depthMax:11,baseDifficulty:6,hazards:["stale prompt vector","latency storm"],rewardCredits:126},{templateId:"pack-signal-recovery-run",title:"Signal Recovery Run",archetype:"recovery",depthMin:5,depthMax:12,baseDifficulty:6,hazards:["tool timeout chain","cache divergence"],rewardCredits:132},{templateId:"pack-entropy-firebreak",title:"Entropy Firebreak",archetype:"stability",depthMin:6,depthMax:13,baseDifficulty:7,hazards:["schema mismatch surge","tool timeout chain"],rewardCredits:138},{templateId:"pack-pressure-release",title:"Pressure Release",archetype:"throughput",depthMin:6,depthMax:14,baseDifficulty:7,hazards:["latency storm","stale prompt vector"],rewardCredits:144},{templateId:"pack-replay-integrity-probe",title:"Replay Integrity Probe",archetype:"diagnostics",depthMin:7,depthMax:15,baseDifficulty:8,hazards:["cache divergence","tool timeout chain"],rewardCredits:150},{templateId:"pack-phased-countermeasure",title:"Phased Countermeasure",archetype:"boss",depthMin:7,depthMax:16,baseDifficulty:8,hazards:["tool timeout chain","schema mismatch surge"],rewardCredits:156},{templateId:"pack-cascade-rollup",title:"Cascade Rollup",archetype:"recovery",depthMin:8,depthMax:18,baseDifficulty:9,hazards:["schema mismatch surge","latency storm"],rewardCredits:162},{templateId:"pack-hyperlane-retune",title:"Hyperlane Retune",archetype:"timelines",depthMin:8,depthMax:20,baseDifficulty:9,hazards:["stale prompt vector","cache divergence"],rewardCredits:168},{templateId:"pack-guardian-gambit",title:"Guardian Gambit",archetype:"stability",depthMin:9,depthMax:24,baseDifficulty:10,hazards:["schema mismatch surge","latency storm"],rewardCredits:176},{templateId:"pack-final-lockdown",title:"Final Lockdown",archetype:"boss",depthMin:10,depthMax:Number.MAX_SAFE_INTEGER,baseDifficulty:10,hazards:["tool timeout chain","cache divergence"],rewardCredits:184}],Ln=5,Cr=[{id:"seasonal-incident-sprint",title:"Resolve 3 raid objectives",goal:3,rewardCredits:120},{id:"boss-shutdown",title:"Defeat one boss encounter",goal:1,rewardCredits:200},{id:"guild-push",title:"Complete 2 guild operations",goal:2,rewardCredits:160},{id:"timeline-weaver",title:"Merge 2 timeline forks",goal:2,rewardCredits:150}],Hc={stability_patch:{credits:20,materials:12},precision_lens:{credits:28,materials:16},overclock_core:{credits:42,materials:24}};function se(e,n,s){return Math.min(s,Math.max(n,e))}function Ea(e){let n=0;for(let s=0;s<e.length;s+=1)n=(n*31+e.charCodeAt(s))%1e5;return n}function Uc(e,n,s,r){if(r.length===0)return 96;const i=r.slice(-Ln),d=new Set(i.map(y=>y.templateId)),c=new Set(i.map(y=>y.archetype)),p=new Set(i.flatMap(y=>y.hazards.map(w=>w.toLowerCase())));let f=58+[...new Set(e.map(y=>y.toLowerCase()))].filter(y=>!p.has(y)).length*12;return d.has(n)?f-=10:f+=14,c.has(s)||(f+=10),se(f,20,100)}function Vc(e,n,s,r){const i=r.slice(-Ln);if(i.length===0)return 0;const d=new Set(e.map(p=>p.toLowerCase()));let c=0;return[...i].reverse().forEach((p,u)=>{const h=Math.max(1,Ln-u),f=p.hazards.filter(y=>d.has(y.toLowerCase())).length;c+=f*4*h,p.templateId===n&&(c+=8*h),p.archetype===s&&(c+=4*h)}),se(c,0,72)}function Jc(e,n,s,r){const i=Ea(`${e}:${n}:${s.join("|")}`),d=[...new Set(s.map(x=>x.trim()).filter(Boolean))].sort().slice(-2),c=Dn.filter(x=>n>=x.depthMin&&n<=x.depthMax),u=(c.length>0?c:Dn).map(x=>{const k=Ea(`${i}:${x.templateId}`),b=Nr[k%Nr.length],j=[...new Set([...x.hazards,b,...d.slice(-1)])].slice(0,4),C=Uc(j,x.templateId,x.archetype,r),D=Vc(j,x.templateId,x.archetype,r),V=se(x.baseDifficulty+Math.floor(n/4),1,10),T=se(Math.round(46+C*.5-D*.45+V*3),0,100),R=Ea(`${k}:${r.length}:${n}`);return{template:x,candidateSeed:k,hazards:j,noveltyScore:C,repetitionPenalty:D,qualityScore:T,difficulty:V,tieBreaker:R}});u.sort((x,k)=>x.qualityScore!==k.qualityScore?x.qualityScore-k.qualityScore:x.noveltyScore!==k.noveltyScore?x.noveltyScore-k.noveltyScore:x.repetitionPenalty!==k.repetitionPenalty?k.repetitionPenalty-x.repetitionPenalty:x.tieBreaker-k.tieBreaker);const h=u[u.length-1],f=1+Math.min(n,12)*.04,y=Math.round(h.template.rewardCredits*f),w=[`seed=${h.candidateSeed}`,`depth=${n}`,`mutators=${d.join(",")||"none"}`,`template=${h.template.templateId}`,`archetype=${h.template.archetype}`].join(";");return{id:`mission-${n}-${h.template.templateId.replace("pack-","")}-${(e+n)%997}`,title:h.template.title,difficulty:h.difficulty,hazards:h.hazards,rewardCredits:y,missionSeed:h.candidateSeed,blueprint:w,templateId:h.template.templateId,archetype:h.template.archetype,qualityScore:h.qualityScore,noveltyScore:h.noveltyScore,repetitionPenalty:h.repetitionPenalty,launchPackSize:Dn.length}}function Jr(e,n,s,r){return Jc(e,n,s,r)}function Kc(){return[{id:"node-alpha",title:"Signal Fracture",body:"Telemetry divergence emerges across parallel tool paths.",choices:[{id:"alpha-risk",label:"Push aggressive branch optimization",nextNodeId:"node-beta",tensionDelta:12,mutator:"risk-surge"},{id:"alpha-safe",label:"Stabilize and preserve deterministic flow",nextNodeId:"node-beta",tensionDelta:-5,mutator:"stability-first"}]},{id:"node-beta",title:"Protocol Fork",body:"The team must choose speed versus interpretability under pressure.",choices:[{id:"beta-speed",label:"Favor speed and absorb uncertainty",nextNodeId:"node-gamma",tensionDelta:8,mutator:"throughput-boost"},{id:"beta-clarity",label:"Favor clarity and route through guardrails",nextNodeId:"node-gamma",tensionDelta:-3,mutator:"clarity-path"}]},{id:"node-gamma",title:"Final Directive",body:"Command has one move left before the run locks in.",choices:[{id:"gamma-strike",label:"Launch decisive strike sequence",nextNodeId:"node-alpha",tensionDelta:10,mutator:"strike-loop"},{id:"gamma-reset",label:"Reset tempo and rebuild confidence",nextNodeId:"node-alpha",tensionDelta:-6,mutator:"tempo-reset"}]}]}function Kr(e,n){return{...Cr[(e+n)%Cr.length],progress:0,completed:!1}}function Qr(e,n){const s=[...e,n];return Array.from(new Set(s)).slice(-6)}function Fn(e,n,s,r){return{...e,campaign:{...e.campaign,depth:n,mutators:s,missionHistory:r,currentMission:Jr(e.seed,n,s,r)}}}function Mr(e){const n=Ea(e),s=["baseline"];return{seed:n,raid:{party:["director"],roles:{director:"strategist"},objectives:[{id:"obj-root-cause",label:"Identify root cause chain",progress:0,target:100,completed:!1},{id:"obj-recover",label:"Recover operational stability",progress:0,target:100,completed:!1},{id:"obj-harden",label:"Harden replay strategy",progress:0,target:100,completed:!1}],completed:!1},campaign:{depth:1,lives:3,completedMissionIds:[],missionHistory:[],mutators:s,currentMission:Jr(n,1,s,[])},narrative:{currentNodeId:"node-alpha",nodes:Kc(),history:[],tension:35},skills:{points:6,nodes:[{id:"skill-focus",label:"Focus Matrix",cost:1,requires:[],minLevel:1,requiredMilestones:[],tier:1,loadoutSlot:"core",unlocked:!1},{id:"skill-resilience",label:"Resilience Mesh",cost:1,requires:[],minLevel:1,requiredMilestones:[],tier:1,loadoutSlot:"utility",unlocked:!1},{id:"skill-surge",label:"Surge Compiler",cost:2,requires:["skill-focus"],minLevel:2,requiredMilestones:[],tier:2,loadoutSlot:"power",unlocked:!1},{id:"skill-echo",label:"Echo Anticipator",cost:2,requires:["skill-resilience"],minLevel:2,requiredMilestones:[],tier:2,loadoutSlot:"utility",unlocked:!1},{id:"skill-ward",label:"Ward Lattice",cost:2,requires:["skill-resilience"],minLevel:3,requiredMilestones:["milestone-level-3"],tier:3,loadoutSlot:"power",unlocked:!1},{id:"skill-overclock",label:"Overclock Nexus",cost:3,requires:["skill-surge","skill-echo"],minLevel:4,requiredMilestones:["milestone-level-3"],tier:3,loadoutSlot:"power",unlocked:!1}],loadout:{capacity:3,equipped:[],slotCaps:{core:1,utility:1,power:1}}},pvp:{round:0,stability:72,sabotage:28,fog:40,winner:null},time:{activeForkId:"primary",forks:[{id:"primary",label:"Primary timeline",playheadMs:0,history:[0]}]},boss:{name:"The Causality Hydra",phase:1,hp:320,maxHp:320,enraged:!1,phaseMechanic:"Phase 1: Shield lattice destabilization",vulnerability:"exploit"},director:{risk:30,hint:"Start with the bottleneck path and branch cautiously.",recommendedModifier:"stability_patch",lastOutcome:"mixed"},economy:{credits:140,materials:90,crafted:[],inflationIndex:.438,reserveTarget:320},rewards:{dailyClaimedOn:null,streakDays:0,sessionClaimed:!1,streakClaimedFor:0,masteryClaims:[],history:[]},guild:{name:"Trace Guild",members:4,operationsScore:0,eventsCompleted:0},cinematic:{queue:[]},liveops:{season:`Season-${2026+n%2}`,week:1,challenge:Kr(n,1),difficultyFactor:1,rewardMultiplier:1,tuningHistory:[]},teamComms:{pings:[]},safety:{mutedPlayerIds:[],blockedPlayerIds:[],reports:[]},outcome:{status:"in_progress",reason:"Run started. Complete missions and stabilize the incident.",updatedAt:Date.now()},sandbox:{enabled:!1},progression:{xp:0,level:1,nextLevelXp:200,milestones:[]}}}function Wd(e,n){return{...e,sandbox:{enabled:n},outcome:n?{status:"in_progress",reason:"Sandbox mode enabled. Penalties are disabled for safe practice runs.",updatedAt:Date.now()}:e.outcome}}function Hd(e,n,s){if(!n.trim())return e;const r=e.raid.party.includes(n)?e.raid.party:[...e.raid.party,n];return{...e,raid:{...e.raid,party:r,roles:{...e.raid.roles,[n]:s}}}}function Ud(e,n,s){const r=Un(e),i=e.raid.objectives.map(u=>{if(u.id!==n)return u;const h=se(u.progress+s,0,u.target);return{...u,progress:h,completed:h>=u.target}}),d=i.every(u=>u.completed),c=d&&!e.raid.completed?180:0,p={...e,raid:{...e.raid,objectives:i,completed:d},outcome:d&&!e.raid.completed?{status:"partial",reason:"Raid objectives completed. Push campaign and boss tracks to close the run.",updatedAt:Date.now()}:r};return!d||e.raid.completed?p:Ye(ea(p,c),60)}function Vd(e,n){const s=td(e),r=e.campaign.currentMission,i=n?"success":"failure",d=[...e.campaign.missionHistory,{missionId:r.id,templateId:r.templateId??"legacy-template",archetype:r.archetype??"legacy",hazards:r.hazards,qualityScore:r.qualityScore??50,noveltyScore:r.noveltyScore??50,repetitionPenalty:r.repetitionPenalty??0,outcome:i}].slice(-30);if(n){const f=e.campaign.depth+1,y=Fn(e,f,e.campaign.mutators,d),w=f>=5?{status:"win",reason:"Campaign depth target reached. Incident run is stabilized.",updatedAt:Date.now()}:{status:"partial",reason:`Mission ${r.id} cleared. Advance deeper to secure the run.`,updatedAt:Date.now()},x={...y,campaign:{...y.campaign,completedMissionIds:[...y.campaign.completedMissionIds,r.id]},economy:{...y.economy,materials:y.economy.materials+14},director:{...y.director,lastOutcome:"success"},outcome:w};return Ye(ea(x,r.rewardCredits),120)}const c=s.enabled?e.campaign.lives:se(e.campaign.lives-1,0,3),p=Fn(e,e.campaign.depth,Qr(e.campaign.mutators,"failure-loop"),d),u=s.enabled?{status:"partial",reason:"Sandbox mode active. Failure recorded with no life penalty.",updatedAt:Date.now()}:c<=0?{status:"loss",reason:"No campaign lives remaining. Incident run failed.",updatedAt:Date.now()}:{status:"partial",reason:`Mission failed. ${c} campaign lives remaining.`,updatedAt:Date.now()},h={...p,campaign:{...p.campaign,lives:c},director:{...p.director,lastOutcome:"failure"},outcome:u};return Ye(h,40)}function Jd(e,n){const s=e.narrative.nodes.find(p=>p.id===e.narrative.currentNodeId),r=s==null?void 0:s.choices.find(p=>p.id===n);if(!s||!r)return e;const i=se(e.narrative.tension+r.tensionDelta,0,100),d=Qr(e.campaign.mutators,r.mutator),c=Fn(e,e.campaign.depth,d,e.campaign.missionHistory);return{...c,narrative:{...c.narrative,currentNodeId:r.nextNodeId,history:[...c.narrative.history,{nodeId:s.id,choiceId:r.id}],tension:i}}}function Kd(e,n){const s=e.skills.nodes.find(i=>i.id===n);return!s||!Qc(e,n).allowed?e:{...e,skills:{...e.skills,points:e.skills.points-s.cost,nodes:e.skills.nodes.map(i=>i.id===n?{...i,unlocked:!0}:i)}}}function Qd(e,n){return Yc(e,n).allowed?{...e,skills:{...e.skills,loadout:{...e.skills.loadout,equipped:[...e.skills.loadout.equipped,n]}}}:e}function Qc(e,n){const s=e.skills.nodes.find(p=>p.id===n);if(!s)return{allowed:!1,reason:"Unknown skill node."};if(s.unlocked)return{allowed:!1,reason:"Skill already unlocked."};const r=new Set(e.skills.nodes.filter(p=>p.unlocked).map(p=>p.id)),i=s.requires.filter(p=>!r.has(p));if(i.length>0)return{allowed:!1,reason:`Requires: ${i.join(", ")}`};const d=Xr(e);if(d.level<s.minLevel)return{allowed:!1,reason:`Requires level ${s.minLevel}`};const c=s.requiredMilestones.filter(p=>!d.milestones.includes(p));return c.length>0?{allowed:!1,reason:`Requires milestone ${c[0]}`}:e.skills.points<s.cost?{allowed:!1,reason:`Need ${s.cost} points`}:{allowed:!0,reason:"Unlock available"}}function Yc(e,n){const s=e.skills.nodes.find(d=>d.id===n);if(!s)return{allowed:!1,reason:"Unknown skill node."};if(!s.unlocked)return{allowed:!1,reason:"Unlock required before equip."};if(e.skills.loadout.equipped.includes(n))return{allowed:!1,reason:"Already equipped."};if(e.skills.loadout.equipped.length>=e.skills.loadout.capacity)return{allowed:!1,reason:"Loadout capacity reached."};const r=e.skills.loadout.slotCaps[s.loadoutSlot];return e.skills.loadout.equipped.reduce((d,c)=>{const p=e.skills.nodes.find(u=>u.id===c);return(p==null?void 0:p.loadoutSlot)===s.loadoutSlot?d+1:d},0)>=r?{allowed:!1,reason:`${s.loadoutSlot} slot limit reached.`}:{allowed:!0,reason:"Equip available"}}function Yd(e,n){const s=Un(e),r={...e.pvp};n==="sabotage"?(r.sabotage=se(r.sabotage+13,0,100),r.stability=se(r.stability-11,0,100),r.fog=se(r.fog+9,0,100)):n==="stabilize"?(r.stability=se(r.stability+14,0,100),r.sabotage=se(r.sabotage-8,0,100),r.fog=se(r.fog-6,0,100)):(r.fog=se(r.fog-16,0,100),r.stability=se(r.stability+3,0,100),r.sabotage=se(r.sabotage-4,0,100)),r.round+=1,r.stability<=0?r.winner="saboteur":r.sabotage<=0?r.winner="operator":r.round>=10&&(r.winner=r.stability>=r.sabotage?"operator":"saboteur");const i=r.winner==="operator"?{status:"win",reason:"Operator side prevailed in the sabotage conflict.",updatedAt:Date.now()}:r.winner==="saboteur"?{status:"loss",reason:"Saboteur pressure overwhelmed system stability.",updatedAt:Date.now()}:s,d={...e,pvp:r,outcome:i};return Ye(d,r.winner?72:12)}function Xd(e,n,s){const r=`fork-${e.time.forks.length+1}`,i={id:r,label:n.trim()||r,playheadMs:se(s,0,36e5),history:[se(s,0,36e5)]};return{...e,time:{...e.time,activeForkId:r,forks:[...e.time.forks,i]}}}function Zd(e,n){const s=e.time.activeForkId,r=e.time.forks.map(i=>{if(i.id!==s)return i;const d=se(i.playheadMs-Math.abs(n),0,36e5);return{...i,playheadMs:d,history:[...i.history,d]}});return{...e,time:{...e.time,forks:r}}}function eu(e,n){if(n==="primary")return e;const s=e.time.forks.find(d=>d.id===n),r=e.time.forks.find(d=>d.id==="primary");if(!s||!r)return e;const i={...r,playheadMs:s.playheadMs,history:[...r.history,s.playheadMs]};return{...e,time:{activeForkId:"primary",forks:[i,...e.time.forks.filter(d=>d.id!=="primary"&&d.id!==n)]}}}function tu(e,n){const s=Un(e),i={1:{exploit:42,strike:24,shield:8},2:{exploit:34,strike:28,shield:10},3:{exploit:26,strike:18,shield:14}}[e.boss.phase][n],d=e.boss.vulnerability===n?8:0,c=i+d,p=se(e.boss.hp-c,0,e.boss.maxHp),u=p/e.boss.maxHp,h=u<=.33?3:u<=.66?2:1,f=h===1?"Phase 1: Shield lattice destabilization":h===2?"Phase 2: Mirror clones absorb exploit damage":"Phase 3: Enrage pulse; shield counters become lethal",y=h===1?"exploit":h===2?"strike":"shield",w={...e,boss:{...e.boss,hp:p,phase:h,enraged:h===3||p<=e.boss.maxHp*.2,phaseMechanic:f,vulnerability:y},outcome:p<=0?{status:"win",reason:"Boss encounter cleared. Run secured.",updatedAt:Date.now()}:s};return Ye(w,p<=0?180:10)}function au(e,n){const s=n.failures*12+n.retries*4+(n.latencyMs>1400?8:0),r=se(e.director.risk+s,0,100),i=n.failures>0?"Prioritize failure triage and run a stabilizing replay branch.":n.latencyMs>1400?"Latency pressure detected. Reduce fan-out and tighten tool boundaries.":"Momentum is stable. Push a high-confidence optimization branch.",d=n.failures>1?"stability_patch":n.latencyMs>1400?"precision_lens":"overclock_core",c=n.failures>0?"failure":"success";return{...e,director:{risk:r,hint:i,recommendedModifier:d,lastOutcome:c}}}function nu(e,n){const s=Hc[n];if(!s||e.economy.credits<s.credits||e.economy.materials<s.materials)return e;const r=e.economy.crafted.includes(n)?e.economy.crafted:[...e.economy.crafted,n],i=e.economy.reserveTarget||320,d=e.economy.credits-s.credits;let c={...e,economy:{...e.economy,credits:d,materials:e.economy.materials-s.materials,crafted:r,inflationIndex:Number((d/i).toFixed(3))}};return n==="stability_patch"&&(c={...c,pvp:{...c.pvp,stability:se(c.pvp.stability+8,0,100)}}),n==="precision_lens"&&(c={...c,raid:{...c.raid,objectives:c.raid.objectives.map((p,u)=>u===0?{...p,progress:se(p.progress+10,0,p.target),completed:se(p.progress+10,0,p.target)>=p.target}:p)}}),n==="overclock_core"&&(c={...c,boss:{...c.boss,hp:se(c.boss.hp-16,0,c.boss.maxHp)}}),Ye(c,10)}function su(e,n){const s=Math.round(n),r={...e,guild:{...e.guild,operationsScore:e.guild.operationsScore+s,eventsCompleted:e.guild.eventsCompleted+(s>0?1:0)}},i=s>0?ea(r,s*3):r;return Ye(i,Math.max(0,s*6))}function ru(e,n,s,r){const i={id:`event-${e.cinematic.queue.length+1}-${e.seed%1e3}`,type:n,message:s,intensity:r,at:Date.now()};return{...e,cinematic:{queue:[i,...e.cinematic.queue].slice(0,12)}}}function iu(e){const n=Wn(e),s=n.week+1,r=Kr(e.seed,s),i=se(n.difficultyFactor??1,.6,1.6),d=se(n.rewardMultiplier??1,.5,2),c={...r,goal:Math.max(1,Math.round(r.goal*i)),rewardCredits:Math.max(1,Math.round(r.rewardCredits*d))},p={...e,liveops:{...n,week:s,challenge:c}};return Zc(p)}function ou(e,n){const s=Wn(e),r=s.challenge,i=se(n,0,20),d=se(r.progress+i,0,r.goal),c=d>=r.goal,p={...e,liveops:{...s,challenge:{...r,progress:d,completed:c}}};return!c||r.completed?p:Ye(ea(p,r.rewardCredits),80)}function Xc(e,n,s="raid_mastery"){const r=Yr(e),i=new Date().toISOString().slice(0,10);return n==="daily"?r.dailyClaimedOn===i?{allowed:!1,reason:"Daily reward already claimed today."}:{allowed:!0,reason:"Daily reward available."}:n==="session"?r.sessionClaimed?{allowed:!1,reason:"Session reward already claimed."}:e.raid.objectives.some(p=>p.progress>0)||e.campaign.depth>1||e.pvp.round>0?{allowed:!0,reason:"Session reward available."}:{allowed:!1,reason:"Session reward requires gameplay activity."}:n==="streak"?r.streakDays<3?{allowed:!1,reason:"Streak reward requires 3+ daily claims."}:r.streakClaimedFor>=r.streakDays?{allowed:!1,reason:"Streak reward already claimed for current streak."}:{allowed:!0,reason:"Streak reward available."}:r.masteryClaims.includes(s)?{allowed:!1,reason:"Mastery reward already claimed."}:(s==="raid_mastery"?e.raid.completed:s==="campaign_mastery"?e.campaign.depth>=4:e.boss.hp<=0)?{allowed:!0,reason:"Mastery reward available."}:{allowed:!1,reason:"Mastery requirement not met."}}function lu(e,n,s="raid_mastery"){if(!Xc(e,n,s).allowed)return e;const i=Yr(e),d=new Date().toISOString().slice(0,10);let c=i,p=0,u={};if(n==="daily"){const w=i.dailyClaimedOn===d?i.streakDays:i.streakDays+1;c={...i,dailyClaimedOn:d,streakDays:w},p=90+Math.min(7,w)*10,u={streakDays:w}}else n==="session"?(c={...i,sessionClaimed:!0},p=140,u={actions:e.pvp.round+e.narrative.history.length+e.campaign.depth}):n==="streak"?(c={...i,streakClaimedFor:i.streakDays},p=170+i.streakDays*5,u={streakDays:i.streakDays}):(c={...i,masteryClaims:[...i.masteryClaims,s]},p=s==="boss_mastery"?260:s==="campaign_mastery"?220:180,u={masteryId:s});const h=ea({...e,rewards:c},p),f=Math.max(1,h.economy.credits-e.economy.credits),y={id:`reward-${c.history.length+1}-${e.seed%1e3}`,kind:n,amount:f,at:Date.now(),details:u};return Ye({...h,rewards:{...c,history:[y,...c.history].slice(0,60)}},30+Math.max(1,Math.round(f/10)))}function cu(e,n){const s=Wn(e),r=se(n.difficultyFactor,.6,1.6),i=se(n.rewardMultiplier,.5,2),d=s.difficultyFactor||1,c=s.rewardMultiplier||1,p=n.note.trim()||"Operator tuning update",u={...s.challenge,goal:Math.max(1,Math.round(s.challenge.goal/d*r)),rewardCredits:Math.max(1,Math.round(s.challenge.rewardCredits/c*i))},h={id:`tuning-${s.tuningHistory.length+1}-${e.seed%1e3}`,changedAt:Date.now(),difficultyFactor:r,rewardMultiplier:i,note:p};return{...e,liveops:{...s,challenge:u,difficultyFactor:r,rewardMultiplier:i,tuningHistory:[h,...s.tuningHistory].slice(0,20)}}}function ea(e,n){if(n<=0)return e;const s=e.economy.reserveTarget||320,r=e.economy.credits;let i=1;if(r<=s){const f=Math.min(.12,(s-r)/s*.12);i=Math.min(1.12,1+f)}else{const f=(r-s)/s;i=Math.max(.45,1-f*.35)}const d=Math.max(1,Math.round(n*i)),c=Math.round(s*1.7),p=r+d,u=p>c?Math.max(1,Math.round((p-c)*.22)):0,h=p-u;return{...e,economy:{...e.economy,credits:h,inflationIndex:Number((h/s).toFixed(3))}}}function Zc(e){const n=e.economy.reserveTarget||320;if(e.economy.credits<=n)return{...e,economy:{...e.economy,inflationIndex:Number((e.economy.credits/n).toFixed(3))}};const s=Math.max(6,Math.round((e.economy.credits-n)*.08)),r=Math.max(0,e.economy.credits-s);return{...e,economy:{...e.economy,credits:r,inflationIndex:Number((r/n).toFixed(3))}}}function Wn(e){var n,s,r,i,d,c;return{season:((n=e.liveops)==null?void 0:n.season)??"Season-2026",week:((s=e.liveops)==null?void 0:s.week)??1,challenge:((r=e.liveops)==null?void 0:r.challenge)??{id:"fallback-liveops",title:"Complete one objective",goal:1,progress:0,rewardCredits:100,completed:!1},difficultyFactor:((i=e.liveops)==null?void 0:i.difficultyFactor)??1,rewardMultiplier:((d=e.liveops)==null?void 0:d.rewardMultiplier)??1,tuningHistory:((c=e.liveops)==null?void 0:c.tuningHistory)??[]}}function Yr(e){return e.rewards??{dailyClaimedOn:null,streakDays:0,sessionClaimed:!1,streakClaimedFor:0,masteryClaims:[],history:[]}}function ed(e){return e.teamComms??{pings:[]}}function Ta(e){return e.trim().toLowerCase()}function Hn(e){return e.safety??{mutedPlayerIds:[],blockedPlayerIds:[],reports:[]}}function du(e,n,s,r="director"){const i=n,d=(s??"").trim(),c=d.length>0;if(c&&!e.raid.objectives.some(h=>h.id===d))return e;const p=ed(e),u={id:`ping-${p.pings.length+1}-${e.seed%1e3}`,fromPlayerId:Ta(r)||"director",intent:i,targetObjectiveId:c?d:null,createdAt:Date.now()};return{...e,teamComms:{pings:[u,...p.pings].slice(0,50)}}}function Un(e){return e.outcome??{status:"in_progress",reason:"Run in progress.",updatedAt:Date.now()}}function td(e){return e.sandbox??{enabled:!1}}function Xr(e){return e.progression??{xp:0,level:1,nextLevelXp:200,milestones:[]}}function Ye(e,n){if(n<=0)return e;const s=Xr(e);let r=s.xp+n,i=s.level,d=s.nextLevelXp,c=0;for(;r>=d;)r-=d,i+=1,c+=1,d=i*200;const p=[...s.milestones];return[3,5,10].forEach(u=>{const h=`milestone-level-${u}`;i>=u&&!p.includes(h)&&p.push(h)}),{...e,progression:{xp:r,level:i,nextLevelXp:d,milestones:p},skills:{...e.skills,points:e.skills.points+c}}}function uu(e,n,s){const r=Ta(n),i=s.trim();if(!r||!i)return e;const d=Hn(e),c={id:`report-${d.reports.length+1}-${e.seed%1e3}`,targetPlayerId:r,reason:i,createdAt:Date.now()};return{...e,safety:{...d,reports:[c,...d.reports].slice(0,40)}}}function pu(e,n){const s=Ta(n),r=Hn(e);return!s||r.mutedPlayerIds.includes(s)?e:{...e,safety:{...r,mutedPlayerIds:[...r.mutedPlayerIds,s]}}}function mu(e,n){const s=Ta(n),r=Hn(e);return!s||r.blockedPlayerIds.includes(s)?e:{...e,safety:{...r,blockedPlayerIds:[...r.blockedPlayerIds,s],mutedPlayerIds:r.mutedPlayerIds.includes(s)?r.mutedPlayerIds:[...r.mutedPlayerIds,s]}}}const Er={en:{setup_support_title:"Setup + support",open_setup_wizard:"Open setup wizard",open_support_panel:"Open support panel",telemetry_summary_title:"Telemetry summary",telemetry_summary_body:"Product events are captured in local analytics queue for pre-release UX audits.",export_event_queue:"Export event queue",settings_center_title:"Settings center",settings_center_body:"Centralized controls for input, UX behavior, and safe sharing defaults.",safe_export:"Safe export",gamepad_enabled:"Gamepad enabled",timeline_windowing:"Timeline windowing",theme_label:"Theme",motion_label:"Motion",app_language_label:"App language",gameplay_locale_label:"Gameplay locale",traceql_placeholder:"TraceQL (example: type=tool_call and duration_ms>800)",run_traceql:"Run TraceQL",clear_traceql:"Clear TraceQL",select_extension:"Select extension",run_extension:"Run extension",running_extension:"Running extension...",mode_cinema:"Cinema",mode_flow:"Flow",mode_compare:"Compare",mode_matrix:"Matrix",mode_gameplay:"Gameplay",windowed:"Windowed",overlay:"Overlay",sync_playback:"Sync playback",loading_view:"Loading view...",loading_panel:"Loading panel..."},es:{setup_support_title:"Configuracion y soporte",open_setup_wizard:"Abrir asistente de configuracion",open_support_panel:"Abrir panel de soporte",telemetry_summary_title:"Resumen de telemetria",telemetry_summary_body:"Los eventos de producto se guardan en una cola local para auditorias UX de pre-lanzamiento.",export_event_queue:"Exportar cola de eventos",settings_center_title:"Centro de configuracion",settings_center_body:"Controles centralizados para entradas, UX y opciones seguras de comparticion.",safe_export:"Exportacion segura",gamepad_enabled:"Gamepad habilitado",timeline_windowing:"Ventana de timeline",theme_label:"Tema",motion_label:"Movimiento",app_language_label:"Idioma de la app",gameplay_locale_label:"Idioma de gameplay",traceql_placeholder:"TraceQL (ejemplo: type=tool_call and duration_ms>800)",run_traceql:"Ejecutar TraceQL",clear_traceql:"Limpiar TraceQL",select_extension:"Seleccionar extension",run_extension:"Ejecutar extension",running_extension:"Ejecutando extension...",mode_cinema:"Cine",mode_flow:"Flujo",mode_compare:"Comparar",mode_matrix:"Matriz",mode_gameplay:"Gameplay",windowed:"En ventana",overlay:"Superposicion",sync_playback:"Sincronizar reproduccion",loading_view:"Cargando vista...",loading_panel:"Cargando panel..."}},ad=[{value:"en",label:"English"},{value:"es",label:"Espanol"}];function Ir(e){return e==="es"?"es":"en"}function nd(e,n){var s;return((s=Er[e])==null?void 0:s[n])??Er.en[n]}const sd=new Set(["cinema","flow","compare","matrix","gameplay"]);function $n(e){if(!e)return;const n=e.trim();return n.length?n:void 0}function _r(e){const n=new URLSearchParams(e),s=$n(n.get("mode")),r=$n(n.get("trace")),i=$n(n.get("step")),d={};return s&&sd.has(s)&&(d.mode=s),r&&(d.traceId=r),i&&(d.stepId=i),d}function rd(e,n){const s=new URL(e);return n.mode?s.searchParams.set("mode",n.mode):s.searchParams.delete("mode"),n.traceId?s.searchParams.set("trace",n.traceId):s.searchParams.delete("trace"),n.stepId?s.searchParams.set("step",n.stepId):s.searchParams.delete("step"),s.toString()}function Tr(e){if(typeof e.durationMs=="number"&&Number.isFinite(e.durationMs))return Math.max(0,e.durationMs);const n=Date.parse(e.startedAt),s=Date.parse(e.endedAt??e.startedAt);return!Number.isFinite(n)||!Number.isFinite(s)?0:Math.max(0,s-n)}function id(e,n,s){return e==="analysis"?s?"compare":"matrix":e==="collaboration"?"gameplay":e==="operations"?n==="compare"?"matrix":n:n==="gameplay"?"cinema":n}function od(e,n,s=6){var h,f,y,w,x;if(e.length===0)return[];const r=[...e].sort((k,b)=>k.index-b.index),i=n?r.findIndex(k=>k.id===n):-1,d=r.find(k=>k.status==="failed"),c=r.reduce((k,b)=>Tr(b)>Tr(k)?b:k),p=[(h=r[0])==null?void 0:h.id,i>=0?(f=r[i])==null?void 0:f.id:null,i>0?(y=r[i-1])==null?void 0:y.id:null,i>=0&&i<r.length-1?(w=r[i+1])==null?void 0:w.id:null,(d==null?void 0:d.id)??null,c.id,(x=r[r.length-1])==null?void 0:x.id];return Array.from(new Set(p.filter(k=>!!k))).slice(0,s)}const qn={setupWizardV1:!0,supportPanelV1:!0,exportCenterV1:!0,ownershipPanelV1:!0},Zr="agentDirector.analytics.events.v1",ei="agentDirector.featureFlags.v1",ld=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;function cd(e){const n=e.dataSource.trim(),s=e.importPath.trim(),i=e.inviteEmails.split(",").map(u=>u.trim()).filter(Boolean).filter(u=>!ld.test(u)),d=n?null:"Select a data source.",c=s?null:"Import path is required.",p=i.length?`Invalid invite email(s): ${i.join(", ")}`:null;return{dataSourceError:d,importPathError:c,inviteEmailsError:p,isValid:!d&&!c&&!p}}function dd(e,n){const s=n.updatedAt??Date.now(),r={...n,updatedAt:s},i=e.findIndex(c=>c.id===r.id);if(i===-1)return[r,...e].slice(0,12);const d=[...e];return d[i]={...d[i],...r},d.sort((c,p)=>p.updatedAt-c.updatedAt),d.slice(0,12)}function ud(e){try{const n=JSON.parse(e.getItem(Zr)??"[]");return Array.isArray(n)?n.filter(s=>{if(!s||typeof s!="object")return!1;const r=s;return typeof r.name=="string"&&typeof r.at=="string"&&typeof r.metadata=="object"}).slice(-250):[]}catch{return[]}}function pd(e,n){const r=[...ud(e),n].slice(-250);return e.setItem(Zr,JSON.stringify(r)),r}function md(e){var n,s;return{capturedAt:new Date().toISOString(),app:"agent-director",mode:e.mode,traceId:((n=e.trace)==null?void 0:n.id)??null,traceStatus:((s=e.trace)==null?void 0:s.status)??null,stepCount:e.stepCount,selectedStepId:e.selectedStepId,workspaceId:e.workspaceId,workspaceRole:e.workspaceRole,safeExport:e.safeExport,timeToFirstSuccessMs:e.timeToFirstSuccessMs??null,userAgent:typeof navigator<"u"?navigator.userAgent:"unknown",online:typeof navigator<"u"?navigator.onLine:!0,recentNotifications:e.notifications.slice(-6),asyncActions:e.actions.slice(0,8),stuckSignals:(e.stuckSignals??[]).slice(0,6)}}function hd(e){try{const n=JSON.parse(e.getItem(ei)??"{}");if(!n||typeof n!="object")return{...qn};const s=n;return{setupWizardV1:s.setupWizardV1!==!1,supportPanelV1:s.supportPanelV1!==!1,exportCenterV1:s.exportCenterV1!==!1,ownershipPanelV1:s.ownershipPanelV1!==!1}}catch{return{...qn}}}function fd(e,n){e.setItem(ei,JSON.stringify(n))}function Ar(e,n,s){return e.filter(r=>n-r<=s)}function yd(e,n=4){return e.length>=n}function bd(e,n){return Math.max(0,n-e)}const Dr=220,$r=120,zn="agentDirector.presence.v1",gd=2e4,xd=5e3,At="agentDirector.collab.cursors.v1",Rn="agentDirector.collab.annotations.v1",On="agentDirector.collab.activity.v1",vd=6e3,wd=1600,kd=4,jd=2e4,Sd=12e4,Nd=3,Cd={journey:{title:"Understand this run",description:"Track progression and save the exact view you need to return to quickly."},analysis:{title:"Diagnose root cause",description:"Run exports and async diagnostics to isolate what changed and why."},collaboration:{title:"Coordinate responders",description:"Set ownership, create handoffs, and keep the team aligned in real time."},operations:{title:"Configure workspace",description:"Manage setup, support access, and release-safe feature controls."}},Md={cinema:"Timeline playback",flow:"Flow graph",compare:"Compare runs",matrix:"Scenario matrix",gameplay:"Gameplay command"},Rr=[{id:"personal",label:"Personal"},{id:"operations",label:"Operations"},{id:"executive",label:"Executive"}],Ed=l.lazy(()=>Qe(()=>import("./index-DV4ABu7r.js"),__vite__mapDeps([0,1,2,3]))),Id=l.lazy(()=>Qe(()=>import("./index-B64owC2L.js"),__vite__mapDeps([4,1,2,3]))),_d=l.lazy(()=>Qe(()=>import("./index-CE2CPFBw.js"),__vite__mapDeps([5,1,2,3]))),Td=l.lazy(()=>Qe(()=>import("./index-Cmv7wfhp.js"),__vite__mapDeps([6,1,2,3]))),Ad=l.lazy(()=>Qe(()=>import("./index-KpyKW-ng.js"),__vite__mapDeps([7,1,2,3])));function Ma(){return`scenario-${Math.random().toString(36).slice(2,9)}`}function Dd(e){return e.filter(n=>n.parentStepId).map(n=>({source:n.parentStepId,target:n.id}))}function $d(e){const n=[...e].sort((s,r)=>s.index-r.index);return n.slice(1).map((s,r)=>({source:n[r].id,target:s.id}))}function Rd(e){const n={},s=e.getBoundingClientRect();return e.querySelectorAll(".step-card").forEach(i=>{const d=i.dataset.stepId;if(!d)return;const c=i.getBoundingClientRect();n[d]={left:c.left-s.left,top:c.top-s.top,width:c.width,height:c.height}}),n}function Od(e,n,s){const r=[...Dd(e),...$d(e),...Lc(e).map(k=>({source:k.source,target:k.target}))],i=Rc(e,r,s),d=n.getBoundingClientRect(),c=Math.min(...i.map(k=>k.position.x)),p=Math.min(...i.map(k=>k.position.y)),u=Math.max(...i.map(k=>k.position.x)),h=Math.max(...i.map(k=>k.position.y)),f=u-c+Dr,y=h-p+$r,w=Math.max(32,(d.width-f)/2),x=Math.max(24,(d.height-y)/2);return i.reduce((k,b)=>(k[b.id]={left:b.position.x-c+w,top:b.position.y-p+x,width:Dr,height:$r},k),{})}function Or(e,n,s){const r=n.trim().toLowerCase();return e.filter(i=>{var c,p,u;return s!=="all"&&i.type!==s?!1:r?[i.name,(c=i.preview)==null?void 0:c.title,(p=i.preview)==null?void 0:p.outputPreview,(u=i.preview)==null?void 0:u.inputPreview].filter(Boolean).join(" ").toLowerCase().includes(r):!0})}function Pd(e,n,s){var h,f,y,w,x,k,b,j,C,D,V,T,R,W,q,L,H,re,S,_,$,B,E,K,he,Y,te,Ce,we,ve;const r=e.profiles[n]??e.profiles[((h=e.players[0])==null?void 0:h.player_id)??""]??Object.values(e.profiles)[0],i=e.players.reduce((v,X)=>(v[X.player_id]=X.role,v),{}),d=Object.entries(e.narrative.nodes).map(([v,X])=>({id:v,title:X.title,body:X.title,choices:X.choices.map(ae=>({id:ae.id,label:ae.id,nextNodeId:ae.next,tensionDelta:ae.tension,mutator:ae.modifier}))})),c=e.pvp.winner??null,u=e.telemetry.failures>0?"failure":c?"success":"mixed";return{seed:e.seed,raid:{party:e.players.map(v=>v.player_id),roles:i,objectives:e.raid.objectives.map(v=>({id:v.id,label:v.label,progress:v.progress,target:v.target,completed:v.completed})),completed:e.raid.completed},campaign:{depth:e.campaign.depth,lives:e.campaign.lives,currentMission:{id:e.campaign.current_mission.id,title:e.campaign.current_mission.title,difficulty:e.campaign.current_mission.difficulty,hazards:e.campaign.current_mission.hazards,rewardCredits:e.campaign.current_mission.reward_tokens,missionSeed:e.campaign.current_mission.mission_seed??s.campaign.currentMission.missionSeed??e.seed,blueprint:e.campaign.current_mission.blueprint??s.campaign.currentMission.blueprint??`seed=${e.seed};depth=${e.campaign.depth}`,templateId:e.campaign.current_mission.template_id??s.campaign.currentMission.templateId,archetype:e.campaign.current_mission.archetype??s.campaign.currentMission.archetype,qualityScore:e.campaign.current_mission.quality_score??s.campaign.currentMission.qualityScore,noveltyScore:e.campaign.current_mission.novelty_score??s.campaign.currentMission.noveltyScore,repetitionPenalty:e.campaign.current_mission.repetition_penalty??s.campaign.currentMission.repetitionPenalty,launchPackSize:e.campaign.current_mission.launch_pack_size??s.campaign.currentMission.launchPackSize},completedMissionIds:e.campaign.completed_missions,missionHistory:((f=e.campaign.mission_history)==null?void 0:f.map(v=>({missionId:v.mission_id,templateId:v.template_id??"legacy-template",archetype:v.archetype??"legacy",hazards:v.hazards??[],qualityScore:v.quality_score??50,noveltyScore:v.novelty_score??50,repetitionPenalty:v.repetition_penalty??0,outcome:v.outcome==="success"||v.outcome==="failure"?v.outcome:"unknown"})))??s.campaign.missionHistory,mutators:[...e.campaign.modifiers,...e.campaign.unlocked_modifiers]},narrative:{currentNodeId:e.narrative.current_node_id,nodes:d.length>0?d:s.narrative.nodes,history:e.narrative.history.map(v=>({nodeId:v.node_id,choiceId:v.choice_id})),tension:e.narrative.tension},skills:{points:(r==null?void 0:r.skill_points)??s.skills.points,nodes:s.skills.nodes.map(v=>({...v,unlocked:!!(r!=null&&r.unlocked_skills.includes(v.id))})),loadout:{capacity:(r==null?void 0:r.loadout_capacity)??s.skills.loadout.capacity,equipped:(r==null?void 0:r.loadout)??[],slotCaps:s.skills.loadout.slotCaps}},pvp:{round:e.pvp.round,stability:e.pvp.operator_stability,sabotage:e.pvp.sabotage_pressure,fog:e.pvp.fog,winner:c},time:{activeForkId:e.time.active_fork_id,forks:e.time.forks.map(v=>({id:v.id,label:v.label,playheadMs:v.playhead_ms,history:v.history}))},boss:{name:e.boss.name,phase:e.boss.phase,hp:e.boss.hp,maxHp:e.boss.max_hp,enraged:e.boss.enraged,phaseMechanic:e.boss.phase_mechanic??(e.boss.phase===1?"Phase 1: Shield lattice destabilization":e.boss.phase===2?"Phase 2: Mirror clones absorb exploit damage":"Phase 3: Enrage pulse; shield counters become lethal"),vulnerability:e.boss.vulnerability==="strike"||e.boss.vulnerability==="shield"||e.boss.vulnerability==="exploit"?e.boss.vulnerability:e.boss.phase===1?"exploit":e.boss.phase===2?"strike":"shield"},director:{risk:e.director.risk,hint:e.director.hint,recommendedModifier:e.director.hazard_bias,lastOutcome:u},economy:{credits:e.economy.tokens,materials:e.economy.materials,crafted:e.economy.crafted,reserveTarget:((y=e.economy.policy)==null?void 0:y.target_reserve)??s.economy.reserveTarget??320,inflationIndex:e.economy.inflation_index??Number((e.economy.tokens/(((w=e.economy.policy)==null?void 0:w.target_reserve)??s.economy.reserveTarget??320)).toFixed(3))},rewards:{dailyClaimedOn:((x=e.rewards)==null?void 0:x.daily_claimed_date)??((k=s.rewards)==null?void 0:k.dailyClaimedOn)??null,streakDays:((b=e.rewards)==null?void 0:b.streak_days)??((j=s.rewards)==null?void 0:j.streakDays)??0,sessionClaimed:((C=e.rewards)==null?void 0:C.session_claimed)??((D=s.rewards)==null?void 0:D.sessionClaimed)??!1,streakClaimedFor:((V=e.rewards)==null?void 0:V.streak_claimed_for)??((T=s.rewards)==null?void 0:T.streakClaimedFor)??0,masteryClaims:((R=e.rewards)==null?void 0:R.mastery_claims)??((W=s.rewards)==null?void 0:W.masteryClaims)??[],history:((L=(q=e.rewards)==null?void 0:q.history)==null?void 0:L.map(v=>({id:v.id,kind:v.kind==="daily"||v.kind==="session"||v.kind==="streak"||v.kind==="mastery"?v.kind:"daily",amount:v.amount,at:Date.parse(v.at)||Date.now(),details:v.details?Object.fromEntries(Object.entries(v.details).map(([X,ae])=>[X,String(ae)])):{}})))??((H=s.rewards)==null?void 0:H.history)??[]},guild:{name:e.guild.guild_id??"Trace Guild",members:e.players.length,operationsScore:e.guild.operations_score,eventsCompleted:e.guild.events_completed},cinematic:{queue:e.cinematic.events.map(v=>({id:v.id,type:v.type==="critical"||v.type==="success"||v.type==="warning"||v.type==="twist"?v.type:"warning",message:v.message,intensity:v.intensity||1,at:Date.parse(v.at)||Date.now()}))},liveops:{season:e.liveops.season,week:e.liveops.week,challenge:{id:e.liveops.challenge.id,title:e.liveops.challenge.title,goal:e.liveops.challenge.goal,progress:e.liveops.challenge.progress,rewardCredits:e.liveops.challenge.reward,completed:e.liveops.challenge.completed},difficultyFactor:e.liveops.telemetry.difficultyFactor??s.liveops.difficultyFactor??1,rewardMultiplier:e.liveops.telemetry.rewardMultiplier??s.liveops.rewardMultiplier??1,tuningHistory:((re=e.liveops.tuning_history)==null?void 0:re.map(v=>({id:v.id,changedAt:Date.parse(v.changed_at)||Date.now(),difficultyFactor:v.difficultyFactor,rewardMultiplier:v.rewardMultiplier,note:v.note})))??s.liveops.tuningHistory??[]},teamComms:{pings:((_=(S=e.team_comms)==null?void 0:S.pings)==null?void 0:_.map(v=>({id:v.id,fromPlayerId:v.from_player_id,intent:v.intent==="focus"||v.intent==="assist"||v.intent==="defend"||v.intent==="rotate"?v.intent:"focus",targetObjectiveId:v.target_objective_id??null,createdAt:Date.parse(v.created_at)||Date.now()})))??s.teamComms.pings??[]},safety:{mutedPlayerIds:(($=e.safety)==null?void 0:$.muted_player_ids)??s.safety.mutedPlayerIds??[],blockedPlayerIds:((B=e.safety)==null?void 0:B.blocked_player_ids)??s.safety.blockedPlayerIds??[],reports:((K=(E=e.safety)==null?void 0:E.reports)==null?void 0:K.map(v=>({id:v.id,targetPlayerId:v.target_player_id,reason:v.reason,createdAt:Date.parse(v.created_at)||Date.now()})))??s.safety.reports??[]},outcome:e.status==="completed"?{status:e.telemetry.successes>=e.telemetry.failures?"win":"loss",reason:e.telemetry.successes>=e.telemetry.failures?"Session completed with positive outcomes.":"Session completed with unresolved failures.",updatedAt:Date.now()}:e.telemetry.failures>0?{status:"partial",reason:`${e.telemetry.failures} failure signals observed; run still active.`,updatedAt:Date.now()}:s.outcome??{status:"in_progress",reason:"Run in progress.",updatedAt:Date.now()},sandbox:{enabled:((he=e.sandbox)==null?void 0:he.enabled)??((Y=s.sandbox)==null?void 0:Y.enabled)??!1},progression:{xp:(r==null?void 0:r.xp)??((te=s.progression)==null?void 0:te.xp)??0,level:(r==null?void 0:r.level)??((Ce=s.progression)==null?void 0:Ce.level)??1,nextLevelXp:((r==null?void 0:r.level)??((we=s.progression)==null?void 0:we.level)??1)*200,milestones:(r==null?void 0:r.milestones)??((ve=s.progression)==null?void 0:ve.milestones)??[]}}}function Ld(){const e=window.sessionStorage.getItem("agentDirector.sessionId");if(e)return e;const n=`session-${Math.random().toString(36).slice(2,10)}`;return window.sessionStorage.setItem("agentDirector.sessionId",n),n}function Pr(){try{const e=window.localStorage.getItem(zn);if(!e)return{};const n=JSON.parse(e),s={};return Object.entries(n).forEach(([r,i])=>{typeof i=="number"&&(s[r]=i)}),s}catch{return{}}}function Lr(e,n=Date.now()){return Object.fromEntries(Object.entries(e).filter(([,s])=>n-s<gd))}function Fd(){var Ks,Qs,Ys,Xs;const{trace:e,insights:n,loading:s,error:r,reload:i,traces:d,selectedTraceId:c,setSelectedTraceId:p}=Dc(),[u,h]=U("agentDirector.mode","cinema"),[f,y]=U("agentDirector.workspaceSection.v1","journey"),[w,x]=l.useState(!1),[k,b]=U("agentDirector.workspacePanelOpen.v1",!1),[j,C]=l.useState(""),D=l.useDeferredValue(j),[V,T]=l.useState("all"),[R,W]=l.useState(""),[q,L]=l.useState(null),[H,re]=l.useState(null),[S,_]=U("agentDirector.toolbarAdvanced.v1",!1),[$,B]=l.useState(null),[E,K]=l.useState([]),[he,Y]=l.useState(""),[te,Ce]=l.useState(null),[we,ve]=l.useState(!1),[v,X]=l.useState(null),[ae,I]=U("agentDirector.safeExport",!1),[ue,Ge]=U("agentDirector.syncPlayback",!0),[z,xt]=l.useState(null),[_e,fe]=l.useState(!1),[M,J]=l.useState(0),[ge,ke]=U("agentDirector.speed",1),[$e,Oe]=U("agentDirector.windowed",!1),[Aa,Da]=l.useState(2e4),[ti,Xe]=l.useState(!1),[$a,Be]=l.useState(!1),[$t,Te]=U("agentDirector.overlayEnabled",!1),[ai,ni]=U("agentDirector.onboarded",!1),[,vt]=U("agentDirector.tourCompleted",!1),[Pe,Me]=U("agentDirector.explainMode",!0),[Ra,Oa]=U("agentDirector.heroDismissed",!1),[si,Pa]=U("agentDirector.dockOpen",!1),[je,ri]=U("agentDirector.introPersona","builder"),[La,Fa]=U("agentDirector.launchPath","rapid_triage"),[Rt,Vn]=U("agentDirector.themeMode","studio"),[ta,Jn]=U("agentDirector.motionMode","balanced"),[qa,ii]=U("agentDirector.densityMode.v1","auto"),[oi,li]=l.useState(typeof window>"u"?1280:window.innerWidth),[aa,ci]=U("agentDirector.workspaceId.v1",Rr[0].id),[Ot,di]=U("agentDirector.workspaceRole.v1","operator"),[Kn,Qn]=U("agentDirector.sessionExpiresAt.v1",Date.now()+1e3*60*60*4),[ye,Yn]=U("agentDirector.timelineLaneStrategy","type"),[Xn,wt]=U("agentDirector.timelineStudioConfig",Yt),[na,Se]=U("agentDirector.missions",{playback:!1,flow:!1,inspect:!1,matrix:!1,replay:!1,annotate:!1,collaborate:!1}),sa=!1,[kt,ra]=U("agentDirector.introDismissed",sa),[za,Ze]=l.useState(!1),[et,Ga]=l.useState("source"),[tt,Ba]=U("agentDirector.setupWizardDraft.v1",{dataSource:"",importPath:"",inviteEmails:""}),[Zn,es]=U("agentDirector.setupWizardComplete.v1",!1),[ts,as]=U("agentDirector.setupWizardPrompted.v1",!1),[Wa,xe]=l.useState(!1),[ie,ia]=l.useState(null),[oa,Ha]=l.useState([]),[Ua,Va]=l.useState(null),[ui,ns]=l.useState(null),[Ja,Ka]=l.useState(""),[Qa,ct]=l.useState([{id:Ma(),name:"Prompt tighter",strategy:"hybrid",modificationsText:'{"prompt":"Return concise response"}'},{id:Ma(),name:"Recorded baseline",strategy:"recorded",modificationsText:"{}"}]),[at,Ya]=l.useState(null),[Ee,ss]=l.useState(null),[pi,la]=l.useState(!1),[ca,Pt]=l.useState(null),[oe,Lt]=U("agentDirector.gameplayState.v1",Mr("bootstrap")),[me,rs]=U("agentDirector.gameplayTraceId.v1",""),[Ae]=U("agentDirector.gameplayPlayerId.v1",`player-${Math.random().toString(36).slice(2,8)}`),[Ie,nt]=U("agentDirector.gameplaySessionId.v1",""),[pe,Le]=l.useState(null),[da,ne]=l.useState(null),[mi,jt]=l.useState(null),[hi,ua]=l.useState(null),[is,fi]=U("agentDirector.locale.v1","en"),[os,ls]=U("agentDirector.gameplayLocale.v1","en"),[pa,cs]=U("agentDirector.gamepad.enabled.v1",!0),[Xa,yi]=U("agentDirector.gamepad.preset.v1","standard"),[ma,ha]=U("agentDirector.shortcuts.bindings.v1",gl),[bi,ds]=l.useState(typeof navigator>"u"?!0:navigator.onLine),[gi,us]=l.useState(null),[xi,ps]=l.useState(null),[Za,ms]=l.useState(1),[fa,en]=l.useState(null),[St,tn]=l.useState(null),[Fe,an]=l.useState([]),[vi,hs]=l.useState(""),[Nt,wi]=l.useState([]),[fs,nn]=l.useState([]),[qe,ya]=U("agentDirector.savedViews.v1",[]),[dt,ys]=l.useState(""),[He,ba]=l.useState(""),[sn,bs]=l.useState(!1),[Ft,gs]=l.useState(""),[st,ki]=l.useState(null),[ze,ji]=l.useState([]),[qt,Si]=U("agentDirector.runOwner.v1","on-call-operator"),[zt,Ni]=U("agentDirector.handoffOwner.v1",""),[de,xs]=l.useState(qn),[ga,rn]=l.useState(null),[Gt,on]=l.useState(null),[vs,ln]=l.useState({}),[ws,cn]=l.useState([]);l.useEffect(()=>{const a=()=>li(window.innerWidth);return a(),window.addEventListener("resize",a),()=>window.removeEventListener("resize",a)},[]);const[dn,un]=l.useState([]),[Bt,pn]=l.useState(800),[Ci,Mi]=l.useState(0),mn=l.useRef(null),ks=l.useRef(null),js=l.useRef(null),Ct=l.useRef(Ld()),Ss=l.useRef(0),Ns=l.useRef(null),Cs=l.useRef({}),Ms=l.useRef(0),hn=l.useRef(!1),Es=l.useRef({}),xa=l.useRef({}),Ei=l.useRef(Date.now()),Is=l.useRef(!1),_s=l.useRef({}),Ts=l.useRef([]),As=l.useRef({}),Ds=l.useRef({}),$s=l.useRef({}),Rs=l.useRef({}),fn=l.useRef({}),Os=l.useRef({}),Ps=l.useRef(""),Ii=l.useRef(_r(typeof window>"u"?"":window.location.search)),yn=l.useRef(!1),ut=l.useMemo(()=>Pn(ma),[ma]),bn=l.useMemo(()=>Ir(is),[is]),Z=l.useCallback(a=>nd(bn,a),[bn]),Ue=l.useMemo(()=>{if(!e)return[];const a=performance.now(),o=Or(e.steps,D,V);return Ms.current=performance.now()-a,o},[e,D,V]),gn=l.useMemo(()=>Ue.slice(0,Math.min(Ue.length,Bt)),[Bt,Ue]),Ls=l.useMemo(()=>{if(!q)return gn;const a=new Set(q.matchedStepIds);return gn.filter(o=>a.has(o.id))},[gn,q]),_i=l.useMemo(()=>z?Or(z.steps,D,V).slice(0,Math.min(z.steps.length,Bt)):[],[z,D,V,Bt]),Fs=l.useMemo(()=>e?Fc(e.startedAt,e.endedAt,e.steps):[],[e]),Ti=l.useMemo(()=>!e||!z?null:Wr(e,z),[e,z]),qs=l.useMemo(()=>e?e.steps.find(a=>a.id===v)??null:null,[e,v]),pt=l.useMemo(()=>id(f,u,!!z),[f,u,z]),Wt=l.useMemo(()=>od((e==null?void 0:e.steps)??[],v),[e==null?void 0:e.steps,v]),xn=l.useMemo(()=>Wt.join("|"),[Wt]),Ht=l.useMemo(()=>e?nl(e.steps,ye):[],[e,ye]),Mt=l.useMemo(()=>{const a=Xn[ye]??Yt[ye];return ar(Ht,a.order,a.hidden)},[Ht,ye,Xn]),Ai=l.useMemo(()=>Mt.order.filter(a=>!Mt.hidden.includes(a)),[Mt.hidden,Mt.order]),va=l.useMemo(()=>{const a=Ct.current;return Object.values(vs).filter(o=>o.sessionId!==a).filter(o=>o.traceId===((e==null?void 0:e.id)??"none")).sort((o,m)=>m.updatedAt-o.updatedAt)},[vs,e==null?void 0:e.id]),Di=l.useMemo(()=>va.map(a=>a.playheadMs),[va]),$i=l.useMemo(()=>ws.filter(a=>a.traceId===(e==null?void 0:e.id)),[ws,e==null?void 0:e.id]),zs=l.useMemo(()=>{const a=Object.keys(na).length,o=Object.values(na).filter(Boolean).length;return{done:o,total:a,pct:a>0?Math.round(o/a*100):0}},[na]),Ut=l.useMemo(()=>{var A;if(!e)return 100;const a=100,o=Math.min(60,((n==null?void 0:n.errors)??0)*16),m=Math.min(24,((n==null?void 0:n.retries)??0)*6),g=e.metadata.wallTimeMs>6e4?12:e.metadata.wallTimeMs>3e4?6:0,N=(A=n==null?void 0:n.timing)!=null&&A.degraded?8:0;return Math.max(0,Math.min(100,Math.round(a-o-m-g-N)))},[n==null?void 0:n.errors,n==null?void 0:n.retries,(Ks=n==null?void 0:n.timing)==null?void 0:Ks.degraded,e]),Ri=l.useMemo(()=>u==="flow"?"F / C / Space":u==="compare"?"C / Space / ← →":u==="matrix"?"G / C / Cmd+K":u==="gameplay"?"G / S / Cmd+K":"C / F / Space",[u]),mt=l.useMemo(()=>{const a=Kn-Date.now(),o=Math.max(0,Math.ceil(a/6e4));return{expired:a<=0,remainingMinutes:o,label:a<=0?"Expired":`${o}m left`}},[Kn]),Ve=l.useMemo(()=>cd(tt),[tt]),ht=l.useMemo(()=>dt.trim()?qe.some(o=>o.name.toLowerCase()===dt.trim().toLowerCase())?"Saved view name already exists.":null:"Saved view name is required.",[dt,qe]),wa=l.useMemo(()=>md({trace:e,selectedStepId:v,mode:u,workspaceId:aa,workspaceRole:Ot,safeExport:ae,notifications:Fe.map(a=>({message:a.message,level:a.level})),actions:Nt,stepCount:(e==null?void 0:e.steps.length)??0,timeToFirstSuccessMs:st,stuckSignals:ze.map(a=>({kind:a.kind,detail:a.detail,at:a.at}))}),[Nt,u,Fe,ae,v,ze,st,e,aa,Ot]),Q=l.useCallback((a,o="info")=>{const m=a.trim();if(!m)return;const g=Date.now();an(N=>N.some(G=>G.message===m&&G.level===o)?N:[...N,{id:`notif-${g}-${Math.random().toString(36).slice(2,8)}`,message:m,level:o,expiresAt:g+vd}].slice(-6))},[]),P=l.useCallback((a,o={})=>{try{pd(window.localStorage,{name:a,at:new Date().toISOString(),metadata:o})}catch{}},[]),ka=l.useCallback((a,o,m={})=>{const g=Date.now(),N=`${a}:${String(m.target??"global")}`,A=As.current[N]??0;g-A<jd||(As.current[N]=g,ji(G=>[{id:`stuck-${g}-${Math.random().toString(36).slice(2,8)}`,kind:a,detail:o,at:g},...G].slice(0,8)),Q("Looks like you might be stuck. Use Need help now for guided recovery.","warning"),P("ux.error.window",{signal:a,detail:o,...m}))},[Q,P]);l.useEffect(()=>{const a=o=>{const m=o.target instanceof HTMLElement?o.target:null;if(!m)return;const g=m.closest('button, a, [role="button"]');if(!g)return;const A=(g.getAttribute("aria-label")??g.getAttribute("data-help-title")??g.textContent??"").trim().replace(/\s+/g," ").slice(0,60).toLowerCase();if(!A)return;const G=Date.now(),O=`click:${A}`,ce=_s.current[O]??[],be=[...Ar(ce,G,wd),G];_s.current[O]=be,yd(be,kd)&&ka("rage_click",`Rapid repeated clicks on "${A}".`,{target:A,count:be.length})};return window.addEventListener("click",a,!0),()=>window.removeEventListener("click",a,!0)},[ka]),l.useEffect(()=>{const a=Fe[Fe.length-1];if(!a)return;const o=Date.now();if(!Is.current&&a.level==="success"){const m=bd(Ei.current,o);Is.current=!0,ki(m),P("ux.action.confirmed",{source:"time_to_first_success",elapsedMs:m,message:a.message})}if(a.level==="error"){const m=[...Ar(Ts.current,o,Sd),o];Ts.current=m,m.length>=Nd&&ka("dead_end_actions","Multiple error outcomes detected in a short period.",{count:m.length})}},[Fe,ka,P]);const Et=l.useCallback(a=>{wi(o=>dd(o,a))},[]),Vt=l.useCallback(async a=>{Rs.current[a.id]=()=>{Vt(a)},nn(o=>{const m=o.find(N=>N.id===a.id),g={id:a.id,label:a.label,status:"running",detail:"Running",updatedAt:Date.now(),retryable:!1};return m?[g,...o.filter(N=>N.id!==a.id)].slice(0,8):[g,...o].slice(0,8)}),P("ux.export.queued",{taskId:a.id,label:a.label});try{a.run(),nn(o=>o.map(m=>m.id===a.id?{...m,status:"success",detail:"Completed",updatedAt:Date.now(),retryable:!1}:m)),P("ux.export.completed",{taskId:a.id,label:a.label})}catch(o){const m=o instanceof Error?o.message:"Export failed";nn(g=>g.map(N=>N.id===a.id?{...N,status:"error",detail:m,updatedAt:Date.now(),retryable:!0}:N)),Q(`Export failed: ${a.label}`,"error"),P("ux.export.failed",{taskId:a.id,label:a.label,detail:m})}},[Q,P]),rt=l.useCallback((a,o,m)=>{const g=`confirm-${Math.random().toString(36).slice(2,9)}`;fn.current[g]=m,rn({id:g,title:a,message:o})},[]),Gs=l.useCallback((a,o)=>{const m=`undo-${Math.random().toString(36).slice(2,9)}`;Os.current[m]=o,on({id:m,label:a})},[]),Bs=Ot!=="viewer"&&!mt.expired,le=l.useCallback(a=>Bs?!0:(mt.expired?Q(`Session expired. Renew session to ${a}.`,"warning"):Q(`Viewer role cannot ${a}. Switch role to operator or admin.`,"warning"),!1),[Q,Bs,mt.expired]),Oi=l.useCallback(a=>{an(o=>o.filter(m=>m.id!==a))},[]),Pi=l.useCallback(()=>{Qn(Date.now()+1e3*60*60*4),Q("Session renewed for 4 hours.","success")},[Q,Qn]);l.useEffect(()=>{xs(hd(window.localStorage))},[]),l.useEffect(()=>{de.setupWizardV1&&window.localStorage.getItem("agentDirector.setupWizardAuto")==="1"&&(!kt||Zn||za||ts||(Ze(!0),as(!0),P("ux.setup.opened",{source:"auto"})))},[de.setupWizardV1,kt,as,Zn,za,ts,P]),l.useEffect(()=>{if(!Gt)return;const a=window.setTimeout(()=>{on(null)},6e3);return()=>window.clearTimeout(a)},[Gt]),l.useEffect(()=>{const a=m=>{P("ux.error.window",{message:m.message,filename:m.filename,line:m.lineno})},o=m=>{const g=m.reason instanceof Error?m.reason.message:String(m.reason??"unknown");P("ux.error.window",{kind:"unhandledrejection",reason:g})};return window.addEventListener("error",a),window.addEventListener("unhandledrejection",o),()=>{window.removeEventListener("error",a),window.removeEventListener("unhandledrejection",o)}},[P]),l.useEffect(()=>{if(yn.current)return;const a=Ii.current;if(!a.mode&&!a.traceId&&!a.stepId){yn.current=!0;return}if(a.mode&&a.mode!==u&&h(a.mode),a.traceId){if(!d.some(m=>m.id===a.traceId))return;if(c!==a.traceId){p(a.traceId);return}}a.stepId&&(e!=null&&e.steps.some(o=>o.id===a.stepId))&&v!==a.stepId&&X(a.stepId),yn.current=!0},[u,v,c,h,p,e==null?void 0:e.steps,d]),l.useEffect(()=>{if(typeof window>"u")return;const a=rd(window.location.href,{mode:u,traceId:c??void 0,stepId:v??void 0});a!==window.location.href&&window.history.replaceState(null,"",a)},[u,v,c]),l.useEffect(()=>{if(!Fe.length)return;const a=window.setInterval(()=>{const o=Date.now();an(m=>m.filter(g=>g.expiresAt>o))},1e3);return()=>{window.clearInterval(a)}},[Fe.length]),l.useEffect(()=>{if(!w)return;const a=m=>{var g;(g=ks.current)!=null&&g.contains(m.target)||x(!1)},o=m=>{m.key==="Escape"&&x(!1)};return window.addEventListener("mousedown",a),window.addEventListener("keydown",o),()=>{window.removeEventListener("mousedown",a),window.removeEventListener("keydown",o)}},[w]),l.useEffect(()=>{x(!1)},[f,u]),l.useEffect(()=>{const a=Fe[Fe.length-1];a&&a.id!==Ns.current&&(Ns.current=a.id,hs(a.message))},[Fe]),l.useEffect(()=>{var N;const a=Nt[0];if(!a||Cs.current[a.id]===a.status)return;Cs.current[a.id]=a.status;const m=(N=a.detail)==null?void 0:N.trim(),g=a.status==="running"?"running":a.status;hs(m?`${a.label}: ${g}. ${m}`:`${a.label}: ${g}.`)},[Nt]),l.useEffect(()=>{fa&&Q(fa,"success")},[Q,fa]),l.useEffect(()=>{$a&&P("ux.palette.opened",{section:f,mode:u})},[f,u,$a,P]),l.useEffect(()=>{St&&Q(St,"success")},[Q,St]),l.useEffect(()=>{ca&&Q(ca,"error")},[Q,ca]),l.useEffect(()=>{H&&Q(H,"warning")},[Q,H]),l.useEffect(()=>{da&&Q(da,"warning")},[Q,da]),l.useEffect(()=>{mt.expired&&Q("Workspace session expired. Renew to continue write actions.","warning")},[Q,mt.expired]),l.useEffect(()=>{e&&e.id!==me&&(Lt(Mr(e.id)),rs(e.id))},[me,Lt,rs,e]),l.useEffect(()=>{let a=!1;if(!Ie){Le(null);return}return An().then(o=>{a||(Le(o),o||ne("Gameplay session not found."))}),()=>{a=!0}},[Ie]),l.useEffect(()=>{if(!Ie)return;const a=Ac();return()=>a()},[Ie]),l.useEffect(()=>{pe&&Lt(a=>Pd(pe,Ae,a))},[Ae,pe,Lt]),l.useEffect(()=>{let a=!1;if(!(pe==null?void 0:pe.guild.guild_id)){jt(null);return}return Ec().then(m=>{a||jt(m)}),()=>{a=!0}},[pe==null?void 0:pe.guild.guild_id]),l.useEffect(()=>{let a=!1;return gr().then(o=>{a||o&&ua(o)}),()=>{a=!0}},[Ae,pe==null?void 0:pe.id]),l.useEffect(()=>{if(typeof window>"u")return;const a=()=>ds(!0),o=()=>ds(!1);return window.addEventListener("online",a),window.addEventListener("offline",o),()=>{window.removeEventListener("online",a),window.removeEventListener("offline",o)}},[]),l.useEffect(()=>{if(!pa){xa.current={};return}if(typeof navigator>"u"||typeof navigator.getGamepads!="function")return;const a=Xa==="lefty"?{playPause:1,palette:3,modeCycle:2,speedDown:6,speedUp:7}:{playPause:0,palette:2,modeCycle:3,speedDown:4,speedUp:5},o=["cinema","flow","compare","matrix","gameplay"];let m=0;const g=(A,G,O)=>{const ce=!!xa.current[G];A&&!ce&&O(),xa.current[G]=A},N=()=>{var G,O,ce,be,Zs;const A=navigator.getGamepads()[0];A&&(g(!!((G=A.buttons[a.playPause])!=null&&G.pressed),"playPause",()=>fe(bt=>!bt)),g(!!((O=A.buttons[a.palette])!=null&&O.pressed),"palette",()=>Be(!0)),g(!!((ce=A.buttons[a.modeCycle])!=null&&ce.pressed),"modeCycle",()=>{h(bt=>{const Oo=o.indexOf(bt);return o[(Oo+1)%o.length]})}),g(!!((be=A.buttons[a.speedDown])!=null&&be.pressed),"speedDown",()=>{ke(bt=>Math.max(.25,Number((bt-.25).toFixed(2))))}),g(!!((Zs=A.buttons[a.speedUp])!=null&&Zs.pressed),"speedUp",()=>{ke(bt=>Math.min(3,Number((bt+.25).toFixed(2))))})),m=window.requestAnimationFrame(N)};return m=window.requestAnimationFrame(N),()=>{window.cancelAnimationFrame(m),xa.current={}}},[pa,Xa,h,ke]),l.useEffect(()=>{let a=!1;const o=async()=>{const[g,N]=await Promise.all([xr(),vr()]);a||(g&&us(g),N&&ps(N))};o();const m=window.setInterval(()=>{o()},3e4);return()=>{a=!0,window.clearInterval(m)}},[]),l.useEffect(()=>{L(null),re(null)},[e==null?void 0:e.id]),l.useEffect(()=>{const a=Math.round(Ms.current);Mi(a),a>0&&P("ux.perf.filter_ms",{ms:a,steps:Ue.length})},[Ue,P]),l.useEffect(()=>{if(!e)return;const a=Ue.length;if(a<=1200){pn(a);return}pn(800);const o=window.setInterval(()=>{pn(m=>m>=a?(window.clearInterval(o),a):Math.min(a,m+1e3))},70);return()=>window.clearInterval(o)},[Ue.length,e]),l.useEffect(()=>{e&&(e.steps.length<450||$e||(Oe(!0),Da(a=>Math.min(a,15e3)),Q("Enabled windowed playback automatically for large traces.","info")))},[Q,e,$e,Oe]),l.useEffect(()=>{let a=!1;if(!(e!=null&&e.id)){B(null);return}return pc(e.id).then(o=>{a||B(o)}),()=>{a=!0}},[e==null?void 0:e.id]),l.useEffect(()=>{let a=!1;return mc().then(o=>{a||(K(o),!he&&o.length>0&&Y(o[0].id))}),()=>{a=!0}},[he]),l.useEffect(()=>{js.current=z},[z]),l.useEffect(()=>(document.body.dataset.theme=Rt,()=>{delete document.body.dataset.theme}),[Rt]),l.useEffect(()=>(document.body.dataset.motion=ta,()=>{delete document.body.dataset.motion}),[ta]),l.useEffect(()=>{const a=Ct.current,o=(O=!1)=>{const ce=Date.now(),be=Lr(Pr(),ce);O?delete be[a]:be[a]=ce,window.localStorage.setItem(zn,JSON.stringify(be)),ms(Math.max(1,Object.keys(be).length))},m=()=>{const O=Lr(Pr(),Date.now());ms(Math.max(1,Object.keys(O).length))};o();const g=window.setInterval(()=>o(),xd),N=O=>{O.key===zn&&m()},A=()=>{document.visibilityState==="visible"&&o()},G=()=>o(!0);return window.addEventListener("storage",N),document.addEventListener("visibilitychange",A),window.addEventListener("beforeunload",G),()=>{window.clearInterval(g),o(!0),window.removeEventListener("storage",N),document.removeEventListener("visibilitychange",A),window.removeEventListener("beforeunload",G)}},[]),l.useEffect(()=>{u==="compare"&&Pa(!1)},[u,Pa]),l.useEffect(()=>{Ht.length!==0&&wt(a=>{const o=a[ye]??Yt[ye],m=ar(Ht,o.order,o.hidden);return m.order.join("|")===o.order.join("|")&&m.hidden.join("|")===o.hidden.join("|")?a:{...a,[ye]:m}})},[Ht,ye,wt]),l.useEffect(()=>{ln(lt(window.localStorage.getItem(At),{})),cn(lt(window.localStorage.getItem(Rn),[])),un(lt(window.localStorage.getItem(On),[]))},[]),l.useEffect(()=>{const a=Date.now();if(a-Ss.current<120&&_e)return;Ss.current=a;const o=Ct.current,m={sessionId:o,traceId:(e==null?void 0:e.id)??"none",mode:u,playheadMs:Math.round(M),selectedStepId:v,updatedAt:a},N={...lt(window.localStorage.getItem(At),{}),[o]:m};window.localStorage.setItem(At,JSON.stringify(N)),ln(N)},[_e,u,M,v,e==null?void 0:e.id]),l.useEffect(()=>{const a=Ct.current;return()=>{const o=lt(window.localStorage.getItem(At),{});if(!o[a])return;const m={...o};delete m[a],window.localStorage.setItem(At,JSON.stringify(m))}},[]),l.useEffect(()=>{const a=o=>{if(o.key===At&&ln(lt(o.newValue,{})),o.key===Rn){const m=lt(o.newValue,[]);cn(g=>jr(g,m))}o.key===On&&un(Sr(lt(o.newValue,[])))};return window.addEventListener("storage",a),()=>window.removeEventListener("storage",a)},[]);const F=l.useCallback(a=>{const o={id:`activity-${Math.random().toString(36).slice(2,9)}`,sessionId:Ct.current,message:a,timestamp:Date.now()};un(m=>{const g=Sr([o,...m]);return window.localStorage.setItem(On,JSON.stringify(g)),g})},[]),Ne=l.useCallback((a,o,m)=>{Es.current[a]||(Es.current[a]=!0,Pc(o,m))},[]),it=l.useCallback(async function(o){o.retry&&(Ds.current[o.id]=o.retry),o.resume&&($s.current[o.id]=o.resume),Et({id:o.id,label:o.label,status:"running",detail:"Running",retryable:!1,resumable:!1});try{const m=await o.run();return Et({id:o.id,label:o.label,status:"success",detail:o.successDetail??"Completed",retryable:!1,resumable:!1}),m}catch(m){const g=m instanceof Error?m.message:"Action failed";throw Et({id:o.id,label:o.label,status:"error",detail:g,retryable:!!o.retry,resumable:!!o.resume}),m}},[Et]),Li=l.useCallback(a=>{const o=Ds.current[a];o&&(P("ux.action.retry",{id:a}),o())},[P]),Fi=l.useCallback(a=>{const o=$s.current[a];o&&(P("ux.action.resume",{id:a}),o())},[P]),Je=l.useCallback(async a=>{if(!e||!le("run replay"))return;const o=await fc(e.id,a,"hybrid",{note:"UI replay"},e);o&&(xt(o),Te(!0),h("flow"),Se(m=>m.replay?m:{...m,replay:!0}),F(`Created replay from ${a}`))},[F,le,Se,e,xt,h,Te]),qi=l.useCallback(async()=>{if(e){if(!R.trim()){L(null),re(null);return}try{const a=await it({id:"trace-query",label:"TraceQL query",run:async()=>uc(e.id,R.trim()),successDetail:"Query complete"});if(!a){re("TraceQL query failed"),L(null);return}L(a),re(null);const o=a.matchedStepIds[0];o&&(X(o),u!=="cinema"&&h("cinema"))}catch{re("TraceQL query failed"),L(null)}}},[it,u,h,e,R]),zi=l.useCallback(async()=>{if(!(!e||!he)){ve(!0);try{const a=await it({id:"run-extension",label:"Run extension",run:async()=>hc(he,e.id),successDetail:"Extension output ready"});if(!a)return;Ce(a.result)}finally{ve(!1)}}},[it,he,e]),Re=l.useCallback(()=>{if(!e)return;const a=[...e.steps].sort((o,m)=>(m.durationMs??0)-(o.durationMs??0))[0];a&&(X(a.id),h("cinema"))},[e,h]),Ws=l.useCallback(()=>{if(!e||e.steps.length===0)return null;const a=[...e.steps].sort((o,m)=>(m.durationMs??0)-(o.durationMs??0))[0];return(a==null?void 0:a.id)??null},[e]),ft=l.useCallback(()=>{if(!e)return;const a=e.steps.find(o=>o.status==="failed");a&&(X(a.id),h("cinema"))},[e,h]),It=l.useCallback(async()=>{if(!e)return;const a=new URL(window.location.href);a.searchParams.set("trace",c??e.id),a.searchParams.set("mode",u),v?a.searchParams.set("step",v):a.searchParams.delete("step");try{await navigator.clipboard.writeText(a.toString()),en("Live link copied")}catch{window.prompt("Copy live session link",a.toString()),en("Live link ready")}window.setTimeout(()=>en(null),1800)},[u,v,c,e]),Gi=l.useCallback(a=>{Yn(a),F(`Switched lane strategy to ${a}`)},[F,Yn]),Bi=l.useCallback(a=>{wt(o=>{const m=o[ye]??Yt[ye],g=m.hidden.includes(a)?m.hidden.filter(N=>N!==a):[...m.hidden,a];return{...o,[ye]:{...m,hidden:g}}}),F(`Toggled lane visibility for ${a}`)},[F,ye,wt]),Wi=l.useCallback(async a=>{if(!e||!le("create gameplay sessions"))return;const o=await vc({traceId:e.id,name:a.trim()||"Night Ops"});if(!o){ne("Failed to create gameplay session.");return}Le(o),nt(o.id),ne(null),F(`Created gameplay session ${o.id}`)},[F,Ae,le,nt,e]),Hi=l.useCallback(async()=>{if(!e||!le("matchmake gameplay sessions"))return;const a=await wc({traceId:e.id});if(!a){ne("Failed to matchmake gameplay session.");return}Le(a.session),nt(a.session.id),ne(null),F(`${a.match.type==="created"?"Created":"Matched"} gameplay session ${a.session.id} as ${a.match.assigned_role}`)},[F,Ae,le,nt,e]),Ui=l.useCallback(async(a,o,m)=>{if(!le("join gameplay sessions"))return;if(!a.trim()){ne("Session id is required.");return}const g=await kc({sessionId:a.trim(),playerId:o.trim()});if(!g){ne("Failed to join gameplay session.");return}Le(g),nt(g.id),ne(null),F(`Joined gameplay session ${g.id} as ${o}`)},[F,le,nt]),Vi=l.useCallback(async()=>{Ie&&le("leave gameplay sessions")&&rt("Leave gameplay session",`Leave session ${Ie}?`,()=>{(async()=>{if(!await jc()){ne("Failed to leave gameplay session.");return}Le(null),nt(""),ne(null),F(`Left gameplay session ${Ie}`),P("ux.action.confirmed",{action:"leave_gameplay_session",sessionId:Ie})})()})},[F,Ae,Ie,rt,le,nt,P]),Ji=l.useCallback(async()=>{if(!Ie)return;const a=await Sc();if(!a){ne("Failed to reconnect gameplay session.");return}Le(a),ne(null),F(`Reconnected gameplay session ${Ie}`)},[F,Ae,Ie]),Ki=l.useCallback(async(a,o)=>{if(!(pe!=null&&pe.id)||!le(`run gameplay action ${a}`))return;const m=await br({sessionId:pe.id,expectedVersion:pe.version});if(m.session){Le(m.session),ne(null),F(`Gameplay action: ${a}`);return}if(m.conflict){const g=await An(pe.id);g&&Le(g),ne("Session changed by another player. Synced latest state.");return}ne(m.error??"Gameplay action failed.")},[F,Ae,pe,le]),Qi=l.useCallback(async(a,o)=>{if(!le("create guilds"))return;if(!a.trim()||!o.trim()){ne("Guild id and name are required.");return}const m=await Mc({guildId:a.trim(),name:o.trim()});if(!m){ne("Failed to create guild.");return}if(jt(m),pe){const g=await br({sessionId:pe.id,payload:{guild_id:m.id},expectedVersion:pe.version});g.session&&Le(g.session)}ne(null),F(`Created guild ${m.id}`)},[F,Ae,pe,le]),Yi=l.useCallback(async(a,o)=>{if(!le("join guilds"))return;if(!a.trim()||!o.trim()){ne("Guild id and player id are required.");return}const m=await Ic(a.trim(),o.trim());if(!m){ne("Failed to join guild.");return}jt(m),ne(null),F(`Joined guild ${m.id} as ${o}`)},[F,le]),Xi=l.useCallback(async(a,o,m)=>{if(!le("schedule guild events"))return;if(!a.trim()||!o.trim()||!m.trim()){ne("Guild id, title, and schedule are required.");return}const g=await _c({guildId:a.trim(),title:o.trim(),scheduledAt:m.trim()});if(!g){ne("Failed to schedule guild event.");return}jt(g.guild),ne(null),F(`Scheduled guild event ${g.event.id}`)},[F,le]),Zi=l.useCallback(async(a,o,m)=>{if(!le("complete guild events"))return;const g=await Tc();if(!g){ne("Failed to complete guild event.");return}jt(g),ne(null),F(`Completed guild event ${o}`)},[F,le]),eo=l.useCallback(async a=>{if(!le("send friend invites"))return;const o=await Nc({toPlayerId:a.trim().toLowerCase()});if(!o){ne("Failed to send friend invite.");return}ua(o.social),ne(null),F(`Sent friend invite to ${a}`)},[F,Ae,le]),to=l.useCallback(async a=>{if(!le("accept friend invites"))return;const o=await Cc();if(!o){ne("Failed to accept friend invite.");return}ua(o),ne(null),F(`Accepted friend invite ${a}`)},[F,Ae,le]),Hs=l.useCallback(()=>{it({id:"retry-connectivity",label:"Retry connectivity",retry:()=>Hs(),run:async()=>{if(ne(null),i(),Ie){const g=await An();g&&Le(g)}const[a,o,m]=await Promise.all([gr(),xr(),vr()]);return a&&ua(a),o&&us(o),m&&ps(m),F("Retried connectivity sync"),!0},successDetail:"Connectivity synced"}).catch(()=>{ne("Retry connectivity failed.")})},[F,it,Ae,Ie,i]),ao=l.useCallback((a,o)=>{wt(m=>{const g=m[ye]??Yt[ye],N=[...g.order],A=N.indexOf(a);if(A===-1)return m;const G=o==="up"?A-1:A+1;if(G<0||G>=N.length)return m;const[O]=N.splice(A,1);return N.splice(G,0,O),{...m,[ye]:{...g,order:N}}}),F(`Moved lane group ${a} ${o}`)},[F,ye,wt]),no=l.useCallback(()=>{Se({playback:!1,flow:!1,inspect:!1,matrix:!1,replay:!1,annotate:!1,collaborate:!1}),F("Reset onboarding missions")},[F,Se]),so=l.useCallback((a,o)=>{if(!e||!a.trim())return;const m=Date.now(),g={id:`annotation-${Math.random().toString(36).slice(2,9)}`,traceId:e.id,stepId:o,body:a.trim(),authorSessionId:Ct.current,createdAt:m,updatedAt:m};cn(N=>{const A=jr(N,[g]);return window.localStorage.setItem(Rn,JSON.stringify(A)),A}),Se(N=>N.annotate?N:{...N,annotate:!0}),F(o?`Added annotation on step ${o}`:"Added trace annotation")},[F,Se,e]),ro=l.useCallback((a,o)=>{ct(m=>m.map(g=>g.id===a?{...g,...o}:g))},[]),io=l.useCallback(a=>{ct(a)},[]),oo=l.useCallback(()=>{ct(a=>[...a,{id:Ma(),name:`Scenario ${a.length+1}`,strategy:"hybrid",modificationsText:"{}"}])},[]),lo=l.useCallback(a=>{Qa.length<=1||rt("Remove scenario","Remove this scenario from the matrix run?",()=>{let o=null,m=-1;ct(g=>(m=g.findIndex(N=>N.id===a),m===-1||g.length<=1?g:(o=g[m]??null,g.filter(N=>N.id!==a)))),!(!o||m===-1)&&(Gs("Scenario removed",()=>{ct(g=>{const N=[...g];return N.splice(Math.min(m,N.length),0,o),N}),P("ux.action.undone",{action:"matrix_scenario_remove",scenarioId:a})}),P("ux.action.confirmed",{action:"matrix_scenario_remove",scenarioId:a}))})},[Qa.length,Gs,rt,P]),co=l.useCallback(a=>{ct(o=>{const m=o.findIndex(G=>G.id===a);if(m===-1)return o;const g=o[m],N={...g,id:Ma(),name:`${g.name} copy`},A=[...o];return A.splice(m+1,0,N),A})},[]),uo=l.useCallback((a,o)=>{ct(m=>{const g=m.findIndex(O=>O.id===a);if(g===-1)return m;const N=o==="up"?g-1:g+1;if(N<0||N>=m.length)return m;const A=[...m],[G]=A.splice(g,1);return A.splice(N,0,G),A})},[]),vn=l.useCallback(async a=>{var m;if(!e||!le("run replay matrix"))return;const o=Ja||v||((m=e.steps[0])==null?void 0:m.id);if(!o){Pt("Select an anchor step before running the matrix.");return}try{la(!0),Pt(null),await it({id:"matrix-run",label:"Replay matrix run",retry:()=>{vn(a)},resume:()=>{vn(a)},run:async()=>{const g=await yc({traceId:e.id,stepId:o,scenarios:a});if(!g)throw new Error("Failed to create replay job.");Ya(g);let N=g;for(let G=0;G<30&&!(N.status!=="queued"&&N.status!=="running");G+=1){const O=Wc(G);await new Promise(be=>window.setTimeout(be,O));const ce=await bc(g.id);if(!ce)break;N=ce,Ya(ce)}const A=await yr(g.id);if(!A)throw new Error("Replay job finished but matrix summary is unavailable.");return ss(A),h("matrix"),F(`Ran matrix with ${a.length} scenario(s) from ${o}`),A},successDetail:`${a.length} scenario(s) complete`})}catch(g){Pt(g instanceof Error?g.message:"Failed to run replay matrix.")}finally{la(!1)}},[F,it,Ja,le,v,e,h]),po=l.useCallback(async()=>{at&&le("cancel replay matrix jobs")&&rt("Cancel matrix job",`Cancel replay job ${at.id}?`,()=>{(async()=>{la(!0);try{const a=await gc(at.id);if(!a){Pt("Failed to cancel replay job.");return}Ya(a),Et({id:"matrix-run",label:"Replay matrix run",status:"canceled",detail:`Canceled ${at.id}`,resumable:!0,retryable:!0});const o=await yr(a.id);o&&ss(o),F(`Canceled matrix job ${at.id}`),P("ux.action.cancel",{id:at.id})}finally{la(!1)}})()})},[F,at,rt,le,Et,P]),mo=l.useCallback(async a=>{const o=await Hr();if(!(o!=null&&o.trace)){Pt("Could not load replay trace for compare view.");return}xt(o.trace),Te(!0),h("compare"),F(`Opened matrix compare trace ${a}`)},[F,h,Te]),ee=l.useCallback(a=>{if(!(a===u||!e)){if((a==="flow"||a==="matrix"||a==="gameplay")&&fe(!1),a==="flow"&&u==="cinema"&&mn.current){const o=mn.current,m=Rd(o),g=Od(e.steps,o,e.id);ns({steps:e.steps,fromRects:m,toRects:g}),F("Morphed cinema to flow");return}h(a),F(`Switched mode to ${a}`)}},[F,u,e,fe,h]),Jt=l.useCallback(async a=>{if(Fa(a),a==="rapid_triage"){Me(!0),ee("cinema"),ft(),e!=null&&e.steps.some(o=>o.status==="failed")||Re(),F("Started rapid triage launch path");return}if(a==="deep_diagnosis"){Me(!0),ee("flow"),xe(!0),F("Started deep diagnosis launch path");return}Ge(!0),ee("matrix"),await It(),F("Started team sync launch path")},[F,ee,Re,ft,Me,Fa,Ge,It,e]),wn=l.useCallback(()=>{u==="flow"&&ee("cinema"),fe(a=>!a)},[u,ee]),ot=l.useCallback(()=>{ia(null),Ha([]),Va(null),fe(!1)},[fe]),Us=l.useCallback(a=>[{id:"setup",label:"Opening the reel",duration:1100,action:()=>{Me(!0),fe(!1),J(0),X(null),Te(!1),ke(1),e&&e.steps.length<500&&Oe(!1),ee("cinema")}},{id:"pace",label:"Pacing the timeline",duration:2200,action:()=>{ee("cinema"),fe(!0),ke(1.1)}},{id:"bottleneck",label:"Freeze on the bottleneck",duration:1600,action:()=>{fe(!1),Re()}},{id:"inspect",label:"Inspect the moment",duration:1600,action:()=>{a&&X(a)}},{id:"flow",label:"Morph into flow",duration:2100,action:()=>{ee("flow")}},{id:"replay",label:"Director’s Cut replay",duration:2200,action:async()=>{if(!e)return;!js.current&&a&&await Je(a),Te(!0),h("compare")}},{id:"compare",label:"Compare the cut",duration:2e3,action:()=>{fe(!0),ke(1)}},{id:"finale",label:"Final frame",duration:1100,action:()=>{fe(!1)}}],[ee,Je,Re,Me,fe,h,Te,J,X,ke,Oe,e]),_t=l.useCallback(()=>{var o;if(!e)return;const a=v??Ws()??((o=e.steps[0])==null?void 0:o.id)??null;Ha(Us(a)),ia({active:!0,step:0}),Va(e.id),xe(!1),Xe(!1),Be(!1)},[Us,Ws,v,e,Be,Xe,Ha,ia,Va,xe]),Kt=l.useCallback(()=>{if(ie!=null&&ie.active){ot();return}_t()},[_t,ot,ie==null?void 0:ie.active]),ho=l.useMemo(()=>{const o=[{id:"header",title:"Mission control",body:`Confirm run status and metadata. ${{builder:"Focus on payload flow, tool-call sequencing, and replay-ready steps.",executive:"Focus on bottlenecks, risk signals, and run-level outcome changes.",operator:"Focus on failure patterns, retries, and runtime reliability posture."}[je]}`,target:'[data-tour="header"]',placement:"bottom"}];return Ra||o.push({id:"hero",title:"Director briefing",body:"Choose Tour, Story mode, or Explain to ramp up quickly.",target:'[data-tour="hero"]',placement:"bottom"}),o.push({id:"insights",title:"Fast diagnosis",body:je==="executive"?"Jump straight to bottlenecks and high-cost segments for fast executive readouts.":je==="operator"?"Jump to failures and retries first, then inspect impacted steps.":"Jump straight to bottlenecks, errors, and high-cost steps with one click.",target:'[data-tour="insights"]',placement:"bottom"},{id:"journey",title:"Director journey",body:"A narrative path that teaches how to watch, inspect, and direct a better run.",target:'[data-tour="journey"]',placement:"bottom"},{id:"toolbar",title:"Filters + modes",body:"Search, filter, and switch between Cinema, Flow, and Compare as the story evolves.",target:'[data-tour="toolbar"]',placement:"bottom"},{id:"quick-actions",title:"Quick actions",body:"Launch Story Mode, open the command palette, or jump to bottlenecks instantly.",target:'[data-tour="quick-actions"]',placement:"left"},{id:"stage",title:"Cinema stage",body:"The timeline shows every step as a scene. Scrub to see pacing and concurrency.",target:'[data-tour="stage"]',placement:"top"},{id:"inspector",title:"Inspector",body:je==="executive"?"Open key moments to validate outcome impact and communication-ready summaries.":"Open any step to read payloads, apply redaction, and replay from that moment.",target:'[data-tour="inspector"]',placement:"left"},{id:"compare",title:"Compare runs",body:z?"Compare is live. Review deltas in cost, steps, and wall time side by side.":"Replay from a step to unlock compare mode and validate improvements.",target:'[data-tour="compare"]',placement:"top"}),o},[z,Ra,je]),fo=l.useCallback(()=>{ns(null),h("flow")},[h]),We=l.useMemo(()=>{var g,N,A,G;if(!e)return[];const a=[],o=[...e.steps].sort((O,ce)=>(ce.durationMs??0)-(O.durationMs??0))[0],m=e.steps.find(O=>O.status==="failed");if(m&&v!==m.id&&a.push({id:"jump-error",title:"Investigate first failure",body:`${m.name} failed and should be inspected before optimization work.`,actionLabel:"Open failed step",tone:"warning",action:ft}),o&&v!==o.id&&a.push({id:"jump-bottleneck",title:"Tackle latency bottleneck",body:`${o.name} is the slowest scene in this run and the best optimization target.`,actionLabel:"Open bottleneck",tone:"priority",action:Re}),(g=$==null?void 0:$.hypotheses)!=null&&g[0]){const O=$.hypotheses[0];a.push({id:"investigate-hypothesis",title:O.title,body:O.summary,actionLabel:"Inspect evidence",tone:"info",action:()=>{const ce=O.evidenceStepIds[0];ce&&(X(ce),u!=="cinema"&&h("cinema"))}})}if(u!=="matrix"&&a.push({id:"matrix-experiment",title:"Run scenario matrix",body:"Compare prompt and strategy alternatives from one anchor step to rank causal impact.",actionLabel:"Open matrix",tone:"info",action:()=>{var O;Ka(v??((O=e.steps[0])==null?void 0:O.id)??""),h("matrix")}}),!z&&(v||(N=e.steps[0])!=null&&N.id)){const O=v??((A=e.steps[0])==null?void 0:A.id)??null;O&&a.push({id:"run-replay",title:"Create director replay",body:"Branch a replay trace and validate whether your change improves the run.",actionLabel:"Replay from step",tone:"info",action:()=>{Je(O)}})}if((G=Ee==null?void 0:Ee.causalRanking)!=null&&G.length){const O=Ee.causalRanking[0];a.push({id:"causal-factor",title:`Top causal factor: ${O.factor}`,body:`Confidence ${(O.confidence*100).toFixed(0)}% across ${O.evidence.samples} sample(s).`,actionLabel:"View matrix",tone:"priority",action:()=>h("matrix")})}return a.slice(0,4)},[z,Je,$,Re,ft,u,Ee,v,e,h]),yo=l.useMemo(()=>We.map((a,o)=>{const m=a.tone==="warning"?"high":a.tone==="priority"?"medium":"low";return{id:`priority-${a.id}`,title:a.title,detail:a.body,severity:m,actionLabel:a.actionLabel,onAction:a.action,done:o===0?a.id==="jump-error"&&!!v||a.id==="jump-bottleneck"&&!!v:!1}}),[We,v]),yt=l.useMemo(()=>{var A,G;if(!e)return"No trace loaded.";const a=[...e.steps].sort((O,ce)=>(ce.durationMs??0)-(O.durationMs??0))[0],o=e.steps.filter(O=>O.status==="failed").length,m=(A=$==null?void 0:$.hypotheses)==null?void 0:A[0],g=(G=Ee==null?void 0:Ee.causalRanking)==null?void 0:G[0];return[`Run ${e.id} completed with ${e.steps.length} steps across ${e.metadata.wallTimeMs}ms.`,a?`Primary latency driver: ${a.name} (${a.durationMs??0}ms).`:null,o>0?`Observed ${o} failed step(s), indicating reliability risk.`:"No failed steps observed.",m?`Top investigation hypothesis: ${m.title} (${m.severity}).`:null,g?`Highest ranked causal factor from matrix: ${g.factor} (${(g.confidence*100).toFixed(0)}% confidence).`:null,"Recommended plan: inspect bottleneck evidence, validate with replay matrix, and lock in mitigations."].filter(Boolean).join(" ")},[$,Ee==null?void 0:Ee.causalRanking,e]),bo=l.useCallback(a=>{var m,g;const o=a.toLowerCase();if(!e)return"No trace is loaded yet.";if(o.includes("bottleneck")||o.includes("slow")){const N=[...e.steps].sort((A,G)=>(G.durationMs??0)-(A.durationMs??0))[0];return N?`The primary bottleneck is ${N.name} at ${N.durationMs??0}ms. Prioritize this step for optimization and replay validation.`:"No bottleneck could be determined from current trace data."}if(o.includes("risk")||o.includes("failure")||o.includes("error")){const N=e.steps.filter(A=>A.status==="failed");return N.length?`Risk is concentrated in ${N.length} failed step(s), starting at ${((m=N[0])==null?void 0:m.name)??"unknown"}.`:"Failure risk appears low for this run; no failed steps were observed."}return o.includes("cost")?`Recorded run cost is ${(e.metadata.totalCostUsd??0).toFixed(4)} USD. Use matrix scenarios to evaluate cheaper prompt/strategy options.`:o.includes("next")||o.includes("action")?We.length?`Next action: ${((g=We[0])==null?void 0:g.title)??"Open matrix"}.`:"Next action: open Cinema mode, inspect bottleneck, then run the matrix.":yt},[yt,We,e]),ja=l.useCallback(()=>{e&&Vt({id:"export-director-narrative",label:"Director narrative markdown",run:()=>{const a=`# Director Narrative

${yt}

## Recommended Actions
${We.map(o=>`- ${o.title}: ${o.body}`).join(`
`)}`;Cn(`agent-director-narrative-${e.id}.md`,a,"text/markdown")}})},[yt,We,Vt,e]),Sa=l.useCallback(async()=>{if(!e)return;const a=We[0],o=e.steps.filter(N=>N.status==="failed").length,g=[`Session handoff (${new Date().toISOString()})`,`Trace: ${e.id}`,`Owner: ${qt}`,`Handoff owner: ${zt||"unassigned"}`,`Mode: ${u}`,`Selected step: ${v??"none"}`,`Run health: ${Ut}/100`,`Failures: ${o}`,`Wall time: ${e.metadata.wallTimeMs}ms`,`Top recommendation: ${a?`${a.title} -> ${a.actionLabel}`:"None"}`,`Narrative: ${yt}`].join(`
`);try{await navigator.clipboard.writeText(g),tn("Handoff digest copied"),P("ux.support.payload_copied",{kind:"handoff_digest"})}catch{window.prompt("Copy handoff digest",g),tn("Handoff digest ready")}window.setTimeout(()=>tn(null),2200)},[yt,We,zt,u,Ut,qt,v,e,P]),Na=l.useCallback(a=>{xs(o=>{const m={...o,[a]:!o[a]};return fd(window.localStorage,m),P("ux.feature_flag.toggled",{flag:a,enabled:m[a]}),m})},[P]),go=l.useCallback(()=>{Ve.isValid&&(es(!0),Ze(!1),Ga("source"),Q("Workspace setup complete.","success"),P("ux.setup.completed",{dataSource:tt.dataSource,hasInvites:!!tt.inviteEmails.trim()}))},[Q,Ve.isValid,tt,P,es]),Qt=l.useCallback(a=>{const o=ze[0],m=v??"none",g=(e==null?void 0:e.id)??"none",N=[`Need-help escalation (${new Date().toISOString()})`,`Trace: ${g}`,`Mode: ${u}`,`Selected step: ${m}`,`Signal: ${o?`${o.kind} - ${o.detail}`:"manual escalation request"}`,`Time to first success: ${st??"not yet achieved"} ms`,"What happened: ","Expected outcome: ","What blocked progress: "].join(`
`);gs(A=>A.trim()?A:N),bs(!0),Q("Guided support opened with contextual diagnostics.","info"),P("ux.support.opened",{source:a,escalated:!0,signal:(o==null?void 0:o.kind)??null,timeToFirstSuccessMs:st})},[Q,u,v,ze,st,e,P]),xo=l.useCallback(async()=>{const a=JSON.stringify({diagnostics:wa,note:Ft,owner:qt,handoffOwner:zt||null},null,2);try{await navigator.clipboard.writeText(a),Q("Support payload copied.","success"),P("ux.support.payload_copied",{bytes:a.length})}catch{window.prompt("Copy support payload",a)}},[Q,zt,qt,wa,Ft,P]),kn=l.useCallback(()=>{const a=dt.trim();if(!a||ht)return;const o={id:`view-${Math.random().toString(36).slice(2,9)}`,name:a,state:{mode:u,query:j,typeFilter:V,selectedStepId:v,safeExport:ae,windowed:$e,syncPlayback:ue,explainMode:Pe,section:f}};ya(m=>[o,...m].slice(0,20)),ys(""),ba(o.id),P("ux.saved_view.created",{viewId:o.id,name:a}),Q(`Saved view: ${a}`,"success")},[f,Q,Pe,u,j,ae,dt,ht,v,ya,ue,P,V,$e]),jn=l.useCallback(a=>{const o=qe.find(m=>m.id===a);o&&(h(o.state.mode),C(o.state.query),T(o.state.typeFilter),X(o.state.selectedStepId),I(o.state.safeExport),Oe(o.state.windowed),Ge(o.state.syncPlayback),Me(o.state.explainMode),y(o.state.section),ba(o.id),P("ux.saved_view.applied",{viewId:o.id,name:o.name}),Q(`Applied view: ${o.name}`,"info"))},[Q,qe,y,Me,h,I,Ge,Oe,P]),vo=l.useCallback(()=>{if(!He)return;const a=qe.find(o=>o.id===He);a&&rt("Delete saved view",`Delete saved view "${a.name}"?`,()=>{ya(o=>o.filter(m=>m.id!==He)),ba(""),P("ux.saved_view.deleted",{viewId:a.id,name:a.name}),Q(`Deleted view: ${a.name}`,"warning")})},[Q,rt,qe,He,ya,P]);l.useEffect(()=>{var m;if(!e)return;dc(),J(0),fe(!1);const a=Math.min(Math.max((e.metadata.wallTimeMs||1)*.2,5e3),6e4);Da(a),e.steps.length>500&&Oe(!0),z||Te(!1),u==="compare"&&!z&&h("cinema");const o=v&&e.steps.some(g=>g.id===v)?v:((m=e.steps[0])==null?void 0:m.id)??"";Ka(g=>g&&e.steps.some(N=>N.id===g)?g:o)},[e,z,u,v,h,Oe,Te]),l.useEffect(()=>(document.body.classList.toggle("explain-mode",Pe),()=>{document.body.classList.remove("explain-mode")}),[Pe]),l.useEffect(()=>(document.body.classList.toggle("story-mode",!!(ie!=null&&ie.active)),()=>{document.body.classList.remove("story-mode")}),[ie==null?void 0:ie.active]),l.useEffect(()=>{if(!(ie!=null&&ie.active))return;const a=oa[ie.step];if(!a){ot();return}Promise.resolve(a.action());const o=window.setTimeout(()=>{ia(m=>m&&m.active?{...m,step:m.step+1}:m)},a.duration);return()=>window.clearTimeout(o)},[oa,ot,ie]),l.useEffect(()=>{ie!=null&&ie.active&&(!e||!Ua||e.id!==Ua&&ot())},[ie==null?void 0:ie.active,e,Ua,ot]),l.useEffect(()=>{kt||sa||Ne(`tutorial_start:${(e==null?void 0:e.id)||me||oe.seed}`,"funnel.tutorial_start",{traceId:(e==null?void 0:e.id)||me||"unknown",persona:je,launchPath:La})},[Ne,oe.seed,me,kt,je,La,sa,e==null?void 0:e.id]),l.useEffect(()=>{M>0&&Se(a=>a.playback?a:{...a,playback:!0})},[M,Se]),l.useEffect(()=>{u==="flow"&&Se(a=>a.flow?a:{...a,flow:!0}),u==="matrix"&&Se(a=>a.matrix?a:{...a,matrix:!0})},[u,Se]),l.useEffect(()=>{v&&Se(a=>a.inspect?a:{...a,inspect:!0})},[v,Se]),l.useEffect(()=>{Za>1&&Se(a=>a.collaborate?a:{...a,collaborate:!0})},[Za,Se]),l.useEffect(()=>{Ne(`session_start:${me||oe.seed}`,"funnel.session_start",{traceId:me||(e==null?void 0:e.id)||"unknown",seed:oe.seed})},[Ne,oe.seed,me,e==null?void 0:e.id]),l.useEffect(()=>{oe.raid.objectives.some(o=>o.progress>0)&&Ne(`objective_progress:${me||oe.seed}`,"funnel.first_objective_progress",{traceId:me||(e==null?void 0:e.id)||"unknown"})},[Ne,oe.raid.objectives,oe.seed,me,e==null?void 0:e.id]),l.useEffect(()=>{oe.outcome.status!=="in_progress"&&(Ne(`first_outcome:${me||oe.seed}`,"funnel.first_mission_outcome",{status:oe.outcome.status,reason:oe.outcome.reason}),(oe.outcome.status==="win"||oe.outcome.status==="loss")&&Ne(`run_outcome:${me||oe.seed}`,"funnel.run_outcome",{status:oe.outcome.status,reason:oe.outcome.reason}))},[Ne,oe.outcome.reason,oe.outcome.status,oe.seed,me]),l.useEffect(()=>{if(!ue||_e||hn.current)return;const a=va[0];if(!a||a.traceId!==(e==null?void 0:e.id))return;const o=Math.abs(a.playheadMs-M),m=a.mode!==u,g=(a.selectedStepId??null)!==(v??null);o<600&&!m&&!g||(hn.current=!0,J(a.playheadMs),(a.mode==="cinema"||a.mode==="flow"||a.mode==="compare"||a.mode==="matrix"||a.mode==="gameplay")&&h(a.mode),X(a.selectedStepId??null),window.setTimeout(()=>{hn.current=!1},180))},[_e,u,M,va,v,h,ue,e==null?void 0:e.id]),l.useEffect(()=>{if(!e)return;const o=Date.parse(e.startedAt)+M;let m=0,g=Number.POSITIVE_INFINITY;e.steps.forEach((A,G)=>{const O=Date.parse(A.startedAt),ce=Date.parse(A.endedAt??A.startedAt);if(o>=O&&o<=ce){m=G,g=0;return}const be=Math.min(Math.abs(o-O),Math.abs(o-ce));be<g&&(g=be,m=G)}),[m,m-1,m+1].filter(A=>A>=0&&A<e.steps.length).forEach(A=>{const G=e.steps[A];G&&Tn(e.id,G.id,ae)})},[e,M,ae]),l.useEffect(()=>{if(!e||!xn)return;const a=`${e.id}:${pt}:${(z==null?void 0:z.id)??"none"}:${ae?"safe":"raw"}:${xn}`;if(Ps.current===a)return;Ps.current=a;const o=window.setTimeout(()=>{Wt.forEach(m=>{Tn(e.id,m,ae)}),pt==="compare"&&z&&Wt.forEach(m=>{Tn(z.id,m,ae)}),pt==="flow"?Qe(()=>import("./index-DV4ABu7r.js"),__vite__mapDeps([0,1,2,3])):pt==="matrix"?Qe(()=>import("./index-Cmv7wfhp.js"),__vite__mapDeps([6,1,2,3])):pt==="compare"&&z?Qe(()=>import("./index-B64owC2L.js"),__vite__mapDeps([4,1,2,3])):pt==="gameplay"&&Qe(()=>import("./index-KpyKW-ng.js"),__vite__mapDeps([7,1,2,3]))},160);return()=>window.clearTimeout(o)},[z,pt,Wt,xn,ae,e]),l.useEffect(()=>{if(!e||!_e||u!=="cinema"&&u!=="compare")return;const a=(z==null?void 0:z.metadata.wallTimeMs)??0,o=u==="compare"?Math.max(e.metadata.wallTimeMs||1,a||1):e.metadata.wallTimeMs||1;let m=0,g=performance.now();const N=A=>{const G=(A-g)*ge;g=A,J(O=>{const ce=O+G;return ce>=o?(fe(!1),o):ce}),m=requestAnimationFrame(N)};return m=requestAnimationFrame(N),()=>cancelAnimationFrame(m)},[e,z,_e,ge,u]),l.useEffect(()=>{const a=JSON.stringify(ma),o=JSON.stringify(ut);a!==o&&ha(ut)},[ut,ha,ma]);const wo=l.useCallback((a,o)=>{ha(m=>vl(m,a,o)),P("ux.settings.shortcut.updated",{shortcut:a,key:o.toLowerCase()})},[ha,P]);l.useEffect(()=>{const a=o=>{var G;const m=O=>!o.metaKey&&!o.ctrlKey&&!o.altKey&&o.key.toLowerCase()===ut[O],g=o.target,N=(G=g==null?void 0:g.tagName)==null?void 0:G.toLowerCase();if(!(N==="input"||N==="textarea"||N==="select"||g!=null&&g.isContentEditable)){if((o.metaKey||o.ctrlKey)&&o.key.toLowerCase()==="k"){o.preventDefault(),Be(O=>!O);return}if(o.key==="?"||o.key==="/"&&o.shiftKey){o.preventDefault(),Xe(!0);return}if(m("toggleStory")){o.preventDefault(),Kt();return}if(m("toggleExplain")){o.preventDefault(),Me(O=>!O);return}if(m("startTour")){o.preventDefault(),xe(!0);return}if(o.key==="Escape"){if(Wa){xe(!1),vt(!0);return}Xe(!1),Be(!1),X(null);return}if(o.key===" "){o.preventDefault(),(u==="cinema"||u==="compare")&&fe(O=>!O);return}if(m("toggleFlow")){o.preventDefault(),u==="flow"?h("cinema"):u==="cinema"&&ee("flow");return}if(m("toggleCinema")){o.preventDefault(),u!=="cinema"&&h("cinema");return}if(m("toggleGameplay")){o.preventDefault(),ee("gameplay");return}if(m("toggleInspector")){o.preventDefault(),v?X(null):e!=null&&e.steps.length&&X(e.steps[0].id);return}if(o.key==="ArrowLeft"||o.key==="ArrowRight"){if(o.preventDefault(),!e)return;const O=e.metadata.wallTimeMs||1;if(o.shiftKey){J(o.key==="ArrowLeft"?0:O),fe(!1),h("cinema");return}const ce=o.key==="ArrowRight"?1:-1,be=qc(Fs,M,ce);be!=null&&(J(be),fe(!1),h("cinema"))}}};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[u,ut,v,e,M,Fs,ee,h,Me,Be,xe,vt,Wa,Kt]);const Vs=l.useMemo(()=>{if(!e||!$e||j)return null;const a=e.metadata.wallTimeMs||1,o=Math.min(Math.max(Aa,5e3),a);let m=Math.max(0,M-o/2);const g=Math.min(a,m+o);return g-m<o&&(m=Math.max(0,g-o)),{startMs:m,endMs:g}},[e,$e,M,j,Aa]),Tt=!!(ie!=null&&ie.active),Js=(ie==null?void 0:ie.step)??0,ko=((Qs=oa[Js])==null?void 0:Qs.label)??"Wrapping up",jo=oa.length,So=j!==D,No=`${Math.min(Ue.length,Bt)}/${Ue.length}`,Co=l.useMemo(()=>je==="executive"?[{label:"Review run health",done:Ut>=80},{label:"Inspect top risk",done:!!v},{label:"Share handoff digest",done:!!St}]:je==="operator"?[{label:"Open failed step",done:!!v},{label:"Run replay",done:!!z},{label:"Use support diagnostics",done:sn||!!Ft.trim()}]:[{label:"Open flow graph",done:u==="flow"},{label:"Run matrix scenario",done:!!Ee},{label:"Save a reusable view",done:qe.length>0}],[z,St,je,u,Ee,Ut,qe.length,v,Ft,sn]),Mo=l.useMemo(()=>[{id:"macro-rapid-triage",label:"Run rapid triage launch path",description:"Jump to the highest-risk step and start mitigation.",group:"Macros",onTrigger:()=>{Jt("rapid_triage")}},{id:"macro-deep-diagnosis",label:"Run deep diagnosis launch path",description:"Open flow analysis and guided tour.",group:"Macros",onTrigger:()=>{Jt("deep_diagnosis")}},{id:"macro-team-sync",label:"Run team sync launch path",description:"Enable sync mode and generate shareable context.",group:"Macros",onTrigger:()=>{Jt("team_sync")}},{id:"story-toggle",label:Tt?"Stop story mode":"Start story mode",description:"Auto-runs a cinematic walkthrough.",group:"Story",keys:"S",onTrigger:Kt},{id:"tour-start",label:"Start guided tour",description:"Walk the interface step by step.",group:"Onboarding",keys:"T",onTrigger:()=>xe(!0)},{id:"explain-toggle",label:Pe?"Disable explain mode":"Enable explain mode",description:"Toggle contextual overlays.",group:"Onboarding",keys:"E",onTrigger:()=>Me(a=>!a)},{id:"shortcuts",label:"Show shortcuts",description:"Open the keyboard map.",group:"Onboarding",keys:"?",onTrigger:()=>Xe(!0)},{id:"playback-toggle",label:_e?"Pause playback":"Play playback",description:"Start or stop the run.",group:"Playback",keys:"Space",onTrigger:wn},{id:"mode-cinema",label:"Switch to Cinema",description:"Timeline playback view.",group:"Modes",keys:"C",onTrigger:()=>ee("cinema")},{id:"mode-flow",label:"Switch to Flow",description:"Graph dependency view.",group:"Modes",keys:"F",onTrigger:()=>ee("flow")},{id:"mode-compare",label:"Open Compare",description:"Side-by-side diff view.",group:"Modes",onTrigger:()=>ee("compare"),disabled:!z},{id:"mode-matrix",label:"Open Matrix",description:"Counterfactual replay matrix view.",group:"Modes",onTrigger:()=>ee("matrix")},{id:"mode-gameplay",label:"Open Gameplay",description:"World-class gameplay mechanics control center.",group:"Modes",keys:"G",onTrigger:()=>ee("gameplay")},{id:"jump-bottleneck",label:"Jump to bottleneck",description:"Select the slowest step.",group:"Navigation",onTrigger:Re},{id:"jump-error",label:"Jump to error",description:"Select the first failed step.",group:"Navigation",onTrigger:ft},{id:"replay-step",label:"Replay from selected step",description:"Branch a Director’s Cut.",group:"Tools",onTrigger:()=>v&&Je(v),disabled:!v},{id:"overlay-toggle",label:$t?"Hide overlay":"Show overlay",description:"Ghost diff in Cinema/Flow.",group:"Tools",onTrigger:()=>Te(a=>!a),disabled:!z},{id:"safe-export",label:ae?"Disable safe export":"Enable safe export",description:"Redact sensitive payloads.",group:"Safety",onTrigger:()=>I(a=>!a)},{id:"reload",label:"Reload traces",description:"Refresh trace data.",group:"Meta",onTrigger:i},{id:"handoff-digest",label:"Copy handoff digest",description:"Capture mode, risk summary, and next actions for teammates.",group:"Meta",keys:"H",onTrigger:()=>{Sa()}},{id:"section-journey",label:"Open journey workspace",description:"Show journey presets and persona progression.",group:"Workspace",onTrigger:()=>y("journey")},{id:"section-analysis",label:"Open analysis workspace",description:"Show async action health and export queue.",group:"Workspace",onTrigger:()=>y("analysis")},{id:"section-collaboration",label:"Open collaboration workspace",description:"Ownership, handoff, and activity timeline.",group:"Workspace",onTrigger:()=>y("collaboration")},{id:"section-operations",label:"Open operations workspace",description:"Setup, support, and feature flags.",group:"Workspace",onTrigger:()=>y("operations")},{id:"open-setup-wizard",label:"Open setup wizard",description:"Connect source, import context, and invite teammates.",group:"Workspace",onTrigger:()=>{Ze(!0),P("ux.setup.opened",{source:"command_palette"})},disabled:!de.setupWizardV1},{id:"open-support-panel",label:"Open support diagnostics",description:"Collect support payload and copy handoff diagnostics.",group:"Workspace",onTrigger:()=>{Qt("command_palette")},disabled:!de.supportPanelV1},...qe.slice(0,5).map(a=>({id:`saved-view-${a.id}`,label:`Apply saved view: ${a.name}`,description:"Restore a saved journey configuration.",group:"Workspace",onTrigger:()=>jn(a.id)}))],[jn,Sa,de.setupWizardV1,de.supportPanelV1,Qt,Tt,Kt,Pe,_e,wn,ee,z,Re,ft,v,Je,$t,ae,i,Me,Te,I,Xe,Ze,xe,y,qe,Jt,P]),Eo=l.useCallback(()=>{Ne(`tutorial_skip:intro:${(e==null?void 0:e.id)||me||oe.seed}`,"funnel.tutorial_skip",{traceId:(e==null?void 0:e.id)||me||"unknown",source:"intro_overlay"}),ra(!0)},[Ne,oe.seed,me,ra,e==null?void 0:e.id]),Io=l.useCallback(()=>{ra(!0),xe(!0)},[ra,xe]),_o=l.useCallback(()=>{Ne(`tutorial_skip:tour:${(e==null?void 0:e.id)||me||oe.seed}`,"funnel.tutorial_skip",{traceId:(e==null?void 0:e.id)||me||"unknown",source:"guided_tour"}),xe(!1),vt(!0)},[Ne,oe.seed,me,vt,e==null?void 0:e.id]),To=l.useCallback(()=>{Ne(`tutorial_complete:${(e==null?void 0:e.id)||me||oe.seed}`,"funnel.tutorial_complete",{traceId:(e==null?void 0:e.id)||me||"unknown"}),xe(!1),vt(!0)},[Ne,oe.seed,me,vt,e==null?void 0:e.id]);if(s)return t.jsx(_n,{variant:"loading",title:"Loading trace...",message:"Preparing timeline, graph, and replay context."});if(!r&&!e&&d.length===0)return t.jsx(_n,{variant:"empty",title:"No traces yet",message:"Ingest your first trace, then reload to begin the Observe → Inspect → Direct workflow.",actions:[{id:"retry",label:"Retry",node:t.jsx("button",{className:"primary-button",type:"button",onClick:i,children:"Retry"})},{id:"help",label:"Open help",node:t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer",children:"Open help"})}]});if(r||!e)return t.jsx(_n,{variant:"error",title:"Trace load failed",message:r??"Failed to load trace.",actions:[{id:"retry",label:"Retry",node:t.jsx("button",{className:"primary-button",type:"button",onClick:i,children:"Retry"})},{id:"help",label:"Open help",node:t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer",children:"Open help"})}]});const Sn=Cd[f],Ao=!!(R.trim()||q||H||he||we),Nn=(()=>{switch(f){case"journey":return{label:"Save current view",onClick:()=>kn(),disabled:!!ht};case"analysis":return{label:"Queue narrative export",onClick:()=>ja(),disabled:!e||!de.exportCenterV1};case"collaboration":return{label:"Share live link",onClick:()=>{It()},disabled:!de.ownershipPanelV1};case"operations":default:return{label:Z("open_setup_wizard"),onClick:()=>{Ze(!0),P("ux.setup.opened",{source:"workspace_primary"})},disabled:!de.setupWizardV1}}})(),Do=Md[u],$o=qa==="auto"?oi<=980?"compact":"comfortable":qa,Ro=`Workspace / ${Sn.title} / ${Do}`,Ca=f==="journey"?u!=="cinema"?{summary:"Switch back to timeline playback to inspect sequence order before you save or share.",label:"Open timeline playback",onClick:()=>ee("cinema"),disabled:!1}:{summary:"Save this viewpoint so you can return to the exact context during handoff.",label:"Save current view",onClick:()=>kn(),disabled:!!ht}:f==="analysis"?u!=="flow"?{summary:"Open the flow graph to inspect causal edges before running deeper diagnostics.",label:"Open flow graph",onClick:()=>ee("flow"),disabled:!1}:{summary:"Queue a director narrative so root-cause evidence is ready for reporting.",label:"Queue narrative export",onClick:()=>ja(),disabled:!de.exportCenterV1}:f==="collaboration"?ue?{summary:"Share a live session link so responders open this exact context immediately.",label:"Share live link",onClick:()=>{It()},disabled:!de.ownershipPanelV1}:{summary:"Enable sync playback so collaborators stay aligned on the same investigation moment.",label:"Enable sync playback",onClick:()=>Ge(!0),disabled:!1}:{summary:"Run setup checks before demo and release handoff to avoid surprises.",label:Z("open_setup_wizard"),onClick:()=>{Ze(!0),P("ux.setup.opened",{source:"workspace_next_action"})},disabled:!de.setupWizardV1};return t.jsxs("div",{className:`app theme-${Rt} density-${$o} ${Pe?"explain-mode":""} ${u==="compare"?"mode-compare":""} ${u==="matrix"?"mode-matrix":""} ${u==="gameplay"?"mode-gameplay":""}`,children:[t.jsx("h1",{className:"sr-only",children:"Workspace"}),t.jsx("div",{className:"live-region",role:"status","aria-live":"polite","aria-atomic":"true",children:vi}),t.jsx(Bo,{trace:e,traces:d,selectedTraceId:c,onSelectTrace:p,onReload:i,onStartTour:()=>xe(!0),onToggleStory:Kt,onOpenPalette:()=>Be(!0),onToggleExplain:()=>Me(a=>!a),onShareSession:It,onCreateHandoffDigest:()=>void Sa(),onOpenSupport:()=>{Qt("header")},onThemeChange:Vn,onMotionChange:Jn,densityMode:qa,onDensityChange:ii,themeMode:Rt,motionMode:ta,activeSessions:Za,shareStatus:fa,handoffStatus:St,explainMode:Pe,storyActive:Tt,mode:u,missionCompletion:zs,runHealthScore:Ut,modeHotkeys:Ri,workspaces:Rr,workspaceId:aa,onWorkspaceChange:ci,workspaceRole:Ot,onWorkspaceRoleChange:di,sessionLabel:mt.label,sessionExpired:mt.expired,onRenewSession:Pi}),t.jsx(Bl,{notifications:Fe.map(({id:a,message:o,level:m})=>({id:a,message:o,level:m})),onDismiss:Oi}),ze.length>0||st===null?t.jsxs("section",{className:"help-escalation-banner","aria-live":"polite",children:[t.jsxs("div",{className:"help-escalation-copy",children:[t.jsx("strong",{children:"Need help now?"}),t.jsx("p",{children:ze.length>0?`Detected ${ze.length} potential friction signal${ze.length===1?"":"s"} in this session.`:"No successful action recorded yet in this session. Start guided recovery to avoid guesswork."})]}),t.jsxs("div",{className:"help-escalation-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>Qt("escalation_banner"),children:"Need help now"}),t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer",children:"Open quick help"})]})]}):null,Gt?t.jsxs("div",{className:"undo-banner",role:"status","aria-live":"polite",children:[t.jsx("span",{children:Gt.label}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{var a,o;(o=(a=Os.current)[Gt.id])==null||o.call(a),on(null)},children:"Undo"})]}):null,ga?t.jsx("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true","aria-label":"Confirm action",children:t.jsxs("div",{className:"palette confirm-dialog",children:[t.jsx("div",{className:"palette-header",children:t.jsxs("div",{children:[t.jsx("div",{className:"palette-title",children:ga.title}),t.jsx("div",{className:"palette-subtitle",children:ga.message})]})}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>rn(null),children:"Cancel"}),t.jsx("button",{className:"primary-button",type:"button",onClick:()=>{var o,m;const a=ga.id;P("ux.action.confirmed",{confirmationId:a}),(m=(o=fn.current)[a])==null||m.call(o),delete fn.current[a],rn(null)},children:"Confirm"})]})]})}):null,za&&de.setupWizardV1?t.jsx("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true","aria-label":"First-run setup wizard",children:t.jsxs("div",{className:"palette setup-wizard",children:[t.jsxs("div",{className:"palette-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"palette-title",children:"First-run setup wizard"}),t.jsx("div",{className:"palette-subtitle",children:"Connect source, import context, invite teammates."})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Ze(!1),children:"Close"})]}),t.jsxs("div",{className:"setup-stepper",children:[t.jsx("span",{className:et==="source"?"active":"",children:"1. Source"}),t.jsx("span",{className:et==="import"?"active":"",children:"2. Import"}),t.jsx("span",{className:et==="invite"?"active":"",children:"3. Invite"})]}),et==="source"?t.jsxs("div",{className:"workspace-card",children:[t.jsxs("label",{children:["Data source",t.jsxs("select",{className:"search-select",value:tt.dataSource,onChange:a=>Ba(o=>({...o,dataSource:a.target.value})),children:[t.jsx("option",{value:"",children:"Select source"}),t.jsx("option",{value:"api",children:"Live API"}),t.jsx("option",{value:"file",children:"Trace file import"}),t.jsx("option",{value:"hybrid",children:"Hybrid replay baseline"})]})]}),Ve.dataSourceError?t.jsx("p",{className:"workspace-error",children:Ve.dataSourceError}):null]}):null,et==="import"?t.jsxs("div",{className:"workspace-card",children:[t.jsxs("label",{children:["Import path or URI",t.jsx("input",{className:"search-input",value:tt.importPath,onChange:a=>Ba(o=>({...o,importPath:a.target.value})),placeholder:"/data/traces/latest.json"})]}),Ve.importPathError?t.jsx("p",{className:"workspace-error",children:Ve.importPathError}):null]}):null,et==="invite"?t.jsxs("div",{className:"workspace-card",children:[t.jsxs("label",{children:["Invite emails (comma-separated)",t.jsx("input",{className:"search-input",value:tt.inviteEmails,onChange:a=>Ba(o=>({...o,inviteEmails:a.target.value})),placeholder:"ops@example.com, qa@example.com"})]}),Ve.inviteEmailsError?t.jsx("p",{className:"workspace-error",children:Ve.inviteEmailsError}):null]}):null,t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Ga(a=>a==="invite"?"import":"source"),disabled:et==="source",children:"Back"}),et!=="invite"?t.jsx("button",{className:"primary-button",type:"button",onClick:()=>Ga(a=>a==="source"?"import":"invite"),children:"Continue"}):t.jsx("button",{className:"primary-button",type:"button",disabled:!Ve.isValid,onClick:go,children:"Complete setup"})]})]})}):null,sn&&de.supportPanelV1?t.jsx("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true","aria-label":"Support diagnostics",children:t.jsxs("div",{className:"palette support-panel",children:[t.jsxs("div",{className:"palette-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"palette-title",children:"Support diagnostics"}),t.jsx("div",{className:"palette-subtitle",children:"Capture environment, friction signals, and handoff payload for rapid triage."})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>bs(!1),children:"Close"})]}),t.jsxs("div",{className:"support-guided-recovery",children:[t.jsx("strong",{children:"Guided recovery context"}),t.jsx("p",{children:ze.length?`Latest signal: ${(Ys=ze[0])==null?void 0:Ys.kind.replace("_"," ")}. ${(Xs=ze[0])==null?void 0:Xs.detail}`:"No explicit friction signal detected. This panel still captures full context for proactive support."}),t.jsxs("p",{children:["Time to first success:"," ",st===null?"not yet recorded in this session":`${st}ms`]})]}),t.jsxs("label",{children:["Support note",t.jsx("textarea",{className:"search-input",value:Ft,onChange:a=>gs(a.target.value),rows:3,placeholder:"Describe the issue, reproduction path, expected behavior, and where the user got stuck."})]}),t.jsx("pre",{className:"support-diagnostics-preview",children:JSON.stringify(wa,null,2)}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>void xo(),children:"Copy diagnostics payload"}),t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer",children:"Open help"})]})]})}):null,!kt&&!sa?t.jsx(Fl,{onComplete:Eo,onStartTour:Io,onStartStory:_t,persona:je,onPersonaChange:ri,launchPath:La,onLaunchPathChange:Fa,onStartLaunchPath:a=>void Jt(a)}):null,kt&&!Ra?t.jsx(ql,{explainMode:Pe,storyActive:Tt,onStartTour:()=>{Oa(!0),xe(!0)},onStartStory:()=>{Oa(!0),_t()},onToggleExplain:()=>Me(a=>!a),onDismiss:()=>Oa(!0)}):null,t.jsx(Rl,{steps:ho,open:Wa,onClose:_o,onComplete:To}),t.jsx(Ol,{enabled:Pe}),t.jsx(Gl,{active:Tt,label:ko,step:Js,total:jo,onStop:ot,onRestart:_t}),t.jsx(Wo,{insights:n,investigation:$,onSelectStep:a=>{X(a),u!=="cinema"&&h("cinema")},onJumpToError:ft,onJumpToBottleneck:Re}),t.jsx(El,{trace:e,mode:u==="matrix"||u==="gameplay"?"cinema":u,playheadMs:M,selectedStepId:v,compareTrace:z,collapsed:ai,onToggleCollapsed:()=>ni(a=>!a),onModeChange:ee,onSelectStep:a=>{X(a),u!=="cinema"&&h("cinema")},onJumpToBottleneck:Re,onReplay:Je,onStartTour:()=>xe(!0),priorityQueue:yo}),t.jsxs("nav",{className:"workspace-nav","aria-label":"Workspace navigation",children:[t.jsx("button",{className:`ghost-button ${f==="journey"?"active":""}`,type:"button","aria-pressed":f==="journey","aria-label":"Understand this run workspace section",onClick:()=>y("journey"),children:"Understand"}),t.jsx("button",{className:`ghost-button ${f==="analysis"?"active":""}`,type:"button","aria-pressed":f==="analysis","aria-label":"Diagnose root cause workspace section",onClick:()=>y("analysis"),children:"Diagnose"}),t.jsx("button",{className:`ghost-button ${f==="collaboration"?"active":""}`,type:"button","aria-pressed":f==="collaboration","aria-label":"Coordinate responders workspace section",onClick:()=>y("collaboration"),children:"Coordinate"}),t.jsx("button",{className:`ghost-button ${f==="operations"?"active":""}`,type:"button","aria-pressed":f==="operations","aria-label":"Configure workspace section",onClick:()=>y("operations"),children:"Configure"}),t.jsx("button",{className:`ghost-button ${u==="compare"||u==="matrix"?"active":""}`,type:"button","aria-pressed":u==="compare"||u==="matrix","aria-label":"Validate outcome intent",onClick:()=>{y("analysis"),ee(z?"compare":"matrix")},children:"Validate"})]}),t.jsxs("div",{className:"workspace-orientation","aria-live":"polite",children:[t.jsx("p",{className:"workspace-breadcrumb","aria-label":"Current location",children:Ro}),t.jsxs("div",{className:"workspace-orientation-meta",children:[t.jsxs("span",{className:"status-badge",children:["Workspace: ",aa]}),t.jsxs("span",{className:"status-badge",children:["Role: ",Ot]})]})]}),t.jsxs("div",{className:"workspace-section-header",children:[t.jsxs("div",{className:"workspace-section-meta",children:[t.jsx("p",{className:"workspace-section-eyebrow",children:"Workspace"}),t.jsx("h2",{id:"workspace-section-title",children:Sn.title}),t.jsx("p",{children:Sn.description}),t.jsxs("div",{className:"workspace-next-action",children:[t.jsx("p",{className:"workspace-next-action-eyebrow",children:"Next best action"}),t.jsx("p",{className:"workspace-next-action-summary",children:Ca.summary}),t.jsx("button",{className:"ghost-button",type:"button",onClick:Ca.onClick,disabled:Ca.disabled,children:Ca.label})]})]}),t.jsxs("div",{className:"workspace-section-actions",children:[t.jsx("button",{className:"primary-button workspace-primary-button",type:"button",onClick:Nn.onClick,disabled:Nn.disabled,children:Nn.label}),t.jsxs("div",{className:"workspace-secondary-actions",ref:ks,children:[t.jsx("button",{className:`ghost-button ${w?"active":""}`,type:"button",onClick:()=>x(a=>!a),"aria-expanded":w,"aria-controls":"workspace-actions-menu",children:"More actions"}),w?t.jsxs("div",{className:"workspace-actions-menu",id:"workspace-actions-menu",role:"menu","aria-label":"Workspace secondary actions",children:[t.jsx("button",{className:"ghost-button",type:"button",role:"menuitem",onClick:()=>{b(a=>!a),x(!1)},"aria-controls":"workspace-context-panel","aria-expanded":k,children:k?"Hide workspace tools":"Show workspace tools"}),t.jsx("button",{className:"ghost-button",type:"button",role:"menuitem",onClick:()=>{xe(!0),x(!1)},children:"Open guide"})]}):null]})]})]}),k?t.jsxs("section",{className:"workspace-context-panel",id:"workspace-context-panel","aria-labelledby":"workspace-section-title",children:[f==="journey"?t.jsxs("div",{className:"workspace-context-grid",children:[t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Track persona progress"}),t.jsx("p",{children:je==="executive"?"Executive mission path":je==="operator"?"Operator mission path":"Builder mission path"}),t.jsx("div",{className:"workspace-checklist",children:Co.map(a=>t.jsxs("div",{className:`workspace-check ${a.done?"done":""}`,children:[t.jsx("span",{children:a.done?"✓":"○"}),t.jsx("span",{children:a.label})]},a.label))})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Save and restore views"}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("input",{className:"search-input",placeholder:"Saved view name",value:dt,onChange:a=>ys(a.target.value),"aria-label":"Saved view name"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:kn,disabled:!!ht,children:"Save view"})]}),ht&&dt.trim()?t.jsx("p",{className:"workspace-error",children:ht}):null,t.jsxs("div",{className:"workspace-inline-form",children:[t.jsxs("select",{className:"search-select",value:He,onChange:a=>ba(a.target.value),"aria-label":"Saved views",children:[t.jsx("option",{value:"",children:"Select saved view"}),qe.map(a=>t.jsx("option",{value:a.id,children:a.name},a.id))]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>He&&jn(He),disabled:!He,children:"Apply"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:vo,disabled:!He,children:"Delete"})]})]})]}):null,f==="analysis"?t.jsxs("div",{className:"workspace-context-grid",children:[t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Track async actions"}),Nt.length===0?t.jsx("p",{children:"No tracked async actions yet."}):null,Nt.map(a=>t.jsxs("div",{className:`async-action-row status-${a.status}`,"data-status":a.status,children:[t.jsxs("div",{children:[t.jsx("strong",{children:a.label}),t.jsx("p",{children:a.detail})]}),t.jsxs("div",{className:"async-action-actions",children:[a.retryable?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Li(a.id),children:"Retry"}):null,a.resumable?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Fi(a.id),children:"Resume"}):null]})]},a.id))]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Run exports"}),de.exportCenterV1?null:t.jsx("p",{children:"Export center is disabled by feature flag."}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>ja(),disabled:!e||!de.exportCenterV1,children:"Queue narrative export"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{Vt({id:"export-support-diagnostics",label:"Support diagnostics JSON",run:()=>Cn("agent-director-support-diagnostics.json",JSON.stringify(wa,null,2),"application/json")})},disabled:!de.exportCenterV1,children:"Queue diagnostics export"})]}),de.exportCenterV1&&fs.length===0?t.jsx("p",{children:"No exports queued."}):null,fs.map(a=>t.jsxs("div",{className:`export-task-row status-${a.status}`,"data-status":a.status,children:[t.jsx("span",{children:a.label}),t.jsx("span",{children:a.detail}),a.retryable?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{var o,m;P("ux.export.retried",{taskId:a.id}),(m=(o=Rs.current)[a.id])==null||m.call(o)},children:"Retry"}):null]},a.id))]})]}):null,f==="collaboration"?t.jsxs("div",{className:"workspace-context-grid",children:[de.ownershipPanelV1?null:t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Enable ownership to continue"}),t.jsx("p",{children:"Enable the ownership panel feature flag in Operations to configure handoff ownership."})]}),de.ownershipPanelV1?t.jsxs(t.Fragment,{children:[t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Assign ownership and handoff"}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("input",{className:"search-input",value:qt,onChange:a=>Si(a.target.value),"aria-label":"Run owner",placeholder:"Run owner"}),t.jsx("input",{className:"search-input",value:zt,onChange:a=>Ni(a.target.value),"aria-label":"Handoff owner",placeholder:"Handoff owner"})]}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void It(),children:"Share live link"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void Sa(),children:"Copy handoff digest"})]})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Review collaboration activity"}),dn.length===0?t.jsx("p",{children:"No collaboration activity yet."}):null,t.jsx("div",{className:"workspace-feed",children:dn.slice(0,8).map(a=>t.jsxs("div",{className:"workspace-feed-item",children:[t.jsx("span",{children:new Date(a.timestamp).toLocaleTimeString()}),t.jsx("span",{children:a.message})]},a.id))})]})]}):null]}):null,f==="operations"?t.jsxs("div",{className:"workspace-context-grid",children:[t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:Z("setup_support_title")}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{Ze(!0),P("ux.setup.opened",{source:"operations_panel"})},disabled:!de.setupWizardV1,children:Z("open_setup_wizard")}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{Qt("operations_panel")},disabled:!de.supportPanelV1,children:Z("open_support_panel")})]}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:de.setupWizardV1,onChange:()=>Na("setupWizardV1")}),"Enable setup wizard"]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:de.supportPanelV1,onChange:()=>Na("supportPanelV1")}),"Enable support panel"]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:de.exportCenterV1,onChange:()=>Na("exportCenterV1")}),"Enable export center"]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:de.ownershipPanelV1,onChange:()=>Na("ownershipPanelV1")}),"Enable ownership panel"]})]})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:Z("telemetry_summary_title")}),t.jsx("p",{children:Z("telemetry_summary_body")}),t.jsx("div",{className:"workspace-inline-form",children:t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{const a=window.localStorage.getItem("agentDirector.analytics.events.v1")??"[]";Vt({id:"export-analytics-events",label:"Frontend analytics events",run:()=>Cn("agent-director-frontend-events.json",a,"application/json")})},children:Z("export_event_queue")})})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:Z("settings_center_title")}),t.jsx("p",{children:Z("settings_center_body")}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:ae,onChange:()=>I(a=>!a)}),Z("safe_export")]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:pa,onChange:()=>cs(a=>!a)}),Z("gamepad_enabled")]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:$e,onChange:()=>Oe(a=>!a)}),Z("timeline_windowing")]})]}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsxs("label",{children:[Z("theme_label"),t.jsxs("select",{className:"search-select",value:Rt,onChange:a=>Vn(a.target.value),children:[t.jsx("option",{value:"studio",children:"Studio"}),t.jsx("option",{value:"focus",children:"Focus"}),t.jsx("option",{value:"contrast",children:"Contrast"})]})]}),t.jsxs("label",{children:[Z("motion_label"),t.jsxs("select",{className:"search-select",value:ta,onChange:a=>Jn(a.target.value),children:[t.jsx("option",{value:"cinematic",children:"Cinematic"}),t.jsx("option",{value:"balanced",children:"Balanced"}),t.jsx("option",{value:"minimal",children:"Minimal"})]})]}),t.jsxs("label",{children:[Z("app_language_label"),t.jsx("select",{className:"search-select",value:bn,onChange:a=>fi(Ir(a.target.value)),children:ad.map(a=>t.jsx("option",{value:a.value,children:a.label},a.value))})]}),t.jsxs("label",{children:[Z("gameplay_locale_label"),t.jsxs("select",{className:"search-select",value:os,onChange:a=>ls(a.target.value),children:[t.jsx("option",{value:"en",children:"English"}),t.jsx("option",{value:"es",children:"Espanol"})]})]})]}),t.jsx("div",{className:"workspace-feed",children:Zt.map(a=>t.jsxs("label",{className:"workspace-inline-form",children:[t.jsx("span",{children:a.label}),t.jsx("select",{className:"search-select",value:ut[a.id],onChange:o=>wo(a.id,o.target.value),"aria-label":`${a.label} shortcut`,children:Bn.map(o=>t.jsx("option",{value:o,children:o.toUpperCase()},o))})]},a.id))})]})]}):null]}):t.jsx("p",{className:"workspace-panel-collapsed",id:"workspace-context-panel",children:"Workspace tools are hidden to reduce clutter. Use “Show workspace tools” when you need deeper controls."}),t.jsxs("section",{className:"toolbar","data-help":!0,"data-help-indicator":!0,"data-tour":"toolbar","data-help-title":"Search + filters","data-help-body":"Core controls stay visible. Open Advanced controls for TraceQL and extension diagnostics.","data-help-placement":"bottom","aria-labelledby":"workspace-toolbar-heading",children:[t.jsx("h2",{id:"workspace-toolbar-heading",className:"sr-only",children:"Controls"}),t.jsxs("div",{className:"toolbar-primary",children:[t.jsx(Uo,{query:j,typeFilter:V,onQueryChange:C,onTypeFilterChange:T}),t.jsxs("div",{className:"toolbar-mode-switcher",children:[t.jsx("button",{className:`ghost-button ${u==="cinema"?"active":""}`,type:"button","aria-pressed":u==="cinema",title:"Timeline playback",onClick:()=>ee("cinema"),"data-help":!0,"data-help-title":"Cinema mode","data-help-body":"Timeline view with step cards ordered by time.","data-help-placement":"bottom",children:Z("mode_cinema")}),t.jsx("button",{className:`ghost-button ${u==="flow"?"active":""}`,type:"button","aria-pressed":u==="flow",title:"Graph view",onClick:()=>ee("flow"),"data-help":!0,"data-help-title":"Flow mode","data-help-body":"Dependency graph of steps and tool calls.","data-help-placement":"bottom",children:Z("mode_flow")}),t.jsx("button",{className:`ghost-button ${u==="compare"?"active":""}`,type:"button","aria-pressed":u==="compare",title:z?"Side-by-side compare":"Run a replay to enable compare",onClick:()=>ee("compare"),disabled:!z,"data-tour":"compare","data-help":!0,"data-help-title":"Compare mode","data-help-body":"Side-by-side view after a replay. Enabled once you replay.","data-help-placement":"bottom",children:Z("mode_compare")}),t.jsx("button",{className:`ghost-button ${u==="matrix"?"active":""}`,type:"button","aria-pressed":u==="matrix",title:"Counterfactual replay matrix",onClick:()=>ee("matrix"),"data-help":!0,"data-help-title":"Matrix mode","data-help-body":"Run multiple replay scenarios and rank likely causal factors.","data-help-placement":"bottom",children:Z("mode_matrix")}),t.jsx("button",{className:`ghost-button ${u==="gameplay"?"active":""}`,type:"button","aria-pressed":u==="gameplay",title:"Gameplay mechanics command center",onClick:()=>ee("gameplay"),"data-help":!0,"data-help-title":"Gameplay mode","data-help-body":"Command raids, campaign, pvp, time forks, boss runs, economy, and liveops.","data-help-placement":"bottom",children:Z("mode_gameplay")})]})]}),t.jsxs("div",{className:"toolbar-utility",children:[t.jsxs("div",{className:"toolbar-toggle-group",children:[t.jsxs("label",{className:"toggle",title:"Redact payloads and disable raw views for safe sharing","data-help":!0,"data-help-title":"Safe export","data-help-body":"Redacts secrets and disables raw payload views for safe sharing.","data-help-placement":"bottom",children:[t.jsx("input",{type:"checkbox",checked:ae,onChange:()=>I(a=>!a)}),Z("safe_export")]}),e.steps.length>200||$e?t.jsxs("label",{className:"toggle",title:"Window steps around the playhead for large traces","data-help":!0,"data-help-title":"Windowed mode","data-help-body":"Limits rendering to a playhead window for large traces.","data-help-placement":"bottom",children:[t.jsx("input",{type:"checkbox",checked:$e,onChange:()=>Oe(a=>!a)}),Z("windowed")]}):null,z?t.jsxs("label",{className:"toggle",title:"Show ghost overlay of replay in Cinema/Flow","data-help":!0,"data-help-title":"Overlay replay","data-help-body":"Layer the replay over the base run to spot differences.","data-help-placement":"bottom",children:[t.jsx("input",{type:"checkbox",checked:$t,onChange:()=>Te(a=>!a)}),Z("overlay")]}):null,t.jsxs("label",{className:"toggle",title:"Follow active collaborator cursor and mode updates",children:[t.jsx("input",{type:"checkbox",checked:ue,onChange:()=>Ge(a=>!a)}),Z("sync_playback")]})]}),t.jsxs("div",{className:"toolbar-advanced-controls",children:[!S&&Ao?t.jsx("span",{className:"status-badge",children:"Advanced controls active"}):null,t.jsx("button",{className:`ghost-button ${S?"active":""}`,type:"button",onClick:()=>_(a=>!a),"aria-expanded":S,"aria-controls":"advanced-toolbar-panel",children:S?"Hide advanced controls":"Show advanced controls"})]})]}),S?t.jsxs("div",{className:"toolbar-advanced-panel",id:"advanced-toolbar-panel",children:[t.jsxs("div",{className:"toolbar-advanced-group",children:[t.jsx("input",{className:"search-input",value:R,onChange:a=>W(a.target.value),placeholder:Z("traceql_placeholder"),"aria-label":"TraceQL query"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void qi(),children:Z("run_traceql")}),q?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{W(""),L(null),re(null)},children:Z("clear_traceql")}):null]}),t.jsxs("div",{className:"toolbar-advanced-group",children:[t.jsxs("select",{className:"search-select",value:he,onChange:a=>Y(a.target.value),"aria-label":"Extension selector",children:[t.jsx("option",{value:"",children:Z("select_extension")}),E.map(a=>t.jsx("option",{value:a.id,children:a.name},a.id))]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void zi(),disabled:!e||!he||we,children:Z(we?"running_extension":"run_extension")})]}),t.jsxs("div",{className:"toolbar-advanced-status",children:[q?t.jsxs("span",{className:"status-badge",children:[q.matchCount," match(es)"]}):null,So?t.jsx("span",{className:"status-badge",children:"Filtering..."}):null,t.jsxs("span",{className:"status-badge",children:["Hydration ",No]}),t.jsxs("span",{className:"status-badge",children:["Filter ",Ci,"ms"]}),H?t.jsx("span",{className:"status-badge warn",children:H}):null]})]}):null]}),te?t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Extension output"}),t.jsx("pre",{className:"inspector-json",children:JSON.stringify(te,null,2)})]}):null,u==="cinema"?t.jsxs("div",{className:"playback-stack","data-tour":"playback",children:[t.jsx("div",{"data-help":!0,"data-help-title":"Playback controls","data-help-body":"Play, pause, scrub, and adjust speed to feel the rhythm of the run.","data-help-placement":"bottom",children:t.jsx(sr,{playheadMs:M,wallTimeMs:e.metadata.wallTimeMs||1,isPlaying:_e,speed:ge,onToggle:()=>fe(a=>!a),onScrub:a=>J(a),onSpeedChange:ke})}),t.jsx("div",{"data-help":!0,"data-help-title":"Density map","data-help-body":"Zoom into hotspots and keep long traces readable with windowing.","data-help-placement":"bottom",children:t.jsx(yl,{traceStart:e.startedAt,traceEnd:e.endedAt,steps:e.steps,playheadMs:M,windowRange:Vs,windowed:$e,spanMs:Aa,onSpanChange:Da,onToggleWindowed:Oe,onScrub:a=>J(a),persistenceKey:e.id,laneStrategy:ye,visibleLaneGroups:Ai,remotePlayheads:Di})})]}):null,u==="compare"&&z?t.jsx("div",{"data-help":!0,"data-help-title":"Compare playback","data-help-body":"Sync both runs to evaluate improvements at identical timestamps.","data-help-placement":"bottom",children:t.jsx(sr,{playheadMs:M,wallTimeMs:Math.max(e.metadata.wallTimeMs||1,z.metadata.wallTimeMs||1),isPlaying:_e,speed:ge,onToggle:()=>fe(a=>!a),onScrub:a=>J(a),onSpeedChange:ke})}):null,t.jsxs("main",{className:`stage ${u==="compare"?"stage-compare":""} motion-fade-in`,role:"main",children:[t.jsx("div",{className:"main motion-slide-up",ref:mn,"data-help":!0,"data-help-indicator":!0,"data-tour":"stage","data-help-title":"Trace stage","data-help-body":"Every step becomes a scene. Hover or click to open deep inspection.","data-help-placement":"top",children:t.jsx(Hl,{morph:ui,onComplete:fo,children:t.jsxs(l.Suspense,{fallback:t.jsx("div",{className:"loading",children:Z("loading_view")}),children:[u==="cinema"?t.jsx(dl,{trace:e,steps:Ls,selectedStepId:v,onSelectStep:a=>X(a),playheadMs:M,windowRange:Vs,timing:n==null?void 0:n.timing,ghostTrace:$t?z:null,diff:Ti,laneStrategy:ye,laneGroupsOrder:Mt.order,hiddenLaneGroups:Mt.hidden,onLaneStrategyChange:Gi,onToggleLaneGroupVisibility:Bi,onMoveLaneGroup:ao}):null,u==="flow"?t.jsx(Ed,{steps:Ls,selectedStepId:v,onSelectStep:a=>X(a),baseTrace:e,compareTrace:z,compareSteps:_i,overlayEnabled:$t,onToggleOverlay:()=>Te(a=>!a)}):null,u==="compare"&&z?t.jsx(Id,{baseTrace:e,compareTrace:z,playheadMs:M,safeExport:ae,onExit:()=>{h("cinema"),xt(null)}}):null,u==="matrix"?t.jsx(Td,{steps:e.steps,anchorStepId:Ja,onAnchorStepChange:Ka,scenarios:Qa,onScenarioChange:ro,onDuplicateScenario:co,onMoveScenario:uo,onAddScenario:oo,onRemoveScenario:lo,onRun:vn,onCancel:po,onReplaceScenarios:io,loading:pi,error:ca,job:at,matrix:Ee,safeExport:ae,onOpenCompare:mo}):null,u==="gameplay"?t.jsx(Ad,{state:oe,playheadMs:M,onUpdate:a=>Lt(o=>a(o)),session:pe,playerId:Ae,sessionError:da,onCreateSession:Wi,onQuickMatchSession:Hi,onJoinSession:Ui,onLeaveSession:Vi,onReconnectSession:Ji,onDispatchAction:Ki,guild:mi,social:hi,onInviteFriend:eo,onAcceptFriendInvite:to,locale:os,onLocaleChange:ls,gamepadEnabled:pa,onToggleGamepad:cs,gamepadPreset:Xa,onGamepadPresetChange:yi,isOnline:bi,onRetryConnectivity:Hs,onCreateGuild:Qi,onJoinGuild:Yi,onScheduleGuildEvent:Xi,onCompleteGuildEvent:Zi,observability:gi,analytics:xi}):null]})})}),t.jsx(l.Suspense,{fallback:t.jsx("div",{className:"loading",children:Z("loading_panel")}),children:u==="compare"||u==="matrix"||u==="gameplay"?null:qs?t.jsx(_d,{traceId:e.id,step:qs,safeExport:ae,onClose:()=>X(null),onReplay:Je}):t.jsx($l,{trace:e,mode:u,selectedStepId:v,onModeChange:ee,onSelectStep:a=>X(a),onJumpToBottleneck:Re,onReplay:Je,recommendations:We,persona:je,annotations:$i,activityFeed:dn,onAddAnnotation:so,missionProgress:na,missionCompletion:zs,onResetMissions:no,narrative:yt,onAskDirector:bo,onExportNarrative:ja})})]}),t.jsxs("div",{className:"mobile-quick-rail","aria-label":"Mobile quick actions",children:[t.jsx("button",{className:`ghost-button ${u==="cinema"?"active":""}`,type:"button",onClick:()=>ee("cinema"),"aria-label":"Open timeline mode",children:"Timeline"}),t.jsx("button",{className:`ghost-button ${u==="flow"?"active":""}`,type:"button",onClick:()=>ee("flow"),"aria-label":"Open flow graph mode",children:"Flow"}),t.jsx("button",{className:`ghost-button ${u==="compare"||u==="matrix"?"active":""}`,type:"button",onClick:()=>{y("analysis"),ee(z?"compare":"matrix")},"aria-label":"Open validation mode",children:"Validate"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>xe(!0),"aria-label":"Start guided tour",children:"Guide"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Be(!0),"aria-label":"Open command palette",children:"Command"})]}),t.jsx(zl,{mode:u==="matrix"||u==="gameplay"?"cinema":u,isPlaying:_e,storyActive:Tt,explainMode:Pe,hidden:u==="compare",open:si,onToggleOpen:()=>Pa(a=>!a),onTogglePlay:wn,onStartStory:_t,onStopStory:ot,onStartTour:()=>xe(!0),onOpenPalette:()=>Be(!0),onShowShortcuts:()=>Xe(!0),onToggleExplain:()=>Me(a=>!a),onJumpToBottleneck:Re}),t.jsx(Cl,{open:$a,onClose:()=>Be(!1),actions:Mo,context:{section:f,mode:u,persona:je},onActionRun:a=>P("ux.palette.command_run",{id:a.id,group:a.group??null})}),t.jsx(kl,{open:ti,onClose:()=>Xe(!1),bindings:ut})]})}Po.createRoot(document.getElementById("root")).render(t.jsx(Lo.StrictMode,{children:t.jsx(Fd,{})}));"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js")});export{nu as A,lu as B,su as C,ru as D,iu as E,ou as F,cu as G,pu as H,mu as I,uu as J,al as S,ll as T,Rc as a,Lc as b,ml as c,Wr as d,Bd as e,Gd as f,lc as g,Cn as h,Qc as i,Hd as j,Yc as k,Xc as l,Wd as m,Ud as n,du as o,Vd as p,Jd as q,Qd as r,Jo as s,Yd as t,Kd as u,Xd as v,Zd as w,eu as x,tu as y,au as z};
