const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-oebQSRbW.js","assets/vendor-react-D4yGots9.js","assets/vendor-DClHNS3s.js","assets/vendor-B5DZHykP.css","assets/index-CMT8YpUr.js","assets/index-DPcWxoFh.js","assets/index-DLGvXWER.js","assets/index-BdULIYZr.js"])))=>i.map(i=>d[i]);
import{j as t,r as d,a as eo,R as to}from"./vendor-react-D4yGots9.js";import{m as ao,d as Ba}from"./vendor-DClHNS3s.js";(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const no="modulepreload",so=function(e){return"/agent-director/"+e},Ha={},ut=function(a,n,s){let o=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),p=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));o=Promise.allSettled(n.map(c=>{if(c=so(c),c in Ha)return;Ha[c]=!0;const h=c.endsWith(".css"),f=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${f}`))return;const y=document.createElement("link");if(y.rel=h?"stylesheet":no,h||(y.as="script"),y.crossOrigin="",y.href=c,p&&y.setAttribute("nonce",p),document.head.appendChild(y),h)return new Promise((g,v)=>{y.addEventListener("load",g),y.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${c}`)))})}))}function r(l){const p=new Event("vite:preloadError",{cancelable:!0});if(p.payload=l,window.dispatchEvent(p),!p.defaultPrevented)throw l}return o.then(l=>{for(const p of l||[])p.status==="rejected"&&r(p.reason);return a().catch(r)})},oo=()=>t.jsxs("svg",{className:"logo-mark",width:"54",height:"54",viewBox:"0 0 120 120",role:"img","aria-label":"Agent Director logo",children:[t.jsx("rect",{x:"8",y:"8",width:"104",height:"104",rx:"18",className:"logo-frame"}),t.jsx("rect",{x:"24",y:"28",width:"72",height:"16",rx:"6",className:"logo-bar logo-bar-a"}),t.jsx("rect",{x:"24",y:"52",width:"72",height:"16",rx:"6",className:"logo-bar logo-bar-b"}),t.jsx("rect",{x:"24",y:"76",width:"72",height:"16",rx:"6",className:"logo-bar logo-bar-c"}),t.jsx("circle",{cx:"96",cy:"36",r:"6",className:"logo-node logo-node-a"}),t.jsx("circle",{cx:"96",cy:"60",r:"6",className:"logo-node logo-node-b"}),t.jsx("circle",{cx:"96",cy:"84",r:"6",className:"logo-node logo-node-c"})]});function io({trace:e,traces:a=[],selectedTraceId:n,onSelectTrace:s,onReload:o,onStartTour:r,onToggleStory:l,onOpenPalette:p,onToggleExplain:c,onShareSession:h,onThemeChange:f,onMotionChange:y,themeMode:g="studio",motionMode:v="balanced",activeSessions:x=1,shareStatus:m=null,handoffStatus:S=null,explainMode:k=!1,storyActive:T=!1,mode:z="cinema",missionCompletion:M,runHealthScore:D=100,modeHotkeys:q="C / F / Space",onCreateHandoffDigest:H}){const P=Math.max(0,Math.min(100,Math.round(D))),j=M?`${M.done}/${M.total} missions`:"Missions n/a";return t.jsxs("header",{className:"header","data-help":!0,"data-help-indicator":!0,"data-tour":"header","data-help-title":"Mission control","data-help-body":"Trace identity, status, and live controls live here. Use Story, Guide, or Explain to orient new viewers.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"header-title",children:[t.jsxs("div",{className:"header-logo",children:[t.jsx(oo,{}),t.jsx("span",{children:"Agent Director"})]}),t.jsx("div",{className:"header-tagline",children:"Cinematic trace intelligence for agent runs."}),t.jsxs("div",{className:"header-meta",children:[t.jsxs("span",{className:"header-run",children:["Run: ",(e==null?void 0:e.id)??"loading"]}),a.length>0?t.jsx("select",{className:"trace-select",value:n??(e==null?void 0:e.id)??"","aria-label":"Select trace",onChange:L=>s==null?void 0:s(L.target.value),"data-help":!0,"data-help-title":"Trace selector","data-help-body":"Switch between available runs to compare different sessions.","data-help-placement":"bottom",children:a.map(L=>t.jsxs("option",{value:L.id,children:[L.name," (",L.id,")"]},L.id))}):null,t.jsx("span",{className:`status-pill status-${(e==null?void 0:e.status)??"loading"}`,children:(e==null?void 0:e.status)??"loading"}),e!=null&&e.replay?t.jsxs("span",{className:"header-replay",title:`Replay from ${e.branchPointStepId??"unknown step"}`,children:["Replay: ",e.replay.strategy]}):null,t.jsxs("span",{className:"header-wall",children:["Wall: ",(e==null?void 0:e.metadata.wallTimeMs)??0,"ms"]}),t.jsxs("span",{className:"header-presence","aria-label":"Active sessions",children:["Live: ",x]}),t.jsxs("span",{className:"header-mode-pill","aria-label":"Current mode",children:["Mode: ",z]}),t.jsxs("span",{className:"header-hotkeys","aria-label":"Mode hotkeys",children:["Keys: ",q]}),t.jsx("span",{className:"header-mission","aria-label":"Mission completion",children:j}),t.jsxs("span",{className:"header-health","aria-label":`Run health score ${P}`,children:[t.jsx("span",{className:"header-health-bar",children:t.jsx("span",{className:"header-health-fill",style:{width:`${P}%`}})}),t.jsxs("span",{children:["Health ",P]})]}),m?t.jsx("span",{className:"header-share-status",children:m}):null,S?t.jsx("span",{className:"header-share-status",children:S}):null]})]}),t.jsxs("div",{className:"header-actions",children:[t.jsxs("label",{className:"theme-picker",children:["Theme",t.jsxs("select",{className:"trace-select",value:g,"aria-label":"Select theme",onChange:L=>f==null?void 0:f(L.target.value),children:[t.jsx("option",{value:"studio",children:"Studio"}),t.jsx("option",{value:"focus",children:"Focus"}),t.jsx("option",{value:"contrast",children:"Contrast"})]})]}),t.jsxs("label",{className:"theme-picker",children:["Motion",t.jsxs("select",{className:"trace-select",value:v,"aria-label":"Select motion profile",onChange:L=>y==null?void 0:y(L.target.value),children:[t.jsx("option",{value:"cinematic",children:"Cinematic"}),t.jsx("option",{value:"balanced",children:"Balanced"}),t.jsx("option",{value:"minimal",children:"Minimal"})]})]}),t.jsx("button",{className:`ghost-button ${T?"active":""}`,type:"button",onClick:l,"aria-pressed":T,"aria-label":"Toggle story mode","data-help":!0,"data-help-title":"Story mode","data-help-body":"Auto-runs a cinematic walkthrough for demos.","data-help-placement":"bottom",children:"Story"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:r,"aria-label":"Start guided tour","data-help":!0,"data-help-title":"Guided tour","data-help-body":"Walk through the interface step by step.","data-help-placement":"bottom",children:"Guide"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:p,"aria-label":"Open command palette","data-help":!0,"data-help-title":"Command palette","data-help-body":"Search and trigger any action instantly.","data-help-placement":"bottom",children:"Command"}),t.jsx("button",{className:`ghost-button ${k?"active":""}`,type:"button",onClick:c,"aria-pressed":k,"aria-label":"Toggle explain mode","data-help":!0,"data-help-title":"Explain mode","data-help-body":"Hover any control to see contextual guidance.","data-help-placement":"bottom",children:"Explain"}),t.jsx("button",{className:"ghost-button",onClick:o,type:"button","aria-label":"Refresh traces",title:"Refresh traces","data-help":!0,"data-help-title":"Refresh","data-help-body":"Reload traces from the data store.","data-help-placement":"bottom",children:"Refresh"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:h,"aria-label":"Copy live session link",title:"Copy live session link",children:"Share"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:H,"aria-label":"Copy session handoff digest",title:"Copy session handoff digest",children:"Handoff"}),t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer","data-help":!0,"data-help-title":"Help","data-help-body":"Open quick docs for first run, key flows, troubleshooting, and shortcuts.","data-help-placement":"bottom",children:"Help"}),null]})]})}function ro({insights:e,investigation:a,onSelectStep:n,onJumpToBottleneck:s,onJumpToError:o}){var g,v,x,m,S;if(!e)return null;const r=e.timing,l=e.ioWarnings??[],p=e.concurrency,c=e.retryPatterns,h=e.costByTool??{},f=e.costByModel??{},y=((g=a==null?void 0:a.hypotheses)==null?void 0:g.slice(0,2))??[];return t.jsxs("section",{className:"insight-strip","data-help":!0,"data-help-indicator":!0,"data-tour":"insights","data-help-title":"Run insights","data-help-body":"Fast diagnostics for latency, cost, errors, and concurrency. Click chips to jump into the trace.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Top latency","data-help-body":"Largest steps by duration; jump straight to the slowest.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Top latency"}),t.jsxs("div",{className:"insight-items",children:[e.topLatencySteps.map(k=>t.jsxs("button",{className:"insight-chip",type:"button",title:`Jump to ${k.name}`,onClick:()=>n==null?void 0:n(k.stepId),children:[k.name," (",k.durationMs,"ms)"]},k.stepId)),e.topLatencySteps.length>0?t.jsx("button",{className:"insight-chip",type:"button",onClick:s,title:"Jump to longest step",children:"Jump to bottleneck"}):null]})]}),t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Cost by type","data-help-body":"Aggregated spend by step class.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Cost by type"}),t.jsx("div",{className:"insight-items",children:Object.entries(e.costByType).map(([k,T])=>t.jsxs("span",{className:"insight-chip",title:`Total cost for ${k}`,children:[k,": $",T.toFixed(3)]},k))})]}),Object.keys(h).length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Cost by tool","data-help-body":"Top tools by total spend.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Cost by tool"}),t.jsx("div",{className:"insight-items",children:Object.entries(h).sort((k,T)=>T[1]-k[1]).slice(0,3).map(([k,T])=>t.jsxs("span",{className:"insight-chip",title:`Total cost for ${k}`,children:[k,": $",T.toFixed(3)]},k))})]}):null,t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Errors & retries","data-help-body":"Instant visibility into failed or retried steps.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Errors / retries"}),t.jsxs("div",{className:"insight-items",children:[t.jsxs("span",{className:"insight-chip",children:["Errors: ",e.errors]}),t.jsxs("span",{className:"insight-chip",children:["Retries: ",e.retries]}),e.errors>0?t.jsx("button",{className:"insight-chip",type:"button",onClick:o,title:"Jump to first error",children:"Jump to first error"}):null,(v=c==null?void 0:c.topRetries)!=null&&v.length?t.jsxs("span",{className:"insight-chip",title:`Retry rate ${(c.retryRate*100).toFixed(1)}%`,children:["Top retries: ",c.topRetries.length]}):null]})]}),t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Wall vs work","data-help-body":"Wall time vs summed work to show parallelism.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Wall vs work"}),t.jsxs("div",{className:"insight-items",children:[t.jsxs("span",{className:"insight-chip",title:"Wall clock duration",children:["Wall: ",e.wallTimeMs,"ms"]}),t.jsxs("span",{className:"insight-chip",title:"Sum of step durations",children:["Work: ",e.workTimeMs,"ms"]}),e.criticalPathMs!=null?t.jsxs("span",{className:"insight-chip",title:"Longest parent-child chain",children:["Critical: ",e.criticalPathMs,"ms"]}):null]})]}),t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Health","data-help-body":"Timing and I/O anomalies detected in the trace.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Health"}),t.jsxs("div",{className:"insight-items",children:[r!=null&&r.degraded?t.jsx("span",{className:"insight-chip insight-warning",title:r.issues.join(" "),children:"Timing degraded"}):t.jsx("span",{className:"insight-chip",children:"Timing OK"}),l.length>0?t.jsxs("span",{className:"insight-chip insight-warning",title:l.map(k=>k.message).join(" "),children:["IO warnings: ",l.length]}):t.jsx("span",{className:"insight-chip",children:"IO OK"})]})]}),y.length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Investigator","data-help-body":"Automated root-cause hypotheses ranked by severity and confidence.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Investigator"}),t.jsxs("div",{className:"insight-items",children:[y.map(k=>t.jsxs("span",{className:"insight-chip",title:k.summary,children:[k.title," (",Math.round(k.confidence*100),"%)"]},k.id)),(m=(x=y[0])==null?void 0:x.evidenceStepIds)!=null&&m[0]?t.jsx("button",{className:"insight-chip",type:"button",onClick:()=>n==null?void 0:n(y[0].evidenceStepIds[0]),children:"Jump to evidence"}):null]})]}):null,(S=p==null?void 0:p.buckets)!=null&&S.length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Parallelism","data-help-body":"How many steps ran concurrently over time.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Parallelism"}),t.jsx("div",{className:"insight-items",children:t.jsx("div",{className:"insight-heatmap",title:`Peak concurrency: ${p.peak}`,children:p.buckets.map((k,T)=>t.jsx("span",{className:"heatmap-bar",style:{height:`${Math.max(20,k.active/Math.max(1,p.peak)*48)}px`},title:`Bucket ${T+1}: ${k.active} active`},`${k.startMs}-${k.endMs}`))})})]}):null,Object.keys(f).length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Model cost","data-help-body":"Spend by model family.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Model cost"}),t.jsx("div",{className:"insight-items",children:Object.entries(f).map(([k,T])=>t.jsxs("span",{className:"insight-chip",title:`Total cost for ${k}`,children:[k,": $",T.toFixed(3)]},k))})]}):null]})}const lo=["all","llm_call","tool_call","decision","handoff","guardrail"];function co({query:e,typeFilter:a,onQueryChange:n,onTypeFilterChange:s}){return t.jsxs("div",{className:"search-bar",children:[t.jsx("input",{className:"search-input",placeholder:"Search steps, tools, previews...","aria-label":"Search steps",value:e,onChange:o=>n(o.target.value),"data-help":!0,"data-help-title":"Search","data-help-body":"Filter steps by name, tool, or payload preview. Great for fast recall.","data-help-placement":"bottom"}),t.jsx("select",{className:"search-select",value:a,"aria-label":"Filter by step type",onChange:o=>s(o.target.value),"data-help":!0,"data-help-title":"Type filter","data-help-body":"Narrow the timeline to a specific class of steps (LLM, tool, decision, handoff).","data-help-placement":"bottom",children:lo.map(o=>t.jsx("option",{value:o,children:o},o))})]})}function It(e,a,n){const s=Date.parse(e),o=n.map(f=>Date.parse(f.endedAt??f.startedAt)).filter(f=>Number.isFinite(f)),r=a?Date.parse(a):o.length?Math.max(...o):s,l=Math.max(1,r-s),p=n.map(f=>{const y=Math.max(0,Date.parse(f.startedAt)-s),g=Math.max(y,Date.parse(f.endedAt??f.startedAt)-s);return{stepId:f.id,startMs:y,endMs:g}}).sort((f,y)=>f.startMs-y.startMs||f.endMs-y.endMs),c=[],h=[];for(const f of p){let y=c.findIndex(g=>g<=f.startMs);y===-1?(y=c.length,c.push(f.endMs)):c[y]=f.endMs,h.push({stepId:f.stepId,startMs:f.startMs,endMs:f.endMs,lane:y,xPct:f.startMs/l*100,wPct:Math.max(.75,(f.endMs-f.startMs)/l*100)})}return{wallTimeMs:l,intervals:h,laneCount:c.length}}function uo(e){var x;const n=e.steps.map(m=>({stepId:m.id,name:m.name,durationMs:m.durationMs??0})).sort((m,S)=>S.durationMs-m.durationMs).slice(0,3),s={},o={};for(const m of e.steps)((x=m.metrics)==null?void 0:x.costUsd)!=null&&(s[m.type]=(s[m.type]??0)+m.metrics.costUsd,m.type==="tool_call"&&(o[m.name]=(o[m.name]??0)+m.metrics.costUsd));const r=e.steps.filter(m=>m.status==="failed").length,l=e.steps.filter(m=>!!m.retryOfStepId).length,p=e.metadata.wallTimeMs,c=e.metadata.workTimeMs??e.steps.reduce((m,S)=>m+(S.durationMs??0),0),h=mo(e),f=ho(e.steps),y=fo(e.steps),g=yo(e),v=bo(e.steps);return{topLatencySteps:n,costByType:s,costByTool:o,costByModel:{[e.metadata.modelId]:e.metadata.totalCostUsd??0},errors:r,retries:l,wallTimeMs:p,workTimeMs:c,timing:h,ioWarnings:f,criticalPathMs:y,concurrency:g,retryPatterns:v}}function po(e){var n;const a=(n=e.metrics)==null?void 0:n.costUsd;return a==null?null:`$${a.toFixed(3)}`}function $e(e){if(!e)return null;const a=Date.parse(e);return Number.isNaN(a)?null:a}function mo(e){const a=$e(e.startedAt),n=$e(e.endedAt??void 0),s=[],o=[],r=[];return a==null&&r.push("Trace start time missing or invalid."),e.steps.forEach(l=>{const p=$e(l.startedAt),c=$e(l.endedAt??l.startedAt);if(p==null||c==null){s.push(l.id);return}if(c<p){o.push(l.id);return}a!=null&&p<a&&o.push(l.id),n!=null&&c>n&&o.push(l.id)}),s.length&&r.push(`Missing timestamps on ${s.length} steps.`),o.length&&r.push(`Timestamp skew detected on ${o.length} steps.`),{degraded:!!(s.length||o.length||a==null),issues:r,missingStepIds:s,skewedStepIds:o}}function ho(e){const a=new Map;e.forEach(r=>{r.type==="tool_call"&&r.toolCallId&&a.set(r.toolCallId,r)});const n=new Set,s=new Set,o=[];return e.forEach(r=>{r.type!=="llm_call"||!r.io||((r.io.emittedToolCallIds??[]).forEach(l=>{n.add(l),a.has(l)||o.push({kind:"missing_tool_step",message:`Emitted toolCallId ${l} has no tool step.`,stepId:r.id,toolCallId:l})}),(r.io.consumedToolCallIds??[]).forEach(l=>{s.add(l),a.has(l)||o.push({kind:"missing_tool_step",message:`Consumed toolCallId ${l} has no tool step.`,stepId:r.id,toolCallId:l}),n.has(l)||o.push({kind:"consume_without_emit",message:`Consumed toolCallId ${l} without emission.`,stepId:r.id,toolCallId:l})}))}),a.forEach((r,l)=>{n.has(l)||o.push({kind:"unemitted_tool",message:`Tool step ${r.id} has toolCallId ${l} never emitted.`,stepId:r.id,toolCallId:l}),s.has(l)||o.push({kind:"unconsumed_tool",message:`Tool step ${r.id} has toolCallId ${l} never consumed.`,stepId:r.id,toolCallId:l})}),o}function fo(e){const a=new Map,n=new Map,s=[];e.forEach(l=>{if(a.set(l.id,l.durationMs??0),l.parentStepId){const p=n.get(l.parentStepId)??[];p.push(l.id),n.set(l.parentStepId,p)}else s.push(l.id)});const o=new Map,r=l=>{if(o.has(l))return o.get(l)??0;const c=(n.get(l)??[]).reduce((f,y)=>Math.max(f,r(y)),0),h=(a.get(l)??0)+c;return o.set(l,h),h};return s.length?Math.max(...s.map(l=>r(l))):0}function yo(e){const a=$e(e.startedAt);if(a==null)return{buckets:[],peak:0};const n=$e(e.endedAt??void 0)??Math.max(...e.steps.map(c=>$e(c.endedAt??c.startedAt)??a),a),s=Math.max(1,n-a),o=12,r=Math.max(1,Math.floor(s/o)),l=[];let p=0;for(let c=0;c<o;c+=1){const h=a+c*r,f=h+r;let y=0;e.steps.forEach(g=>{const v=$e(g.startedAt),x=$e(g.endedAt??g.startedAt);v==null||x==null||x>=h&&v<=f&&(y+=1)}),p=Math.max(p,y),l.push({startMs:c*r,endMs:(c+1)*r,active:y})}return{buckets:l,peak:p}}function bo(e){const a={};e.forEach(o=>{o.retryOfStepId&&(a[o.retryOfStepId]=(a[o.retryOfStepId]??0)+1)});const n=Object.values(a).reduce((o,r)=>o+r,0),s=Object.entries(a).sort((o,r)=>r[1]-o[1]).slice(0,3);return{totalRetries:n,retryRate:e.length?n/e.length:0,topRetries:s.map(([o,r])=>({stepId:o,count:r}))}}const go={llm_call:{label:"LLM",icon:"LLM",description:"Model call"},tool_call:{label:"TOOL",icon:"TOOL",description:"Tool call"},decision:{label:"DEC",icon:"DEC",description:"Decision"},handoff:{label:"HAND",icon:"HAND",description:"Handoff"},guardrail:{label:"GUARD",icon:"GUARD",description:"Guardrail"}};function xo(e){return go[e]}function vo({type:e,size:a="sm",showLabel:n=!1}){const s=xo(e);return t.jsxs("span",{className:`step-badge step-badge-${e} step-badge-${a}`,title:s.description,children:[t.jsx("span",{className:"step-badge-icon",children:s.icon}),n?t.jsx("span",{className:"step-badge-label",children:s.label}):null]})}function wn({step:e,interval:a,playbackState:n,selected:s,onSelect:o,variant:r="base",diffStatus:l,disabled:p=!1,laneHeight:c=140}){var M,D,q,H,P,j;const h=po(e),f=((M=e.preview)==null?void 0:M.subtitle)??((D=e.preview)==null?void 0:D.title)??"",y=((q=e.preview)==null?void 0:q.outputPreview)??((H=e.preview)==null?void 0:H.inputPreview)??"",g=l?`step-diff-${l}`:"",v=r==="ghost"?"step-ghost":"",x=a.wPct<8?"step-compact":"",m=e.type.replace("_"," ").toUpperCase(),S=((P=e.metrics)==null?void 0:P.tokensTotal)!=null?`${e.metrics.tokensTotal} tokens`:null,k=e.durationMs!=null?`${e.durationMs}ms`:null,T=[S,k,h].filter(Boolean).join(" · "),z=`Click to inspect inputs/outputs and replay from this moment.${T?` ${T}.`:""}`;return t.jsxs("button",{type:"button",className:`step-card step-${e.type} step-${n} ${s?"step-selected":""} ${g} ${v} ${x}`,"data-step-id":e.id,"aria-pressed":s,"aria-hidden":r==="ghost",disabled:p,"data-help":!0,"data-help-title":`${e.name} · ${m}`,"data-help-body":z,"data-help-placement":"top",style:{left:`${a.xPct}%`,width:`${a.wPct}%`,top:`${a.lane*c}px`},onClick:()=>{p||o(e.id)},children:[t.jsxs("div",{className:"step-card-header",children:[t.jsxs("div",{className:"step-title-group",children:[t.jsx(vo,{type:e.type}),t.jsx("span",{className:"step-title",children:e.name})]}),t.jsx("span",{className:`status-pill status-${e.status}`,children:e.status})]}),f?t.jsx("div",{className:"step-subtitle",children:f}):null,t.jsxs("div",{className:"step-metrics",children:[((j=e.metrics)==null?void 0:j.tokensTotal)!=null?t.jsxs("span",{children:[e.metrics.tokensTotal," tok"]}):null,e.durationMs!=null?t.jsxs("span",{children:[e.durationMs,"ms"]}):null,h?t.jsx("span",{children:h}):null]}),y?t.jsx("div",{className:"step-preview",children:y}):null]})}function kn(e,a){return a<e.startMs?"future":a>e.endMs?"past":"active"}const ct={type:{order:[],hidden:[]},status:{order:[],hidden:[]},parent:{order:[],hidden:[]}};function pa(e,a){return a==="type"?e.type:a==="status"?e.status:e.parentStepId??"root"}function wo(e,a){const n=new Set;return e.forEach(s=>n.add(pa(s,a))),Array.from(n).sort((s,o)=>s.localeCompare(o))}function Ua(e,a,n){const s=new Set(e),o=[...a.filter(l=>s.has(l))];e.forEach(l=>{o.includes(l)||o.push(l)});const r=Array.from(new Set(n.filter(l=>s.has(l))));return{order:o,hidden:r}}const ko=140,jo=132,So=96,Ja={llm_call:1,tool_call:2,decision:3,handoff:4,guardrail:5};function jn(e){return[...e].sort((a,n)=>(Ja[a.type]??9)-(Ja[n.type]??9))}function No(e,a,n,s,o){const r=new Map;a.forEach(g=>{var x;const v=pa(g,n);r.has(v)||r.set(v,[]),(x=r.get(v))==null||x.push(g)});const l=Array.from(r.keys()),p=[...s.filter(g=>l.includes(g))];l.forEach(g=>{p.includes(g)||p.push(g)});const c=p.filter(g=>!o.includes(g)),h=new Map;let f=0,y=0;return c.forEach(g=>{const v=r.get(g)??[],x=It(e.startedAt,e.endedAt,v);x.intervals.forEach(m=>{h.set(m.stepId,{...m,lane:m.lane+f})}),f+=Math.max(1,x.laneCount)}),y=Math.max(1,f),{intervalsByStepId:h,laneCount:y,visibleGroups:c}}function Mo({trace:e,steps:a,selectedStepId:n,onSelectStep:s,playheadPct:o,playheadMs:r,windowRange:l,ghostTrace:p,diff:c,laneStrategy:h="type",laneGroupsOrder:f=[],hiddenLaneGroups:y=[],laneHeight:g=ko,cardHeight:v=jo,compactHeight:x=So}){const{intervalsByStepId:m,laneCount:S}=No(e,a,h,f,y),k=Array.from(m.values()),T=new Map(k.map(I=>[I.stepId,I])),z=jn(a),M=e.metadata.wallTimeMs||1,D=new Set((c==null?void 0:c.removedSteps)??[]),q=new Set((c==null?void 0:c.changedSteps)??[]),H=new Set(((c==null?void 0:c.changedPairs)??[]).map(I=>I.rightId)),P=new Set((c==null?void 0:c.addedSteps)??[]);let j=k;if(l){const I=l.endMs-l.startMs,C=Math.max(1e3,I*.15),R=Math.max(0,l.startMs-C),W=l.endMs+C;if(j=k.filter(A=>A.endMs>=R&&A.startMs<=W),n&&!j.some(A=>A.stepId===n)){const A=T.get(n);A&&(j=[...j,A])}}const L=new Set(j.map(I=>I.stepId));return t.jsx("div",{className:"timeline",style:{"--step-card-height":`${v}px`,"--step-compact-height":`${x}px`},children:t.jsxs("div",{className:"timeline-grid",style:{height:`${S*g}px`},"data-help":!0,"data-help-title":"Timeline lanes","data-help-body":"Each lane stacks overlapping steps; width reflects duration.","data-help-placement":"top",children:[t.jsx("div",{className:"playback-cursor",style:{left:`${o}%`}}),z.filter(I=>L.has(I.id)).filter(I=>!y.includes(pa(I,h))).map(I=>{const C=T.get(I.id);if(!C)return null;const R=kn(C,r);return t.jsx(wn,{step:I,interval:C,playbackState:R,selected:n===I.id,diffStatus:D.has(I.id)?"removed":q.has(I.id)?"changed":null,laneHeight:g,onSelect:s},I.id)}),p?t.jsx(Co,{ghostTrace:p,baseWallTimeMs:M,playheadMs:r,windowRange:l,diffAdded:P,diffChanged:H,laneHeight:g}):null]})})}function Co({ghostTrace:e,baseWallTimeMs:a,playheadMs:n,windowRange:s,diffAdded:o,diffChanged:r,laneHeight:l}){const{intervals:p,laneCount:c}=It(e.startedAt,e.endedAt,e.steps),h=new Map(p.map(m=>[m.stepId,m])),f=e.metadata.wallTimeMs||1,y=n/a*f;let g=p;if(s){const m=s.endMs-s.startMs,S=Math.max(1e3,m*.15),k=f/a,T=Math.max(0,(s.startMs-S)*k),z=Math.min(f,(s.endMs+S)*k);g=p.filter(M=>M.endMs>=T&&M.startMs<=z)}const v=new Set(g.map(m=>m.stepId)),x=jn(e.steps);return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"ghost-lanes",style:{height:`${c*l}px`}}),x.filter(m=>v.has(m.id)).map(m=>{const S=h.get(m.id);if(!S)return null;const k=kn(S,y),T=o.has(m.id)?"added":r.has(m.id)?"changed":null;return t.jsx(wn,{step:m,interval:S,playbackState:k,selected:!1,diffStatus:T,variant:"ghost",disabled:!0,laneHeight:l,onSelect:()=>{}},`ghost-${m.id}`)})]})}function Io({trace:e,steps:a,selectedStepId:n,onSelectStep:s,playheadMs:o,windowRange:r,timing:l,ghostTrace:p,diff:c,laneStrategy:h,laneGroupsOrder:f,hiddenLaneGroups:y,onLaneStrategyChange:g,onToggleLaneGroupVisibility:v,onMoveLaneGroup:x}){const m=e.metadata.wallTimeMs||1,S=Math.min(100,Math.max(0,o/m*100)),k=f.filter(T=>!y.includes(T)).length;return t.jsxs("section",{className:"cinema-mode","aria-label":"Cinema mode",children:[l!=null&&l.degraded?t.jsxs("div",{className:"timing-banner",title:l.issues.join(" "),children:["Timing degraded: ",l.issues[0]??"Check timestamps."]}):null,t.jsxs("div",{className:"timeline-studio-panel","data-help":!0,"data-help-title":"Timeline studio","data-help-body":"Regroup lanes by type/status/parent, hide noisy groups, and reorder emphasis.",children:[t.jsxs("label",{className:"timeline-studio-strategy",children:["Lane strategy",t.jsxs("select",{value:h,onChange:T=>g(T.target.value),children:[t.jsx("option",{value:"type",children:"Type"}),t.jsx("option",{value:"status",children:"Status"}),t.jsx("option",{value:"parent",children:"Parent branch"})]})]}),t.jsxs("div",{className:"timeline-studio-summary",children:[k,"/",f.length," groups visible"]}),t.jsx("div",{className:"timeline-studio-groups",children:f.map((T,z)=>{const M=y.includes(T);return t.jsxs("div",{className:`timeline-studio-group ${M?"is-hidden":""}`,children:[t.jsx("button",{type:"button",className:"ghost-button",onClick:()=>v(T),children:M?"Show":"Hide"}),t.jsx("span",{className:"timeline-studio-group-name",children:T}),t.jsx("button",{type:"button",className:"ghost-button",onClick:()=>x(T,"up"),disabled:z===0,children:"Up"}),t.jsx("button",{type:"button",className:"ghost-button",onClick:()=>x(T,"down"),disabled:z===f.length-1,children:"Down"})]},T)})})]}),t.jsx(Mo,{trace:e,steps:a,selectedStepId:n,onSelectStep:s,playheadPct:S,playheadMs:o,windowRange:r,ghostTrace:p,diff:c,laneStrategy:h,laneGroupsOrder:f,hiddenLaneGroups:y})]})}const Eo=[.5,1,1.5,2,4];function za({playheadMs:e,wallTimeMs:a,isPlaying:n,speed:s,onToggle:o,onScrub:r,onSpeedChange:l}){const p=c=>{r(Number(c.target.value))};return t.jsxs("div",{className:"playback-controls",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:o,"aria-label":n?"Pause playback":"Play playback","data-help":!0,"data-help-title":"Playhead","data-help-body":"Start or pause the run to experience timing as it unfolded.","data-help-placement":"bottom",children:n?"Pause":"Play"}),t.jsx("input",{className:"playback-slider",type:"range",min:0,max:a,value:e,"aria-label":"Playback position",onChange:p,"data-help":!0,"data-help-title":"Scrub timeline","data-help-body":"Drag to jump to any moment in the run.","data-help-placement":"bottom"}),t.jsx("select",{className:"playback-speed",value:s,"aria-label":"Playback speed",onChange:c=>l(Number(c.target.value)),"data-help":!0,"data-help-title":"Speed","data-help-body":"Slow down to inspect or speed up to skim.","data-help-placement":"bottom",children:Eo.map(c=>t.jsxs("option",{value:c,children:[c,"x"]},c))})]})}function To(e,a,n,s=60){const{wallTimeMs:o,intervals:r}=It(e,a,n),l=new Array(s).fill(0);if(!o)return{buckets:l,wallTimeMs:0};const p=o/s;return!Number.isFinite(p)||p<=0?{buckets:l,wallTimeMs:o}:(r.forEach(c=>{const h=Math.max(0,Math.floor(c.startMs/p)),f=Math.min(s-1,Math.floor(c.endMs/p));for(let y=h;y<=f;y+=1)l[y]+=1}),{buckets:l,wallTimeMs:o})}function Do(e,a){const n=new Blob([JSON.stringify(a,null,2)],{type:"application/json"}),s=URL.createObjectURL(n),o=document.createElement("a");o.href=s,o.download=e,document.body.appendChild(o),o.click(),o.remove(),URL.revokeObjectURL(s)}function Ao(e,a,n="text/plain"){const s=new Blob([a],{type:n}),o=URL.createObjectURL(s),r=document.createElement("a");r.href=o,r.download=e,document.body.appendChild(r),r.click(),r.remove(),URL.revokeObjectURL(o)}const dt=5e3,$o=32;function xe(e,a,n){return Math.min(n,Math.max(a,e))}function tt(e,a){const n=new Set;return e.forEach(s=>{n.add(xe(Math.round(s),0,a))}),Array.from(n).sort((s,o)=>s-o).slice(0,$o)}function _o(e,a){if(!e)return{bookmarksMs:[],clipStartMs:null,clipEndMs:null,segments:[]};try{const n=JSON.parse(e),s=tt(Array.isArray(n.bookmarksMs)?n.bookmarksMs:[],a),o=typeof n.clipStartMs=="number"?xe(n.clipStartMs,0,a):null,r=typeof n.clipEndMs=="number"?xe(n.clipEndMs,0,a):null,l=Array.isArray(n.segments)?n.segments.filter(p=>typeof(p==null?void 0:p.id)=="string"&&typeof(p==null?void 0:p.startMs)=="number"&&typeof(p==null?void 0:p.endMs)=="number"&&typeof(p==null?void 0:p.label)=="string").map(p=>({...p,startMs:xe(p.startMs,0,a),endMs:xe(p.endMs,0,a)})):[];return{bookmarksMs:s,clipStartMs:o,clipEndMs:o!=null&&r!=null&&r<o?o:r,segments:l}}catch{return{bookmarksMs:[],clipStartMs:null,clipEndMs:null,segments:[]}}}function Wa(e,a){const n=Date.parse(e);return Number.isNaN(n)?null:new Date(n+a).toISOString()}function Ro({traceStart:e,traceEnd:a,steps:n,playheadMs:s,windowRange:o,windowed:r,spanMs:l,onSpanChange:p,onToggleWindowed:c,onScrub:h,persistenceKey:f,laneStrategy:y="type",visibleLaneGroups:g=[],remotePlayheads:v=[]}){const{buckets:x,wallTimeMs:m}=To(e,a,n,64),S=Math.max(1,...x),k=xe(l,dt,Math.max(dt,m)),T=(o==null?void 0:o.startMs)??0,z=(o==null?void 0:o.endMs)??m,M=d.useMemo(()=>`agentDirector.timelineStudio.${f??e}`,[f,e]),[D,q]=d.useState([]),[H,P]=d.useState(null),[j,L]=d.useState(null),[I,C]=d.useState([]),[R,W]=d.useState("");d.useEffect(()=>{const E=_o(window.localStorage.getItem(M),m);q(E.bookmarksMs),P(E.clipStartMs),L(E.clipEndMs),C(E.segments)},[M,m]),d.useEffect(()=>{const E={bookmarksMs:tt(D,m),clipStartMs:H==null?null:xe(H,0,m),clipEndMs:j==null?null:xe(j,0,m),segments:I};window.localStorage.setItem(M,JSON.stringify(E))},[D,j,H,I,M,m]);const A=m?T/m*100:0,ae=m?(z-T)/m*100:100,ue=m?s/m*100:0,se=H!=null&&j!=null?Math.min(H,j):null,ne=H!=null&&j!=null?Math.max(H,j):null,ve=se!=null&&ne!=null&&m?(ne-se)/m*100:0,U=se!=null&&m?se/m*100:0,N=se!=null&&ne!=null&&ne>se,oe=E=>{const J=E.currentTarget.getBoundingClientRect(),he=(E.clientX-J.left)/J.width,me=xe(Math.round(he*m),0,m);h(me)},K=E=>{if(E.key==="ArrowLeft"){E.preventDefault(),h(xe(s-Math.max(250,Math.round(m*.02)),0,m));return}if(E.key==="ArrowRight"){E.preventDefault(),h(xe(s+Math.max(250,Math.round(m*.02)),0,m));return}if(E.key==="Home"){E.preventDefault(),h(0);return}if(E.key==="End"){E.preventDefault(),h(m);return}(E.key===" "||E.key==="Enter")&&(E.preventDefault(),h(s))},ie=()=>{q(E=>tt([...E,s],m))},O=E=>{if(D.length===0)return;const J=tt(D,m);if(E==="previous"){const me=[...J].reverse().find(qe=>qe<s)??J[J.length-1];h(me);return}const he=J.find(me=>me>s)??J[0];h(he)},ce=()=>{const E=xe(s,0,m);P(E),j!=null&&j<E&&L(E)},be=()=>{const E=xe(s,0,m);L(E),H!=null&&H>E&&P(E)},Fe=()=>{P(null),L(null)},Re=()=>{if(!N||se==null||ne==null)return;const E=R.trim()||`Scene ${I.length+1}`,J=`segment-${Math.random().toString(36).slice(2,9)}`;C(he=>[...he,{id:J,startMs:se,endMs:ne,label:E}]),W("")},at=E=>{C(J=>J.filter(he=>he.id!==E))},mt=()=>{if(!N||se==null||ne==null)return;const E={type:"agent-director-clip",traceStart:e,traceEnd:a,clip:{startMs:se,endMs:ne,startAt:Wa(e,se),endAt:Wa(e,ne)},bookmarksMs:tt(D,m).filter(J=>J>=se&&J<=ne),playheadMs:s,laneContext:{strategy:y,visibleGroups:g},segments:I.filter(J=>J.endMs>=se&&J.startMs<=ne),exportedAt:new Date().toISOString()};Do(`agent-director-clip-${se}-${ne}.json`,E)};return t.jsxs("div",{className:"mini-timeline",children:[t.jsxs("div",{className:"mini-track",onClick:oe,role:"slider",tabIndex:0,"aria-label":"Timeline density map","aria-valuemin":0,"aria-valuemax":m,"aria-valuenow":s,"aria-valuetext":`${s} milliseconds`,onKeyDown:K,"data-help":!0,"data-help-title":"Density map","data-help-body":"A compact view of activity density. Click to jump the playhead.","data-help-placement":"top",children:[t.jsx("div",{className:"mini-bars",children:x.map((E,J)=>t.jsx("span",{className:"mini-bar",style:{height:`${E/S*100}%`}},`bucket-${J}`))}),t.jsx("div",{className:"mini-window",style:{left:`${A}%`,width:`${ae}%`,opacity:r?1:.4}}),N?t.jsx("div",{className:"mini-clip-window",style:{left:`${U}%`,width:`${ve}%`}}):null,t.jsx("div",{className:"mini-bookmark-markers","data-testid":"timeline-bookmark-markers","aria-hidden":"true",children:tt(D,m).map(E=>{const J=m?E/m*100:0;return t.jsx("button",{type:"button",className:"mini-bookmark-marker",style:{left:`${J}%`},onClick:he=>{he.stopPropagation(),h(E)},title:`Jump to bookmark at ${E}ms`,"aria-label":`Bookmark ${E} milliseconds`},`bookmark-${E}`)})}),t.jsx("div",{className:"mini-remote-markers","aria-hidden":"true",children:v.map((E,J)=>{const he=m?E/m*100:0;return t.jsx("span",{className:"mini-remote-marker",style:{left:`${he}%`}},`remote-${J}`)})}),t.jsx("div",{className:"mini-segments","aria-hidden":"true",children:I.map(E=>{const J=m?E.startMs/m*100:0,he=m?(E.endMs-E.startMs)/m*100:0;return t.jsx("span",{className:"mini-segment-bar",style:{left:`${J}%`,width:`${Math.max(1,he)}%`},title:E.label},E.id)})}),t.jsx("div",{className:"mini-playhead",style:{left:`${ue}%`}})]}),t.jsxs("div",{className:"mini-controls",children:[t.jsx("label",{className:"mini-label",children:"Zoom"}),t.jsx("input",{type:"range",min:dt,max:Math.max(dt,m),value:k,"aria-label":"Timeline zoom",onChange:E=>{c(!0),p(Number(E.target.value))},"data-help":!0,"data-help-title":"Zoom window","data-help-body":"Tighten the window to focus on hotspots.","data-help-placement":"top"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>c(!r),title:"Toggle windowed playback",children:r?"Full":"Window"}),t.jsx("button",{className:"ghost-button",type:"button",title:"Reset zoom",onClick:()=>{c(!0),p(Math.min(Math.max(m*.2,dt),6e4))},children:"Reset"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:ie,children:"Add bookmark"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>O("previous"),children:"Previous bookmark"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>O("next"),children:"Next bookmark"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:ce,children:"Set clip start"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:be,children:"Set clip end"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:Fe,children:"Clear clip"}),t.jsx("input",{className:"search-input mini-segment-input",placeholder:"Segment label",value:R,onChange:E=>W(E.target.value),"aria-label":"Segment label"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:Re,disabled:!N,children:"Add segment"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:mt,disabled:!N,children:"Export clip"})]}),I.length?t.jsx("div",{className:"mini-segment-list",children:I.map(E=>t.jsxs("div",{className:"mini-segment-item",children:[t.jsxs("span",{children:[E.label," (",E.startMs,"ms - ",E.endMs,"ms)"]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>at(E.id),children:"Remove"})]},E.id))}):null]})}const Oo=[{keys:"Space",action:"Play / pause"},{keys:"← / →",action:"Step boundary back / forward"},{keys:"Shift + ← / →",action:"Jump to start / end"},{keys:"F",action:"Toggle Flow mode"},{keys:"I",action:"Toggle Inspector"},{keys:"S",action:"Story mode"},{keys:"E",action:"Explain mode"},{keys:"T",action:"Start tour"},{keys:"Cmd/Ctrl + K",action:"Open command palette"},{keys:"?",action:"Show shortcuts"},{keys:"Esc",action:"Close modal / inspector"}];function Lo({open:e,onClose:a}){const n=d.useRef(null);if(d.useEffect(()=>{var o;e&&((o=n.current)==null||o.focus())},[e]),!e)return null;const s=o=>{var c;if(o.key==="Escape"){o.preventDefault(),a();return}if(o.key!=="Tab")return;const r=Array.from(o.currentTarget.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'));if(r.length===0)return;const l=r.indexOf(document.activeElement),p=o.shiftKey?l<=0?r.length-1:l-1:(l+1)%r.length;(c=r[p])==null||c.focus(),o.preventDefault()};return t.jsx("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true","aria-labelledby":"shortcuts-title",onKeyDown:s,children:t.jsxs("div",{className:"modal",tabIndex:-1,children:[t.jsxs("div",{className:"modal-header",children:[t.jsx("div",{className:"modal-title",id:"shortcuts-title",children:"Keyboard Shortcuts"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:a,ref:n,"aria-label":"Close shortcuts",children:"Close"})]}),t.jsx("div",{className:"modal-body",children:Oo.map(o=>t.jsxs("div",{className:"modal-row",children:[t.jsx("span",{className:"modal-keys",children:o.keys}),t.jsx("span",{className:"modal-action",children:o.action})]},o.keys))})]})})}const Ka="agentDirector.palette.recent.v1",Ya="agentDirector.palette.pinned.v1",Po=8,Fo=12,qo=e=>e.trim().toLowerCase();function Qa(e){try{const a=JSON.parse(window.localStorage.getItem(e)??"[]");return Array.isArray(a)?a.filter(n=>typeof n=="string"):[]}catch{return[]}}function Va(e,a){window.localStorage.setItem(e,JSON.stringify(a))}function Go(e){const a=new Map;return e.forEach(n=>{var o;const s=n.section;a.has(s)||a.set(s,[]),(o=a.get(s))==null||o.push(n)}),a}function Za(e,a,n){var o;if(!e.length)return 0;let s=a;for(let r=0;r<e.length;r+=1)if(s=(s+n+e.length)%e.length,!((o=e[s])!=null&&o.disabled))return s;return a}function Bo({open:e,onClose:a,actions:n}){var H,P;const[s,o]=d.useState(""),[r,l]=d.useState(0),[p,c]=d.useState([]),[h,f]=d.useState([]),y=d.useRef(null),g=d.useRef(null),v=d.useMemo(()=>{const j=qo(s);return j?n.filter(L=>[L.label,L.description,L.group,L.keys].filter(Boolean).join(" ").toLowerCase().includes(j)):n},[n,s]),x=d.useMemo(()=>{const j=new Map(v.map(R=>[R.id,R])),L=h.map(R=>j.get(R)).filter(R=>!!R).map(R=>({...R,section:"Pinned"})),I=p.map(R=>j.get(R)).filter(R=>!!R).filter(R=>!L.some(W=>W.id===R.id)).map(R=>({...R,section:"Recent"})),C=v.filter(R=>!L.some(W=>W.id===R.id)).filter(R=>!I.some(W=>W.id===R.id)).map(R=>({...R,section:R.group??"General"}));return[...L,...I,...C]},[v,h,p]),m=d.useMemo(()=>Go(x),[x]),S=d.useMemo(()=>n.filter(j=>(j.group??"").toLowerCase()==="macros"||j.id.startsWith("macro-")),[n]);if(d.useEffect(()=>{if(!e)return;o(""),l(0),c(Qa(Ka)),f(Qa(Ya));const j=window.setTimeout(()=>{var L;return(L=y.current)==null?void 0:L.focus()},0);return()=>window.clearTimeout(j)},[e]),d.useEffect(()=>{r>=x.length&&l(0)},[r,x.length]),!e)return null;const k=j=>{c(L=>{const I=[j,...L.filter(C=>C!==j)].slice(0,Po);return Va(Ka,I),I})},T=j=>{j.disabled||(k(j.id),j.onTrigger(),a())},z=j=>{f(L=>{const I=L.includes(j)?L.filter(C=>C!==j):[j,...L].slice(0,Fo);return Va(Ya,I),I})},M=j=>{var L,I;if(j.key==="Escape"){j.preventDefault(),a();return}if(j.key==="ArrowDown"){j.preventDefault(),l(C=>Za(x,C,1));return}if(j.key==="ArrowUp"){j.preventDefault(),l(C=>Za(x,C,-1));return}if(j.key==="Enter"){j.preventDefault();const C=x[r];C&&T(C);return}if(j.key==="Tab"){const C=Array.from(((L=g.current)==null?void 0:L.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'))??[]);if(!C.length)return;const R=C.indexOf(document.activeElement),W=j.shiftKey?R<=0?C.length-1:R-1:(R+1)%C.length;(I=C[W])==null||I.focus(),j.preventDefault()}},D=(H=x[r])!=null&&H.id?`palette-option-${(P=x[r])==null?void 0:P.id}`:void 0;let q=-1;return t.jsx("div",{className:"modal-backdrop palette-backdrop",role:"dialog","aria-modal":"true","aria-label":"Command palette",onKeyDown:M,onMouseDown:j=>{j.target===j.currentTarget&&a()},children:t.jsxs("div",{className:"palette",ref:g,children:[t.jsxs("div",{className:"palette-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"palette-title",children:"Command palette"}),t.jsx("div",{className:"palette-subtitle",children:"Search actions, modes, and playbook steps."})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:a,"aria-label":"Close command palette",children:"Close"})]}),t.jsx("input",{ref:y,className:"palette-input",value:s,onChange:j=>o(j.target.value),placeholder:"Type to filter actions…","aria-label":"Search commands",role:"combobox","aria-expanded":"true","aria-controls":"command-palette-list","aria-activedescendant":D,"aria-autocomplete":"list"}),!s.trim()&&S.length>0?t.jsxs("div",{className:"palette-macros",children:[t.jsx("div",{className:"palette-group-title",children:"Quick macros"}),t.jsx("div",{className:"palette-macro-list",children:S.slice(0,3).map(j=>t.jsx("button",{className:"ghost-button palette-macro-item",type:"button",onClick:()=>T(j),children:j.label},j.id))})]}):null,t.jsxs("div",{className:"palette-list",role:"listbox",id:"command-palette-list",children:[x.length===0?t.jsx("div",{className:"palette-empty",children:"No matching commands."}):null,Array.from(m.entries()).map(([j,L])=>t.jsxs("div",{className:"palette-group",children:[t.jsx("div",{className:"palette-group-title",children:j}),t.jsx("div",{className:"palette-group-list",children:L.map(I=>{q+=1;const C=q===r,R=h.includes(I.id);return t.jsxs("button",{id:`palette-option-${I.id}`,className:`palette-item ${C?"active":""}`,type:"button",role:"option","aria-selected":C,onMouseEnter:()=>l(q),onClick:()=>T(I),disabled:I.disabled,children:[t.jsxs("div",{className:"palette-item-main",children:[t.jsx("div",{className:"palette-item-title",children:I.label}),I.description?t.jsx("div",{className:"palette-item-description",children:I.description}):null]}),t.jsxs("div",{className:"palette-item-trailing",children:[I.keys?t.jsx("div",{className:"palette-item-keys",children:I.keys}):null,t.jsx("span",{className:`palette-pin ${R?"active":""}`,role:"button",tabIndex:0,onClick:W=>{W.stopPropagation(),z(I.id)},onKeyDown:W=>{W.key!=="Enter"&&W.key!==" "||(W.preventDefault(),W.stopPropagation(),z(I.id))},"aria-label":R?`Unpin ${I.label}`:`Pin ${I.label}`,title:R?"Unpin command":"Pin command",children:R?"★":"☆"})]})]},I.id)})})]},j))]})]})})}function Ho(e){return e.length?e.reduce((a,n)=>(n.durationMs??0)>(a.durationMs??0)?n:a,e[0]):null}function Uo({trace:e,mode:a,playheadMs:n,selectedStepId:s,compareTrace:o,collapsed:r,onToggleCollapsed:l,onModeChange:p,onSelectStep:c,onJumpToBottleneck:h,onReplay:f,onStartTour:y,priorityQueue:g=[]}){var I;const v=e.steps??[],x=Ho(v),m=s??(x==null?void 0:x.id)??((I=v[0])==null?void 0:I.id)??null,S=a==="cinema"||n>0,k=!!s,T=!!o,z=[S,k,T].filter(Boolean).length,M=[S,k,T].findIndex(C=>!C),D=M===-1?2:M,q=[0,1,2].map(C=>[S,k,T][C]?"done":C===D?"active":"next"),H=[{id:"observe",title:"Act I: Observe",summary:"Scrub the timeline to feel the pacing, bottlenecks, and tool choreography.",status:q[0],actionLabel:"Enter cinema",action:()=>p("cinema"),tasks:[{label:"Scrub the timeline",done:n>0},{label:"Stay in Cinema mode",done:a==="cinema"}]},{id:"inspect",title:"Act II: Inspect",summary:"Open the most expensive or failed step and read the payload with context.",status:q[1],actionLabel:x?"Jump to bottleneck":"Select first step",action:()=>{if(s){p("cinema");return}if(x){h();return}m&&(c(m),p("cinema"))},disabled:!m,tasks:[{label:"Open the Inspector",done:!!s},{label:"Jump to the bottleneck",done:!!(x&&s===x.id)}]},{id:"direct",title:"Act III: Direct",summary:"Replay from a decisive step, then compare flows and diffs side-by-side.",status:q[2],actionLabel:o?"Open compare":"Replay from step",action:()=>{if(o){p("compare");return}m&&f(m)},disabled:!m,tasks:[{label:"Replay from a step",done:!!o},{label:"Compare runs side-by-side",done:!!(o&&a==="compare")}]}],P=H[D],L=g.filter(C=>!C.done)[0];return r?t.jsxs("section",{className:"journey-panel journey-collapsed","aria-label":"Director journey","data-help":!0,"data-help-indicator":!0,"data-tour":"journey","data-help-title":"Director journey","data-help-body":"A guided path from observation to replay. Use it to show newcomers what to do first.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"journey-collapsed-main",children:[t.jsx("div",{className:"journey-eyebrow",children:"Director journey"}),t.jsx("div",{className:"journey-collapsed-title",children:"From observe to direct"})]}),t.jsxs("div",{className:"journey-collapsed-actions",children:[t.jsxs("span",{className:"journey-progress-text",children:[z,"/3 complete"]}),L?t.jsxs("span",{className:`journey-priority-chip severity-${L.severity}`,children:["Next priority: ",L.title]}):null,P?t.jsxs("button",{className:"primary-button journey-next",type:"button",onClick:P.action,disabled:P.disabled,children:["Next: ",P.actionLabel]}):null,y?t.jsx("button",{className:"ghost-button",type:"button",onClick:y,children:"Tour"}):null,t.jsx("button",{className:"primary-button journey-expand",type:"button",onClick:l,children:"Expand"})]})]}):t.jsxs("section",{className:"journey-panel","aria-label":"Director journey","data-help":!0,"data-help-indicator":!0,"data-tour":"journey","data-help-title":"Director journey","data-help-body":"A three-act flow that teaches the story: observe, inspect, direct. Each act jumps to the right place.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"journey-head",children:[t.jsxs("div",{children:[t.jsx("div",{className:"journey-eyebrow",children:"Director journey"}),t.jsx("h2",{className:"journey-title",children:"Cut a perfect take in three acts."}),t.jsx("p",{className:"journey-subtitle",children:"Trace the performance, interrogate the moment, then direct a better run."})]}),t.jsxs("div",{className:"journey-head-actions",children:[y?t.jsx("button",{className:"ghost-button",type:"button",onClick:y,children:"Start tour"}):null,t.jsx("button",{className:"ghost-button",type:"button",onClick:l,children:"Collapse"})]})]}),t.jsx("div",{className:"journey-track",children:H.map((C,R)=>{var W;return t.jsxs("div",{className:"journey-card","data-status":C.status,children:[t.jsxs("div",{className:"journey-card-top",children:[t.jsxs("span",{className:"journey-index",children:["0",R+1]}),t.jsx("span",{className:"journey-status",children:C.status})]}),t.jsx("h3",{className:"journey-card-title",children:C.title}),t.jsx("p",{className:"journey-card-body",children:C.summary}),(W=C.tasks)!=null&&W.length?t.jsx("ul",{className:"journey-tasks",children:C.tasks.map(A=>t.jsxs("li",{className:`journey-task ${A.done?"done":""}`,children:[t.jsx("span",{className:"journey-task-icon","aria-hidden":"true",children:A.done?"✓":"○"}),t.jsx("span",{children:A.label})]},A.label))}):null,t.jsx("button",{className:"primary-button journey-action",type:"button",onClick:C.action,disabled:C.disabled,children:C.actionLabel})]},C.id)})}),t.jsxs("div",{className:"journey-footer",children:[t.jsxs("div",{children:[t.jsx("div",{className:"journey-progress-label",children:"Progress"}),t.jsx("div",{className:"journey-progress",children:t.jsx("span",{className:"journey-progress-bar",style:{width:`${z/3*100}%`}})})]}),t.jsx("div",{className:"journey-footnote",children:"Tip: Use Flow to spot fan-out, Compare to validate your changes."})]}),g.length?t.jsxs("div",{className:"journey-priority-queue",children:[t.jsxs("div",{className:"journey-priority-head",children:[t.jsx("div",{className:"journey-progress-label",children:"Priority queue"}),t.jsxs("span",{children:[g.filter(C=>C.done).length,"/",g.length," resolved"]})]}),t.jsx("div",{className:"journey-priority-list",children:g.map(C=>t.jsxs("article",{className:`journey-priority-item ${C.done?"done":""}`,children:[t.jsxs("div",{className:"journey-priority-main",children:[t.jsx("span",{className:`journey-priority-chip severity-${C.severity}`,children:C.severity}),t.jsxs("div",{children:[t.jsx("div",{className:"journey-priority-title",children:C.title}),t.jsx("div",{className:"journey-priority-body",children:C.detail})]})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:C.onAction,disabled:C.done,children:C.done?"Resolved":C.actionLabel})]},C.id))})]}):null]})}const Jo=[],zo=[],Wo=[],Ko={};function Yo(e){return e.length?e.reduce((a,n)=>(n.durationMs??0)>(a.durationMs??0)?n:a,e[0]):null}function Qo({trace:e,mode:a,selectedStepId:n,onModeChange:s,onSelectStep:o,onJumpToBottleneck:r,onReplay:l,recommendations:p=Jo,persona:c="builder",annotations:h=zo,activityFeed:f=Wo,onAddAnnotation:y,missionProgress:g=Ko,missionCompletion:v,onResetMissions:x,narrative:m="",onAskDirector:S,onExportNarrative:k}){var ie;const T=e.steps??[],z=Yo(T),M=n??(z==null?void 0:z.id)??((ie=T[0])==null?void 0:ie.id)??null,D=e.metadata.wallTimeMs??0,q=c==="executive"?"Executive lens":c==="operator"?"Operator lens":"Builder lens",[H,P]=d.useState(""),[j,L]=d.useState(""),[I,C]=d.useState(""),[R,W]=d.useState("overview"),[A,ae]=d.useState([]),ue=d.useMemo(()=>f.slice(0,6),[f]),se=(v==null?void 0:v.done)??0,ne=se>=3||!!g.inspect,ve=se>=5||!!g.collaborate||ue.length>0,U=d.useMemo(()=>p.slice(0,3).map((O,ce)=>({id:O.id,step:`${ce+1}. ${O.actionLabel} — ${O.title}`})),[p]);d.useEffect(()=>{ae(O=>O.filter(ce=>p.some(be=>be.id===ce)))},[p]);const N=A.filter(O=>p.some(ce=>ce.id===O)).length,oe=p.length?Math.round(N/p.length*100):0,K=O=>{O.action(),ae(ce=>ce.includes(O.id)?ce:[...ce,O.id])};return t.jsxs("aside",{className:"inspector inspector-empty","data-help":!0,"data-help-indicator":!0,"data-tour":"inspector","data-help-title":"Inspector panel","data-help-body":"Select a step to open detailed payloads, redaction controls, and replay actions.","data-help-placement":"left",children:[t.jsx("div",{className:"inspector-header",children:t.jsxs("div",{children:[t.jsx("div",{className:"inspector-title",children:"Director's notes"}),t.jsxs("div",{className:"inspector-subtitle",children:[q,". Select a step to open deep inspection."]})]})}),t.jsxs("div",{className:"director-tabs",role:"tablist","aria-label":"Director workspace tabs",children:[t.jsx("button",{className:`ghost-button ${R==="overview"?"active":""}`,type:"button",role:"tab","aria-selected":R==="overview",onClick:()=>W("overview"),children:"Overview"}),t.jsx("button",{className:`ghost-button ${R==="narrative"?"active":""}`,type:"button",role:"tab","aria-selected":R==="narrative",onClick:()=>W("narrative"),children:"Narrative"}),t.jsx("button",{className:`ghost-button ${R==="collab"?"active":""}`,type:"button",role:"tab","aria-selected":R==="collab",onClick:()=>W("collab"),children:"Collaboration"})]}),R==="overview"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Run summary"}),t.jsxs("div",{className:"inspector-row",children:[t.jsx("span",{children:"Steps"}),t.jsx("span",{children:T.length})]}),t.jsxs("div",{className:"inspector-row",children:[t.jsx("span",{children:"Wall time"}),t.jsxs("span",{children:[D,"ms"]})]}),t.jsxs("div",{className:"inspector-row",children:[t.jsx("span",{children:"Status"}),t.jsx("span",{children:e.status})]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Next actions"}),t.jsxs("div",{className:"director-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>s("cinema"),"data-help":!0,"data-help-title":"Open cinema","data-help-body":"Jump straight into the timeline.","data-help-placement":"right",children:"Open cinema"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>s("flow"),"data-help":!0,"data-help-title":"Open flow","data-help-body":"See the dependency graph of the run.","data-help-placement":"right",children:"Switch to flow"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{if(!n){if(z){r();return}M&&o(M)}},disabled:!M||!!n,"data-help":!0,"data-help-title":"Jump to bottleneck","data-help-body":"Select the slowest step for inspection.","data-help-placement":"right",children:n?"Inspector open":z?"Jump to bottleneck":"Select first step"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>M&&l(M),disabled:!M||!ne,title:ne?void 0:"Complete core missions to unlock replay guidance.","data-help":!0,"data-help-title":"Replay","data-help-body":"Branch a replay from a decisive step.","data-help-placement":"right",children:"Replay from step"})]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Mode"}),t.jsxs("div",{className:"director-modes",children:[t.jsx("button",{className:`ghost-button ${a==="cinema"?"active":""}`,type:"button",onClick:()=>s("cinema"),"data-help":!0,"data-help-title":"Cinema mode","data-help-body":"Timeline view for pacing and sequence.","data-help-placement":"right",children:"Cinema"}),t.jsx("button",{className:`ghost-button ${a==="flow"?"active":""}`,type:"button",onClick:()=>s("flow"),"data-help":!0,"data-help-title":"Flow mode","data-help-body":"Graph view for dependencies.","data-help-placement":"right",children:"Flow"}),t.jsx("button",{className:"ghost-button",type:"button",disabled:!0,children:"Compare"})]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Adaptive missions"}),t.jsxs("div",{className:"mission-summary",children:[(v==null?void 0:v.done)??0,"/",(v==null?void 0:v.total)??0," complete",t.jsxs("span",{children:[(v==null?void 0:v.pct)??0,"%"]})]}),t.jsxs("div",{className:"mission-stage",children:["Stage: ",ve?"Collaboration":ne?"Analysis":"Foundation"]}),t.jsx("div",{className:"mission-grid",children:Object.entries(g).map(([O,ce])=>t.jsxs("div",{className:`mission-chip ${ce?"done":""}`,children:[t.jsx("span",{children:O}),t.jsx("span",{children:ce?"Done":"Pending"})]},O))}),t.jsx("button",{className:"ghost-button",type:"button",onClick:x,children:"Reset missions"})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Action plan"}),ne?p.length===0?t.jsx("div",{className:"annotation-empty",children:"No recommendations generated yet."}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"mission-summary",children:[N,"/",p.length," complete",t.jsxs("span",{children:[oe,"%"]})]}),t.jsx("div",{className:"director-recommendations",children:p.map(O=>{const ce=A.includes(O.id);return t.jsxs("article",{className:`director-recommendation tone-${O.tone} ${ce?"done":""}`,children:[t.jsx("div",{className:"director-recommendation-title",children:O.title}),t.jsx("p",{className:"director-recommendation-body",children:O.body}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>K(O),children:ce?"Completed":O.actionLabel})]},O.id)})})]}):t.jsx("div",{className:"annotation-empty",children:"Complete inspect/flow/replay missions to unlock AI narrative tools."}),ve?null:t.jsx("div",{className:"annotation-empty",children:"Open another live session to unlock collaboration activity feed."})]})]}):null,R==="narrative"?t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"AI director narrative"}),ne?t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"director-recommendation-body",children:m}),U.length?t.jsx("div",{className:"director-guided-plan",children:U.map(O=>t.jsx("div",{children:O.step},O.id))}):null,t.jsxs("div",{className:"director-ask-row",children:[t.jsx("input",{className:"search-input",value:j,onChange:O=>L(O.target.value),placeholder:"Ask Director (e.g. what is highest risk?)","aria-label":"Ask director question"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{j.trim()&&C((S==null?void 0:S(j))??"")},children:"Ask"})]}),I?t.jsx("div",{className:"director-answer",children:I}):null,t.jsx("button",{className:"ghost-button",type:"button",onClick:k,children:"Export narrative"})]}):t.jsx("div",{className:"annotation-empty",children:"Complete inspect/flow/replay missions to unlock AI narrative tools."})]}):null,R==="collab"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Shared annotations"}),t.jsx("textarea",{value:H,onChange:O=>P(O.target.value),rows:3,placeholder:n?"Add note for selected step...":"Add trace-level note...","aria-label":"Shared annotation"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{const O=H.trim();O&&(y==null||y(O,n),P(""))},children:"Add annotation"}),t.jsxs("div",{className:"annotation-list",children:[h.slice(-6).reverse().map(O=>t.jsxs("article",{className:"annotation-item",children:[t.jsxs("div",{className:"annotation-meta",children:[t.jsx("span",{children:O.stepId?`step ${O.stepId}`:"trace"}),t.jsx("span",{children:O.authorSessionId})]}),t.jsx("p",{children:O.body})]},O.id)),h.length===0?t.jsx("div",{className:"annotation-empty",children:"No shared annotations yet."}):null]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Collab activity"}),ve?t.jsxs("div",{className:"activity-list",children:[ue.map(O=>t.jsxs("div",{className:"activity-item",children:[t.jsx("span",{children:O.message}),t.jsx("span",{children:new Date(O.timestamp).toLocaleTimeString()})]},O.id)),ue.length===0?t.jsx("div",{className:"annotation-empty",children:"No activity yet."}):null]}):t.jsx("div",{className:"annotation-empty",children:"Open another live session to unlock collaboration activity feed."})]})]}):null]})}const oa=(e,a,n)=>Math.min(n,Math.max(a,e));function ia(e){return Array.from((e==null?void 0:e.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'))??[]).filter(n=>!(n.hasAttribute("disabled")||n.getAttribute("aria-hidden")==="true"))}function Vo({steps:e,open:a,onClose:n,onComplete:s}){const[o,r]=d.useState(0),[l,p]=d.useState(null),[c,h]=d.useState(null),f=d.useRef(null),y=d.useRef(null),g=d.useRef(null),v=d.useMemo(()=>e[o],[e,o]),x=d.useCallback(()=>{if(!a)return;const M=document.querySelector(v.target);if(!M){y.current=null,p(null);return}y.current=M;const D=M.getBoundingClientRect();p(D)},[a,v.target]),m=d.useCallback(()=>{if(!l||!f.current){h(null);return}const M=f.current.offsetWidth,D=f.current.offsetHeight,q=16;let H=oa(l.left+l.width/2-M/2,q,window.innerWidth-M-q),P=l.bottom+16;v.placement==="top"&&(P=l.top-D-16),v.placement==="left"&&(H=l.left-M-16,P=l.top+l.height/2-D/2),v.placement==="right"&&(H=l.right+16,P=l.top+l.height/2-D/2),P+D>window.innerHeight-q&&(P=l.top-D-16),P<q&&(P=l.bottom+16),H=oa(H,q,window.innerWidth-M-q),P=oa(P,q,window.innerHeight-D-q),h({top:P,left:H})},[v.placement,l]);if(d.useEffect(()=>{a&&r(0)},[a]),d.useEffect(()=>{var D,q;if(!a){(q=(D=g.current)==null?void 0:D.focus)==null||q.call(D);return}g.current=document.activeElement;const M=window.setTimeout(()=>{var P;(P=ia(f.current)[0]??f.current)==null||P.focus()},0);return()=>window.clearTimeout(M)},[a]),d.useEffect(()=>{if(!a)return;const M=document.querySelector(v.target);M&&M.scrollIntoView({behavior:"smooth",block:"center",inline:"center"});const D=window.requestAnimationFrame(()=>x());return()=>window.cancelAnimationFrame(D)},[a,v.target,x]),d.useLayoutEffect(()=>{m()},[l,m,v.title]),d.useEffect(()=>{if(!a)return;const M=()=>{x(),m()};return window.addEventListener("resize",M),window.addEventListener("scroll",M,!0),()=>{window.removeEventListener("resize",M),window.removeEventListener("scroll",M,!0)}},[a,x,m]),d.useEffect(()=>{if(!a)return;const M=D=>{var L;if(D.key==="Escape"){D.preventDefault(),n();return}if(D.key!=="Tab")return;const q=ia(f.current);if(!q.length)return;const H=document.activeElement,P=q.indexOf(H),j=D.shiftKey?P<=0?q.length-1:P-1:(P+1)%q.length;(L=q[j])==null||L.focus(),D.preventDefault()};return document.addEventListener("keydown",M,!0),()=>document.removeEventListener("keydown",M,!0)},[n,a]),!a||!v)return null;const S=M=>{var j;if(M.key==="Escape"){M.preventDefault(),n();return}if(M.key!=="Tab")return;const D=ia(f.current);if(D.length===0)return;const q=document.activeElement,H=D.indexOf(q),P=M.shiftKey?H<=0?D.length-1:H-1:(H+1)%D.length;(j=D[P])==null||j.focus(),M.preventDefault()},k=`tour-title-${v.id}`,T=`tour-body-${v.id}`,z=l?{top:l.top-6,left:l.left-6,width:l.width+12,height:l.height+12}:void 0;return t.jsxs("div",{className:"tour-overlay",role:"dialog","aria-modal":"true","aria-label":"Guided tour","aria-labelledby":k,"aria-describedby":T,onKeyDown:S,children:[t.jsx("div",{className:"tour-backdrop",onClick:n}),l?t.jsx("div",{className:"tour-spotlight",style:z}):null,t.jsxs("div",{className:`tour-card ${c?"tour-card-anchored":""}`,ref:f,style:c??void 0,tabIndex:-1,children:[t.jsxs("div",{className:"tour-step",children:["Step ",o+1," of ",e.length]}),t.jsx("div",{className:"tour-title",id:k,children:v.title}),t.jsx("p",{className:"tour-body",id:T,children:v.body}),t.jsxs("div",{className:"tour-actions",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>r(M=>Math.max(0,M-1)),disabled:o===0,children:"Back"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:n,children:"Skip"}),o===e.length-1?t.jsx("button",{className:"primary-button",type:"button",onClick:s,children:"Finish tour"}):t.jsx("button",{className:"primary-button",type:"button",onClick:()=>r(M=>M+1),children:"Next"})]})]})]})}const Xa=(e,a,n)=>Math.min(n,Math.max(a,e));function Zo({enabled:e}){const[a,n]=d.useState(null),[s,o]=d.useState(null),r=d.useRef(null),l=d.useRef(null),p=d.useCallback(()=>{const h=r.current;if(!h){n(null);return}const f=h.getBoundingClientRect(),y=h.dataset.helpTitle??"Context",g=h.dataset.helpBody??"",v=h.dataset.helpPlacement??"right";n({rect:f,title:y,body:g,placement:v})},[]);d.useEffect(()=>{if(!e){r.current=null,n(null);return}const h=x=>{var S,k;const m=(k=(S=x.target)==null?void 0:S.closest)==null?void 0:k.call(S,"[data-help]");if(!m){r.current||n(null);return}r.current!==m&&(r.current=m,p())},f=x=>{var S,k;const m=(k=(S=x.target)==null?void 0:S.closest)==null?void 0:k.call(S,"[data-help]");m&&(r.current=m,p())},y=x=>{var S;const m=x.relatedTarget;(S=m==null?void 0:m.closest)!=null&&S.call(m,"[data-help]")||(r.current=null,n(null))},g=x=>{var S,k;const m=(k=(S=x.target)==null?void 0:S.closest)==null?void 0:k.call(S,"[data-help]");if(!m){r.current=null,n(null);return}r.current=m,p()},v=()=>{r.current&&p()};return window.addEventListener("mousemove",h),window.addEventListener("focusin",f),window.addEventListener("focusout",y),window.addEventListener("pointerdown",g),window.addEventListener("scroll",v,!0),window.addEventListener("resize",v),()=>{window.removeEventListener("mousemove",h),window.removeEventListener("focusin",f),window.removeEventListener("focusout",y),window.removeEventListener("pointerdown",g),window.removeEventListener("scroll",v,!0),window.removeEventListener("resize",v)}},[e,p]);const c=d.useCallback(()=>{if(!a||!l.current){o(null);return}const h=12,f=l.current.offsetWidth,y=l.current.offsetHeight,{rect:g,placement:v}=a;let x=g.right+16,m=g.top+g.height/2-y/2;v==="left"&&(x=g.left-f-16,m=g.top+g.height/2-y/2),v==="top"&&(x=g.left+g.width/2-f/2,m=g.top-y-16),v==="bottom"&&(x=g.left+g.width/2-f/2,m=g.bottom+16),x=Xa(x,h,window.innerWidth-f-h),m=Xa(m,h,window.innerHeight-y-h),o({left:x,top:m})},[a]);return d.useLayoutEffect(()=>{c()},[c]),!e||!a?null:t.jsxs("div",{className:"help-overlay","aria-hidden":"true",children:[t.jsx("div",{className:"help-highlight",style:{top:a.rect.top-6,left:a.rect.left-6,width:a.rect.width+12,height:a.rect.height+12}}),t.jsxs("div",{className:"help-bubble",ref:l,style:s??void 0,"data-placement":a.placement,children:[t.jsx("div",{className:"help-title",children:a.title}),t.jsx("div",{className:"help-body",children:a.body})]})]})}const Xo=[{id:"builder",label:"Builder lens",body:"Focus on step payloads, execution paths, and replay control."},{id:"executive",label:"Executive lens",body:"Focus on bottlenecks, risk, and outcome-level run quality."},{id:"operator",label:"Operator lens",body:"Focus on failures, retries, and trace reliability posture."}],ei=[{id:"rapid_triage",label:"Rapid triage",body:"Jump straight to the highest-risk step and start resolution.",estimate:"2-3 min"},{id:"deep_diagnosis",label:"Deep diagnosis",body:"Open flow and guided analysis for full root-cause exploration.",estimate:"8-12 min"},{id:"team_sync",label:"Team sync",body:"Open collaborative mode and prep a handoff workflow.",estimate:"4-6 min"}];function ti({onComplete:e,onStartTour:a,onStartStory:n,persona:s="builder",onPersonaChange:o,launchPath:r="rapid_triage",onLaunchPathChange:l,onStartLaunchPath:p}){const c=()=>{a==null||a(),e()},h=()=>{n==null||n(),e()},f=y=>{l==null||l(y),p==null||p(y),e()};return t.jsx("div",{className:"intro-overlay",role:"dialog","aria-modal":"true","aria-label":"Agent Director intro",children:t.jsxs("div",{className:"intro-card",children:[t.jsx("div",{className:"intro-scan"}),t.jsx("div",{className:"intro-title",children:"Agent Director"}),t.jsx("div",{className:"intro-tagline",children:"Watch your agent think. Then direct it."}),t.jsxs("div",{className:"intro-steps",children:[t.jsxs("div",{className:"intro-step",children:[t.jsx("div",{className:"intro-step-label",children:"Observe"}),t.jsx("div",{className:"intro-step-body",children:"Scrub the timeline to feel pacing and parallelism."})]}),t.jsxs("div",{className:"intro-step",children:[t.jsx("div",{className:"intro-step-label",children:"Inspect"}),t.jsx("div",{className:"intro-step-body",children:"Open the bottleneck to read payloads and costs."})]}),t.jsxs("div",{className:"intro-step",children:[t.jsx("div",{className:"intro-step-label",children:"Direct"}),t.jsx("div",{className:"intro-step-body",children:"Replay from a decisive step and compare runs."})]})]}),t.jsx("div",{className:"intro-personas",role:"group","aria-label":"Select onboarding lens",children:Xo.map(y=>t.jsxs("button",{type:"button",className:`ghost-button intro-persona ${s===y.id?"active":""}`,onClick:()=>o==null?void 0:o(y.id),"aria-pressed":s===y.id,"aria-label":y.label,children:[t.jsx("span",{className:"intro-persona-label",children:y.label}),t.jsx("span",{className:"intro-persona-body",children:y.body})]},y.id))}),t.jsx("div",{className:"intro-launch-paths",role:"group","aria-label":"Select launch path",children:ei.map(y=>t.jsxs("article",{className:`intro-path-card ${r===y.id?"active":""}`,children:[t.jsxs("button",{type:"button",className:`ghost-button intro-path-button ${r===y.id?"active":""}`,onClick:()=>l==null?void 0:l(y.id),"aria-pressed":r===y.id,"aria-label":y.label,children:[t.jsx("span",{className:"intro-path-label",children:y.label}),t.jsx("span",{className:"intro-path-estimate",children:y.estimate}),t.jsx("span",{className:"intro-path-body",children:y.body})]}),t.jsxs("button",{className:"primary-button intro-path-start",type:"button",onClick:()=>f(y.id),children:["Start ",y.label]})]},y.id))}),t.jsxs("div",{className:"intro-grid",children:[t.jsx("span",{}),t.jsx("span",{}),t.jsx("span",{}),t.jsx("span",{})]}),t.jsxs("div",{className:"intro-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:c,children:"Start guided tour"}),n?t.jsx("button",{className:"ghost-button",type:"button",onClick:h,children:"Play story mode"}):null,t.jsx("button",{className:"ghost-button",type:"button",onClick:e,children:"Skip intro"})]})]})})}function ai({explainMode:e,storyActive:a,onStartTour:n,onStartStory:s,onToggleExplain:o,onDismiss:r}){return t.jsxs("section",{className:"hero-ribbon","aria-label":"Director briefing","data-help":!0,"data-help-indicator":!0,"data-tour":"hero","data-help-title":"Director briefing","data-help-body":"Start the tour, play story mode, or enable explain to learn the interface instantly.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"hero-ribbon-top",children:[t.jsx("span",{className:"hero-eyebrow",children:"Director briefing"}),t.jsx("button",{className:"ghost-button hero-dismiss",type:"button",onClick:r,children:"Dismiss"})]}),t.jsx("div",{className:"hero-title",children:"Observe. Inspect. Direct."}),t.jsx("div",{className:"hero-subtitle",children:"A cinematic control room for agent traces. See time, read structure, then replay with confidence."}),t.jsxs("div",{className:"hero-pills",children:[t.jsx("span",{className:"hero-pill","data-tone":"observe",children:"Observe"}),t.jsx("span",{className:"hero-pill","data-tone":"inspect",children:"Inspect"}),t.jsx("span",{className:"hero-pill","data-tone":"direct",children:"Direct"})]}),t.jsxs("div",{className:"hero-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:n,children:"Start guided tour"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:s,disabled:a,children:a?"Story running":"Play story mode"}),t.jsxs("button",{className:`ghost-button ${e?"active":""}`,type:"button",onClick:o,"aria-pressed":e,children:["Explain ",e?"On":"Off"]})]})]})}function ni({mode:e,isPlaying:a,storyActive:n,explainMode:s,hidden:o=!1,open:r,onToggleOpen:l,onTogglePlay:p,onStartStory:c,onStopStory:h,onStartTour:f,onOpenPalette:y,onShowShortcuts:g,onToggleExplain:v,onJumpToBottleneck:x}){if(o)return null;const m=a?"Pause":"Play",S=n?"Stop story":"Story mode";return r?t.jsxs("aside",{className:"quick-actions","aria-label":"Quick actions","data-help":!0,"data-help-indicator":!0,"data-tour":"quick-actions","data-help-title":"Quick actions","data-help-body":"Launch story mode, open the command palette, or jump to the bottleneck instantly.","data-help-placement":"left",children:[t.jsxs("div",{className:"quick-actions-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"quick-actions-title",children:"Quick actions"}),t.jsx("div",{className:"quick-actions-subtitle",children:"Pin demo controls close at hand."})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:l,"aria-label":"Collapse quick actions",children:"Collapse"})]}),t.jsxs("button",{className:`quick-action ${a?"active":""}`,type:"button",onClick:p,"aria-label":m,"data-help":!0,"data-help-title":"Play or pause","data-help-body":"Start or stop playback from anywhere.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:m}),t.jsx("span",{className:"quick-action-meta",children:e==="flow"?"Cinema":"Space"})]}),t.jsxs("button",{className:`quick-action ${n?"active":""}`,type:"button",onClick:n?h:c,"aria-label":S,"data-help":!0,"data-help-title":"Story mode","data-help-body":"Auto-runs a cinematic walkthrough of the run.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:S}),t.jsx("span",{className:"quick-action-meta",children:"S"})]}),t.jsxs("button",{className:"quick-action",type:"button",onClick:y,"aria-label":"Open command palette","data-help":!0,"data-help-title":"Command palette","data-help-body":"Search every action and jump instantly.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Command"}),t.jsx("span",{className:"quick-action-meta",children:"Cmd+K"})]}),t.jsxs("button",{className:"quick-action",type:"button",onClick:f,"aria-label":"Start guided tour","data-help":!0,"data-help-title":"Guided tour","data-help-body":"Walk the interface with a curated tour.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Tour"}),t.jsx("span",{className:"quick-action-meta",children:"Guide"})]}),t.jsxs("button",{className:`quick-action ${s?"active":""}`,type:"button",onClick:v,"aria-label":"Toggle explain mode","data-help":!0,"data-help-title":"Explain mode","data-help-body":"Toggle contextual overlays for every control.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Explain"}),t.jsx("span",{className:"quick-action-meta",children:s?"On":"Off"})]}),t.jsxs("button",{className:"quick-action",type:"button",onClick:x,"aria-label":"Jump to bottleneck","data-help":!0,"data-help-title":"Bottleneck jump","data-help-body":"Focus instantly on the slowest step.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Bottleneck"}),t.jsx("span",{className:"quick-action-meta",children:"Latency"})]}),t.jsxs("button",{className:"quick-action",type:"button",onClick:g,"aria-label":"Show shortcuts","data-help":!0,"data-help-title":"Shortcuts","data-help-body":"See the full keyboard map.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Shortcuts"}),t.jsx("span",{className:"quick-action-meta",children:"?"})]})]}):t.jsxs("button",{className:"quick-actions-toggle",type:"button",onClick:l,title:"Open quick actions","aria-expanded":"false","data-help":!0,"data-tour":"quick-actions","data-help-title":"Quick actions","data-help-body":"Open the dock to access demos, shortcuts, and instant actions.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-actions-toggle-label",children:"Actions"}),t.jsx("span",{className:"quick-actions-toggle-meta",children:"Dock"})]})}function si({active:e,label:a,step:n,total:s,onStop:o,onRestart:r}){if(!e)return null;const l=s>0?(n+1)/s*100:0;return t.jsxs("div",{className:"story-banner",role:"status","aria-live":"polite",children:[t.jsxs("div",{className:"story-banner-main",children:[t.jsx("div",{className:"story-banner-title",children:"Story mode"}),t.jsx("div",{className:"story-banner-step",children:a})]}),t.jsxs("div",{className:"story-banner-actions",children:[t.jsxs("span",{className:"story-banner-count",children:[Math.min(n+1,s),"/",s]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:r,children:"Restart"}),t.jsx("button",{className:"primary-button",type:"button",onClick:o,children:"Stop"})]}),t.jsx("div",{className:"story-banner-progress",children:t.jsx("span",{style:{width:`${l}%`}})})]})}function oi({steps:e,fromRects:a,toRects:n,onComplete:s}){return d.useEffect(()=>{const o=window.setTimeout(s,550);return()=>window.clearTimeout(o)},[s]),t.jsx("div",{className:"morph-layer",children:e.map(o=>{var p;const r=a[o.id],l=n[o.id];return!r||!l?null:t.jsxs(ao.div,{className:`morph-card step-${o.type}`,initial:{left:r.left,top:r.top,width:r.width,height:r.height},animate:{left:l.left,top:l.top,width:l.width,height:l.height},transition:{duration:.5,ease:"easeInOut"},children:[t.jsx("div",{className:"morph-card-title",children:o.name}),t.jsx("div",{className:"morph-card-subtitle",children:((p=o.preview)==null?void 0:p.title)??o.type})]},o.id)})})}function ii({morph:e,onComplete:a,children:n}){return t.jsxs("div",{className:"morph-orchestrator",children:[n,e?t.jsx(oi,{steps:e.steps,fromRects:e.fromRects,toRects:e.toRects,onComplete:a}):null]})}const ri="demo-trace-overlap-001",li="Overlap + ToolCallId Demo",ci="2026-01-27T10:00:00.000Z",di="2026-01-27T10:00:05.000Z",ui="completed",pi={source:"openai_agents",agentName:"DemoAgent",modelId:"gpt-4o-2024-11-20",wallTimeMs:5e3,workTimeMs:7200,totalTokens:1400,totalCostUsd:.018},mi=[{id:"s1",index:0,type:"llm_call",name:"plan",startedAt:"2026-01-27T10:00:00.000Z",endedAt:"2026-01-27T10:00:01.000Z",durationMs:1e3,childStepIds:[],metrics:{tokensTotal:300,costUsd:.004},preview:{title:"LLM: plan",subtitle:"gpt-4o",outputPreview:"I'll fetch two sources..."},status:"completed"},{id:"s2",index:1,type:"llm_call",name:"call_tools",startedAt:"2026-01-27T10:00:01.000Z",endedAt:"2026-01-27T10:00:01.200Z",durationMs:200,childStepIds:[],metrics:{tokensTotal:120,costUsd:.002},preview:{title:"LLM: call tools",outputPreview:"Calling web_search + database_query"},io:{emittedToolCallIds:["tc-001","tc-002"]},status:"completed"},{id:"s3",index:2,type:"tool_call",name:"web_search",toolCallId:"tc-001",startedAt:"2026-01-27T10:00:01.200Z",endedAt:"2026-01-27T10:00:03.200Z",durationMs:2e3,childStepIds:[],metrics:{costUsd:0},preview:{title:"Tool: web_search",inputPreview:'{"q":"EU AI Act"}',outputPreview:"[3 results...]"},status:"completed"},{id:"s4",index:3,type:"tool_call",name:"database_query",toolCallId:"tc-002",startedAt:"2026-01-27T10:00:01.500Z",endedAt:"2026-01-27T10:00:02.700Z",durationMs:1200,childStepIds:[],preview:{title:"Tool: database_query",inputPreview:'{"sql":"SELECT..."}',outputPreview:'{"rows":42}'},status:"completed"},{id:"s5",index:4,type:"llm_call",name:"analyze",startedAt:"2026-01-27T10:00:03.200Z",endedAt:"2026-01-27T10:00:04.600Z",durationMs:1400,childStepIds:[],metrics:{tokensTotal:700,costUsd:.012},preview:{title:"LLM: analyze",outputPreview:"Synthesis based on tool outputs..."},io:{consumedToolCallIds:["tc-001","tc-002"]},status:"completed"}],Et={id:ri,name:li,startedAt:ci,endedAt:di,status:ui,metadata:pi,steps:mi};function Sn(e,a){const n=hi(e,a),s=new Set(n.map(y=>y.leftId)),o=new Set(n.map(y=>y.rightId)),r=a.steps.filter(y=>!o.has(y.id)).map(y=>y.id),l=e.steps.filter(y=>!s.has(y.id)).map(y=>y.id),p=n.filter(y=>{const g=e.steps.find(x=>x.id===y.leftId),v=a.steps.find(x=>x.id===y.rightId);return!g||!v?!1:en(g)!==en(v)}),c=p.map(y=>y.leftId),h=(a.metadata.totalCostUsd??0)-(e.metadata.totalCostUsd??0),f=a.metadata.wallTimeMs-e.metadata.wallTimeMs;return{addedSteps:r,removedSteps:l,changedSteps:c,changedPairs:p,alignedSteps:n,costDeltaUsd:h,wallTimeDeltaMs:f}}function hi(e,a){const n=[],s=new Set(e.steps.map(f=>f.id)),o=new Set(a.steps.map(f=>f.id));Array.from(s).forEach(f=>{o.has(f)&&(n.push({leftId:f,rightId:f}),s.delete(f),o.delete(f))});const r=new Map;a.steps.forEach(f=>{f.toolCallId&&r.set(f.toolCallId,f.id)}),e.steps.forEach(f=>{if(!f.toolCallId)return;const y=r.get(f.toolCallId);y&&o.has(y)&&(n.push({leftId:f.id,rightId:y}),s.delete(f.id),o.delete(y))});const l=nn(e),p=nn(a),c=fi(e,a),h={};return o.forEach(f=>{const y=p.get(f);if(!y)return;const g=tn(y.step);g&&(h[g]||(h[g]=[]),h[g].push(f))}),Object.values(h).forEach(f=>{f.sort((y,g)=>{var v,x;return(((v=p.get(y))==null?void 0:v.startMs)??0)-(((x=p.get(g))==null?void 0:x.startMs)??0)})}),Array.from(s).forEach(f=>{var x;const y=l.get(f);if(!y)return;const g=tn(y.step);if(!g||!((x=h[g])!=null&&x.length))return;const v=yi(y,h[g],p,c);v&&(n.push({leftId:f,rightId:v}),s.delete(f),o.delete(v),h[g]=h[g].filter(m=>m!==v))}),n}function en(e){var s,o;const a=((s=e.preview)==null?void 0:s.outputPreview)??null,n=((o=e.metrics)==null?void 0:o.costUsd)??null;return`${e.status}|${a??""}|${n??""}`}function tn(e){return e.type?`${e.type}:${e.name??""}`:null}function an(e){if(!e)return null;const a=Date.parse(e);return Number.isNaN(a)?null:a}function nn(e){const a=an(e.startedAt),n=new Map;return e.steps.forEach(s=>{const o=an(s.startedAt),r=a!=null&&o!=null?o-a:null;n.set(s.id,{step:s,startMs:r})}),n}function fi(e,a){const n=Math.max(e.metadata.wallTimeMs,a.metadata.wallTimeMs,1);return Math.max(1e3,Math.min(5e3,Math.round(n*.1)))}function yi(e,a,n,s){const o=e.startMs;if(o==null)return null;let r=null,l=s+1;return a.forEach(p=>{const c=n.get(p);if(!c||c.startMs==null)return;const h=Math.abs(c.startMs-o);h<l&&(l=h,r=p)}),l<=s?r:null}const bi=new Map,gi=new Map,Ue=new Map;async function xi(){return[Et]}async function Nn(e){return{trace:Et}}const vi={s1:{role:"assistant",content:"I'll analyze the user's request and create a plan to fetch information from two sources: a web search for current EU AI Act updates and a database query for historical compliance data.",model:"gpt-4o-2024-11-20",usage:{prompt_tokens:150,completion_tokens:150,total_tokens:300},reasoning:"The user wants comprehensive information about AI regulations. I'll use parallel tool calls to maximize efficiency."},s2:{role:"assistant",content:null,tool_calls:[{id:"tc-001",type:"function",function:{name:"web_search",arguments:'{"q":"EU AI Act latest updates 2026"}'}},{id:"tc-002",type:"function",function:{name:"database_query",arguments:`{"sql":"SELECT * FROM compliance_records WHERE region='EU' ORDER BY date DESC LIMIT 10"}`}}],model:"gpt-4o-2024-11-20",usage:{prompt_tokens:80,completion_tokens:40,total_tokens:120}},s3:{tool_call_id:"tc-001",tool_name:"web_search",input:{q:"EU AI Act latest updates 2026"},output:{results:[{title:"EU AI Act Implementation Timeline",url:"https://example.com/ai-act",snippet:"The EU AI Act enters full force in 2026..."},{title:"High-Risk AI Systems Classification",url:"https://example.com/classification",snippet:"New guidance on high-risk categorization..."},{title:"Compliance Deadlines Approaching",url:"https://example.com/deadlines",snippet:"Organizations must comply by August 2026..."}],total_results:3,search_time_ms:1850},status:"success"},s4:{tool_call_id:"tc-002",tool_name:"database_query",input:{sql:"SELECT * FROM compliance_records WHERE region='EU' ORDER BY date DESC LIMIT 10"},output:{rows:[{id:1,company:"TechCorp",status:"compliant",date:"2026-01-15"},{id:2,company:"AIStartup",status:"in_progress",date:"2026-01-10"},{id:3,company:"DataCo",status:"compliant",date:"2026-01-05"}],row_count:42,query_time_ms:1100},status:"success"},s5:{role:"assistant",content:`Based on my analysis of the web search results and database records:

**Key Findings:**
1. The EU AI Act is now in full effect as of 2026
2. High-risk AI systems require specific compliance measures
3. 42 organizations in our database have compliance records

**Recommendations:**
- Review classification of AI systems
- Ensure documentation is complete
- Schedule compliance audit before August deadline`,model:"gpt-4o-2024-11-20",usage:{prompt_tokens:450,completion_tokens:250,total_tokens:700},reasoning:"Synthesized information from both the web search (3 relevant articles) and database query (42 compliance records) to provide actionable insights."}};function wi(e,a){const n=Et.steps.find(r=>r.id===e);if(!n)return null;const s=vi[e];if(!s)return null;const o=a?ki(s):s;return{...n,data:o}}function ki(e){var n,s;const a=JSON.parse(JSON.stringify(e));return(n=a.input)!=null&&n.sql&&(a.input.sql="[REDACTED]"),(s=a.output)!=null&&s.rows&&(a.output.rows=a.output.rows.map(o=>({...o,company:"[REDACTED]"}))),a.tool_calls&&(a.tool_calls=a.tool_calls.map(o=>({...o,function:{...o.function,arguments:"[REDACTED]"}}))),a}async function ji(e,a,n,s=[],o=!1){return await new Promise(r=>setTimeout(r,150)),wi(a,o)}async function Si(e,a,n){await ji(e,a,"redacted",[],n)}function Ni(e,a){return()=>{}}function Mi(){bi.clear(),gi.clear()}async function Ci(e,a){return null}async function Ii(e){return null}async function $r(e,a){return[]}async function _r(e,a,n,s,o){return null}async function Ei(){return[]}async function Ti(e,a){return null}async function Di(e,a,n,s,o){return o?Mn(o,a,n,s):null}function Mn(e,a,n,s){var x;const o=JSON.parse(JSON.stringify(e)),r=6e4,l=Date.parse("2024-01-01T00:00:00.000Z"),p=Date.parse(e.endedAt??e.startedAt??""),h=(Number.isNaN(p)?l:p)+r,f=new Date(h);o.id=`${e.id}-replay-${h}`,o.parentTraceId=e.id,o.branchPointStepId=a,o.replay={strategy:n,modifiedStepId:a,modifications:s,createdAt:f.toISOString()};const y=m=>{if(!m)return m;const S=Date.parse(m);return Number.isNaN(S)?m:new Date(S+r).toISOString()};o.startedAt=y(o.startedAt)??o.startedAt,o.endedAt=y(o.endedAt);const g=new Set,v=((x=o.steps.find(m=>m.id===a))==null?void 0:x.index)??-1;return n==="live"?o.steps.forEach(m=>{m.index>v&&g.add(m.id)}):n==="hybrid"&&o.steps.forEach(m=>{m.index>v&&g.add(m.id)}),o.steps=o.steps.map(m=>{var k;const S={...m};if(S.startedAt=y(m.startedAt)??m.startedAt,S.endedAt=y(m.endedAt),m.id===a){const T=((k=m.preview)==null?void 0:k.outputPreview)??"";S.preview={...m.preview,outputPreview:`${T} (modified)`.trim()}}return g.has(m.id)&&(S.status="pending",S.endedAt=null,S.durationMs=void 0,S.metrics=void 0,S.preview={...m.preview,outputPreview:"[invalidated for replay]"}),S}),o}async function Ai(e){return Ri(e)}async function $i(e){var a;return((a=Ue.get(e))==null?void 0:a.job)??null}async function sn(e){var a;return((a=Ue.get(e))==null?void 0:a.matrix)??null}async function _i(e){{const a=Ue.get(e);if(!a)return null;const n={...a.job,status:"canceled",scenarios:a.job.scenarios.map(s=>({...s,status:"canceled",endedAt:s.endedAt??new Date().toISOString()}))};return Ue.set(e,{...a,job:n}),n}}function Ri(e){const a=`demo-job-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,n=Et,s=new Date().toISOString(),o=e.scenarios.map((c,h)=>({id:`demo-scn-${h+1}`,name:c.name,strategy:c.strategy,modifications:c.modifications,status:"running",startedAt:s,endedAt:null,replayTraceId:`${a}-replay-${h+1}`})),r={id:a,traceId:e.traceId,stepId:e.stepId,status:"running",createdAt:s,startedAt:s,endedAt:null,scenarioCount:o.length,completedCount:0,failedCount:0,canceledCount:0,scenarios:o},l=o.map(c=>{const h=Mn(n,e.stepId,c.strategy,c.modifications);h.id=c.replayTraceId;const f=Sn(n,h),y=n.metadata.totalCostUsd??0,g=h.metadata.totalCostUsd??y,v=n.metadata.errorCount??0,x=h.metadata.errorCount??v,m=n.metadata.retryCount??0,S=h.metadata.retryCount??m,k=h.steps.filter(T=>T.status==="pending").length;return{scenarioId:c.id,name:c.name,strategy:c.strategy,status:"completed",replayTraceId:c.replayTraceId,modifications:c.modifications,error:null,changedStepIds:f.changedSteps,addedStepIds:f.addedSteps,removedStepIds:f.removedSteps,metrics:{costDeltaUsd:g-y,wallTimeDeltaMs:(h.metadata.wallTimeMs??0)-(n.metadata.wallTimeMs??0),errorDelta:x-v,retryDelta:S-m,changedSteps:f.changedSteps.length,addedSteps:f.addedSteps.length,removedSteps:f.removedSteps.length,invalidatedStepCount:k}}}),p={jobId:a,traceId:e.traceId,stepId:e.stepId,rows:l,causalRanking:[]};return Ue.set(a,{job:r,matrix:p}),window.setTimeout(()=>{const c=Ue.get(a);if(!c)return;const h=new Date().toISOString(),f=c.job.scenarios.map(v=>({...v,status:"completed",endedAt:h})),y={...c.job,status:"completed",endedAt:h,completedCount:f.length,scenarios:f},g={...c.matrix,rows:c.matrix.rows.map(v=>({...v,status:"completed"}))};Ue.set(a,{job:y,matrix:g})},600),r}async function Oi(e){return null}async function ra(e){return null}async function Li(e){return null}async function Pi(e){return null}async function Fi(e){return null}async function on(e){return{session:null,conflict:!1,error:null}}async function rn(e){return null}async function qi(e){return null}async function Gi(e){return null}async function Bi(e){return null}async function Hi(e){return null}async function Ui(e,a){return null}async function Ji(e){return null}async function zi(e,a,n){return null}async function ln(){return null}async function cn(){return null}function Wi(e,a,n){return()=>{}}function Ki(){const[e,a]=d.useState(null),[n,s]=d.useState(null),[o,r]=d.useState(!0),[l,p]=d.useState(null),[c,h]=d.useState([]),[f,y]=d.useState(null),g=d.useCallback(async x=>{const m=await Nn(),S=(m==null?void 0:m.trace)??null;a(S),s(S?(m==null?void 0:m.insights)??uo(S):null)},[a,s]),v=d.useCallback(async()=>{var x;r(!0),p(null);try{const m=await xi();h(m);const S=((x=m[m.length-1])==null?void 0:x.id)??null,k=f??S;if(!k){a(null),s(null);return}if(!f||f!==k){y(k);return}await g(k)}catch(m){p(m instanceof Error?m.message:"Failed to load trace")}finally{r(!1)}},[f,g]);return d.useEffect(()=>{v()},[v]),d.useEffect(()=>{f&&(r(!0),g(f).catch(x=>{p(x instanceof Error?x.message:"Failed to load trace")}).finally(()=>r(!1)))},[f,g]),d.useEffect(()=>Ni(),[f,y]),{trace:e,insights:n,loading:o,error:l,reload:v,traces:c,selectedTraceId:f,setSelectedTraceId:y}}function te(e,a){const[n,s]=d.useState(()=>{if(typeof window>"u")return a;try{const o=window.localStorage.getItem(e);return o==null?a:JSON.parse(o)}catch{return a}});return d.useEffect(()=>{try{window.localStorage.setItem(e,JSON.stringify(n))}catch{}},[e,n]),[n,s]}const dn=new Map;function Yi(e,a){const n=e.map(o=>o.id).join("|"),s=a.map(o=>`${o.source}->${o.target}`).join("|");return`${e.length}:${a.length}:${n}:${s}`}function Qi(e,a,n){if(n){const s=Yi(e,a),o=dn.get(n);if(o&&o.signature===s)return o.layout;const r=un(e,a);return dn.set(n,{signature:s,layout:r}),r}return un(e,a)}function un(e,a){if(e.length>2500){const s=Math.ceil(Math.sqrt(e.length));return e.map((o,r)=>{const l=Math.floor(r/s),p=r%s;return{id:o.id,position:{x:p*260,y:l*160}}})}const n=new Ba.graphlib.Graph;return n.setGraph({rankdir:"LR",nodesep:48,ranksep:80}),n.setDefaultEdgeLabel(()=>({})),e.forEach(s=>{n.setNode(s.id,{width:220,height:120})}),a.forEach(s=>{n.setEdge(s.source,s.target)}),Ba.layout(n),e.map(s=>{const o=n.node(s.id);return{id:s.id,position:{x:o.x-o.width/2,y:o.y-o.height/2}}})}const Cn="agentDirector.gameplayFunnel.v1";function Vi(){try{const e=window.localStorage.getItem(Cn);if(!e)return[];const a=JSON.parse(e);return Array.isArray(a)?a.filter(n=>{if(!n||typeof n!="object")return!1;const s=n;return typeof s.name=="string"&&typeof s.at=="number"&&!!s.metadata&&typeof s.metadata=="object"}):[]}catch{return[]}}function Zi(e,a={}){const n={name:e,at:Date.now(),metadata:a},o=[...Vi(),n].slice(-200);return window.localStorage.setItem(Cn,JSON.stringify(o)),n}function Xi(e){const a=new Map;for(const s of e)s.type==="tool_call"&&s.toolCallId&&a.set(s.toolCallId,s.id);const n=[];for(const s of e)if(!(s.type!=="llm_call"||!s.io)){for(const o of s.io.emittedToolCallIds??[]){const r=a.get(o);r&&n.push({id:`io_emit_${s.id}_${r}`,source:s.id,target:r,kind:"io",toolCallId:o})}for(const o of s.io.consumedToolCallIds??[]){const r=a.get(o);r&&n.push({id:`io_consume_${r}_${s.id}`,source:r,target:s.id,kind:"io",toolCallId:o})}}return n}function er(e,a,n){const{intervals:s}=It(e,a,n),o=new Set;return s.forEach(r=>{o.add(r.startMs),o.add(r.endMs)}),Array.from(o).sort((r,l)=>r-l)}function tr(e,a,n){if(!e.length)return null;if(n===1){for(const s of e)if(s>a+1)return s;return e[e.length-1]}for(let s=e.length-1;s>=0;s-=1){const o=e[s];if(o<a-1)return o}return e[0]}const ar=300,nr=2e3,sr=1.5;function or(e){const a=ar*Math.pow(sr,Math.max(0,e));return Math.min(nr,Math.round(a))}function Pe(e,a){if(!e)return a;try{return JSON.parse(e)}catch{return a}}function pn(e,a){const n=new Map;return[...e,...a].forEach(s=>{const o=n.get(s.id);(!o||s.updatedAt>=o.updatedAt)&&n.set(s.id,s)}),Array.from(n.values()).sort((s,o)=>s.createdAt-o.createdAt)}function mn(e,a=50){return[...e].sort((n,s)=>s.timestamp-n.timestamp).slice(0,a)}const ir=[{minDepth:1,maxDepth:1,difficulty:1},{minDepth:2,maxDepth:3,difficulty:2},{minDepth:4,maxDepth:5,difficulty:3},{minDepth:6,maxDepth:7,difficulty:4},{minDepth:8,maxDepth:9,difficulty:5},{minDepth:10,maxDepth:12,difficulty:6},{minDepth:13,maxDepth:16,difficulty:7},{minDepth:17,maxDepth:20,difficulty:8},{minDepth:21,maxDepth:24,difficulty:9},{minDepth:25,maxDepth:Number.MAX_SAFE_INTEGER,difficulty:10}],Mt=["latency storm","cache divergence","tool timeout chain","stale prompt vector","schema mismatch surge"],hn=[{id:"seasonal-incident-sprint",title:"Resolve 3 raid objectives",goal:3,rewardCredits:120},{id:"boss-shutdown",title:"Defeat one boss encounter",goal:1,rewardCredits:200},{id:"guild-push",title:"Complete 2 guild operations",goal:2,rewardCredits:160},{id:"timeline-weaver",title:"Merge 2 timeline forks",goal:2,rewardCredits:150}],rr={stability_patch:{credits:20,materials:12},precision_lens:{credits:28,materials:16},overclock_core:{credits:42,materials:24}};function X(e,a,n){return Math.min(n,Math.max(a,e))}function In(e){let a=0;for(let n=0;n<e.length;n+=1)a=(a*31+e.charCodeAt(n))%1e5;return a}function lr(e,a,n){const s=In(`${e}:${a}:${n.join("|")}`),o=Mt[s%Mt.length],r=Mt[Math.floor(s/7)%Mt.length],l=Array.from(new Set([o,r])),p=[...n].sort().slice(-2),c=`seed=${s};depth=${a};mutators=${p.join(",")||"none"}`;return{id:`mission-${a}-${(e+a)%997}`,title:`Scenario Depth ${a}`,difficulty:cr(a),hazards:[...l,...p.slice(-1)],rewardCredits:60+a*15,missionSeed:s,blueprint:c}}function En(e,a,n){return lr(e,a,n)}function cr(e){var n;const a=Math.max(1,Math.floor(e));return((n=ir.find(s=>a>=s.minDepth&&a<=s.maxDepth))==null?void 0:n.difficulty)??10}function dr(){return[{id:"node-alpha",title:"Signal Fracture",body:"Telemetry divergence emerges across parallel tool paths.",choices:[{id:"alpha-risk",label:"Push aggressive branch optimization",nextNodeId:"node-beta",tensionDelta:12,mutator:"risk-surge"},{id:"alpha-safe",label:"Stabilize and preserve deterministic flow",nextNodeId:"node-beta",tensionDelta:-5,mutator:"stability-first"}]},{id:"node-beta",title:"Protocol Fork",body:"The team must choose speed versus interpretability under pressure.",choices:[{id:"beta-speed",label:"Favor speed and absorb uncertainty",nextNodeId:"node-gamma",tensionDelta:8,mutator:"throughput-boost"},{id:"beta-clarity",label:"Favor clarity and route through guardrails",nextNodeId:"node-gamma",tensionDelta:-3,mutator:"clarity-path"}]},{id:"node-gamma",title:"Final Directive",body:"Command has one move left before the run locks in.",choices:[{id:"gamma-strike",label:"Launch decisive strike sequence",nextNodeId:"node-alpha",tensionDelta:10,mutator:"strike-loop"},{id:"gamma-reset",label:"Reset tempo and rebuild confidence",nextNodeId:"node-alpha",tensionDelta:-6,mutator:"tempo-reset"}]}]}function Tn(e,a){return{...hn[(e+a)%hn.length],progress:0,completed:!1}}function Dn(e,a){const n=[...e,a];return Array.from(new Set(n)).slice(-6)}function da(e,a,n){return{...e,campaign:{...e.campaign,depth:a,mutators:n,currentMission:En(e.seed,a,n)}}}function fn(e){const a=In(e),n=["baseline"];return{seed:a,raid:{party:["director"],roles:{director:"strategist"},objectives:[{id:"obj-root-cause",label:"Identify root cause chain",progress:0,target:100,completed:!1},{id:"obj-recover",label:"Recover operational stability",progress:0,target:100,completed:!1},{id:"obj-harden",label:"Harden replay strategy",progress:0,target:100,completed:!1}],completed:!1},campaign:{depth:1,lives:3,completedMissionIds:[],mutators:n,currentMission:En(a,1,n)},narrative:{currentNodeId:"node-alpha",nodes:dr(),history:[],tension:35},skills:{points:6,nodes:[{id:"skill-focus",label:"Focus Matrix",cost:1,requires:[],minLevel:1,requiredMilestones:[],tier:1,loadoutSlot:"core",unlocked:!1},{id:"skill-resilience",label:"Resilience Mesh",cost:1,requires:[],minLevel:1,requiredMilestones:[],tier:1,loadoutSlot:"utility",unlocked:!1},{id:"skill-surge",label:"Surge Compiler",cost:2,requires:["skill-focus"],minLevel:2,requiredMilestones:[],tier:2,loadoutSlot:"power",unlocked:!1},{id:"skill-echo",label:"Echo Anticipator",cost:2,requires:["skill-resilience"],minLevel:2,requiredMilestones:[],tier:2,loadoutSlot:"utility",unlocked:!1},{id:"skill-ward",label:"Ward Lattice",cost:2,requires:["skill-resilience"],minLevel:3,requiredMilestones:["milestone-level-3"],tier:3,loadoutSlot:"power",unlocked:!1},{id:"skill-overclock",label:"Overclock Nexus",cost:3,requires:["skill-surge","skill-echo"],minLevel:4,requiredMilestones:["milestone-level-3"],tier:3,loadoutSlot:"power",unlocked:!1}],loadout:{capacity:3,equipped:[],slotCaps:{core:1,utility:1,power:1}}},pvp:{round:0,stability:72,sabotage:28,fog:40,winner:null},time:{activeForkId:"primary",forks:[{id:"primary",label:"Primary timeline",playheadMs:0,history:[0]}]},boss:{name:"The Causality Hydra",phase:1,hp:320,maxHp:320,enraged:!1,phaseMechanic:"Phase 1: Shield lattice destabilization",vulnerability:"exploit"},director:{risk:30,hint:"Start with the bottleneck path and branch cautiously.",recommendedModifier:"stability_patch",lastOutcome:"mixed"},economy:{credits:140,materials:90,crafted:[],inflationIndex:.438,reserveTarget:320},rewards:{dailyClaimedOn:null,streakDays:0,sessionClaimed:!1,streakClaimedFor:0,masteryClaims:[],history:[]},guild:{name:"Trace Guild",members:4,operationsScore:0,eventsCompleted:0},cinematic:{queue:[]},liveops:{season:`Season-${2026+a%2}`,week:1,challenge:Tn(a,1),difficultyFactor:1,rewardMultiplier:1,tuningHistory:[]},teamComms:{pings:[]},safety:{mutedPlayerIds:[],blockedPlayerIds:[],reports:[]},outcome:{status:"in_progress",reason:"Run started. Complete missions and stabilize the incident.",updatedAt:Date.now()},sandbox:{enabled:!1},progression:{xp:0,level:1,nextLevelXp:200,milestones:[]}}}function Rr(e,a){return{...e,sandbox:{enabled:a},outcome:a?{status:"in_progress",reason:"Sandbox mode enabled. Penalties are disabled for safe practice runs.",updatedAt:Date.now()}:e.outcome}}function Or(e,a,n){if(!a.trim())return e;const s=e.raid.party.includes(a)?e.raid.party:[...e.raid.party,a];return{...e,raid:{...e.raid,party:s,roles:{...e.raid.roles,[a]:n}}}}function Lr(e,a,n){const s=fa(e),o=e.raid.objectives.map(c=>{if(c.id!==a)return c;const h=X(c.progress+n,0,c.target);return{...c,progress:h,completed:h>=c.target}}),r=o.every(c=>c.completed),l=r&&!e.raid.completed?180:0,p={...e,raid:{...e.raid,objectives:o,completed:r},outcome:r&&!e.raid.completed?{status:"partial",reason:"Raid objectives completed. Push campaign and boss tracks to close the run.",updatedAt:Date.now()}:s};return!r||e.raid.completed?p:_e(pt(p,l),60)}function Pr(e,a){const n=yr(e),s=e.campaign.currentMission;if(a){const c=e.campaign.depth+1,h=da(e,c,e.campaign.mutators),f=c>=5?{status:"win",reason:"Campaign depth target reached. Incident run is stabilized.",updatedAt:Date.now()}:{status:"partial",reason:`Mission ${s.id} cleared. Advance deeper to secure the run.`,updatedAt:Date.now()},y={...h,campaign:{...h.campaign,completedMissionIds:[...h.campaign.completedMissionIds,s.id]},economy:{...h.economy,materials:h.economy.materials+14},director:{...h.director,lastOutcome:"success"},outcome:f};return _e(pt(y,s.rewardCredits),120)}const o=n.enabled?e.campaign.lives:X(e.campaign.lives-1,0,3),r=da(e,e.campaign.depth,Dn(e.campaign.mutators,"failure-loop")),l=n.enabled?{status:"partial",reason:"Sandbox mode active. Failure recorded with no life penalty.",updatedAt:Date.now()}:o<=0?{status:"loss",reason:"No campaign lives remaining. Incident run failed.",updatedAt:Date.now()}:{status:"partial",reason:`Mission failed. ${o} campaign lives remaining.`,updatedAt:Date.now()},p={...r,campaign:{...r.campaign,lives:o},director:{...r.director,lastOutcome:"failure"},outcome:l};return _e(p,40)}function Fr(e,a){const n=e.narrative.nodes.find(p=>p.id===e.narrative.currentNodeId),s=n==null?void 0:n.choices.find(p=>p.id===a);if(!n||!s)return e;const o=X(e.narrative.tension+s.tensionDelta,0,100),r=Dn(e.campaign.mutators,s.mutator),l=da(e,e.campaign.depth,r);return{...l,narrative:{...l.narrative,currentNodeId:s.nextNodeId,history:[...l.narrative.history,{nodeId:n.id,choiceId:s.id}],tension:o}}}function qr(e,a){const n=e.skills.nodes.find(o=>o.id===a);return!n||!ur(e,a).allowed?e:{...e,skills:{...e.skills,points:e.skills.points-n.cost,nodes:e.skills.nodes.map(o=>o.id===a?{...o,unlocked:!0}:o)}}}function Gr(e,a){return pr(e,a).allowed?{...e,skills:{...e.skills,loadout:{...e.skills.loadout,equipped:[...e.skills.loadout.equipped,a]}}}:e}function ur(e,a){const n=e.skills.nodes.find(p=>p.id===a);if(!n)return{allowed:!1,reason:"Unknown skill node."};if(n.unlocked)return{allowed:!1,reason:"Skill already unlocked."};const s=new Set(e.skills.nodes.filter(p=>p.unlocked).map(p=>p.id)),o=n.requires.filter(p=>!s.has(p));if(o.length>0)return{allowed:!1,reason:`Requires: ${o.join(", ")}`};const r=$n(e);if(r.level<n.minLevel)return{allowed:!1,reason:`Requires level ${n.minLevel}`};const l=n.requiredMilestones.filter(p=>!r.milestones.includes(p));return l.length>0?{allowed:!1,reason:`Requires milestone ${l[0]}`}:e.skills.points<n.cost?{allowed:!1,reason:`Need ${n.cost} points`}:{allowed:!0,reason:"Unlock available"}}function pr(e,a){const n=e.skills.nodes.find(r=>r.id===a);if(!n)return{allowed:!1,reason:"Unknown skill node."};if(!n.unlocked)return{allowed:!1,reason:"Unlock required before equip."};if(e.skills.loadout.equipped.includes(a))return{allowed:!1,reason:"Already equipped."};if(e.skills.loadout.equipped.length>=e.skills.loadout.capacity)return{allowed:!1,reason:"Loadout capacity reached."};const s=e.skills.loadout.slotCaps[n.loadoutSlot];return e.skills.loadout.equipped.reduce((r,l)=>{const p=e.skills.nodes.find(c=>c.id===l);return(p==null?void 0:p.loadoutSlot)===n.loadoutSlot?r+1:r},0)>=s?{allowed:!1,reason:`${n.loadoutSlot} slot limit reached.`}:{allowed:!0,reason:"Equip available"}}function Br(e,a){const n=fa(e),s={...e.pvp};a==="sabotage"?(s.sabotage=X(s.sabotage+13,0,100),s.stability=X(s.stability-11,0,100),s.fog=X(s.fog+9,0,100)):a==="stabilize"?(s.stability=X(s.stability+14,0,100),s.sabotage=X(s.sabotage-8,0,100),s.fog=X(s.fog-6,0,100)):(s.fog=X(s.fog-16,0,100),s.stability=X(s.stability+3,0,100),s.sabotage=X(s.sabotage-4,0,100)),s.round+=1,s.stability<=0?s.winner="saboteur":s.sabotage<=0?s.winner="operator":s.round>=10&&(s.winner=s.stability>=s.sabotage?"operator":"saboteur");const o=s.winner==="operator"?{status:"win",reason:"Operator side prevailed in the sabotage conflict.",updatedAt:Date.now()}:s.winner==="saboteur"?{status:"loss",reason:"Saboteur pressure overwhelmed system stability.",updatedAt:Date.now()}:n,r={...e,pvp:s,outcome:o};return _e(r,s.winner?72:12)}function Hr(e,a,n){const s=`fork-${e.time.forks.length+1}`,o={id:s,label:a.trim()||s,playheadMs:X(n,0,36e5),history:[X(n,0,36e5)]};return{...e,time:{...e.time,activeForkId:s,forks:[...e.time.forks,o]}}}function Ur(e,a){const n=e.time.activeForkId,s=e.time.forks.map(o=>{if(o.id!==n)return o;const r=X(o.playheadMs-Math.abs(a),0,36e5);return{...o,playheadMs:r,history:[...o.history,r]}});return{...e,time:{...e.time,forks:s}}}function Jr(e,a){if(a==="primary")return e;const n=e.time.forks.find(r=>r.id===a),s=e.time.forks.find(r=>r.id==="primary");if(!n||!s)return e;const o={...s,playheadMs:n.playheadMs,history:[...s.history,n.playheadMs]};return{...e,time:{activeForkId:"primary",forks:[o,...e.time.forks.filter(r=>r.id!=="primary"&&r.id!==a)]}}}function zr(e,a){const n=fa(e),o={1:{exploit:42,strike:24,shield:8},2:{exploit:34,strike:28,shield:10},3:{exploit:26,strike:18,shield:14}}[e.boss.phase][a],r=e.boss.vulnerability===a?8:0,l=o+r,p=X(e.boss.hp-l,0,e.boss.maxHp),c=p/e.boss.maxHp,h=c<=.33?3:c<=.66?2:1,f=h===1?"Phase 1: Shield lattice destabilization":h===2?"Phase 2: Mirror clones absorb exploit damage":"Phase 3: Enrage pulse; shield counters become lethal",y=h===1?"exploit":h===2?"strike":"shield",g={...e,boss:{...e.boss,hp:p,phase:h,enraged:h===3||p<=e.boss.maxHp*.2,phaseMechanic:f,vulnerability:y},outcome:p<=0?{status:"win",reason:"Boss encounter cleared. Run secured.",updatedAt:Date.now()}:n};return _e(g,p<=0?180:10)}function Wr(e,a){const n=a.failures*12+a.retries*4+(a.latencyMs>1400?8:0),s=X(e.director.risk+n,0,100),o=a.failures>0?"Prioritize failure triage and run a stabilizing replay branch.":a.latencyMs>1400?"Latency pressure detected. Reduce fan-out and tighten tool boundaries.":"Momentum is stable. Push a high-confidence optimization branch.",r=a.failures>1?"stability_patch":a.latencyMs>1400?"precision_lens":"overclock_core",l=a.failures>0?"failure":"success";return{...e,director:{risk:s,hint:o,recommendedModifier:r,lastOutcome:l}}}function Kr(e,a){const n=rr[a];if(!n||e.economy.credits<n.credits||e.economy.materials<n.materials)return e;const s=e.economy.crafted.includes(a)?e.economy.crafted:[...e.economy.crafted,a],o=e.economy.reserveTarget||320,r=e.economy.credits-n.credits;let l={...e,economy:{...e.economy,credits:r,materials:e.economy.materials-n.materials,crafted:s,inflationIndex:Number((r/o).toFixed(3))}};return a==="stability_patch"&&(l={...l,pvp:{...l.pvp,stability:X(l.pvp.stability+8,0,100)}}),a==="precision_lens"&&(l={...l,raid:{...l.raid,objectives:l.raid.objectives.map((p,c)=>c===0?{...p,progress:X(p.progress+10,0,p.target),completed:X(p.progress+10,0,p.target)>=p.target}:p)}}),a==="overclock_core"&&(l={...l,boss:{...l.boss,hp:X(l.boss.hp-16,0,l.boss.maxHp)}}),_e(l,10)}function Yr(e,a){const n=Math.round(a),s={...e,guild:{...e.guild,operationsScore:e.guild.operationsScore+n,eventsCompleted:e.guild.eventsCompleted+(n>0?1:0)}},o=n>0?pt(s,n*3):s;return _e(o,Math.max(0,n*6))}function Qr(e,a,n,s){const o={id:`event-${e.cinematic.queue.length+1}-${e.seed%1e3}`,type:a,message:n,intensity:s,at:Date.now()};return{...e,cinematic:{queue:[o,...e.cinematic.queue].slice(0,12)}}}function Vr(e){const a=ma(e),n=a.week+1,s=Tn(e.seed,n),o=X(a.difficultyFactor??1,.6,1.6),r=X(a.rewardMultiplier??1,.5,2),l={...s,goal:Math.max(1,Math.round(s.goal*o)),rewardCredits:Math.max(1,Math.round(s.rewardCredits*r))},p={...e,liveops:{...a,week:n,challenge:l}};return hr(p)}function Zr(e,a){const n=ma(e),s=n.challenge,o=X(a,0,20),r=X(s.progress+o,0,s.goal),l=r>=s.goal,p={...e,liveops:{...n,challenge:{...s,progress:r,completed:l}}};return!l||s.completed?p:_e(pt(p,s.rewardCredits),80)}function mr(e,a,n="raid_mastery"){const s=An(e),o=new Date().toISOString().slice(0,10);return a==="daily"?s.dailyClaimedOn===o?{allowed:!1,reason:"Daily reward already claimed today."}:{allowed:!0,reason:"Daily reward available."}:a==="session"?s.sessionClaimed?{allowed:!1,reason:"Session reward already claimed."}:e.raid.objectives.some(p=>p.progress>0)||e.campaign.depth>1||e.pvp.round>0?{allowed:!0,reason:"Session reward available."}:{allowed:!1,reason:"Session reward requires gameplay activity."}:a==="streak"?s.streakDays<3?{allowed:!1,reason:"Streak reward requires 3+ daily claims."}:s.streakClaimedFor>=s.streakDays?{allowed:!1,reason:"Streak reward already claimed for current streak."}:{allowed:!0,reason:"Streak reward available."}:s.masteryClaims.includes(n)?{allowed:!1,reason:"Mastery reward already claimed."}:(n==="raid_mastery"?e.raid.completed:n==="campaign_mastery"?e.campaign.depth>=4:e.boss.hp<=0)?{allowed:!0,reason:"Mastery reward available."}:{allowed:!1,reason:"Mastery requirement not met."}}function Xr(e,a,n="raid_mastery"){if(!mr(e,a,n).allowed)return e;const o=An(e),r=new Date().toISOString().slice(0,10);let l=o,p=0,c={};if(a==="daily"){const g=o.dailyClaimedOn===r?o.streakDays:o.streakDays+1;l={...o,dailyClaimedOn:r,streakDays:g},p=90+Math.min(7,g)*10,c={streakDays:g}}else a==="session"?(l={...o,sessionClaimed:!0},p=140,c={actions:e.pvp.round+e.narrative.history.length+e.campaign.depth}):a==="streak"?(l={...o,streakClaimedFor:o.streakDays},p=170+o.streakDays*5,c={streakDays:o.streakDays}):(l={...o,masteryClaims:[...o.masteryClaims,n]},p=n==="boss_mastery"?260:n==="campaign_mastery"?220:180,c={masteryId:n});const h=pt({...e,rewards:l},p),f=Math.max(1,h.economy.credits-e.economy.credits),y={id:`reward-${l.history.length+1}-${e.seed%1e3}`,kind:a,amount:f,at:Date.now(),details:c};return _e({...h,rewards:{...l,history:[y,...l.history].slice(0,60)}},30+Math.max(1,Math.round(f/10)))}function el(e,a){const n=ma(e),s=X(a.difficultyFactor,.6,1.6),o=X(a.rewardMultiplier,.5,2),r=n.difficultyFactor||1,l=n.rewardMultiplier||1,p=a.note.trim()||"Operator tuning update",c={...n.challenge,goal:Math.max(1,Math.round(n.challenge.goal/r*s)),rewardCredits:Math.max(1,Math.round(n.challenge.rewardCredits/l*o))},h={id:`tuning-${n.tuningHistory.length+1}-${e.seed%1e3}`,changedAt:Date.now(),difficultyFactor:s,rewardMultiplier:o,note:p};return{...e,liveops:{...n,challenge:c,difficultyFactor:s,rewardMultiplier:o,tuningHistory:[h,...n.tuningHistory].slice(0,20)}}}function pt(e,a){if(a<=0)return e;const n=e.economy.reserveTarget||320,s=e.economy.credits;let o=1;if(s<=n){const f=Math.min(.12,(n-s)/n*.12);o=Math.min(1.12,1+f)}else{const f=(s-n)/n;o=Math.max(.45,1-f*.35)}const r=Math.max(1,Math.round(a*o)),l=Math.round(n*1.7),p=s+r,c=p>l?Math.max(1,Math.round((p-l)*.22)):0,h=p-c;return{...e,economy:{...e.economy,credits:h,inflationIndex:Number((h/n).toFixed(3))}}}function hr(e){const a=e.economy.reserveTarget||320;if(e.economy.credits<=a)return{...e,economy:{...e.economy,inflationIndex:Number((e.economy.credits/a).toFixed(3))}};const n=Math.max(6,Math.round((e.economy.credits-a)*.08)),s=Math.max(0,e.economy.credits-n);return{...e,economy:{...e.economy,credits:s,inflationIndex:Number((s/a).toFixed(3))}}}function ma(e){var a,n,s,o,r,l;return{season:((a=e.liveops)==null?void 0:a.season)??"Season-2026",week:((n=e.liveops)==null?void 0:n.week)??1,challenge:((s=e.liveops)==null?void 0:s.challenge)??{id:"fallback-liveops",title:"Complete one objective",goal:1,progress:0,rewardCredits:100,completed:!1},difficultyFactor:((o=e.liveops)==null?void 0:o.difficultyFactor)??1,rewardMultiplier:((r=e.liveops)==null?void 0:r.rewardMultiplier)??1,tuningHistory:((l=e.liveops)==null?void 0:l.tuningHistory)??[]}}function An(e){return e.rewards??{dailyClaimedOn:null,streakDays:0,sessionClaimed:!1,streakClaimedFor:0,masteryClaims:[],history:[]}}function fr(e){return e.teamComms??{pings:[]}}function Tt(e){return e.trim().toLowerCase()}function ha(e){return e.safety??{mutedPlayerIds:[],blockedPlayerIds:[],reports:[]}}function tl(e,a,n,s="director"){const o=a,r=(n??"").trim(),l=r.length>0;if(l&&!e.raid.objectives.some(h=>h.id===r))return e;const p=fr(e),c={id:`ping-${p.pings.length+1}-${e.seed%1e3}`,fromPlayerId:Tt(s)||"director",intent:o,targetObjectiveId:l?r:null,createdAt:Date.now()};return{...e,teamComms:{pings:[c,...p.pings].slice(0,50)}}}function fa(e){return e.outcome??{status:"in_progress",reason:"Run in progress.",updatedAt:Date.now()}}function yr(e){return e.sandbox??{enabled:!1}}function $n(e){return e.progression??{xp:0,level:1,nextLevelXp:200,milestones:[]}}function _e(e,a){if(a<=0)return e;const n=$n(e);let s=n.xp+a,o=n.level,r=n.nextLevelXp,l=0;for(;s>=r;)s-=r,o+=1,l+=1,r=o*200;const p=[...n.milestones];return[3,5,10].forEach(c=>{const h=`milestone-level-${c}`;o>=c&&!p.includes(h)&&p.push(h)}),{...e,progression:{xp:s,level:o,nextLevelXp:r,milestones:p},skills:{...e.skills,points:e.skills.points+l}}}function al(e,a,n){const s=Tt(a),o=n.trim();if(!s||!o)return e;const r=ha(e),l={id:`report-${r.reports.length+1}-${e.seed%1e3}`,targetPlayerId:s,reason:o,createdAt:Date.now()};return{...e,safety:{...r,reports:[l,...r.reports].slice(0,40)}}}function nl(e,a){const n=Tt(a),s=ha(e);return!n||s.mutedPlayerIds.includes(n)?e:{...e,safety:{...s,mutedPlayerIds:[...s.mutedPlayerIds,n]}}}function sl(e,a){const n=Tt(a),s=ha(e);return!n||s.blockedPlayerIds.includes(n)?e:{...e,safety:{...s,blockedPlayerIds:[...s.blockedPlayerIds,n],mutedPlayerIds:s.mutedPlayerIds.includes(n)?s.mutedPlayerIds:[...s.mutedPlayerIds,n]}}}const yn=220,bn=120,ua="agentDirector.presence.v1",br=2e4,gr=5e3,et="agentDirector.collab.cursors.v1",la="agentDirector.collab.annotations.v1",ca="agentDirector.collab.activity.v1",xr=d.lazy(()=>ut(()=>import("./index-oebQSRbW.js"),__vite__mapDeps([0,1,2,3]))),vr=d.lazy(()=>ut(()=>import("./index-CMT8YpUr.js"),__vite__mapDeps([4,1,2,3]))),wr=d.lazy(()=>ut(()=>import("./index-DPcWxoFh.js"),__vite__mapDeps([5,1,2,3]))),kr=d.lazy(()=>ut(()=>import("./index-DLGvXWER.js"),__vite__mapDeps([6,1,2,3]))),jr=d.lazy(()=>ut(()=>import("./index-BdULIYZr.js"),__vite__mapDeps([7,1,2,3])));function Ct(){return`scenario-${Math.random().toString(36).slice(2,9)}`}function Sr(e){return e.filter(a=>a.parentStepId).map(a=>({source:a.parentStepId,target:a.id}))}function Nr(e){const a=[...e].sort((n,s)=>n.index-s.index);return a.slice(1).map((n,s)=>({source:a[s].id,target:n.id}))}function Mr(e){const a={},n=e.getBoundingClientRect();return e.querySelectorAll(".step-card").forEach(o=>{const r=o.dataset.stepId;if(!r)return;const l=o.getBoundingClientRect();a[r]={left:l.left-n.left,top:l.top-n.top,width:l.width,height:l.height}}),a}function Cr(e,a,n){const s=[...Sr(e),...Nr(e),...Xi(e).map(x=>({source:x.source,target:x.target}))],o=Qi(e,s,n),r=a.getBoundingClientRect(),l=Math.min(...o.map(x=>x.position.x)),p=Math.min(...o.map(x=>x.position.y)),c=Math.max(...o.map(x=>x.position.x)),h=Math.max(...o.map(x=>x.position.y)),f=c-l+yn,y=h-p+bn,g=Math.max(32,(r.width-f)/2),v=Math.max(24,(r.height-y)/2);return o.reduce((x,m)=>(x[m.id]={left:m.position.x-l+g,top:m.position.y-p+v,width:yn,height:bn},x),{})}function gn(e,a,n){const s=a.trim().toLowerCase();return e.filter(o=>{var l,p,c;return n!=="all"&&o.type!==n?!1:s?[o.name,(l=o.preview)==null?void 0:l.title,(p=o.preview)==null?void 0:p.outputPreview,(c=o.preview)==null?void 0:c.inputPreview].filter(Boolean).join(" ").toLowerCase().includes(s):!0})}function Ir(e,a,n){var h,f,y,g,v,x,m,S,k,T,z,M,D,q,H,P,j,L,I,C,R,W,A,ae,ue,se,ne,ve,U;const s=e.profiles[a]??e.profiles[((h=e.players[0])==null?void 0:h.player_id)??""]??Object.values(e.profiles)[0],o=e.players.reduce((N,oe)=>(N[oe.player_id]=oe.role,N),{}),r=Object.entries(e.narrative.nodes).map(([N,oe])=>({id:N,title:oe.title,body:oe.title,choices:oe.choices.map(K=>({id:K.id,label:K.id,nextNodeId:K.next,tensionDelta:K.tension,mutator:K.modifier}))})),l=e.pvp.winner??null,c=e.telemetry.failures>0?"failure":l?"success":"mixed";return{seed:e.seed,raid:{party:e.players.map(N=>N.player_id),roles:o,objectives:e.raid.objectives.map(N=>({id:N.id,label:N.label,progress:N.progress,target:N.target,completed:N.completed})),completed:e.raid.completed},campaign:{depth:e.campaign.depth,lives:e.campaign.lives,currentMission:{id:e.campaign.current_mission.id,title:e.campaign.current_mission.title,difficulty:e.campaign.current_mission.difficulty,hazards:e.campaign.current_mission.hazards,rewardCredits:e.campaign.current_mission.reward_tokens,missionSeed:e.campaign.current_mission.mission_seed??n.campaign.currentMission.missionSeed??e.seed,blueprint:e.campaign.current_mission.blueprint??n.campaign.currentMission.blueprint??`seed=${e.seed};depth=${e.campaign.depth}`},completedMissionIds:e.campaign.completed_missions,mutators:[...e.campaign.modifiers,...e.campaign.unlocked_modifiers]},narrative:{currentNodeId:e.narrative.current_node_id,nodes:r.length>0?r:n.narrative.nodes,history:e.narrative.history.map(N=>({nodeId:N.node_id,choiceId:N.choice_id})),tension:e.narrative.tension},skills:{points:(s==null?void 0:s.skill_points)??n.skills.points,nodes:n.skills.nodes.map(N=>({...N,unlocked:!!(s!=null&&s.unlocked_skills.includes(N.id))})),loadout:{capacity:(s==null?void 0:s.loadout_capacity)??n.skills.loadout.capacity,equipped:(s==null?void 0:s.loadout)??[],slotCaps:n.skills.loadout.slotCaps}},pvp:{round:e.pvp.round,stability:e.pvp.operator_stability,sabotage:e.pvp.sabotage_pressure,fog:e.pvp.fog,winner:l},time:{activeForkId:e.time.active_fork_id,forks:e.time.forks.map(N=>({id:N.id,label:N.label,playheadMs:N.playhead_ms,history:N.history}))},boss:{name:e.boss.name,phase:e.boss.phase,hp:e.boss.hp,maxHp:e.boss.max_hp,enraged:e.boss.enraged,phaseMechanic:e.boss.phase_mechanic??(e.boss.phase===1?"Phase 1: Shield lattice destabilization":e.boss.phase===2?"Phase 2: Mirror clones absorb exploit damage":"Phase 3: Enrage pulse; shield counters become lethal"),vulnerability:e.boss.vulnerability==="strike"||e.boss.vulnerability==="shield"||e.boss.vulnerability==="exploit"?e.boss.vulnerability:e.boss.phase===1?"exploit":e.boss.phase===2?"strike":"shield"},director:{risk:e.director.risk,hint:e.director.hint,recommendedModifier:e.director.hazard_bias,lastOutcome:c},economy:{credits:e.economy.tokens,materials:e.economy.materials,crafted:e.economy.crafted,reserveTarget:((f=e.economy.policy)==null?void 0:f.target_reserve)??n.economy.reserveTarget??320,inflationIndex:e.economy.inflation_index??Number((e.economy.tokens/(((y=e.economy.policy)==null?void 0:y.target_reserve)??n.economy.reserveTarget??320)).toFixed(3))},rewards:{dailyClaimedOn:((g=e.rewards)==null?void 0:g.daily_claimed_date)??((v=n.rewards)==null?void 0:v.dailyClaimedOn)??null,streakDays:((x=e.rewards)==null?void 0:x.streak_days)??((m=n.rewards)==null?void 0:m.streakDays)??0,sessionClaimed:((S=e.rewards)==null?void 0:S.session_claimed)??((k=n.rewards)==null?void 0:k.sessionClaimed)??!1,streakClaimedFor:((T=e.rewards)==null?void 0:T.streak_claimed_for)??((z=n.rewards)==null?void 0:z.streakClaimedFor)??0,masteryClaims:((M=e.rewards)==null?void 0:M.mastery_claims)??((D=n.rewards)==null?void 0:D.masteryClaims)??[],history:((H=(q=e.rewards)==null?void 0:q.history)==null?void 0:H.map(N=>({id:N.id,kind:N.kind==="daily"||N.kind==="session"||N.kind==="streak"||N.kind==="mastery"?N.kind:"daily",amount:N.amount,at:Date.parse(N.at)||Date.now(),details:N.details?Object.fromEntries(Object.entries(N.details).map(([oe,K])=>[oe,String(K)])):{}})))??((P=n.rewards)==null?void 0:P.history)??[]},guild:{name:e.guild.guild_id??"Trace Guild",members:e.players.length,operationsScore:e.guild.operations_score,eventsCompleted:e.guild.events_completed},cinematic:{queue:e.cinematic.events.map(N=>({id:N.id,type:N.type==="critical"||N.type==="success"||N.type==="warning"||N.type==="twist"?N.type:"warning",message:N.message,intensity:N.intensity||1,at:Date.parse(N.at)||Date.now()}))},liveops:{season:e.liveops.season,week:e.liveops.week,challenge:{id:e.liveops.challenge.id,title:e.liveops.challenge.title,goal:e.liveops.challenge.goal,progress:e.liveops.challenge.progress,rewardCredits:e.liveops.challenge.reward,completed:e.liveops.challenge.completed},difficultyFactor:e.liveops.telemetry.difficultyFactor??n.liveops.difficultyFactor??1,rewardMultiplier:e.liveops.telemetry.rewardMultiplier??n.liveops.rewardMultiplier??1,tuningHistory:((j=e.liveops.tuning_history)==null?void 0:j.map(N=>({id:N.id,changedAt:Date.parse(N.changed_at)||Date.now(),difficultyFactor:N.difficultyFactor,rewardMultiplier:N.rewardMultiplier,note:N.note})))??n.liveops.tuningHistory??[]},teamComms:{pings:((I=(L=e.team_comms)==null?void 0:L.pings)==null?void 0:I.map(N=>({id:N.id,fromPlayerId:N.from_player_id,intent:N.intent==="focus"||N.intent==="assist"||N.intent==="defend"||N.intent==="rotate"?N.intent:"focus",targetObjectiveId:N.target_objective_id??null,createdAt:Date.parse(N.created_at)||Date.now()})))??n.teamComms.pings??[]},safety:{mutedPlayerIds:((C=e.safety)==null?void 0:C.muted_player_ids)??n.safety.mutedPlayerIds??[],blockedPlayerIds:((R=e.safety)==null?void 0:R.blocked_player_ids)??n.safety.blockedPlayerIds??[],reports:((A=(W=e.safety)==null?void 0:W.reports)==null?void 0:A.map(N=>({id:N.id,targetPlayerId:N.target_player_id,reason:N.reason,createdAt:Date.parse(N.created_at)||Date.now()})))??n.safety.reports??[]},outcome:e.status==="completed"?{status:e.telemetry.successes>=e.telemetry.failures?"win":"loss",reason:e.telemetry.successes>=e.telemetry.failures?"Session completed with positive outcomes.":"Session completed with unresolved failures.",updatedAt:Date.now()}:e.telemetry.failures>0?{status:"partial",reason:`${e.telemetry.failures} failure signals observed; run still active.`,updatedAt:Date.now()}:n.outcome??{status:"in_progress",reason:"Run in progress.",updatedAt:Date.now()},sandbox:{enabled:((ae=e.sandbox)==null?void 0:ae.enabled)??((ue=n.sandbox)==null?void 0:ue.enabled)??!1},progression:{xp:(s==null?void 0:s.xp)??((se=n.progression)==null?void 0:se.xp)??0,level:(s==null?void 0:s.level)??((ne=n.progression)==null?void 0:ne.level)??1,nextLevelXp:((s==null?void 0:s.level)??((ve=n.progression)==null?void 0:ve.level)??1)*200,milestones:(s==null?void 0:s.milestones)??((U=n.progression)==null?void 0:U.milestones)??[]}}}function Er(){const e=window.sessionStorage.getItem("agentDirector.sessionId");if(e)return e;const a=`session-${Math.random().toString(36).slice(2,10)}`;return window.sessionStorage.setItem("agentDirector.sessionId",a),a}function xn(){try{const e=window.localStorage.getItem(ua);if(!e)return{};const a=JSON.parse(e),n={};return Object.entries(a).forEach(([s,o])=>{typeof o=="number"&&(n[s]=o)}),n}catch{return{}}}function vn(e,a=Date.now()){return Object.fromEntries(Object.entries(e).filter(([,n])=>a-n<br))}function Tr(){var Fa,qa;const{trace:e,insights:a,loading:n,error:s,reload:o,traces:r,selectedTraceId:l,setSelectedTraceId:p}=Ki(),[c,h]=te("agentDirector.mode","cinema"),[f,y]=d.useState(""),g=d.useDeferredValue(f),[v,x]=d.useState("all"),[m,S]=d.useState(""),[k,T]=d.useState(null),[z,M]=d.useState(null),[D,q]=d.useState(null),[H,P]=d.useState([]),[j,L]=d.useState(""),[I,C]=d.useState(null),[R,W]=d.useState(!1),[A,ae]=d.useState(null),[ue,se]=te("agentDirector.safeExport",!1),[ne,ve]=te("agentDirector.syncPlayback",!0),[U,N]=d.useState(null),[oe,K]=d.useState(!1),[ie,O]=d.useState(0),[ce,be]=te("agentDirector.speed",1),[Fe,Re]=te("agentDirector.windowed",!1),[at,mt]=d.useState(2e4),[E,J]=d.useState(!1),[he,me]=d.useState(!1),[qe,ge]=te("agentDirector.overlayEnabled",!1),[_n,Rn]=te("agentDirector.onboarded",!1),[,Je]=te("agentDirector.tourCompleted",!1),[Ee,we]=te("agentDirector.explainMode",!0),[Dt,At]=te("agentDirector.heroDismissed",!1),[On,$t]=te("agentDirector.dockOpen",!1),[Te,Ln]=te("agentDirector.introPersona","builder"),[_t,Rt]=te("agentDirector.launchPath","rapid_triage"),[ht,Pn]=te("agentDirector.themeMode","studio"),[Ot,Fn]=te("agentDirector.motionMode","balanced"),[de,ya]=te("agentDirector.timelineLaneStrategy","type"),[ba,ze]=te("agentDirector.timelineStudioConfig",ct),[ft,fe]=te("agentDirector.missions",{playback:!1,flow:!1,inspect:!1,matrix:!1,replay:!1,annotate:!1,collaborate:!1}),yt=!1,[bt,gt]=te("agentDirector.introDismissed",yt),[Lt,pe]=d.useState(!1),[Y,xt]=d.useState(null),[vt,Pt]=d.useState([]),[Ft,qt]=d.useState(null),[qn,ga]=d.useState(null),[Gt,Bt]=d.useState(""),[Gn,We]=d.useState([{id:Ct(),name:"Prompt tighter",strategy:"hybrid",modificationsText:'{"prompt":"Return concise response"}'},{id:Ct(),name:"Recorded baseline",strategy:"recorded",modificationsText:"{}"}]),[nt,Ht]=d.useState(null),[ke,xa]=d.useState(null),[Bn,wt]=d.useState(!1),[Hn,st]=d.useState(null),[V,ot]=te("agentDirector.gameplayState.v1",fn("bootstrap")),[le,va]=te("agentDirector.gameplayTraceId.v1",""),[je]=te("agentDirector.gameplayPlayerId.v1",`player-${Math.random().toString(36).slice(2,8)}`),[Se,Ke]=te("agentDirector.gameplaySessionId.v1",""),[re,Ce]=d.useState(null),[Un,Q]=d.useState(null),[Jn,Ye]=d.useState(null),[zn,kt]=d.useState(null),[Wn,Kn]=te("agentDirector.gameplayLocale.v1","en"),[Ut,Yn]=te("agentDirector.gamepad.enabled.v1",!0),[Jt,Qn]=te("agentDirector.gamepad.preset.v1","standard"),[Vn,wa]=d.useState(typeof navigator>"u"?!0:navigator.onLine),[Zn,ka]=d.useState(null),[Xn,ja]=d.useState(null),[zt,Sa]=d.useState(1),[es,Wt]=d.useState(null),[ts,Kt]=d.useState(null),[Na,Yt]=d.useState({}),[Ma,Qt]=d.useState([]),[as,Vt]=d.useState([]),[it,Zt]=d.useState(800),[ns,ss]=d.useState(0),Xt=d.useRef(null),Ca=d.useRef(null),Qe=d.useRef(Er()),Ia=d.useRef(0),Ea=d.useRef(0),ea=d.useRef(!1),Ta=d.useRef({}),jt=d.useRef({}),Oe=d.useMemo(()=>{if(!e)return[];const i=performance.now(),u=gn(e.steps,g,v);return Ea.current=performance.now()-i,u},[e,g,v]),ta=d.useMemo(()=>Oe.slice(0,Math.min(Oe.length,it)),[it,Oe]),Da=d.useMemo(()=>{if(!k)return ta;const i=new Set(k.matchedStepIds);return ta.filter(u=>i.has(u.id))},[ta,k]),os=d.useMemo(()=>U?gn(U.steps,g,v).slice(0,Math.min(U.steps.length,it)):[],[U,g,v,it]),Aa=d.useMemo(()=>e?er(e.startedAt,e.endedAt,e.steps):[],[e]),is=d.useMemo(()=>!e||!U?null:Sn(e,U),[e,U]),$a=d.useMemo(()=>e?e.steps.find(i=>i.id===A)??null:null,[e,A]),rt=d.useMemo(()=>e?wo(e.steps,de):[],[e,de]),Ve=d.useMemo(()=>{const i=ba[de]??ct[de];return Ua(rt,i.order,i.hidden)},[rt,de,ba]),rs=d.useMemo(()=>Ve.order.filter(i=>!Ve.hidden.includes(i)),[Ve.hidden,Ve.order]),St=d.useMemo(()=>{const i=Qe.current;return Object.values(Na).filter(u=>u.sessionId!==i).filter(u=>u.traceId===((e==null?void 0:e.id)??"none")).sort((u,b)=>b.updatedAt-u.updatedAt)},[Na,e==null?void 0:e.id]),ls=d.useMemo(()=>St.map(i=>i.playheadMs),[St]),cs=d.useMemo(()=>Ma.filter(i=>i.traceId===(e==null?void 0:e.id)),[Ma,e==null?void 0:e.id]),_a=d.useMemo(()=>{const i=Object.keys(ft).length,u=Object.values(ft).filter(Boolean).length;return{done:u,total:i,pct:i>0?Math.round(u/i*100):0}},[ft]),aa=d.useMemo(()=>{var _;if(!e)return 100;const i=100,u=Math.min(60,((a==null?void 0:a.errors)??0)*16),b=Math.min(24,((a==null?void 0:a.retries)??0)*6),w=e.metadata.wallTimeMs>6e4?12:e.metadata.wallTimeMs>3e4?6:0,$=(_=a==null?void 0:a.timing)!=null&&_.degraded?8:0;return Math.max(0,Math.min(100,Math.round(i-u-b-w-$)))},[a==null?void 0:a.errors,a==null?void 0:a.retries,(Fa=a==null?void 0:a.timing)==null?void 0:Fa.degraded,e]),ds=d.useMemo(()=>c==="flow"?"F / C / Space":c==="compare"?"C / Space / ← →":c==="matrix"?"G / C / Cmd+K":c==="gameplay"?"G / S / Cmd+K":"C / F / Space",[c]);d.useEffect(()=>{e&&e.id!==le&&(ot(fn(e.id)),va(e.id))},[le,ot,va,e]),d.useEffect(()=>{let i=!1;if(!Se){Ce(null);return}return ra().then(u=>{i||(Ce(u),u||Q("Gameplay session not found."))}),()=>{i=!0}},[Se]),d.useEffect(()=>{if(!Se)return;const i=Wi();return()=>i()},[Se]),d.useEffect(()=>{re&&ot(i=>Ir(re,je,i))},[je,re,ot]),d.useEffect(()=>{let i=!1;if(!(re==null?void 0:re.guild.guild_id)){Ye(null);return}return Hi().then(b=>{i||Ye(b)}),()=>{i=!0}},[re==null?void 0:re.guild.guild_id]),d.useEffect(()=>{let i=!1;return rn().then(u=>{i||u&&kt(u)}),()=>{i=!0}},[je,re==null?void 0:re.id]),d.useEffect(()=>{if(typeof window>"u")return;const i=()=>wa(!0),u=()=>wa(!1);return window.addEventListener("online",i),window.addEventListener("offline",u),()=>{window.removeEventListener("online",i),window.removeEventListener("offline",u)}},[]),d.useEffect(()=>{if(!Ut){jt.current={};return}if(typeof navigator>"u"||typeof navigator.getGamepads!="function")return;const i=Jt==="lefty"?{playPause:1,palette:3,modeCycle:2,speedDown:6,speedUp:7}:{playPause:0,palette:2,modeCycle:3,speedDown:4,speedUp:5},u=["cinema","flow","compare","matrix","gameplay"];let b=0;const w=(_,B,G)=>{const Z=!!jt.current[B];_&&!Z&&G(),jt.current[B]=_},$=()=>{var B,G,Z,Me,Ga;const _=navigator.getGamepads()[0];_&&(w(!!((B=_.buttons[i.playPause])!=null&&B.pressed),"playPause",()=>K(He=>!He)),w(!!((G=_.buttons[i.palette])!=null&&G.pressed),"palette",()=>me(!0)),w(!!((Z=_.buttons[i.modeCycle])!=null&&Z.pressed),"modeCycle",()=>{h(He=>{const Xs=u.indexOf(He);return u[(Xs+1)%u.length]})}),w(!!((Me=_.buttons[i.speedDown])!=null&&Me.pressed),"speedDown",()=>{be(He=>Math.max(.25,Number((He-.25).toFixed(2))))}),w(!!((Ga=_.buttons[i.speedUp])!=null&&Ga.pressed),"speedUp",()=>{be(He=>Math.min(3,Number((He+.25).toFixed(2))))})),b=window.requestAnimationFrame($)};return b=window.requestAnimationFrame($),()=>{window.cancelAnimationFrame(b),jt.current={}}},[Ut,Jt,h,be]),d.useEffect(()=>{let i=!1;const u=async()=>{const[w,$]=await Promise.all([ln(),cn()]);i||(w&&ka(w),$&&ja($))};u();const b=window.setInterval(()=>{u()},3e4);return()=>{i=!0,window.clearInterval(b)}},[]),d.useEffect(()=>{T(null),M(null)},[e==null?void 0:e.id]),d.useEffect(()=>{ss(Math.round(Ea.current))},[Oe]),d.useEffect(()=>{if(!e)return;const i=Oe.length;if(i<=1200){Zt(i);return}Zt(800);const u=window.setInterval(()=>{Zt(b=>b>=i?(window.clearInterval(u),i):Math.min(i,b+1e3))},70);return()=>window.clearInterval(u)},[Oe.length,e]),d.useEffect(()=>{let i=!1;if(!(e!=null&&e.id)){q(null);return}return Ii(e.id).then(u=>{i||q(u)}),()=>{i=!0}},[e==null?void 0:e.id]),d.useEffect(()=>{let i=!1;return Ei().then(u=>{i||(P(u),!j&&u.length>0&&L(u[0].id))}),()=>{i=!0}},[j]),d.useEffect(()=>{Ca.current=U},[U]),d.useEffect(()=>(document.body.dataset.theme=ht,()=>{delete document.body.dataset.theme}),[ht]),d.useEffect(()=>(document.body.dataset.motion=Ot,()=>{delete document.body.dataset.motion}),[Ot]),d.useEffect(()=>{const i=Qe.current,u=(G=!1)=>{const Z=Date.now(),Me=vn(xn(),Z);G?delete Me[i]:Me[i]=Z,window.localStorage.setItem(ua,JSON.stringify(Me)),Sa(Math.max(1,Object.keys(Me).length))},b=()=>{const G=vn(xn(),Date.now());Sa(Math.max(1,Object.keys(G).length))};u();const w=window.setInterval(()=>u(),gr),$=G=>{G.key===ua&&b()},_=()=>{document.visibilityState==="visible"&&u()},B=()=>u(!0);return window.addEventListener("storage",$),document.addEventListener("visibilitychange",_),window.addEventListener("beforeunload",B),()=>{window.clearInterval(w),u(!0),window.removeEventListener("storage",$),document.removeEventListener("visibilitychange",_),window.removeEventListener("beforeunload",B)}},[]),d.useEffect(()=>{c==="compare"&&$t(!1)},[c,$t]),d.useEffect(()=>{rt.length!==0&&ze(i=>{const u=i[de]??ct[de],b=Ua(rt,u.order,u.hidden);return b.order.join("|")===u.order.join("|")&&b.hidden.join("|")===u.hidden.join("|")?i:{...i,[de]:b}})},[rt,de,ze]),d.useEffect(()=>{Yt(Pe(window.localStorage.getItem(et),{})),Qt(Pe(window.localStorage.getItem(la),[])),Vt(Pe(window.localStorage.getItem(ca),[]))},[]),d.useEffect(()=>{const i=Date.now();if(i-Ia.current<120&&oe)return;Ia.current=i;const u=Qe.current,b={sessionId:u,traceId:(e==null?void 0:e.id)??"none",mode:c,playheadMs:Math.round(ie),selectedStepId:A,updatedAt:i},$={...Pe(window.localStorage.getItem(et),{}),[u]:b};window.localStorage.setItem(et,JSON.stringify($)),Yt($)},[oe,c,ie,A,e==null?void 0:e.id]),d.useEffect(()=>{const i=Qe.current;return()=>{const u=Pe(window.localStorage.getItem(et),{});if(!u[i])return;const b={...u};delete b[i],window.localStorage.setItem(et,JSON.stringify(b))}},[]),d.useEffect(()=>{const i=u=>{if(u.key===et&&Yt(Pe(u.newValue,{})),u.key===la){const b=Pe(u.newValue,[]);Qt(w=>pn(w,b))}u.key===ca&&Vt(mn(Pe(u.newValue,[])))};return window.addEventListener("storage",i),()=>window.removeEventListener("storage",i)},[]);const F=d.useCallback(i=>{const u={id:`activity-${Math.random().toString(36).slice(2,9)}`,sessionId:Qe.current,message:i,timestamp:Date.now()};Vt(b=>{const w=mn([u,...b]);return window.localStorage.setItem(ca,JSON.stringify(w)),w})},[]),ye=d.useCallback((i,u,b)=>{Ta.current[i]||(Ta.current[i]=!0,Zi(u,b))},[]),De=d.useCallback(async i=>{if(!e)return;const u=await Di(e.id,i,"hybrid",{note:"UI replay"},e);u&&(N(u),ge(!0),h("flow"),fe(b=>b.replay?b:{...b,replay:!0}),F(`Created replay from ${i}`))},[F,fe,e,N,h,ge]),us=d.useCallback(async()=>{if(!e)return;if(!m.trim()){T(null),M(null);return}const i=await Ci(e.id,m.trim());if(!i){M("TraceQL query failed"),T(null);return}T(i),M(null);const u=i.matchedStepIds[0];u&&(ae(u),c!=="cinema"&&h("cinema"))},[c,h,e,m]),ps=d.useCallback(async()=>{if(!e||!j)return;W(!0);const i=await Ti(j,e.id);W(!1),i&&C(i.result)},[j,e]),Ne=d.useCallback(()=>{if(!e)return;const i=[...e.steps].sort((u,b)=>(b.durationMs??0)-(u.durationMs??0))[0];i&&(ae(i.id),h("cinema"))},[e,h]),Ra=d.useCallback(()=>{if(!e||e.steps.length===0)return null;const i=[...e.steps].sort((u,b)=>(b.durationMs??0)-(u.durationMs??0))[0];return(i==null?void 0:i.id)??null},[e]),Ge=d.useCallback(()=>{if(!e)return;const i=e.steps.find(u=>u.status==="failed");i&&(ae(i.id),h("cinema"))},[e,h]),na=d.useCallback(async()=>{if(!e)return;const i=new URL(window.location.href);i.searchParams.set("trace",l??e.id),i.searchParams.set("mode",c),A?i.searchParams.set("step",A):i.searchParams.delete("step");try{await navigator.clipboard.writeText(i.toString()),Wt("Live link copied")}catch{window.prompt("Copy live session link",i.toString()),Wt("Live link ready")}window.setTimeout(()=>Wt(null),1800)},[c,A,l,e]),ms=d.useCallback(i=>{ya(i),F(`Switched lane strategy to ${i}`)},[F,ya]),hs=d.useCallback(i=>{ze(u=>{const b=u[de]??ct[de],w=b.hidden.includes(i)?b.hidden.filter($=>$!==i):[...b.hidden,i];return{...u,[de]:{...b,hidden:w}}}),F(`Toggled lane visibility for ${i}`)},[F,de,ze]),fs=d.useCallback(async i=>{if(!e)return;const u=await Oi({traceId:e.id,name:i.trim()||"Night Ops"});if(!u){Q("Failed to create gameplay session.");return}Ce(u),Ke(u.id),Q(null),F(`Created gameplay session ${u.id}`)},[F,je,Ke,e]),ys=d.useCallback(async(i,u,b)=>{if(!i.trim()){Q("Session id is required.");return}const w=await Li({sessionId:i.trim(),playerId:u.trim()});if(!w){Q("Failed to join gameplay session.");return}Ce(w),Ke(w.id),Q(null),F(`Joined gameplay session ${w.id} as ${u}`)},[F,Ke]),bs=d.useCallback(async()=>{if(!Se)return;if(!await Pi()){Q("Failed to leave gameplay session.");return}Ce(null),Ke(""),Q(null),F(`Left gameplay session ${Se}`)},[F,je,Se,Ke]),gs=d.useCallback(async()=>{if(!Se)return;const i=await Fi();if(!i){Q("Failed to reconnect gameplay session.");return}Ce(i),Q(null),F(`Reconnected gameplay session ${Se}`)},[F,je,Se]),xs=d.useCallback(async(i,u)=>{if(!(re!=null&&re.id))return;const b=await on({sessionId:re.id,expectedVersion:re.version});if(b.session){Ce(b.session),Q(null),F(`Gameplay action: ${i}`);return}if(b.conflict){const w=await ra(re.id);w&&Ce(w),Q("Session changed by another player. Synced latest state.");return}Q(b.error??"Gameplay action failed.")},[F,je,re]),vs=d.useCallback(async(i,u)=>{if(!i.trim()||!u.trim()){Q("Guild id and name are required.");return}const b=await Bi({guildId:i.trim(),name:u.trim()});if(!b){Q("Failed to create guild.");return}if(Ye(b),re){const w=await on({sessionId:re.id,payload:{guild_id:b.id},expectedVersion:re.version});w.session&&Ce(w.session)}Q(null),F(`Created guild ${b.id}`)},[F,je,re]),ws=d.useCallback(async(i,u)=>{if(!i.trim()||!u.trim()){Q("Guild id and player id are required.");return}const b=await Ui(i.trim(),u.trim());if(!b){Q("Failed to join guild.");return}Ye(b),Q(null),F(`Joined guild ${b.id} as ${u}`)},[F]),ks=d.useCallback(async(i,u,b)=>{if(!i.trim()||!u.trim()||!b.trim()){Q("Guild id, title, and schedule are required.");return}const w=await Ji({guildId:i.trim(),title:u.trim(),scheduledAt:b.trim()});if(!w){Q("Failed to schedule guild event.");return}Ye(w.guild),Q(null),F(`Scheduled guild event ${w.event.id}`)},[F]),js=d.useCallback(async(i,u,b)=>{const w=await zi();if(!w){Q("Failed to complete guild event.");return}Ye(w),Q(null),F(`Completed guild event ${u}`)},[F]),Ss=d.useCallback(async i=>{const u=await qi({toPlayerId:i.trim().toLowerCase()});if(!u){Q("Failed to send friend invite.");return}kt(u.social),Q(null),F(`Sent friend invite to ${i}`)},[F,je]),Ns=d.useCallback(async i=>{const u=await Gi();if(!u){Q("Failed to accept friend invite.");return}kt(u),Q(null),F(`Accepted friend invite ${i}`)},[F,je]),Ms=d.useCallback(()=>{Q(null),o(),Se&&ra().then(i=>{i&&Ce(i)}),rn().then(i=>{i&&kt(i)}),ln().then(i=>{i&&ka(i)}),cn().then(i=>{i&&ja(i)}),F("Retried connectivity sync")},[F,je,Se,o]),Cs=d.useCallback((i,u)=>{ze(b=>{const w=b[de]??ct[de],$=[...w.order],_=$.indexOf(i);if(_===-1)return b;const B=u==="up"?_-1:_+1;if(B<0||B>=$.length)return b;const[G]=$.splice(_,1);return $.splice(B,0,G),{...b,[de]:{...w,order:$}}}),F(`Moved lane group ${i} ${u}`)},[F,de,ze]),Is=d.useCallback(()=>{fe({playback:!1,flow:!1,inspect:!1,matrix:!1,replay:!1,annotate:!1,collaborate:!1}),F("Reset onboarding missions")},[F,fe]),Es=d.useCallback((i,u)=>{if(!e||!i.trim())return;const b=Date.now(),w={id:`annotation-${Math.random().toString(36).slice(2,9)}`,traceId:e.id,stepId:u,body:i.trim(),authorSessionId:Qe.current,createdAt:b,updatedAt:b};Qt($=>{const _=pn($,[w]);return window.localStorage.setItem(la,JSON.stringify(_)),_}),fe($=>$.annotate?$:{...$,annotate:!0}),F(u?`Added annotation on step ${u}`:"Added trace annotation")},[F,fe,e]),Ts=d.useCallback((i,u)=>{We(b=>b.map(w=>w.id===i?{...w,...u}:w))},[]),Ds=d.useCallback(i=>{We(i)},[]),As=d.useCallback(()=>{We(i=>[...i,{id:Ct(),name:`Scenario ${i.length+1}`,strategy:"hybrid",modificationsText:"{}"}])},[]),$s=d.useCallback(i=>{We(u=>u.length<=1?u:u.filter(b=>b.id!==i))},[]),_s=d.useCallback(i=>{We(u=>{const b=u.findIndex(B=>B.id===i);if(b===-1)return u;const w=u[b],$={...w,id:Ct(),name:`${w.name} copy`},_=[...u];return _.splice(b+1,0,$),_})},[]),Rs=d.useCallback((i,u)=>{We(b=>{const w=b.findIndex(G=>G.id===i);if(w===-1)return b;const $=u==="up"?w-1:w+1;if($<0||$>=b.length)return b;const _=[...b],[B]=_.splice(w,1);return _.splice($,0,B),_})},[]),Os=d.useCallback(async i=>{var b;if(!e)return;const u=Gt||A||((b=e.steps[0])==null?void 0:b.id);if(!u){st("Select an anchor step before running the matrix.");return}try{wt(!0),st(null);const w=await Ai({traceId:e.id,stepId:u,scenarios:i});if(!w)throw new Error("Failed to create replay job.");Ht(w);let $=w;for(let B=0;B<30&&!($.status!=="queued"&&$.status!=="running");B+=1){const G=or(B);await new Promise(Me=>window.setTimeout(Me,G));const Z=await $i(w.id);if(!Z)break;$=Z,Ht(Z)}const _=await sn(w.id);if(!_)throw new Error("Replay job finished but matrix summary is unavailable.");xa(_),h("matrix"),F(`Ran matrix with ${i.length} scenario(s) from ${u}`)}catch(w){st(w instanceof Error?w.message:"Failed to run replay matrix.")}finally{wt(!1)}},[F,Gt,A,e,h]),Ls=d.useCallback(async()=>{if(nt){wt(!0);try{const i=await _i(nt.id);if(!i){st("Failed to cancel replay job.");return}Ht(i);const u=await sn(i.id);u&&xa(u),F(`Canceled matrix job ${nt.id}`)}finally{wt(!1)}}},[F,nt]),Ps=d.useCallback(async i=>{const u=await Nn();if(!(u!=null&&u.trace)){st("Could not load replay trace for compare view.");return}N(u.trace),ge(!0),h("compare"),F(`Opened matrix compare trace ${i}`)},[F,h,ge]),ee=d.useCallback(i=>{if(!(i===c||!e)){if((i==="flow"||i==="matrix"||i==="gameplay")&&K(!1),i==="flow"&&c==="cinema"&&Xt.current){const u=Xt.current,b=Mr(u),w=Cr(e.steps,u,e.id);ga({steps:e.steps,fromRects:b,toRects:w}),F("Morphed cinema to flow");return}h(i),F(`Switched mode to ${i}`)}},[F,c,e,K,h]),lt=d.useCallback(async i=>{if(Rt(i),i==="rapid_triage"){we(!0),ee("cinema"),Ge(),e!=null&&e.steps.some(u=>u.status==="failed")||Ne(),F("Started rapid triage launch path");return}if(i==="deep_diagnosis"){we(!0),ee("flow"),pe(!0),F("Started deep diagnosis launch path");return}ve(!0),ee("matrix"),await na(),F("Started team sync launch path")},[F,ee,Ne,Ge,we,Rt,ve,na,e]),sa=d.useCallback(()=>{c==="flow"&&ee("cinema"),K(i=>!i)},[c,ee]),Le=d.useCallback(()=>{xt(null),Pt([]),qt(null),K(!1)},[K]),Oa=d.useCallback(i=>[{id:"setup",label:"Opening the reel",duration:1100,action:()=>{we(!0),K(!1),O(0),ae(null),ge(!1),be(1),e&&e.steps.length<500&&Re(!1),ee("cinema")}},{id:"pace",label:"Pacing the timeline",duration:2200,action:()=>{ee("cinema"),K(!0),be(1.1)}},{id:"bottleneck",label:"Freeze on the bottleneck",duration:1600,action:()=>{K(!1),Ne()}},{id:"inspect",label:"Inspect the moment",duration:1600,action:()=>{i&&ae(i)}},{id:"flow",label:"Morph into flow",duration:2100,action:()=>{ee("flow")}},{id:"replay",label:"Director’s Cut replay",duration:2200,action:async()=>{if(!e)return;!Ca.current&&i&&await De(i),ge(!0),h("compare")}},{id:"compare",label:"Compare the cut",duration:2e3,action:()=>{K(!0),be(1)}},{id:"finale",label:"Final frame",duration:1100,action:()=>{K(!1)}}],[ee,De,Ne,we,K,h,ge,O,ae,be,Re,e]),Ze=d.useCallback(()=>{var u;if(!e)return;const i=A??Ra()??((u=e.steps[0])==null?void 0:u.id)??null;Pt(Oa(i)),xt({active:!0,step:0}),qt(e.id),pe(!1),J(!1),me(!1)},[Oa,Ra,A,e,me,J,Pt,xt,qt,pe]),Xe=d.useCallback(()=>{if(Y!=null&&Y.active){Le();return}Ze()},[Ze,Le,Y==null?void 0:Y.active]),Fs=d.useMemo(()=>{const u=[{id:"header",title:"Mission control",body:`Confirm run status and metadata. ${{builder:"Focus on payload flow, tool-call sequencing, and replay-ready steps.",executive:"Focus on bottlenecks, risk signals, and run-level outcome changes.",operator:"Focus on failure patterns, retries, and runtime reliability posture."}[Te]}`,target:'[data-tour="header"]',placement:"bottom"}];return Dt||u.push({id:"hero",title:"Director briefing",body:"Choose Tour, Story mode, or Explain to ramp up quickly.",target:'[data-tour="hero"]',placement:"bottom"}),u.push({id:"insights",title:"Fast diagnosis",body:Te==="executive"?"Jump straight to bottlenecks and high-cost segments for fast executive readouts.":Te==="operator"?"Jump to failures and retries first, then inspect impacted steps.":"Jump straight to bottlenecks, errors, and high-cost steps with one click.",target:'[data-tour="insights"]',placement:"bottom"},{id:"journey",title:"Director journey",body:"A narrative path that teaches how to watch, inspect, and direct a better run.",target:'[data-tour="journey"]',placement:"bottom"},{id:"toolbar",title:"Filters + modes",body:"Search, filter, and switch between Cinema, Flow, and Compare as the story evolves.",target:'[data-tour="toolbar"]',placement:"bottom"},{id:"quick-actions",title:"Quick actions",body:"Launch Story Mode, open the command palette, or jump to bottlenecks instantly.",target:'[data-tour="quick-actions"]',placement:"left"},{id:"stage",title:"Cinema stage",body:"The timeline shows every step as a scene. Scrub to see pacing and concurrency.",target:'[data-tour="stage"]',placement:"top"},{id:"inspector",title:"Inspector",body:Te==="executive"?"Open key moments to validate outcome impact and communication-ready summaries.":"Open any step to read payloads, apply redaction, and replay from that moment.",target:'[data-tour="inspector"]',placement:"left"},{id:"compare",title:"Compare runs",body:U?"Compare is live. Review deltas in cost, steps, and wall time side by side.":"Replay from a step to unlock compare mode and validate improvements.",target:'[data-tour="compare"]',placement:"top"}),u},[U,Dt,Te]),qs=d.useCallback(()=>{ga(null),h("flow")},[h]),Ie=d.useMemo(()=>{var w,$,_,B;if(!e)return[];const i=[],u=[...e.steps].sort((G,Z)=>(Z.durationMs??0)-(G.durationMs??0))[0],b=e.steps.find(G=>G.status==="failed");if(b&&A!==b.id&&i.push({id:"jump-error",title:"Investigate first failure",body:`${b.name} failed and should be inspected before optimization work.`,actionLabel:"Open failed step",tone:"warning",action:Ge}),u&&A!==u.id&&i.push({id:"jump-bottleneck",title:"Tackle latency bottleneck",body:`${u.name} is the slowest scene in this run and the best optimization target.`,actionLabel:"Open bottleneck",tone:"priority",action:Ne}),(w=D==null?void 0:D.hypotheses)!=null&&w[0]){const G=D.hypotheses[0];i.push({id:"investigate-hypothesis",title:G.title,body:G.summary,actionLabel:"Inspect evidence",tone:"info",action:()=>{const Z=G.evidenceStepIds[0];Z&&(ae(Z),c!=="cinema"&&h("cinema"))}})}if(c!=="matrix"&&i.push({id:"matrix-experiment",title:"Run scenario matrix",body:"Compare prompt and strategy alternatives from one anchor step to rank causal impact.",actionLabel:"Open matrix",tone:"info",action:()=>{var G;Bt(A??((G=e.steps[0])==null?void 0:G.id)??""),h("matrix")}}),!U&&(A||($=e.steps[0])!=null&&$.id)){const G=A??((_=e.steps[0])==null?void 0:_.id)??null;G&&i.push({id:"run-replay",title:"Create director replay",body:"Branch a replay trace and validate whether your change improves the run.",actionLabel:"Replay from step",tone:"info",action:()=>{De(G)}})}if((B=ke==null?void 0:ke.causalRanking)!=null&&B.length){const G=ke.causalRanking[0];i.push({id:"causal-factor",title:`Top causal factor: ${G.factor}`,body:`Confidence ${(G.confidence*100).toFixed(0)}% across ${G.evidence.samples} sample(s).`,actionLabel:"View matrix",tone:"priority",action:()=>h("matrix")})}return i.slice(0,4)},[U,De,D,Ne,Ge,c,ke,A,e,h]),Gs=d.useMemo(()=>Ie.map((i,u)=>{const b=i.tone==="warning"?"high":i.tone==="priority"?"medium":"low";return{id:`priority-${i.id}`,title:i.title,detail:i.body,severity:b,actionLabel:i.actionLabel,onAction:i.action,done:u===0?i.id==="jump-error"&&!!A||i.id==="jump-bottleneck"&&!!A:!1}}),[Ie,A]),Be=d.useMemo(()=>{var _,B;if(!e)return"No trace loaded.";const i=[...e.steps].sort((G,Z)=>(Z.durationMs??0)-(G.durationMs??0))[0],u=e.steps.filter(G=>G.status==="failed").length,b=(_=D==null?void 0:D.hypotheses)==null?void 0:_[0],w=(B=ke==null?void 0:ke.causalRanking)==null?void 0:B[0];return[`Run ${e.id} completed with ${e.steps.length} steps across ${e.metadata.wallTimeMs}ms.`,i?`Primary latency driver: ${i.name} (${i.durationMs??0}ms).`:null,u>0?`Observed ${u} failed step(s), indicating reliability risk.`:"No failed steps observed.",b?`Top investigation hypothesis: ${b.title} (${b.severity}).`:null,w?`Highest ranked causal factor from matrix: ${w.factor} (${(w.confidence*100).toFixed(0)}% confidence).`:null,"Recommended plan: inspect bottleneck evidence, validate with replay matrix, and lock in mitigations."].filter(Boolean).join(" ")},[D,ke==null?void 0:ke.causalRanking,e]),Bs=d.useCallback(i=>{var b,w;const u=i.toLowerCase();if(!e)return"No trace is loaded yet.";if(u.includes("bottleneck")||u.includes("slow")){const $=[...e.steps].sort((_,B)=>(B.durationMs??0)-(_.durationMs??0))[0];return $?`The primary bottleneck is ${$.name} at ${$.durationMs??0}ms. Prioritize this step for optimization and replay validation.`:"No bottleneck could be determined from current trace data."}if(u.includes("risk")||u.includes("failure")||u.includes("error")){const $=e.steps.filter(_=>_.status==="failed");return $.length?`Risk is concentrated in ${$.length} failed step(s), starting at ${((b=$[0])==null?void 0:b.name)??"unknown"}.`:"Failure risk appears low for this run; no failed steps were observed."}return u.includes("cost")?`Recorded run cost is ${(e.metadata.totalCostUsd??0).toFixed(4)} USD. Use matrix scenarios to evaluate cheaper prompt/strategy options.`:u.includes("next")||u.includes("action")?Ie.length?`Next action: ${((w=Ie[0])==null?void 0:w.title)??"Open matrix"}.`:"Next action: open Cinema mode, inspect bottleneck, then run the matrix.":Be},[Be,Ie,e]),Hs=d.useCallback(()=>{if(!e)return;const i=`# Director Narrative

${Be}

## Recommended Actions
${Ie.map(u=>`- ${u.title}: ${u.body}`).join(`
`)}`;Ao(`agent-director-narrative-${e.id}.md`,i,"text/markdown")},[Be,Ie,e]),Nt=d.useCallback(async()=>{if(!e)return;const i=Ie[0],u=e.steps.filter($=>$.status==="failed").length,w=[`Session handoff (${new Date().toISOString()})`,`Trace: ${e.id}`,`Mode: ${c}`,`Selected step: ${A??"none"}`,`Run health: ${aa}/100`,`Failures: ${u}`,`Wall time: ${e.metadata.wallTimeMs}ms`,`Top recommendation: ${i?`${i.title} -> ${i.actionLabel}`:"None"}`,`Narrative: ${Be}`].join(`
`);try{await navigator.clipboard.writeText(w),Kt("Handoff digest copied")}catch{window.prompt("Copy handoff digest",w),Kt("Handoff digest ready")}window.setTimeout(()=>Kt(null),2200)},[Be,Ie,c,aa,A,e]);d.useEffect(()=>{var b;if(!e)return;Mi(),O(0),K(!1);const i=Math.min(Math.max((e.metadata.wallTimeMs||1)*.2,5e3),6e4);mt(i),e.steps.length>500&&Re(!0),U||ge(!1),c==="compare"&&!U&&h("cinema");const u=A&&e.steps.some(w=>w.id===A)?A:((b=e.steps[0])==null?void 0:b.id)??"";Bt(w=>w&&e.steps.some($=>$.id===w)?w:u)},[e,U,c,A,h,Re,ge]),d.useEffect(()=>(document.body.classList.toggle("explain-mode",Ee),()=>{document.body.classList.remove("explain-mode")}),[Ee]),d.useEffect(()=>(document.body.classList.toggle("story-mode",!!(Y!=null&&Y.active)),()=>{document.body.classList.remove("story-mode")}),[Y==null?void 0:Y.active]),d.useEffect(()=>{if(!(Y!=null&&Y.active))return;const i=vt[Y.step];if(!i){Le();return}Promise.resolve(i.action());const u=window.setTimeout(()=>{xt(b=>b&&b.active?{...b,step:b.step+1}:b)},i.duration);return()=>window.clearTimeout(u)},[vt,Le,Y]),d.useEffect(()=>{Y!=null&&Y.active&&(!e||!Ft||e.id!==Ft&&Le())},[Y==null?void 0:Y.active,e,Ft,Le]),d.useEffect(()=>{bt||yt||ye(`tutorial_start:${(e==null?void 0:e.id)||le||V.seed}`,"funnel.tutorial_start",{traceId:(e==null?void 0:e.id)||le||"unknown",persona:Te,launchPath:_t})},[ye,V.seed,le,bt,Te,_t,yt,e==null?void 0:e.id]),d.useEffect(()=>{ie>0&&fe(i=>i.playback?i:{...i,playback:!0})},[ie,fe]),d.useEffect(()=>{c==="flow"&&fe(i=>i.flow?i:{...i,flow:!0}),c==="matrix"&&fe(i=>i.matrix?i:{...i,matrix:!0})},[c,fe]),d.useEffect(()=>{A&&fe(i=>i.inspect?i:{...i,inspect:!0})},[A,fe]),d.useEffect(()=>{zt>1&&fe(i=>i.collaborate?i:{...i,collaborate:!0})},[zt,fe]),d.useEffect(()=>{ye(`session_start:${le||V.seed}`,"funnel.session_start",{traceId:le||(e==null?void 0:e.id)||"unknown",seed:V.seed})},[ye,V.seed,le,e==null?void 0:e.id]),d.useEffect(()=>{V.raid.objectives.some(u=>u.progress>0)&&ye(`objective_progress:${le||V.seed}`,"funnel.first_objective_progress",{traceId:le||(e==null?void 0:e.id)||"unknown"})},[ye,V.raid.objectives,V.seed,le,e==null?void 0:e.id]),d.useEffect(()=>{V.outcome.status!=="in_progress"&&(ye(`first_outcome:${le||V.seed}`,"funnel.first_mission_outcome",{status:V.outcome.status,reason:V.outcome.reason}),(V.outcome.status==="win"||V.outcome.status==="loss")&&ye(`run_outcome:${le||V.seed}`,"funnel.run_outcome",{status:V.outcome.status,reason:V.outcome.reason}))},[ye,V.outcome.reason,V.outcome.status,V.seed,le]),d.useEffect(()=>{if(!ne||oe||ea.current)return;const i=St[0];if(!i||i.traceId!==(e==null?void 0:e.id))return;const u=Math.abs(i.playheadMs-ie),b=i.mode!==c,w=(i.selectedStepId??null)!==(A??null);u<600&&!b&&!w||(ea.current=!0,O(i.playheadMs),(i.mode==="cinema"||i.mode==="flow"||i.mode==="compare"||i.mode==="matrix"||i.mode==="gameplay")&&h(i.mode),ae(i.selectedStepId??null),window.setTimeout(()=>{ea.current=!1},180))},[oe,c,ie,St,A,h,ne,e==null?void 0:e.id]),d.useEffect(()=>{if(!e)return;const u=Date.parse(e.startedAt)+ie;let b=0,w=Number.POSITIVE_INFINITY;e.steps.forEach((_,B)=>{const G=Date.parse(_.startedAt),Z=Date.parse(_.endedAt??_.startedAt);if(u>=G&&u<=Z){b=B,w=0;return}const Me=Math.min(Math.abs(u-G),Math.abs(u-Z));Me<w&&(w=Me,b=B)}),[b,b-1,b+1].filter(_=>_>=0&&_<e.steps.length).forEach(_=>{const B=e.steps[_];B&&Si(e.id,B.id,ue)})},[e,ie,ue]),d.useEffect(()=>{if(!e||!oe||c!=="cinema"&&c!=="compare")return;const i=(U==null?void 0:U.metadata.wallTimeMs)??0,u=c==="compare"?Math.max(e.metadata.wallTimeMs||1,i||1):e.metadata.wallTimeMs||1;let b=0,w=performance.now();const $=_=>{const B=(_-w)*ce;w=_,O(G=>{const Z=G+B;return Z>=u?(K(!1),u):Z}),b=requestAnimationFrame($)};return b=requestAnimationFrame($),()=>cancelAnimationFrame(b)},[e,U,oe,ce,c]),d.useEffect(()=>{const i=u=>{var _;const b=u.target,w=(_=b==null?void 0:b.tagName)==null?void 0:_.toLowerCase();if(!(w==="input"||w==="textarea"||w==="select"||b!=null&&b.isContentEditable)){if((u.metaKey||u.ctrlKey)&&u.key.toLowerCase()==="k"){u.preventDefault(),me(B=>!B);return}if(u.key==="?"||u.key==="/"&&u.shiftKey){u.preventDefault(),J(!0);return}if(u.key.toLowerCase()==="s"){u.preventDefault(),Xe();return}if(u.key.toLowerCase()==="e"){u.preventDefault(),we(B=>!B);return}if(u.key.toLowerCase()==="t"){u.preventDefault(),pe(!0);return}if(u.key==="Escape"){if(Lt){pe(!1),Je(!0);return}J(!1),me(!1),ae(null);return}if(u.key===" "){u.preventDefault(),(c==="cinema"||c==="compare")&&K(B=>!B);return}if(u.key.toLowerCase()==="f"){u.preventDefault(),c==="flow"?h("cinema"):c==="cinema"&&ee("flow");return}if(u.key.toLowerCase()==="c"){u.preventDefault(),c!=="cinema"&&h("cinema");return}if(u.key.toLowerCase()==="g"){u.preventDefault(),ee("gameplay");return}if(u.key.toLowerCase()==="i"){u.preventDefault(),A?ae(null):e!=null&&e.steps.length&&ae(e.steps[0].id);return}if(u.key==="ArrowLeft"||u.key==="ArrowRight"){if(u.preventDefault(),!e)return;const B=e.metadata.wallTimeMs||1;if(u.shiftKey){O(u.key==="ArrowLeft"?0:B),K(!1),h("cinema");return}const G=u.key==="ArrowRight"?1:-1,Z=tr(Aa,ie,G);Z!=null&&(O(Z),K(!1),h("cinema"))}}};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[c,A,e,ie,Aa,ee,h,we,me,pe,Je,Lt,Xe]);const La=d.useMemo(()=>{if(!e||!Fe||f)return null;const i=e.metadata.wallTimeMs||1,u=Math.min(Math.max(at,5e3),i);let b=Math.max(0,ie-u/2);const w=Math.min(i,b+u);return w-b<u&&(b=Math.max(0,w-u)),{startMs:b,endMs:w}},[e,Fe,ie,f,at]),Ae=!!(Y!=null&&Y.active),Pa=(Y==null?void 0:Y.step)??0,Us=((qa=vt[Pa])==null?void 0:qa.label)??"Wrapping up",Js=vt.length,zs=f!==g,Ws=`${Math.min(Oe.length,it)}/${Oe.length}`,Ks=d.useMemo(()=>[{id:"macro-rapid-triage",label:"Run rapid triage launch path",description:"Jump to the highest-risk step and start mitigation.",group:"Macros",onTrigger:()=>{lt("rapid_triage")}},{id:"macro-deep-diagnosis",label:"Run deep diagnosis launch path",description:"Open flow analysis and guided tour.",group:"Macros",onTrigger:()=>{lt("deep_diagnosis")}},{id:"macro-team-sync",label:"Run team sync launch path",description:"Enable sync mode and generate shareable context.",group:"Macros",onTrigger:()=>{lt("team_sync")}},{id:"story-toggle",label:Ae?"Stop story mode":"Start story mode",description:"Auto-runs a cinematic walkthrough.",group:"Story",keys:"S",onTrigger:Xe},{id:"tour-start",label:"Start guided tour",description:"Walk the interface step by step.",group:"Onboarding",keys:"T",onTrigger:()=>pe(!0)},{id:"explain-toggle",label:Ee?"Disable explain mode":"Enable explain mode",description:"Toggle contextual overlays.",group:"Onboarding",keys:"E",onTrigger:()=>we(i=>!i)},{id:"shortcuts",label:"Show shortcuts",description:"Open the keyboard map.",group:"Onboarding",keys:"?",onTrigger:()=>J(!0)},{id:"playback-toggle",label:oe?"Pause playback":"Play playback",description:"Start or stop the run.",group:"Playback",keys:"Space",onTrigger:sa},{id:"mode-cinema",label:"Switch to Cinema",description:"Timeline playback view.",group:"Modes",keys:"C",onTrigger:()=>ee("cinema")},{id:"mode-flow",label:"Switch to Flow",description:"Graph dependency view.",group:"Modes",keys:"F",onTrigger:()=>ee("flow")},{id:"mode-compare",label:"Open Compare",description:"Side-by-side diff view.",group:"Modes",onTrigger:()=>ee("compare"),disabled:!U},{id:"mode-matrix",label:"Open Matrix",description:"Counterfactual replay matrix view.",group:"Modes",onTrigger:()=>ee("matrix")},{id:"mode-gameplay",label:"Open Gameplay",description:"World-class gameplay mechanics control center.",group:"Modes",keys:"G",onTrigger:()=>ee("gameplay")},{id:"jump-bottleneck",label:"Jump to bottleneck",description:"Select the slowest step.",group:"Navigation",onTrigger:Ne},{id:"jump-error",label:"Jump to error",description:"Select the first failed step.",group:"Navigation",onTrigger:Ge},{id:"replay-step",label:"Replay from selected step",description:"Branch a Director’s Cut.",group:"Tools",onTrigger:()=>A&&De(A),disabled:!A},{id:"overlay-toggle",label:qe?"Hide overlay":"Show overlay",description:"Ghost diff in Cinema/Flow.",group:"Tools",onTrigger:()=>ge(i=>!i),disabled:!U},{id:"safe-export",label:ue?"Disable safe export":"Enable safe export",description:"Redact sensitive payloads.",group:"Safety",onTrigger:()=>se(i=>!i)},{id:"reload",label:"Reload traces",description:"Refresh trace data.",group:"Meta",onTrigger:o},{id:"handoff-digest",label:"Copy handoff digest",description:"Capture mode, risk summary, and next actions for teammates.",group:"Meta",keys:"H",onTrigger:()=>{Nt()}}],[Nt,Ae,Xe,Ee,oe,sa,ee,U,Ne,Ge,A,De,qe,ue,o,we,ge,se,J,pe,lt]),Ys=d.useCallback(()=>{ye(`tutorial_skip:intro:${(e==null?void 0:e.id)||le||V.seed}`,"funnel.tutorial_skip",{traceId:(e==null?void 0:e.id)||le||"unknown",source:"intro_overlay"}),gt(!0)},[ye,V.seed,le,gt,e==null?void 0:e.id]),Qs=d.useCallback(()=>{gt(!0),pe(!0)},[gt,pe]),Vs=d.useCallback(()=>{ye(`tutorial_skip:tour:${(e==null?void 0:e.id)||le||V.seed}`,"funnel.tutorial_skip",{traceId:(e==null?void 0:e.id)||le||"unknown",source:"guided_tour"}),pe(!1),Je(!0)},[ye,V.seed,le,Je,e==null?void 0:e.id]),Zs=d.useCallback(()=>{ye(`tutorial_complete:${(e==null?void 0:e.id)||le||V.seed}`,"funnel.tutorial_complete",{traceId:(e==null?void 0:e.id)||le||"unknown"}),pe(!1),Je(!0)},[ye,V.seed,le,Je,e==null?void 0:e.id]);return n?t.jsx("div",{className:"loading",children:"Loading trace..."}):!s&&!e&&r.length===0?t.jsxs("div",{className:"error",children:[t.jsx("h2",{children:"No traces yet"}),t.jsx("p",{children:"Ingest your first trace, then reload to begin the Observe → Inspect → Direct workflow."}),t.jsxs("div",{className:"error-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:o,children:"Retry"}),t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer",children:"Open help"})]})]}):s||!e?t.jsxs("div",{className:"error",children:[t.jsx("p",{children:s??"Failed to load trace."}),t.jsxs("div",{className:"error-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:o,children:"Retry"}),t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer",children:"Open help"})]})]}):t.jsxs("div",{className:`app theme-${ht} ${Ee?"explain-mode":""} ${c==="compare"?"mode-compare":""} ${c==="matrix"?"mode-matrix":""} ${c==="gameplay"?"mode-gameplay":""}`,children:[t.jsx(io,{trace:e,traces:r,selectedTraceId:l,onSelectTrace:p,onReload:o,onStartTour:()=>pe(!0),onToggleStory:Xe,onOpenPalette:()=>me(!0),onToggleExplain:()=>we(i=>!i),onShareSession:na,onCreateHandoffDigest:()=>void Nt(),onThemeChange:Pn,onMotionChange:Fn,themeMode:ht,motionMode:Ot,activeSessions:zt,shareStatus:es,handoffStatus:ts,explainMode:Ee,storyActive:Ae,mode:c,missionCompletion:_a,runHealthScore:aa,modeHotkeys:ds}),!bt&&!yt?t.jsx(ti,{onComplete:Ys,onStartTour:Qs,onStartStory:Ze,persona:Te,onPersonaChange:Ln,launchPath:_t,onLaunchPathChange:Rt,onStartLaunchPath:i=>void lt(i)}):null,bt&&!Dt?t.jsx(ai,{explainMode:Ee,storyActive:Ae,onStartTour:()=>{At(!0),pe(!0)},onStartStory:()=>{At(!0),Ze()},onToggleExplain:()=>we(i=>!i),onDismiss:()=>At(!0)}):null,t.jsx(Vo,{steps:Fs,open:Lt,onClose:Vs,onComplete:Zs}),t.jsx(Zo,{enabled:Ee}),t.jsx(si,{active:Ae,label:Us,step:Pa,total:Js,onStop:Le,onRestart:Ze}),t.jsx(ro,{insights:a,investigation:D,onSelectStep:i=>{ae(i),c!=="cinema"&&h("cinema")},onJumpToError:Ge,onJumpToBottleneck:Ne}),t.jsx(Uo,{trace:e,mode:c==="matrix"||c==="gameplay"?"cinema":c,playheadMs:ie,selectedStepId:A,compareTrace:U,collapsed:_n,onToggleCollapsed:()=>Rn(i=>!i),onModeChange:ee,onSelectStep:i=>{ae(i),c!=="cinema"&&h("cinema")},onJumpToBottleneck:Ne,onReplay:De,onStartTour:()=>pe(!0),priorityQueue:Gs}),t.jsxs("div",{className:"toolbar","data-help":!0,"data-help-indicator":!0,"data-tour":"toolbar","data-help-title":"Search + filters","data-help-body":"Filter by step type, enable Safe export, and jump between Cinema, Flow, Compare, and Matrix.","data-help-placement":"bottom",children:[t.jsx(co,{query:f,typeFilter:v,onQueryChange:y,onTypeFilterChange:x}),t.jsxs("div",{className:"toolbar-actions",children:[t.jsx("input",{className:"search-input",value:m,onChange:i=>S(i.target.value),placeholder:"TraceQL (example: type=tool_call and duration_ms>800)","aria-label":"TraceQL query"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void us(),children:"Run TraceQL"}),k?t.jsxs("span",{className:"status-badge",children:[k.matchCount," match(es)"]}):null,zs?t.jsx("span",{className:"status-badge",children:"Filtering..."}):null,t.jsxs("span",{className:"status-badge",children:["Hydration ",Ws]}),t.jsxs("span",{className:"status-badge",children:["Filter ",ns,"ms"]}),k?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{S(""),T(null),M(null)},children:"Clear TraceQL"}):null,z?t.jsx("span",{className:"status-badge warn",children:z}):null,t.jsxs("select",{className:"search-select",value:j,onChange:i=>L(i.target.value),"aria-label":"Extension selector",children:[t.jsx("option",{value:"",children:"Select extension"}),H.map(i=>t.jsx("option",{value:i.id,children:i.name},i.id))]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void ps(),disabled:!e||!j||R,children:R?"Running extension...":"Run extension"}),t.jsx("button",{className:`ghost-button ${c==="cinema"?"active":""}`,type:"button","aria-pressed":c==="cinema",title:"Timeline playback",onClick:()=>ee("cinema"),"data-help":!0,"data-help-title":"Cinema mode","data-help-body":"Timeline view with step cards ordered by time.","data-help-placement":"bottom",children:"Cinema"}),t.jsx("button",{className:`ghost-button ${c==="flow"?"active":""}`,type:"button","aria-pressed":c==="flow",title:"Graph view",onClick:()=>ee("flow"),"data-help":!0,"data-help-title":"Flow mode","data-help-body":"Dependency graph of steps and tool calls.","data-help-placement":"bottom",children:"Flow"}),t.jsx("button",{className:`ghost-button ${c==="compare"?"active":""}`,type:"button","aria-pressed":c==="compare",title:U?"Side-by-side compare":"Run a replay to enable compare",onClick:()=>ee("compare"),disabled:!U,"data-tour":"compare","data-help":!0,"data-help-title":"Compare mode","data-help-body":"Side-by-side view after a replay. Enabled once you replay.","data-help-placement":"bottom",children:"Compare"}),t.jsx("button",{className:`ghost-button ${c==="matrix"?"active":""}`,type:"button","aria-pressed":c==="matrix",title:"Counterfactual replay matrix",onClick:()=>ee("matrix"),"data-help":!0,"data-help-title":"Matrix mode","data-help-body":"Run multiple replay scenarios and rank likely causal factors.","data-help-placement":"bottom",children:"Matrix"}),t.jsx("button",{className:`ghost-button ${c==="gameplay"?"active":""}`,type:"button","aria-pressed":c==="gameplay",title:"Gameplay mechanics command center",onClick:()=>ee("gameplay"),"data-help":!0,"data-help-title":"Gameplay mode","data-help-body":"Command raids, campaign, pvp, time forks, boss runs, economy, and liveops.","data-help-placement":"bottom",children:"Gameplay"}),t.jsxs("label",{className:"toggle",title:"Redact payloads and disable raw views for safe sharing","data-help":!0,"data-help-title":"Safe export","data-help-body":"Redacts secrets and disables raw payload views for safe sharing.","data-help-placement":"bottom",children:[t.jsx("input",{type:"checkbox",checked:ue,onChange:()=>se(i=>!i)}),"Safe export"]}),e.steps.length>200||Fe?t.jsxs("label",{className:"toggle",title:"Window steps around the playhead for large traces","data-help":!0,"data-help-title":"Windowed mode","data-help-body":"Limits rendering to a playhead window for large traces.","data-help-placement":"bottom",children:[t.jsx("input",{type:"checkbox",checked:Fe,onChange:()=>Re(i=>!i)}),"Windowed"]}):null,U?t.jsxs("label",{className:"toggle",title:"Show ghost overlay of replay in Cinema/Flow","data-help":!0,"data-help-title":"Overlay replay","data-help-body":"Layer the replay over the base run to spot differences.","data-help-placement":"bottom",children:[t.jsx("input",{type:"checkbox",checked:qe,onChange:()=>ge(i=>!i)}),"Overlay"]}):null,t.jsxs("label",{className:"toggle",title:"Follow active collaborator cursor and mode updates",children:[t.jsx("input",{type:"checkbox",checked:ne,onChange:()=>ve(i=>!i)}),"Sync playback"]})]})]}),I?t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Extension output"}),t.jsx("pre",{className:"inspector-json",children:JSON.stringify(I,null,2)})]}):null,c==="cinema"?t.jsxs("div",{className:"playback-stack","data-tour":"playback",children:[t.jsx("div",{"data-help":!0,"data-help-title":"Playback controls","data-help-body":"Play, pause, scrub, and adjust speed to feel the rhythm of the run.","data-help-placement":"bottom",children:t.jsx(za,{playheadMs:ie,wallTimeMs:e.metadata.wallTimeMs||1,isPlaying:oe,speed:ce,onToggle:()=>K(i=>!i),onScrub:i=>O(i),onSpeedChange:be})}),t.jsx("div",{"data-help":!0,"data-help-title":"Density map","data-help-body":"Zoom into hotspots and keep long traces readable with windowing.","data-help-placement":"bottom",children:t.jsx(Ro,{traceStart:e.startedAt,traceEnd:e.endedAt,steps:e.steps,playheadMs:ie,windowRange:La,windowed:Fe,spanMs:at,onSpanChange:mt,onToggleWindowed:Re,onScrub:i=>O(i),persistenceKey:e.id,laneStrategy:de,visibleLaneGroups:rs,remotePlayheads:ls})})]}):null,c==="compare"&&U?t.jsx("div",{"data-help":!0,"data-help-title":"Compare playback","data-help-body":"Sync both runs to evaluate improvements at identical timestamps.","data-help-placement":"bottom",children:t.jsx(za,{playheadMs:ie,wallTimeMs:Math.max(e.metadata.wallTimeMs||1,U.metadata.wallTimeMs||1),isPlaying:oe,speed:ce,onToggle:()=>K(i=>!i),onScrub:i=>O(i),onSpeedChange:be})}):null,t.jsxs("main",{className:`stage ${c==="compare"?"stage-compare":""} motion-fade-in`,role:"main",children:[t.jsx("div",{className:"main motion-slide-up",ref:Xt,"data-help":!0,"data-help-indicator":!0,"data-tour":"stage","data-help-title":"Trace stage","data-help-body":"Every step becomes a scene. Hover or click to open deep inspection.","data-help-placement":"top",children:t.jsx(ii,{morph:qn,onComplete:qs,children:t.jsxs(d.Suspense,{fallback:t.jsx("div",{className:"loading",children:"Loading view..."}),children:[c==="cinema"?t.jsx(Io,{trace:e,steps:Da,selectedStepId:A,onSelectStep:i=>ae(i),playheadMs:ie,windowRange:La,timing:a==null?void 0:a.timing,ghostTrace:qe?U:null,diff:is,laneStrategy:de,laneGroupsOrder:Ve.order,hiddenLaneGroups:Ve.hidden,onLaneStrategyChange:ms,onToggleLaneGroupVisibility:hs,onMoveLaneGroup:Cs}):null,c==="flow"?t.jsx(xr,{steps:Da,selectedStepId:A,onSelectStep:i=>ae(i),baseTrace:e,compareTrace:U,compareSteps:os,overlayEnabled:qe,onToggleOverlay:()=>ge(i=>!i)}):null,c==="compare"&&U?t.jsx(vr,{baseTrace:e,compareTrace:U,playheadMs:ie,safeExport:ue,onExit:()=>{h("cinema"),N(null)}}):null,c==="matrix"?t.jsx(kr,{steps:e.steps,anchorStepId:Gt,onAnchorStepChange:Bt,scenarios:Gn,onScenarioChange:Ts,onDuplicateScenario:_s,onMoveScenario:Rs,onAddScenario:As,onRemoveScenario:$s,onRun:Os,onCancel:Ls,onReplaceScenarios:Ds,loading:Bn,error:Hn,job:nt,matrix:ke,safeExport:ue,onOpenCompare:Ps}):null,c==="gameplay"?t.jsx(jr,{state:V,playheadMs:ie,onUpdate:i=>ot(u=>i(u)),session:re,playerId:je,sessionError:Un,onCreateSession:fs,onJoinSession:ys,onLeaveSession:bs,onReconnectSession:gs,onDispatchAction:xs,guild:Jn,social:zn,onInviteFriend:Ss,onAcceptFriendInvite:Ns,locale:Wn,onLocaleChange:Kn,gamepadEnabled:Ut,onToggleGamepad:Yn,gamepadPreset:Jt,onGamepadPresetChange:Qn,isOnline:Vn,onRetryConnectivity:Ms,onCreateGuild:vs,onJoinGuild:ws,onScheduleGuildEvent:ks,onCompleteGuildEvent:js,observability:Zn,analytics:Xn}):null]})})}),t.jsx(d.Suspense,{fallback:t.jsx("div",{className:"loading",children:"Loading panel..."}),children:c==="compare"||c==="matrix"||c==="gameplay"?null:$a?t.jsx(wr,{traceId:e.id,step:$a,safeExport:ue,onClose:()=>ae(null),onReplay:De}):t.jsx(Qo,{trace:e,mode:c,selectedStepId:A,onModeChange:ee,onSelectStep:i=>ae(i),onJumpToBottleneck:Ne,onReplay:De,recommendations:Ie,persona:Te,annotations:cs,activityFeed:as,onAddAnnotation:Es,missionProgress:ft,missionCompletion:_a,onResetMissions:Is,narrative:Be,onAskDirector:Bs,onExportNarrative:Hs})})]}),t.jsxs("div",{className:"mobile-quick-rail","aria-label":"Mobile quick actions",children:[t.jsx("button",{className:`ghost-button ${Ae?"active":""}`,type:"button",onClick:Xe,"aria-label":Ae?"Stop story mode":"Start story mode",children:Ae?"Stop Story":"Story"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>pe(!0),"aria-label":"Start guided tour",children:"Guide"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>me(!0),"aria-label":"Open command palette",children:"Command"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void Nt(),"aria-label":"Copy handoff digest",children:"Handoff"})]}),t.jsx(ni,{mode:c==="matrix"||c==="gameplay"?"cinema":c,isPlaying:oe,storyActive:Ae,explainMode:Ee,hidden:c==="compare",open:On,onToggleOpen:()=>$t(i=>!i),onTogglePlay:sa,onStartStory:Ze,onStopStory:Le,onStartTour:()=>pe(!0),onOpenPalette:()=>me(!0),onShowShortcuts:()=>J(!0),onToggleExplain:()=>we(i=>!i),onJumpToBottleneck:Ne}),t.jsx(Bo,{open:he,onClose:()=>me(!1),actions:Ks}),t.jsx(Lo,{open:E,onClose:()=>J(!1)})]})}eo.createRoot(document.getElementById("root")).render(t.jsx(to.StrictMode,{children:t.jsx(Tr,{})}));export{Kr as A,Xr as B,Yr as C,Qr as D,Vr as E,Zr as F,el as G,nl as H,sl as I,al as J,vo as S,Mo as T,Qi as a,Xi as b,Do as c,Sn as d,_r as e,$r as f,ji as g,Ao as h,ur as i,Or as j,pr as k,mr as l,Rr as m,Lr as n,tl as o,Pr as p,Fr as q,Gr as r,po as s,Br as t,qr as u,Hr as v,Ur as w,Jr as x,zr as y,Wr as z};
