const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DmHykuq0.js","assets/vendor-react-D4yGots9.js","assets/vendor-DClHNS3s.js","assets/vendor-B5DZHykP.css","assets/index-l3gohnbE.js","assets/index-EnB6Kfxk.js","assets/index-BRP7CN14.js","assets/index-CjFqSkU0.js"])))=>i.map(i=>d[i]);
import{j as t,r as c,a as qi,R as Gi}from"./vendor-react-D4yGots9.js";import{m as Bi,d as xs}from"./vendor-DClHNS3s.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const d of i)if(d.type==="childList")for(const l of d.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function s(i){const d={};return i.integrity&&(d.integrity=i.integrity),i.referrerPolicy&&(d.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?d.credentials="include":i.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function r(i){if(i.ep)return;i.ep=!0;const d=s(i);fetch(i.href,d)}})();const zi="modulepreload",Ui=function(e){return"/agent-director/"+e},vs={},zt=function(n,s,r){let i=Promise.resolve();if(s&&s.length>0){document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),p=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));i=Promise.allSettled(s.map(u=>{if(u=Ui(u),u in vs)return;vs[u]=!0;const f=u.endsWith(".css"),b=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${b}`))return;const y=document.createElement("link");if(y.rel=f?"stylesheet":zi,f||(y.as="script"),y.crossOrigin="",y.href=u,p&&y.setAttribute("nonce",p),document.head.appendChild(y),f)return new Promise((x,w)=>{y.addEventListener("load",x),y.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${u}`)))})}))}function d(l){const p=new Event("vite:preloadError",{cancelable:!0});if(p.payload=l,window.dispatchEvent(p),!p.defaultPrevented)throw l}return i.then(l=>{for(const p of l||[])p.status==="rejected"&&d(p.reason);return n().catch(d)})},Hi=()=>t.jsxs("svg",{className:"logo-mark",width:"54",height:"54",viewBox:"0 0 120 120",role:"img","aria-label":"Agent Director logo",children:[t.jsx("rect",{x:"8",y:"8",width:"104",height:"104",rx:"18",className:"logo-frame"}),t.jsx("rect",{x:"24",y:"28",width:"72",height:"16",rx:"6",className:"logo-bar logo-bar-a"}),t.jsx("rect",{x:"24",y:"52",width:"72",height:"16",rx:"6",className:"logo-bar logo-bar-b"}),t.jsx("rect",{x:"24",y:"76",width:"72",height:"16",rx:"6",className:"logo-bar logo-bar-c"}),t.jsx("circle",{cx:"96",cy:"36",r:"6",className:"logo-node logo-node-a"}),t.jsx("circle",{cx:"96",cy:"60",r:"6",className:"logo-node logo-node-b"}),t.jsx("circle",{cx:"96",cy:"84",r:"6",className:"logo-node logo-node-c"})]});function Wi({trace:e,traces:n=[],selectedTraceId:s,onSelectTrace:r,onReload:i,onStartTour:d,onToggleStory:l,onOpenPalette:p,onToggleExplain:u,onShareSession:f,onThemeChange:b,onMotionChange:y,themeMode:x="studio",motionMode:w="balanced",activeSessions:v=1,shareStatus:h=null,handoffStatus:k=null,explainMode:S=!1,storyActive:$=!1,mode:X="cinema",missionCompletion:E,runHealthScore:_=100,modeHotkeys:H="C / F / Space",onCreateHandoffDigest:F,onOpenSupport:B,workspaces:V=[],workspaceId:re,onWorkspaceChange:j,workspaceRole:I="operator",onWorkspaceRoleChange:R,sessionLabel:W="Active",sessionExpired:N=!1,onRenewSession:K}){const D=Math.max(0,Math.min(100,Math.round(_))),q=E?`${E.done}/${E.total} missions`:"Missions n/a";return t.jsxs("header",{className:"header","data-help":!0,"data-help-indicator":!0,"data-tour":"header","data-help-title":"Mission control","data-help-body":"Trace identity, status, and live controls live here. Use Story, Guide, or Explain to orient new viewers.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"header-title",children:[t.jsxs("div",{className:"header-logo",children:[t.jsx(Hi,{}),t.jsx("span",{children:"Agent Director"})]}),t.jsx("div",{className:"header-tagline",children:"Cinematic trace intelligence for agent runs."}),t.jsxs("div",{className:"header-meta",children:[t.jsxs("span",{className:"header-run",children:["Run: ",(e==null?void 0:e.id)??"loading"]}),n.length>0?t.jsx("select",{className:"trace-select",value:s??(e==null?void 0:e.id)??"","aria-label":"Select trace",onChange:P=>r==null?void 0:r(P.target.value),"data-help":!0,"data-help-title":"Trace selector","data-help-body":"Switch between available runs to compare different sessions.","data-help-placement":"bottom",children:n.map(P=>t.jsxs("option",{value:P.id,children:[P.name," (",P.id,")"]},P.id))}):null,t.jsx("span",{className:`status-pill status-${(e==null?void 0:e.status)??"loading"}`,children:(e==null?void 0:e.status)??"loading"}),e!=null&&e.replay?t.jsxs("span",{className:"header-replay",title:`Replay from ${e.branchPointStepId??"unknown step"}`,children:["Replay: ",e.replay.strategy]}):null,t.jsxs("span",{className:"header-wall",children:["Wall: ",(e==null?void 0:e.metadata.wallTimeMs)??0,"ms"]}),t.jsxs("span",{className:"header-presence","aria-label":"Active sessions",children:["Live: ",v]}),t.jsxs("span",{className:"header-mode-pill","aria-label":"Current mode",children:["Mode: ",X]}),re?t.jsxs("span",{className:"header-workspace-pill","aria-label":"Current workspace",children:["Workspace: ",re]}):null,t.jsxs("span",{className:`header-role-pill role-${I}`,"aria-label":"Current workspace role",children:["Role: ",I]}),t.jsxs("span",{className:`header-session-pill ${N?"expired":""}`,"aria-label":"Session status",children:["Session: ",W]}),t.jsxs("span",{className:"header-hotkeys","aria-label":"Mode hotkeys",children:["Keys: ",H]}),t.jsx("span",{className:"header-mission","aria-label":"Mission completion",children:q}),t.jsxs("span",{className:"header-health","aria-label":`Run health score ${D}`,children:[t.jsx("span",{className:"header-health-bar",children:t.jsx("span",{className:"header-health-fill",style:{width:`${D}%`}})}),t.jsxs("span",{children:["Health ",D]})]}),h?t.jsx("span",{className:"header-share-status",children:h}):null,k?t.jsx("span",{className:"header-share-status",children:k}):null]})]}),t.jsxs("div",{className:"header-actions",children:[t.jsxs("label",{className:"theme-picker",children:["Workspace",t.jsx("select",{className:"trace-select",value:re,"aria-label":"Select workspace",onChange:P=>j==null?void 0:j(P.target.value),children:V.map(P=>t.jsx("option",{value:P.id,children:P.label},P.id))})]}),t.jsxs("label",{className:"theme-picker",children:["Role",t.jsxs("select",{className:"trace-select",value:I,"aria-label":"Select workspace role",onChange:P=>R==null?void 0:R(P.target.value),children:[t.jsx("option",{value:"viewer",children:"Viewer"}),t.jsx("option",{value:"operator",children:"Operator"}),t.jsx("option",{value:"admin",children:"Admin"})]})]}),t.jsxs("label",{className:"theme-picker",children:["Theme",t.jsxs("select",{className:"trace-select",value:x,"aria-label":"Select theme",onChange:P=>b==null?void 0:b(P.target.value),children:[t.jsx("option",{value:"studio",children:"Studio"}),t.jsx("option",{value:"focus",children:"Focus"}),t.jsx("option",{value:"contrast",children:"Contrast"})]})]}),t.jsxs("label",{className:"theme-picker",children:["Motion",t.jsxs("select",{className:"trace-select",value:w,"aria-label":"Select motion profile",onChange:P=>y==null?void 0:y(P.target.value),children:[t.jsx("option",{value:"cinematic",children:"Cinematic"}),t.jsx("option",{value:"balanced",children:"Balanced"}),t.jsx("option",{value:"minimal",children:"Minimal"})]})]}),t.jsx("button",{className:`ghost-button ${$?"active":""}`,type:"button",onClick:l,"aria-pressed":$,"aria-label":"Toggle story mode","data-help":!0,"data-help-title":"Story mode","data-help-body":"Auto-runs a cinematic walkthrough for demos.","data-help-placement":"bottom",children:"Story"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:d,"aria-label":"Start guided tour","data-help":!0,"data-help-title":"Guided tour","data-help-body":"Walk through the interface step by step.","data-help-placement":"bottom",children:"Guide"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:p,"aria-label":"Open command palette","data-help":!0,"data-help-title":"Command palette","data-help-body":"Search and trigger any action instantly.","data-help-placement":"bottom",children:"Command"}),t.jsx("button",{className:`ghost-button ${S?"active":""}`,type:"button",onClick:u,"aria-pressed":S,"aria-label":"Toggle explain mode","data-help":!0,"data-help-title":"Explain mode","data-help-body":"Hover any control to see contextual guidance.","data-help-placement":"bottom",children:"Explain"}),t.jsx("button",{className:"ghost-button",onClick:i,type:"button","aria-label":"Refresh traces",title:"Refresh traces","data-help":!0,"data-help-title":"Refresh","data-help-body":"Reload traces from the data store.","data-help-placement":"bottom",children:"Refresh"}),t.jsx("button",{className:`ghost-button ${N?"warn":""}`,type:"button",onClick:K,"aria-label":"Renew workspace session",title:"Renew workspace session",children:"Renew Session"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:f,"aria-label":"Copy live session link",title:"Copy live session link",children:"Share"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:F,"aria-label":"Copy session handoff digest",title:"Copy session handoff digest",children:"Handoff"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:B,"aria-label":"Open support diagnostics",title:"Open support diagnostics",children:"Support"}),t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer","data-help":!0,"data-help-title":"Help","data-help-body":"Open quick docs for first run, key flows, troubleshooting, and shortcuts.","data-help-placement":"bottom",children:"Help"}),null]})]})}function Ji({insights:e,investigation:n,onSelectStep:s,onJumpToBottleneck:r,onJumpToError:i}){var x,w,v,h,k;if(!e)return null;const d=e.timing,l=e.ioWarnings??[],p=e.concurrency,u=e.retryPatterns,f=e.costByTool??{},b=e.costByModel??{},y=((x=n==null?void 0:n.hypotheses)==null?void 0:x.slice(0,2))??[];return t.jsxs("section",{className:"insight-strip","data-help":!0,"data-help-indicator":!0,"data-tour":"insights","data-help-title":"Run insights","data-help-body":"Fast diagnostics for latency, cost, errors, and concurrency. Click chips to jump into the trace.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Top latency","data-help-body":"Largest steps by duration; jump straight to the slowest.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Top latency"}),t.jsxs("div",{className:"insight-items",children:[e.topLatencySteps.map(S=>t.jsxs("button",{className:"insight-chip",type:"button",title:`Jump to ${S.name}`,onClick:()=>s==null?void 0:s(S.stepId),children:[S.name," (",S.durationMs,"ms)"]},S.stepId)),e.topLatencySteps.length>0?t.jsx("button",{className:"insight-chip",type:"button",onClick:r,title:"Jump to longest step",children:"Jump to bottleneck"}):null]})]}),t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Cost by type","data-help-body":"Aggregated spend by step class.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Cost by type"}),t.jsx("div",{className:"insight-items",children:Object.entries(e.costByType).map(([S,$])=>t.jsxs("span",{className:"insight-chip",title:`Total cost for ${S}`,children:[S,": $",$.toFixed(3)]},S))})]}),Object.keys(f).length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Cost by tool","data-help-body":"Top tools by total spend.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Cost by tool"}),t.jsx("div",{className:"insight-items",children:Object.entries(f).sort((S,$)=>$[1]-S[1]).slice(0,3).map(([S,$])=>t.jsxs("span",{className:"insight-chip",title:`Total cost for ${S}`,children:[S,": $",$.toFixed(3)]},S))})]}):null,t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Errors & retries","data-help-body":"Instant visibility into failed or retried steps.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Errors / retries"}),t.jsxs("div",{className:"insight-items",children:[t.jsxs("span",{className:"insight-chip",children:["Errors: ",e.errors]}),t.jsxs("span",{className:"insight-chip",children:["Retries: ",e.retries]}),e.errors>0?t.jsx("button",{className:"insight-chip",type:"button",onClick:i,title:"Jump to first error",children:"Jump to first error"}):null,(w=u==null?void 0:u.topRetries)!=null&&w.length?t.jsxs("span",{className:"insight-chip",title:`Retry rate ${(u.retryRate*100).toFixed(1)}%`,children:["Top retries: ",u.topRetries.length]}):null]})]}),t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Wall vs work","data-help-body":"Wall time vs summed work to show parallelism.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Wall vs work"}),t.jsxs("div",{className:"insight-items",children:[t.jsxs("span",{className:"insight-chip",title:"Wall clock duration",children:["Wall: ",e.wallTimeMs,"ms"]}),t.jsxs("span",{className:"insight-chip",title:"Sum of step durations",children:["Work: ",e.workTimeMs,"ms"]}),e.criticalPathMs!=null?t.jsxs("span",{className:"insight-chip",title:"Longest parent-child chain",children:["Critical: ",e.criticalPathMs,"ms"]}):null]})]}),t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Health","data-help-body":"Timing and I/O anomalies detected in the trace.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Health"}),t.jsxs("div",{className:"insight-items",children:[d!=null&&d.degraded?t.jsx("span",{className:"insight-chip insight-warning",title:d.issues.join(" "),children:"Timing degraded"}):t.jsx("span",{className:"insight-chip",children:"Timing OK"}),l.length>0?t.jsxs("span",{className:"insight-chip insight-warning",title:l.map(S=>S.message).join(" "),children:["IO warnings: ",l.length]}):t.jsx("span",{className:"insight-chip",children:"IO OK"})]})]}),y.length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Investigator","data-help-body":"Automated root-cause hypotheses ranked by severity and confidence.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Investigator"}),t.jsxs("div",{className:"insight-items",children:[y.map(S=>t.jsxs("span",{className:"insight-chip",title:S.summary,children:[S.title," (",Math.round(S.confidence*100),"%)"]},S.id)),(h=(v=y[0])==null?void 0:v.evidenceStepIds)!=null&&h[0]?t.jsx("button",{className:"insight-chip",type:"button",onClick:()=>s==null?void 0:s(y[0].evidenceStepIds[0]),children:"Jump to evidence"}):null]})]}):null,(k=p==null?void 0:p.buckets)!=null&&k.length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Parallelism","data-help-body":"How many steps ran concurrently over time.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Parallelism"}),t.jsx("div",{className:"insight-items",children:t.jsx("div",{className:"insight-heatmap",title:`Peak concurrency: ${p.peak}`,children:p.buckets.map((S,$)=>t.jsx("span",{className:"heatmap-bar",style:{height:`${Math.max(20,S.active/Math.max(1,p.peak)*48)}px`},title:`Bucket ${$+1}: ${S.active} active`},`${S.startMs}-${S.endMs}`))})})]}):null,Object.keys(b).length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Model cost","data-help-body":"Spend by model family.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Model cost"}),t.jsx("div",{className:"insight-items",children:Object.entries(b).map(([S,$])=>t.jsxs("span",{className:"insight-chip",title:`Total cost for ${S}`,children:[S,": $",$.toFixed(3)]},S))})]}):null]})}const Vi=["all","llm_call","tool_call","decision","handoff","guardrail"];function Ki({query:e,typeFilter:n,onQueryChange:s,onTypeFilterChange:r}){return t.jsxs("div",{className:"search-bar",children:[t.jsx("input",{className:"search-input",placeholder:"Search steps, tools, previews...","aria-label":"Search steps",value:e,onChange:i=>s(i.target.value),"data-help":!0,"data-help-title":"Search","data-help-body":"Filter steps by name, tool, or payload preview. Great for fast recall.","data-help-placement":"bottom"}),t.jsx("select",{className:"search-select",value:n,"aria-label":"Filter by step type",onChange:i=>r(i.target.value),"data-help":!0,"data-help-title":"Type filter","data-help-body":"Narrow the timeline to a specific class of steps (LLM, tool, decision, handoff).","data-help-placement":"bottom",children:Vi.map(i=>t.jsx("option",{value:i,children:i},i))})]})}function ga(e,n,s){const r=Date.parse(e),i=s.map(b=>Date.parse(b.endedAt??b.startedAt)).filter(b=>Number.isFinite(b)),d=n?Date.parse(n):i.length?Math.max(...i):r,l=Math.max(1,d-r),p=s.map(b=>{const y=Math.max(0,Date.parse(b.startedAt)-r),x=Math.max(y,Date.parse(b.endedAt??b.startedAt)-r);return{stepId:b.id,startMs:y,endMs:x}}).sort((b,y)=>b.startMs-y.startMs||b.endMs-y.endMs),u=[],f=[];for(const b of p){let y=u.findIndex(x=>x<=b.startMs);y===-1?(y=u.length,u.push(b.endMs)):u[y]=b.endMs,f.push({stepId:b.stepId,startMs:b.startMs,endMs:b.endMs,lane:y,xPct:b.startMs/l*100,wPct:Math.max(.75,(b.endMs-b.startMs)/l*100)})}return{wallTimeMs:l,intervals:f,laneCount:u.length}}function Qi(e){var v;const s=e.steps.map(h=>({stepId:h.id,name:h.name,durationMs:h.durationMs??0})).sort((h,k)=>k.durationMs-h.durationMs).slice(0,3),r={},i={};for(const h of e.steps)((v=h.metrics)==null?void 0:v.costUsd)!=null&&(r[h.type]=(r[h.type]??0)+h.metrics.costUsd,h.type==="tool_call"&&(i[h.name]=(i[h.name]??0)+h.metrics.costUsd));const d=e.steps.filter(h=>h.status==="failed").length,l=e.steps.filter(h=>!!h.retryOfStepId).length,p=e.metadata.wallTimeMs,u=e.metadata.workTimeMs??e.steps.reduce((h,k)=>h+(k.durationMs??0),0),f=Xi(e),b=Zi(e.steps),y=eo(e.steps),x=to(e),w=ao(e.steps);return{topLatencySteps:s,costByType:r,costByTool:i,costByModel:{[e.metadata.modelId]:e.metadata.totalCostUsd??0},errors:d,retries:l,wallTimeMs:p,workTimeMs:u,timing:f,ioWarnings:b,criticalPathMs:y,concurrency:x,retryPatterns:w}}function Yi(e){var s;const n=(s=e.metrics)==null?void 0:s.costUsd;return n==null?null:`$${n.toFixed(3)}`}function He(e){if(!e)return null;const n=Date.parse(e);return Number.isNaN(n)?null:n}function Xi(e){const n=He(e.startedAt),s=He(e.endedAt??void 0),r=[],i=[],d=[];return n==null&&d.push("Trace start time missing or invalid."),e.steps.forEach(l=>{const p=He(l.startedAt),u=He(l.endedAt??l.startedAt);if(p==null||u==null){r.push(l.id);return}if(u<p){i.push(l.id);return}n!=null&&p<n&&i.push(l.id),s!=null&&u>s&&i.push(l.id)}),r.length&&d.push(`Missing timestamps on ${r.length} steps.`),i.length&&d.push(`Timestamp skew detected on ${i.length} steps.`),{degraded:!!(r.length||i.length||n==null),issues:d,missingStepIds:r,skewedStepIds:i}}function Zi(e){const n=new Map;e.forEach(d=>{d.type==="tool_call"&&d.toolCallId&&n.set(d.toolCallId,d)});const s=new Set,r=new Set,i=[];return e.forEach(d=>{d.type!=="llm_call"||!d.io||((d.io.emittedToolCallIds??[]).forEach(l=>{s.add(l),n.has(l)||i.push({kind:"missing_tool_step",message:`Emitted toolCallId ${l} has no tool step.`,stepId:d.id,toolCallId:l})}),(d.io.consumedToolCallIds??[]).forEach(l=>{r.add(l),n.has(l)||i.push({kind:"missing_tool_step",message:`Consumed toolCallId ${l} has no tool step.`,stepId:d.id,toolCallId:l}),s.has(l)||i.push({kind:"consume_without_emit",message:`Consumed toolCallId ${l} without emission.`,stepId:d.id,toolCallId:l})}))}),n.forEach((d,l)=>{s.has(l)||i.push({kind:"unemitted_tool",message:`Tool step ${d.id} has toolCallId ${l} never emitted.`,stepId:d.id,toolCallId:l}),r.has(l)||i.push({kind:"unconsumed_tool",message:`Tool step ${d.id} has toolCallId ${l} never consumed.`,stepId:d.id,toolCallId:l})}),i}function eo(e){const n=new Map,s=new Map,r=[];e.forEach(l=>{if(n.set(l.id,l.durationMs??0),l.parentStepId){const p=s.get(l.parentStepId)??[];p.push(l.id),s.set(l.parentStepId,p)}else r.push(l.id)});const i=new Map,d=l=>{if(i.has(l))return i.get(l)??0;const u=(s.get(l)??[]).reduce((b,y)=>Math.max(b,d(y)),0),f=(n.get(l)??0)+u;return i.set(l,f),f};return r.length?Math.max(...r.map(l=>d(l))):0}function to(e){const n=He(e.startedAt);if(n==null)return{buckets:[],peak:0};const s=He(e.endedAt??void 0)??Math.max(...e.steps.map(u=>He(u.endedAt??u.startedAt)??n),n),r=Math.max(1,s-n),i=12,d=Math.max(1,Math.floor(r/i)),l=[];let p=0;for(let u=0;u<i;u+=1){const f=n+u*d,b=f+d;let y=0;e.steps.forEach(x=>{const w=He(x.startedAt),v=He(x.endedAt??x.startedAt);w==null||v==null||v>=f&&w<=b&&(y+=1)}),p=Math.max(p,y),l.push({startMs:u*d,endMs:(u+1)*d,active:y})}return{buckets:l,peak:p}}function ao(e){const n={};e.forEach(i=>{i.retryOfStepId&&(n[i.retryOfStepId]=(n[i.retryOfStepId]??0)+1)});const s=Object.values(n).reduce((i,d)=>i+d,0),r=Object.entries(n).sort((i,d)=>d[1]-i[1]).slice(0,3);return{totalRetries:s,retryRate:e.length?s/e.length:0,topRetries:r.map(([i,d])=>({stepId:i,count:d}))}}const no={llm_call:{label:"LLM",icon:"LLM",description:"Model call"},tool_call:{label:"TOOL",icon:"TOOL",description:"Tool call"},decision:{label:"DEC",icon:"DEC",description:"Decision"},handoff:{label:"HAND",icon:"HAND",description:"Handoff"},guardrail:{label:"GUARD",icon:"GUARD",description:"Guardrail"}};function so(e){return no[e]}function ro({type:e,size:n="sm",showLabel:s=!1}){const r=so(e);return t.jsxs("span",{className:`step-badge step-badge-${e} step-badge-${n}`,title:r.description,children:[t.jsx("span",{className:"step-badge-icon",children:r.icon}),s?t.jsx("span",{className:"step-badge-label",children:r.label}):null]})}function Zs({step:e,interval:n,playbackState:s,selected:r,onSelect:i,variant:d="base",diffStatus:l,disabled:p=!1,laneHeight:u=140}){var E,_,H,F,B,V;const f=Yi(e),b=((E=e.preview)==null?void 0:E.subtitle)??((_=e.preview)==null?void 0:_.title)??"",y=((H=e.preview)==null?void 0:H.outputPreview)??((F=e.preview)==null?void 0:F.inputPreview)??"",x=l?`step-diff-${l}`:"",w=d==="ghost"?"step-ghost":"",v=n.wPct<8?"step-compact":"",h=e.type.replace("_"," ").toUpperCase(),k=((B=e.metrics)==null?void 0:B.tokensTotal)!=null?`${e.metrics.tokensTotal} tokens`:null,S=e.durationMs!=null?`${e.durationMs}ms`:null,$=[k,S,f].filter(Boolean).join(" · "),X=`Click to inspect inputs/outputs and replay from this moment.${$?` ${$}.`:""}`;return t.jsxs("button",{type:"button",className:`step-card step-${e.type} step-${s} ${r?"step-selected":""} ${x} ${w} ${v}`,"data-step-id":e.id,"aria-pressed":r,"aria-hidden":d==="ghost",disabled:p,"data-help":!0,"data-help-title":`${e.name} · ${h}`,"data-help-body":X,"data-help-placement":"top",style:{left:`${n.xPct}%`,width:`${n.wPct}%`,top:`${n.lane*u}px`},onClick:()=>{p||i(e.id)},children:[t.jsxs("div",{className:"step-card-header",children:[t.jsxs("div",{className:"step-title-group",children:[t.jsx(ro,{type:e.type}),t.jsx("span",{className:"step-title",children:e.name})]}),t.jsx("span",{className:`status-pill status-${e.status}`,children:e.status})]}),b?t.jsx("div",{className:"step-subtitle",children:b}):null,t.jsxs("div",{className:"step-metrics",children:[((V=e.metrics)==null?void 0:V.tokensTotal)!=null?t.jsxs("span",{children:[e.metrics.tokensTotal," tok"]}):null,e.durationMs!=null?t.jsxs("span",{children:[e.durationMs,"ms"]}):null,f?t.jsx("span",{children:f}):null]}),y?t.jsx("div",{className:"step-preview",children:y}):null]})}function er(e,n){return n<e.startMs?"future":n>e.endMs?"past":"active"}const Gt={type:{order:[],hidden:[]},status:{order:[],hidden:[]},parent:{order:[],hidden:[]}};function vn(e,n){return n==="type"?e.type:n==="status"?e.status:e.parentStepId??"root"}function io(e,n){const s=new Set;return e.forEach(r=>s.add(vn(r,n))),Array.from(s).sort((r,i)=>r.localeCompare(i))}function ws(e,n,s){const r=new Set(e),i=[...n.filter(l=>r.has(l))];e.forEach(l=>{i.includes(l)||i.push(l)});const d=Array.from(new Set(s.filter(l=>r.has(l))));return{order:i,hidden:d}}const oo=140,lo=132,co=96,js={llm_call:1,tool_call:2,decision:3,handoff:4,guardrail:5};function tr(e){return[...e].sort((n,s)=>(js[n.type]??9)-(js[s.type]??9))}function uo(e,n,s,r,i){const d=new Map;n.forEach(x=>{var v;const w=vn(x,s);d.has(w)||d.set(w,[]),(v=d.get(w))==null||v.push(x)});const l=Array.from(d.keys()),p=[...r.filter(x=>l.includes(x))];l.forEach(x=>{p.includes(x)||p.push(x)});const u=p.filter(x=>!i.includes(x)),f=new Map;let b=0,y=0;return u.forEach(x=>{const w=d.get(x)??[],v=ga(e.startedAt,e.endedAt,w);v.intervals.forEach(h=>{f.set(h.stepId,{...h,lane:h.lane+b})}),b+=Math.max(1,v.laneCount)}),y=Math.max(1,b),{intervalsByStepId:f,laneCount:y,visibleGroups:u}}function po({trace:e,steps:n,selectedStepId:s,onSelectStep:r,playheadPct:i,playheadMs:d,windowRange:l,ghostTrace:p,diff:u,laneStrategy:f="type",laneGroupsOrder:b=[],hiddenLaneGroups:y=[],laneHeight:x=oo,cardHeight:w=lo,compactHeight:v=co}){const{intervalsByStepId:h,laneCount:k}=uo(e,n,f,b,y),S=Array.from(h.values()),$=new Map(S.map(j=>[j.stepId,j])),X=tr(n),E=e.metadata.wallTimeMs||1,_=new Set((u==null?void 0:u.removedSteps)??[]),H=new Set((u==null?void 0:u.changedSteps)??[]),F=new Set(((u==null?void 0:u.changedPairs)??[]).map(j=>j.rightId)),B=new Set((u==null?void 0:u.addedSteps)??[]);let V=S;if(l){const j=l.endMs-l.startMs,I=Math.max(1e3,j*.15),R=Math.max(0,l.startMs-I),W=l.endMs+I;if(V=S.filter(N=>N.endMs>=R&&N.startMs<=W),s&&!V.some(N=>N.stepId===s)){const N=$.get(s);N&&(V=[...V,N])}}const re=new Set(V.map(j=>j.stepId));return t.jsx("div",{className:"timeline",style:{"--step-card-height":`${w}px`,"--step-compact-height":`${v}px`},children:t.jsxs("div",{className:"timeline-grid",style:{height:`${k*x}px`},"data-help":!0,"data-help-title":"Timeline lanes","data-help-body":"Each lane stacks overlapping steps; width reflects duration.","data-help-placement":"top",children:[t.jsx("div",{className:"playback-cursor",style:{left:`${i}%`}}),X.filter(j=>re.has(j.id)).filter(j=>!y.includes(vn(j,f))).map(j=>{const I=$.get(j.id);if(!I)return null;const R=er(I,d);return t.jsx(Zs,{step:j,interval:I,playbackState:R,selected:s===j.id,diffStatus:_.has(j.id)?"removed":H.has(j.id)?"changed":null,laneHeight:x,onSelect:r},j.id)}),p?t.jsx(mo,{ghostTrace:p,baseWallTimeMs:E,playheadMs:d,windowRange:l,diffAdded:B,diffChanged:F,laneHeight:x}):null]})})}function mo({ghostTrace:e,baseWallTimeMs:n,playheadMs:s,windowRange:r,diffAdded:i,diffChanged:d,laneHeight:l}){const{intervals:p,laneCount:u}=ga(e.startedAt,e.endedAt,e.steps),f=new Map(p.map(h=>[h.stepId,h])),b=e.metadata.wallTimeMs||1,y=s/n*b;let x=p;if(r){const h=r.endMs-r.startMs,k=Math.max(1e3,h*.15),S=b/n,$=Math.max(0,(r.startMs-k)*S),X=Math.min(b,(r.endMs+k)*S);x=p.filter(E=>E.endMs>=$&&E.startMs<=X)}const w=new Set(x.map(h=>h.stepId)),v=tr(e.steps);return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"ghost-lanes",style:{height:`${u*l}px`}}),v.filter(h=>w.has(h.id)).map(h=>{const k=f.get(h.id);if(!k)return null;const S=er(k,y),$=i.has(h.id)?"added":d.has(h.id)?"changed":null;return t.jsx(Zs,{step:h,interval:k,playbackState:S,selected:!1,diffStatus:$,variant:"ghost",disabled:!0,laneHeight:l,onSelect:()=>{}},`ghost-${h.id}`)})]})}function ho({trace:e,steps:n,selectedStepId:s,onSelectStep:r,playheadMs:i,windowRange:d,timing:l,ghostTrace:p,diff:u,laneStrategy:f,laneGroupsOrder:b,hiddenLaneGroups:y,onLaneStrategyChange:x,onToggleLaneGroupVisibility:w,onMoveLaneGroup:v}){const h=e.metadata.wallTimeMs||1,k=Math.min(100,Math.max(0,i/h*100)),S=b.filter($=>!y.includes($)).length;return t.jsxs("section",{className:"cinema-mode","aria-label":"Cinema mode",children:[l!=null&&l.degraded?t.jsxs("div",{className:"timing-banner",title:l.issues.join(" "),children:["Timing degraded: ",l.issues[0]??"Check timestamps."]}):null,t.jsxs("div",{className:"timeline-studio-panel","data-help":!0,"data-help-title":"Timeline studio","data-help-body":"Regroup lanes by type/status/parent, hide noisy groups, and reorder emphasis.",children:[t.jsxs("label",{className:"timeline-studio-strategy",children:["Lane strategy",t.jsxs("select",{value:f,onChange:$=>x($.target.value),children:[t.jsx("option",{value:"type",children:"Type"}),t.jsx("option",{value:"status",children:"Status"}),t.jsx("option",{value:"parent",children:"Parent branch"})]})]}),t.jsxs("div",{className:"timeline-studio-summary",children:[S,"/",b.length," groups visible"]}),t.jsx("div",{className:"timeline-studio-groups",children:b.map(($,X)=>{const E=y.includes($);return t.jsxs("div",{className:`timeline-studio-group ${E?"is-hidden":""}`,children:[t.jsx("button",{type:"button",className:"ghost-button",onClick:()=>w($),children:E?"Show":"Hide"}),t.jsx("span",{className:"timeline-studio-group-name",children:$}),t.jsx("button",{type:"button",className:"ghost-button",onClick:()=>v($,"up"),disabled:X===0,children:"Up"}),t.jsx("button",{type:"button",className:"ghost-button",onClick:()=>v($,"down"),disabled:X===b.length-1,children:"Down"})]},$)})})]}),t.jsx(po,{trace:e,steps:n,selectedStepId:s,onSelectStep:r,playheadPct:k,playheadMs:i,windowRange:d,ghostTrace:p,diff:u,laneStrategy:f,laneGroupsOrder:b,hiddenLaneGroups:y})]})}const fo=[.5,1,1.5,2,4];function ks({playheadMs:e,wallTimeMs:n,isPlaying:s,speed:r,onToggle:i,onScrub:d,onSpeedChange:l}){const p=u=>{d(Number(u.target.value))};return t.jsxs("div",{className:"playback-controls",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:i,"aria-label":s?"Pause playback":"Play playback","data-help":!0,"data-help-title":"Playhead","data-help-body":"Start or pause the run to experience timing as it unfolded.","data-help-placement":"bottom",children:s?"Pause":"Play"}),t.jsx("input",{className:"playback-slider",type:"range",min:0,max:n,value:e,"aria-label":"Playback position",onChange:p,"data-help":!0,"data-help-title":"Scrub timeline","data-help-body":"Drag to jump to any moment in the run.","data-help-placement":"bottom"}),t.jsx("select",{className:"playback-speed",value:r,"aria-label":"Playback speed",onChange:u=>l(Number(u.target.value)),"data-help":!0,"data-help-title":"Speed","data-help-body":"Slow down to inspect or speed up to skim.","data-help-placement":"bottom",children:fo.map(u=>t.jsxs("option",{value:u,children:[u,"x"]},u))})]})}function yo(e,n,s,r=60){const{wallTimeMs:i,intervals:d}=ga(e,n,s),l=new Array(r).fill(0);if(!i)return{buckets:l,wallTimeMs:0};const p=i/r;return!Number.isFinite(p)||p<=0?{buckets:l,wallTimeMs:i}:(d.forEach(u=>{const f=Math.max(0,Math.floor(u.startMs/p)),b=Math.min(r-1,Math.floor(u.endMs/p));for(let y=f;y<=b;y+=1)l[y]+=1}),{buckets:l,wallTimeMs:i})}function bo(e,n){const s=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),r=URL.createObjectURL(s),i=document.createElement("a");i.href=r,i.download=e,document.body.appendChild(i),i.click(),i.remove(),URL.revokeObjectURL(r)}function on(e,n,s="text/plain"){const r=new Blob([n],{type:s}),i=URL.createObjectURL(r),d=document.createElement("a");d.href=i,d.download=e,document.body.appendChild(d),d.click(),d.remove(),URL.revokeObjectURL(i)}const Bt=5e3,go=32;function Te(e,n,s){return Math.min(s,Math.max(n,e))}function jt(e,n){const s=new Set;return e.forEach(r=>{s.add(Te(Math.round(r),0,n))}),Array.from(s).sort((r,i)=>r-i).slice(0,go)}function xo(e,n){if(!e)return{bookmarksMs:[],clipStartMs:null,clipEndMs:null,segments:[]};try{const s=JSON.parse(e),r=jt(Array.isArray(s.bookmarksMs)?s.bookmarksMs:[],n),i=typeof s.clipStartMs=="number"?Te(s.clipStartMs,0,n):null,d=typeof s.clipEndMs=="number"?Te(s.clipEndMs,0,n):null,l=Array.isArray(s.segments)?s.segments.filter(p=>typeof(p==null?void 0:p.id)=="string"&&typeof(p==null?void 0:p.startMs)=="number"&&typeof(p==null?void 0:p.endMs)=="number"&&typeof(p==null?void 0:p.label)=="string").map(p=>({...p,startMs:Te(p.startMs,0,n),endMs:Te(p.endMs,0,n)})):[];return{bookmarksMs:r,clipStartMs:i,clipEndMs:i!=null&&d!=null&&d<i?i:d,segments:l}}catch{return{bookmarksMs:[],clipStartMs:null,clipEndMs:null,segments:[]}}}function Ss(e,n){const s=Date.parse(e);return Number.isNaN(s)?null:new Date(s+n).toISOString()}function vo({traceStart:e,traceEnd:n,steps:s,playheadMs:r,windowRange:i,windowed:d,spanMs:l,onSpanChange:p,onToggleWindowed:u,onScrub:f,persistenceKey:b,laneStrategy:y="type",visibleLaneGroups:x=[],remotePlayheads:w=[]}){const{buckets:v,wallTimeMs:h}=yo(e,n,s,64),k=Math.max(1,...v),S=Te(l,Bt,Math.max(Bt,h)),$=(i==null?void 0:i.startMs)??0,X=(i==null?void 0:i.endMs)??h,E=c.useMemo(()=>`agentDirector.timelineStudio.${b??e}`,[b,e]),[_,H]=c.useState([]),[F,B]=c.useState(null),[V,re]=c.useState(null),[j,I]=c.useState([]),[R,W]=c.useState("");c.useEffect(()=>{const T=xo(window.localStorage.getItem(E),h);H(T.bookmarksMs),B(T.clipStartMs),re(T.clipEndMs),I(T.segments)},[E,h]),c.useEffect(()=>{const T={bookmarksMs:jt(_,h),clipStartMs:F==null?null:Te(F,0,h),clipEndMs:V==null?null:Te(V,0,h),segments:j};window.localStorage.setItem(E,JSON.stringify(T))},[_,V,F,j,E,h]);const N=h?$/h*100:0,K=h?(X-$)/h*100:100,D=h?r/h*100:0,q=F!=null&&V!=null?Math.min(F,V):null,P=F!=null&&V!=null?Math.max(F,V):null,me=q!=null&&P!=null&&h?(P-q)/h*100:0,Me=q!=null&&h?q/h*100:0,M=q!=null&&P!=null&&P>q,U=T=>{const ee=T.currentTarget.getBoundingClientRect(),be=(T.clientX-ee.left)/ee.width,ke=Te(Math.round(be*h),0,h);f(ke)},fe=T=>{if(T.key==="ArrowLeft"){T.preventDefault(),f(Te(r-Math.max(250,Math.round(h*.02)),0,h));return}if(T.key==="ArrowRight"){T.preventDefault(),f(Te(r+Math.max(250,Math.round(h*.02)),0,h));return}if(T.key==="Home"){T.preventDefault(),f(0);return}if(T.key==="End"){T.preventDefault(),f(h);return}(T.key===" "||T.key==="Enter")&&(T.preventDefault(),f(r))},ye=()=>{H(T=>jt([...T,r],h))},A=T=>{if(_.length===0)return;const ee=jt(_,h);if(T==="previous"){const ke=[...ee].reverse().find(kt=>kt<r)??ee[ee.length-1];f(ke);return}const be=ee.find(ke=>ke>r)??ee[0];f(be)},Q=()=>{const T=Te(r,0,h);B(T),V!=null&&V<T&&re(T)},je=()=>{const T=Te(r,0,h);re(T),F!=null&&F>T&&B(T)},ct=()=>{B(null),re(null)},Ae=()=>{if(!M||q==null||P==null)return;const T=R.trim()||`Scene ${j.length+1}`,ee=`segment-${Math.random().toString(36).slice(2,9)}`;I(be=>[...be,{id:ee,startMs:q,endMs:P,label:T}]),W("")},Pe=T=>{I(ee=>ee.filter(be=>be.id!==T))},$e=()=>{if(!M||q==null||P==null)return;const T={type:"agent-director-clip",traceStart:e,traceEnd:n,clip:{startMs:q,endMs:P,startAt:Ss(e,q),endAt:Ss(e,P)},bookmarksMs:jt(_,h).filter(ee=>ee>=q&&ee<=P),playheadMs:r,laneContext:{strategy:y,visibleGroups:x},segments:j.filter(ee=>ee.endMs>=q&&ee.startMs<=P),exportedAt:new Date().toISOString()};bo(`agent-director-clip-${q}-${P}.json`,T)};return t.jsxs("div",{className:"mini-timeline",children:[t.jsxs("div",{className:"mini-track",onClick:U,role:"slider",tabIndex:0,"aria-label":"Timeline density map","aria-valuemin":0,"aria-valuemax":h,"aria-valuenow":r,"aria-valuetext":`${r} milliseconds`,onKeyDown:fe,"data-help":!0,"data-help-title":"Density map","data-help-body":"A compact view of activity density. Click to jump the playhead.","data-help-placement":"top",children:[t.jsx("div",{className:"mini-bars",children:v.map((T,ee)=>t.jsx("span",{className:"mini-bar",style:{height:`${T/k*100}%`}},`bucket-${ee}`))}),t.jsx("div",{className:"mini-window",style:{left:`${N}%`,width:`${K}%`,opacity:d?1:.4}}),M?t.jsx("div",{className:"mini-clip-window",style:{left:`${Me}%`,width:`${me}%`}}):null,t.jsx("div",{className:"mini-bookmark-markers","data-testid":"timeline-bookmark-markers","aria-hidden":"true",children:jt(_,h).map(T=>{const ee=h?T/h*100:0;return t.jsx("button",{type:"button",className:"mini-bookmark-marker",style:{left:`${ee}%`},onClick:be=>{be.stopPropagation(),f(T)},title:`Jump to bookmark at ${T}ms`,"aria-label":`Bookmark ${T} milliseconds`},`bookmark-${T}`)})}),t.jsx("div",{className:"mini-remote-markers","aria-hidden":"true",children:w.map((T,ee)=>{const be=h?T/h*100:0;return t.jsx("span",{className:"mini-remote-marker",style:{left:`${be}%`}},`remote-${ee}`)})}),t.jsx("div",{className:"mini-segments","aria-hidden":"true",children:j.map(T=>{const ee=h?T.startMs/h*100:0,be=h?(T.endMs-T.startMs)/h*100:0;return t.jsx("span",{className:"mini-segment-bar",style:{left:`${ee}%`,width:`${Math.max(1,be)}%`},title:T.label},T.id)})}),t.jsx("div",{className:"mini-playhead",style:{left:`${D}%`}})]}),t.jsxs("div",{className:"mini-controls",children:[t.jsx("label",{className:"mini-label",children:"Zoom"}),t.jsx("input",{type:"range",min:Bt,max:Math.max(Bt,h),value:S,"aria-label":"Timeline zoom",onChange:T=>{u(!0),p(Number(T.target.value))},"data-help":!0,"data-help-title":"Zoom window","data-help-body":"Tighten the window to focus on hotspots.","data-help-placement":"top"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>u(!d),title:"Toggle windowed playback",children:d?"Full":"Window"}),t.jsx("button",{className:"ghost-button",type:"button",title:"Reset zoom",onClick:()=>{u(!0),p(Math.min(Math.max(h*.2,Bt),6e4))},children:"Reset"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:ye,children:"Add bookmark"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>A("previous"),children:"Previous bookmark"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>A("next"),children:"Next bookmark"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:Q,children:"Set clip start"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:je,children:"Set clip end"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:ct,children:"Clear clip"}),t.jsx("input",{className:"search-input mini-segment-input",placeholder:"Segment label",value:R,onChange:T=>W(T.target.value),"aria-label":"Segment label"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:Ae,disabled:!M,children:"Add segment"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:$e,disabled:!M,children:"Export clip"})]}),j.length?t.jsx("div",{className:"mini-segment-list",children:j.map(T=>t.jsxs("div",{className:"mini-segment-item",children:[t.jsxs("span",{children:[T.label," (",T.startMs,"ms - ",T.endMs,"ms)"]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Pe(T.id),children:"Remove"})]},T.id))}):null]})}const Ut=[{id:"toggleStory",label:"Story mode",defaultKey:"s"},{id:"toggleExplain",label:"Explain mode",defaultKey:"e"},{id:"startTour",label:"Start guided tour",defaultKey:"t"},{id:"toggleFlow",label:"Toggle Flow mode",defaultKey:"f"},{id:"toggleCinema",label:"Switch to Cinema mode",defaultKey:"c"},{id:"toggleGameplay",label:"Switch to Gameplay mode",defaultKey:"g"},{id:"toggleInspector",label:"Toggle inspector",defaultKey:"i"}],wn="abcdefghijklmnopqrstuvwxyz".split(""),wo=Ut.reduce((e,n)=>(e[n.id]=n.defaultKey,e),{}),jo={...wo};function ar(e,n){const s=String(e??"").trim().toLowerCase();return wn.includes(s)?s:n}function ko(e){return wn.find(s=>!e.has(s))??"z"}function yn(e){const n={},s=new Set;for(const r of Ut){const i=ar(e==null?void 0:e[r.id],r.defaultKey),d=s.has(i)?ko(s):i;n[r.id]=d,s.add(d)}return n}function So(e,n,s){const r=yn(e),i=ar(s,r[n]);if(r[n]===i)return r;const d={...r,[n]:i},l=Ut.find(p=>p.id!==n&&d[p.id]===i);return l&&(d[l.id]=r[n]),yn(d)}function No(e){return e.trim().toUpperCase()}function Co({open:e,onClose:n,bindings:s}){const r=c.useRef(null),i=[{keys:"Space",action:"Play / pause"},{keys:"← / →",action:"Step boundary back / forward"},{keys:"Shift + ← / →",action:"Jump to start / end"},...Ut.map(l=>({keys:No(s[l.id]),action:l.label})),{keys:"Cmd/Ctrl + K",action:"Open command palette"},{keys:"?",action:"Show shortcuts"},{keys:"Esc",action:"Close modal / inspector"}];if(c.useEffect(()=>{var l;e&&((l=r.current)==null||l.focus())},[e]),!e)return null;const d=l=>{var b;if(l.key==="Escape"){l.preventDefault(),n();return}if(l.key!=="Tab")return;const p=Array.from(l.currentTarget.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'));if(p.length===0)return;const u=p.indexOf(document.activeElement),f=l.shiftKey?u<=0?p.length-1:u-1:(u+1)%p.length;(b=p[f])==null||b.focus(),l.preventDefault()};return t.jsx("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true","aria-labelledby":"shortcuts-title",onKeyDown:d,children:t.jsxs("div",{className:"modal",tabIndex:-1,children:[t.jsxs("div",{className:"modal-header",children:[t.jsx("div",{className:"modal-title",id:"shortcuts-title",children:"Keyboard Shortcuts"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:n,ref:r,"aria-label":"Close shortcuts",children:"Close"})]}),t.jsx("div",{className:"modal-body",children:i.map(l=>t.jsxs("div",{className:"modal-row",children:[t.jsx("span",{className:"modal-keys",children:l.keys}),t.jsx("span",{className:"modal-action",children:l.action})]},l.keys))})]})})}const Ns="agentDirector.palette.recent.v1",Cs="agentDirector.palette.pinned.v1",Mo=8,Eo=12,nr=e=>e.trim().toLowerCase(),ln=(e,n)=>{if(!n)return 0;const s=nr(e);return s?s===n?30:s.startsWith(n)?18:s.includes(n)?8:0:0};function Ms(e){try{const n=JSON.parse(window.localStorage.getItem(e)??"[]");return Array.isArray(n)?n.filter(s=>typeof s=="string"):[]}catch{return[]}}function Es(e,n){window.localStorage.setItem(e,JSON.stringify(n))}function Io(e){const n=new Map;return e.forEach(s=>{var i;const r=s.section;n.has(r)||n.set(r,[]),(i=n.get(r))==null||i.push(s)}),n}function Is(e,n,s){var i;if(!e.length)return 0;let r=n;for(let d=0;d<e.length;d+=1)if(r=(r+s+e.length)%e.length,!((i=e[r])!=null&&i.disabled))return r;return n}function To({open:e,onClose:n,actions:s,context:r,onActionRun:i}){var V,re;const[d,l]=c.useState(""),[p,u]=c.useState(0),[f,b]=c.useState([]),[y,x]=c.useState([]),w=c.useRef(null),v=c.useRef(null),h=c.useMemo(()=>{const j=nr(d),I=new Set(f),R=new Set(y);return s.map((N,K)=>{var P;const D=[N.label,N.description,N.group,N.keys,...N.keywords??[]].filter(Boolean).join(" ").toLowerCase();if(j&&!D.includes(j))return null;let q=N.priority??0;return q+=ln(N.label,j),q+=ln(N.group??"",j),(N.keywords??[]).forEach(me=>{q+=ln(me,j)}),I.has(N.id)&&(q+=6),R.has(N.id)&&(q+=12),r!=null&&r.section&&((P=N.group)==null?void 0:P.toLowerCase())===r.section.toLowerCase()&&(q+=8),r!=null&&r.mode&&N.id.includes(`mode-${r.mode}`)&&(q+=8),{action:N,score:q,index:K}}).filter(N=>!!N).sort((N,K)=>K.score===N.score?N.index-K.index:K.score-N.score).map(N=>N.action)},[s,r==null?void 0:r.mode,r==null?void 0:r.section,y,d,f]),k=c.useMemo(()=>{const j=new Map(h.map(N=>[N.id,N])),I=y.map(N=>j.get(N)).filter(N=>!!N).map(N=>({...N,section:"Pinned"})),R=f.map(N=>j.get(N)).filter(N=>!!N).filter(N=>!I.some(K=>K.id===N.id)).map(N=>({...N,section:"Recent"})),W=h.filter(N=>!I.some(K=>K.id===N.id)).filter(N=>!R.some(K=>K.id===N.id)).map(N=>({...N,section:N.group??"General"}));if(!d.trim()&&r){const N=W.slice(0,4).map(K=>({...K,id:`recommended-${K.id}`,label:`Recommended: ${K.label}`,section:"Recommended"}));return[...I,...R,...N,...W]}return[...I,...R,...W]},[r,h,y,f,d]),S=c.useMemo(()=>Io(k),[k]),$=c.useMemo(()=>s.filter(j=>(j.group??"").toLowerCase()==="macros"||j.id.startsWith("macro-")),[s]);if(c.useEffect(()=>{if(!e)return;l(""),u(0),b(Ms(Ns)),x(Ms(Cs));const j=window.setTimeout(()=>{var I;return(I=w.current)==null?void 0:I.focus()},0);return()=>window.clearTimeout(j)},[e]),c.useEffect(()=>{p>=k.length&&u(0)},[p,k.length]),!e)return null;const X=j=>{b(I=>{const R=[j,...I.filter(W=>W!==j)].slice(0,Mo);return Es(Ns,R),R})},E=j=>{j.disabled||(X(j.id),i==null||i(j),j.onTrigger(),n())},_=j=>{x(I=>{const R=I.includes(j)?I.filter(W=>W!==j):[j,...I].slice(0,Eo);return Es(Cs,R),R})},H=j=>{var I,R;if(j.key==="Escape"){j.preventDefault(),n();return}if(j.key==="ArrowDown"){j.preventDefault(),u(W=>Is(k,W,1));return}if(j.key==="ArrowUp"){j.preventDefault(),u(W=>Is(k,W,-1));return}if(j.key==="Enter"){j.preventDefault();const W=k[p];W&&E(W);return}if(j.key==="Tab"){const W=Array.from(((I=v.current)==null?void 0:I.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'))??[]);if(!W.length)return;const N=W.indexOf(document.activeElement),K=j.shiftKey?N<=0?W.length-1:N-1:(N+1)%W.length;(R=W[K])==null||R.focus(),j.preventDefault()}},F=(V=k[p])!=null&&V.id?`palette-option-${(re=k[p])==null?void 0:re.id}`:void 0;let B=-1;return t.jsx("div",{className:"modal-backdrop palette-backdrop",role:"dialog","aria-modal":"true","aria-label":"Command palette",onKeyDown:H,onMouseDown:j=>{j.target===j.currentTarget&&n()},children:t.jsxs("div",{className:"palette",ref:v,children:[t.jsxs("div",{className:"palette-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"palette-title",children:"Command palette"}),t.jsx("div",{className:"palette-subtitle",children:"Search actions, modes, and playbook steps."})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:n,"aria-label":"Close command palette",children:"Close"})]}),t.jsx("input",{ref:w,className:"palette-input",value:d,onChange:j=>l(j.target.value),placeholder:"Type to filter actions…","aria-label":"Search commands",role:"combobox","aria-expanded":"true","aria-controls":"command-palette-list","aria-activedescendant":F,"aria-autocomplete":"list"}),!d.trim()&&$.length>0?t.jsxs("div",{className:"palette-macros",children:[t.jsx("div",{className:"palette-group-title",children:"Quick macros"}),t.jsx("div",{className:"palette-macro-list",children:$.slice(0,3).map(j=>t.jsx("button",{className:"ghost-button palette-macro-item",type:"button",onClick:()=>E(j),children:j.label},j.id))})]}):null,t.jsxs("div",{className:"palette-list",role:"listbox",id:"command-palette-list",children:[k.length===0?t.jsx("div",{className:"palette-empty",children:"No matching commands."}):null,Array.from(S.entries()).map(([j,I])=>t.jsxs("div",{className:"palette-group",children:[t.jsx("div",{className:"palette-group-title",children:j}),t.jsx("div",{className:"palette-group-list",children:I.map(R=>{B+=1;const W=B===p,N=y.includes(R.id);return t.jsxs("button",{id:`palette-option-${R.id}`,className:`palette-item ${W?"active":""}`,type:"button",role:"option","aria-selected":W,onMouseEnter:()=>u(B),onClick:()=>E(R),disabled:R.disabled,children:[t.jsxs("div",{className:"palette-item-main",children:[t.jsx("div",{className:"palette-item-title",children:R.label}),R.description?t.jsx("div",{className:"palette-item-description",children:R.description}):null]}),t.jsxs("div",{className:"palette-item-trailing",children:[R.keys?t.jsx("div",{className:"palette-item-keys",children:R.keys}):null,t.jsx("span",{className:`palette-pin ${N?"active":""}`,role:"button",tabIndex:0,onClick:K=>{K.stopPropagation(),_(R.id)},onKeyDown:K=>{K.key!=="Enter"&&K.key!==" "||(K.preventDefault(),K.stopPropagation(),_(R.id))},"aria-label":N?`Unpin ${R.label}`:`Pin ${R.label}`,title:N?"Unpin command":"Pin command",children:N?"★":"☆"})]})]},R.id)})})]},j))]})]})})}function Do(e){return e.length?e.reduce((n,s)=>(s.durationMs??0)>(n.durationMs??0)?s:n,e[0]):null}function Ao({trace:e,mode:n,playheadMs:s,selectedStepId:r,compareTrace:i,collapsed:d,onToggleCollapsed:l,onModeChange:p,onSelectStep:u,onJumpToBottleneck:f,onReplay:b,onStartTour:y,priorityQueue:x=[]}){var j;const w=e.steps??[],v=Do(w),h=r??(v==null?void 0:v.id)??((j=w[0])==null?void 0:j.id)??null,k=n==="cinema"||s>0,S=!!r,$=!!i,X=[k,S,$].filter(Boolean).length,E=[k,S,$].findIndex(I=>!I),_=E===-1?2:E,H=[0,1,2].map(I=>[k,S,$][I]?"done":I===_?"active":"next"),F=[{id:"observe",title:"Act I: Observe",summary:"Scrub the timeline to feel the pacing, bottlenecks, and tool choreography.",status:H[0],actionLabel:"Enter cinema",action:()=>p("cinema"),tasks:[{label:"Scrub the timeline",done:s>0},{label:"Stay in Cinema mode",done:n==="cinema"}]},{id:"inspect",title:"Act II: Inspect",summary:"Open the most expensive or failed step and read the payload with context.",status:H[1],actionLabel:v?"Jump to bottleneck":"Select first step",action:()=>{if(r){p("cinema");return}if(v){f();return}h&&(u(h),p("cinema"))},disabled:!h,tasks:[{label:"Open the Inspector",done:!!r},{label:"Jump to the bottleneck",done:!!(v&&r===v.id)}]},{id:"direct",title:"Act III: Direct",summary:"Replay from a decisive step, then compare flows and diffs side-by-side.",status:H[2],actionLabel:i?"Open compare":"Replay from step",action:()=>{if(i){p("compare");return}h&&b(h)},disabled:!h,tasks:[{label:"Replay from a step",done:!!i},{label:"Compare runs side-by-side",done:!!(i&&n==="compare")}]}],B=F[_],re=x.filter(I=>!I.done)[0];return d?t.jsxs("section",{className:"journey-panel journey-collapsed","aria-label":"Director journey","data-help":!0,"data-help-indicator":!0,"data-tour":"journey","data-help-title":"Director journey","data-help-body":"A guided path from observation to replay. Use it to show newcomers what to do first.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"journey-collapsed-main",children:[t.jsx("div",{className:"journey-eyebrow",children:"Director journey"}),t.jsx("div",{className:"journey-collapsed-title",children:"From observe to direct"})]}),t.jsxs("div",{className:"journey-collapsed-actions",children:[t.jsxs("span",{className:"journey-progress-text",children:[X,"/3 complete"]}),re?t.jsxs("span",{className:`journey-priority-chip severity-${re.severity}`,children:["Next priority: ",re.title]}):null,B?t.jsxs("button",{className:"primary-button journey-next",type:"button",onClick:B.action,disabled:B.disabled,children:["Next: ",B.actionLabel]}):null,y?t.jsx("button",{className:"ghost-button",type:"button",onClick:y,children:"Tour"}):null,t.jsx("button",{className:"primary-button journey-expand",type:"button",onClick:l,children:"Expand"})]})]}):t.jsxs("section",{className:"journey-panel","aria-label":"Director journey","data-help":!0,"data-help-indicator":!0,"data-tour":"journey","data-help-title":"Director journey","data-help-body":"A three-act flow that teaches the story: observe, inspect, direct. Each act jumps to the right place.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"journey-head",children:[t.jsxs("div",{children:[t.jsx("div",{className:"journey-eyebrow",children:"Director journey"}),t.jsx("h2",{className:"journey-title",children:"Cut a perfect take in three acts."}),t.jsx("p",{className:"journey-subtitle",children:"Trace the performance, interrogate the moment, then direct a better run."})]}),t.jsxs("div",{className:"journey-head-actions",children:[y?t.jsx("button",{className:"ghost-button",type:"button",onClick:y,children:"Start tour"}):null,t.jsx("button",{className:"ghost-button",type:"button",onClick:l,children:"Collapse"})]})]}),t.jsx("div",{className:"journey-track",children:F.map((I,R)=>{var W;return t.jsxs("div",{className:"journey-card","data-status":I.status,children:[t.jsxs("div",{className:"journey-card-top",children:[t.jsxs("span",{className:"journey-index",children:["0",R+1]}),t.jsx("span",{className:"journey-status",children:I.status})]}),t.jsx("h3",{className:"journey-card-title",children:I.title}),t.jsx("p",{className:"journey-card-body",children:I.summary}),(W=I.tasks)!=null&&W.length?t.jsx("ul",{className:"journey-tasks",children:I.tasks.map(N=>t.jsxs("li",{className:`journey-task ${N.done?"done":""}`,children:[t.jsx("span",{className:"journey-task-icon","aria-hidden":"true",children:N.done?"✓":"○"}),t.jsx("span",{children:N.label})]},N.label))}):null,t.jsx("button",{className:"primary-button journey-action",type:"button",onClick:I.action,disabled:I.disabled,children:I.actionLabel})]},I.id)})}),t.jsxs("div",{className:"journey-footer",children:[t.jsxs("div",{children:[t.jsx("div",{className:"journey-progress-label",children:"Progress"}),t.jsx("div",{className:"journey-progress",children:t.jsx("span",{className:"journey-progress-bar",style:{width:`${X/3*100}%`}})})]}),t.jsx("div",{className:"journey-footnote",children:"Tip: Use Flow to spot fan-out, Compare to validate your changes."})]}),x.length?t.jsxs("div",{className:"journey-priority-queue",children:[t.jsxs("div",{className:"journey-priority-head",children:[t.jsx("div",{className:"journey-progress-label",children:"Priority queue"}),t.jsxs("span",{children:[x.filter(I=>I.done).length,"/",x.length," resolved"]})]}),t.jsx("div",{className:"journey-priority-list",children:x.map(I=>t.jsxs("article",{className:`journey-priority-item ${I.done?"done":""}`,children:[t.jsxs("div",{className:"journey-priority-main",children:[t.jsx("span",{className:`journey-priority-chip severity-${I.severity}`,children:I.severity}),t.jsxs("div",{children:[t.jsx("div",{className:"journey-priority-title",children:I.title}),t.jsx("div",{className:"journey-priority-body",children:I.detail})]})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:I.onAction,disabled:I.done,children:I.done?"Resolved":I.actionLabel})]},I.id))})]}):null]})}const $o=[],_o=[],Ro=[],Oo={};function Po(e){return e.length?e.reduce((n,s)=>(s.durationMs??0)>(n.durationMs??0)?s:n,e[0]):null}function Lo({trace:e,mode:n,selectedStepId:s,onModeChange:r,onSelectStep:i,onJumpToBottleneck:d,onReplay:l,recommendations:p=$o,persona:u="builder",annotations:f=_o,activityFeed:b=Ro,onAddAnnotation:y,missionProgress:x=Oo,missionCompletion:w,onResetMissions:v,narrative:h="",onAskDirector:k,onExportNarrative:S}){var ye;const $=e.steps??[],X=Po($),E=s??(X==null?void 0:X.id)??((ye=$[0])==null?void 0:ye.id)??null,_=e.metadata.wallTimeMs??0,H=u==="executive"?"Executive lens":u==="operator"?"Operator lens":"Builder lens",[F,B]=c.useState(""),[V,re]=c.useState(""),[j,I]=c.useState(""),[R,W]=c.useState("overview"),[N,K]=c.useState([]),D=c.useMemo(()=>b.slice(0,6),[b]),q=(w==null?void 0:w.done)??0,P=q>=3||!!x.inspect,me=q>=5||!!x.collaborate||D.length>0,Me=c.useMemo(()=>p.slice(0,3).map((A,Q)=>({id:A.id,step:`${Q+1}. ${A.actionLabel} — ${A.title}`})),[p]);c.useEffect(()=>{K(A=>A.filter(Q=>p.some(je=>je.id===Q)))},[p]);const M=N.filter(A=>p.some(Q=>Q.id===A)).length,U=p.length?Math.round(M/p.length*100):0,fe=A=>{A.action(),K(Q=>Q.includes(A.id)?Q:[...Q,A.id])};return t.jsxs("aside",{className:"inspector inspector-empty","data-help":!0,"data-help-indicator":!0,"data-tour":"inspector","data-help-title":"Inspector panel","data-help-body":"Select a step to open detailed payloads, redaction controls, and replay actions.","data-help-placement":"left",children:[t.jsx("div",{className:"inspector-header",children:t.jsxs("div",{children:[t.jsx("div",{className:"inspector-title",children:"Director's notes"}),t.jsxs("div",{className:"inspector-subtitle",children:[H,". Select a step to open deep inspection."]})]})}),t.jsxs("div",{className:"director-tabs",role:"tablist","aria-label":"Director workspace tabs",children:[t.jsx("button",{className:`ghost-button ${R==="overview"?"active":""}`,type:"button",role:"tab","aria-selected":R==="overview",onClick:()=>W("overview"),children:"Overview"}),t.jsx("button",{className:`ghost-button ${R==="narrative"?"active":""}`,type:"button",role:"tab","aria-selected":R==="narrative",onClick:()=>W("narrative"),children:"Narrative"}),t.jsx("button",{className:`ghost-button ${R==="collab"?"active":""}`,type:"button",role:"tab","aria-selected":R==="collab",onClick:()=>W("collab"),children:"Collaboration"})]}),R==="overview"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Run summary"}),t.jsxs("div",{className:"inspector-row",children:[t.jsx("span",{children:"Steps"}),t.jsx("span",{children:$.length})]}),t.jsxs("div",{className:"inspector-row",children:[t.jsx("span",{children:"Wall time"}),t.jsxs("span",{children:[_,"ms"]})]}),t.jsxs("div",{className:"inspector-row",children:[t.jsx("span",{children:"Status"}),t.jsx("span",{children:e.status})]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Next actions"}),t.jsxs("div",{className:"director-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>r("cinema"),"data-help":!0,"data-help-title":"Open cinema","data-help-body":"Jump straight into the timeline.","data-help-placement":"right",children:"Open cinema"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>r("flow"),"data-help":!0,"data-help-title":"Open flow","data-help-body":"See the dependency graph of the run.","data-help-placement":"right",children:"Switch to flow"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{if(!s){if(X){d();return}E&&i(E)}},disabled:!E||!!s,"data-help":!0,"data-help-title":"Jump to bottleneck","data-help-body":"Select the slowest step for inspection.","data-help-placement":"right",children:s?"Inspector open":X?"Jump to bottleneck":"Select first step"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>E&&l(E),disabled:!E||!P,title:P?void 0:"Complete core missions to unlock replay guidance.","data-help":!0,"data-help-title":"Replay","data-help-body":"Branch a replay from a decisive step.","data-help-placement":"right",children:"Replay from step"})]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Mode"}),t.jsxs("div",{className:"director-modes",children:[t.jsx("button",{className:`ghost-button ${n==="cinema"?"active":""}`,type:"button",onClick:()=>r("cinema"),"data-help":!0,"data-help-title":"Cinema mode","data-help-body":"Timeline view for pacing and sequence.","data-help-placement":"right",children:"Cinema"}),t.jsx("button",{className:`ghost-button ${n==="flow"?"active":""}`,type:"button",onClick:()=>r("flow"),"data-help":!0,"data-help-title":"Flow mode","data-help-body":"Graph view for dependencies.","data-help-placement":"right",children:"Flow"}),t.jsx("button",{className:"ghost-button",type:"button",disabled:!0,children:"Compare"})]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Adaptive missions"}),t.jsxs("div",{className:"mission-summary",children:[(w==null?void 0:w.done)??0,"/",(w==null?void 0:w.total)??0," complete",t.jsxs("span",{children:[(w==null?void 0:w.pct)??0,"%"]})]}),t.jsxs("div",{className:"mission-stage",children:["Stage: ",me?"Collaboration":P?"Analysis":"Foundation"]}),t.jsx("div",{className:"mission-grid",children:Object.entries(x).map(([A,Q])=>t.jsxs("div",{className:`mission-chip ${Q?"done":""}`,children:[t.jsx("span",{children:A}),t.jsx("span",{children:Q?"Done":"Pending"})]},A))}),t.jsx("button",{className:"ghost-button",type:"button",onClick:v,children:"Reset missions"})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Action plan"}),P?p.length===0?t.jsx("div",{className:"annotation-empty",children:"No recommendations generated yet."}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"mission-summary",children:[M,"/",p.length," complete",t.jsxs("span",{children:[U,"%"]})]}),t.jsx("div",{className:"director-recommendations",children:p.map(A=>{const Q=N.includes(A.id);return t.jsxs("article",{className:`director-recommendation tone-${A.tone} ${Q?"done":""}`,children:[t.jsx("div",{className:"director-recommendation-title",children:A.title}),t.jsx("p",{className:"director-recommendation-body",children:A.body}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>fe(A),children:Q?"Completed":A.actionLabel})]},A.id)})})]}):t.jsx("div",{className:"annotation-empty",children:"Complete inspect/flow/replay missions to unlock AI narrative tools."}),me?null:t.jsx("div",{className:"annotation-empty",children:"Open another live session to unlock collaboration activity feed."})]})]}):null,R==="narrative"?t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"AI director narrative"}),P?t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"director-recommendation-body",children:h}),Me.length?t.jsx("div",{className:"director-guided-plan",children:Me.map(A=>t.jsx("div",{children:A.step},A.id))}):null,t.jsxs("div",{className:"director-ask-row",children:[t.jsx("input",{className:"search-input",value:V,onChange:A=>re(A.target.value),placeholder:"Ask Director (e.g. what is highest risk?)","aria-label":"Ask director question"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{V.trim()&&I((k==null?void 0:k(V))??"")},children:"Ask"})]}),j?t.jsx("div",{className:"director-answer",children:j}):null,t.jsx("button",{className:"ghost-button",type:"button",onClick:S,children:"Export narrative"})]}):t.jsx("div",{className:"annotation-empty",children:"Complete inspect/flow/replay missions to unlock AI narrative tools."})]}):null,R==="collab"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Shared annotations"}),t.jsx("textarea",{value:F,onChange:A=>B(A.target.value),rows:3,placeholder:s?"Add note for selected step...":"Add trace-level note...","aria-label":"Shared annotation"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{const A=F.trim();A&&(y==null||y(A,s),B(""))},children:"Add annotation"}),t.jsxs("div",{className:"annotation-list",children:[f.slice(-6).reverse().map(A=>t.jsxs("article",{className:"annotation-item",children:[t.jsxs("div",{className:"annotation-meta",children:[t.jsx("span",{children:A.stepId?`step ${A.stepId}`:"trace"}),t.jsx("span",{children:A.authorSessionId})]}),t.jsx("p",{children:A.body})]},A.id)),f.length===0?t.jsx("div",{className:"annotation-empty",children:"No shared annotations yet."}):null]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Collab activity"}),me?t.jsxs("div",{className:"activity-list",children:[D.map(A=>t.jsxs("div",{className:"activity-item",children:[t.jsx("span",{children:A.message}),t.jsx("span",{children:new Date(A.timestamp).toLocaleTimeString()})]},A.id)),D.length===0?t.jsx("div",{className:"annotation-empty",children:"No activity yet."}):null]}):t.jsx("div",{className:"annotation-empty",children:"Open another live session to unlock collaboration activity feed."})]})]}):null]})}const cn=(e,n,s)=>Math.min(s,Math.max(n,e));function dn(e){return Array.from((e==null?void 0:e.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'))??[]).filter(s=>!(s.hasAttribute("disabled")||s.getAttribute("aria-hidden")==="true"))}function Fo({steps:e,open:n,onClose:s,onComplete:r}){const[i,d]=c.useState(0),[l,p]=c.useState(null),[u,f]=c.useState(null),b=c.useRef(null),y=c.useRef(null),x=c.useRef(null),w=c.useMemo(()=>e[i],[e,i]),v=c.useCallback(()=>{if(!n)return;const E=document.querySelector(w.target);if(!E){y.current=null,p(null);return}y.current=E;const _=E.getBoundingClientRect();p(_)},[n,w.target]),h=c.useCallback(()=>{if(!l||!b.current){f(null);return}const E=b.current.offsetWidth,_=b.current.offsetHeight,H=16;let F=cn(l.left+l.width/2-E/2,H,window.innerWidth-E-H),B=l.bottom+16;w.placement==="top"&&(B=l.top-_-16),w.placement==="left"&&(F=l.left-E-16,B=l.top+l.height/2-_/2),w.placement==="right"&&(F=l.right+16,B=l.top+l.height/2-_/2),B+_>window.innerHeight-H&&(B=l.top-_-16),B<H&&(B=l.bottom+16),F=cn(F,H,window.innerWidth-E-H),B=cn(B,H,window.innerHeight-_-H),f({top:B,left:F})},[w.placement,l]);if(c.useEffect(()=>{n&&d(0)},[n]),c.useEffect(()=>{var _,H;if(!n){(H=(_=x.current)==null?void 0:_.focus)==null||H.call(_);return}x.current=document.activeElement;const E=window.setTimeout(()=>{var B;(B=dn(b.current)[0]??b.current)==null||B.focus()},0);return()=>window.clearTimeout(E)},[n]),c.useEffect(()=>{if(!n)return;const E=document.querySelector(w.target);E&&E.scrollIntoView({behavior:"smooth",block:"center",inline:"center"});const _=window.requestAnimationFrame(()=>v());return()=>window.cancelAnimationFrame(_)},[n,w.target,v]),c.useLayoutEffect(()=>{h()},[l,h,w.title]),c.useEffect(()=>{if(!n)return;const E=()=>{v(),h()};return window.addEventListener("resize",E),window.addEventListener("scroll",E,!0),()=>{window.removeEventListener("resize",E),window.removeEventListener("scroll",E,!0)}},[n,v,h]),c.useEffect(()=>{if(!n)return;const E=_=>{var re;if(_.key==="Escape"){_.preventDefault(),s();return}if(_.key!=="Tab")return;const H=dn(b.current);if(!H.length)return;const F=document.activeElement,B=H.indexOf(F),V=_.shiftKey?B<=0?H.length-1:B-1:(B+1)%H.length;(re=H[V])==null||re.focus(),_.preventDefault()};return document.addEventListener("keydown",E,!0),()=>document.removeEventListener("keydown",E,!0)},[s,n]),!n||!w)return null;const k=E=>{var V;if(E.key==="Escape"){E.preventDefault(),s();return}if(E.key!=="Tab")return;const _=dn(b.current);if(_.length===0)return;const H=document.activeElement,F=_.indexOf(H),B=E.shiftKey?F<=0?_.length-1:F-1:(F+1)%_.length;(V=_[B])==null||V.focus(),E.preventDefault()},S=`tour-title-${w.id}`,$=`tour-body-${w.id}`,X=l?{top:l.top-6,left:l.left-6,width:l.width+12,height:l.height+12}:void 0;return t.jsxs("div",{className:"tour-overlay",role:"dialog","aria-modal":"true","aria-label":"Guided tour","aria-labelledby":S,"aria-describedby":$,onKeyDown:k,children:[t.jsx("div",{className:"tour-backdrop",onClick:s}),l?t.jsx("div",{className:"tour-spotlight",style:X}):null,t.jsxs("div",{className:`tour-card ${u?"tour-card-anchored":""}`,ref:b,style:u??void 0,tabIndex:-1,children:[t.jsxs("div",{className:"tour-step",children:["Step ",i+1," of ",e.length]}),t.jsx("div",{className:"tour-title",id:S,children:w.title}),t.jsx("p",{className:"tour-body",id:$,children:w.body}),t.jsxs("div",{className:"tour-actions",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>d(E=>Math.max(0,E-1)),disabled:i===0,children:"Back"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:s,children:"Skip"}),i===e.length-1?t.jsx("button",{className:"primary-button",type:"button",onClick:r,children:"Finish tour"}):t.jsx("button",{className:"primary-button",type:"button",onClick:()=>d(E=>E+1),children:"Next"})]})]})]})}const Ts=(e,n,s)=>Math.min(s,Math.max(n,e));function qo({enabled:e}){const[n,s]=c.useState(null),[r,i]=c.useState(null),d=c.useRef(null),l=c.useRef(null),p=c.useCallback(()=>{const f=d.current;if(!f){s(null);return}const b=f.getBoundingClientRect(),y=f.dataset.helpTitle??"Context",x=f.dataset.helpBody??"",w=f.dataset.helpPlacement??"right";s({rect:b,title:y,body:x,placement:w})},[]);c.useEffect(()=>{if(!e){d.current=null,s(null);return}const f=v=>{var k,S;const h=(S=(k=v.target)==null?void 0:k.closest)==null?void 0:S.call(k,"[data-help]");if(!h){d.current||s(null);return}d.current!==h&&(d.current=h,p())},b=v=>{var k,S;const h=(S=(k=v.target)==null?void 0:k.closest)==null?void 0:S.call(k,"[data-help]");h&&(d.current=h,p())},y=v=>{var k;const h=v.relatedTarget;(k=h==null?void 0:h.closest)!=null&&k.call(h,"[data-help]")||(d.current=null,s(null))},x=v=>{var k,S;const h=(S=(k=v.target)==null?void 0:k.closest)==null?void 0:S.call(k,"[data-help]");if(!h){d.current=null,s(null);return}d.current=h,p()},w=()=>{d.current&&p()};return window.addEventListener("mousemove",f),window.addEventListener("focusin",b),window.addEventListener("focusout",y),window.addEventListener("pointerdown",x),window.addEventListener("scroll",w,!0),window.addEventListener("resize",w),()=>{window.removeEventListener("mousemove",f),window.removeEventListener("focusin",b),window.removeEventListener("focusout",y),window.removeEventListener("pointerdown",x),window.removeEventListener("scroll",w,!0),window.removeEventListener("resize",w)}},[e,p]);const u=c.useCallback(()=>{if(!n||!l.current){i(null);return}const f=12,b=l.current.offsetWidth,y=l.current.offsetHeight,{rect:x,placement:w}=n;let v=x.right+16,h=x.top+x.height/2-y/2;w==="left"&&(v=x.left-b-16,h=x.top+x.height/2-y/2),w==="top"&&(v=x.left+x.width/2-b/2,h=x.top-y-16),w==="bottom"&&(v=x.left+x.width/2-b/2,h=x.bottom+16),v=Ts(v,f,window.innerWidth-b-f),h=Ts(h,f,window.innerHeight-y-f),i({left:v,top:h})},[n]);return c.useLayoutEffect(()=>{u()},[u]),!e||!n?null:t.jsxs("div",{className:"help-overlay","aria-hidden":"true",children:[t.jsx("div",{className:"help-highlight",style:{top:n.rect.top-6,left:n.rect.left-6,width:n.rect.width+12,height:n.rect.height+12}}),t.jsxs("div",{className:"help-bubble",ref:l,style:r??void 0,"data-placement":n.placement,children:[t.jsx("div",{className:"help-title",children:n.title}),t.jsx("div",{className:"help-body",children:n.body})]})]})}const Go=[{id:"builder",label:"Builder lens",body:"Focus on step payloads, execution paths, and replay control."},{id:"executive",label:"Executive lens",body:"Focus on bottlenecks, risk, and outcome-level run quality."},{id:"operator",label:"Operator lens",body:"Focus on failures, retries, and trace reliability posture."}],Bo=[{id:"rapid_triage",label:"Rapid triage",body:"Jump straight to the highest-risk step and start resolution.",estimate:"2-3 min"},{id:"deep_diagnosis",label:"Deep diagnosis",body:"Open flow and guided analysis for full root-cause exploration.",estimate:"8-12 min"},{id:"team_sync",label:"Team sync",body:"Open collaborative mode and prep a handoff workflow.",estimate:"4-6 min"}];function zo({onComplete:e,onStartTour:n,onStartStory:s,persona:r="builder",onPersonaChange:i,launchPath:d="rapid_triage",onLaunchPathChange:l,onStartLaunchPath:p}){const u=()=>{n==null||n(),e()},f=()=>{s==null||s(),e()},b=y=>{l==null||l(y),p==null||p(y),e()};return t.jsx("div",{className:"intro-overlay",role:"dialog","aria-modal":"true","aria-label":"Agent Director intro",children:t.jsxs("div",{className:"intro-card",children:[t.jsx("div",{className:"intro-scan"}),t.jsx("div",{className:"intro-title",children:"Agent Director"}),t.jsx("div",{className:"intro-tagline",children:"Watch your agent think. Then direct it."}),t.jsxs("div",{className:"intro-steps",children:[t.jsxs("div",{className:"intro-step",children:[t.jsx("div",{className:"intro-step-label",children:"Observe"}),t.jsx("div",{className:"intro-step-body",children:"Scrub the timeline to feel pacing and parallelism."})]}),t.jsxs("div",{className:"intro-step",children:[t.jsx("div",{className:"intro-step-label",children:"Inspect"}),t.jsx("div",{className:"intro-step-body",children:"Open the bottleneck to read payloads and costs."})]}),t.jsxs("div",{className:"intro-step",children:[t.jsx("div",{className:"intro-step-label",children:"Direct"}),t.jsx("div",{className:"intro-step-body",children:"Replay from a decisive step and compare runs."})]})]}),t.jsx("div",{className:"intro-personas",role:"group","aria-label":"Select onboarding lens",children:Go.map(y=>t.jsxs("button",{type:"button",className:`ghost-button intro-persona ${r===y.id?"active":""}`,onClick:()=>i==null?void 0:i(y.id),"aria-pressed":r===y.id,"aria-label":y.label,children:[t.jsx("span",{className:"intro-persona-label",children:y.label}),t.jsx("span",{className:"intro-persona-body",children:y.body})]},y.id))}),t.jsx("div",{className:"intro-launch-paths",role:"group","aria-label":"Select launch path",children:Bo.map(y=>t.jsxs("article",{className:`intro-path-card ${d===y.id?"active":""}`,children:[t.jsxs("button",{type:"button",className:`ghost-button intro-path-button ${d===y.id?"active":""}`,onClick:()=>l==null?void 0:l(y.id),"aria-pressed":d===y.id,"aria-label":y.label,children:[t.jsx("span",{className:"intro-path-label",children:y.label}),t.jsx("span",{className:"intro-path-estimate",children:y.estimate}),t.jsx("span",{className:"intro-path-body",children:y.body})]}),t.jsxs("button",{className:"primary-button intro-path-start",type:"button",onClick:()=>b(y.id),children:["Start ",y.label]})]},y.id))}),t.jsxs("div",{className:"intro-grid",children:[t.jsx("span",{}),t.jsx("span",{}),t.jsx("span",{}),t.jsx("span",{})]}),t.jsxs("div",{className:"intro-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:u,children:"Start guided tour"}),s?t.jsx("button",{className:"ghost-button",type:"button",onClick:f,children:"Play story mode"}):null,t.jsx("button",{className:"ghost-button",type:"button",onClick:e,children:"Skip intro"})]})]})})}function Uo({explainMode:e,storyActive:n,onStartTour:s,onStartStory:r,onToggleExplain:i,onDismiss:d}){return t.jsxs("section",{className:"hero-ribbon","aria-label":"Director briefing","data-help":!0,"data-help-indicator":!0,"data-tour":"hero","data-help-title":"Director briefing","data-help-body":"Start the tour, play story mode, or enable explain to learn the interface instantly.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"hero-ribbon-top",children:[t.jsx("span",{className:"hero-eyebrow",children:"Director briefing"}),t.jsx("button",{className:"ghost-button hero-dismiss",type:"button",onClick:d,children:"Dismiss"})]}),t.jsx("div",{className:"hero-title",children:"Observe. Inspect. Direct."}),t.jsx("div",{className:"hero-subtitle",children:"A cinematic control room for agent traces. See time, read structure, then replay with confidence."}),t.jsxs("div",{className:"hero-pills",children:[t.jsx("span",{className:"hero-pill","data-tone":"observe",children:"Observe"}),t.jsx("span",{className:"hero-pill","data-tone":"inspect",children:"Inspect"}),t.jsx("span",{className:"hero-pill","data-tone":"direct",children:"Direct"})]}),t.jsxs("div",{className:"hero-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:s,children:"Start guided tour"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:r,disabled:n,children:n?"Story running":"Play story mode"}),t.jsxs("button",{className:`ghost-button ${e?"active":""}`,type:"button",onClick:i,"aria-pressed":e,children:["Explain ",e?"On":"Off"]})]})]})}function Ho({mode:e,isPlaying:n,storyActive:s,explainMode:r,hidden:i=!1,open:d,onToggleOpen:l,onTogglePlay:p,onStartStory:u,onStopStory:f,onStartTour:b,onOpenPalette:y,onShowShortcuts:x,onToggleExplain:w,onJumpToBottleneck:v}){if(i)return null;const h=n?"Pause":"Play",k=s?"Stop story":"Story mode";return d?t.jsxs("aside",{className:"quick-actions","aria-label":"Quick actions","data-help":!0,"data-help-indicator":!0,"data-tour":"quick-actions","data-help-title":"Quick actions","data-help-body":"Launch story mode, open the command palette, or jump to the bottleneck instantly.","data-help-placement":"left",children:[t.jsxs("div",{className:"quick-actions-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"quick-actions-title",children:"Quick actions"}),t.jsx("div",{className:"quick-actions-subtitle",children:"Pin demo controls close at hand."})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:l,"aria-label":"Collapse quick actions",children:"Collapse"})]}),t.jsxs("button",{className:`quick-action ${n?"active":""}`,type:"button",onClick:p,"aria-label":h,"data-help":!0,"data-help-title":"Play or pause","data-help-body":"Start or stop playback from anywhere.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:h}),t.jsx("span",{className:"quick-action-meta",children:e==="flow"?"Cinema":"Space"})]}),t.jsxs("button",{className:`quick-action ${s?"active":""}`,type:"button",onClick:s?f:u,"aria-label":k,"data-help":!0,"data-help-title":"Story mode","data-help-body":"Auto-runs a cinematic walkthrough of the run.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:k}),t.jsx("span",{className:"quick-action-meta",children:"S"})]}),t.jsxs("button",{className:"quick-action",type:"button",onClick:y,"aria-label":"Open command palette","data-help":!0,"data-help-title":"Command palette","data-help-body":"Search every action and jump instantly.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Command"}),t.jsx("span",{className:"quick-action-meta",children:"Cmd+K"})]}),t.jsxs("button",{className:"quick-action",type:"button",onClick:b,"aria-label":"Start guided tour","data-help":!0,"data-help-title":"Guided tour","data-help-body":"Walk the interface with a curated tour.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Tour"}),t.jsx("span",{className:"quick-action-meta",children:"Guide"})]}),t.jsxs("button",{className:`quick-action ${r?"active":""}`,type:"button",onClick:w,"aria-label":"Toggle explain mode","data-help":!0,"data-help-title":"Explain mode","data-help-body":"Toggle contextual overlays for every control.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Explain"}),t.jsx("span",{className:"quick-action-meta",children:r?"On":"Off"})]}),t.jsxs("button",{className:"quick-action",type:"button",onClick:v,"aria-label":"Jump to bottleneck","data-help":!0,"data-help-title":"Bottleneck jump","data-help-body":"Focus instantly on the slowest step.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Bottleneck"}),t.jsx("span",{className:"quick-action-meta",children:"Latency"})]}),t.jsxs("button",{className:"quick-action",type:"button",onClick:x,"aria-label":"Show shortcuts","data-help":!0,"data-help-title":"Shortcuts","data-help-body":"See the full keyboard map.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:"Shortcuts"}),t.jsx("span",{className:"quick-action-meta",children:"?"})]})]}):t.jsxs("button",{className:"quick-actions-toggle",type:"button",onClick:l,title:"Open quick actions","aria-expanded":"false","data-help":!0,"data-tour":"quick-actions","data-help-title":"Quick actions","data-help-body":"Open the dock to access demos, shortcuts, and instant actions.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-actions-toggle-label",children:"Actions"}),t.jsx("span",{className:"quick-actions-toggle-meta",children:"Dock"})]})}function Wo({active:e,label:n,step:s,total:r,onStop:i,onRestart:d}){if(!e)return null;const l=r>0?(s+1)/r*100:0;return t.jsxs("div",{className:"story-banner",role:"status","aria-live":"polite",children:[t.jsxs("div",{className:"story-banner-main",children:[t.jsx("div",{className:"story-banner-title",children:"Story mode"}),t.jsx("div",{className:"story-banner-step",children:n})]}),t.jsxs("div",{className:"story-banner-actions",children:[t.jsxs("span",{className:"story-banner-count",children:[Math.min(s+1,r),"/",r]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:d,children:"Restart"}),t.jsx("button",{className:"primary-button",type:"button",onClick:i,children:"Stop"})]}),t.jsx("div",{className:"story-banner-progress",children:t.jsx("span",{style:{width:`${l}%`}})})]})}function un({variant:e,title:n,message:s,actions:r=[]}){return t.jsx("section",{className:`app-shell-state app-shell-${e}`,"aria-live":"polite",children:t.jsxs("div",{className:"app-shell-card",children:[e==="loading"?t.jsx("div",{className:"app-shell-spinner","aria-hidden":"true"}):null,t.jsx("h2",{children:n}),t.jsx("p",{children:s}),r.length?t.jsx("div",{className:"app-shell-actions",children:r.map(i=>t.jsx("span",{children:i.node},i.id))}):null]})})}function Jo({notifications:e,onDismiss:n}){return e.length?t.jsx("aside",{className:"notification-center","aria-label":"System notifications","aria-live":"polite",children:e.map(s=>t.jsxs("article",{className:`notification-item level-${s.level}`,children:[t.jsx("p",{children:s.message}),t.jsx("button",{className:"ghost-button notification-dismiss",type:"button",onClick:()=>n(s.id),"aria-label":"Dismiss notification",children:"Dismiss"})]},s.id))}):null}function Vo({steps:e,fromRects:n,toRects:s,onComplete:r}){return c.useEffect(()=>{const i=window.setTimeout(r,550);return()=>window.clearTimeout(i)},[r]),t.jsx("div",{className:"morph-layer",children:e.map(i=>{var p;const d=n[i.id],l=s[i.id];return!d||!l?null:t.jsxs(Bi.div,{className:`morph-card step-${i.type}`,initial:{left:d.left,top:d.top,width:d.width,height:d.height},animate:{left:l.left,top:l.top,width:l.width,height:l.height},transition:{duration:.5,ease:"easeInOut"},children:[t.jsx("div",{className:"morph-card-title",children:i.name}),t.jsx("div",{className:"morph-card-subtitle",children:((p=i.preview)==null?void 0:p.title)??i.type})]},i.id)})})}function Ko({morph:e,onComplete:n,children:s}){return t.jsxs("div",{className:"morph-orchestrator",children:[s,e?t.jsx(Vo,{steps:e.steps,fromRects:e.fromRects,toRects:e.toRects,onComplete:n}):null]})}const Qo="demo-trace-overlap-001",Yo="Overlap + ToolCallId Demo",Xo="2026-01-27T10:00:00.000Z",Zo="2026-01-27T10:00:05.000Z",el="completed",tl={source:"openai_agents",agentName:"DemoAgent",modelId:"gpt-4o-2024-11-20",wallTimeMs:5e3,workTimeMs:7200,totalTokens:1400,totalCostUsd:.018},al=[{id:"s1",index:0,type:"llm_call",name:"plan",startedAt:"2026-01-27T10:00:00.000Z",endedAt:"2026-01-27T10:00:01.000Z",durationMs:1e3,childStepIds:[],metrics:{tokensTotal:300,costUsd:.004},preview:{title:"LLM: plan",subtitle:"gpt-4o",outputPreview:"I'll fetch two sources..."},status:"completed"},{id:"s2",index:1,type:"llm_call",name:"call_tools",startedAt:"2026-01-27T10:00:01.000Z",endedAt:"2026-01-27T10:00:01.200Z",durationMs:200,childStepIds:[],metrics:{tokensTotal:120,costUsd:.002},preview:{title:"LLM: call tools",outputPreview:"Calling web_search + database_query"},io:{emittedToolCallIds:["tc-001","tc-002"]},status:"completed"},{id:"s3",index:2,type:"tool_call",name:"web_search",toolCallId:"tc-001",startedAt:"2026-01-27T10:00:01.200Z",endedAt:"2026-01-27T10:00:03.200Z",durationMs:2e3,childStepIds:[],metrics:{costUsd:0},preview:{title:"Tool: web_search",inputPreview:'{"q":"EU AI Act"}',outputPreview:"[3 results...]"},status:"completed"},{id:"s4",index:3,type:"tool_call",name:"database_query",toolCallId:"tc-002",startedAt:"2026-01-27T10:00:01.500Z",endedAt:"2026-01-27T10:00:02.700Z",durationMs:1200,childStepIds:[],preview:{title:"Tool: database_query",inputPreview:'{"sql":"SELECT..."}',outputPreview:'{"rows":42}'},status:"completed"},{id:"s5",index:4,type:"llm_call",name:"analyze",startedAt:"2026-01-27T10:00:03.200Z",endedAt:"2026-01-27T10:00:04.600Z",durationMs:1400,childStepIds:[],metrics:{tokensTotal:700,costUsd:.012},preview:{title:"LLM: analyze",outputPreview:"Synthesis based on tool outputs..."},io:{consumedToolCallIds:["tc-001","tc-002"]},status:"completed"}],xa={id:Qo,name:Yo,startedAt:Xo,endedAt:Zo,status:el,metadata:tl,steps:al};function sr(e,n){const s=nl(e,n),r=new Set(s.map(y=>y.leftId)),i=new Set(s.map(y=>y.rightId)),d=n.steps.filter(y=>!i.has(y.id)).map(y=>y.id),l=e.steps.filter(y=>!r.has(y.id)).map(y=>y.id),p=s.filter(y=>{const x=e.steps.find(v=>v.id===y.leftId),w=n.steps.find(v=>v.id===y.rightId);return!x||!w?!1:Ds(x)!==Ds(w)}),u=p.map(y=>y.leftId),f=(n.metadata.totalCostUsd??0)-(e.metadata.totalCostUsd??0),b=n.metadata.wallTimeMs-e.metadata.wallTimeMs;return{addedSteps:d,removedSteps:l,changedSteps:u,changedPairs:p,alignedSteps:s,costDeltaUsd:f,wallTimeDeltaMs:b}}function nl(e,n){const s=[],r=new Set(e.steps.map(b=>b.id)),i=new Set(n.steps.map(b=>b.id));Array.from(r).forEach(b=>{i.has(b)&&(s.push({leftId:b,rightId:b}),r.delete(b),i.delete(b))});const d=new Map;n.steps.forEach(b=>{b.toolCallId&&d.set(b.toolCallId,b.id)}),e.steps.forEach(b=>{if(!b.toolCallId)return;const y=d.get(b.toolCallId);y&&i.has(y)&&(s.push({leftId:b.id,rightId:y}),r.delete(b.id),i.delete(y))});const l=_s(e),p=_s(n),u=sl(e,n),f={};return i.forEach(b=>{const y=p.get(b);if(!y)return;const x=As(y.step);x&&(f[x]||(f[x]=[]),f[x].push(b))}),Object.values(f).forEach(b=>{b.sort((y,x)=>{var w,v;return(((w=p.get(y))==null?void 0:w.startMs)??0)-(((v=p.get(x))==null?void 0:v.startMs)??0)})}),Array.from(r).forEach(b=>{var v;const y=l.get(b);if(!y)return;const x=As(y.step);if(!x||!((v=f[x])!=null&&v.length))return;const w=rl(y,f[x],p,u);w&&(s.push({leftId:b,rightId:w}),r.delete(b),i.delete(w),f[x]=f[x].filter(h=>h!==w))}),s}function Ds(e){var r,i;const n=((r=e.preview)==null?void 0:r.outputPreview)??null,s=((i=e.metrics)==null?void 0:i.costUsd)??null;return`${e.status}|${n??""}|${s??""}`}function As(e){return e.type?`${e.type}:${e.name??""}`:null}function $s(e){if(!e)return null;const n=Date.parse(e);return Number.isNaN(n)?null:n}function _s(e){const n=$s(e.startedAt),s=new Map;return e.steps.forEach(r=>{const i=$s(r.startedAt),d=n!=null&&i!=null?i-n:null;s.set(r.id,{step:r,startMs:d})}),s}function sl(e,n){const s=Math.max(e.metadata.wallTimeMs,n.metadata.wallTimeMs,1);return Math.max(1e3,Math.min(5e3,Math.round(s*.1)))}function rl(e,n,s,r){const i=e.startMs;if(i==null)return null;let d=null,l=r+1;return n.forEach(p=>{const u=s.get(p);if(!u||u.startMs==null)return;const f=Math.abs(u.startMs-i);f<l&&(l=f,d=p)}),l<=r?d:null}const il=new Map,ol=new Map,lt=new Map;async function ll(){return[xa]}async function rr(e){return{trace:xa}}const cl={s1:{role:"assistant",content:"I'll analyze the user's request and create a plan to fetch information from two sources: a web search for current EU AI Act updates and a database query for historical compliance data.",model:"gpt-4o-2024-11-20",usage:{prompt_tokens:150,completion_tokens:150,total_tokens:300},reasoning:"The user wants comprehensive information about AI regulations. I'll use parallel tool calls to maximize efficiency."},s2:{role:"assistant",content:null,tool_calls:[{id:"tc-001",type:"function",function:{name:"web_search",arguments:'{"q":"EU AI Act latest updates 2026"}'}},{id:"tc-002",type:"function",function:{name:"database_query",arguments:`{"sql":"SELECT * FROM compliance_records WHERE region='EU' ORDER BY date DESC LIMIT 10"}`}}],model:"gpt-4o-2024-11-20",usage:{prompt_tokens:80,completion_tokens:40,total_tokens:120}},s3:{tool_call_id:"tc-001",tool_name:"web_search",input:{q:"EU AI Act latest updates 2026"},output:{results:[{title:"EU AI Act Implementation Timeline",url:"https://example.com/ai-act",snippet:"The EU AI Act enters full force in 2026..."},{title:"High-Risk AI Systems Classification",url:"https://example.com/classification",snippet:"New guidance on high-risk categorization..."},{title:"Compliance Deadlines Approaching",url:"https://example.com/deadlines",snippet:"Organizations must comply by August 2026..."}],total_results:3,search_time_ms:1850},status:"success"},s4:{tool_call_id:"tc-002",tool_name:"database_query",input:{sql:"SELECT * FROM compliance_records WHERE region='EU' ORDER BY date DESC LIMIT 10"},output:{rows:[{id:1,company:"TechCorp",status:"compliant",date:"2026-01-15"},{id:2,company:"AIStartup",status:"in_progress",date:"2026-01-10"},{id:3,company:"DataCo",status:"compliant",date:"2026-01-05"}],row_count:42,query_time_ms:1100},status:"success"},s5:{role:"assistant",content:`Based on my analysis of the web search results and database records:

**Key Findings:**
1. The EU AI Act is now in full effect as of 2026
2. High-risk AI systems require specific compliance measures
3. 42 organizations in our database have compliance records

**Recommendations:**
- Review classification of AI systems
- Ensure documentation is complete
- Schedule compliance audit before August deadline`,model:"gpt-4o-2024-11-20",usage:{prompt_tokens:450,completion_tokens:250,total_tokens:700},reasoning:"Synthesized information from both the web search (3 relevant articles) and database query (42 compliance records) to provide actionable insights."}};function dl(e,n){const s=xa.steps.find(d=>d.id===e);if(!s)return null;const r=cl[e];if(!r)return null;const i=n?ul(r):r;return{...s,data:i}}function ul(e){var s,r;const n=JSON.parse(JSON.stringify(e));return(s=n.input)!=null&&s.sql&&(n.input.sql="[REDACTED]"),(r=n.output)!=null&&r.rows&&(n.output.rows=n.output.rows.map(i=>({...i,company:"[REDACTED]"}))),n.tool_calls&&(n.tool_calls=n.tool_calls.map(i=>({...i,function:{...i.function,arguments:"[REDACTED]"}}))),n}async function pl(e,n,s,r=[],i=!1){return await new Promise(d=>setTimeout(d,150)),dl(n,i)}async function ml(e,n,s){await pl(e,n,"redacted",[],s)}function hl(e,n){return()=>{}}function fl(){il.clear(),ol.clear()}async function yl(e,n){return null}async function bl(e){return null}async function _c(e,n){return[]}async function Rc(e,n,s,r,i){return null}async function gl(){return[]}async function xl(e,n){return null}async function vl(e,n,s,r,i){return i?ir(i,n,s,r):null}function ir(e,n,s,r){var v;const i=JSON.parse(JSON.stringify(e)),d=6e4,l=Date.parse("2024-01-01T00:00:00.000Z"),p=Date.parse(e.endedAt??e.startedAt??""),f=(Number.isNaN(p)?l:p)+d,b=new Date(f);i.id=`${e.id}-replay-${f}`,i.parentTraceId=e.id,i.branchPointStepId=n,i.replay={strategy:s,modifiedStepId:n,modifications:r,createdAt:b.toISOString()};const y=h=>{if(!h)return h;const k=Date.parse(h);return Number.isNaN(k)?h:new Date(k+d).toISOString()};i.startedAt=y(i.startedAt)??i.startedAt,i.endedAt=y(i.endedAt);const x=new Set,w=((v=i.steps.find(h=>h.id===n))==null?void 0:v.index)??-1;return s==="live"?i.steps.forEach(h=>{h.index>w&&x.add(h.id)}):s==="hybrid"&&i.steps.forEach(h=>{h.index>w&&x.add(h.id)}),i.steps=i.steps.map(h=>{var S;const k={...h};if(k.startedAt=y(h.startedAt)??h.startedAt,k.endedAt=y(h.endedAt),h.id===n){const $=((S=h.preview)==null?void 0:S.outputPreview)??"";k.preview={...h.preview,outputPreview:`${$} (modified)`.trim()}}return x.has(h.id)&&(k.status="pending",k.endedAt=null,k.durationMs=void 0,k.metrics=void 0,k.preview={...h.preview,outputPreview:"[invalidated for replay]"}),k}),i}async function wl(e){return Sl(e)}async function jl(e){var n;return((n=lt.get(e))==null?void 0:n.job)??null}async function Rs(e){var n;return((n=lt.get(e))==null?void 0:n.matrix)??null}async function kl(e){{const n=lt.get(e);if(!n)return null;const s={...n.job,status:"canceled",scenarios:n.job.scenarios.map(r=>({...r,status:"canceled",endedAt:r.endedAt??new Date().toISOString()}))};return lt.set(e,{...n,job:s}),s}}function Sl(e){const n=`demo-job-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,s=xa,r=new Date().toISOString(),i=e.scenarios.map((u,f)=>({id:`demo-scn-${f+1}`,name:u.name,strategy:u.strategy,modifications:u.modifications,status:"running",startedAt:r,endedAt:null,replayTraceId:`${n}-replay-${f+1}`})),d={id:n,traceId:e.traceId,stepId:e.stepId,status:"running",createdAt:r,startedAt:r,endedAt:null,scenarioCount:i.length,completedCount:0,failedCount:0,canceledCount:0,scenarios:i},l=i.map(u=>{const f=ir(s,e.stepId,u.strategy,u.modifications);f.id=u.replayTraceId;const b=sr(s,f),y=s.metadata.totalCostUsd??0,x=f.metadata.totalCostUsd??y,w=s.metadata.errorCount??0,v=f.metadata.errorCount??w,h=s.metadata.retryCount??0,k=f.metadata.retryCount??h,S=f.steps.filter($=>$.status==="pending").length;return{scenarioId:u.id,name:u.name,strategy:u.strategy,status:"completed",replayTraceId:u.replayTraceId,modifications:u.modifications,error:null,changedStepIds:b.changedSteps,addedStepIds:b.addedSteps,removedStepIds:b.removedSteps,metrics:{costDeltaUsd:x-y,wallTimeDeltaMs:(f.metadata.wallTimeMs??0)-(s.metadata.wallTimeMs??0),errorDelta:v-w,retryDelta:k-h,changedSteps:b.changedSteps.length,addedSteps:b.addedSteps.length,removedSteps:b.removedSteps.length,invalidatedStepCount:S}}}),p={jobId:n,traceId:e.traceId,stepId:e.stepId,rows:l,causalRanking:[]};return lt.set(n,{job:d,matrix:p}),window.setTimeout(()=>{const u=lt.get(n);if(!u)return;const f=new Date().toISOString(),b=u.job.scenarios.map(w=>({...w,status:"completed",endedAt:f})),y={...u.job,status:"completed",endedAt:f,completedCount:b.length,scenarios:b},x={...u.matrix,rows:u.matrix.rows.map(w=>({...w,status:"completed"}))};lt.set(n,{job:y,matrix:x})},600),d}async function Nl(e){return null}async function Cl(e){return null}async function pn(e){return null}async function Ml(e){return null}async function El(e){return null}async function Il(e){return null}async function Os(e){return{session:null,conflict:!1,error:null}}async function Ps(e){return null}async function Tl(e){return null}async function Dl(e){return null}async function Al(e){return null}async function $l(e){return null}async function _l(e,n){return null}async function Rl(e){return null}async function Ol(e,n,s){return null}async function Ls(){return null}async function Fs(){return null}function Pl(e,n,s){return()=>{}}function Ll(){const[e,n]=c.useState(null),[s,r]=c.useState(null),[i,d]=c.useState(!0),[l,p]=c.useState(null),[u,f]=c.useState([]),[b,y]=c.useState(null),x=c.useCallback(async v=>{const h=await rr(),k=(h==null?void 0:h.trace)??null;n(k),r(k?(h==null?void 0:h.insights)??Qi(k):null)},[n,r]),w=c.useCallback(async()=>{var v;d(!0),p(null);try{const h=await ll();f(h);const k=((v=h[h.length-1])==null?void 0:v.id)??null,S=b??k;if(!S){n(null),r(null);return}if(!b||b!==S){y(S);return}await x(S)}catch(h){p(h instanceof Error?h.message:"Failed to load trace")}finally{d(!1)}},[b,x]);return c.useEffect(()=>{w()},[w]),c.useEffect(()=>{b&&(d(!0),x(b).catch(v=>{p(v instanceof Error?v.message:"Failed to load trace")}).finally(()=>d(!1)))},[b,x]),c.useEffect(()=>hl(),[b,y]),{trace:e,insights:s,loading:i,error:l,reload:w,traces:u,selectedTraceId:b,setSelectedTraceId:y}}function Y(e,n){const[s,r]=c.useState(()=>{if(typeof window>"u")return n;try{const i=window.localStorage.getItem(e);return i==null?n:JSON.parse(i)}catch{return n}});return c.useEffect(()=>{try{window.localStorage.setItem(e,JSON.stringify(s))}catch{}},[e,s]),[s,r]}const qs=new Map;function Fl(e,n){const s=e.map(i=>i.id).join("|"),r=n.map(i=>`${i.source}->${i.target}`).join("|");return`${e.length}:${n.length}:${s}:${r}`}function ql(e,n,s){if(s){const r=Fl(e,n),i=qs.get(s);if(i&&i.signature===r)return i.layout;const d=Gs(e,n);return qs.set(s,{signature:r,layout:d}),d}return Gs(e,n)}function Gs(e,n){if(e.length>2500){const r=Math.ceil(Math.sqrt(e.length));return e.map((i,d)=>{const l=Math.floor(d/r),p=d%r;return{id:i.id,position:{x:p*260,y:l*160}}})}const s=new xs.graphlib.Graph;return s.setGraph({rankdir:"LR",nodesep:48,ranksep:80}),s.setDefaultEdgeLabel(()=>({})),e.forEach(r=>{s.setNode(r.id,{width:220,height:120})}),n.forEach(r=>{s.setEdge(r.source,r.target)}),xs.layout(s),e.map(r=>{const i=s.node(r.id);return{id:r.id,position:{x:i.x-i.width/2,y:i.y-i.height/2}}})}const or="agentDirector.gameplayFunnel.v1";function Gl(){try{const e=window.localStorage.getItem(or);if(!e)return[];const n=JSON.parse(e);return Array.isArray(n)?n.filter(s=>{if(!s||typeof s!="object")return!1;const r=s;return typeof r.name=="string"&&typeof r.at=="number"&&!!r.metadata&&typeof r.metadata=="object"}):[]}catch{return[]}}function Bl(e,n={}){const s={name:e,at:Date.now(),metadata:n},i=[...Gl(),s].slice(-200);return window.localStorage.setItem(or,JSON.stringify(i)),s}function zl(e){const n=new Map;for(const r of e)r.type==="tool_call"&&r.toolCallId&&n.set(r.toolCallId,r.id);const s=[];for(const r of e)if(!(r.type!=="llm_call"||!r.io)){for(const i of r.io.emittedToolCallIds??[]){const d=n.get(i);d&&s.push({id:`io_emit_${r.id}_${d}`,source:r.id,target:d,kind:"io",toolCallId:i})}for(const i of r.io.consumedToolCallIds??[]){const d=n.get(i);d&&s.push({id:`io_consume_${d}_${r.id}`,source:d,target:r.id,kind:"io",toolCallId:i})}}return s}function Ul(e,n,s){const{intervals:r}=ga(e,n,s),i=new Set;return r.forEach(d=>{i.add(d.startMs),i.add(d.endMs)}),Array.from(i).sort((d,l)=>d-l)}function Hl(e,n,s){if(!e.length)return null;if(s===1){for(const r of e)if(r>n+1)return r;return e[e.length-1]}for(let r=e.length-1;r>=0;r-=1){const i=e[r];if(i<n-1)return i}return e[0]}const Wl=300,Jl=2e3,Vl=1.5;function Kl(e){const n=Wl*Math.pow(Vl,Math.max(0,e));return Math.min(Jl,Math.round(n))}function et(e,n){if(!e)return n;try{return JSON.parse(e)}catch{return n}}function Bs(e,n){const s=new Map;return[...e,...n].forEach(r=>{const i=s.get(r.id);(!i||r.updatedAt>=i.updatedAt)&&s.set(r.id,r)}),Array.from(s.values()).sort((r,i)=>r.createdAt-i.createdAt)}function zs(e,n=50){return[...e].sort((s,r)=>r.timestamp-s.timestamp).slice(0,n)}const Ql=[{minDepth:1,maxDepth:1,difficulty:1},{minDepth:2,maxDepth:3,difficulty:2},{minDepth:4,maxDepth:5,difficulty:3},{minDepth:6,maxDepth:7,difficulty:4},{minDepth:8,maxDepth:9,difficulty:5},{minDepth:10,maxDepth:12,difficulty:6},{minDepth:13,maxDepth:16,difficulty:7},{minDepth:17,maxDepth:20,difficulty:8},{minDepth:21,maxDepth:24,difficulty:9},{minDepth:25,maxDepth:Number.MAX_SAFE_INTEGER,difficulty:10}],ya=["latency storm","cache divergence","tool timeout chain","stale prompt vector","schema mismatch surge"],Us=[{id:"seasonal-incident-sprint",title:"Resolve 3 raid objectives",goal:3,rewardCredits:120},{id:"boss-shutdown",title:"Defeat one boss encounter",goal:1,rewardCredits:200},{id:"guild-push",title:"Complete 2 guild operations",goal:2,rewardCredits:160},{id:"timeline-weaver",title:"Merge 2 timeline forks",goal:2,rewardCredits:150}],Yl={stability_patch:{credits:20,materials:12},precision_lens:{credits:28,materials:16},overclock_core:{credits:42,materials:24}};function ie(e,n,s){return Math.min(s,Math.max(n,e))}function lr(e){let n=0;for(let s=0;s<e.length;s+=1)n=(n*31+e.charCodeAt(s))%1e5;return n}function Xl(e,n,s){const r=lr(`${e}:${n}:${s.join("|")}`),i=ya[r%ya.length],d=ya[Math.floor(r/7)%ya.length],l=Array.from(new Set([i,d])),p=[...s].sort().slice(-2),u=`seed=${r};depth=${n};mutators=${p.join(",")||"none"}`;return{id:`mission-${n}-${(e+n)%997}`,title:`Scenario Depth ${n}`,difficulty:Zl(n),hazards:[...l,...p.slice(-1)],rewardCredits:60+n*15,missionSeed:r,blueprint:u}}function cr(e,n,s){return Xl(e,n,s)}function Zl(e){var s;const n=Math.max(1,Math.floor(e));return((s=Ql.find(r=>n>=r.minDepth&&n<=r.maxDepth))==null?void 0:s.difficulty)??10}function ec(){return[{id:"node-alpha",title:"Signal Fracture",body:"Telemetry divergence emerges across parallel tool paths.",choices:[{id:"alpha-risk",label:"Push aggressive branch optimization",nextNodeId:"node-beta",tensionDelta:12,mutator:"risk-surge"},{id:"alpha-safe",label:"Stabilize and preserve deterministic flow",nextNodeId:"node-beta",tensionDelta:-5,mutator:"stability-first"}]},{id:"node-beta",title:"Protocol Fork",body:"The team must choose speed versus interpretability under pressure.",choices:[{id:"beta-speed",label:"Favor speed and absorb uncertainty",nextNodeId:"node-gamma",tensionDelta:8,mutator:"throughput-boost"},{id:"beta-clarity",label:"Favor clarity and route through guardrails",nextNodeId:"node-gamma",tensionDelta:-3,mutator:"clarity-path"}]},{id:"node-gamma",title:"Final Directive",body:"Command has one move left before the run locks in.",choices:[{id:"gamma-strike",label:"Launch decisive strike sequence",nextNodeId:"node-alpha",tensionDelta:10,mutator:"strike-loop"},{id:"gamma-reset",label:"Reset tempo and rebuild confidence",nextNodeId:"node-alpha",tensionDelta:-6,mutator:"tempo-reset"}]}]}function dr(e,n){return{...Us[(e+n)%Us.length],progress:0,completed:!1}}function ur(e,n){const s=[...e,n];return Array.from(new Set(s)).slice(-6)}function bn(e,n,s){return{...e,campaign:{...e.campaign,depth:n,mutators:s,currentMission:cr(e.seed,n,s)}}}function Hs(e){const n=lr(e),s=["baseline"];return{seed:n,raid:{party:["director"],roles:{director:"strategist"},objectives:[{id:"obj-root-cause",label:"Identify root cause chain",progress:0,target:100,completed:!1},{id:"obj-recover",label:"Recover operational stability",progress:0,target:100,completed:!1},{id:"obj-harden",label:"Harden replay strategy",progress:0,target:100,completed:!1}],completed:!1},campaign:{depth:1,lives:3,completedMissionIds:[],mutators:s,currentMission:cr(n,1,s)},narrative:{currentNodeId:"node-alpha",nodes:ec(),history:[],tension:35},skills:{points:6,nodes:[{id:"skill-focus",label:"Focus Matrix",cost:1,requires:[],minLevel:1,requiredMilestones:[],tier:1,loadoutSlot:"core",unlocked:!1},{id:"skill-resilience",label:"Resilience Mesh",cost:1,requires:[],minLevel:1,requiredMilestones:[],tier:1,loadoutSlot:"utility",unlocked:!1},{id:"skill-surge",label:"Surge Compiler",cost:2,requires:["skill-focus"],minLevel:2,requiredMilestones:[],tier:2,loadoutSlot:"power",unlocked:!1},{id:"skill-echo",label:"Echo Anticipator",cost:2,requires:["skill-resilience"],minLevel:2,requiredMilestones:[],tier:2,loadoutSlot:"utility",unlocked:!1},{id:"skill-ward",label:"Ward Lattice",cost:2,requires:["skill-resilience"],minLevel:3,requiredMilestones:["milestone-level-3"],tier:3,loadoutSlot:"power",unlocked:!1},{id:"skill-overclock",label:"Overclock Nexus",cost:3,requires:["skill-surge","skill-echo"],minLevel:4,requiredMilestones:["milestone-level-3"],tier:3,loadoutSlot:"power",unlocked:!1}],loadout:{capacity:3,equipped:[],slotCaps:{core:1,utility:1,power:1}}},pvp:{round:0,stability:72,sabotage:28,fog:40,winner:null},time:{activeForkId:"primary",forks:[{id:"primary",label:"Primary timeline",playheadMs:0,history:[0]}]},boss:{name:"The Causality Hydra",phase:1,hp:320,maxHp:320,enraged:!1,phaseMechanic:"Phase 1: Shield lattice destabilization",vulnerability:"exploit"},director:{risk:30,hint:"Start with the bottleneck path and branch cautiously.",recommendedModifier:"stability_patch",lastOutcome:"mixed"},economy:{credits:140,materials:90,crafted:[],inflationIndex:.438,reserveTarget:320},rewards:{dailyClaimedOn:null,streakDays:0,sessionClaimed:!1,streakClaimedFor:0,masteryClaims:[],history:[]},guild:{name:"Trace Guild",members:4,operationsScore:0,eventsCompleted:0},cinematic:{queue:[]},liveops:{season:`Season-${2026+n%2}`,week:1,challenge:dr(n,1),difficultyFactor:1,rewardMultiplier:1,tuningHistory:[]},teamComms:{pings:[]},safety:{mutedPlayerIds:[],blockedPlayerIds:[],reports:[]},outcome:{status:"in_progress",reason:"Run started. Complete missions and stabilize the incident.",updatedAt:Date.now()},sandbox:{enabled:!1},progression:{xp:0,level:1,nextLevelXp:200,milestones:[]}}}function Oc(e,n){return{...e,sandbox:{enabled:n},outcome:n?{status:"in_progress",reason:"Sandbox mode enabled. Penalties are disabled for safe practice runs.",updatedAt:Date.now()}:e.outcome}}function Pc(e,n,s){if(!n.trim())return e;const r=e.raid.party.includes(n)?e.raid.party:[...e.raid.party,n];return{...e,raid:{...e.raid,party:r,roles:{...e.raid.roles,[n]:s}}}}function Lc(e,n,s){const r=Sn(e),i=e.raid.objectives.map(u=>{if(u.id!==n)return u;const f=ie(u.progress+s,0,u.target);return{...u,progress:f,completed:f>=u.target}}),d=i.every(u=>u.completed),l=d&&!e.raid.completed?180:0,p={...e,raid:{...e.raid,objectives:i,completed:d},outcome:d&&!e.raid.completed?{status:"partial",reason:"Raid objectives completed. Push campaign and boss tracks to close the run.",updatedAt:Date.now()}:r};return!d||e.raid.completed?p:We(Ht(p,l),60)}function Fc(e,n){const s=ic(e),r=e.campaign.currentMission;if(n){const u=e.campaign.depth+1,f=bn(e,u,e.campaign.mutators),b=u>=5?{status:"win",reason:"Campaign depth target reached. Incident run is stabilized.",updatedAt:Date.now()}:{status:"partial",reason:`Mission ${r.id} cleared. Advance deeper to secure the run.`,updatedAt:Date.now()},y={...f,campaign:{...f.campaign,completedMissionIds:[...f.campaign.completedMissionIds,r.id]},economy:{...f.economy,materials:f.economy.materials+14},director:{...f.director,lastOutcome:"success"},outcome:b};return We(Ht(y,r.rewardCredits),120)}const i=s.enabled?e.campaign.lives:ie(e.campaign.lives-1,0,3),d=bn(e,e.campaign.depth,ur(e.campaign.mutators,"failure-loop")),l=s.enabled?{status:"partial",reason:"Sandbox mode active. Failure recorded with no life penalty.",updatedAt:Date.now()}:i<=0?{status:"loss",reason:"No campaign lives remaining. Incident run failed.",updatedAt:Date.now()}:{status:"partial",reason:`Mission failed. ${i} campaign lives remaining.`,updatedAt:Date.now()},p={...d,campaign:{...d.campaign,lives:i},director:{...d.director,lastOutcome:"failure"},outcome:l};return We(p,40)}function qc(e,n){const s=e.narrative.nodes.find(p=>p.id===e.narrative.currentNodeId),r=s==null?void 0:s.choices.find(p=>p.id===n);if(!s||!r)return e;const i=ie(e.narrative.tension+r.tensionDelta,0,100),d=ur(e.campaign.mutators,r.mutator),l=bn(e,e.campaign.depth,d);return{...l,narrative:{...l.narrative,currentNodeId:r.nextNodeId,history:[...l.narrative.history,{nodeId:s.id,choiceId:r.id}],tension:i}}}function Gc(e,n){const s=e.skills.nodes.find(i=>i.id===n);return!s||!tc(e,n).allowed?e:{...e,skills:{...e.skills,points:e.skills.points-s.cost,nodes:e.skills.nodes.map(i=>i.id===n?{...i,unlocked:!0}:i)}}}function Bc(e,n){return ac(e,n).allowed?{...e,skills:{...e.skills,loadout:{...e.skills.loadout,equipped:[...e.skills.loadout.equipped,n]}}}:e}function tc(e,n){const s=e.skills.nodes.find(p=>p.id===n);if(!s)return{allowed:!1,reason:"Unknown skill node."};if(s.unlocked)return{allowed:!1,reason:"Skill already unlocked."};const r=new Set(e.skills.nodes.filter(p=>p.unlocked).map(p=>p.id)),i=s.requires.filter(p=>!r.has(p));if(i.length>0)return{allowed:!1,reason:`Requires: ${i.join(", ")}`};const d=mr(e);if(d.level<s.minLevel)return{allowed:!1,reason:`Requires level ${s.minLevel}`};const l=s.requiredMilestones.filter(p=>!d.milestones.includes(p));return l.length>0?{allowed:!1,reason:`Requires milestone ${l[0]}`}:e.skills.points<s.cost?{allowed:!1,reason:`Need ${s.cost} points`}:{allowed:!0,reason:"Unlock available"}}function ac(e,n){const s=e.skills.nodes.find(d=>d.id===n);if(!s)return{allowed:!1,reason:"Unknown skill node."};if(!s.unlocked)return{allowed:!1,reason:"Unlock required before equip."};if(e.skills.loadout.equipped.includes(n))return{allowed:!1,reason:"Already equipped."};if(e.skills.loadout.equipped.length>=e.skills.loadout.capacity)return{allowed:!1,reason:"Loadout capacity reached."};const r=e.skills.loadout.slotCaps[s.loadoutSlot];return e.skills.loadout.equipped.reduce((d,l)=>{const p=e.skills.nodes.find(u=>u.id===l);return(p==null?void 0:p.loadoutSlot)===s.loadoutSlot?d+1:d},0)>=r?{allowed:!1,reason:`${s.loadoutSlot} slot limit reached.`}:{allowed:!0,reason:"Equip available"}}function zc(e,n){const s=Sn(e),r={...e.pvp};n==="sabotage"?(r.sabotage=ie(r.sabotage+13,0,100),r.stability=ie(r.stability-11,0,100),r.fog=ie(r.fog+9,0,100)):n==="stabilize"?(r.stability=ie(r.stability+14,0,100),r.sabotage=ie(r.sabotage-8,0,100),r.fog=ie(r.fog-6,0,100)):(r.fog=ie(r.fog-16,0,100),r.stability=ie(r.stability+3,0,100),r.sabotage=ie(r.sabotage-4,0,100)),r.round+=1,r.stability<=0?r.winner="saboteur":r.sabotage<=0?r.winner="operator":r.round>=10&&(r.winner=r.stability>=r.sabotage?"operator":"saboteur");const i=r.winner==="operator"?{status:"win",reason:"Operator side prevailed in the sabotage conflict.",updatedAt:Date.now()}:r.winner==="saboteur"?{status:"loss",reason:"Saboteur pressure overwhelmed system stability.",updatedAt:Date.now()}:s,d={...e,pvp:r,outcome:i};return We(d,r.winner?72:12)}function Uc(e,n,s){const r=`fork-${e.time.forks.length+1}`,i={id:r,label:n.trim()||r,playheadMs:ie(s,0,36e5),history:[ie(s,0,36e5)]};return{...e,time:{...e.time,activeForkId:r,forks:[...e.time.forks,i]}}}function Hc(e,n){const s=e.time.activeForkId,r=e.time.forks.map(i=>{if(i.id!==s)return i;const d=ie(i.playheadMs-Math.abs(n),0,36e5);return{...i,playheadMs:d,history:[...i.history,d]}});return{...e,time:{...e.time,forks:r}}}function Wc(e,n){if(n==="primary")return e;const s=e.time.forks.find(d=>d.id===n),r=e.time.forks.find(d=>d.id==="primary");if(!s||!r)return e;const i={...r,playheadMs:s.playheadMs,history:[...r.history,s.playheadMs]};return{...e,time:{activeForkId:"primary",forks:[i,...e.time.forks.filter(d=>d.id!=="primary"&&d.id!==n)]}}}function Jc(e,n){const s=Sn(e),i={1:{exploit:42,strike:24,shield:8},2:{exploit:34,strike:28,shield:10},3:{exploit:26,strike:18,shield:14}}[e.boss.phase][n],d=e.boss.vulnerability===n?8:0,l=i+d,p=ie(e.boss.hp-l,0,e.boss.maxHp),u=p/e.boss.maxHp,f=u<=.33?3:u<=.66?2:1,b=f===1?"Phase 1: Shield lattice destabilization":f===2?"Phase 2: Mirror clones absorb exploit damage":"Phase 3: Enrage pulse; shield counters become lethal",y=f===1?"exploit":f===2?"strike":"shield",x={...e,boss:{...e.boss,hp:p,phase:f,enraged:f===3||p<=e.boss.maxHp*.2,phaseMechanic:b,vulnerability:y},outcome:p<=0?{status:"win",reason:"Boss encounter cleared. Run secured.",updatedAt:Date.now()}:s};return We(x,p<=0?180:10)}function Vc(e,n){const s=n.failures*12+n.retries*4+(n.latencyMs>1400?8:0),r=ie(e.director.risk+s,0,100),i=n.failures>0?"Prioritize failure triage and run a stabilizing replay branch.":n.latencyMs>1400?"Latency pressure detected. Reduce fan-out and tighten tool boundaries.":"Momentum is stable. Push a high-confidence optimization branch.",d=n.failures>1?"stability_patch":n.latencyMs>1400?"precision_lens":"overclock_core",l=n.failures>0?"failure":"success";return{...e,director:{risk:r,hint:i,recommendedModifier:d,lastOutcome:l}}}function Kc(e,n){const s=Yl[n];if(!s||e.economy.credits<s.credits||e.economy.materials<s.materials)return e;const r=e.economy.crafted.includes(n)?e.economy.crafted:[...e.economy.crafted,n],i=e.economy.reserveTarget||320,d=e.economy.credits-s.credits;let l={...e,economy:{...e.economy,credits:d,materials:e.economy.materials-s.materials,crafted:r,inflationIndex:Number((d/i).toFixed(3))}};return n==="stability_patch"&&(l={...l,pvp:{...l.pvp,stability:ie(l.pvp.stability+8,0,100)}}),n==="precision_lens"&&(l={...l,raid:{...l.raid,objectives:l.raid.objectives.map((p,u)=>u===0?{...p,progress:ie(p.progress+10,0,p.target),completed:ie(p.progress+10,0,p.target)>=p.target}:p)}}),n==="overclock_core"&&(l={...l,boss:{...l.boss,hp:ie(l.boss.hp-16,0,l.boss.maxHp)}}),We(l,10)}function Qc(e,n){const s=Math.round(n),r={...e,guild:{...e.guild,operationsScore:e.guild.operationsScore+s,eventsCompleted:e.guild.eventsCompleted+(s>0?1:0)}},i=s>0?Ht(r,s*3):r;return We(i,Math.max(0,s*6))}function Yc(e,n,s,r){const i={id:`event-${e.cinematic.queue.length+1}-${e.seed%1e3}`,type:n,message:s,intensity:r,at:Date.now()};return{...e,cinematic:{queue:[i,...e.cinematic.queue].slice(0,12)}}}function Xc(e){const n=jn(e),s=n.week+1,r=dr(e.seed,s),i=ie(n.difficultyFactor??1,.6,1.6),d=ie(n.rewardMultiplier??1,.5,2),l={...r,goal:Math.max(1,Math.round(r.goal*i)),rewardCredits:Math.max(1,Math.round(r.rewardCredits*d))},p={...e,liveops:{...n,week:s,challenge:l}};return sc(p)}function Zc(e,n){const s=jn(e),r=s.challenge,i=ie(n,0,20),d=ie(r.progress+i,0,r.goal),l=d>=r.goal,p={...e,liveops:{...s,challenge:{...r,progress:d,completed:l}}};return!l||r.completed?p:We(Ht(p,r.rewardCredits),80)}function nc(e,n,s="raid_mastery"){const r=pr(e),i=new Date().toISOString().slice(0,10);return n==="daily"?r.dailyClaimedOn===i?{allowed:!1,reason:"Daily reward already claimed today."}:{allowed:!0,reason:"Daily reward available."}:n==="session"?r.sessionClaimed?{allowed:!1,reason:"Session reward already claimed."}:e.raid.objectives.some(p=>p.progress>0)||e.campaign.depth>1||e.pvp.round>0?{allowed:!0,reason:"Session reward available."}:{allowed:!1,reason:"Session reward requires gameplay activity."}:n==="streak"?r.streakDays<3?{allowed:!1,reason:"Streak reward requires 3+ daily claims."}:r.streakClaimedFor>=r.streakDays?{allowed:!1,reason:"Streak reward already claimed for current streak."}:{allowed:!0,reason:"Streak reward available."}:r.masteryClaims.includes(s)?{allowed:!1,reason:"Mastery reward already claimed."}:(s==="raid_mastery"?e.raid.completed:s==="campaign_mastery"?e.campaign.depth>=4:e.boss.hp<=0)?{allowed:!0,reason:"Mastery reward available."}:{allowed:!1,reason:"Mastery requirement not met."}}function ed(e,n,s="raid_mastery"){if(!nc(e,n,s).allowed)return e;const i=pr(e),d=new Date().toISOString().slice(0,10);let l=i,p=0,u={};if(n==="daily"){const x=i.dailyClaimedOn===d?i.streakDays:i.streakDays+1;l={...i,dailyClaimedOn:d,streakDays:x},p=90+Math.min(7,x)*10,u={streakDays:x}}else n==="session"?(l={...i,sessionClaimed:!0},p=140,u={actions:e.pvp.round+e.narrative.history.length+e.campaign.depth}):n==="streak"?(l={...i,streakClaimedFor:i.streakDays},p=170+i.streakDays*5,u={streakDays:i.streakDays}):(l={...i,masteryClaims:[...i.masteryClaims,s]},p=s==="boss_mastery"?260:s==="campaign_mastery"?220:180,u={masteryId:s});const f=Ht({...e,rewards:l},p),b=Math.max(1,f.economy.credits-e.economy.credits),y={id:`reward-${l.history.length+1}-${e.seed%1e3}`,kind:n,amount:b,at:Date.now(),details:u};return We({...f,rewards:{...l,history:[y,...l.history].slice(0,60)}},30+Math.max(1,Math.round(b/10)))}function td(e,n){const s=jn(e),r=ie(n.difficultyFactor,.6,1.6),i=ie(n.rewardMultiplier,.5,2),d=s.difficultyFactor||1,l=s.rewardMultiplier||1,p=n.note.trim()||"Operator tuning update",u={...s.challenge,goal:Math.max(1,Math.round(s.challenge.goal/d*r)),rewardCredits:Math.max(1,Math.round(s.challenge.rewardCredits/l*i))},f={id:`tuning-${s.tuningHistory.length+1}-${e.seed%1e3}`,changedAt:Date.now(),difficultyFactor:r,rewardMultiplier:i,note:p};return{...e,liveops:{...s,challenge:u,difficultyFactor:r,rewardMultiplier:i,tuningHistory:[f,...s.tuningHistory].slice(0,20)}}}function Ht(e,n){if(n<=0)return e;const s=e.economy.reserveTarget||320,r=e.economy.credits;let i=1;if(r<=s){const b=Math.min(.12,(s-r)/s*.12);i=Math.min(1.12,1+b)}else{const b=(r-s)/s;i=Math.max(.45,1-b*.35)}const d=Math.max(1,Math.round(n*i)),l=Math.round(s*1.7),p=r+d,u=p>l?Math.max(1,Math.round((p-l)*.22)):0,f=p-u;return{...e,economy:{...e.economy,credits:f,inflationIndex:Number((f/s).toFixed(3))}}}function sc(e){const n=e.economy.reserveTarget||320;if(e.economy.credits<=n)return{...e,economy:{...e.economy,inflationIndex:Number((e.economy.credits/n).toFixed(3))}};const s=Math.max(6,Math.round((e.economy.credits-n)*.08)),r=Math.max(0,e.economy.credits-s);return{...e,economy:{...e.economy,credits:r,inflationIndex:Number((r/n).toFixed(3))}}}function jn(e){var n,s,r,i,d,l;return{season:((n=e.liveops)==null?void 0:n.season)??"Season-2026",week:((s=e.liveops)==null?void 0:s.week)??1,challenge:((r=e.liveops)==null?void 0:r.challenge)??{id:"fallback-liveops",title:"Complete one objective",goal:1,progress:0,rewardCredits:100,completed:!1},difficultyFactor:((i=e.liveops)==null?void 0:i.difficultyFactor)??1,rewardMultiplier:((d=e.liveops)==null?void 0:d.rewardMultiplier)??1,tuningHistory:((l=e.liveops)==null?void 0:l.tuningHistory)??[]}}function pr(e){return e.rewards??{dailyClaimedOn:null,streakDays:0,sessionClaimed:!1,streakClaimedFor:0,masteryClaims:[],history:[]}}function rc(e){return e.teamComms??{pings:[]}}function va(e){return e.trim().toLowerCase()}function kn(e){return e.safety??{mutedPlayerIds:[],blockedPlayerIds:[],reports:[]}}function ad(e,n,s,r="director"){const i=n,d=(s??"").trim(),l=d.length>0;if(l&&!e.raid.objectives.some(f=>f.id===d))return e;const p=rc(e),u={id:`ping-${p.pings.length+1}-${e.seed%1e3}`,fromPlayerId:va(r)||"director",intent:i,targetObjectiveId:l?d:null,createdAt:Date.now()};return{...e,teamComms:{pings:[u,...p.pings].slice(0,50)}}}function Sn(e){return e.outcome??{status:"in_progress",reason:"Run in progress.",updatedAt:Date.now()}}function ic(e){return e.sandbox??{enabled:!1}}function mr(e){return e.progression??{xp:0,level:1,nextLevelXp:200,milestones:[]}}function We(e,n){if(n<=0)return e;const s=mr(e);let r=s.xp+n,i=s.level,d=s.nextLevelXp,l=0;for(;r>=d;)r-=d,i+=1,l+=1,d=i*200;const p=[...s.milestones];return[3,5,10].forEach(u=>{const f=`milestone-level-${u}`;i>=u&&!p.includes(f)&&p.push(f)}),{...e,progression:{xp:r,level:i,nextLevelXp:d,milestones:p},skills:{...e.skills,points:e.skills.points+l}}}function nd(e,n,s){const r=va(n),i=s.trim();if(!r||!i)return e;const d=kn(e),l={id:`report-${d.reports.length+1}-${e.seed%1e3}`,targetPlayerId:r,reason:i,createdAt:Date.now()};return{...e,safety:{...d,reports:[l,...d.reports].slice(0,40)}}}function sd(e,n){const s=va(n),r=kn(e);return!s||r.mutedPlayerIds.includes(s)?e:{...e,safety:{...r,mutedPlayerIds:[...r.mutedPlayerIds,s]}}}function rd(e,n){const s=va(n),r=kn(e);return!s||r.blockedPlayerIds.includes(s)?e:{...e,safety:{...r,blockedPlayerIds:[...r.blockedPlayerIds,s],mutedPlayerIds:r.mutedPlayerIds.includes(s)?r.mutedPlayerIds:[...r.mutedPlayerIds,s]}}}const oc=new Set(["cinema","flow","compare","matrix","gameplay"]);function mn(e){if(!e)return;const n=e.trim();return n.length?n:void 0}function Ws(e){const n=new URLSearchParams(e),s=mn(n.get("mode")),r=mn(n.get("trace")),i=mn(n.get("step")),d={};return s&&oc.has(s)&&(d.mode=s),r&&(d.traceId=r),i&&(d.stepId=i),d}function lc(e,n){const s=new URL(e);return n.mode?s.searchParams.set("mode",n.mode):s.searchParams.delete("mode"),n.traceId?s.searchParams.set("trace",n.traceId):s.searchParams.delete("trace"),n.stepId?s.searchParams.set("step",n.stepId):s.searchParams.delete("step"),s.toString()}const gn={setupWizardV1:!0,supportPanelV1:!0,exportCenterV1:!0,ownershipPanelV1:!0},hr="agentDirector.analytics.events.v1",fr="agentDirector.featureFlags.v1",cc=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;function dc(e){const n=e.dataSource.trim(),s=e.importPath.trim(),i=e.inviteEmails.split(",").map(u=>u.trim()).filter(Boolean).filter(u=>!cc.test(u)),d=n?null:"Select a data source.",l=s?null:"Import path is required.",p=i.length?`Invalid invite email(s): ${i.join(", ")}`:null;return{dataSourceError:d,importPathError:l,inviteEmailsError:p,isValid:!d&&!l&&!p}}function uc(e,n){const s=n.updatedAt??Date.now(),r={...n,updatedAt:s},i=e.findIndex(l=>l.id===r.id);if(i===-1)return[r,...e].slice(0,12);const d=[...e];return d[i]={...d[i],...r},d.sort((l,p)=>p.updatedAt-l.updatedAt),d.slice(0,12)}function pc(e){try{const n=JSON.parse(e.getItem(hr)??"[]");return Array.isArray(n)?n.filter(s=>{if(!s||typeof s!="object")return!1;const r=s;return typeof r.name=="string"&&typeof r.at=="string"&&typeof r.metadata=="object"}).slice(-250):[]}catch{return[]}}function mc(e,n){const r=[...pc(e),n].slice(-250);return e.setItem(hr,JSON.stringify(r)),r}function hc(e){var n,s;return{capturedAt:new Date().toISOString(),app:"agent-director",mode:e.mode,traceId:((n=e.trace)==null?void 0:n.id)??null,traceStatus:((s=e.trace)==null?void 0:s.status)??null,stepCount:e.stepCount,selectedStepId:e.selectedStepId,workspaceId:e.workspaceId,workspaceRole:e.workspaceRole,safeExport:e.safeExport,userAgent:typeof navigator<"u"?navigator.userAgent:"unknown",online:typeof navigator<"u"?navigator.onLine:!0,recentNotifications:e.notifications.slice(-6),asyncActions:e.actions.slice(0,8)}}function fc(e){try{const n=JSON.parse(e.getItem(fr)??"{}");if(!n||typeof n!="object")return{...gn};const s=n;return{setupWizardV1:s.setupWizardV1!==!1,supportPanelV1:s.supportPanelV1!==!1,exportCenterV1:s.exportCenterV1!==!1,ownershipPanelV1:s.ownershipPanelV1!==!1}}catch{return{...gn}}}function yc(e,n){e.setItem(fr,JSON.stringify(n))}const Js=220,Vs=120,xn="agentDirector.presence.v1",bc=2e4,gc=5e3,wt="agentDirector.collab.cursors.v1",hn="agentDirector.collab.annotations.v1",fn="agentDirector.collab.activity.v1",xc=6e3,Ks=[{id:"personal",label:"Personal"},{id:"operations",label:"Operations"},{id:"executive",label:"Executive"}],vc=c.lazy(()=>zt(()=>import("./index-DmHykuq0.js"),__vite__mapDeps([0,1,2,3]))),wc=c.lazy(()=>zt(()=>import("./index-l3gohnbE.js"),__vite__mapDeps([4,1,2,3]))),jc=c.lazy(()=>zt(()=>import("./index-EnB6Kfxk.js"),__vite__mapDeps([5,1,2,3]))),kc=c.lazy(()=>zt(()=>import("./index-BRP7CN14.js"),__vite__mapDeps([6,1,2,3]))),Sc=c.lazy(()=>zt(()=>import("./index-CjFqSkU0.js"),__vite__mapDeps([7,1,2,3])));function ba(){return`scenario-${Math.random().toString(36).slice(2,9)}`}function Nc(e){return e.filter(n=>n.parentStepId).map(n=>({source:n.parentStepId,target:n.id}))}function Cc(e){const n=[...e].sort((s,r)=>s.index-r.index);return n.slice(1).map((s,r)=>({source:n[r].id,target:s.id}))}function Mc(e){const n={},s=e.getBoundingClientRect();return e.querySelectorAll(".step-card").forEach(i=>{const d=i.dataset.stepId;if(!d)return;const l=i.getBoundingClientRect();n[d]={left:l.left-s.left,top:l.top-s.top,width:l.width,height:l.height}}),n}function Ec(e,n,s){const r=[...Nc(e),...Cc(e),...zl(e).map(v=>({source:v.source,target:v.target}))],i=ql(e,r,s),d=n.getBoundingClientRect(),l=Math.min(...i.map(v=>v.position.x)),p=Math.min(...i.map(v=>v.position.y)),u=Math.max(...i.map(v=>v.position.x)),f=Math.max(...i.map(v=>v.position.y)),b=u-l+Js,y=f-p+Vs,x=Math.max(32,(d.width-b)/2),w=Math.max(24,(d.height-y)/2);return i.reduce((v,h)=>(v[h.id]={left:h.position.x-l+x,top:h.position.y-p+w,width:Js,height:Vs},v),{})}function Qs(e,n,s){const r=n.trim().toLowerCase();return e.filter(i=>{var l,p,u;return s!=="all"&&i.type!==s?!1:r?[i.name,(l=i.preview)==null?void 0:l.title,(p=i.preview)==null?void 0:p.outputPreview,(u=i.preview)==null?void 0:u.inputPreview].filter(Boolean).join(" ").toLowerCase().includes(r):!0})}function Ic(e,n,s){var f,b,y,x,w,v,h,k,S,$,X,E,_,H,F,B,V,re,j,I,R,W,N,K,D,q,P,me,Me;const r=e.profiles[n]??e.profiles[((f=e.players[0])==null?void 0:f.player_id)??""]??Object.values(e.profiles)[0],i=e.players.reduce((M,U)=>(M[U.player_id]=U.role,M),{}),d=Object.entries(e.narrative.nodes).map(([M,U])=>({id:M,title:U.title,body:U.title,choices:U.choices.map(fe=>({id:fe.id,label:fe.id,nextNodeId:fe.next,tensionDelta:fe.tension,mutator:fe.modifier}))})),l=e.pvp.winner??null,u=e.telemetry.failures>0?"failure":l?"success":"mixed";return{seed:e.seed,raid:{party:e.players.map(M=>M.player_id),roles:i,objectives:e.raid.objectives.map(M=>({id:M.id,label:M.label,progress:M.progress,target:M.target,completed:M.completed})),completed:e.raid.completed},campaign:{depth:e.campaign.depth,lives:e.campaign.lives,currentMission:{id:e.campaign.current_mission.id,title:e.campaign.current_mission.title,difficulty:e.campaign.current_mission.difficulty,hazards:e.campaign.current_mission.hazards,rewardCredits:e.campaign.current_mission.reward_tokens,missionSeed:e.campaign.current_mission.mission_seed??s.campaign.currentMission.missionSeed??e.seed,blueprint:e.campaign.current_mission.blueprint??s.campaign.currentMission.blueprint??`seed=${e.seed};depth=${e.campaign.depth}`},completedMissionIds:e.campaign.completed_missions,mutators:[...e.campaign.modifiers,...e.campaign.unlocked_modifiers]},narrative:{currentNodeId:e.narrative.current_node_id,nodes:d.length>0?d:s.narrative.nodes,history:e.narrative.history.map(M=>({nodeId:M.node_id,choiceId:M.choice_id})),tension:e.narrative.tension},skills:{points:(r==null?void 0:r.skill_points)??s.skills.points,nodes:s.skills.nodes.map(M=>({...M,unlocked:!!(r!=null&&r.unlocked_skills.includes(M.id))})),loadout:{capacity:(r==null?void 0:r.loadout_capacity)??s.skills.loadout.capacity,equipped:(r==null?void 0:r.loadout)??[],slotCaps:s.skills.loadout.slotCaps}},pvp:{round:e.pvp.round,stability:e.pvp.operator_stability,sabotage:e.pvp.sabotage_pressure,fog:e.pvp.fog,winner:l},time:{activeForkId:e.time.active_fork_id,forks:e.time.forks.map(M=>({id:M.id,label:M.label,playheadMs:M.playhead_ms,history:M.history}))},boss:{name:e.boss.name,phase:e.boss.phase,hp:e.boss.hp,maxHp:e.boss.max_hp,enraged:e.boss.enraged,phaseMechanic:e.boss.phase_mechanic??(e.boss.phase===1?"Phase 1: Shield lattice destabilization":e.boss.phase===2?"Phase 2: Mirror clones absorb exploit damage":"Phase 3: Enrage pulse; shield counters become lethal"),vulnerability:e.boss.vulnerability==="strike"||e.boss.vulnerability==="shield"||e.boss.vulnerability==="exploit"?e.boss.vulnerability:e.boss.phase===1?"exploit":e.boss.phase===2?"strike":"shield"},director:{risk:e.director.risk,hint:e.director.hint,recommendedModifier:e.director.hazard_bias,lastOutcome:u},economy:{credits:e.economy.tokens,materials:e.economy.materials,crafted:e.economy.crafted,reserveTarget:((b=e.economy.policy)==null?void 0:b.target_reserve)??s.economy.reserveTarget??320,inflationIndex:e.economy.inflation_index??Number((e.economy.tokens/(((y=e.economy.policy)==null?void 0:y.target_reserve)??s.economy.reserveTarget??320)).toFixed(3))},rewards:{dailyClaimedOn:((x=e.rewards)==null?void 0:x.daily_claimed_date)??((w=s.rewards)==null?void 0:w.dailyClaimedOn)??null,streakDays:((v=e.rewards)==null?void 0:v.streak_days)??((h=s.rewards)==null?void 0:h.streakDays)??0,sessionClaimed:((k=e.rewards)==null?void 0:k.session_claimed)??((S=s.rewards)==null?void 0:S.sessionClaimed)??!1,streakClaimedFor:(($=e.rewards)==null?void 0:$.streak_claimed_for)??((X=s.rewards)==null?void 0:X.streakClaimedFor)??0,masteryClaims:((E=e.rewards)==null?void 0:E.mastery_claims)??((_=s.rewards)==null?void 0:_.masteryClaims)??[],history:((F=(H=e.rewards)==null?void 0:H.history)==null?void 0:F.map(M=>({id:M.id,kind:M.kind==="daily"||M.kind==="session"||M.kind==="streak"||M.kind==="mastery"?M.kind:"daily",amount:M.amount,at:Date.parse(M.at)||Date.now(),details:M.details?Object.fromEntries(Object.entries(M.details).map(([U,fe])=>[U,String(fe)])):{}})))??((B=s.rewards)==null?void 0:B.history)??[]},guild:{name:e.guild.guild_id??"Trace Guild",members:e.players.length,operationsScore:e.guild.operations_score,eventsCompleted:e.guild.events_completed},cinematic:{queue:e.cinematic.events.map(M=>({id:M.id,type:M.type==="critical"||M.type==="success"||M.type==="warning"||M.type==="twist"?M.type:"warning",message:M.message,intensity:M.intensity||1,at:Date.parse(M.at)||Date.now()}))},liveops:{season:e.liveops.season,week:e.liveops.week,challenge:{id:e.liveops.challenge.id,title:e.liveops.challenge.title,goal:e.liveops.challenge.goal,progress:e.liveops.challenge.progress,rewardCredits:e.liveops.challenge.reward,completed:e.liveops.challenge.completed},difficultyFactor:e.liveops.telemetry.difficultyFactor??s.liveops.difficultyFactor??1,rewardMultiplier:e.liveops.telemetry.rewardMultiplier??s.liveops.rewardMultiplier??1,tuningHistory:((V=e.liveops.tuning_history)==null?void 0:V.map(M=>({id:M.id,changedAt:Date.parse(M.changed_at)||Date.now(),difficultyFactor:M.difficultyFactor,rewardMultiplier:M.rewardMultiplier,note:M.note})))??s.liveops.tuningHistory??[]},teamComms:{pings:((j=(re=e.team_comms)==null?void 0:re.pings)==null?void 0:j.map(M=>({id:M.id,fromPlayerId:M.from_player_id,intent:M.intent==="focus"||M.intent==="assist"||M.intent==="defend"||M.intent==="rotate"?M.intent:"focus",targetObjectiveId:M.target_objective_id??null,createdAt:Date.parse(M.created_at)||Date.now()})))??s.teamComms.pings??[]},safety:{mutedPlayerIds:((I=e.safety)==null?void 0:I.muted_player_ids)??s.safety.mutedPlayerIds??[],blockedPlayerIds:((R=e.safety)==null?void 0:R.blocked_player_ids)??s.safety.blockedPlayerIds??[],reports:((N=(W=e.safety)==null?void 0:W.reports)==null?void 0:N.map(M=>({id:M.id,targetPlayerId:M.target_player_id,reason:M.reason,createdAt:Date.parse(M.created_at)||Date.now()})))??s.safety.reports??[]},outcome:e.status==="completed"?{status:e.telemetry.successes>=e.telemetry.failures?"win":"loss",reason:e.telemetry.successes>=e.telemetry.failures?"Session completed with positive outcomes.":"Session completed with unresolved failures.",updatedAt:Date.now()}:e.telemetry.failures>0?{status:"partial",reason:`${e.telemetry.failures} failure signals observed; run still active.`,updatedAt:Date.now()}:s.outcome??{status:"in_progress",reason:"Run in progress.",updatedAt:Date.now()},sandbox:{enabled:((K=e.sandbox)==null?void 0:K.enabled)??((D=s.sandbox)==null?void 0:D.enabled)??!1},progression:{xp:(r==null?void 0:r.xp)??((q=s.progression)==null?void 0:q.xp)??0,level:(r==null?void 0:r.level)??((P=s.progression)==null?void 0:P.level)??1,nextLevelXp:((r==null?void 0:r.level)??((me=s.progression)==null?void 0:me.level)??1)*200,milestones:(r==null?void 0:r.milestones)??((Me=s.progression)==null?void 0:Me.milestones)??[]}}}function Tc(){const e=window.sessionStorage.getItem("agentDirector.sessionId");if(e)return e;const n=`session-${Math.random().toString(36).slice(2,10)}`;return window.sessionStorage.setItem("agentDirector.sessionId",n),n}function Ys(){try{const e=window.localStorage.getItem(xn);if(!e)return{};const n=JSON.parse(e),s={};return Object.entries(n).forEach(([r,i])=>{typeof i=="number"&&(s[r]=i)}),s}catch{return{}}}function Xs(e,n=Date.now()){return Object.fromEntries(Object.entries(e).filter(([,s])=>n-s<bc))}function Dc(){var ys,bs;const{trace:e,insights:n,loading:s,error:r,reload:i,traces:d,selectedTraceId:l,setSelectedTraceId:p}=Ll(),[u,f]=Y("agentDirector.mode","cinema"),[b,y]=Y("agentDirector.workspaceSection.v1","journey"),[x,w]=c.useState(""),v=c.useDeferredValue(x),[h,k]=c.useState("all"),[S,$]=c.useState(""),[X,E]=c.useState(null),[_,H]=c.useState(null),[F,B]=c.useState(null),[V,re]=c.useState([]),[j,I]=c.useState(""),[R,W]=c.useState(null),[N,K]=c.useState(!1),[D,q]=c.useState(null),[P,me]=Y("agentDirector.safeExport",!1),[Me,M]=Y("agentDirector.syncPlayback",!0),[U,fe]=c.useState(null),[ye,A]=c.useState(!1),[Q,je]=c.useState(0),[ct,Ae]=Y("agentDirector.speed",1),[Pe,$e]=Y("agentDirector.windowed",!1),[T,ee]=c.useState(2e4),[be,ke]=c.useState(!1),[kt,Le]=c.useState(!1),[St,Ee]=Y("agentDirector.overlayEnabled",!1),[yr,br]=Y("agentDirector.onboarded",!1),[,dt]=Y("agentDirector.tourCompleted",!1),[_e,Se]=Y("agentDirector.explainMode",!0),[wa,ja]=Y("agentDirector.heroDismissed",!1),[gr,ka]=Y("agentDirector.dockOpen",!1),[ge,xr]=Y("agentDirector.introPersona","builder"),[Sa,Na]=Y("agentDirector.launchPath","rapid_triage"),[Nt,Nn]=Y("agentDirector.themeMode","studio"),[Wt,Cn]=Y("agentDirector.motionMode","balanced"),[Ca,vr]=Y("agentDirector.workspaceId.v1",Ks[0].id),[Jt,wr]=Y("agentDirector.workspaceRole.v1","operator"),[Mn,En]=Y("agentDirector.sessionExpiresAt.v1",Date.now()+1e3*60*60*4),[pe,In]=Y("agentDirector.timelineLaneStrategy","type"),[Tn,ut]=Y("agentDirector.timelineStudioConfig",Gt),[Vt,xe]=Y("agentDirector.missions",{playback:!1,flow:!1,inspect:!1,matrix:!1,replay:!1,annotate:!1,collaborate:!1}),Kt=!1,[pt,Qt]=Y("agentDirector.introDismissed",Kt),[Ma,mt]=c.useState(!1),[Je,Ea]=c.useState("source"),[Ve,Ia]=Y("agentDirector.setupWizardDraft.v1",{dataSource:"",importPath:"",inviteEmails:""}),[Dn,An]=Y("agentDirector.setupWizardComplete.v1",!1),[$n,_n]=Y("agentDirector.setupWizardPrompted.v1",!1),[Ta,he]=c.useState(!1),[te,Yt]=c.useState(null),[Xt,Da]=c.useState([]),[Aa,$a]=c.useState(null),[jr,Rn]=c.useState(null),[_a,Ra]=c.useState(""),[Oa,tt]=c.useState([{id:ba(),name:"Prompt tighter",strategy:"hybrid",modificationsText:'{"prompt":"Return concise response"}'},{id:ba(),name:"Recorded baseline",strategy:"recorded",modificationsText:"{}"}]),[Ke,Pa]=c.useState(null),[Ne,On]=c.useState(null),[kr,Zt]=c.useState(!1),[ea,Ct]=c.useState(null),[ne,Mt]=Y("agentDirector.gameplayState.v1",Hs("bootstrap")),[de,Pn]=Y("agentDirector.gameplayTraceId.v1",""),[Ie]=Y("agentDirector.gameplayPlayerId.v1",`player-${Math.random().toString(36).slice(2,8)}`),[Ce,Qe]=Y("agentDirector.gameplaySessionId.v1",""),[ce,Re]=c.useState(null),[ta,Z]=c.useState(null),[Sr,ht]=c.useState(null),[Nr,aa]=c.useState(null),[Ln,Fn]=Y("agentDirector.gameplayLocale.v1","en"),[na,qn]=Y("agentDirector.gamepad.enabled.v1",!0),[La,Cr]=Y("agentDirector.gamepad.preset.v1","standard"),[sa,ra]=Y("agentDirector.shortcuts.bindings.v1",jo),[Mr,Gn]=c.useState(typeof navigator>"u"?!0:navigator.onLine),[Er,Bn]=c.useState(null),[Ir,zn]=c.useState(null),[Fa,Un]=c.useState(1),[ia,qa]=c.useState(null),[ft,Ga]=c.useState(null),[Et,Ba]=c.useState([]),[oa,Tr]=c.useState([]),[Hn,za]=c.useState([]),[Oe,la]=Y("agentDirector.savedViews.v1",[]),[at,Wn]=c.useState(""),[qe,ca]=c.useState(""),[Ua,It]=c.useState(!1),[Tt,Dr]=c.useState(""),[Dt,Ar]=Y("agentDirector.runOwner.v1","on-call-operator"),[At,$r]=Y("agentDirector.handoffOwner.v1",""),[ue,Jn]=c.useState(gn),[da,Ha]=c.useState(null),[$t,Wa]=c.useState(null),[Vn,Ja]=c.useState({}),[Kn,Va]=c.useState([]),[Ka,Qa]=c.useState([]),[_t,Ya]=c.useState(800),[_r,Rr]=c.useState(0),Xa=c.useRef(null),Qn=c.useRef(null),yt=c.useRef(Tc()),Yn=c.useRef(0),Xn=c.useRef(0),Za=c.useRef(!1),Zn=c.useRef({}),ua=c.useRef({}),es=c.useRef({}),ts=c.useRef({}),as=c.useRef({}),en=c.useRef({}),ns=c.useRef({}),Or=c.useRef(Ws(typeof window>"u"?"":window.location.search)),tn=c.useRef(!1),nt=c.useMemo(()=>yn(sa),[sa]),Ge=c.useMemo(()=>{if(!e)return[];const a=performance.now(),o=Qs(e.steps,v,h);return Xn.current=performance.now()-a,o},[e,v,h]),an=c.useMemo(()=>Ge.slice(0,Math.min(Ge.length,_t)),[_t,Ge]),ss=c.useMemo(()=>{if(!X)return an;const a=new Set(X.matchedStepIds);return an.filter(o=>a.has(o.id))},[an,X]),Pr=c.useMemo(()=>U?Qs(U.steps,v,h).slice(0,Math.min(U.steps.length,_t)):[],[U,v,h,_t]),rs=c.useMemo(()=>e?Ul(e.startedAt,e.endedAt,e.steps):[],[e]),Lr=c.useMemo(()=>!e||!U?null:sr(e,U),[e,U]),is=c.useMemo(()=>e?e.steps.find(a=>a.id===D)??null:null,[e,D]),Rt=c.useMemo(()=>e?io(e.steps,pe):[],[e,pe]),bt=c.useMemo(()=>{const a=Tn[pe]??Gt[pe];return ws(Rt,a.order,a.hidden)},[Rt,pe,Tn]),Fr=c.useMemo(()=>bt.order.filter(a=>!bt.hidden.includes(a)),[bt.hidden,bt.order]),pa=c.useMemo(()=>{const a=yt.current;return Object.values(Vn).filter(o=>o.sessionId!==a).filter(o=>o.traceId===((e==null?void 0:e.id)??"none")).sort((o,m)=>m.updatedAt-o.updatedAt)},[Vn,e==null?void 0:e.id]),qr=c.useMemo(()=>pa.map(a=>a.playheadMs),[pa]),Gr=c.useMemo(()=>Kn.filter(a=>a.traceId===(e==null?void 0:e.id)),[Kn,e==null?void 0:e.id]),os=c.useMemo(()=>{const a=Object.keys(Vt).length,o=Object.values(Vt).filter(Boolean).length;return{done:o,total:a,pct:a>0?Math.round(o/a*100):0}},[Vt]),Ot=c.useMemo(()=>{var O;if(!e)return 100;const a=100,o=Math.min(60,((n==null?void 0:n.errors)??0)*16),m=Math.min(24,((n==null?void 0:n.retries)??0)*6),g=e.metadata.wallTimeMs>6e4?12:e.metadata.wallTimeMs>3e4?6:0,C=(O=n==null?void 0:n.timing)!=null&&O.degraded?8:0;return Math.max(0,Math.min(100,Math.round(a-o-m-g-C)))},[n==null?void 0:n.errors,n==null?void 0:n.retries,(ys=n==null?void 0:n.timing)==null?void 0:ys.degraded,e]),Br=c.useMemo(()=>u==="flow"?"F / C / Space":u==="compare"?"C / Space / ← →":u==="matrix"?"G / C / Cmd+K":u==="gameplay"?"G / S / Cmd+K":"C / F / Space",[u]),st=c.useMemo(()=>{const a=Mn-Date.now(),o=Math.max(0,Math.ceil(a/6e4));return{expired:a<=0,remainingMinutes:o,label:a<=0?"Expired":`${o}m left`}},[Mn]),Be=c.useMemo(()=>dc(Ve),[Ve]),Pt=c.useMemo(()=>at.trim()?Oe.some(o=>o.name.toLowerCase()===at.trim().toLowerCase())?"Saved view name already exists.":null:"Saved view name is required.",[at,Oe]),ma=c.useMemo(()=>hc({trace:e,selectedStepId:D,mode:u,workspaceId:Ca,workspaceRole:Jt,safeExport:P,notifications:Et.map(a=>({message:a.message,level:a.level})),actions:oa,stepCount:(e==null?void 0:e.steps.length)??0}),[oa,u,Et,P,D,e,Ca,Jt]),ae=c.useCallback((a,o="info")=>{const m=a.trim();if(!m)return;const g=Date.now();Ba(C=>C.some(J=>J.message===m&&J.level===o)?C:[...C,{id:`notif-${g}-${Math.random().toString(36).slice(2,8)}`,message:m,level:o,expiresAt:g+xc}].slice(-6))},[]),z=c.useCallback((a,o={})=>{try{mc(window.localStorage,{name:a,at:new Date().toISOString(),metadata:o})}catch{}},[]),gt=c.useCallback(a=>{Tr(o=>uc(o,a))},[]),Lt=c.useCallback(async a=>{as.current[a.id]=()=>{Lt(a)},za(o=>{const m=o.find(C=>C.id===a.id),g={id:a.id,label:a.label,status:"running",detail:"Running",updatedAt:Date.now(),retryable:!1};return m?[g,...o.filter(C=>C.id!==a.id)].slice(0,8):[g,...o].slice(0,8)}),z("ux.export.queued",{taskId:a.id,label:a.label});try{a.run(),za(o=>o.map(m=>m.id===a.id?{...m,status:"success",detail:"Completed",updatedAt:Date.now(),retryable:!1}:m)),z("ux.export.completed",{taskId:a.id,label:a.label})}catch(o){const m=o instanceof Error?o.message:"Export failed";za(g=>g.map(C=>C.id===a.id?{...C,status:"error",detail:m,updatedAt:Date.now(),retryable:!0}:C)),ae(`Export failed: ${a.label}`,"error"),z("ux.export.failed",{taskId:a.id,label:a.label,detail:m})}},[ae,z]),Ye=c.useCallback((a,o,m)=>{const g=`confirm-${Math.random().toString(36).slice(2,9)}`;en.current[g]=m,Ha({id:g,title:a,message:o})},[]),ls=c.useCallback((a,o)=>{const m=`undo-${Math.random().toString(36).slice(2,9)}`;ns.current[m]=o,Wa({id:m,label:a})},[]),cs=Jt!=="viewer"&&!st.expired,se=c.useCallback(a=>cs?!0:(st.expired?ae(`Session expired. Renew session to ${a}.`,"warning"):ae(`Viewer role cannot ${a}. Switch role to operator or admin.`,"warning"),!1),[ae,cs,st.expired]),zr=c.useCallback(a=>{Ba(o=>o.filter(m=>m.id!==a))},[]),Ur=c.useCallback(()=>{En(Date.now()+1e3*60*60*4),ae("Session renewed for 4 hours.","success")},[ae,En]);c.useEffect(()=>{Jn(fc(window.localStorage))},[]),c.useEffect(()=>{ue.setupWizardV1&&window.localStorage.getItem("agentDirector.setupWizardAuto")==="1"&&(!pt||Dn||Ma||$n||(mt(!0),_n(!0),z("ux.setup.opened",{source:"auto"})))},[ue.setupWizardV1,pt,_n,Dn,Ma,$n,z]),c.useEffect(()=>{if(!$t)return;const a=window.setTimeout(()=>{Wa(null)},6e3);return()=>window.clearTimeout(a)},[$t]),c.useEffect(()=>{const a=m=>{z("ux.error.window",{message:m.message,filename:m.filename,line:m.lineno})},o=m=>{const g=m.reason instanceof Error?m.reason.message:String(m.reason??"unknown");z("ux.error.window",{kind:"unhandledrejection",reason:g})};return window.addEventListener("error",a),window.addEventListener("unhandledrejection",o),()=>{window.removeEventListener("error",a),window.removeEventListener("unhandledrejection",o)}},[z]),c.useEffect(()=>{if(tn.current)return;const a=Or.current;if(!a.mode&&!a.traceId&&!a.stepId){tn.current=!0;return}if(a.mode&&a.mode!==u&&f(a.mode),a.traceId){if(!d.some(m=>m.id===a.traceId))return;if(l!==a.traceId){p(a.traceId);return}}a.stepId&&(e!=null&&e.steps.some(o=>o.id===a.stepId))&&D!==a.stepId&&q(a.stepId),tn.current=!0},[u,D,l,f,p,e==null?void 0:e.steps,d]),c.useEffect(()=>{if(typeof window>"u")return;const a=lc(window.location.href,{mode:u,traceId:l??void 0,stepId:D??void 0});a!==window.location.href&&window.history.replaceState(null,"",a)},[u,D,l]),c.useEffect(()=>{if(!Et.length)return;const a=window.setInterval(()=>{const o=Date.now();Ba(m=>m.filter(g=>g.expiresAt>o))},1e3);return()=>{window.clearInterval(a)}},[Et.length]),c.useEffect(()=>{ia&&ae(ia,"success")},[ae,ia]),c.useEffect(()=>{kt&&z("ux.palette.opened",{section:b,mode:u})},[b,u,kt,z]),c.useEffect(()=>{ft&&ae(ft,"success")},[ae,ft]),c.useEffect(()=>{ea&&ae(ea,"error")},[ae,ea]),c.useEffect(()=>{_&&ae(_,"warning")},[ae,_]),c.useEffect(()=>{ta&&ae(ta,"warning")},[ae,ta]),c.useEffect(()=>{st.expired&&ae("Workspace session expired. Renew to continue write actions.","warning")},[ae,st.expired]),c.useEffect(()=>{e&&e.id!==de&&(Mt(Hs(e.id)),Pn(e.id))},[de,Mt,Pn,e]),c.useEffect(()=>{let a=!1;if(!Ce){Re(null);return}return pn().then(o=>{a||(Re(o),o||Z("Gameplay session not found."))}),()=>{a=!0}},[Ce]),c.useEffect(()=>{if(!Ce)return;const a=Pl();return()=>a()},[Ce]),c.useEffect(()=>{ce&&Mt(a=>Ic(ce,Ie,a))},[Ie,ce,Mt]),c.useEffect(()=>{let a=!1;if(!(ce==null?void 0:ce.guild.guild_id)){ht(null);return}return $l().then(m=>{a||ht(m)}),()=>{a=!0}},[ce==null?void 0:ce.guild.guild_id]),c.useEffect(()=>{let a=!1;return Ps().then(o=>{a||o&&aa(o)}),()=>{a=!0}},[Ie,ce==null?void 0:ce.id]),c.useEffect(()=>{if(typeof window>"u")return;const a=()=>Gn(!0),o=()=>Gn(!1);return window.addEventListener("online",a),window.addEventListener("offline",o),()=>{window.removeEventListener("online",a),window.removeEventListener("offline",o)}},[]),c.useEffect(()=>{if(!na){ua.current={};return}if(typeof navigator>"u"||typeof navigator.getGamepads!="function")return;const a=La==="lefty"?{playPause:1,palette:3,modeCycle:2,speedDown:6,speedUp:7}:{playPause:0,palette:2,modeCycle:3,speedDown:4,speedUp:5},o=["cinema","flow","compare","matrix","gameplay"];let m=0;const g=(O,J,L)=>{const le=!!ua.current[J];O&&!le&&L(),ua.current[J]=O},C=()=>{var J,L,le,we,gs;const O=navigator.getGamepads()[0];O&&(g(!!((J=O.buttons[a.playPause])!=null&&J.pressed),"playPause",()=>A(ot=>!ot)),g(!!((L=O.buttons[a.palette])!=null&&L.pressed),"palette",()=>Le(!0)),g(!!((le=O.buttons[a.modeCycle])!=null&&le.pressed),"modeCycle",()=>{f(ot=>{const Fi=o.indexOf(ot);return o[(Fi+1)%o.length]})}),g(!!((we=O.buttons[a.speedDown])!=null&&we.pressed),"speedDown",()=>{Ae(ot=>Math.max(.25,Number((ot-.25).toFixed(2))))}),g(!!((gs=O.buttons[a.speedUp])!=null&&gs.pressed),"speedUp",()=>{Ae(ot=>Math.min(3,Number((ot+.25).toFixed(2))))})),m=window.requestAnimationFrame(C)};return m=window.requestAnimationFrame(C),()=>{window.cancelAnimationFrame(m),ua.current={}}},[na,La,f,Ae]),c.useEffect(()=>{let a=!1;const o=async()=>{const[g,C]=await Promise.all([Ls(),Fs()]);a||(g&&Bn(g),C&&zn(C))};o();const m=window.setInterval(()=>{o()},3e4);return()=>{a=!0,window.clearInterval(m)}},[]),c.useEffect(()=>{E(null),H(null)},[e==null?void 0:e.id]),c.useEffect(()=>{const a=Math.round(Xn.current);Rr(a),a>0&&z("ux.perf.filter_ms",{ms:a,steps:Ge.length})},[Ge,z]),c.useEffect(()=>{if(!e)return;const a=Ge.length;if(a<=1200){Ya(a);return}Ya(800);const o=window.setInterval(()=>{Ya(m=>m>=a?(window.clearInterval(o),a):Math.min(a,m+1e3))},70);return()=>window.clearInterval(o)},[Ge.length,e]),c.useEffect(()=>{let a=!1;if(!(e!=null&&e.id)){B(null);return}return bl(e.id).then(o=>{a||B(o)}),()=>{a=!0}},[e==null?void 0:e.id]),c.useEffect(()=>{let a=!1;return gl().then(o=>{a||(re(o),!j&&o.length>0&&I(o[0].id))}),()=>{a=!0}},[j]),c.useEffect(()=>{Qn.current=U},[U]),c.useEffect(()=>(document.body.dataset.theme=Nt,()=>{delete document.body.dataset.theme}),[Nt]),c.useEffect(()=>(document.body.dataset.motion=Wt,()=>{delete document.body.dataset.motion}),[Wt]),c.useEffect(()=>{const a=yt.current,o=(L=!1)=>{const le=Date.now(),we=Xs(Ys(),le);L?delete we[a]:we[a]=le,window.localStorage.setItem(xn,JSON.stringify(we)),Un(Math.max(1,Object.keys(we).length))},m=()=>{const L=Xs(Ys(),Date.now());Un(Math.max(1,Object.keys(L).length))};o();const g=window.setInterval(()=>o(),gc),C=L=>{L.key===xn&&m()},O=()=>{document.visibilityState==="visible"&&o()},J=()=>o(!0);return window.addEventListener("storage",C),document.addEventListener("visibilitychange",O),window.addEventListener("beforeunload",J),()=>{window.clearInterval(g),o(!0),window.removeEventListener("storage",C),document.removeEventListener("visibilitychange",O),window.removeEventListener("beforeunload",J)}},[]),c.useEffect(()=>{u==="compare"&&ka(!1)},[u,ka]),c.useEffect(()=>{Rt.length!==0&&ut(a=>{const o=a[pe]??Gt[pe],m=ws(Rt,o.order,o.hidden);return m.order.join("|")===o.order.join("|")&&m.hidden.join("|")===o.hidden.join("|")?a:{...a,[pe]:m}})},[Rt,pe,ut]),c.useEffect(()=>{Ja(et(window.localStorage.getItem(wt),{})),Va(et(window.localStorage.getItem(hn),[])),Qa(et(window.localStorage.getItem(fn),[]))},[]),c.useEffect(()=>{const a=Date.now();if(a-Yn.current<120&&ye)return;Yn.current=a;const o=yt.current,m={sessionId:o,traceId:(e==null?void 0:e.id)??"none",mode:u,playheadMs:Math.round(Q),selectedStepId:D,updatedAt:a},C={...et(window.localStorage.getItem(wt),{}),[o]:m};window.localStorage.setItem(wt,JSON.stringify(C)),Ja(C)},[ye,u,Q,D,e==null?void 0:e.id]),c.useEffect(()=>{const a=yt.current;return()=>{const o=et(window.localStorage.getItem(wt),{});if(!o[a])return;const m={...o};delete m[a],window.localStorage.setItem(wt,JSON.stringify(m))}},[]),c.useEffect(()=>{const a=o=>{if(o.key===wt&&Ja(et(o.newValue,{})),o.key===hn){const m=et(o.newValue,[]);Va(g=>Bs(g,m))}o.key===fn&&Qa(zs(et(o.newValue,[])))};return window.addEventListener("storage",a),()=>window.removeEventListener("storage",a)},[]);const G=c.useCallback(a=>{const o={id:`activity-${Math.random().toString(36).slice(2,9)}`,sessionId:yt.current,message:a,timestamp:Date.now()};Qa(m=>{const g=zs([o,...m]);return window.localStorage.setItem(fn,JSON.stringify(g)),g})},[]),ve=c.useCallback((a,o,m)=>{Zn.current[a]||(Zn.current[a]=!0,Bl(o,m))},[]),Xe=c.useCallback(async function(o){o.retry&&(es.current[o.id]=o.retry),o.resume&&(ts.current[o.id]=o.resume),gt({id:o.id,label:o.label,status:"running",detail:"Running",retryable:!1,resumable:!1});try{const m=await o.run();return gt({id:o.id,label:o.label,status:"success",detail:o.successDetail??"Completed",retryable:!1,resumable:!1}),m}catch(m){const g=m instanceof Error?m.message:"Action failed";throw gt({id:o.id,label:o.label,status:"error",detail:g,retryable:!!o.retry,resumable:!!o.resume}),m}},[gt]),Hr=c.useCallback(a=>{const o=es.current[a];o&&(z("ux.action.retry",{id:a}),o())},[z]),Wr=c.useCallback(a=>{const o=ts.current[a];o&&(z("ux.action.resume",{id:a}),o())},[z]),ze=c.useCallback(async a=>{if(!e||!se("run replay"))return;const o=await vl(e.id,a,"hybrid",{note:"UI replay"},e);o&&(fe(o),Ee(!0),f("flow"),xe(m=>m.replay?m:{...m,replay:!0}),G(`Created replay from ${a}`))},[G,se,xe,e,fe,f,Ee]),Jr=c.useCallback(async()=>{if(e){if(!S.trim()){E(null),H(null);return}try{const a=await Xe({id:"trace-query",label:"TraceQL query",run:async()=>yl(e.id,S.trim()),successDetail:"Query complete"});if(!a){H("TraceQL query failed"),E(null);return}E(a),H(null);const o=a.matchedStepIds[0];o&&(q(o),u!=="cinema"&&f("cinema"))}catch{H("TraceQL query failed"),E(null)}}},[Xe,u,f,e,S]),Vr=c.useCallback(async()=>{if(!(!e||!j)){K(!0);try{const a=await Xe({id:"run-extension",label:"Run extension",run:async()=>xl(j,e.id),successDetail:"Extension output ready"});if(!a)return;W(a.result)}finally{K(!1)}}},[Xe,j,e]),De=c.useCallback(()=>{if(!e)return;const a=[...e.steps].sort((o,m)=>(m.durationMs??0)-(o.durationMs??0))[0];a&&(q(a.id),f("cinema"))},[e,f]),ds=c.useCallback(()=>{if(!e||e.steps.length===0)return null;const a=[...e.steps].sort((o,m)=>(m.durationMs??0)-(o.durationMs??0))[0];return(a==null?void 0:a.id)??null},[e]),rt=c.useCallback(()=>{if(!e)return;const a=e.steps.find(o=>o.status==="failed");a&&(q(a.id),f("cinema"))},[e,f]),ha=c.useCallback(async()=>{if(!e)return;const a=new URL(window.location.href);a.searchParams.set("trace",l??e.id),a.searchParams.set("mode",u),D?a.searchParams.set("step",D):a.searchParams.delete("step");try{await navigator.clipboard.writeText(a.toString()),qa("Live link copied")}catch{window.prompt("Copy live session link",a.toString()),qa("Live link ready")}window.setTimeout(()=>qa(null),1800)},[u,D,l,e]),Kr=c.useCallback(a=>{In(a),G(`Switched lane strategy to ${a}`)},[G,In]),Qr=c.useCallback(a=>{ut(o=>{const m=o[pe]??Gt[pe],g=m.hidden.includes(a)?m.hidden.filter(C=>C!==a):[...m.hidden,a];return{...o,[pe]:{...m,hidden:g}}}),G(`Toggled lane visibility for ${a}`)},[G,pe,ut]),Yr=c.useCallback(async a=>{if(!e||!se("create gameplay sessions"))return;const o=await Nl({traceId:e.id,name:a.trim()||"Night Ops"});if(!o){Z("Failed to create gameplay session.");return}Re(o),Qe(o.id),Z(null),G(`Created gameplay session ${o.id}`)},[G,Ie,se,Qe,e]),Xr=c.useCallback(async()=>{if(!e||!se("matchmake gameplay sessions"))return;const a=await Cl({traceId:e.id});if(!a){Z("Failed to matchmake gameplay session.");return}Re(a.session),Qe(a.session.id),Z(null),G(`${a.match.type==="created"?"Created":"Matched"} gameplay session ${a.session.id} as ${a.match.assigned_role}`)},[G,Ie,se,Qe,e]),Zr=c.useCallback(async(a,o,m)=>{if(!se("join gameplay sessions"))return;if(!a.trim()){Z("Session id is required.");return}const g=await Ml({sessionId:a.trim(),playerId:o.trim()});if(!g){Z("Failed to join gameplay session.");return}Re(g),Qe(g.id),Z(null),G(`Joined gameplay session ${g.id} as ${o}`)},[G,se,Qe]),ei=c.useCallback(async()=>{Ce&&se("leave gameplay sessions")&&Ye("Leave gameplay session",`Leave session ${Ce}?`,()=>{(async()=>{if(!await El()){Z("Failed to leave gameplay session.");return}Re(null),Qe(""),Z(null),G(`Left gameplay session ${Ce}`),z("ux.action.confirmed",{action:"leave_gameplay_session",sessionId:Ce})})()})},[G,Ie,Ce,Ye,se,Qe,z]),ti=c.useCallback(async()=>{if(!Ce)return;const a=await Il();if(!a){Z("Failed to reconnect gameplay session.");return}Re(a),Z(null),G(`Reconnected gameplay session ${Ce}`)},[G,Ie,Ce]),ai=c.useCallback(async(a,o)=>{if(!(ce!=null&&ce.id)||!se(`run gameplay action ${a}`))return;const m=await Os({sessionId:ce.id,expectedVersion:ce.version});if(m.session){Re(m.session),Z(null),G(`Gameplay action: ${a}`);return}if(m.conflict){const g=await pn(ce.id);g&&Re(g),Z("Session changed by another player. Synced latest state.");return}Z(m.error??"Gameplay action failed.")},[G,Ie,ce,se]),ni=c.useCallback(async(a,o)=>{if(!se("create guilds"))return;if(!a.trim()||!o.trim()){Z("Guild id and name are required.");return}const m=await Al({guildId:a.trim(),name:o.trim()});if(!m){Z("Failed to create guild.");return}if(ht(m),ce){const g=await Os({sessionId:ce.id,payload:{guild_id:m.id},expectedVersion:ce.version});g.session&&Re(g.session)}Z(null),G(`Created guild ${m.id}`)},[G,Ie,ce,se]),si=c.useCallback(async(a,o)=>{if(!se("join guilds"))return;if(!a.trim()||!o.trim()){Z("Guild id and player id are required.");return}const m=await _l(a.trim(),o.trim());if(!m){Z("Failed to join guild.");return}ht(m),Z(null),G(`Joined guild ${m.id} as ${o}`)},[G,se]),ri=c.useCallback(async(a,o,m)=>{if(!se("schedule guild events"))return;if(!a.trim()||!o.trim()||!m.trim()){Z("Guild id, title, and schedule are required.");return}const g=await Rl({guildId:a.trim(),title:o.trim(),scheduledAt:m.trim()});if(!g){Z("Failed to schedule guild event.");return}ht(g.guild),Z(null),G(`Scheduled guild event ${g.event.id}`)},[G,se]),ii=c.useCallback(async(a,o,m)=>{if(!se("complete guild events"))return;const g=await Ol();if(!g){Z("Failed to complete guild event.");return}ht(g),Z(null),G(`Completed guild event ${o}`)},[G,se]),oi=c.useCallback(async a=>{if(!se("send friend invites"))return;const o=await Tl({toPlayerId:a.trim().toLowerCase()});if(!o){Z("Failed to send friend invite.");return}aa(o.social),Z(null),G(`Sent friend invite to ${a}`)},[G,Ie,se]),li=c.useCallback(async a=>{if(!se("accept friend invites"))return;const o=await Dl();if(!o){Z("Failed to accept friend invite.");return}aa(o),Z(null),G(`Accepted friend invite ${a}`)},[G,Ie,se]),us=c.useCallback(()=>{Xe({id:"retry-connectivity",label:"Retry connectivity",retry:()=>us(),run:async()=>{if(Z(null),i(),Ce){const g=await pn();g&&Re(g)}const[a,o,m]=await Promise.all([Ps(),Ls(),Fs()]);return a&&aa(a),o&&Bn(o),m&&zn(m),G("Retried connectivity sync"),!0},successDetail:"Connectivity synced"}).catch(()=>{Z("Retry connectivity failed.")})},[G,Xe,Ie,Ce,i]),ci=c.useCallback((a,o)=>{ut(m=>{const g=m[pe]??Gt[pe],C=[...g.order],O=C.indexOf(a);if(O===-1)return m;const J=o==="up"?O-1:O+1;if(J<0||J>=C.length)return m;const[L]=C.splice(O,1);return C.splice(J,0,L),{...m,[pe]:{...g,order:C}}}),G(`Moved lane group ${a} ${o}`)},[G,pe,ut]),di=c.useCallback(()=>{xe({playback:!1,flow:!1,inspect:!1,matrix:!1,replay:!1,annotate:!1,collaborate:!1}),G("Reset onboarding missions")},[G,xe]),ui=c.useCallback((a,o)=>{if(!e||!a.trim())return;const m=Date.now(),g={id:`annotation-${Math.random().toString(36).slice(2,9)}`,traceId:e.id,stepId:o,body:a.trim(),authorSessionId:yt.current,createdAt:m,updatedAt:m};Va(C=>{const O=Bs(C,[g]);return window.localStorage.setItem(hn,JSON.stringify(O)),O}),xe(C=>C.annotate?C:{...C,annotate:!0}),G(o?`Added annotation on step ${o}`:"Added trace annotation")},[G,xe,e]),pi=c.useCallback((a,o)=>{tt(m=>m.map(g=>g.id===a?{...g,...o}:g))},[]),mi=c.useCallback(a=>{tt(a)},[]),hi=c.useCallback(()=>{tt(a=>[...a,{id:ba(),name:`Scenario ${a.length+1}`,strategy:"hybrid",modificationsText:"{}"}])},[]),fi=c.useCallback(a=>{Oa.length<=1||Ye("Remove scenario","Remove this scenario from the matrix run?",()=>{let o=null,m=-1;tt(g=>(m=g.findIndex(C=>C.id===a),m===-1||g.length<=1?g:(o=g[m]??null,g.filter(C=>C.id!==a)))),!(!o||m===-1)&&(ls("Scenario removed",()=>{tt(g=>{const C=[...g];return C.splice(Math.min(m,C.length),0,o),C}),z("ux.action.undone",{action:"matrix_scenario_remove",scenarioId:a})}),z("ux.action.confirmed",{action:"matrix_scenario_remove",scenarioId:a}))})},[Oa.length,ls,Ye,z]),yi=c.useCallback(a=>{tt(o=>{const m=o.findIndex(J=>J.id===a);if(m===-1)return o;const g=o[m],C={...g,id:ba(),name:`${g.name} copy`},O=[...o];return O.splice(m+1,0,C),O})},[]),bi=c.useCallback((a,o)=>{tt(m=>{const g=m.findIndex(L=>L.id===a);if(g===-1)return m;const C=o==="up"?g-1:g+1;if(C<0||C>=m.length)return m;const O=[...m],[J]=O.splice(g,1);return O.splice(C,0,J),O})},[]),nn=c.useCallback(async a=>{var m;if(!e||!se("run replay matrix"))return;const o=_a||D||((m=e.steps[0])==null?void 0:m.id);if(!o){Ct("Select an anchor step before running the matrix.");return}try{Zt(!0),Ct(null),await Xe({id:"matrix-run",label:"Replay matrix run",retry:()=>{nn(a)},resume:()=>{nn(a)},run:async()=>{const g=await wl({traceId:e.id,stepId:o,scenarios:a});if(!g)throw new Error("Failed to create replay job.");Pa(g);let C=g;for(let J=0;J<30&&!(C.status!=="queued"&&C.status!=="running");J+=1){const L=Kl(J);await new Promise(we=>window.setTimeout(we,L));const le=await jl(g.id);if(!le)break;C=le,Pa(le)}const O=await Rs(g.id);if(!O)throw new Error("Replay job finished but matrix summary is unavailable.");return On(O),f("matrix"),G(`Ran matrix with ${a.length} scenario(s) from ${o}`),O},successDetail:`${a.length} scenario(s) complete`})}catch(g){Ct(g instanceof Error?g.message:"Failed to run replay matrix.")}finally{Zt(!1)}},[G,Xe,_a,se,D,e,f]),gi=c.useCallback(async()=>{Ke&&se("cancel replay matrix jobs")&&Ye("Cancel matrix job",`Cancel replay job ${Ke.id}?`,()=>{(async()=>{Zt(!0);try{const a=await kl(Ke.id);if(!a){Ct("Failed to cancel replay job.");return}Pa(a),gt({id:"matrix-run",label:"Replay matrix run",status:"canceled",detail:`Canceled ${Ke.id}`,resumable:!0,retryable:!0});const o=await Rs(a.id);o&&On(o),G(`Canceled matrix job ${Ke.id}`),z("ux.action.cancel",{id:Ke.id})}finally{Zt(!1)}})()})},[G,Ke,Ye,se,gt,z]),xi=c.useCallback(async a=>{const o=await rr();if(!(o!=null&&o.trace)){Ct("Could not load replay trace for compare view.");return}fe(o.trace),Ee(!0),f("compare"),G(`Opened matrix compare trace ${a}`)},[G,f,Ee]),oe=c.useCallback(a=>{if(!(a===u||!e)){if((a==="flow"||a==="matrix"||a==="gameplay")&&A(!1),a==="flow"&&u==="cinema"&&Xa.current){const o=Xa.current,m=Mc(o),g=Ec(e.steps,o,e.id);Rn({steps:e.steps,fromRects:m,toRects:g}),G("Morphed cinema to flow");return}f(a),G(`Switched mode to ${a}`)}},[G,u,e,A,f]),Ft=c.useCallback(async a=>{if(Na(a),a==="rapid_triage"){Se(!0),oe("cinema"),rt(),e!=null&&e.steps.some(o=>o.status==="failed")||De(),G("Started rapid triage launch path");return}if(a==="deep_diagnosis"){Se(!0),oe("flow"),he(!0),G("Started deep diagnosis launch path");return}M(!0),oe("matrix"),await ha(),G("Started team sync launch path")},[G,oe,De,rt,Se,Na,M,ha,e]),sn=c.useCallback(()=>{u==="flow"&&oe("cinema"),A(a=>!a)},[u,oe]),Ze=c.useCallback(()=>{Yt(null),Da([]),$a(null),A(!1)},[A]),ps=c.useCallback(a=>[{id:"setup",label:"Opening the reel",duration:1100,action:()=>{Se(!0),A(!1),je(0),q(null),Ee(!1),Ae(1),e&&e.steps.length<500&&$e(!1),oe("cinema")}},{id:"pace",label:"Pacing the timeline",duration:2200,action:()=>{oe("cinema"),A(!0),Ae(1.1)}},{id:"bottleneck",label:"Freeze on the bottleneck",duration:1600,action:()=>{A(!1),De()}},{id:"inspect",label:"Inspect the moment",duration:1600,action:()=>{a&&q(a)}},{id:"flow",label:"Morph into flow",duration:2100,action:()=>{oe("flow")}},{id:"replay",label:"Director’s Cut replay",duration:2200,action:async()=>{if(!e)return;!Qn.current&&a&&await ze(a),Ee(!0),f("compare")}},{id:"compare",label:"Compare the cut",duration:2e3,action:()=>{A(!0),Ae(1)}},{id:"finale",label:"Final frame",duration:1100,action:()=>{A(!1)}}],[oe,ze,De,Se,A,f,Ee,je,q,Ae,$e,e]),xt=c.useCallback(()=>{var o;if(!e)return;const a=D??ds()??((o=e.steps[0])==null?void 0:o.id)??null;Da(ps(a)),Yt({active:!0,step:0}),$a(e.id),he(!1),ke(!1),Le(!1)},[ps,ds,D,e,Le,ke,Da,Yt,$a,he]),vt=c.useCallback(()=>{if(te!=null&&te.active){Ze();return}xt()},[xt,Ze,te==null?void 0:te.active]),vi=c.useMemo(()=>{const o=[{id:"header",title:"Mission control",body:`Confirm run status and metadata. ${{builder:"Focus on payload flow, tool-call sequencing, and replay-ready steps.",executive:"Focus on bottlenecks, risk signals, and run-level outcome changes.",operator:"Focus on failure patterns, retries, and runtime reliability posture."}[ge]}`,target:'[data-tour="header"]',placement:"bottom"}];return wa||o.push({id:"hero",title:"Director briefing",body:"Choose Tour, Story mode, or Explain to ramp up quickly.",target:'[data-tour="hero"]',placement:"bottom"}),o.push({id:"insights",title:"Fast diagnosis",body:ge==="executive"?"Jump straight to bottlenecks and high-cost segments for fast executive readouts.":ge==="operator"?"Jump to failures and retries first, then inspect impacted steps.":"Jump straight to bottlenecks, errors, and high-cost steps with one click.",target:'[data-tour="insights"]',placement:"bottom"},{id:"journey",title:"Director journey",body:"A narrative path that teaches how to watch, inspect, and direct a better run.",target:'[data-tour="journey"]',placement:"bottom"},{id:"toolbar",title:"Filters + modes",body:"Search, filter, and switch between Cinema, Flow, and Compare as the story evolves.",target:'[data-tour="toolbar"]',placement:"bottom"},{id:"quick-actions",title:"Quick actions",body:"Launch Story Mode, open the command palette, or jump to bottlenecks instantly.",target:'[data-tour="quick-actions"]',placement:"left"},{id:"stage",title:"Cinema stage",body:"The timeline shows every step as a scene. Scrub to see pacing and concurrency.",target:'[data-tour="stage"]',placement:"top"},{id:"inspector",title:"Inspector",body:ge==="executive"?"Open key moments to validate outcome impact and communication-ready summaries.":"Open any step to read payloads, apply redaction, and replay from that moment.",target:'[data-tour="inspector"]',placement:"left"},{id:"compare",title:"Compare runs",body:U?"Compare is live. Review deltas in cost, steps, and wall time side by side.":"Replay from a step to unlock compare mode and validate improvements.",target:'[data-tour="compare"]',placement:"top"}),o},[U,wa,ge]),wi=c.useCallback(()=>{Rn(null),f("flow")},[f]),Fe=c.useMemo(()=>{var g,C,O,J;if(!e)return[];const a=[],o=[...e.steps].sort((L,le)=>(le.durationMs??0)-(L.durationMs??0))[0],m=e.steps.find(L=>L.status==="failed");if(m&&D!==m.id&&a.push({id:"jump-error",title:"Investigate first failure",body:`${m.name} failed and should be inspected before optimization work.`,actionLabel:"Open failed step",tone:"warning",action:rt}),o&&D!==o.id&&a.push({id:"jump-bottleneck",title:"Tackle latency bottleneck",body:`${o.name} is the slowest scene in this run and the best optimization target.`,actionLabel:"Open bottleneck",tone:"priority",action:De}),(g=F==null?void 0:F.hypotheses)!=null&&g[0]){const L=F.hypotheses[0];a.push({id:"investigate-hypothesis",title:L.title,body:L.summary,actionLabel:"Inspect evidence",tone:"info",action:()=>{const le=L.evidenceStepIds[0];le&&(q(le),u!=="cinema"&&f("cinema"))}})}if(u!=="matrix"&&a.push({id:"matrix-experiment",title:"Run scenario matrix",body:"Compare prompt and strategy alternatives from one anchor step to rank causal impact.",actionLabel:"Open matrix",tone:"info",action:()=>{var L;Ra(D??((L=e.steps[0])==null?void 0:L.id)??""),f("matrix")}}),!U&&(D||(C=e.steps[0])!=null&&C.id)){const L=D??((O=e.steps[0])==null?void 0:O.id)??null;L&&a.push({id:"run-replay",title:"Create director replay",body:"Branch a replay trace and validate whether your change improves the run.",actionLabel:"Replay from step",tone:"info",action:()=>{ze(L)}})}if((J=Ne==null?void 0:Ne.causalRanking)!=null&&J.length){const L=Ne.causalRanking[0];a.push({id:"causal-factor",title:`Top causal factor: ${L.factor}`,body:`Confidence ${(L.confidence*100).toFixed(0)}% across ${L.evidence.samples} sample(s).`,actionLabel:"View matrix",tone:"priority",action:()=>f("matrix")})}return a.slice(0,4)},[U,ze,F,De,rt,u,Ne,D,e,f]),ji=c.useMemo(()=>Fe.map((a,o)=>{const m=a.tone==="warning"?"high":a.tone==="priority"?"medium":"low";return{id:`priority-${a.id}`,title:a.title,detail:a.body,severity:m,actionLabel:a.actionLabel,onAction:a.action,done:o===0?a.id==="jump-error"&&!!D||a.id==="jump-bottleneck"&&!!D:!1}}),[Fe,D]),it=c.useMemo(()=>{var O,J;if(!e)return"No trace loaded.";const a=[...e.steps].sort((L,le)=>(le.durationMs??0)-(L.durationMs??0))[0],o=e.steps.filter(L=>L.status==="failed").length,m=(O=F==null?void 0:F.hypotheses)==null?void 0:O[0],g=(J=Ne==null?void 0:Ne.causalRanking)==null?void 0:J[0];return[`Run ${e.id} completed with ${e.steps.length} steps across ${e.metadata.wallTimeMs}ms.`,a?`Primary latency driver: ${a.name} (${a.durationMs??0}ms).`:null,o>0?`Observed ${o} failed step(s), indicating reliability risk.`:"No failed steps observed.",m?`Top investigation hypothesis: ${m.title} (${m.severity}).`:null,g?`Highest ranked causal factor from matrix: ${g.factor} (${(g.confidence*100).toFixed(0)}% confidence).`:null,"Recommended plan: inspect bottleneck evidence, validate with replay matrix, and lock in mitigations."].filter(Boolean).join(" ")},[F,Ne==null?void 0:Ne.causalRanking,e]),ki=c.useCallback(a=>{var m,g;const o=a.toLowerCase();if(!e)return"No trace is loaded yet.";if(o.includes("bottleneck")||o.includes("slow")){const C=[...e.steps].sort((O,J)=>(J.durationMs??0)-(O.durationMs??0))[0];return C?`The primary bottleneck is ${C.name} at ${C.durationMs??0}ms. Prioritize this step for optimization and replay validation.`:"No bottleneck could be determined from current trace data."}if(o.includes("risk")||o.includes("failure")||o.includes("error")){const C=e.steps.filter(O=>O.status==="failed");return C.length?`Risk is concentrated in ${C.length} failed step(s), starting at ${((m=C[0])==null?void 0:m.name)??"unknown"}.`:"Failure risk appears low for this run; no failed steps were observed."}return o.includes("cost")?`Recorded run cost is ${(e.metadata.totalCostUsd??0).toFixed(4)} USD. Use matrix scenarios to evaluate cheaper prompt/strategy options.`:o.includes("next")||o.includes("action")?Fe.length?`Next action: ${((g=Fe[0])==null?void 0:g.title)??"Open matrix"}.`:"Next action: open Cinema mode, inspect bottleneck, then run the matrix.":it},[it,Fe,e]),ms=c.useCallback(()=>{e&&Lt({id:"export-director-narrative",label:"Director narrative markdown",run:()=>{const a=`# Director Narrative

${it}

## Recommended Actions
${Fe.map(o=>`- ${o.title}: ${o.body}`).join(`
`)}`;on(`agent-director-narrative-${e.id}.md`,a,"text/markdown")}})},[it,Fe,Lt,e]),qt=c.useCallback(async()=>{if(!e)return;const a=Fe[0],o=e.steps.filter(C=>C.status==="failed").length,g=[`Session handoff (${new Date().toISOString()})`,`Trace: ${e.id}`,`Owner: ${Dt}`,`Handoff owner: ${At||"unassigned"}`,`Mode: ${u}`,`Selected step: ${D??"none"}`,`Run health: ${Ot}/100`,`Failures: ${o}`,`Wall time: ${e.metadata.wallTimeMs}ms`,`Top recommendation: ${a?`${a.title} -> ${a.actionLabel}`:"None"}`,`Narrative: ${it}`].join(`
`);try{await navigator.clipboard.writeText(g),Ga("Handoff digest copied"),z("ux.support.payload_copied",{kind:"handoff_digest"})}catch{window.prompt("Copy handoff digest",g),Ga("Handoff digest ready")}window.setTimeout(()=>Ga(null),2200)},[it,Fe,At,u,Ot,Dt,D,e,z]),fa=c.useCallback(a=>{Jn(o=>{const m={...o,[a]:!o[a]};return yc(window.localStorage,m),z("ux.feature_flag.toggled",{flag:a,enabled:m[a]}),m})},[z]),Si=c.useCallback(()=>{Be.isValid&&(An(!0),mt(!1),Ea("source"),ae("Workspace setup complete.","success"),z("ux.setup.completed",{dataSource:Ve.dataSource,hasInvites:!!Ve.inviteEmails.trim()}))},[ae,Be.isValid,Ve,z,An]),Ni=c.useCallback(async()=>{const a=JSON.stringify({diagnostics:ma,note:Tt,owner:Dt,handoffOwner:At||null},null,2);try{await navigator.clipboard.writeText(a),ae("Support payload copied.","success"),z("ux.support.payload_copied",{bytes:a.length})}catch{window.prompt("Copy support payload",a)}},[ae,At,Dt,ma,Tt,z]),Ci=c.useCallback(()=>{const a=at.trim();if(!a||Pt)return;const o={id:`view-${Math.random().toString(36).slice(2,9)}`,name:a,state:{mode:u,query:x,typeFilter:h,selectedStepId:D,safeExport:P,windowed:Pe,syncPlayback:Me,explainMode:_e,section:b}};la(m=>[o,...m].slice(0,20)),Wn(""),ca(o.id),z("ux.saved_view.created",{viewId:o.id,name:a}),ae(`Saved view: ${a}`,"success")},[b,ae,_e,u,x,P,at,Pt,D,la,Me,z,h,Pe]),rn=c.useCallback(a=>{const o=Oe.find(m=>m.id===a);o&&(f(o.state.mode),w(o.state.query),k(o.state.typeFilter),q(o.state.selectedStepId),me(o.state.safeExport),$e(o.state.windowed),M(o.state.syncPlayback),Se(o.state.explainMode),y(o.state.section),ca(o.id),z("ux.saved_view.applied",{viewId:o.id,name:o.name}),ae(`Applied view: ${o.name}`,"info"))},[ae,Oe,y,Se,f,me,M,$e,z]),Mi=c.useCallback(()=>{if(!qe)return;const a=Oe.find(o=>o.id===qe);a&&Ye("Delete saved view",`Delete saved view "${a.name}"?`,()=>{la(o=>o.filter(m=>m.id!==qe)),ca(""),z("ux.saved_view.deleted",{viewId:a.id,name:a.name}),ae(`Deleted view: ${a.name}`,"warning")})},[ae,Ye,Oe,qe,la,z]);c.useEffect(()=>{var m;if(!e)return;fl(),je(0),A(!1);const a=Math.min(Math.max((e.metadata.wallTimeMs||1)*.2,5e3),6e4);ee(a),e.steps.length>500&&$e(!0),U||Ee(!1),u==="compare"&&!U&&f("cinema");const o=D&&e.steps.some(g=>g.id===D)?D:((m=e.steps[0])==null?void 0:m.id)??"";Ra(g=>g&&e.steps.some(C=>C.id===g)?g:o)},[e,U,u,D,f,$e,Ee]),c.useEffect(()=>(document.body.classList.toggle("explain-mode",_e),()=>{document.body.classList.remove("explain-mode")}),[_e]),c.useEffect(()=>(document.body.classList.toggle("story-mode",!!(te!=null&&te.active)),()=>{document.body.classList.remove("story-mode")}),[te==null?void 0:te.active]),c.useEffect(()=>{if(!(te!=null&&te.active))return;const a=Xt[te.step];if(!a){Ze();return}Promise.resolve(a.action());const o=window.setTimeout(()=>{Yt(m=>m&&m.active?{...m,step:m.step+1}:m)},a.duration);return()=>window.clearTimeout(o)},[Xt,Ze,te]),c.useEffect(()=>{te!=null&&te.active&&(!e||!Aa||e.id!==Aa&&Ze())},[te==null?void 0:te.active,e,Aa,Ze]),c.useEffect(()=>{pt||Kt||ve(`tutorial_start:${(e==null?void 0:e.id)||de||ne.seed}`,"funnel.tutorial_start",{traceId:(e==null?void 0:e.id)||de||"unknown",persona:ge,launchPath:Sa})},[ve,ne.seed,de,pt,ge,Sa,Kt,e==null?void 0:e.id]),c.useEffect(()=>{Q>0&&xe(a=>a.playback?a:{...a,playback:!0})},[Q,xe]),c.useEffect(()=>{u==="flow"&&xe(a=>a.flow?a:{...a,flow:!0}),u==="matrix"&&xe(a=>a.matrix?a:{...a,matrix:!0})},[u,xe]),c.useEffect(()=>{D&&xe(a=>a.inspect?a:{...a,inspect:!0})},[D,xe]),c.useEffect(()=>{Fa>1&&xe(a=>a.collaborate?a:{...a,collaborate:!0})},[Fa,xe]),c.useEffect(()=>{ve(`session_start:${de||ne.seed}`,"funnel.session_start",{traceId:de||(e==null?void 0:e.id)||"unknown",seed:ne.seed})},[ve,ne.seed,de,e==null?void 0:e.id]),c.useEffect(()=>{ne.raid.objectives.some(o=>o.progress>0)&&ve(`objective_progress:${de||ne.seed}`,"funnel.first_objective_progress",{traceId:de||(e==null?void 0:e.id)||"unknown"})},[ve,ne.raid.objectives,ne.seed,de,e==null?void 0:e.id]),c.useEffect(()=>{ne.outcome.status!=="in_progress"&&(ve(`first_outcome:${de||ne.seed}`,"funnel.first_mission_outcome",{status:ne.outcome.status,reason:ne.outcome.reason}),(ne.outcome.status==="win"||ne.outcome.status==="loss")&&ve(`run_outcome:${de||ne.seed}`,"funnel.run_outcome",{status:ne.outcome.status,reason:ne.outcome.reason}))},[ve,ne.outcome.reason,ne.outcome.status,ne.seed,de]),c.useEffect(()=>{if(!Me||ye||Za.current)return;const a=pa[0];if(!a||a.traceId!==(e==null?void 0:e.id))return;const o=Math.abs(a.playheadMs-Q),m=a.mode!==u,g=(a.selectedStepId??null)!==(D??null);o<600&&!m&&!g||(Za.current=!0,je(a.playheadMs),(a.mode==="cinema"||a.mode==="flow"||a.mode==="compare"||a.mode==="matrix"||a.mode==="gameplay")&&f(a.mode),q(a.selectedStepId??null),window.setTimeout(()=>{Za.current=!1},180))},[ye,u,Q,pa,D,f,Me,e==null?void 0:e.id]),c.useEffect(()=>{if(!e)return;const o=Date.parse(e.startedAt)+Q;let m=0,g=Number.POSITIVE_INFINITY;e.steps.forEach((O,J)=>{const L=Date.parse(O.startedAt),le=Date.parse(O.endedAt??O.startedAt);if(o>=L&&o<=le){m=J,g=0;return}const we=Math.min(Math.abs(o-L),Math.abs(o-le));we<g&&(g=we,m=J)}),[m,m-1,m+1].filter(O=>O>=0&&O<e.steps.length).forEach(O=>{const J=e.steps[O];J&&ml(e.id,J.id,P)})},[e,Q,P]),c.useEffect(()=>{if(!e||!ye||u!=="cinema"&&u!=="compare")return;const a=(U==null?void 0:U.metadata.wallTimeMs)??0,o=u==="compare"?Math.max(e.metadata.wallTimeMs||1,a||1):e.metadata.wallTimeMs||1;let m=0,g=performance.now();const C=O=>{const J=(O-g)*ct;g=O,je(L=>{const le=L+J;return le>=o?(A(!1),o):le}),m=requestAnimationFrame(C)};return m=requestAnimationFrame(C),()=>cancelAnimationFrame(m)},[e,U,ye,ct,u]),c.useEffect(()=>{const a=JSON.stringify(sa),o=JSON.stringify(nt);a!==o&&ra(nt)},[nt,ra,sa]);const Ei=c.useCallback((a,o)=>{ra(m=>So(m,a,o)),z("ux.settings.shortcut.updated",{shortcut:a,key:o.toLowerCase()})},[ra,z]);c.useEffect(()=>{const a=o=>{var J;const m=L=>!o.metaKey&&!o.ctrlKey&&!o.altKey&&o.key.toLowerCase()===nt[L],g=o.target,C=(J=g==null?void 0:g.tagName)==null?void 0:J.toLowerCase();if(!(C==="input"||C==="textarea"||C==="select"||g!=null&&g.isContentEditable)){if((o.metaKey||o.ctrlKey)&&o.key.toLowerCase()==="k"){o.preventDefault(),Le(L=>!L);return}if(o.key==="?"||o.key==="/"&&o.shiftKey){o.preventDefault(),ke(!0);return}if(m("toggleStory")){o.preventDefault(),vt();return}if(m("toggleExplain")){o.preventDefault(),Se(L=>!L);return}if(m("startTour")){o.preventDefault(),he(!0);return}if(o.key==="Escape"){if(Ta){he(!1),dt(!0);return}ke(!1),Le(!1),q(null);return}if(o.key===" "){o.preventDefault(),(u==="cinema"||u==="compare")&&A(L=>!L);return}if(m("toggleFlow")){o.preventDefault(),u==="flow"?f("cinema"):u==="cinema"&&oe("flow");return}if(m("toggleCinema")){o.preventDefault(),u!=="cinema"&&f("cinema");return}if(m("toggleGameplay")){o.preventDefault(),oe("gameplay");return}if(m("toggleInspector")){o.preventDefault(),D?q(null):e!=null&&e.steps.length&&q(e.steps[0].id);return}if(o.key==="ArrowLeft"||o.key==="ArrowRight"){if(o.preventDefault(),!e)return;const L=e.metadata.wallTimeMs||1;if(o.shiftKey){je(o.key==="ArrowLeft"?0:L),A(!1),f("cinema");return}const le=o.key==="ArrowRight"?1:-1,we=Hl(rs,Q,le);we!=null&&(je(we),A(!1),f("cinema"))}}};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[u,nt,D,e,Q,rs,oe,f,Se,Le,he,dt,Ta,vt]);const hs=c.useMemo(()=>{if(!e||!Pe||x)return null;const a=e.metadata.wallTimeMs||1,o=Math.min(Math.max(T,5e3),a);let m=Math.max(0,Q-o/2);const g=Math.min(a,m+o);return g-m<o&&(m=Math.max(0,g-o)),{startMs:m,endMs:g}},[e,Pe,Q,x,T]),Ue=!!(te!=null&&te.active),fs=(te==null?void 0:te.step)??0,Ii=((bs=Xt[fs])==null?void 0:bs.label)??"Wrapping up",Ti=Xt.length,Di=x!==v,Ai=`${Math.min(Ge.length,_t)}/${Ge.length}`,$i=c.useMemo(()=>ge==="executive"?[{label:"Review run health",done:Ot>=80},{label:"Inspect top risk",done:!!D},{label:"Share handoff digest",done:!!ft}]:ge==="operator"?[{label:"Open failed step",done:!!D},{label:"Run replay",done:!!U},{label:"Use support diagnostics",done:Ua||!!Tt.trim()}]:[{label:"Open flow graph",done:u==="flow"},{label:"Run matrix scenario",done:!!Ne},{label:"Save a reusable view",done:Oe.length>0}],[U,ft,ge,u,Ne,Ot,Oe.length,D,Tt,Ua]),_i=c.useMemo(()=>[{id:"macro-rapid-triage",label:"Run rapid triage launch path",description:"Jump to the highest-risk step and start mitigation.",group:"Macros",onTrigger:()=>{Ft("rapid_triage")}},{id:"macro-deep-diagnosis",label:"Run deep diagnosis launch path",description:"Open flow analysis and guided tour.",group:"Macros",onTrigger:()=>{Ft("deep_diagnosis")}},{id:"macro-team-sync",label:"Run team sync launch path",description:"Enable sync mode and generate shareable context.",group:"Macros",onTrigger:()=>{Ft("team_sync")}},{id:"story-toggle",label:Ue?"Stop story mode":"Start story mode",description:"Auto-runs a cinematic walkthrough.",group:"Story",keys:"S",onTrigger:vt},{id:"tour-start",label:"Start guided tour",description:"Walk the interface step by step.",group:"Onboarding",keys:"T",onTrigger:()=>he(!0)},{id:"explain-toggle",label:_e?"Disable explain mode":"Enable explain mode",description:"Toggle contextual overlays.",group:"Onboarding",keys:"E",onTrigger:()=>Se(a=>!a)},{id:"shortcuts",label:"Show shortcuts",description:"Open the keyboard map.",group:"Onboarding",keys:"?",onTrigger:()=>ke(!0)},{id:"playback-toggle",label:ye?"Pause playback":"Play playback",description:"Start or stop the run.",group:"Playback",keys:"Space",onTrigger:sn},{id:"mode-cinema",label:"Switch to Cinema",description:"Timeline playback view.",group:"Modes",keys:"C",onTrigger:()=>oe("cinema")},{id:"mode-flow",label:"Switch to Flow",description:"Graph dependency view.",group:"Modes",keys:"F",onTrigger:()=>oe("flow")},{id:"mode-compare",label:"Open Compare",description:"Side-by-side diff view.",group:"Modes",onTrigger:()=>oe("compare"),disabled:!U},{id:"mode-matrix",label:"Open Matrix",description:"Counterfactual replay matrix view.",group:"Modes",onTrigger:()=>oe("matrix")},{id:"mode-gameplay",label:"Open Gameplay",description:"World-class gameplay mechanics control center.",group:"Modes",keys:"G",onTrigger:()=>oe("gameplay")},{id:"jump-bottleneck",label:"Jump to bottleneck",description:"Select the slowest step.",group:"Navigation",onTrigger:De},{id:"jump-error",label:"Jump to error",description:"Select the first failed step.",group:"Navigation",onTrigger:rt},{id:"replay-step",label:"Replay from selected step",description:"Branch a Director’s Cut.",group:"Tools",onTrigger:()=>D&&ze(D),disabled:!D},{id:"overlay-toggle",label:St?"Hide overlay":"Show overlay",description:"Ghost diff in Cinema/Flow.",group:"Tools",onTrigger:()=>Ee(a=>!a),disabled:!U},{id:"safe-export",label:P?"Disable safe export":"Enable safe export",description:"Redact sensitive payloads.",group:"Safety",onTrigger:()=>me(a=>!a)},{id:"reload",label:"Reload traces",description:"Refresh trace data.",group:"Meta",onTrigger:i},{id:"handoff-digest",label:"Copy handoff digest",description:"Capture mode, risk summary, and next actions for teammates.",group:"Meta",keys:"H",onTrigger:()=>{qt()}},{id:"section-journey",label:"Open journey workspace",description:"Show journey presets and persona progression.",group:"Workspace",onTrigger:()=>y("journey")},{id:"section-analysis",label:"Open analysis workspace",description:"Show async action health and export queue.",group:"Workspace",onTrigger:()=>y("analysis")},{id:"section-collaboration",label:"Open collaboration workspace",description:"Ownership, handoff, and activity timeline.",group:"Workspace",onTrigger:()=>y("collaboration")},{id:"section-operations",label:"Open operations workspace",description:"Setup, support, and feature flags.",group:"Workspace",onTrigger:()=>y("operations")},{id:"open-setup-wizard",label:"Open setup wizard",description:"Connect source, import context, and invite teammates.",group:"Workspace",onTrigger:()=>{mt(!0),z("ux.setup.opened",{source:"command_palette"})},disabled:!ue.setupWizardV1},{id:"open-support-panel",label:"Open support diagnostics",description:"Collect support payload and copy handoff diagnostics.",group:"Workspace",onTrigger:()=>{It(!0),z("ux.support.opened",{source:"command_palette"})},disabled:!ue.supportPanelV1},...Oe.slice(0,5).map(a=>({id:`saved-view-${a.id}`,label:`Apply saved view: ${a.name}`,description:"Restore a saved journey configuration.",group:"Workspace",onTrigger:()=>rn(a.id)}))],[rn,qt,ue.setupWizardV1,ue.supportPanelV1,Ue,vt,_e,ye,sn,oe,U,De,rt,D,ze,St,P,i,Se,Ee,me,ke,It,mt,he,y,Oe,Ft,z]),Ri=c.useCallback(()=>{ve(`tutorial_skip:intro:${(e==null?void 0:e.id)||de||ne.seed}`,"funnel.tutorial_skip",{traceId:(e==null?void 0:e.id)||de||"unknown",source:"intro_overlay"}),Qt(!0)},[ve,ne.seed,de,Qt,e==null?void 0:e.id]),Oi=c.useCallback(()=>{Qt(!0),he(!0)},[Qt,he]),Pi=c.useCallback(()=>{ve(`tutorial_skip:tour:${(e==null?void 0:e.id)||de||ne.seed}`,"funnel.tutorial_skip",{traceId:(e==null?void 0:e.id)||de||"unknown",source:"guided_tour"}),he(!1),dt(!0)},[ve,ne.seed,de,dt,e==null?void 0:e.id]),Li=c.useCallback(()=>{ve(`tutorial_complete:${(e==null?void 0:e.id)||de||ne.seed}`,"funnel.tutorial_complete",{traceId:(e==null?void 0:e.id)||de||"unknown"}),he(!1),dt(!0)},[ve,ne.seed,de,dt,e==null?void 0:e.id]);return s?t.jsx(un,{variant:"loading",title:"Loading trace...",message:"Preparing timeline, graph, and replay context."}):!r&&!e&&d.length===0?t.jsx(un,{variant:"empty",title:"No traces yet",message:"Ingest your first trace, then reload to begin the Observe → Inspect → Direct workflow.",actions:[{id:"retry",label:"Retry",node:t.jsx("button",{className:"primary-button",type:"button",onClick:i,children:"Retry"})},{id:"help",label:"Open help",node:t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer",children:"Open help"})}]}):r||!e?t.jsx(un,{variant:"error",title:"Trace load failed",message:r??"Failed to load trace.",actions:[{id:"retry",label:"Retry",node:t.jsx("button",{className:"primary-button",type:"button",onClick:i,children:"Retry"})},{id:"help",label:"Open help",node:t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer",children:"Open help"})}]}):t.jsxs("div",{className:`app theme-${Nt} ${_e?"explain-mode":""} ${u==="compare"?"mode-compare":""} ${u==="matrix"?"mode-matrix":""} ${u==="gameplay"?"mode-gameplay":""}`,children:[t.jsx(Wi,{trace:e,traces:d,selectedTraceId:l,onSelectTrace:p,onReload:i,onStartTour:()=>he(!0),onToggleStory:vt,onOpenPalette:()=>Le(!0),onToggleExplain:()=>Se(a=>!a),onShareSession:ha,onCreateHandoffDigest:()=>void qt(),onOpenSupport:()=>{It(!0),z("ux.support.opened",{source:"header"})},onThemeChange:Nn,onMotionChange:Cn,themeMode:Nt,motionMode:Wt,activeSessions:Fa,shareStatus:ia,handoffStatus:ft,explainMode:_e,storyActive:Ue,mode:u,missionCompletion:os,runHealthScore:Ot,modeHotkeys:Br,workspaces:Ks,workspaceId:Ca,onWorkspaceChange:vr,workspaceRole:Jt,onWorkspaceRoleChange:wr,sessionLabel:st.label,sessionExpired:st.expired,onRenewSession:Ur}),t.jsx(Jo,{notifications:Et.map(({id:a,message:o,level:m})=>({id:a,message:o,level:m})),onDismiss:zr}),$t?t.jsxs("div",{className:"undo-banner",role:"status","aria-live":"polite",children:[t.jsx("span",{children:$t.label}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{var a,o;(o=(a=ns.current)[$t.id])==null||o.call(a),Wa(null)},children:"Undo"})]}):null,da?t.jsx("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true","aria-label":"Confirm action",children:t.jsxs("div",{className:"palette confirm-dialog",children:[t.jsx("div",{className:"palette-header",children:t.jsxs("div",{children:[t.jsx("div",{className:"palette-title",children:da.title}),t.jsx("div",{className:"palette-subtitle",children:da.message})]})}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Ha(null),children:"Cancel"}),t.jsx("button",{className:"primary-button",type:"button",onClick:()=>{var o,m;const a=da.id;z("ux.action.confirmed",{confirmationId:a}),(m=(o=en.current)[a])==null||m.call(o),delete en.current[a],Ha(null)},children:"Confirm"})]})]})}):null,Ma&&ue.setupWizardV1?t.jsx("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true","aria-label":"First-run setup wizard",children:t.jsxs("div",{className:"palette setup-wizard",children:[t.jsxs("div",{className:"palette-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"palette-title",children:"First-run setup wizard"}),t.jsx("div",{className:"palette-subtitle",children:"Connect source, import context, invite teammates."})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>mt(!1),children:"Close"})]}),t.jsxs("div",{className:"setup-stepper",children:[t.jsx("span",{className:Je==="source"?"active":"",children:"1. Source"}),t.jsx("span",{className:Je==="import"?"active":"",children:"2. Import"}),t.jsx("span",{className:Je==="invite"?"active":"",children:"3. Invite"})]}),Je==="source"?t.jsxs("div",{className:"workspace-card",children:[t.jsxs("label",{children:["Data source",t.jsxs("select",{className:"search-select",value:Ve.dataSource,onChange:a=>Ia(o=>({...o,dataSource:a.target.value})),children:[t.jsx("option",{value:"",children:"Select source"}),t.jsx("option",{value:"api",children:"Live API"}),t.jsx("option",{value:"file",children:"Trace file import"}),t.jsx("option",{value:"hybrid",children:"Hybrid replay baseline"})]})]}),Be.dataSourceError?t.jsx("p",{className:"workspace-error",children:Be.dataSourceError}):null]}):null,Je==="import"?t.jsxs("div",{className:"workspace-card",children:[t.jsxs("label",{children:["Import path or URI",t.jsx("input",{className:"search-input",value:Ve.importPath,onChange:a=>Ia(o=>({...o,importPath:a.target.value})),placeholder:"/data/traces/latest.json"})]}),Be.importPathError?t.jsx("p",{className:"workspace-error",children:Be.importPathError}):null]}):null,Je==="invite"?t.jsxs("div",{className:"workspace-card",children:[t.jsxs("label",{children:["Invite emails (comma-separated)",t.jsx("input",{className:"search-input",value:Ve.inviteEmails,onChange:a=>Ia(o=>({...o,inviteEmails:a.target.value})),placeholder:"ops@example.com, qa@example.com"})]}),Be.inviteEmailsError?t.jsx("p",{className:"workspace-error",children:Be.inviteEmailsError}):null]}):null,t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Ea(a=>a==="invite"?"import":"source"),disabled:Je==="source",children:"Back"}),Je!=="invite"?t.jsx("button",{className:"primary-button",type:"button",onClick:()=>Ea(a=>a==="source"?"import":"invite"),children:"Continue"}):t.jsx("button",{className:"primary-button",type:"button",disabled:!Be.isValid,onClick:Si,children:"Complete setup"})]})]})}):null,Ua&&ue.supportPanelV1?t.jsx("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true","aria-label":"Support diagnostics",children:t.jsxs("div",{className:"palette support-panel",children:[t.jsxs("div",{className:"palette-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"palette-title",children:"Support diagnostics"}),t.jsx("div",{className:"palette-subtitle",children:"Capture environment and handoff payload for support triage."})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>It(!1),children:"Close"})]}),t.jsxs("label",{children:["Support note",t.jsx("textarea",{className:"search-input",value:Tt,onChange:a=>Dr(a.target.value),rows:3,placeholder:"Describe the issue, reproduction, and expected behavior."})]}),t.jsx("pre",{className:"support-diagnostics-preview",children:JSON.stringify(ma,null,2)}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>void Ni(),children:"Copy diagnostics payload"}),t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer",children:"Open help"})]})]})}):null,!pt&&!Kt?t.jsx(zo,{onComplete:Ri,onStartTour:Oi,onStartStory:xt,persona:ge,onPersonaChange:xr,launchPath:Sa,onLaunchPathChange:Na,onStartLaunchPath:a=>void Ft(a)}):null,pt&&!wa?t.jsx(Uo,{explainMode:_e,storyActive:Ue,onStartTour:()=>{ja(!0),he(!0)},onStartStory:()=>{ja(!0),xt()},onToggleExplain:()=>Se(a=>!a),onDismiss:()=>ja(!0)}):null,t.jsx(Fo,{steps:vi,open:Ta,onClose:Pi,onComplete:Li}),t.jsx(qo,{enabled:_e}),t.jsx(Wo,{active:Ue,label:Ii,step:fs,total:Ti,onStop:Ze,onRestart:xt}),t.jsx(Ji,{insights:n,investigation:F,onSelectStep:a=>{q(a),u!=="cinema"&&f("cinema")},onJumpToError:rt,onJumpToBottleneck:De}),t.jsx(Ao,{trace:e,mode:u==="matrix"||u==="gameplay"?"cinema":u,playheadMs:Q,selectedStepId:D,compareTrace:U,collapsed:yr,onToggleCollapsed:()=>br(a=>!a),onModeChange:oe,onSelectStep:a=>{q(a),u!=="cinema"&&f("cinema")},onJumpToBottleneck:De,onReplay:ze,onStartTour:()=>he(!0),priorityQueue:ji}),t.jsxs("nav",{className:"workspace-nav","aria-label":"Workspace navigation",children:[t.jsx("button",{className:`ghost-button ${b==="journey"?"active":""}`,type:"button",onClick:()=>y("journey"),children:"Journey"}),t.jsx("button",{className:`ghost-button ${b==="analysis"?"active":""}`,type:"button",onClick:()=>y("analysis"),children:"Analysis"}),t.jsx("button",{className:`ghost-button ${b==="collaboration"?"active":""}`,type:"button",onClick:()=>y("collaboration"),children:"Collaboration"}),t.jsx("button",{className:`ghost-button ${b==="operations"?"active":""}`,type:"button",onClick:()=>y("operations"),children:"Operations"})]}),t.jsxs("section",{className:"workspace-context-panel","aria-label":"Contextual workspace tools",children:[b==="journey"?t.jsxs("div",{className:"workspace-context-grid",children:[t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Persona progression"}),t.jsx("p",{children:ge==="executive"?"Executive mission path":ge==="operator"?"Operator mission path":"Builder mission path"}),t.jsx("div",{className:"workspace-checklist",children:$i.map(a=>t.jsxs("div",{className:`workspace-check ${a.done?"done":""}`,children:[t.jsx("span",{children:a.done?"✓":"○"}),t.jsx("span",{children:a.label})]},a.label))})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Saved views"}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("input",{className:"search-input",placeholder:"Saved view name",value:at,onChange:a=>Wn(a.target.value),"aria-label":"Saved view name"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:Ci,disabled:!!Pt,children:"Save view"})]}),Pt&&at.trim()?t.jsx("p",{className:"workspace-error",children:Pt}):null,t.jsxs("div",{className:"workspace-inline-form",children:[t.jsxs("select",{className:"search-select",value:qe,onChange:a=>ca(a.target.value),"aria-label":"Saved views",children:[t.jsx("option",{value:"",children:"Select saved view"}),Oe.map(a=>t.jsx("option",{value:a.id,children:a.name},a.id))]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>qe&&rn(qe),disabled:!qe,children:"Apply"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:Mi,disabled:!qe,children:"Delete"})]})]})]}):null,b==="analysis"?t.jsxs("div",{className:"workspace-context-grid",children:[t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Async actions"}),oa.length===0?t.jsx("p",{children:"No tracked async actions yet."}):null,oa.map(a=>t.jsxs("div",{className:`async-action-row status-${a.status}`,children:[t.jsxs("div",{children:[t.jsx("strong",{children:a.label}),t.jsx("p",{children:a.detail})]}),t.jsxs("div",{className:"async-action-actions",children:[a.retryable?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Hr(a.id),children:"Retry"}):null,a.resumable?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Wr(a.id),children:"Resume"}):null]})]},a.id))]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Export center"}),ue.exportCenterV1?null:t.jsx("p",{children:"Export center is disabled by feature flag."}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>ms(),disabled:!e||!ue.exportCenterV1,children:"Queue narrative export"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{Lt({id:"export-support-diagnostics",label:"Support diagnostics JSON",run:()=>on("agent-director-support-diagnostics.json",JSON.stringify(ma,null,2),"application/json")})},disabled:!ue.exportCenterV1,children:"Queue diagnostics export"})]}),ue.exportCenterV1&&Hn.length===0?t.jsx("p",{children:"No exports queued."}):null,Hn.map(a=>t.jsxs("div",{className:`export-task-row status-${a.status}`,children:[t.jsx("span",{children:a.label}),t.jsx("span",{children:a.detail}),a.retryable?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{var o,m;z("ux.export.retried",{taskId:a.id}),(m=(o=as.current)[a.id])==null||m.call(o)},children:"Retry"}):null]},a.id))]})]}):null,b==="collaboration"?t.jsxs("div",{className:"workspace-context-grid",children:[ue.ownershipPanelV1?null:t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Ownership panel disabled"}),t.jsx("p",{children:"Enable the ownership panel feature flag in Operations to configure handoff ownership."})]}),ue.ownershipPanelV1?t.jsxs(t.Fragment,{children:[t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Ownership and handoff"}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("input",{className:"search-input",value:Dt,onChange:a=>Ar(a.target.value),"aria-label":"Run owner",placeholder:"Run owner"}),t.jsx("input",{className:"search-input",value:At,onChange:a=>$r(a.target.value),"aria-label":"Handoff owner",placeholder:"Handoff owner"})]}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void ha(),children:"Share live link"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void qt(),children:"Copy handoff digest"})]})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Collaboration activity"}),Ka.length===0?t.jsx("p",{children:"No collaboration activity yet."}):null,t.jsx("div",{className:"workspace-feed",children:Ka.slice(0,8).map(a=>t.jsxs("div",{className:"workspace-feed-item",children:[t.jsx("span",{children:new Date(a.timestamp).toLocaleTimeString()}),t.jsx("span",{children:a.message})]},a.id))})]})]}):null]}):null,b==="operations"?t.jsxs("div",{className:"workspace-context-grid",children:[t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Setup + support"}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{mt(!0),z("ux.setup.opened",{source:"operations_panel"})},disabled:!ue.setupWizardV1,children:"Open setup wizard"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{It(!0),z("ux.support.opened",{source:"operations_panel"})},disabled:!ue.supportPanelV1,children:"Open support panel"})]}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:ue.setupWizardV1,onChange:()=>fa("setupWizardV1")}),"Setup wizard flag"]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:ue.supportPanelV1,onChange:()=>fa("supportPanelV1")}),"Support panel flag"]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:ue.exportCenterV1,onChange:()=>fa("exportCenterV1")}),"Export center flag"]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:ue.ownershipPanelV1,onChange:()=>fa("ownershipPanelV1")}),"Ownership panel flag"]})]})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Telemetry summary"}),t.jsx("p",{children:"Product events are captured in local analytics queue for pre-release UX audits."}),t.jsx("div",{className:"workspace-inline-form",children:t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{const a=window.localStorage.getItem("agentDirector.analytics.events.v1")??"[]";Lt({id:"export-analytics-events",label:"Frontend analytics events",run:()=>on("agent-director-frontend-events.json",a,"application/json")})},children:"Export event queue"})})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Settings center"}),t.jsx("p",{children:"Centralized controls for input, UX behavior, and safe sharing defaults."}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:P,onChange:()=>me(a=>!a)}),"Safe export"]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:na,onChange:()=>qn(a=>!a)}),"Gamepad enabled"]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:Pe,onChange:()=>$e(a=>!a)}),"Timeline windowing"]})]}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsxs("label",{children:["Theme",t.jsxs("select",{className:"search-select",value:Nt,onChange:a=>Nn(a.target.value),children:[t.jsx("option",{value:"studio",children:"Studio"}),t.jsx("option",{value:"focus",children:"Focus"}),t.jsx("option",{value:"contrast",children:"Contrast"})]})]}),t.jsxs("label",{children:["Motion",t.jsxs("select",{className:"search-select",value:Wt,onChange:a=>Cn(a.target.value),children:[t.jsx("option",{value:"cinematic",children:"Cinematic"}),t.jsx("option",{value:"balanced",children:"Balanced"}),t.jsx("option",{value:"minimal",children:"Minimal"})]})]}),t.jsxs("label",{children:["Gameplay locale",t.jsxs("select",{className:"search-select",value:Ln,onChange:a=>Fn(a.target.value),children:[t.jsx("option",{value:"en",children:"English"}),t.jsx("option",{value:"es",children:"Espanol"})]})]})]}),t.jsx("div",{className:"workspace-feed",children:Ut.map(a=>t.jsxs("label",{className:"workspace-inline-form",children:[t.jsx("span",{children:a.label}),t.jsx("select",{className:"search-select",value:nt[a.id],onChange:o=>Ei(a.id,o.target.value),"aria-label":`${a.label} shortcut`,children:wn.map(o=>t.jsx("option",{value:o,children:o.toUpperCase()},o))})]},a.id))})]})]}):null]}),t.jsxs("div",{className:"toolbar","data-help":!0,"data-help-indicator":!0,"data-tour":"toolbar","data-help-title":"Search + filters","data-help-body":"Filter by step type, enable Safe export, and jump between Cinema, Flow, Compare, and Matrix.","data-help-placement":"bottom",children:[t.jsx(Ki,{query:x,typeFilter:h,onQueryChange:w,onTypeFilterChange:k}),t.jsxs("div",{className:"toolbar-actions",children:[t.jsx("input",{className:"search-input",value:S,onChange:a=>$(a.target.value),placeholder:"TraceQL (example: type=tool_call and duration_ms>800)","aria-label":"TraceQL query"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void Jr(),children:"Run TraceQL"}),X?t.jsxs("span",{className:"status-badge",children:[X.matchCount," match(es)"]}):null,Di?t.jsx("span",{className:"status-badge",children:"Filtering..."}):null,t.jsxs("span",{className:"status-badge",children:["Hydration ",Ai]}),t.jsxs("span",{className:"status-badge",children:["Filter ",_r,"ms"]}),X?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{$(""),E(null),H(null)},children:"Clear TraceQL"}):null,_?t.jsx("span",{className:"status-badge warn",children:_}):null,t.jsxs("select",{className:"search-select",value:j,onChange:a=>I(a.target.value),"aria-label":"Extension selector",children:[t.jsx("option",{value:"",children:"Select extension"}),V.map(a=>t.jsx("option",{value:a.id,children:a.name},a.id))]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void Vr(),disabled:!e||!j||N,children:N?"Running extension...":"Run extension"}),t.jsx("button",{className:`ghost-button ${u==="cinema"?"active":""}`,type:"button","aria-pressed":u==="cinema",title:"Timeline playback",onClick:()=>oe("cinema"),"data-help":!0,"data-help-title":"Cinema mode","data-help-body":"Timeline view with step cards ordered by time.","data-help-placement":"bottom",children:"Cinema"}),t.jsx("button",{className:`ghost-button ${u==="flow"?"active":""}`,type:"button","aria-pressed":u==="flow",title:"Graph view",onClick:()=>oe("flow"),"data-help":!0,"data-help-title":"Flow mode","data-help-body":"Dependency graph of steps and tool calls.","data-help-placement":"bottom",children:"Flow"}),t.jsx("button",{className:`ghost-button ${u==="compare"?"active":""}`,type:"button","aria-pressed":u==="compare",title:U?"Side-by-side compare":"Run a replay to enable compare",onClick:()=>oe("compare"),disabled:!U,"data-tour":"compare","data-help":!0,"data-help-title":"Compare mode","data-help-body":"Side-by-side view after a replay. Enabled once you replay.","data-help-placement":"bottom",children:"Compare"}),t.jsx("button",{className:`ghost-button ${u==="matrix"?"active":""}`,type:"button","aria-pressed":u==="matrix",title:"Counterfactual replay matrix",onClick:()=>oe("matrix"),"data-help":!0,"data-help-title":"Matrix mode","data-help-body":"Run multiple replay scenarios and rank likely causal factors.","data-help-placement":"bottom",children:"Matrix"}),t.jsx("button",{className:`ghost-button ${u==="gameplay"?"active":""}`,type:"button","aria-pressed":u==="gameplay",title:"Gameplay mechanics command center",onClick:()=>oe("gameplay"),"data-help":!0,"data-help-title":"Gameplay mode","data-help-body":"Command raids, campaign, pvp, time forks, boss runs, economy, and liveops.","data-help-placement":"bottom",children:"Gameplay"}),t.jsxs("label",{className:"toggle",title:"Redact payloads and disable raw views for safe sharing","data-help":!0,"data-help-title":"Safe export","data-help-body":"Redacts secrets and disables raw payload views for safe sharing.","data-help-placement":"bottom",children:[t.jsx("input",{type:"checkbox",checked:P,onChange:()=>me(a=>!a)}),"Safe export"]}),e.steps.length>200||Pe?t.jsxs("label",{className:"toggle",title:"Window steps around the playhead for large traces","data-help":!0,"data-help-title":"Windowed mode","data-help-body":"Limits rendering to a playhead window for large traces.","data-help-placement":"bottom",children:[t.jsx("input",{type:"checkbox",checked:Pe,onChange:()=>$e(a=>!a)}),"Windowed"]}):null,U?t.jsxs("label",{className:"toggle",title:"Show ghost overlay of replay in Cinema/Flow","data-help":!0,"data-help-title":"Overlay replay","data-help-body":"Layer the replay over the base run to spot differences.","data-help-placement":"bottom",children:[t.jsx("input",{type:"checkbox",checked:St,onChange:()=>Ee(a=>!a)}),"Overlay"]}):null,t.jsxs("label",{className:"toggle",title:"Follow active collaborator cursor and mode updates",children:[t.jsx("input",{type:"checkbox",checked:Me,onChange:()=>M(a=>!a)}),"Sync playback"]})]})]}),R?t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Extension output"}),t.jsx("pre",{className:"inspector-json",children:JSON.stringify(R,null,2)})]}):null,u==="cinema"?t.jsxs("div",{className:"playback-stack","data-tour":"playback",children:[t.jsx("div",{"data-help":!0,"data-help-title":"Playback controls","data-help-body":"Play, pause, scrub, and adjust speed to feel the rhythm of the run.","data-help-placement":"bottom",children:t.jsx(ks,{playheadMs:Q,wallTimeMs:e.metadata.wallTimeMs||1,isPlaying:ye,speed:ct,onToggle:()=>A(a=>!a),onScrub:a=>je(a),onSpeedChange:Ae})}),t.jsx("div",{"data-help":!0,"data-help-title":"Density map","data-help-body":"Zoom into hotspots and keep long traces readable with windowing.","data-help-placement":"bottom",children:t.jsx(vo,{traceStart:e.startedAt,traceEnd:e.endedAt,steps:e.steps,playheadMs:Q,windowRange:hs,windowed:Pe,spanMs:T,onSpanChange:ee,onToggleWindowed:$e,onScrub:a=>je(a),persistenceKey:e.id,laneStrategy:pe,visibleLaneGroups:Fr,remotePlayheads:qr})})]}):null,u==="compare"&&U?t.jsx("div",{"data-help":!0,"data-help-title":"Compare playback","data-help-body":"Sync both runs to evaluate improvements at identical timestamps.","data-help-placement":"bottom",children:t.jsx(ks,{playheadMs:Q,wallTimeMs:Math.max(e.metadata.wallTimeMs||1,U.metadata.wallTimeMs||1),isPlaying:ye,speed:ct,onToggle:()=>A(a=>!a),onScrub:a=>je(a),onSpeedChange:Ae})}):null,t.jsxs("main",{className:`stage ${u==="compare"?"stage-compare":""} motion-fade-in`,role:"main",children:[t.jsx("div",{className:"main motion-slide-up",ref:Xa,"data-help":!0,"data-help-indicator":!0,"data-tour":"stage","data-help-title":"Trace stage","data-help-body":"Every step becomes a scene. Hover or click to open deep inspection.","data-help-placement":"top",children:t.jsx(Ko,{morph:jr,onComplete:wi,children:t.jsxs(c.Suspense,{fallback:t.jsx("div",{className:"loading",children:"Loading view..."}),children:[u==="cinema"?t.jsx(ho,{trace:e,steps:ss,selectedStepId:D,onSelectStep:a=>q(a),playheadMs:Q,windowRange:hs,timing:n==null?void 0:n.timing,ghostTrace:St?U:null,diff:Lr,laneStrategy:pe,laneGroupsOrder:bt.order,hiddenLaneGroups:bt.hidden,onLaneStrategyChange:Kr,onToggleLaneGroupVisibility:Qr,onMoveLaneGroup:ci}):null,u==="flow"?t.jsx(vc,{steps:ss,selectedStepId:D,onSelectStep:a=>q(a),baseTrace:e,compareTrace:U,compareSteps:Pr,overlayEnabled:St,onToggleOverlay:()=>Ee(a=>!a)}):null,u==="compare"&&U?t.jsx(wc,{baseTrace:e,compareTrace:U,playheadMs:Q,safeExport:P,onExit:()=>{f("cinema"),fe(null)}}):null,u==="matrix"?t.jsx(kc,{steps:e.steps,anchorStepId:_a,onAnchorStepChange:Ra,scenarios:Oa,onScenarioChange:pi,onDuplicateScenario:yi,onMoveScenario:bi,onAddScenario:hi,onRemoveScenario:fi,onRun:nn,onCancel:gi,onReplaceScenarios:mi,loading:kr,error:ea,job:Ke,matrix:Ne,safeExport:P,onOpenCompare:xi}):null,u==="gameplay"?t.jsx(Sc,{state:ne,playheadMs:Q,onUpdate:a=>Mt(o=>a(o)),session:ce,playerId:Ie,sessionError:ta,onCreateSession:Yr,onQuickMatchSession:Xr,onJoinSession:Zr,onLeaveSession:ei,onReconnectSession:ti,onDispatchAction:ai,guild:Sr,social:Nr,onInviteFriend:oi,onAcceptFriendInvite:li,locale:Ln,onLocaleChange:Fn,gamepadEnabled:na,onToggleGamepad:qn,gamepadPreset:La,onGamepadPresetChange:Cr,isOnline:Mr,onRetryConnectivity:us,onCreateGuild:ni,onJoinGuild:si,onScheduleGuildEvent:ri,onCompleteGuildEvent:ii,observability:Er,analytics:Ir}):null]})})}),t.jsx(c.Suspense,{fallback:t.jsx("div",{className:"loading",children:"Loading panel..."}),children:u==="compare"||u==="matrix"||u==="gameplay"?null:is?t.jsx(jc,{traceId:e.id,step:is,safeExport:P,onClose:()=>q(null),onReplay:ze}):t.jsx(Lo,{trace:e,mode:u,selectedStepId:D,onModeChange:oe,onSelectStep:a=>q(a),onJumpToBottleneck:De,onReplay:ze,recommendations:Fe,persona:ge,annotations:Gr,activityFeed:Ka,onAddAnnotation:ui,missionProgress:Vt,missionCompletion:os,onResetMissions:di,narrative:it,onAskDirector:ki,onExportNarrative:ms})})]}),t.jsxs("div",{className:"mobile-quick-rail","aria-label":"Mobile quick actions",children:[t.jsx("button",{className:`ghost-button ${Ue?"active":""}`,type:"button",onClick:vt,"aria-label":Ue?"Stop story mode":"Start story mode",children:Ue?"Stop Story":"Story"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>he(!0),"aria-label":"Start guided tour",children:"Guide"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Le(!0),"aria-label":"Open command palette",children:"Command"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void qt(),"aria-label":"Copy handoff digest",children:"Handoff"})]}),t.jsx(Ho,{mode:u==="matrix"||u==="gameplay"?"cinema":u,isPlaying:ye,storyActive:Ue,explainMode:_e,hidden:u==="compare",open:gr,onToggleOpen:()=>ka(a=>!a),onTogglePlay:sn,onStartStory:xt,onStopStory:Ze,onStartTour:()=>he(!0),onOpenPalette:()=>Le(!0),onShowShortcuts:()=>ke(!0),onToggleExplain:()=>Se(a=>!a),onJumpToBottleneck:De}),t.jsx(To,{open:kt,onClose:()=>Le(!1),actions:_i,context:{section:b,mode:u,persona:ge},onActionRun:a=>z("ux.palette.command_run",{id:a.id,group:a.group??null})}),t.jsx(Co,{open:be,onClose:()=>ke(!1),bindings:nt})]})}qi.createRoot(document.getElementById("root")).render(t.jsx(Gi.StrictMode,{children:t.jsx(Dc,{})}));"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js")});export{Kc as A,ed as B,Qc as C,Yc as D,Xc as E,Zc as F,td as G,sd as H,rd as I,nd as J,ro as S,po as T,ql as a,zl as b,bo as c,sr as d,Rc as e,_c as f,pl as g,on as h,tc as i,Pc as j,ac as k,nc as l,Oc as m,Lc as n,ad as o,Fc as p,qc as q,Bc as r,Yi as s,zc as t,Gc as u,Uc as v,Hc as w,Wc as x,Jc as y,Vc as z};
