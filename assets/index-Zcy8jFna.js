const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-C18ZUr6w.js","assets/vendor-react-D4yGots9.js","assets/vendor-DClHNS3s.js","assets/vendor-B5DZHykP.css","assets/index-CpbCZ8DM.js","assets/index-CgPEnHJd.js","assets/index-D1nEiSPm.js","assets/index-Cm6o9e9V.js"])))=>i.map(i=>d[i]);
import{j as t,r as l,a as Al,R as $l}from"./vendor-react-D4yGots9.js";import{m as Pl,d as Vr}from"./vendor-DClHNS3s.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const d of o)if(d.type==="childList")for(const c of d.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function s(o){const d={};return o.integrity&&(d.integrity=o.integrity),o.referrerPolicy&&(d.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?d.credentials="include":o.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function r(o){if(o.ep)return;o.ep=!0;const d=s(o);fetch(o.href,d)}})();const Ll="modulepreload",Fl=function(e){return"/agent-director/"+e},Jr={},dt=function(n,s,r){let o=Promise.resolve();if(s&&s.length>0){document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),m=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));o=Promise.allSettled(s.map(u=>{if(u=Fl(u),u in Jr)return;Jr[u]=!0;const f=u.endsWith(".css"),h=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${h}`))return;const g=document.createElement("link");if(g.rel=f?"stylesheet":Ll,f||(g.as="script"),g.crossOrigin="",g.href=u,m&&g.setAttribute("nonce",m),document.head.appendChild(g),f)return new Promise((v,w)=>{g.addEventListener("load",v),g.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${u}`)))})}))}function d(c){const m=new Event("vite:preloadError",{cancelable:!0});if(m.payload=c,window.dispatchEvent(m),!m.defaultPrevented)throw c}return o.then(c=>{for(const m of c||[])m.status==="rejected"&&d(m.reason);return n().catch(d)})},Bl=()=>t.jsxs("svg",{className:"logo-mark",width:"54",height:"54",viewBox:"0 0 120 120",role:"img","aria-label":"Agent Director logo",children:[t.jsx("rect",{x:"8",y:"8",width:"104",height:"104",rx:"18",className:"logo-frame"}),t.jsx("rect",{x:"24",y:"28",width:"72",height:"16",rx:"6",className:"logo-bar logo-bar-a"}),t.jsx("rect",{x:"24",y:"52",width:"72",height:"16",rx:"6",className:"logo-bar logo-bar-b"}),t.jsx("rect",{x:"24",y:"76",width:"72",height:"16",rx:"6",className:"logo-bar logo-bar-c"}),t.jsx("circle",{cx:"96",cy:"36",r:"6",className:"logo-node logo-node-a"}),t.jsx("circle",{cx:"96",cy:"60",r:"6",className:"logo-node logo-node-b"}),t.jsx("circle",{cx:"96",cy:"84",r:"6",className:"logo-node logo-node-c"})]});function ql({trace:e,traces:n=[],selectedTraceId:s,onSelectTrace:r,onReload:o,onStartTour:d,onToggleStory:c,onOpenPalette:m,onToggleExplain:u,onShareSession:f,onThemeChange:h,onMotionChange:g,densityMode:v="auto",onDensityChange:w,themeMode:j="studio",motionMode:b="balanced",activeSessions:S=1,shareStatus:C=null,handoffStatus:R=null,explainMode:K=!1,storyActive:_=!1,mode:O="cinema",missionCompletion:q,runHealthScore:P=100,modeHotkeys:L="C / F / Space",onCreateHandoffDigest:J,onOpenSupport:le,workspaces:N=[],workspaceId:T,onWorkspaceChange:D,workspaceRole:U="operator",onWorkspaceRoleChange:M,sessionLabel:ae="Active",sessionExpired:be=!1,onRenewSession:re,routeShellEnabled:Q=!1}){const[Ee,Re]=l.useState(!1),[xe,x]=l.useState(!1),Y=Ee||Q,ee=Math.max(0,Math.min(100,Math.round(P))),z=q?`${q.done}/${q.total} missions`:"Missions n/a",ge=(e==null?void 0:e.status)==="completed"?"completed ✓":(e==null?void 0:e.status)==="running"?"running ↻":(e==null?void 0:e.status)==="failed"?"failed !":"loading …";return l.useEffect(()=>{const ne=()=>{typeof window>"u"||Re(window.innerWidth<=980)};return ne(),window.addEventListener("resize",ne),()=>window.removeEventListener("resize",ne)},[]),l.useEffect(()=>{Y||x(!1)},[Y]),t.jsxs("header",{className:`header ${Q?"route-shell":""}`,"data-help":!0,"data-help-indicator":!0,"data-tour":"header","data-help-title":"Mission control","data-help-body":"Trace identity, status, and live controls live here. Use Story, Guide, or Explain to orient new viewers.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"header-title",children:[t.jsxs("div",{className:"header-logo",children:[t.jsx(Bl,{}),t.jsx("span",{children:"Agent Director"})]}),t.jsx("div",{className:"header-tagline",children:"Cinematic trace intelligence for agent runs."}),t.jsxs("div",{className:"header-meta",children:[t.jsxs("span",{className:"header-run",children:["Run: ",(e==null?void 0:e.id)??"loading"]}),n.length>0?t.jsx("select",{className:"trace-select",value:s??(e==null?void 0:e.id)??"","aria-label":"Select trace",onChange:ne=>r==null?void 0:r(ne.target.value),"data-help":!0,"data-help-title":"Trace selector","data-help-body":"Switch between available runs to compare different sessions.","data-help-placement":"bottom",children:n.map(ne=>t.jsxs("option",{value:ne.id,children:[ne.name," (",ne.id,")"]},ne.id))}):null,t.jsx("span",{className:`status-pill status-${(e==null?void 0:e.status)??"loading"}`,children:ge}),!Q&&(e!=null&&e.replay)?t.jsxs("span",{className:"header-replay header-meta-secondary",title:`Replay from ${e.branchPointStepId??"unknown step"}`,children:["Replay: ",e.replay.strategy]}):null,Q?null:t.jsxs(t.Fragment,{children:[t.jsxs("span",{className:"header-wall",children:["Wall: ",(e==null?void 0:e.metadata.wallTimeMs)??0,"ms"]}),t.jsxs("span",{className:"header-presence header-meta-secondary","aria-label":"Active sessions",children:["Live: ",S]}),t.jsxs("span",{className:"header-mode-pill header-meta-secondary","aria-label":"Current mode",children:["Mode: ",O]}),T?t.jsxs("span",{className:"header-workspace-pill header-meta-secondary","aria-label":"Current workspace",children:["Workspace: ",T]}):null,t.jsxs("span",{className:`header-role-pill role-${U} header-meta-secondary`,"aria-label":"Current workspace role",children:["Role: ",U]})]}),t.jsxs("span",{className:`header-session-pill ${be?"expired":""} header-meta-secondary`,"aria-label":"Session status",children:["Session: ",ae]}),Q?null:t.jsxs(t.Fragment,{children:[t.jsxs("span",{className:"header-hotkeys header-meta-secondary","aria-label":"Mode hotkeys",children:["Keys: ",L]}),t.jsx("span",{className:"header-mission header-meta-secondary","aria-label":"Mission completion",children:z}),t.jsxs("span",{className:"header-health","aria-label":`Run health score ${ee}`,children:[t.jsx("span",{className:"header-health-bar",children:t.jsx("span",{className:"header-health-fill",style:{width:`${ee}%`}})}),t.jsxs("span",{children:["Health ",ee]})]}),C?t.jsx("span",{className:"header-share-status header-meta-secondary",children:C}):null,R?t.jsx("span",{className:"header-share-status header-meta-secondary",children:R}):null]})]})]}),t.jsxs("div",{className:"header-actions",children:[t.jsxs("div",{className:"header-actions-primary",children:[Q?null:t.jsxs("label",{className:"theme-picker",children:["Workspace",t.jsx("select",{className:"trace-select",value:T,"aria-label":"Select workspace",onChange:ne=>D==null?void 0:D(ne.target.value),children:N.map(ne=>t.jsx("option",{value:ne.id,children:ne.label},ne.id))})]}),Q?null:t.jsxs("label",{className:"theme-picker",children:["Role",t.jsxs("select",{className:"trace-select",value:U,"aria-label":"Select workspace role",onChange:ne=>M==null?void 0:M(ne.target.value),children:[t.jsx("option",{value:"viewer",children:"Viewer"}),t.jsx("option",{value:"operator",children:"Operator"}),t.jsx("option",{value:"admin",children:"Admin"})]})]}),Q?null:t.jsx("button",{className:`ghost-button ${_?"active":""}`,type:"button",onClick:c,"aria-pressed":_,"aria-label":"Toggle story mode","data-help":!0,"data-help-title":"Story mode","data-help-body":"Auto-runs a cinematic walkthrough for demos.","data-help-placement":"bottom",children:"Story"}),Q?null:t.jsx("button",{className:"ghost-button",type:"button",onClick:d,"aria-label":"Start guided tour","data-help":!0,"data-help-title":"Guided tour","data-help-body":"Walk through the interface step by step.","data-help-placement":"bottom",children:"Guide"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:m,"aria-label":"Open command palette","data-help":!0,"data-help-title":"Command palette","data-help-body":"Search and trigger any action instantly.","data-help-placement":"bottom",children:"Command"}),Q?null:t.jsx("button",{className:`ghost-button ${K?"active":""}`,type:"button",onClick:u,"aria-pressed":K,"aria-label":"Toggle explain mode","data-help":!0,"data-help-title":"Explain mode","data-help-body":"Hover any control to see contextual guidance.","data-help-placement":"bottom",children:"Explain"}),Y?t.jsx("button",{className:`ghost-button header-actions-toggle ${xe?"active":""}`,type:"button","aria-expanded":xe,"aria-controls":"header-secondary-actions",onClick:()=>x(ne=>!ne),children:xe?"Fewer actions":"More actions"}):null]}),t.jsxs("div",{id:"header-secondary-actions",className:`header-actions-secondary ${!Y||xe?"open":""}`,children:[Q?null:t.jsxs("label",{className:"theme-picker",children:["Theme",t.jsxs("select",{className:"trace-select",value:j,"aria-label":"Select theme",onChange:ne=>h==null?void 0:h(ne.target.value),children:[t.jsx("option",{value:"studio",children:"Studio"}),t.jsx("option",{value:"focus",children:"Focus"}),t.jsx("option",{value:"contrast",children:"Contrast"})]})]}),Q?null:t.jsxs("label",{className:"theme-picker",children:["Motion",t.jsxs("select",{className:"trace-select",value:b,"aria-label":"Select motion profile",onChange:ne=>g==null?void 0:g(ne.target.value),children:[t.jsx("option",{value:"cinematic",children:"Cinematic"}),t.jsx("option",{value:"balanced",children:"Balanced"}),t.jsx("option",{value:"minimal",children:"Minimal"})]})]}),Q?null:t.jsxs("label",{className:"theme-picker",children:["Density",t.jsxs("select",{className:"trace-select",value:v,"aria-label":"Select density profile",onChange:ne=>w==null?void 0:w(ne.target.value),children:[t.jsx("option",{value:"auto",children:"Auto"}),t.jsx("option",{value:"comfortable",children:"Comfortable"}),t.jsx("option",{value:"compact",children:"Compact"})]})]}),t.jsx("button",{className:"ghost-button",onClick:o,type:"button","aria-label":"Refresh traces",title:"Refresh traces","data-help":!0,"data-help-title":"Refresh","data-help-body":"Reload traces from the data store.","data-help-placement":"bottom",children:"Refresh"}),t.jsx("button",{className:`ghost-button ${be?"warn":""}`,type:"button",onClick:re,"aria-label":"Renew workspace session",title:"Renew workspace session",children:"Renew Session"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:f,"aria-label":"Copy live session link",title:"Copy live session link",children:"Share"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:J,"aria-label":"Copy session handoff digest",title:"Copy session handoff digest",children:"Handoff"}),Q?null:t.jsx("button",{className:"ghost-button",type:"button",onClick:le,"aria-label":"Open support diagnostics",title:"Open support diagnostics",children:"Support"}),t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer","data-help":!0,"data-help-title":"Help","data-help-body":"Open quick docs for first run, key flows, troubleshooting, and shortcuts.","data-help-placement":"bottom",children:"Help"}),null]})]})]})}function zl({insights:e,investigation:n,onSelectStep:s,onJumpToBottleneck:r,onJumpToError:o}){var v,w,j,b,S;if(!e)return null;const d=e.timing,c=e.ioWarnings??[],m=e.concurrency,u=e.retryPatterns,f=e.costByTool??{},h=e.costByModel??{},g=((v=n==null?void 0:n.hypotheses)==null?void 0:v.slice(0,2))??[];return t.jsxs("section",{className:"insight-strip","data-help":!0,"data-help-indicator":!0,"data-tour":"insights","data-help-title":"Run insights","data-help-body":"Fast diagnostics for latency, cost, errors, and concurrency. Click chips to jump into the trace.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Top latency","data-help-body":"Largest steps by duration; jump straight to the slowest.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Top latency"}),t.jsxs("div",{className:"insight-items",children:[e.topLatencySteps.map(C=>t.jsxs("button",{className:"insight-chip",type:"button",title:`Jump to ${C.name}`,onClick:()=>s==null?void 0:s(C.stepId),children:[C.name," (",C.durationMs,"ms)"]},C.stepId)),e.topLatencySteps.length>0?t.jsx("button",{className:"insight-chip",type:"button",onClick:r,title:"Jump to longest step",children:"Jump to bottleneck"}):null]})]}),t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Cost by type","data-help-body":"Aggregated spend by step class.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Cost by type"}),t.jsx("div",{className:"insight-items",children:Object.entries(e.costByType).map(([C,R])=>t.jsxs("span",{className:"insight-chip",title:`Total cost for ${C}`,children:[C,": $",R.toFixed(3)]},C))})]}),Object.keys(f).length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Cost by tool","data-help-body":"Top tools by total spend.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Cost by tool"}),t.jsx("div",{className:"insight-items",children:Object.entries(f).sort((C,R)=>R[1]-C[1]).slice(0,3).map(([C,R])=>t.jsxs("span",{className:"insight-chip",title:`Total cost for ${C}`,children:[C,": $",R.toFixed(3)]},C))})]}):null,t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Errors & retries","data-help-body":"Instant visibility into failed or retried steps.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Errors / retries"}),t.jsxs("div",{className:"insight-items",children:[t.jsxs("span",{className:"insight-chip",children:["Errors: ",e.errors]}),t.jsxs("span",{className:"insight-chip",children:["Retries: ",e.retries]}),e.errors>0?t.jsx("button",{className:"insight-chip",type:"button",onClick:o,title:"Jump to first error",children:"Jump to first error"}):null,(w=u==null?void 0:u.topRetries)!=null&&w.length?t.jsxs("span",{className:"insight-chip",title:`Retry rate ${(u.retryRate*100).toFixed(1)}%`,children:["Top retries: ",u.topRetries.length]}):null]})]}),t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Wall vs work","data-help-body":"Wall time vs summed work to show parallelism.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Wall vs work"}),t.jsxs("div",{className:"insight-items",children:[t.jsxs("span",{className:"insight-chip",title:"Wall clock duration",children:["Wall: ",e.wallTimeMs,"ms"]}),t.jsxs("span",{className:"insight-chip",title:"Sum of step durations",children:["Work: ",e.workTimeMs,"ms"]}),e.criticalPathMs!=null?t.jsxs("span",{className:"insight-chip",title:"Longest parent-child chain",children:["Critical: ",e.criticalPathMs,"ms"]}):null]})]}),t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Health","data-help-body":"Timing and I/O anomalies detected in the trace.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Health"}),t.jsxs("div",{className:"insight-items",children:[d!=null&&d.degraded?t.jsx("span",{className:"insight-chip insight-warning",title:d.issues.join(" "),children:"Timing degraded"}):t.jsx("span",{className:"insight-chip",children:"Timing OK"}),c.length>0?t.jsxs("span",{className:"insight-chip insight-warning",title:c.map(C=>C.message).join(" "),children:["IO warnings: ",c.length]}):t.jsx("span",{className:"insight-chip",children:"IO OK"})]})]}),g.length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Investigator","data-help-body":"Automated root-cause hypotheses ranked by severity and confidence.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Investigator"}),t.jsxs("div",{className:"insight-items",children:[g.map(C=>t.jsxs("span",{className:"insight-chip",title:C.summary,children:[C.title," (",Math.round(C.confidence*100),"%)"]},C.id)),(b=(j=g[0])==null?void 0:j.evidenceStepIds)!=null&&b[0]?t.jsx("button",{className:"insight-chip",type:"button",onClick:()=>s==null?void 0:s(g[0].evidenceStepIds[0]),children:"Jump to evidence"}):null]})]}):null,(S=m==null?void 0:m.buckets)!=null&&S.length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Parallelism","data-help-body":"How many steps ran concurrently over time.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Parallelism"}),t.jsx("div",{className:"insight-items",children:t.jsx("div",{className:"insight-heatmap",title:`Peak concurrency: ${m.peak}`,children:m.buckets.map((C,R)=>t.jsx("span",{className:"heatmap-bar",style:{height:`${Math.max(20,C.active/Math.max(1,m.peak)*48)}px`},title:`Bucket ${R+1}: ${C.active} active`},`${C.startMs}-${C.endMs}`))})})]}):null,Object.keys(h).length?t.jsxs("div",{className:"insight-block","data-help":!0,"data-help-title":"Model cost","data-help-body":"Spend by model family.","data-help-placement":"bottom",children:[t.jsx("span",{className:"insight-label",children:"Model cost"}),t.jsx("div",{className:"insight-items",children:Object.entries(h).map(([C,R])=>t.jsxs("span",{className:"insight-chip",title:`Total cost for ${C}`,children:[C,": $",R.toFixed(3)]},C))})]}):null]})}const Gl=["all","llm_call","tool_call","decision","handoff","guardrail"];function Ul({query:e,typeFilter:n,onQueryChange:s,onTypeFilterChange:r}){return t.jsxs("div",{className:"search-bar",children:[t.jsx("input",{className:"search-input",placeholder:"Search steps, tools, previews...","aria-label":"Search steps",value:e,onChange:o=>s(o.target.value),"data-help":!0,"data-help-title":"Search","data-help-body":"Filter steps by name, tool, or payload preview. Great for fast recall.","data-help-placement":"bottom"}),t.jsx("select",{className:"search-select",value:n,"aria-label":"Filter by step type",onChange:o=>r(o.target.value),"data-help":!0,"data-help-title":"Type filter","data-help-body":"Narrow the timeline to a specific class of steps (LLM, tool, decision, handoff).","data-help-placement":"bottom",children:Gl.map(o=>t.jsx("option",{value:o,children:o},o))})]})}function Za(e,n,s){const r=Date.parse(e),o=s.map(h=>Date.parse(h.endedAt??h.startedAt)).filter(h=>Number.isFinite(h)),d=n?Date.parse(n):o.length?Math.max(...o):r,c=Math.max(1,d-r),m=s.map(h=>{const g=Math.max(0,Date.parse(h.startedAt)-r),v=Math.max(g,Date.parse(h.endedAt??h.startedAt)-r);return{stepId:h.id,startMs:g,endMs:v}}).sort((h,g)=>h.startMs-g.startMs||h.endMs-g.endMs),u=[],f=[];for(const h of m){let g=u.findIndex(v=>v<=h.startMs);g===-1?(g=u.length,u.push(h.endMs)):u[g]=h.endMs,f.push({stepId:h.stepId,startMs:h.startMs,endMs:h.endMs,lane:g,xPct:h.startMs/c*100,wPct:Math.max(.75,(h.endMs-h.startMs)/c*100)})}return{wallTimeMs:c,intervals:f,laneCount:u.length}}function Hl(e){var j;const s=e.steps.map(b=>({stepId:b.id,name:b.name,durationMs:b.durationMs??0})).sort((b,S)=>S.durationMs-b.durationMs).slice(0,3),r={},o={};for(const b of e.steps)((j=b.metrics)==null?void 0:j.costUsd)!=null&&(r[b.type]=(r[b.type]??0)+b.metrics.costUsd,b.type==="tool_call"&&(o[b.name]=(o[b.name]??0)+b.metrics.costUsd));const d=e.steps.filter(b=>b.status==="failed").length,c=e.steps.filter(b=>!!b.retryOfStepId).length,m=e.metadata.wallTimeMs,u=e.metadata.workTimeMs??e.steps.reduce((b,S)=>b+(S.durationMs??0),0),f=Vl(e),h=Jl(e.steps),g=Kl(e.steps),v=Ql(e),w=Yl(e.steps);return{topLatencySteps:s,costByType:r,costByTool:o,costByModel:{[e.metadata.modelId]:e.metadata.totalCostUsd??0},errors:d,retries:c,wallTimeMs:m,workTimeMs:u,timing:f,ioWarnings:h,criticalPathMs:g,concurrency:v,retryPatterns:w}}function Wl(e){var s;const n=(s=e.metrics)==null?void 0:s.costUsd;return n==null?null:`$${n.toFixed(3)}`}function ct(e){if(!e)return null;const n=Date.parse(e);return Number.isNaN(n)?null:n}function Vl(e){const n=ct(e.startedAt),s=ct(e.endedAt??void 0),r=[],o=[],d=[];return n==null&&d.push("Trace start time missing or invalid."),e.steps.forEach(c=>{const m=ct(c.startedAt),u=ct(c.endedAt??c.startedAt);if(m==null||u==null){r.push(c.id);return}if(u<m){o.push(c.id);return}n!=null&&m<n&&o.push(c.id),s!=null&&u>s&&o.push(c.id)}),r.length&&d.push(`Missing timestamps on ${r.length} steps.`),o.length&&d.push(`Timestamp skew detected on ${o.length} steps.`),{degraded:!!(r.length||o.length||n==null),issues:d,missingStepIds:r,skewedStepIds:o}}function Jl(e){const n=new Map;e.forEach(d=>{d.type==="tool_call"&&d.toolCallId&&n.set(d.toolCallId,d)});const s=new Set,r=new Set,o=[];return e.forEach(d=>{d.type!=="llm_call"||!d.io||((d.io.emittedToolCallIds??[]).forEach(c=>{s.add(c),n.has(c)||o.push({kind:"missing_tool_step",message:`Emitted toolCallId ${c} has no tool step.`,stepId:d.id,toolCallId:c})}),(d.io.consumedToolCallIds??[]).forEach(c=>{r.add(c),n.has(c)||o.push({kind:"missing_tool_step",message:`Consumed toolCallId ${c} has no tool step.`,stepId:d.id,toolCallId:c}),s.has(c)||o.push({kind:"consume_without_emit",message:`Consumed toolCallId ${c} without emission.`,stepId:d.id,toolCallId:c})}))}),n.forEach((d,c)=>{s.has(c)||o.push({kind:"unemitted_tool",message:`Tool step ${d.id} has toolCallId ${c} never emitted.`,stepId:d.id,toolCallId:c}),r.has(c)||o.push({kind:"unconsumed_tool",message:`Tool step ${d.id} has toolCallId ${c} never consumed.`,stepId:d.id,toolCallId:c})}),o}function Kl(e){const n=new Map,s=new Map,r=[];e.forEach(c=>{if(n.set(c.id,c.durationMs??0),c.parentStepId){const m=s.get(c.parentStepId)??[];m.push(c.id),s.set(c.parentStepId,m)}else r.push(c.id)});const o=new Map,d=c=>{if(o.has(c))return o.get(c)??0;const u=(s.get(c)??[]).reduce((h,g)=>Math.max(h,d(g)),0),f=(n.get(c)??0)+u;return o.set(c,f),f};return r.length?Math.max(...r.map(c=>d(c))):0}function Ql(e){const n=ct(e.startedAt);if(n==null)return{buckets:[],peak:0};const s=ct(e.endedAt??void 0)??Math.max(...e.steps.map(u=>ct(u.endedAt??u.startedAt)??n),n),r=Math.max(1,s-n),o=12,d=Math.max(1,Math.floor(r/o)),c=[];let m=0;for(let u=0;u<o;u+=1){const f=n+u*d,h=f+d;let g=0;e.steps.forEach(v=>{const w=ct(v.startedAt),j=ct(v.endedAt??v.startedAt);w==null||j==null||j>=f&&w<=h&&(g+=1)}),m=Math.max(m,g),c.push({startMs:u*d,endMs:(u+1)*d,active:g})}return{buckets:c,peak:m}}function Yl(e){const n={};e.forEach(o=>{o.retryOfStepId&&(n[o.retryOfStepId]=(n[o.retryOfStepId]??0)+1)});const s=Object.values(n).reduce((o,d)=>o+d,0),r=Object.entries(n).sort((o,d)=>d[1]-o[1]).slice(0,3);return{totalRetries:s,retryRate:e.length?s/e.length:0,topRetries:r.map(([o,d])=>({stepId:o,count:d}))}}const Xl={llm_call:{label:"LLM",icon:"LLM",description:"Model call"},tool_call:{label:"TOOL",icon:"TOOL",description:"Tool call"},decision:{label:"DEC",icon:"DEC",description:"Decision"},handoff:{label:"HAND",icon:"HAND",description:"Handoff"},guardrail:{label:"GUARD",icon:"GUARD",description:"Guardrail"}};function Zl(e){return Xl[e]}function ec({type:e,size:n="sm",showLabel:s=!1}){const r=Zl(e);return t.jsxs("span",{className:`step-badge step-badge-${e} step-badge-${n}`,title:r.description,children:[t.jsx("span",{className:"step-badge-icon",children:r.icon}),s?t.jsx("span",{className:"step-badge-label",children:r.label}):null]})}function Do({step:e,interval:n,playbackState:s,selected:r,onSelect:o,variant:d="base",diffStatus:c,disabled:m=!1,laneHeight:u=140}){var _,O,q,P,L,J;const f=Wl(e),h=((_=e.preview)==null?void 0:_.subtitle)??((O=e.preview)==null?void 0:O.title)??"",g=((q=e.preview)==null?void 0:q.outputPreview)??((P=e.preview)==null?void 0:P.inputPreview)??"",v=c?`step-diff-${c}`:"",w=d==="ghost"?"step-ghost":"",j=n.wPct<8?"step-compact":"",b=e.type.replace("_"," ").toUpperCase(),S=((L=e.metrics)==null?void 0:L.tokensTotal)!=null?`${e.metrics.tokensTotal} tokens`:null,C=e.durationMs!=null?`${e.durationMs}ms`:null,R=[S,C,f].filter(Boolean).join(" · "),K=`Click to inspect inputs/outputs and replay from this moment.${R?` ${R}.`:""}`;return t.jsxs("button",{type:"button",className:`step-card step-${e.type} step-${s} ${r?"step-selected":""} ${v} ${w} ${j}`,"data-step-id":e.id,"aria-pressed":r,"aria-hidden":d==="ghost",disabled:m,"data-help":!0,"data-help-title":`${e.name} · ${b}`,"data-help-body":K,"data-help-placement":"top",style:{left:`${n.xPct}%`,width:`${n.wPct}%`,top:`${n.lane*u}px`},onClick:()=>{m||o(e.id)},children:[t.jsxs("div",{className:"step-card-header",children:[t.jsxs("div",{className:"step-title-group",children:[t.jsx(ec,{type:e.type}),t.jsx("span",{className:"step-title",children:e.name})]}),t.jsx("span",{className:`status-pill status-${e.status}`,children:e.status})]}),h?t.jsx("div",{className:"step-subtitle",children:h}):null,t.jsxs("div",{className:"step-metrics",children:[((J=e.metrics)==null?void 0:J.tokensTotal)!=null?t.jsxs("span",{children:[e.metrics.tokensTotal," tok"]}):null,e.durationMs!=null?t.jsxs("span",{children:[e.durationMs,"ms"]}):null,f?t.jsx("span",{children:f}):null]}),g?t.jsx("div",{className:"step-preview",children:g}):null]})}function Oo(e,n){return n<e.startMs?"future":n>e.endMs?"past":"active"}const ja={type:{order:[],hidden:[]},status:{order:[],hidden:[]},parent:{order:[],hidden:[]}};function ks(e,n){return n==="type"?e.type:n==="status"?e.status:e.parentStepId??"root"}function tc(e,n){const s=new Set;return e.forEach(r=>s.add(ks(r,n))),Array.from(s).sort((r,o)=>r.localeCompare(o))}function Kr(e,n,s){const r=new Set(e),o=[...n.filter(c=>r.has(c))];e.forEach(c=>{o.includes(c)||o.push(c)});const d=Array.from(new Set(s.filter(c=>r.has(c))));return{order:o,hidden:d}}const ac=140,nc=132,sc=96,Qr={llm_call:1,tool_call:2,decision:3,handoff:4,guardrail:5};function Ao(e){return[...e].sort((n,s)=>(Qr[n.type]??9)-(Qr[s.type]??9))}function rc(e,n,s,r,o){const d=new Map;n.forEach(v=>{var j;const w=ks(v,s);d.has(w)||d.set(w,[]),(j=d.get(w))==null||j.push(v)});const c=Array.from(d.keys()),m=[...r.filter(v=>c.includes(v))];c.forEach(v=>{m.includes(v)||m.push(v)});const u=m.filter(v=>!o.includes(v)),f=new Map;let h=0,g=0;return u.forEach(v=>{const w=d.get(v)??[],j=Za(e.startedAt,e.endedAt,w);j.intervals.forEach(b=>{f.set(b.stepId,{...b,lane:b.lane+h})}),h+=Math.max(1,j.laneCount)}),g=Math.max(1,h),{intervalsByStepId:f,laneCount:g,visibleGroups:u}}function oc({trace:e,steps:n,selectedStepId:s,onSelectStep:r,playheadPct:o,playheadMs:d,windowRange:c,ghostTrace:m,diff:u,laneStrategy:f="type",laneGroupsOrder:h=[],hiddenLaneGroups:g=[],laneHeight:v=ac,cardHeight:w=nc,compactHeight:j=sc}){const{intervalsByStepId:b,laneCount:S}=rc(e,n,f,h,g),C=Array.from(b.values()),R=new Map(C.map(N=>[N.stepId,N])),K=Ao(n),_=e.metadata.wallTimeMs||1,O=new Set((u==null?void 0:u.removedSteps)??[]),q=new Set((u==null?void 0:u.changedSteps)??[]),P=new Set(((u==null?void 0:u.changedPairs)??[]).map(N=>N.rightId)),L=new Set((u==null?void 0:u.addedSteps)??[]);let J=C;if(c){const N=c.endMs-c.startMs,T=Math.max(1e3,N*.15),D=Math.max(0,c.startMs-T),U=c.endMs+T;if(J=C.filter(M=>M.endMs>=D&&M.startMs<=U),s&&!J.some(M=>M.stepId===s)){const M=R.get(s);M&&(J=[...J,M])}}const le=new Set(J.map(N=>N.stepId));return t.jsx("div",{className:"timeline",style:{"--step-card-height":`${w}px`,"--step-compact-height":`${j}px`},children:t.jsxs("div",{className:"timeline-grid",style:{height:`${S*v}px`},"data-help":!0,"data-help-title":"Timeline lanes","data-help-body":"Each lane stacks overlapping steps; width reflects duration.","data-help-placement":"top",children:[t.jsx("div",{className:"playback-cursor",style:{left:`${o}%`}}),K.filter(N=>le.has(N.id)).filter(N=>!g.includes(ks(N,f))).map(N=>{const T=R.get(N.id);if(!T)return null;const D=Oo(T,d);return t.jsx(Do,{step:N,interval:T,playbackState:D,selected:s===N.id,diffStatus:O.has(N.id)?"removed":q.has(N.id)?"changed":null,laneHeight:v,onSelect:r},N.id)}),m?t.jsx(ic,{ghostTrace:m,baseWallTimeMs:_,playheadMs:d,windowRange:c,diffAdded:L,diffChanged:P,laneHeight:v}):null]})})}function ic({ghostTrace:e,baseWallTimeMs:n,playheadMs:s,windowRange:r,diffAdded:o,diffChanged:d,laneHeight:c}){const{intervals:m,laneCount:u}=Za(e.startedAt,e.endedAt,e.steps),f=new Map(m.map(b=>[b.stepId,b])),h=e.metadata.wallTimeMs||1,g=s/n*h;let v=m;if(r){const b=r.endMs-r.startMs,S=Math.max(1e3,b*.15),C=h/n,R=Math.max(0,(r.startMs-S)*C),K=Math.min(h,(r.endMs+S)*C);v=m.filter(_=>_.endMs>=R&&_.startMs<=K)}const w=new Set(v.map(b=>b.stepId)),j=Ao(e.steps);return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"ghost-lanes",style:{height:`${u*c}px`}}),j.filter(b=>w.has(b.id)).map(b=>{const S=f.get(b.id);if(!S)return null;const C=Oo(S,g),R=o.has(b.id)?"added":d.has(b.id)?"changed":null;return t.jsx(Do,{step:b,interval:S,playbackState:C,selected:!1,diffStatus:R,variant:"ghost",disabled:!0,laneHeight:c,onSelect:()=>{}},`ghost-${b.id}`)})]})}function lc({trace:e,steps:n,selectedStepId:s,onSelectStep:r,playheadMs:o,windowRange:d,timing:c,ghostTrace:m,diff:u,laneStrategy:f,laneGroupsOrder:h,hiddenLaneGroups:g,onLaneStrategyChange:v,onToggleLaneGroupVisibility:w,onMoveLaneGroup:j}){const b=e.metadata.wallTimeMs||1,S=Math.min(100,Math.max(0,o/b*100)),C=h.filter(R=>!g.includes(R)).length;return t.jsxs("section",{className:"cinema-mode","aria-label":"Cinema mode",children:[c!=null&&c.degraded?t.jsxs("div",{className:"timing-banner",title:c.issues.join(" "),children:["Timing degraded: ",c.issues[0]??"Check timestamps."]}):null,t.jsxs("div",{className:"timeline-studio-panel","data-help":!0,"data-help-title":"Timeline studio","data-help-body":"Regroup lanes by type/status/parent, hide noisy groups, and reorder emphasis.",children:[t.jsxs("label",{className:"timeline-studio-strategy",children:["Lane strategy",t.jsxs("select",{value:f,onChange:R=>v(R.target.value),children:[t.jsx("option",{value:"type",children:"Type"}),t.jsx("option",{value:"status",children:"Status"}),t.jsx("option",{value:"parent",children:"Parent branch"})]})]}),t.jsxs("div",{className:"timeline-studio-summary",children:[C,"/",h.length," groups visible"]}),t.jsx("div",{className:"timeline-studio-groups",children:h.map((R,K)=>{const _=g.includes(R);return t.jsxs("div",{className:`timeline-studio-group ${_?"is-hidden":""}`,children:[t.jsx("button",{type:"button",className:"ghost-button",onClick:()=>w(R),children:_?"Show":"Hide"}),t.jsx("span",{className:"timeline-studio-group-name",children:R}),t.jsx("button",{type:"button",className:"ghost-button",onClick:()=>j(R,"up"),disabled:K===0,children:"Up"}),t.jsx("button",{type:"button",className:"ghost-button",onClick:()=>j(R,"down"),disabled:K===h.length-1,children:"Down"})]},R)})})]}),t.jsx(oc,{trace:e,steps:n,selectedStepId:s,onSelectStep:r,playheadPct:S,playheadMs:o,windowRange:d,ghostTrace:m,diff:u,laneStrategy:f,laneGroupsOrder:h,hiddenLaneGroups:g})]})}const cc=[.5,1,1.5,2,4];function Yr({playheadMs:e,wallTimeMs:n,isPlaying:s,speed:r,onToggle:o,onScrub:d,onSpeedChange:c}){const m=u=>{d(Number(u.target.value))};return t.jsxs("div",{className:"playback-controls",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:o,"aria-label":s?"Pause playback":"Play playback","data-help":!0,"data-help-title":"Playhead","data-help-body":"Start or pause the run to experience timing as it unfolded.","data-help-placement":"bottom",children:s?"Pause":"Play"}),t.jsx("input",{className:"playback-slider",type:"range",min:0,max:n,value:e,"aria-label":"Playback position",onChange:m,"data-help":!0,"data-help-title":"Scrub timeline","data-help-body":"Drag to jump to any moment in the run.","data-help-placement":"bottom"}),t.jsx("select",{className:"playback-speed",value:r,"aria-label":"Playback speed",onChange:u=>c(Number(u.target.value)),"data-help":!0,"data-help-title":"Speed","data-help-body":"Slow down to inspect or speed up to skim.","data-help-placement":"bottom",children:cc.map(u=>t.jsxs("option",{value:u,children:[u,"x"]},u))})]})}function dc(e,n,s,r=60){const{wallTimeMs:o,intervals:d}=Za(e,n,s),c=new Array(r).fill(0);if(!o)return{buckets:c,wallTimeMs:0};const m=o/r;return!Number.isFinite(m)||m<=0?{buckets:c,wallTimeMs:o}:(d.forEach(u=>{const f=Math.max(0,Math.floor(u.startMs/m)),h=Math.min(r-1,Math.floor(u.endMs/m));for(let g=f;g<=h;g+=1)c[g]+=1}),{buckets:c,wallTimeMs:o})}function uc(e,n){const s=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),r=URL.createObjectURL(s),o=document.createElement("a");o.href=r,o.download=e,document.body.appendChild(o),o.click(),o.remove(),URL.revokeObjectURL(r)}function ns(e,n,s="text/plain"){const r=new Blob([n],{type:s}),o=URL.createObjectURL(r),d=document.createElement("a");d.href=o,d.download=e,document.body.appendChild(d),d.click(),d.remove(),URL.revokeObjectURL(o)}const ka=5e3,pc=32;function He(e,n,s){return Math.min(s,Math.max(n,e))}function oa(e,n){const s=new Set;return e.forEach(r=>{s.add(He(Math.round(r),0,n))}),Array.from(s).sort((r,o)=>r-o).slice(0,pc)}function mc(e,n){if(!e)return{bookmarksMs:[],clipStartMs:null,clipEndMs:null,segments:[]};try{const s=JSON.parse(e),r=oa(Array.isArray(s.bookmarksMs)?s.bookmarksMs:[],n),o=typeof s.clipStartMs=="number"?He(s.clipStartMs,0,n):null,d=typeof s.clipEndMs=="number"?He(s.clipEndMs,0,n):null,c=Array.isArray(s.segments)?s.segments.filter(m=>typeof(m==null?void 0:m.id)=="string"&&typeof(m==null?void 0:m.startMs)=="number"&&typeof(m==null?void 0:m.endMs)=="number"&&typeof(m==null?void 0:m.label)=="string").map(m=>({...m,startMs:He(m.startMs,0,n),endMs:He(m.endMs,0,n)})):[];return{bookmarksMs:r,clipStartMs:o,clipEndMs:o!=null&&d!=null&&d<o?o:d,segments:c}}catch{return{bookmarksMs:[],clipStartMs:null,clipEndMs:null,segments:[]}}}function Xr(e,n){const s=Date.parse(e);return Number.isNaN(s)?null:new Date(s+n).toISOString()}function hc({traceStart:e,traceEnd:n,steps:s,playheadMs:r,windowRange:o,windowed:d,spanMs:c,onSpanChange:m,onToggleWindowed:u,onScrub:f,persistenceKey:h,laneStrategy:g="type",visibleLaneGroups:v=[],remotePlayheads:w=[]}){const{buckets:j,wallTimeMs:b}=dc(e,n,s,64),S=Math.max(1,...j),C=He(c,ka,Math.max(ka,b)),R=(o==null?void 0:o.startMs)??0,K=(o==null?void 0:o.endMs)??b,_=l.useMemo(()=>`agentDirector.timelineStudio.${h??e}`,[h,e]),[O,q]=l.useState([]),[P,L]=l.useState(null),[J,le]=l.useState(null),[N,T]=l.useState([]),[D,U]=l.useState("");l.useEffect(()=>{const E=mc(window.localStorage.getItem(_),b);q(E.bookmarksMs),L(E.clipStartMs),le(E.clipEndMs),T(E.segments)},[_,b]),l.useEffect(()=>{const E={bookmarksMs:oa(O,b),clipStartMs:P==null?null:He(P,0,b),clipEndMs:J==null?null:He(J,0,b),segments:N};window.localStorage.setItem(_,JSON.stringify(E))},[O,J,P,N,_,b]);const M=b?R/b*100:0,ae=b?(K-R)/b*100:100,be=b?r/b*100:0,re=P!=null&&J!=null?Math.min(P,J):null,Q=P!=null&&J!=null?Math.max(P,J):null,Ee=re!=null&&Q!=null&&b?(Q-re)/b*100:0,Re=re!=null&&b?re/b*100:0,xe=re!=null&&Q!=null&&Q>re,x=E=>{const se=E.currentTarget.getBoundingClientRect(),Ne=(E.clientX-se.left)/se.width,De=He(Math.round(Ne*b),0,b);f(De)},Y=E=>{if(E.key==="ArrowLeft"){E.preventDefault(),f(He(r-Math.max(250,Math.round(b*.02)),0,b));return}if(E.key==="ArrowRight"){E.preventDefault(),f(He(r+Math.max(250,Math.round(b*.02)),0,b));return}if(E.key==="Home"){E.preventDefault(),f(0);return}if(E.key==="End"){E.preventDefault(),f(b);return}(E.key===" "||E.key==="Enter")&&(E.preventDefault(),f(r))},ee=()=>{q(E=>oa([...E,r],b))},z=E=>{if(O.length===0)return;const se=oa(O,b);if(E==="previous"){const De=[...se].reverse().find(Oe=>Oe<r)??se[se.length-1];f(De);return}const Ne=se.find(De=>De>r)??se[0];f(Ne)},ge=()=>{const E=He(r,0,b);L(E),J!=null&&J<E&&le(E)},ne=()=>{const E=He(r,0,b);le(E),P!=null&&P>E&&L(E)},B=()=>{L(null),le(null)},zt=()=>{if(!xe||re==null||Q==null)return;const E=D.trim()||`Scene ${N.length+1}`,se=`segment-${Math.random().toString(36).slice(2,9)}`;T(Ne=>[...Ne,{id:se,startMs:re,endMs:Q,label:E}]),U("")},Be=E=>{T(se=>se.filter(Ne=>Ne.id!==E))},je=()=>{if(!xe||re==null||Q==null)return;const E={type:"agent-director-clip",traceStart:e,traceEnd:n,clip:{startMs:re,endMs:Q,startAt:Xr(e,re),endAt:Xr(e,Q)},bookmarksMs:oa(O,b).filter(se=>se>=re&&se<=Q),playheadMs:r,laneContext:{strategy:g,visibleGroups:v},segments:N.filter(se=>se.endMs>=re&&se.startMs<=Q),exportedAt:new Date().toISOString()};uc(`agent-director-clip-${re}-${Q}.json`,E)};return t.jsxs("div",{className:"mini-timeline",children:[t.jsxs("div",{className:"mini-track",onClick:x,role:"slider",tabIndex:0,"aria-label":"Timeline density map","aria-valuemin":0,"aria-valuemax":b,"aria-valuenow":r,"aria-valuetext":`${r} milliseconds`,onKeyDown:Y,"data-help":!0,"data-help-title":"Density map","data-help-body":"A compact view of activity density. Click to jump the playhead.","data-help-placement":"top",children:[t.jsx("div",{className:"mini-bars",children:j.map((E,se)=>t.jsx("span",{className:"mini-bar",style:{height:`${E/S*100}%`}},`bucket-${se}`))}),t.jsx("div",{className:"mini-window",style:{left:`${M}%`,width:`${ae}%`,opacity:d?1:.4}}),xe?t.jsx("div",{className:"mini-clip-window",style:{left:`${Re}%`,width:`${Ee}%`}}):null,t.jsx("div",{className:"mini-bookmark-markers","data-testid":"timeline-bookmark-markers","aria-hidden":"true",children:oa(O,b).map(E=>{const se=b?E/b*100:0;return t.jsx("button",{type:"button",className:"mini-bookmark-marker",style:{left:`${se}%`},onClick:Ne=>{Ne.stopPropagation(),f(E)},title:`Jump to bookmark at ${E}ms`,"aria-label":`Bookmark ${E} milliseconds`},`bookmark-${E}`)})}),t.jsx("div",{className:"mini-remote-markers","aria-hidden":"true",children:w.map((E,se)=>{const Ne=b?E/b*100:0;return t.jsx("span",{className:"mini-remote-marker",style:{left:`${Ne}%`}},`remote-${se}`)})}),t.jsx("div",{className:"mini-segments","aria-hidden":"true",children:N.map(E=>{const se=b?E.startMs/b*100:0,Ne=b?(E.endMs-E.startMs)/b*100:0;return t.jsx("span",{className:"mini-segment-bar",style:{left:`${se}%`,width:`${Math.max(1,Ne)}%`},title:E.label},E.id)})}),t.jsx("div",{className:"mini-playhead",style:{left:`${be}%`}})]}),t.jsxs("div",{className:"mini-controls",children:[t.jsx("label",{className:"mini-label",children:"Zoom"}),t.jsx("input",{type:"range",min:ka,max:Math.max(ka,b),value:C,"aria-label":"Timeline zoom",onChange:E=>{u(!0),m(Number(E.target.value))},"data-help":!0,"data-help-title":"Zoom window","data-help-body":"Tighten the window to focus on hotspots.","data-help-placement":"top"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>u(!d),title:"Toggle windowed playback",children:d?"Full":"Window"}),t.jsx("button",{className:"ghost-button",type:"button",title:"Reset zoom",onClick:()=>{u(!0),m(Math.min(Math.max(b*.2,ka),6e4))},children:"Reset"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:ee,children:"Add bookmark"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>z("previous"),children:"Previous bookmark"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>z("next"),children:"Next bookmark"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:ge,children:"Set clip start"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:ne,children:"Set clip end"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:B,children:"Clear clip"}),t.jsx("input",{className:"search-input mini-segment-input",placeholder:"Segment label",value:D,onChange:E=>U(E.target.value),"aria-label":"Segment label"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:zt,disabled:!xe,children:"Add segment"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:je,disabled:!xe,children:"Export clip"})]}),N.length?t.jsx("div",{className:"mini-segment-list",children:N.map(E=>t.jsxs("div",{className:"mini-segment-item",children:[t.jsxs("span",{children:[E.label," (",E.startMs,"ms - ",E.endMs,"ms)"]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Be(E.id),children:"Remove"})]},E.id))}):null]})}const Sa=[{id:"toggleStory",label:"Story mode",defaultKey:"s"},{id:"toggleExplain",label:"Explain mode",defaultKey:"e"},{id:"startTour",label:"Start guided tour",defaultKey:"t"},{id:"toggleFlow",label:"Toggle Flow mode",defaultKey:"f"},{id:"toggleCinema",label:"Switch to Cinema mode",defaultKey:"c"},{id:"toggleGameplay",label:"Switch to Gameplay mode",defaultKey:"g"},{id:"toggleInspector",label:"Toggle inspector",defaultKey:"i"}],Ss="abcdefghijklmnopqrstuvwxyz".split(""),fc=Sa.reduce((e,n)=>(e[n.id]=n.defaultKey,e),{}),gc={...fc};function $o(e,n){const s=String(e??"").trim().toLowerCase();return Ss.includes(s)?s:n}function bc(e){return Ss.find(s=>!e.has(s))??"z"}function gs(e){const n={},s=new Set;for(const r of Sa){const o=$o(e==null?void 0:e[r.id],r.defaultKey),d=s.has(o)?bc(s):o;n[r.id]=d,s.add(d)}return n}function yc(e,n,s){const r=gs(e),o=$o(s,r[n]);if(r[n]===o)return r;const d={...r,[n]:o},c=Sa.find(m=>m.id!==n&&d[m.id]===o);return c&&(d[c.id]=r[n]),gs(d)}function xc(e){return e.trim().toUpperCase()}function vc({open:e,onClose:n,bindings:s}){const r=l.useRef(null),o=[{keys:"Space",action:"Play / pause"},{keys:"← / →",action:"Step boundary back / forward"},{keys:"Shift + ← / →",action:"Jump to start / end"},...Sa.map(c=>({keys:xc(s[c.id]),action:c.label})),{keys:"Cmd/Ctrl + K",action:"Open command palette"},{keys:"?",action:"Show shortcuts"},{keys:"Esc",action:"Close modal / inspector"}];if(l.useEffect(()=>{var c;e&&((c=r.current)==null||c.focus())},[e]),!e)return null;const d=c=>{var h;if(c.key==="Escape"){c.preventDefault(),n();return}if(c.key!=="Tab")return;const m=Array.from(c.currentTarget.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'));if(m.length===0)return;const u=m.indexOf(document.activeElement),f=c.shiftKey?u<=0?m.length-1:u-1:(u+1)%m.length;(h=m[f])==null||h.focus(),c.preventDefault()};return t.jsx("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true","aria-labelledby":"shortcuts-title",onKeyDown:d,children:t.jsxs("div",{className:"modal",tabIndex:-1,children:[t.jsxs("div",{className:"modal-header",children:[t.jsx("div",{className:"modal-title",id:"shortcuts-title",children:"Keyboard Shortcuts"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:n,ref:r,"aria-label":"Close shortcuts",children:"Close"})]}),t.jsx("div",{className:"modal-body",children:o.map(c=>t.jsxs("div",{className:"modal-row",children:[t.jsx("span",{className:"modal-keys",children:c.keys}),t.jsx("span",{className:"modal-action",children:c.action})]},c.keys))})]})})}const Zr="agentDirector.palette.recent.v1",eo="agentDirector.palette.pinned.v1",wc=8,jc=12,Po=e=>e.trim().toLowerCase(),ss=(e,n)=>{if(!n)return 0;const s=Po(e);return s?s===n?30:s.startsWith(n)?18:s.includes(n)?8:0:0};function to(e){try{const n=JSON.parse(window.localStorage.getItem(e)??"[]");return Array.isArray(n)?n.filter(s=>typeof s=="string"):[]}catch{return[]}}function ao(e,n){window.localStorage.setItem(e,JSON.stringify(n))}function kc(e){const n=new Map;return e.forEach(s=>{var o;const r=s.section;n.has(r)||n.set(r,[]),(o=n.get(r))==null||o.push(s)}),n}function no(e,n,s){var o;if(!e.length)return 0;let r=n;for(let d=0;d<e.length;d+=1)if(r=(r+s+e.length)%e.length,!((o=e[r])!=null&&o.disabled))return r;return n}function Sc({open:e,onClose:n,actions:s,context:r,onActionRun:o}){var J,le;const[d,c]=l.useState(""),[m,u]=l.useState(0),[f,h]=l.useState([]),[g,v]=l.useState([]),w=l.useRef(null),j=l.useRef(null),b=l.useMemo(()=>{const N=Po(d),T=new Set(f),D=new Set(g);return s.map((M,ae)=>{var Q;const be=[M.label,M.description,M.group,M.keys,...M.keywords??[]].filter(Boolean).join(" ").toLowerCase();if(N&&!be.includes(N))return null;let re=M.priority??0;return re+=ss(M.label,N),re+=ss(M.group??"",N),(M.keywords??[]).forEach(Ee=>{re+=ss(Ee,N)}),T.has(M.id)&&(re+=6),D.has(M.id)&&(re+=12),r!=null&&r.section&&((Q=M.group)==null?void 0:Q.toLowerCase())===r.section.toLowerCase()&&(re+=8),r!=null&&r.mode&&M.id.includes(`mode-${r.mode}`)&&(re+=8),{action:M,score:re,index:ae}}).filter(M=>!!M).sort((M,ae)=>ae.score===M.score?M.index-ae.index:ae.score-M.score).map(M=>M.action)},[s,r==null?void 0:r.mode,r==null?void 0:r.section,g,d,f]),S=l.useMemo(()=>{const N=new Map(b.map(M=>[M.id,M])),T=g.map(M=>N.get(M)).filter(M=>!!M).map(M=>({...M,section:"Pinned"})),D=f.map(M=>N.get(M)).filter(M=>!!M).filter(M=>!T.some(ae=>ae.id===M.id)).map(M=>({...M,section:"Recent"})),U=b.filter(M=>!T.some(ae=>ae.id===M.id)).filter(M=>!D.some(ae=>ae.id===M.id)).map(M=>({...M,section:M.group??"General"}));if(!d.trim()&&r){const M=U.slice(0,4).map(ae=>({...ae,id:`recommended-${ae.id}`,label:`Recommended: ${ae.label}`,section:"Recommended"}));return[...T,...D,...M,...U]}return[...T,...D,...U]},[r,b,g,f,d]),C=l.useMemo(()=>kc(S),[S]),R=l.useMemo(()=>s.filter(N=>(N.group??"").toLowerCase()==="macros"||N.id.startsWith("macro-")),[s]);if(l.useEffect(()=>{if(!e)return;c(""),u(0),h(to(Zr)),v(to(eo));const N=window.setTimeout(()=>{var T;return(T=w.current)==null?void 0:T.focus()},0);return()=>window.clearTimeout(N)},[e]),l.useEffect(()=>{m>=S.length&&u(0)},[m,S.length]),!e)return null;const K=N=>{h(T=>{const D=[N,...T.filter(U=>U!==N)].slice(0,wc);return ao(Zr,D),D})},_=N=>{N.disabled||(K(N.id),o==null||o(N),N.onTrigger(),n())},O=N=>{v(T=>{const D=T.includes(N)?T.filter(U=>U!==N):[N,...T].slice(0,jc);return ao(eo,D),D})},q=N=>{var T,D;if(N.key==="Escape"){N.preventDefault(),n();return}if(N.key==="ArrowDown"){N.preventDefault(),u(U=>no(S,U,1));return}if(N.key==="ArrowUp"){N.preventDefault(),u(U=>no(S,U,-1));return}if(N.key==="Enter"){N.preventDefault();const U=S[m];U&&_(U);return}if(N.key==="Tab"){const U=Array.from(((T=j.current)==null?void 0:T.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'))??[]);if(!U.length)return;const M=U.indexOf(document.activeElement),ae=N.shiftKey?M<=0?U.length-1:M-1:(M+1)%U.length;(D=U[ae])==null||D.focus(),N.preventDefault()}},P=(J=S[m])!=null&&J.id?`palette-option-${(le=S[m])==null?void 0:le.id}`:void 0;let L=-1;return t.jsx("div",{className:"modal-backdrop palette-backdrop",role:"dialog","aria-modal":"true","aria-label":"Command palette",onKeyDown:q,onMouseDown:N=>{N.target===N.currentTarget&&n()},children:t.jsxs("div",{className:"palette",ref:j,children:[t.jsxs("div",{className:"palette-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"palette-title",children:"Command palette"}),t.jsx("div",{className:"palette-subtitle",children:"Search actions, modes, and playbook steps."})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:n,"aria-label":"Close command palette",children:"Close"})]}),t.jsx("input",{ref:w,className:"palette-input",value:d,onChange:N=>c(N.target.value),placeholder:"Type to filter actions…","aria-label":"Search commands",role:"combobox","aria-expanded":"true","aria-controls":"command-palette-list","aria-activedescendant":P,"aria-autocomplete":"list"}),!d.trim()&&R.length>0?t.jsxs("div",{className:"palette-macros",children:[t.jsx("div",{className:"palette-group-title",children:"Quick macros"}),t.jsx("div",{className:"palette-macro-list",children:R.slice(0,3).map(N=>t.jsx("button",{className:"ghost-button palette-macro-item",type:"button",onClick:()=>_(N),children:N.label},N.id))})]}):null,t.jsxs("div",{className:"palette-list",role:"listbox",id:"command-palette-list",children:[S.length===0?t.jsx("div",{className:"palette-empty",children:"No matching commands."}):null,Array.from(C.entries()).map(([N,T])=>t.jsxs("div",{className:"palette-group",children:[t.jsx("div",{className:"palette-group-title",children:N}),t.jsx("div",{className:"palette-group-list",children:T.map(D=>{L+=1;const U=L===m,M=g.includes(D.id);return t.jsxs("button",{id:`palette-option-${D.id}`,className:`palette-item ${U?"active":""}`,type:"button",role:"option","aria-selected":U,onMouseEnter:()=>u(L),onClick:()=>_(D),disabled:D.disabled,children:[t.jsxs("div",{className:"palette-item-main",children:[t.jsx("div",{className:"palette-item-title",children:D.label}),D.description?t.jsx("div",{className:"palette-item-description",children:D.description}):null]}),t.jsxs("div",{className:"palette-item-trailing",children:[D.keys?t.jsx("div",{className:"palette-item-keys",children:D.keys}):null,t.jsx("span",{className:`palette-pin ${M?"active":""}`,role:"button",tabIndex:0,onClick:ae=>{ae.stopPropagation(),O(D.id)},onKeyDown:ae=>{ae.key!=="Enter"&&ae.key!==" "||(ae.preventDefault(),ae.stopPropagation(),O(D.id))},"aria-label":M?`Unpin ${D.label}`:`Pin ${D.label}`,title:M?"Unpin command":"Pin command",children:M?"★":"☆"})]})]},D.id)})})]},N))]})]})})}function Nc(e){return e.length?e.reduce((n,s)=>(s.durationMs??0)>(n.durationMs??0)?s:n,e[0]):null}function Cc({trace:e,mode:n,playheadMs:s,selectedStepId:r,compareTrace:o,collapsed:d,onToggleCollapsed:c,onModeChange:m,onSelectStep:u,onJumpToBottleneck:f,onReplay:h,onStartTour:g,priorityQueue:v=[]}){var N;const w=e.steps??[],j=Nc(w),b=r??(j==null?void 0:j.id)??((N=w[0])==null?void 0:N.id)??null,S=n==="cinema"||s>0,C=!!r,R=!!o,K=[S,C,R].filter(Boolean).length,_=[S,C,R].findIndex(T=>!T),O=_===-1?2:_,q=[0,1,2].map(T=>[S,C,R][T]?"done":T===O?"active":"next"),P=[{id:"observe",title:"Act I: Observe",summary:"Scrub the timeline to feel the pacing, bottlenecks, and tool choreography.",status:q[0],actionLabel:"Enter cinema",action:()=>m("cinema"),tasks:[{label:"Scrub the timeline",done:s>0},{label:"Stay in Cinema mode",done:n==="cinema"}]},{id:"inspect",title:"Act II: Inspect",summary:"Open the most expensive or failed step and read the payload with context.",status:q[1],actionLabel:j?"Jump to bottleneck":"Select first step",action:()=>{if(r){m("cinema");return}if(j){f();return}b&&(u(b),m("cinema"))},disabled:!b,tasks:[{label:"Open the Inspector",done:!!r},{label:"Jump to the bottleneck",done:!!(j&&r===j.id)}]},{id:"direct",title:"Act III: Direct",summary:"Replay from a decisive step, then compare flows and diffs side-by-side.",status:q[2],actionLabel:o?"Open compare":"Replay from step",action:()=>{if(o){m("compare");return}b&&h(b)},disabled:!b,tasks:[{label:"Replay from a step",done:!!o},{label:"Compare runs side-by-side",done:!!(o&&n==="compare")}]}],L=P[O],le=v.filter(T=>!T.done)[0];return d?t.jsxs("section",{className:"journey-panel journey-collapsed","aria-label":"Director journey","data-help":!0,"data-help-indicator":!0,"data-tour":"journey","data-help-title":"Director journey","data-help-body":"A guided path from observation to replay. Use it to show newcomers what to do first.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"journey-collapsed-main",children:[t.jsx("div",{className:"journey-eyebrow",children:"Director journey"}),t.jsx("div",{className:"journey-collapsed-title",children:"From observe to direct"})]}),t.jsxs("div",{className:"journey-collapsed-actions",children:[t.jsxs("span",{className:"journey-progress-text",children:[K,"/3 complete"]}),le?t.jsxs("span",{className:`journey-priority-chip severity-${le.severity}`,children:["Next priority: ",le.title]}):null,L?t.jsxs("button",{className:"primary-button journey-next",type:"button",onClick:L.action,disabled:L.disabled,children:["Next: ",L.actionLabel]}):null,g?t.jsx("button",{className:"ghost-button",type:"button",onClick:g,children:"Tour"}):null,t.jsx("button",{className:"primary-button journey-expand",type:"button",onClick:c,children:"Expand"})]})]}):t.jsxs("section",{className:"journey-panel","aria-label":"Director journey","data-help":!0,"data-help-indicator":!0,"data-tour":"journey","data-help-title":"Director journey","data-help-body":"A three-act flow that teaches the story: observe, inspect, direct. Each act jumps to the right place.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"journey-head",children:[t.jsxs("div",{children:[t.jsx("div",{className:"journey-eyebrow",children:"Director journey"}),t.jsx("h2",{className:"journey-title",children:"Cut a perfect take in three acts."}),t.jsx("p",{className:"journey-subtitle",children:"Trace the performance, interrogate the moment, then direct a better run."})]}),t.jsxs("div",{className:"journey-head-actions",children:[g?t.jsx("button",{className:"ghost-button",type:"button",onClick:g,children:"Start tour"}):null,t.jsx("button",{className:"ghost-button",type:"button",onClick:c,children:"Collapse"})]})]}),t.jsx("div",{className:"journey-track",children:P.map((T,D)=>{var U;return t.jsxs("div",{className:"journey-card","data-status":T.status,children:[t.jsxs("div",{className:"journey-card-top",children:[t.jsxs("span",{className:"journey-index",children:["0",D+1]}),t.jsx("span",{className:"journey-status",children:T.status})]}),t.jsx("h3",{className:"journey-card-title",children:T.title}),t.jsx("p",{className:"journey-card-body",children:T.summary}),(U=T.tasks)!=null&&U.length?t.jsx("ul",{className:"journey-tasks",children:T.tasks.map(M=>t.jsxs("li",{className:`journey-task ${M.done?"done":""}`,children:[t.jsx("span",{className:"journey-task-icon","aria-hidden":"true",children:M.done?"✓":"○"}),t.jsx("span",{children:M.label})]},M.label))}):null,t.jsx("button",{className:"primary-button journey-action",type:"button",onClick:T.action,disabled:T.disabled,children:T.actionLabel})]},T.id)})}),t.jsxs("div",{className:"journey-footer",children:[t.jsxs("div",{children:[t.jsx("div",{className:"journey-progress-label",children:"Progress"}),t.jsx("div",{className:"journey-progress",children:t.jsx("span",{className:"journey-progress-bar",style:{width:`${K/3*100}%`}})})]}),t.jsx("div",{className:"journey-footnote",children:"Tip: Use Flow to spot fan-out, Compare to validate your changes."})]}),v.length?t.jsxs("div",{className:"journey-priority-queue",children:[t.jsxs("div",{className:"journey-priority-head",children:[t.jsx("div",{className:"journey-progress-label",children:"Priority queue"}),t.jsxs("span",{children:[v.filter(T=>T.done).length,"/",v.length," resolved"]})]}),t.jsx("div",{className:"journey-priority-list",children:v.map(T=>t.jsxs("article",{className:`journey-priority-item ${T.done?"done":""}`,children:[t.jsxs("div",{className:"journey-priority-main",children:[t.jsx("span",{className:`journey-priority-chip severity-${T.severity}`,children:T.severity}),t.jsxs("div",{children:[t.jsx("div",{className:"journey-priority-title",children:T.title}),t.jsx("div",{className:"journey-priority-body",children:T.detail})]})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:T.onAction,disabled:T.done,children:T.done?"Resolved":T.actionLabel})]},T.id))})]}):null]})}const Mc=[],Ec=[],Ic=[],_c={};function Tc(e){return e.length?e.reduce((n,s)=>(s.durationMs??0)>(n.durationMs??0)?s:n,e[0]):null}function Rc({trace:e,mode:n,selectedStepId:s,onModeChange:r,onSelectStep:o,onJumpToBottleneck:d,onReplay:c,recommendations:m=Mc,persona:u="builder",annotations:f=Ec,activityFeed:h=Ic,onAddAnnotation:g,missionProgress:v=_c,missionCompletion:w,onResetMissions:j,narrative:b="",onAskDirector:S,onExportNarrative:C}){var ee;const R=e.steps??[],K=Tc(R),_=s??(K==null?void 0:K.id)??((ee=R[0])==null?void 0:ee.id)??null,O=e.metadata.wallTimeMs??0,q=u==="executive"?"Executive lens":u==="operator"?"Operator lens":"Builder lens",[P,L]=l.useState(""),[J,le]=l.useState(""),[N,T]=l.useState(""),[D,U]=l.useState("overview"),[M,ae]=l.useState([]),be=l.useMemo(()=>h.slice(0,6),[h]),re=(w==null?void 0:w.done)??0,Q=re>=3||!!v.inspect,Ee=re>=5||!!v.collaborate||be.length>0,Re=l.useMemo(()=>m.slice(0,3).map((z,ge)=>({id:z.id,step:`${ge+1}. ${z.actionLabel} — ${z.title}`})),[m]);l.useEffect(()=>{ae(z=>z.filter(ge=>m.some(ne=>ne.id===ge)))},[m]);const xe=M.filter(z=>m.some(ge=>ge.id===z)).length,x=m.length?Math.round(xe/m.length*100):0,Y=z=>{z.action(),ae(ge=>ge.includes(z.id)?ge:[...ge,z.id])};return t.jsxs("aside",{className:"inspector inspector-empty","data-help":!0,"data-help-indicator":!0,"data-tour":"inspector","data-help-title":"Inspector panel","data-help-body":"Select a step to open detailed payloads, redaction controls, and replay actions.","data-help-placement":"left",children:[t.jsx("div",{className:"inspector-header",children:t.jsxs("div",{children:[t.jsx("div",{className:"inspector-title",children:"Director's notes"}),t.jsxs("div",{className:"inspector-subtitle",children:[q,". Select a step to open deep inspection."]})]})}),t.jsxs("div",{className:"director-tabs",role:"tablist","aria-label":"Director workspace tabs",children:[t.jsx("button",{className:`ghost-button ${D==="overview"?"active":""}`,type:"button",role:"tab","aria-selected":D==="overview",onClick:()=>U("overview"),children:"Overview"}),t.jsx("button",{className:`ghost-button ${D==="narrative"?"active":""}`,type:"button",role:"tab","aria-selected":D==="narrative",onClick:()=>U("narrative"),children:"Narrative"}),t.jsx("button",{className:`ghost-button ${D==="collab"?"active":""}`,type:"button",role:"tab","aria-selected":D==="collab",onClick:()=>U("collab"),children:"Collaboration"})]}),D==="overview"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Run summary"}),t.jsxs("div",{className:"inspector-row",children:[t.jsx("span",{children:"Steps"}),t.jsx("span",{children:R.length})]}),t.jsxs("div",{className:"inspector-row",children:[t.jsx("span",{children:"Wall time"}),t.jsxs("span",{children:[O,"ms"]})]}),t.jsxs("div",{className:"inspector-row",children:[t.jsx("span",{children:"Status"}),t.jsx("span",{children:e.status})]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Next actions"}),t.jsxs("div",{className:"director-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>r("cinema"),"data-help":!0,"data-help-title":"Open cinema","data-help-body":"Jump straight into the timeline.","data-help-placement":"right",children:"Open cinema"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>r("flow"),"data-help":!0,"data-help-title":"Open flow","data-help-body":"See the dependency graph of the run.","data-help-placement":"right",children:"Switch to flow"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{if(!s){if(K){d();return}_&&o(_)}},disabled:!_||!!s,"data-help":!0,"data-help-title":"Jump to bottleneck","data-help-body":"Select the slowest step for inspection.","data-help-placement":"right",children:s?"Inspector open":K?"Jump to bottleneck":"Select first step"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>_&&c(_),disabled:!_||!Q,title:Q?void 0:"Complete core missions to unlock replay guidance.","data-help":!0,"data-help-title":"Replay","data-help-body":"Branch a replay from a decisive step.","data-help-placement":"right",children:"Replay from step"})]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Mode"}),t.jsxs("div",{className:"director-modes",children:[t.jsx("button",{className:`ghost-button ${n==="cinema"?"active":""}`,type:"button",onClick:()=>r("cinema"),"data-help":!0,"data-help-title":"Cinema mode","data-help-body":"Timeline view for pacing and sequence.","data-help-placement":"right",children:"Cinema"}),t.jsx("button",{className:`ghost-button ${n==="flow"?"active":""}`,type:"button",onClick:()=>r("flow"),"data-help":!0,"data-help-title":"Flow mode","data-help-body":"Graph view for dependencies.","data-help-placement":"right",children:"Flow"}),t.jsx("button",{className:"ghost-button",type:"button",disabled:!0,children:"Compare"})]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Adaptive missions"}),t.jsxs("div",{className:"mission-summary",children:[(w==null?void 0:w.done)??0,"/",(w==null?void 0:w.total)??0," complete",t.jsxs("span",{children:[(w==null?void 0:w.pct)??0,"%"]})]}),t.jsxs("div",{className:"mission-stage",children:["Stage: ",Ee?"Collaboration":Q?"Analysis":"Foundation"]}),t.jsx("div",{className:"mission-grid",children:Object.entries(v).map(([z,ge])=>t.jsxs("div",{className:`mission-chip ${ge?"done":""}`,children:[t.jsx("span",{children:z}),t.jsx("span",{children:ge?"Done":"Pending"})]},z))}),t.jsx("button",{className:"ghost-button",type:"button",onClick:j,children:"Reset missions"})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Action plan"}),Q?m.length===0?t.jsx("div",{className:"annotation-empty",children:"No recommendations generated yet."}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"mission-summary",children:[xe,"/",m.length," complete",t.jsxs("span",{children:[x,"%"]})]}),t.jsx("div",{className:"director-recommendations",children:m.map(z=>{const ge=M.includes(z.id);return t.jsxs("article",{className:`director-recommendation tone-${z.tone} ${ge?"done":""}`,children:[t.jsx("div",{className:"director-recommendation-title",children:z.title}),t.jsx("p",{className:"director-recommendation-body",children:z.body}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Y(z),children:ge?"Completed":z.actionLabel})]},z.id)})})]}):t.jsx("div",{className:"annotation-empty",children:"Complete inspect/flow/replay missions to unlock AI narrative tools."}),Ee?null:t.jsx("div",{className:"annotation-empty",children:"Open another live session to unlock collaboration activity feed."})]})]}):null,D==="narrative"?t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"AI director narrative"}),Q?t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"director-recommendation-body",children:b}),Re.length?t.jsx("div",{className:"director-guided-plan",children:Re.map(z=>t.jsx("div",{children:z.step},z.id))}):null,t.jsxs("div",{className:"director-ask-row",children:[t.jsx("input",{className:"search-input",value:J,onChange:z=>le(z.target.value),placeholder:"Ask Director (e.g. what is highest risk?)","aria-label":"Ask director question"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{J.trim()&&T((S==null?void 0:S(J))??"")},children:"Ask"})]}),N?t.jsx("div",{className:"director-answer",children:N}):null,t.jsx("button",{className:"ghost-button",type:"button",onClick:C,children:"Export narrative"})]}):t.jsx("div",{className:"annotation-empty",children:"Complete inspect/flow/replay missions to unlock AI narrative tools."})]}):null,D==="collab"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Shared annotations"}),t.jsx("textarea",{value:P,onChange:z=>L(z.target.value),rows:3,placeholder:s?"Add note for selected step...":"Add trace-level note...","aria-label":"Shared annotation"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{const z=P.trim();z&&(g==null||g(z,s),L(""))},children:"Add annotation"}),t.jsxs("div",{className:"annotation-list",children:[f.slice(-6).reverse().map(z=>t.jsxs("article",{className:"annotation-item",children:[t.jsxs("div",{className:"annotation-meta",children:[t.jsx("span",{children:z.stepId?`step ${z.stepId}`:"trace"}),t.jsx("span",{children:z.authorSessionId})]}),t.jsx("p",{children:z.body})]},z.id)),f.length===0?t.jsx("div",{className:"annotation-empty",children:"No shared annotations yet."}):null]})]}),t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Collab activity"}),Ee?t.jsxs("div",{className:"activity-list",children:[be.map(z=>t.jsxs("div",{className:"activity-item",children:[t.jsx("span",{children:z.message}),t.jsx("span",{children:new Date(z.timestamp).toLocaleTimeString()})]},z.id)),be.length===0?t.jsx("div",{className:"annotation-empty",children:"No activity yet."}):null]}):t.jsx("div",{className:"annotation-empty",children:"Open another live session to unlock collaboration activity feed."})]})]}):null]})}const rs=(e,n,s)=>Math.min(s,Math.max(n,e));function os(e){return Array.from((e==null?void 0:e.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'))??[]).filter(s=>!(s.hasAttribute("disabled")||s.getAttribute("aria-hidden")==="true"))}function Dc({steps:e,open:n,onClose:s,onComplete:r}){const[o,d]=l.useState(0),[c,m]=l.useState(null),[u,f]=l.useState(null),h=l.useRef(null),g=l.useRef(null),v=l.useRef(null),w=l.useMemo(()=>e[o],[e,o]),j=l.useCallback(()=>{if(!n)return;const _=document.querySelector(w.target);if(!_){g.current=null,m(null);return}g.current=_;const O=_.getBoundingClientRect();m(O)},[n,w.target]),b=l.useCallback(()=>{if(!c||!h.current){f(null);return}const _=h.current.offsetWidth,O=h.current.offsetHeight,q=16;let P=rs(c.left+c.width/2-_/2,q,window.innerWidth-_-q),L=c.bottom+16;w.placement==="top"&&(L=c.top-O-16),w.placement==="left"&&(P=c.left-_-16,L=c.top+c.height/2-O/2),w.placement==="right"&&(P=c.right+16,L=c.top+c.height/2-O/2),L+O>window.innerHeight-q&&(L=c.top-O-16),L<q&&(L=c.bottom+16),P=rs(P,q,window.innerWidth-_-q),L=rs(L,q,window.innerHeight-O-q),f({top:L,left:P})},[w.placement,c]);if(l.useEffect(()=>{n&&d(0)},[n]),l.useEffect(()=>{var O,q;if(!n){(q=(O=v.current)==null?void 0:O.focus)==null||q.call(O);return}v.current=document.activeElement;const _=window.setTimeout(()=>{var L;(L=os(h.current)[0]??h.current)==null||L.focus()},0);return()=>window.clearTimeout(_)},[n]),l.useEffect(()=>{if(!n)return;const _=document.querySelector(w.target);_&&_.scrollIntoView({behavior:"smooth",block:"center",inline:"center"});const O=window.requestAnimationFrame(()=>j());return()=>window.cancelAnimationFrame(O)},[n,w.target,j]),l.useLayoutEffect(()=>{b()},[c,b,w.title]),l.useEffect(()=>{if(!n)return;const _=()=>{j(),b()};return window.addEventListener("resize",_),window.addEventListener("scroll",_,!0),()=>{window.removeEventListener("resize",_),window.removeEventListener("scroll",_,!0)}},[n,j,b]),l.useEffect(()=>{if(!n)return;const _=O=>{var le;if(O.key==="Escape"){O.preventDefault(),s();return}if(O.key!=="Tab")return;const q=os(h.current);if(!q.length)return;const P=document.activeElement,L=q.indexOf(P),J=O.shiftKey?L<=0?q.length-1:L-1:(L+1)%q.length;(le=q[J])==null||le.focus(),O.preventDefault()};return document.addEventListener("keydown",_,!0),()=>document.removeEventListener("keydown",_,!0)},[s,n]),!n||!w)return null;const S=_=>{var J;if(_.key==="Escape"){_.preventDefault(),s();return}if(_.key!=="Tab")return;const O=os(h.current);if(O.length===0)return;const q=document.activeElement,P=O.indexOf(q),L=_.shiftKey?P<=0?O.length-1:P-1:(P+1)%O.length;(J=O[L])==null||J.focus(),_.preventDefault()},C=`tour-title-${w.id}`,R=`tour-body-${w.id}`,K=c?{top:c.top-6,left:c.left-6,width:c.width+12,height:c.height+12}:void 0;return t.jsxs("div",{className:"tour-overlay",role:"dialog","aria-modal":"true","aria-label":"Guided tour","aria-labelledby":C,"aria-describedby":R,onKeyDown:S,children:[t.jsx("div",{className:"tour-backdrop",onClick:s}),c?t.jsx("div",{className:"tour-spotlight",style:K}):null,t.jsxs("div",{className:`tour-card ${u?"tour-card-anchored":""}`,ref:h,style:u??void 0,tabIndex:-1,children:[t.jsxs("div",{className:"tour-step",children:["Step ",o+1," of ",e.length]}),t.jsx("div",{className:"tour-title",id:C,children:w.title}),t.jsx("p",{className:"tour-body",id:R,children:w.body}),t.jsxs("div",{className:"tour-actions",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>d(_=>Math.max(0,_-1)),disabled:o===0,children:"Back"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:s,children:"Skip"}),o===e.length-1?t.jsx("button",{className:"primary-button",type:"button",onClick:r,children:"Finish tour"}):t.jsx("button",{className:"primary-button",type:"button",onClick:()=>d(_=>_+1),children:"Next"})]})]})]})}const so=(e,n,s)=>Math.min(s,Math.max(n,e));function Oc({enabled:e}){const[n,s]=l.useState(null),[r,o]=l.useState(null),d=l.useRef(null),c=l.useRef(null),m=l.useCallback(()=>{const f=d.current;if(!f){s(null);return}const h=f.getBoundingClientRect(),g=f.dataset.helpTitle??"Context",v=f.dataset.helpBody??"",w=f.dataset.helpPlacement??"right";s({rect:h,title:g,body:v,placement:w})},[]);l.useEffect(()=>{if(!e){d.current=null,s(null);return}const f=j=>{var S,C;const b=(C=(S=j.target)==null?void 0:S.closest)==null?void 0:C.call(S,"[data-help]");if(!b){d.current||s(null);return}d.current!==b&&(d.current=b,m())},h=j=>{var S,C;const b=(C=(S=j.target)==null?void 0:S.closest)==null?void 0:C.call(S,"[data-help]");b&&(d.current=b,m())},g=j=>{var S;const b=j.relatedTarget;(S=b==null?void 0:b.closest)!=null&&S.call(b,"[data-help]")||(d.current=null,s(null))},v=j=>{var S,C;const b=(C=(S=j.target)==null?void 0:S.closest)==null?void 0:C.call(S,"[data-help]");if(!b){d.current=null,s(null);return}d.current=b,m()},w=()=>{d.current&&m()};return window.addEventListener("mousemove",f),window.addEventListener("focusin",h),window.addEventListener("focusout",g),window.addEventListener("pointerdown",v),window.addEventListener("scroll",w,!0),window.addEventListener("resize",w),()=>{window.removeEventListener("mousemove",f),window.removeEventListener("focusin",h),window.removeEventListener("focusout",g),window.removeEventListener("pointerdown",v),window.removeEventListener("scroll",w,!0),window.removeEventListener("resize",w)}},[e,m]);const u=l.useCallback(()=>{if(!n||!c.current){o(null);return}const f=12,h=c.current.offsetWidth,g=c.current.offsetHeight,{rect:v,placement:w}=n;let j=v.right+16,b=v.top+v.height/2-g/2;w==="left"&&(j=v.left-h-16,b=v.top+v.height/2-g/2),w==="top"&&(j=v.left+v.width/2-h/2,b=v.top-g-16),w==="bottom"&&(j=v.left+v.width/2-h/2,b=v.bottom+16),j=so(j,f,window.innerWidth-h-f),b=so(b,f,window.innerHeight-g-f),o({left:j,top:b})},[n]);return l.useLayoutEffect(()=>{u()},[u]),!e||!n?null:t.jsxs("div",{className:"help-overlay","aria-hidden":"true",children:[t.jsx("div",{className:"help-highlight",style:{top:n.rect.top-6,left:n.rect.left-6,width:n.rect.width+12,height:n.rect.height+12}}),t.jsxs("div",{className:"help-bubble",ref:c,style:r??void 0,"data-placement":n.placement,children:[t.jsx("div",{className:"help-title",children:n.title}),t.jsx("div",{className:"help-body",children:n.body})]})]})}const Ac=[{id:"builder",label:"Builder lens",body:"Focus on step payloads, execution paths, and replay control."},{id:"executive",label:"Executive lens",body:"Focus on bottlenecks, risk, and outcome-level run quality."},{id:"operator",label:"Operator lens",body:"Focus on failures, retries, and trace reliability posture."}],$c=[{id:"rapid_triage",label:"Rapid triage",body:"Jump straight to the highest-risk step and start resolution.",estimate:"2-3 min"},{id:"deep_diagnosis",label:"Deep diagnosis",body:"Open flow and guided analysis for full root-cause exploration.",estimate:"8-12 min"},{id:"team_sync",label:"Team sync",body:"Open collaborative mode and prep a handoff workflow.",estimate:"4-6 min"}];function Pc({onComplete:e,onStartTour:n,onStartStory:s,persona:r="builder",onPersonaChange:o,launchPath:d="rapid_triage",onLaunchPathChange:c,onStartLaunchPath:m}){const u=()=>{n==null||n(),e()},f=()=>{s==null||s(),e()},h=g=>{c==null||c(g),m==null||m(g),e()};return t.jsx("div",{className:"intro-overlay",role:"dialog","aria-modal":"true","aria-label":"Agent Director intro",children:t.jsxs("div",{className:"intro-card",children:[t.jsx("div",{className:"intro-scan"}),t.jsx("div",{className:"intro-title",children:"Agent Director"}),t.jsx("div",{className:"intro-tagline",children:"Watch your agent think. Then direct it."}),t.jsxs("div",{className:"intro-steps",children:[t.jsxs("div",{className:"intro-step",children:[t.jsx("div",{className:"intro-step-label",children:"Observe"}),t.jsx("div",{className:"intro-step-body",children:"Scrub the timeline to feel pacing and parallelism."})]}),t.jsxs("div",{className:"intro-step",children:[t.jsx("div",{className:"intro-step-label",children:"Inspect"}),t.jsx("div",{className:"intro-step-body",children:"Open the bottleneck to read payloads and costs."})]}),t.jsxs("div",{className:"intro-step",children:[t.jsx("div",{className:"intro-step-label",children:"Direct"}),t.jsx("div",{className:"intro-step-body",children:"Replay from a decisive step and compare runs."})]})]}),t.jsx("div",{className:"intro-personas",role:"group","aria-label":"Select onboarding lens",children:Ac.map(g=>t.jsxs("button",{type:"button",className:`ghost-button intro-persona ${r===g.id?"active":""}`,onClick:()=>o==null?void 0:o(g.id),"aria-pressed":r===g.id,"aria-label":g.label,children:[t.jsx("span",{className:"intro-persona-label",children:g.label}),t.jsx("span",{className:"intro-persona-body",children:g.body})]},g.id))}),t.jsx("div",{className:"intro-launch-paths",role:"group","aria-label":"Select launch path",children:$c.map(g=>t.jsxs("article",{className:`intro-path-card ${d===g.id?"active":""}`,children:[t.jsxs("button",{type:"button",className:`ghost-button intro-path-button ${d===g.id?"active":""}`,onClick:()=>c==null?void 0:c(g.id),"aria-pressed":d===g.id,"aria-label":g.label,children:[t.jsx("span",{className:"intro-path-label",children:g.label}),t.jsx("span",{className:"intro-path-estimate",children:g.estimate}),t.jsx("span",{className:"intro-path-body",children:g.body})]}),t.jsxs("button",{className:"primary-button intro-path-start",type:"button",onClick:()=>h(g.id),children:["Start ",g.label]})]},g.id))}),t.jsxs("div",{className:"intro-grid",children:[t.jsx("span",{}),t.jsx("span",{}),t.jsx("span",{}),t.jsx("span",{})]}),t.jsxs("div",{className:"intro-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:u,children:"Start guided tour"}),s?t.jsx("button",{className:"ghost-button",type:"button",onClick:f,children:"Play story mode"}):null,t.jsx("button",{className:"ghost-button",type:"button",onClick:e,children:"Skip intro"})]})]})})}function Lc({explainMode:e,storyActive:n,onStartTour:s,onStartStory:r,onToggleExplain:o,onDismiss:d}){return t.jsxs("section",{className:"hero-ribbon","aria-label":"Director briefing","data-help":!0,"data-help-indicator":!0,"data-tour":"hero","data-help-title":"Director briefing","data-help-body":"Start the tour, play story mode, or enable explain to learn the interface instantly.","data-help-placement":"bottom",children:[t.jsxs("div",{className:"hero-ribbon-top",children:[t.jsx("span",{className:"hero-eyebrow",children:"Director briefing"}),t.jsx("button",{className:"ghost-button hero-dismiss",type:"button",onClick:d,children:"Dismiss"})]}),t.jsx("div",{className:"hero-title",children:"Observe. Inspect. Direct."}),t.jsx("div",{className:"hero-subtitle",children:"A cinematic control room for agent traces. See time, read structure, then replay with confidence."}),t.jsxs("div",{className:"hero-pills",children:[t.jsx("span",{className:"hero-pill","data-tone":"observe",children:"Observe"}),t.jsx("span",{className:"hero-pill","data-tone":"inspect",children:"Inspect"}),t.jsx("span",{className:"hero-pill","data-tone":"direct",children:"Direct"})]}),t.jsxs("div",{className:"hero-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:s,children:"Start guided tour"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:r,disabled:n,children:n?"Story running":"Play story mode"}),t.jsxs("button",{className:`ghost-button ${e?"active":""}`,type:"button",onClick:o,"aria-pressed":e,children:["Explain ",e?"On":"Off"]})]})]})}function Fc({mode:e,isPlaying:n,storyActive:s,hideOnboardingActions:r=!1,hidden:o=!1,open:d,onToggleOpen:c,onTogglePlay:m,onStartStory:u,onStopStory:f,onShowShortcuts:h,onJumpToBottleneck:g}){if(o)return null;const j=[{id:"playback",label:n?"Pause":"Play",meta:e==="flow"?"Cinema":"Space",active:n,onClick:m,helpTitle:"Play or pause",helpBody:"Start or stop playback from anywhere."},{id:"bottleneck",label:"Focus bottleneck",meta:"Latency",active:!1,onClick:g,helpTitle:"Bottleneck jump",helpBody:"Focus instantly on the slowest step."},{id:"story",label:s?"Stop story":"Story mode",meta:"Narrate",active:s,onClick:s?f:u,helpTitle:"Story mode",helpBody:"Auto-runs a cinematic walkthrough of the run.",hidden:r},{id:"shortcuts",label:"Shortcuts",meta:"?",active:!1,onClick:h,helpTitle:"Shortcuts",helpBody:"See the full keyboard map."}].filter(b=>!b.hidden).slice(0,4);return d?t.jsxs("aside",{className:"quick-actions","aria-label":"Quick actions","data-help":!0,"data-help-indicator":!0,"data-tour":"quick-actions","data-help-title":"Quick actions","data-help-body":"Launch story mode, open the command palette, or jump to the bottleneck instantly.","data-help-placement":"left",children:[t.jsxs("div",{className:"quick-actions-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"quick-actions-title",children:"Quick actions"}),t.jsx("div",{className:"quick-actions-subtitle",children:"Contextual tasks (max 4)."})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:c,"aria-label":"Collapse quick actions",children:"Collapse"})]}),j.map(b=>t.jsxs("button",{className:`quick-action ${b.active?"active":""}`,type:"button",onClick:b.onClick,"aria-label":b.label,"data-help":!0,"data-help-title":b.helpTitle,"data-help-body":b.helpBody,"data-help-placement":"left",children:[t.jsx("span",{className:"quick-action-label",children:b.label}),t.jsx("span",{className:"quick-action-meta",children:b.meta})]},b.id))]}):t.jsxs("button",{className:"quick-actions-toggle",type:"button",onClick:c,title:"Open quick actions","aria-expanded":"false","data-help":!0,"data-tour":"quick-actions","data-help-title":"Quick actions","data-help-body":"Open the dock to access contextual tasks for the current workflow.","data-help-placement":"left",children:[t.jsx("span",{className:"quick-actions-toggle-label",children:"Actions"}),t.jsx("span",{className:"quick-actions-toggle-meta",children:"Dock"})]})}const Bc={evaluate:"Get a fast read on run quality and risk.",operate:"Stabilize incidents quickly with focused triage.",investigate:"Go deeper with flow and counterfactual analysis."};function qc(e,n){return n<=0?"Confidence: not started":e===0?"Confidence: building":e>=n?"Confidence: high":"Confidence: growing"}function zc({path:e,steps:n,explainEnabled:s,recommendedActionLabel:r,onRecommendedAction:o,onStartTour:d,onToggleExplain:c,onStartOver:m}){const u=n.slice(0,3),f=u.length,h=u.filter(v=>v.done).length,g=f>0?Math.round(h/f*100):0;return t.jsxs("section",{className:"first-win-checklist","aria-label":"First win checklist",children:[t.jsxs("div",{className:"first-win-header",children:[t.jsxs("span",{className:"status-badge",children:["Path: ",e]}),t.jsxs("span",{className:"first-win-progress-copy",children:[h," of ",f," complete"]})]}),t.jsx("h2",{children:"First win checklist"}),t.jsx("p",{children:Bc[e]}),t.jsx("div",{className:"first-win-progress",role:"progressbar","aria-label":"Onboarding progress","aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":g,children:t.jsx("span",{className:"first-win-progress-track",children:t.jsx("span",{className:"first-win-progress-fill",style:{width:`${g}%`}})})}),t.jsx("p",{className:"first-win-confidence",children:qc(h,f)}),t.jsx("ol",{className:"first-win-steps","aria-label":"First win steps",children:u.map(v=>t.jsxs("li",{className:`first-win-step ${v.done?"done":""}`,children:[t.jsx("span",{className:"first-win-step-marker","aria-hidden":"true",children:v.done?"✓":"○"}),t.jsxs("span",{className:"first-win-step-copy",children:[t.jsx("strong",{children:v.label}),t.jsx("span",{children:v.hint})]})]},v.id))}),t.jsxs("div",{className:"first-win-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:o,children:r}),t.jsx("button",{className:"ghost-button",type:"button",onClick:d,children:"Help me around"}),t.jsxs("button",{className:`ghost-button ${s?"active":""}`,type:"button",onClick:c,"aria-pressed":s,children:["Explain ",s?"On":"Off"]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:m,children:"Start over"})]})]})}const Gc=[{id:"evaluate",label:"Evaluate",body:"See value quickly with a concise end-to-end walkthrough."},{id:"operate",label:"Operate",body:"Start incident triage and unblock the team fast."},{id:"investigate",label:"Investigate",body:"Run deeper diagnosis with flow, compare, and matrix tools."}];function Uc({value:e,onChange:n}){return t.jsx("div",{className:"onboarding-path-selector",role:"group","aria-label":"Choose onboarding path",children:Gc.map(s=>t.jsxs("button",{type:"button",className:`ghost-button onboarding-path-option ${e===s.id?"active":""}`,"aria-pressed":e===s.id,onClick:()=>n(s.id),children:[t.jsx("span",{className:"onboarding-path-label",children:s.label}),t.jsx("span",{className:"onboarding-path-body",children:s.body})]},s.id))})}function Hc({stage:e,path:n,steps:s,explainEnabled:r,recommendedActionLabel:o,onPathChange:d,onStart:c,onSkipSafely:m,onStartOver:u,onStartTour:f,onToggleExplain:h,onRecommendedAction:g}){return e==="select"?t.jsxs("section",{className:"onboarding-orchestrator onboarding-stage-select","aria-label":"Onboarding setup",children:[t.jsx("p",{className:"onboarding-eyebrow",children:"First-run setup"}),t.jsx("h2",{children:"What are you here to do?"}),t.jsx("p",{children:"Pick one path and we will guide you to a fast first win."}),t.jsx(Uc,{value:n,onChange:d}),t.jsxs("div",{className:"onboarding-orchestrator-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:c,children:"Start first win"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:m,children:"Skip for now"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:f,children:"Help me around"})]})]}):e==="skipped"?t.jsxs("section",{className:"onboarding-orchestrator onboarding-stage-skipped","aria-label":"Onboarding skipped",children:[t.jsx("p",{className:"onboarding-eyebrow",children:"Skipped for now"}),t.jsx("h2",{children:"Use one action to get moving."}),t.jsx("p",{children:"Recommended first action based on your selected path:"}),t.jsxs("div",{className:"onboarding-orchestrator-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:g,children:o}),t.jsx("button",{className:"ghost-button",type:"button",onClick:f,children:"Help me around"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:u,children:"Start over"})]})]}):t.jsx("section",{className:`onboarding-orchestrator onboarding-stage-${e}`,"aria-label":e==="completed"?"Onboarding complete":"Onboarding in progress",children:t.jsx(zc,{path:n,steps:s,explainEnabled:r,recommendedActionLabel:o,onRecommendedAction:g,onStartTour:f,onToggleExplain:h,onStartOver:u})})}function Wc({active:e,label:n,step:s,total:r,onStop:o,onRestart:d}){if(!e)return null;const c=r>0?(s+1)/r*100:0;return t.jsxs("div",{className:"story-banner",role:"status","aria-live":"polite",children:[t.jsxs("div",{className:"story-banner-main",children:[t.jsx("div",{className:"story-banner-title",children:"Story mode"}),t.jsx("div",{className:"story-banner-step",children:n})]}),t.jsxs("div",{className:"story-banner-actions",children:[t.jsxs("span",{className:"story-banner-count",children:[Math.min(s+1,r),"/",r]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:d,children:"Restart"}),t.jsx("button",{className:"primary-button",type:"button",onClick:o,children:"Stop"})]}),t.jsx("div",{className:"story-banner-progress",children:t.jsx("span",{style:{width:`${c}%`}})})]})}function is({variant:e,title:n,message:s,actions:r=[]}){const o=`app-shell-state-${e}-title`;return t.jsx("section",{className:`app-shell-state app-shell-${e}`,"aria-live":"polite",role:"region","aria-labelledby":o,children:t.jsxs("div",{className:"app-shell-card",children:[e==="loading"?t.jsx("div",{className:"app-shell-spinner","aria-hidden":"true"}):null,t.jsx("h2",{id:o,children:n}),t.jsx("p",{children:s}),r.length?t.jsx("div",{className:"app-shell-actions",children:r.map(d=>t.jsx("span",{children:d.node},d.id))}):null]})})}function Vc({notifications:e,onDismiss:n}){return e.length?t.jsx("aside",{className:"notification-center","aria-label":"System notifications",role:"region","aria-live":"polite","aria-relevant":"additions text",children:e.map(s=>t.jsxs("article",{className:`notification-item level-${s.level}`,role:s.level==="error"||s.level==="warning"?"alert":"status","aria-atomic":"true",children:[t.jsx("p",{children:s.message}),t.jsx("button",{className:"ghost-button notification-dismiss",type:"button",onClick:()=>n(s.id),"aria-label":"Dismiss notification",children:"Dismiss"})]},s.id))}):null}function Jc({steps:e,fromRects:n,toRects:s,onComplete:r}){return l.useEffect(()=>{const o=window.setTimeout(r,550);return()=>window.clearTimeout(o)},[r]),t.jsx("div",{className:"morph-layer",children:e.map(o=>{var m;const d=n[o.id],c=s[o.id];return!d||!c?null:t.jsxs(Pl.div,{className:`morph-card step-${o.type}`,initial:{left:d.left,top:d.top,width:d.width,height:d.height},animate:{left:c.left,top:c.top,width:c.width,height:c.height},transition:{duration:.5,ease:"easeInOut"},children:[t.jsx("div",{className:"morph-card-title",children:o.name}),t.jsx("div",{className:"morph-card-subtitle",children:((m=o.preview)==null?void 0:m.title)??o.type})]},o.id)})})}function Kc({morph:e,onComplete:n,children:s}){return t.jsxs("div",{className:"morph-orchestrator",children:[s,e?t.jsx(Jc,{steps:e.steps,fromRects:e.fromRects,toRects:e.toRects,onComplete:n}):null]})}const Qc="demo-trace-overlap-001",Yc="Overlap + ToolCallId Demo",Xc="2026-01-27T10:00:00.000Z",Zc="2026-01-27T10:00:05.000Z",ed="completed",td={source:"openai_agents",agentName:"DemoAgent",modelId:"gpt-4o-2024-11-20",wallTimeMs:5e3,workTimeMs:7200,totalTokens:1400,totalCostUsd:.018},ad=[{id:"s1",index:0,type:"llm_call",name:"plan",startedAt:"2026-01-27T10:00:00.000Z",endedAt:"2026-01-27T10:00:01.000Z",durationMs:1e3,childStepIds:[],metrics:{tokensTotal:300,costUsd:.004},preview:{title:"LLM: plan",subtitle:"gpt-4o",outputPreview:"I'll fetch two sources..."},status:"completed"},{id:"s2",index:1,type:"llm_call",name:"call_tools",startedAt:"2026-01-27T10:00:01.000Z",endedAt:"2026-01-27T10:00:01.200Z",durationMs:200,childStepIds:[],metrics:{tokensTotal:120,costUsd:.002},preview:{title:"LLM: call tools",outputPreview:"Calling web_search + database_query"},io:{emittedToolCallIds:["tc-001","tc-002"]},status:"completed"},{id:"s3",index:2,type:"tool_call",name:"web_search",toolCallId:"tc-001",startedAt:"2026-01-27T10:00:01.200Z",endedAt:"2026-01-27T10:00:03.200Z",durationMs:2e3,childStepIds:[],metrics:{costUsd:0},preview:{title:"Tool: web_search",inputPreview:'{"q":"EU AI Act"}',outputPreview:"[3 results...]"},status:"completed"},{id:"s4",index:3,type:"tool_call",name:"database_query",toolCallId:"tc-002",startedAt:"2026-01-27T10:00:01.500Z",endedAt:"2026-01-27T10:00:02.700Z",durationMs:1200,childStepIds:[],preview:{title:"Tool: database_query",inputPreview:'{"sql":"SELECT..."}',outputPreview:'{"rows":42}'},status:"completed"},{id:"s5",index:4,type:"llm_call",name:"analyze",startedAt:"2026-01-27T10:00:03.200Z",endedAt:"2026-01-27T10:00:04.600Z",durationMs:1400,childStepIds:[],metrics:{tokensTotal:700,costUsd:.012},preview:{title:"LLM: analyze",outputPreview:"Synthesis based on tool outputs..."},io:{consumedToolCallIds:["tc-001","tc-002"]},status:"completed"}],en={id:Qc,name:Yc,startedAt:Xc,endedAt:Zc,status:ed,metadata:td,steps:ad};function Lo(e,n){const s=nd(e,n),r=new Set(s.map(g=>g.leftId)),o=new Set(s.map(g=>g.rightId)),d=n.steps.filter(g=>!o.has(g.id)).map(g=>g.id),c=e.steps.filter(g=>!r.has(g.id)).map(g=>g.id),m=s.filter(g=>{const v=e.steps.find(j=>j.id===g.leftId),w=n.steps.find(j=>j.id===g.rightId);return!v||!w?!1:ro(v)!==ro(w)}),u=m.map(g=>g.leftId),f=(n.metadata.totalCostUsd??0)-(e.metadata.totalCostUsd??0),h=n.metadata.wallTimeMs-e.metadata.wallTimeMs;return{addedSteps:d,removedSteps:c,changedSteps:u,changedPairs:m,alignedSteps:s,costDeltaUsd:f,wallTimeDeltaMs:h}}function nd(e,n){const s=[],r=new Set(e.steps.map(h=>h.id)),o=new Set(n.steps.map(h=>h.id));Array.from(r).forEach(h=>{o.has(h)&&(s.push({leftId:h,rightId:h}),r.delete(h),o.delete(h))});const d=new Map;n.steps.forEach(h=>{h.toolCallId&&d.set(h.toolCallId,h.id)}),e.steps.forEach(h=>{if(!h.toolCallId)return;const g=d.get(h.toolCallId);g&&o.has(g)&&(s.push({leftId:h.id,rightId:g}),r.delete(h.id),o.delete(g))});const c=lo(e),m=lo(n),u=sd(e,n),f={};return o.forEach(h=>{const g=m.get(h);if(!g)return;const v=oo(g.step);v&&(f[v]||(f[v]=[]),f[v].push(h))}),Object.values(f).forEach(h=>{h.sort((g,v)=>{var w,j;return(((w=m.get(g))==null?void 0:w.startMs)??0)-(((j=m.get(v))==null?void 0:j.startMs)??0)})}),Array.from(r).forEach(h=>{var j;const g=c.get(h);if(!g)return;const v=oo(g.step);if(!v||!((j=f[v])!=null&&j.length))return;const w=rd(g,f[v],m,u);w&&(s.push({leftId:h,rightId:w}),r.delete(h),o.delete(w),f[v]=f[v].filter(b=>b!==w))}),s}function ro(e){var r,o;const n=((r=e.preview)==null?void 0:r.outputPreview)??null,s=((o=e.metrics)==null?void 0:o.costUsd)??null;return`${e.status}|${n??""}|${s??""}`}function oo(e){return e.type?`${e.type}:${e.name??""}`:null}function io(e){if(!e)return null;const n=Date.parse(e);return Number.isNaN(n)?null:n}function lo(e){const n=io(e.startedAt),s=new Map;return e.steps.forEach(r=>{const o=io(r.startedAt),d=n!=null&&o!=null?o-n:null;s.set(r.id,{step:r,startMs:d})}),s}function sd(e,n){const s=Math.max(e.metadata.wallTimeMs,n.metadata.wallTimeMs,1);return Math.max(1e3,Math.min(5e3,Math.round(s*.1)))}function rd(e,n,s,r){const o=e.startMs;if(o==null)return null;let d=null,c=r+1;return n.forEach(m=>{const u=s.get(m);if(!u||u.startMs==null)return;const f=Math.abs(u.startMs-o);f<c&&(c=f,d=m)}),c<=r?d:null}const od=new Map,id=new Map,qt=new Map;async function ld(){return[en]}async function Fo(e){return{trace:en}}const cd={s1:{role:"assistant",content:"I'll analyze the user's request and create a plan to fetch information from two sources: a web search for current EU AI Act updates and a database query for historical compliance data.",model:"gpt-4o-2024-11-20",usage:{prompt_tokens:150,completion_tokens:150,total_tokens:300},reasoning:"The user wants comprehensive information about AI regulations. I'll use parallel tool calls to maximize efficiency."},s2:{role:"assistant",content:null,tool_calls:[{id:"tc-001",type:"function",function:{name:"web_search",arguments:'{"q":"EU AI Act latest updates 2026"}'}},{id:"tc-002",type:"function",function:{name:"database_query",arguments:`{"sql":"SELECT * FROM compliance_records WHERE region='EU' ORDER BY date DESC LIMIT 10"}`}}],model:"gpt-4o-2024-11-20",usage:{prompt_tokens:80,completion_tokens:40,total_tokens:120}},s3:{tool_call_id:"tc-001",tool_name:"web_search",input:{q:"EU AI Act latest updates 2026"},output:{results:[{title:"EU AI Act Implementation Timeline",url:"https://example.com/ai-act",snippet:"The EU AI Act enters full force in 2026..."},{title:"High-Risk AI Systems Classification",url:"https://example.com/classification",snippet:"New guidance on high-risk categorization..."},{title:"Compliance Deadlines Approaching",url:"https://example.com/deadlines",snippet:"Organizations must comply by August 2026..."}],total_results:3,search_time_ms:1850},status:"success"},s4:{tool_call_id:"tc-002",tool_name:"database_query",input:{sql:"SELECT * FROM compliance_records WHERE region='EU' ORDER BY date DESC LIMIT 10"},output:{rows:[{id:1,company:"TechCorp",status:"compliant",date:"2026-01-15"},{id:2,company:"AIStartup",status:"in_progress",date:"2026-01-10"},{id:3,company:"DataCo",status:"compliant",date:"2026-01-05"}],row_count:42,query_time_ms:1100},status:"success"},s5:{role:"assistant",content:`Based on my analysis of the web search results and database records:

**Key Findings:**
1. The EU AI Act is now in full effect as of 2026
2. High-risk AI systems require specific compliance measures
3. 42 organizations in our database have compliance records

**Recommendations:**
- Review classification of AI systems
- Ensure documentation is complete
- Schedule compliance audit before August deadline`,model:"gpt-4o-2024-11-20",usage:{prompt_tokens:450,completion_tokens:250,total_tokens:700},reasoning:"Synthesized information from both the web search (3 relevant articles) and database query (42 compliance records) to provide actionable insights."}};function dd(e,n){const s=en.steps.find(d=>d.id===e);if(!s)return null;const r=cd[e];if(!r)return null;const o=n?ud(r):r;return{...s,data:o}}function ud(e){var s,r;const n=JSON.parse(JSON.stringify(e));return(s=n.input)!=null&&s.sql&&(n.input.sql="[REDACTED]"),(r=n.output)!=null&&r.rows&&(n.output.rows=n.output.rows.map(o=>({...o,company:"[REDACTED]"}))),n.tool_calls&&(n.tool_calls=n.tool_calls.map(o=>({...o,function:{...o.function,arguments:"[REDACTED]"}}))),n}async function pd(e,n,s,r=[],o=!1){return await new Promise(d=>setTimeout(d,150)),dd(n,o)}async function ls(e,n,s){await pd(e,n,"redacted",[],s)}function md(e,n){return()=>{}}function hd(){od.clear(),id.clear()}async function fd(e,n){return null}async function gd(e){return null}async function xp(e,n){return[]}async function vp(e,n,s,r,o){return null}async function bd(){return[]}async function yd(e,n){return null}async function xd(e,n,s,r,o){return o?Bo(o,n,s,r):null}function Bo(e,n,s,r){var j;const o=JSON.parse(JSON.stringify(e)),d=6e4,c=Date.parse("2024-01-01T00:00:00.000Z"),m=Date.parse(e.endedAt??e.startedAt??""),f=(Number.isNaN(m)?c:m)+d,h=new Date(f);o.id=`${e.id}-replay-${f}`,o.parentTraceId=e.id,o.branchPointStepId=n,o.replay={strategy:s,modifiedStepId:n,modifications:r,createdAt:h.toISOString()};const g=b=>{if(!b)return b;const S=Date.parse(b);return Number.isNaN(S)?b:new Date(S+d).toISOString()};o.startedAt=g(o.startedAt)??o.startedAt,o.endedAt=g(o.endedAt);const v=new Set,w=((j=o.steps.find(b=>b.id===n))==null?void 0:j.index)??-1;return s==="live"?o.steps.forEach(b=>{b.index>w&&v.add(b.id)}):s==="hybrid"&&o.steps.forEach(b=>{b.index>w&&v.add(b.id)}),o.steps=o.steps.map(b=>{var C;const S={...b};if(S.startedAt=g(b.startedAt)??b.startedAt,S.endedAt=g(b.endedAt),b.id===n){const R=((C=b.preview)==null?void 0:C.outputPreview)??"";S.preview={...b.preview,outputPreview:`${R} (modified)`.trim()}}return v.has(b.id)&&(S.status="pending",S.endedAt=null,S.durationMs=void 0,S.metrics=void 0,S.preview={...b.preview,outputPreview:"[invalidated for replay]"}),S}),o}async function vd(e){return kd(e)}async function wd(e){var n;return((n=qt.get(e))==null?void 0:n.job)??null}async function co(e){var n;return((n=qt.get(e))==null?void 0:n.matrix)??null}async function jd(e){{const n=qt.get(e);if(!n)return null;const s={...n.job,status:"canceled",scenarios:n.job.scenarios.map(r=>({...r,status:"canceled",endedAt:r.endedAt??new Date().toISOString()}))};return qt.set(e,{...n,job:s}),s}}function kd(e){const n=`demo-job-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,s=en,r=new Date().toISOString(),o=e.scenarios.map((u,f)=>({id:`demo-scn-${f+1}`,name:u.name,strategy:u.strategy,modifications:u.modifications,status:"running",startedAt:r,endedAt:null,replayTraceId:`${n}-replay-${f+1}`})),d={id:n,traceId:e.traceId,stepId:e.stepId,status:"running",createdAt:r,startedAt:r,endedAt:null,scenarioCount:o.length,completedCount:0,failedCount:0,canceledCount:0,scenarios:o},c=o.map(u=>{const f=Bo(s,e.stepId,u.strategy,u.modifications);f.id=u.replayTraceId;const h=Lo(s,f),g=s.metadata.totalCostUsd??0,v=f.metadata.totalCostUsd??g,w=s.metadata.errorCount??0,j=f.metadata.errorCount??w,b=s.metadata.retryCount??0,S=f.metadata.retryCount??b,C=f.steps.filter(R=>R.status==="pending").length;return{scenarioId:u.id,name:u.name,strategy:u.strategy,status:"completed",replayTraceId:u.replayTraceId,modifications:u.modifications,error:null,changedStepIds:h.changedSteps,addedStepIds:h.addedSteps,removedStepIds:h.removedSteps,metrics:{costDeltaUsd:v-g,wallTimeDeltaMs:(f.metadata.wallTimeMs??0)-(s.metadata.wallTimeMs??0),errorDelta:j-w,retryDelta:S-b,changedSteps:h.changedSteps.length,addedSteps:h.addedSteps.length,removedSteps:h.removedSteps.length,invalidatedStepCount:C}}}),m={jobId:n,traceId:e.traceId,stepId:e.stepId,rows:c,causalRanking:[]};return qt.set(n,{job:d,matrix:m}),window.setTimeout(()=>{const u=qt.get(n);if(!u)return;const f=new Date().toISOString(),h=u.job.scenarios.map(w=>({...w,status:"completed",endedAt:f})),g={...u.job,status:"completed",endedAt:f,completedCount:h.length,scenarios:h},v={...u.matrix,rows:u.matrix.rows.map(w=>({...w,status:"completed"}))};qt.set(n,{job:g,matrix:v})},600),d}async function Sd(e){return null}async function Nd(e){return null}async function cs(e){return null}async function Cd(e){return null}async function Md(e){return null}async function Ed(e){return null}async function uo(e){return{session:null,conflict:!1,error:null}}async function po(e){return null}async function Id(e){return null}async function _d(e){return null}async function Td(e){return null}async function Rd(e){return null}async function Dd(e,n){return null}async function Od(e){return null}async function Ad(e,n,s){return null}async function mo(){return null}async function ho(){return null}function $d(e,n,s){return()=>{}}function Pd(){const[e,n]=l.useState(null),[s,r]=l.useState(null),[o,d]=l.useState(!0),[c,m]=l.useState(null),[u,f]=l.useState([]),[h,g]=l.useState(null),v=l.useCallback(async j=>{const b=await Fo(),S=(b==null?void 0:b.trace)??null;n(S),r(S?(b==null?void 0:b.insights)??Hl(S):null)},[n,r]),w=l.useCallback(async()=>{var j;d(!0),m(null);try{const b=await ld();f(b);const S=((j=b[b.length-1])==null?void 0:j.id)??null,C=h??S;if(!C){n(null),r(null);return}if(!h||h!==C){g(C);return}await v(C)}catch(b){m(b instanceof Error?b.message:"Failed to load trace")}finally{d(!1)}},[h,v]);return l.useEffect(()=>{w()},[w]),l.useEffect(()=>{h&&(d(!0),v(h).catch(j=>{m(j instanceof Error?j.message:"Failed to load trace")}).finally(()=>d(!1)))},[h,v]),l.useEffect(()=>md(),[h,g]),{trace:e,insights:s,loading:o,error:c,reload:w,traces:u,selectedTraceId:h,setSelectedTraceId:g}}function V(e,n){const[s,r]=l.useState(()=>{if(typeof window>"u")return n;try{const o=window.localStorage.getItem(e);return o==null?n:JSON.parse(o)}catch{return n}});return l.useEffect(()=>{try{window.localStorage.setItem(e,JSON.stringify(s))}catch{}},[e,s]),[s,r]}const fo=new Map;function Ld(e,n){const s=e.map(o=>o.id).join("|"),r=n.map(o=>`${o.source}->${o.target}`).join("|");return`${e.length}:${n.length}:${s}:${r}`}function Fd(e,n,s){if(s){const r=Ld(e,n),o=fo.get(s);if(o&&o.signature===r)return o.layout;const d=go(e,n);return fo.set(s,{signature:r,layout:d}),d}return go(e,n)}function go(e,n){if(e.length>2500){const r=Math.ceil(Math.sqrt(e.length));return e.map((o,d)=>{const c=Math.floor(d/r),m=d%r;return{id:o.id,position:{x:m*260,y:c*160}}})}const s=new Vr.graphlib.Graph;return s.setGraph({rankdir:"LR",nodesep:48,ranksep:80}),s.setDefaultEdgeLabel(()=>({})),e.forEach(r=>{s.setNode(r.id,{width:220,height:120})}),n.forEach(r=>{s.setEdge(r.source,r.target)}),Vr.layout(s),e.map(r=>{const o=s.node(r.id);return{id:r.id,position:{x:o.x-o.width/2,y:o.y-o.height/2}}})}const qo="agentDirector.gameplayFunnel.v1";function Bd(){try{const e=window.localStorage.getItem(qo);if(!e)return[];const n=JSON.parse(e);return Array.isArray(n)?n.filter(s=>{if(!s||typeof s!="object")return!1;const r=s;return typeof r.name=="string"&&typeof r.at=="number"&&!!r.metadata&&typeof r.metadata=="object"}):[]}catch{return[]}}function qd(e,n={}){const s={name:e,at:Date.now(),metadata:n},o=[...Bd(),s].slice(-200);return window.localStorage.setItem(qo,JSON.stringify(o)),s}function zd(e){const n=new Map;for(const r of e)r.type==="tool_call"&&r.toolCallId&&n.set(r.toolCallId,r.id);const s=[];for(const r of e)if(!(r.type!=="llm_call"||!r.io)){for(const o of r.io.emittedToolCallIds??[]){const d=n.get(o);d&&s.push({id:`io_emit_${r.id}_${d}`,source:r.id,target:d,kind:"io",toolCallId:o})}for(const o of r.io.consumedToolCallIds??[]){const d=n.get(o);d&&s.push({id:`io_consume_${d}_${r.id}`,source:d,target:r.id,kind:"io",toolCallId:o})}}return s}function Gd(e,n,s){const{intervals:r}=Za(e,n,s),o=new Set;return r.forEach(d=>{o.add(d.startMs),o.add(d.endMs)}),Array.from(o).sort((d,c)=>d-c)}function Ud(e,n,s){if(!e.length)return null;if(s===1){for(const r of e)if(r>n+1)return r;return e[e.length-1]}for(let r=e.length-1;r>=0;r-=1){const o=e[r];if(o<n-1)return o}return e[0]}const Hd=300,Wd=2e3,Vd=1.5;function Jd(e){const n=Hd*Math.pow(Vd,Math.max(0,e));return Math.min(Wd,Math.round(n))}function Et(e,n){if(!e)return n;try{return JSON.parse(e)}catch{return n}}function bo(e,n){const s=new Map;return[...e,...n].forEach(r=>{const o=s.get(r.id);(!o||r.updatedAt>=o.updatedAt)&&s.set(r.id,r)}),Array.from(s.values()).sort((r,o)=>r.createdAt-o.createdAt)}function yo(e,n=50){return[...e].sort((s,r)=>r.timestamp-s.timestamp).slice(0,n)}const xo=["latency storm","cache divergence","tool timeout chain","stale prompt vector","schema mismatch surge"],ds=[{templateId:"pack-stability-bootstrap",title:"Stability Bootstrap",archetype:"stability",depthMin:1,depthMax:3,baseDifficulty:2,hazards:["latency storm","cache divergence"],rewardCredits:78},{templateId:"pack-drift-containment",title:"Drift Containment",archetype:"containment",depthMin:1,depthMax:4,baseDifficulty:2,hazards:["stale prompt vector","schema mismatch surge"],rewardCredits:82},{templateId:"pack-timeout-circuit-breaker",title:"Timeout Circuit Breaker",archetype:"resilience",depthMin:2,depthMax:5,baseDifficulty:3,hazards:["tool timeout chain","schema mismatch surge"],rewardCredits:90},{templateId:"pack-cache-realignment",title:"Cache Realignment",archetype:"forensics",depthMin:2,depthMax:6,baseDifficulty:3,hazards:["cache divergence","schema mismatch surge"],rewardCredits:96},{templateId:"pack-pipeline-quarantine",title:"Pipeline Quarantine",archetype:"containment",depthMin:3,depthMax:7,baseDifficulty:4,hazards:["stale prompt vector","tool timeout chain"],rewardCredits:102},{templateId:"pack-latency-decoupling",title:"Latency Decoupling",archetype:"throughput",depthMin:3,depthMax:8,baseDifficulty:4,hazards:["latency storm","tool timeout chain"],rewardCredits:108},{templateId:"pack-spec-reconciliation",title:"Spec Reconciliation",archetype:"forensics",depthMin:4,depthMax:9,baseDifficulty:5,hazards:["schema mismatch surge","cache divergence"],rewardCredits:114},{templateId:"pack-fault-isolation-grid",title:"Fault Isolation Grid",archetype:"diagnostics",depthMin:4,depthMax:10,baseDifficulty:5,hazards:["schema mismatch surge","stale prompt vector"],rewardCredits:120},{templateId:"pack-shadow-fork-audit",title:"Shadow Fork Audit",archetype:"timelines",depthMin:5,depthMax:11,baseDifficulty:6,hazards:["stale prompt vector","latency storm"],rewardCredits:126},{templateId:"pack-signal-recovery-run",title:"Signal Recovery Run",archetype:"recovery",depthMin:5,depthMax:12,baseDifficulty:6,hazards:["tool timeout chain","cache divergence"],rewardCredits:132},{templateId:"pack-entropy-firebreak",title:"Entropy Firebreak",archetype:"stability",depthMin:6,depthMax:13,baseDifficulty:7,hazards:["schema mismatch surge","tool timeout chain"],rewardCredits:138},{templateId:"pack-pressure-release",title:"Pressure Release",archetype:"throughput",depthMin:6,depthMax:14,baseDifficulty:7,hazards:["latency storm","stale prompt vector"],rewardCredits:144},{templateId:"pack-replay-integrity-probe",title:"Replay Integrity Probe",archetype:"diagnostics",depthMin:7,depthMax:15,baseDifficulty:8,hazards:["cache divergence","tool timeout chain"],rewardCredits:150},{templateId:"pack-phased-countermeasure",title:"Phased Countermeasure",archetype:"boss",depthMin:7,depthMax:16,baseDifficulty:8,hazards:["tool timeout chain","schema mismatch surge"],rewardCredits:156},{templateId:"pack-cascade-rollup",title:"Cascade Rollup",archetype:"recovery",depthMin:8,depthMax:18,baseDifficulty:9,hazards:["schema mismatch surge","latency storm"],rewardCredits:162},{templateId:"pack-hyperlane-retune",title:"Hyperlane Retune",archetype:"timelines",depthMin:8,depthMax:20,baseDifficulty:9,hazards:["stale prompt vector","cache divergence"],rewardCredits:168},{templateId:"pack-guardian-gambit",title:"Guardian Gambit",archetype:"stability",depthMin:9,depthMax:24,baseDifficulty:10,hazards:["schema mismatch surge","latency storm"],rewardCredits:176},{templateId:"pack-final-lockdown",title:"Final Lockdown",archetype:"boss",depthMin:10,depthMax:Number.MAX_SAFE_INTEGER,baseDifficulty:10,hazards:["tool timeout chain","cache divergence"],rewardCredits:184}],bs=5,vo=[{id:"seasonal-incident-sprint",title:"Resolve 3 raid objectives",goal:3,rewardCredits:120},{id:"boss-shutdown",title:"Defeat one boss encounter",goal:1,rewardCredits:200},{id:"guild-push",title:"Complete 2 guild operations",goal:2,rewardCredits:160},{id:"timeline-weaver",title:"Merge 2 timeline forks",goal:2,rewardCredits:150}],Kd={stability_patch:{credits:20,materials:12},precision_lens:{credits:28,materials:16},overclock_core:{credits:42,materials:24}};function de(e,n,s){return Math.min(s,Math.max(n,e))}function Xa(e){let n=0;for(let s=0;s<e.length;s+=1)n=(n*31+e.charCodeAt(s))%1e5;return n}function Qd(e,n,s,r){if(r.length===0)return 96;const o=r.slice(-bs),d=new Set(o.map(g=>g.templateId)),c=new Set(o.map(g=>g.archetype)),m=new Set(o.flatMap(g=>g.hazards.map(v=>v.toLowerCase())));let h=58+[...new Set(e.map(g=>g.toLowerCase()))].filter(g=>!m.has(g)).length*12;return d.has(n)?h-=10:h+=14,c.has(s)||(h+=10),de(h,20,100)}function Yd(e,n,s,r){const o=r.slice(-bs);if(o.length===0)return 0;const d=new Set(e.map(m=>m.toLowerCase()));let c=0;return[...o].reverse().forEach((m,u)=>{const f=Math.max(1,bs-u),h=m.hazards.filter(g=>d.has(g.toLowerCase())).length;c+=h*4*f,m.templateId===n&&(c+=8*f),m.archetype===s&&(c+=4*f)}),de(c,0,72)}function Xd(e,n,s,r){const o=Xa(`${e}:${n}:${s.join("|")}`),d=[...new Set(s.map(w=>w.trim()).filter(Boolean))].sort().slice(-2),c=ds.filter(w=>n>=w.depthMin&&n<=w.depthMax),u=(c.length>0?c:ds).map(w=>{const j=Xa(`${o}:${w.templateId}`),b=xo[j%xo.length],S=[...new Set([...w.hazards,b,...d.slice(-1)])].slice(0,4),C=Qd(S,w.templateId,w.archetype,r),R=Yd(S,w.templateId,w.archetype,r),K=de(w.baseDifficulty+Math.floor(n/4),1,10),_=de(Math.round(46+C*.5-R*.45+K*3),0,100),O=Xa(`${j}:${r.length}:${n}`);return{template:w,candidateSeed:j,hazards:S,noveltyScore:C,repetitionPenalty:R,qualityScore:_,difficulty:K,tieBreaker:O}});u.sort((w,j)=>w.qualityScore!==j.qualityScore?w.qualityScore-j.qualityScore:w.noveltyScore!==j.noveltyScore?w.noveltyScore-j.noveltyScore:w.repetitionPenalty!==j.repetitionPenalty?j.repetitionPenalty-w.repetitionPenalty:w.tieBreaker-j.tieBreaker);const f=u[u.length-1],h=1+Math.min(n,12)*.04,g=Math.round(f.template.rewardCredits*h),v=[`seed=${f.candidateSeed}`,`depth=${n}`,`mutators=${d.join(",")||"none"}`,`template=${f.template.templateId}`,`archetype=${f.template.archetype}`].join(";");return{id:`mission-${n}-${f.template.templateId.replace("pack-","")}-${(e+n)%997}`,title:f.template.title,difficulty:f.difficulty,hazards:f.hazards,rewardCredits:g,missionSeed:f.candidateSeed,blueprint:v,templateId:f.template.templateId,archetype:f.template.archetype,qualityScore:f.qualityScore,noveltyScore:f.noveltyScore,repetitionPenalty:f.repetitionPenalty,launchPackSize:ds.length}}function zo(e,n,s,r){return Xd(e,n,s,r)}function Zd(){return[{id:"node-alpha",title:"Signal Fracture",body:"Telemetry divergence emerges across parallel tool paths.",choices:[{id:"alpha-risk",label:"Push aggressive branch optimization",nextNodeId:"node-beta",tensionDelta:12,mutator:"risk-surge"},{id:"alpha-safe",label:"Stabilize and preserve deterministic flow",nextNodeId:"node-beta",tensionDelta:-5,mutator:"stability-first"}]},{id:"node-beta",title:"Protocol Fork",body:"The team must choose speed versus interpretability under pressure.",choices:[{id:"beta-speed",label:"Favor speed and absorb uncertainty",nextNodeId:"node-gamma",tensionDelta:8,mutator:"throughput-boost"},{id:"beta-clarity",label:"Favor clarity and route through guardrails",nextNodeId:"node-gamma",tensionDelta:-3,mutator:"clarity-path"}]},{id:"node-gamma",title:"Final Directive",body:"Command has one move left before the run locks in.",choices:[{id:"gamma-strike",label:"Launch decisive strike sequence",nextNodeId:"node-alpha",tensionDelta:10,mutator:"strike-loop"},{id:"gamma-reset",label:"Reset tempo and rebuild confidence",nextNodeId:"node-alpha",tensionDelta:-6,mutator:"tempo-reset"}]}]}function Go(e,n){return{...vo[(e+n)%vo.length],progress:0,completed:!1}}function Uo(e,n){const s=[...e,n];return Array.from(new Set(s)).slice(-6)}function ys(e,n,s,r){return{...e,campaign:{...e.campaign,depth:n,mutators:s,missionHistory:r,currentMission:zo(e.seed,n,s,r)}}}function wo(e){const n=Xa(e),s=["baseline"];return{seed:n,raid:{party:["director"],roles:{director:"strategist"},objectives:[{id:"obj-root-cause",label:"Identify root cause chain",progress:0,target:100,completed:!1},{id:"obj-recover",label:"Recover operational stability",progress:0,target:100,completed:!1},{id:"obj-harden",label:"Harden replay strategy",progress:0,target:100,completed:!1}],completed:!1},campaign:{depth:1,lives:3,completedMissionIds:[],missionHistory:[],mutators:s,currentMission:zo(n,1,s,[])},narrative:{currentNodeId:"node-alpha",nodes:Zd(),history:[],tension:35},skills:{points:6,nodes:[{id:"skill-focus",label:"Focus Matrix",cost:1,requires:[],minLevel:1,requiredMilestones:[],tier:1,loadoutSlot:"core",unlocked:!1},{id:"skill-resilience",label:"Resilience Mesh",cost:1,requires:[],minLevel:1,requiredMilestones:[],tier:1,loadoutSlot:"utility",unlocked:!1},{id:"skill-surge",label:"Surge Compiler",cost:2,requires:["skill-focus"],minLevel:2,requiredMilestones:[],tier:2,loadoutSlot:"power",unlocked:!1},{id:"skill-echo",label:"Echo Anticipator",cost:2,requires:["skill-resilience"],minLevel:2,requiredMilestones:[],tier:2,loadoutSlot:"utility",unlocked:!1},{id:"skill-ward",label:"Ward Lattice",cost:2,requires:["skill-resilience"],minLevel:3,requiredMilestones:["milestone-level-3"],tier:3,loadoutSlot:"power",unlocked:!1},{id:"skill-overclock",label:"Overclock Nexus",cost:3,requires:["skill-surge","skill-echo"],minLevel:4,requiredMilestones:["milestone-level-3"],tier:3,loadoutSlot:"power",unlocked:!1}],loadout:{capacity:3,equipped:[],slotCaps:{core:1,utility:1,power:1}}},pvp:{round:0,stability:72,sabotage:28,fog:40,winner:null},time:{activeForkId:"primary",forks:[{id:"primary",label:"Primary timeline",playheadMs:0,history:[0]}]},boss:{name:"The Causality Hydra",phase:1,hp:320,maxHp:320,enraged:!1,phaseMechanic:"Phase 1: Shield lattice destabilization",vulnerability:"exploit"},director:{risk:30,hint:"Start with the bottleneck path and branch cautiously.",recommendedModifier:"stability_patch",lastOutcome:"mixed"},economy:{credits:140,materials:90,crafted:[],inflationIndex:.438,reserveTarget:320},rewards:{dailyClaimedOn:null,streakDays:0,sessionClaimed:!1,streakClaimedFor:0,masteryClaims:[],history:[]},guild:{name:"Trace Guild",members:4,operationsScore:0,eventsCompleted:0},cinematic:{queue:[]},liveops:{season:`Season-${2026+n%2}`,week:1,challenge:Go(n,1),difficultyFactor:1,rewardMultiplier:1,tuningHistory:[]},teamComms:{pings:[]},safety:{mutedPlayerIds:[],blockedPlayerIds:[],reports:[]},outcome:{status:"in_progress",reason:"Run started. Complete missions and stabilize the incident.",updatedAt:Date.now()},sandbox:{enabled:!1},progression:{xp:0,level:1,nextLevelXp:200,milestones:[]}}}function wp(e,n){return{...e,sandbox:{enabled:n},outcome:n?{status:"in_progress",reason:"Sandbox mode enabled. Penalties are disabled for safe practice runs.",updatedAt:Date.now()}:e.outcome}}function jp(e,n,s){if(!n.trim())return e;const r=e.raid.party.includes(n)?e.raid.party:[...e.raid.party,n];return{...e,raid:{...e.raid,party:r,roles:{...e.raid.roles,[n]:s}}}}function kp(e,n,s){const r=Ms(e),o=e.raid.objectives.map(u=>{if(u.id!==n)return u;const f=de(u.progress+s,0,u.target);return{...u,progress:f,completed:f>=u.target}}),d=o.every(u=>u.completed),c=d&&!e.raid.completed?180:0,m={...e,raid:{...e.raid,objectives:o,completed:d},outcome:d&&!e.raid.completed?{status:"partial",reason:"Raid objectives completed. Push campaign and boss tracks to close the run.",updatedAt:Date.now()}:r};return!d||e.raid.completed?m:ut(Na(m,c),60)}function Sp(e,n){const s=ru(e),r=e.campaign.currentMission,o=n?"success":"failure",d=[...e.campaign.missionHistory,{missionId:r.id,templateId:r.templateId??"legacy-template",archetype:r.archetype??"legacy",hazards:r.hazards,qualityScore:r.qualityScore??50,noveltyScore:r.noveltyScore??50,repetitionPenalty:r.repetitionPenalty??0,outcome:o}].slice(-30);if(n){const h=e.campaign.depth+1,g=ys(e,h,e.campaign.mutators,d),v=h>=5?{status:"win",reason:"Campaign depth target reached. Incident run is stabilized.",updatedAt:Date.now()}:{status:"partial",reason:`Mission ${r.id} cleared. Advance deeper to secure the run.`,updatedAt:Date.now()},w={...g,campaign:{...g.campaign,completedMissionIds:[...g.campaign.completedMissionIds,r.id]},economy:{...g.economy,materials:g.economy.materials+14},director:{...g.director,lastOutcome:"success"},outcome:v};return ut(Na(w,r.rewardCredits),120)}const c=s.enabled?e.campaign.lives:de(e.campaign.lives-1,0,3),m=ys(e,e.campaign.depth,Uo(e.campaign.mutators,"failure-loop"),d),u=s.enabled?{status:"partial",reason:"Sandbox mode active. Failure recorded with no life penalty.",updatedAt:Date.now()}:c<=0?{status:"loss",reason:"No campaign lives remaining. Incident run failed.",updatedAt:Date.now()}:{status:"partial",reason:`Mission failed. ${c} campaign lives remaining.`,updatedAt:Date.now()},f={...m,campaign:{...m.campaign,lives:c},director:{...m.director,lastOutcome:"failure"},outcome:u};return ut(f,40)}function Np(e,n){const s=e.narrative.nodes.find(m=>m.id===e.narrative.currentNodeId),r=s==null?void 0:s.choices.find(m=>m.id===n);if(!s||!r)return e;const o=de(e.narrative.tension+r.tensionDelta,0,100),d=Uo(e.campaign.mutators,r.mutator),c=ys(e,e.campaign.depth,d,e.campaign.missionHistory);return{...c,narrative:{...c.narrative,currentNodeId:r.nextNodeId,history:[...c.narrative.history,{nodeId:s.id,choiceId:r.id}],tension:o}}}function Cp(e,n){const s=e.skills.nodes.find(o=>o.id===n);return!s||!eu(e,n).allowed?e:{...e,skills:{...e.skills,points:e.skills.points-s.cost,nodes:e.skills.nodes.map(o=>o.id===n?{...o,unlocked:!0}:o)}}}function Mp(e,n){return tu(e,n).allowed?{...e,skills:{...e.skills,loadout:{...e.skills.loadout,equipped:[...e.skills.loadout.equipped,n]}}}:e}function eu(e,n){const s=e.skills.nodes.find(m=>m.id===n);if(!s)return{allowed:!1,reason:"Unknown skill node."};if(s.unlocked)return{allowed:!1,reason:"Skill already unlocked."};const r=new Set(e.skills.nodes.filter(m=>m.unlocked).map(m=>m.id)),o=s.requires.filter(m=>!r.has(m));if(o.length>0)return{allowed:!1,reason:`Requires: ${o.join(", ")}`};const d=Wo(e);if(d.level<s.minLevel)return{allowed:!1,reason:`Requires level ${s.minLevel}`};const c=s.requiredMilestones.filter(m=>!d.milestones.includes(m));return c.length>0?{allowed:!1,reason:`Requires milestone ${c[0]}`}:e.skills.points<s.cost?{allowed:!1,reason:`Need ${s.cost} points`}:{allowed:!0,reason:"Unlock available"}}function tu(e,n){const s=e.skills.nodes.find(d=>d.id===n);if(!s)return{allowed:!1,reason:"Unknown skill node."};if(!s.unlocked)return{allowed:!1,reason:"Unlock required before equip."};if(e.skills.loadout.equipped.includes(n))return{allowed:!1,reason:"Already equipped."};if(e.skills.loadout.equipped.length>=e.skills.loadout.capacity)return{allowed:!1,reason:"Loadout capacity reached."};const r=e.skills.loadout.slotCaps[s.loadoutSlot];return e.skills.loadout.equipped.reduce((d,c)=>{const m=e.skills.nodes.find(u=>u.id===c);return(m==null?void 0:m.loadoutSlot)===s.loadoutSlot?d+1:d},0)>=r?{allowed:!1,reason:`${s.loadoutSlot} slot limit reached.`}:{allowed:!0,reason:"Equip available"}}function Ep(e,n){const s=Ms(e),r={...e.pvp};n==="sabotage"?(r.sabotage=de(r.sabotage+13,0,100),r.stability=de(r.stability-11,0,100),r.fog=de(r.fog+9,0,100)):n==="stabilize"?(r.stability=de(r.stability+14,0,100),r.sabotage=de(r.sabotage-8,0,100),r.fog=de(r.fog-6,0,100)):(r.fog=de(r.fog-16,0,100),r.stability=de(r.stability+3,0,100),r.sabotage=de(r.sabotage-4,0,100)),r.round+=1,r.stability<=0?r.winner="saboteur":r.sabotage<=0?r.winner="operator":r.round>=10&&(r.winner=r.stability>=r.sabotage?"operator":"saboteur");const o=r.winner==="operator"?{status:"win",reason:"Operator side prevailed in the sabotage conflict.",updatedAt:Date.now()}:r.winner==="saboteur"?{status:"loss",reason:"Saboteur pressure overwhelmed system stability.",updatedAt:Date.now()}:s,d={...e,pvp:r,outcome:o};return ut(d,r.winner?72:12)}function Ip(e,n,s){const r=`fork-${e.time.forks.length+1}`,o={id:r,label:n.trim()||r,playheadMs:de(s,0,36e5),history:[de(s,0,36e5)]};return{...e,time:{...e.time,activeForkId:r,forks:[...e.time.forks,o]}}}function _p(e,n){const s=e.time.activeForkId,r=e.time.forks.map(o=>{if(o.id!==s)return o;const d=de(o.playheadMs-Math.abs(n),0,36e5);return{...o,playheadMs:d,history:[...o.history,d]}});return{...e,time:{...e.time,forks:r}}}function Tp(e,n){if(n==="primary")return e;const s=e.time.forks.find(d=>d.id===n),r=e.time.forks.find(d=>d.id==="primary");if(!s||!r)return e;const o={...r,playheadMs:s.playheadMs,history:[...r.history,s.playheadMs]};return{...e,time:{activeForkId:"primary",forks:[o,...e.time.forks.filter(d=>d.id!=="primary"&&d.id!==n)]}}}function Rp(e,n){const s=Ms(e),o={1:{exploit:42,strike:24,shield:8},2:{exploit:34,strike:28,shield:10},3:{exploit:26,strike:18,shield:14}}[e.boss.phase][n],d=e.boss.vulnerability===n?8:0,c=o+d,m=de(e.boss.hp-c,0,e.boss.maxHp),u=m/e.boss.maxHp,f=u<=.33?3:u<=.66?2:1,h=f===1?"Phase 1: Shield lattice destabilization":f===2?"Phase 2: Mirror clones absorb exploit damage":"Phase 3: Enrage pulse; shield counters become lethal",g=f===1?"exploit":f===2?"strike":"shield",v={...e,boss:{...e.boss,hp:m,phase:f,enraged:f===3||m<=e.boss.maxHp*.2,phaseMechanic:h,vulnerability:g},outcome:m<=0?{status:"win",reason:"Boss encounter cleared. Run secured.",updatedAt:Date.now()}:s};return ut(v,m<=0?180:10)}function Dp(e,n){const s=n.failures*12+n.retries*4+(n.latencyMs>1400?8:0),r=de(e.director.risk+s,0,100),o=n.failures>0?"Prioritize failure triage and run a stabilizing replay branch.":n.latencyMs>1400?"Latency pressure detected. Reduce fan-out and tighten tool boundaries.":"Momentum is stable. Push a high-confidence optimization branch.",d=n.failures>1?"stability_patch":n.latencyMs>1400?"precision_lens":"overclock_core",c=n.failures>0?"failure":"success";return{...e,director:{risk:r,hint:o,recommendedModifier:d,lastOutcome:c}}}function Op(e,n){const s=Kd[n];if(!s||e.economy.credits<s.credits||e.economy.materials<s.materials)return e;const r=e.economy.crafted.includes(n)?e.economy.crafted:[...e.economy.crafted,n],o=e.economy.reserveTarget||320,d=e.economy.credits-s.credits;let c={...e,economy:{...e.economy,credits:d,materials:e.economy.materials-s.materials,crafted:r,inflationIndex:Number((d/o).toFixed(3))}};return n==="stability_patch"&&(c={...c,pvp:{...c.pvp,stability:de(c.pvp.stability+8,0,100)}}),n==="precision_lens"&&(c={...c,raid:{...c.raid,objectives:c.raid.objectives.map((m,u)=>u===0?{...m,progress:de(m.progress+10,0,m.target),completed:de(m.progress+10,0,m.target)>=m.target}:m)}}),n==="overclock_core"&&(c={...c,boss:{...c.boss,hp:de(c.boss.hp-16,0,c.boss.maxHp)}}),ut(c,10)}function Ap(e,n){const s=Math.round(n),r={...e,guild:{...e.guild,operationsScore:e.guild.operationsScore+s,eventsCompleted:e.guild.eventsCompleted+(s>0?1:0)}},o=s>0?Na(r,s*3):r;return ut(o,Math.max(0,s*6))}function $p(e,n,s,r){const o={id:`event-${e.cinematic.queue.length+1}-${e.seed%1e3}`,type:n,message:s,intensity:r,at:Date.now()};return{...e,cinematic:{queue:[o,...e.cinematic.queue].slice(0,12)}}}function Pp(e){const n=Ns(e),s=n.week+1,r=Go(e.seed,s),o=de(n.difficultyFactor??1,.6,1.6),d=de(n.rewardMultiplier??1,.5,2),c={...r,goal:Math.max(1,Math.round(r.goal*o)),rewardCredits:Math.max(1,Math.round(r.rewardCredits*d))},m={...e,liveops:{...n,week:s,challenge:c}};return nu(m)}function Lp(e,n){const s=Ns(e),r=s.challenge,o=de(n,0,20),d=de(r.progress+o,0,r.goal),c=d>=r.goal,m={...e,liveops:{...s,challenge:{...r,progress:d,completed:c}}};return!c||r.completed?m:ut(Na(m,r.rewardCredits),80)}function au(e,n,s="raid_mastery"){const r=Ho(e),o=new Date().toISOString().slice(0,10);return n==="daily"?r.dailyClaimedOn===o?{allowed:!1,reason:"Daily reward already claimed today."}:{allowed:!0,reason:"Daily reward available."}:n==="session"?r.sessionClaimed?{allowed:!1,reason:"Session reward already claimed."}:e.raid.objectives.some(m=>m.progress>0)||e.campaign.depth>1||e.pvp.round>0?{allowed:!0,reason:"Session reward available."}:{allowed:!1,reason:"Session reward requires gameplay activity."}:n==="streak"?r.streakDays<3?{allowed:!1,reason:"Streak reward requires 3+ daily claims."}:r.streakClaimedFor>=r.streakDays?{allowed:!1,reason:"Streak reward already claimed for current streak."}:{allowed:!0,reason:"Streak reward available."}:r.masteryClaims.includes(s)?{allowed:!1,reason:"Mastery reward already claimed."}:(s==="raid_mastery"?e.raid.completed:s==="campaign_mastery"?e.campaign.depth>=4:e.boss.hp<=0)?{allowed:!0,reason:"Mastery reward available."}:{allowed:!1,reason:"Mastery requirement not met."}}function Fp(e,n,s="raid_mastery"){if(!au(e,n,s).allowed)return e;const o=Ho(e),d=new Date().toISOString().slice(0,10);let c=o,m=0,u={};if(n==="daily"){const v=o.dailyClaimedOn===d?o.streakDays:o.streakDays+1;c={...o,dailyClaimedOn:d,streakDays:v},m=90+Math.min(7,v)*10,u={streakDays:v}}else n==="session"?(c={...o,sessionClaimed:!0},m=140,u={actions:e.pvp.round+e.narrative.history.length+e.campaign.depth}):n==="streak"?(c={...o,streakClaimedFor:o.streakDays},m=170+o.streakDays*5,u={streakDays:o.streakDays}):(c={...o,masteryClaims:[...o.masteryClaims,s]},m=s==="boss_mastery"?260:s==="campaign_mastery"?220:180,u={masteryId:s});const f=Na({...e,rewards:c},m),h=Math.max(1,f.economy.credits-e.economy.credits),g={id:`reward-${c.history.length+1}-${e.seed%1e3}`,kind:n,amount:h,at:Date.now(),details:u};return ut({...f,rewards:{...c,history:[g,...c.history].slice(0,60)}},30+Math.max(1,Math.round(h/10)))}function Bp(e,n){const s=Ns(e),r=de(n.difficultyFactor,.6,1.6),o=de(n.rewardMultiplier,.5,2),d=s.difficultyFactor||1,c=s.rewardMultiplier||1,m=n.note.trim()||"Operator tuning update",u={...s.challenge,goal:Math.max(1,Math.round(s.challenge.goal/d*r)),rewardCredits:Math.max(1,Math.round(s.challenge.rewardCredits/c*o))},f={id:`tuning-${s.tuningHistory.length+1}-${e.seed%1e3}`,changedAt:Date.now(),difficultyFactor:r,rewardMultiplier:o,note:m};return{...e,liveops:{...s,challenge:u,difficultyFactor:r,rewardMultiplier:o,tuningHistory:[f,...s.tuningHistory].slice(0,20)}}}function Na(e,n){if(n<=0)return e;const s=e.economy.reserveTarget||320,r=e.economy.credits;let o=1;if(r<=s){const h=Math.min(.12,(s-r)/s*.12);o=Math.min(1.12,1+h)}else{const h=(r-s)/s;o=Math.max(.45,1-h*.35)}const d=Math.max(1,Math.round(n*o)),c=Math.round(s*1.7),m=r+d,u=m>c?Math.max(1,Math.round((m-c)*.22)):0,f=m-u;return{...e,economy:{...e.economy,credits:f,inflationIndex:Number((f/s).toFixed(3))}}}function nu(e){const n=e.economy.reserveTarget||320;if(e.economy.credits<=n)return{...e,economy:{...e.economy,inflationIndex:Number((e.economy.credits/n).toFixed(3))}};const s=Math.max(6,Math.round((e.economy.credits-n)*.08)),r=Math.max(0,e.economy.credits-s);return{...e,economy:{...e.economy,credits:r,inflationIndex:Number((r/n).toFixed(3))}}}function Ns(e){var n,s,r,o,d,c;return{season:((n=e.liveops)==null?void 0:n.season)??"Season-2026",week:((s=e.liveops)==null?void 0:s.week)??1,challenge:((r=e.liveops)==null?void 0:r.challenge)??{id:"fallback-liveops",title:"Complete one objective",goal:1,progress:0,rewardCredits:100,completed:!1},difficultyFactor:((o=e.liveops)==null?void 0:o.difficultyFactor)??1,rewardMultiplier:((d=e.liveops)==null?void 0:d.rewardMultiplier)??1,tuningHistory:((c=e.liveops)==null?void 0:c.tuningHistory)??[]}}function Ho(e){return e.rewards??{dailyClaimedOn:null,streakDays:0,sessionClaimed:!1,streakClaimedFor:0,masteryClaims:[],history:[]}}function su(e){return e.teamComms??{pings:[]}}function tn(e){return e.trim().toLowerCase()}function Cs(e){return e.safety??{mutedPlayerIds:[],blockedPlayerIds:[],reports:[]}}function qp(e,n,s,r="director"){const o=n,d=(s??"").trim(),c=d.length>0;if(c&&!e.raid.objectives.some(f=>f.id===d))return e;const m=su(e),u={id:`ping-${m.pings.length+1}-${e.seed%1e3}`,fromPlayerId:tn(r)||"director",intent:o,targetObjectiveId:c?d:null,createdAt:Date.now()};return{...e,teamComms:{pings:[u,...m.pings].slice(0,50)}}}function Ms(e){return e.outcome??{status:"in_progress",reason:"Run in progress.",updatedAt:Date.now()}}function ru(e){return e.sandbox??{enabled:!1}}function Wo(e){return e.progression??{xp:0,level:1,nextLevelXp:200,milestones:[]}}function ut(e,n){if(n<=0)return e;const s=Wo(e);let r=s.xp+n,o=s.level,d=s.nextLevelXp,c=0;for(;r>=d;)r-=d,o+=1,c+=1,d=o*200;const m=[...s.milestones];return[3,5,10].forEach(u=>{const f=`milestone-level-${u}`;o>=u&&!m.includes(f)&&m.push(f)}),{...e,progression:{xp:r,level:o,nextLevelXp:d,milestones:m},skills:{...e.skills,points:e.skills.points+c}}}function zp(e,n,s){const r=tn(n),o=s.trim();if(!r||!o)return e;const d=Cs(e),c={id:`report-${d.reports.length+1}-${e.seed%1e3}`,targetPlayerId:r,reason:o,createdAt:Date.now()};return{...e,safety:{...d,reports:[c,...d.reports].slice(0,40)}}}function Gp(e,n){const s=tn(n),r=Cs(e);return!s||r.mutedPlayerIds.includes(s)?e:{...e,safety:{...r,mutedPlayerIds:[...r.mutedPlayerIds,s]}}}function Up(e,n){const s=tn(n),r=Cs(e);return!s||r.blockedPlayerIds.includes(s)?e:{...e,safety:{...r,blockedPlayerIds:[...r.blockedPlayerIds,s],mutedPlayerIds:r.mutedPlayerIds.includes(s)?r.mutedPlayerIds:[...r.mutedPlayerIds,s]}}}const jo={en:{setup_support_title:"Setup + support",open_setup_wizard:"Open setup wizard",open_support_panel:"Open support panel",telemetry_summary_title:"Telemetry summary",telemetry_summary_body:"Product events are captured in local analytics queue for pre-release UX audits.",export_event_queue:"Export event queue",settings_center_title:"Settings center",settings_center_body:"Centralized controls for input, UX behavior, and safe sharing defaults.",safe_export:"Safe export",gamepad_enabled:"Gamepad enabled",timeline_windowing:"Timeline windowing",theme_label:"Theme",motion_label:"Motion",app_language_label:"App language",gameplay_locale_label:"Gameplay locale",traceql_placeholder:"TraceQL (example: type=tool_call and duration_ms>800)",run_traceql:"Run TraceQL",clear_traceql:"Clear TraceQL",select_extension:"Select extension",run_extension:"Run extension",running_extension:"Running extension...",mode_cinema:"Cinema",mode_flow:"Flow",mode_compare:"Compare",mode_matrix:"Matrix",mode_gameplay:"Gameplay",windowed:"Windowed",overlay:"Overlay",sync_playback:"Sync playback",loading_view:"Loading view...",loading_panel:"Loading panel..."},es:{setup_support_title:"Configuracion y soporte",open_setup_wizard:"Abrir asistente de configuracion",open_support_panel:"Abrir panel de soporte",telemetry_summary_title:"Resumen de telemetria",telemetry_summary_body:"Los eventos de producto se guardan en una cola local para auditorias UX de pre-lanzamiento.",export_event_queue:"Exportar cola de eventos",settings_center_title:"Centro de configuracion",settings_center_body:"Controles centralizados para entradas, UX y opciones seguras de comparticion.",safe_export:"Exportacion segura",gamepad_enabled:"Gamepad habilitado",timeline_windowing:"Ventana de timeline",theme_label:"Tema",motion_label:"Movimiento",app_language_label:"Idioma de la app",gameplay_locale_label:"Idioma de gameplay",traceql_placeholder:"TraceQL (ejemplo: type=tool_call and duration_ms>800)",run_traceql:"Ejecutar TraceQL",clear_traceql:"Limpiar TraceQL",select_extension:"Seleccionar extension",run_extension:"Ejecutar extension",running_extension:"Ejecutando extension...",mode_cinema:"Cine",mode_flow:"Flujo",mode_compare:"Comparar",mode_matrix:"Matriz",mode_gameplay:"Gameplay",windowed:"En ventana",overlay:"Superposicion",sync_playback:"Sincronizar reproduccion",loading_view:"Cargando vista...",loading_panel:"Cargando panel..."}},ou=[{value:"en",label:"English"},{value:"es",label:"Espanol"}];function ko(e){return e==="es"?"es":"en"}function iu(e,n){var s;return((s=jo[e])==null?void 0:s[n])??jo.en[n]}const lu=new Set(["cinema","flow","compare","matrix","gameplay"]);function us(e){if(!e)return;const n=e.trim();return n.length?n:void 0}function So(e){const n=new URLSearchParams(e),s=us(n.get("mode")),r=us(n.get("trace")),o=us(n.get("step")),d={};return s&&lu.has(s)&&(d.mode=s),r&&(d.traceId=r),o&&(d.stepId=o),d}function cu(e,n){const s=new URL(e);return n.mode?s.searchParams.set("mode",n.mode):s.searchParams.delete("mode"),n.traceId?s.searchParams.set("trace",n.traceId):s.searchParams.delete("trace"),n.stepId?s.searchParams.set("step",n.stepId):s.searchParams.delete("step"),s.toString()}function No(e){if(typeof e.durationMs=="number"&&Number.isFinite(e.durationMs))return Math.max(0,e.durationMs);const n=Date.parse(e.startedAt),s=Date.parse(e.endedAt??e.startedAt);return!Number.isFinite(n)||!Number.isFinite(s)?0:Math.max(0,s-n)}function du(e,n,s){return e==="analysis"?s?"compare":"matrix":e==="collaboration"?"gameplay":e==="operations"?n==="compare"?"matrix":n:n==="gameplay"?"cinema":n}function uu(e,n,s=6){var f,h,g,v,w;if(e.length===0)return[];const r=[...e].sort((j,b)=>j.index-b.index),o=n?r.findIndex(j=>j.id===n):-1,d=r.find(j=>j.status==="failed"),c=r.reduce((j,b)=>No(b)>No(j)?b:j),m=[(f=r[0])==null?void 0:f.id,o>=0?(h=r[o])==null?void 0:h.id:null,o>0?(g=r[o-1])==null?void 0:g.id:null,o>=0&&o<r.length-1?(v=r[o+1])==null?void 0:v.id:null,(d==null?void 0:d.id)??null,c.id,(w=r[r.length-1])==null?void 0:w.id];return Array.from(new Set(m.filter(j=>!!j))).slice(0,s)}const xs={setupWizardV1:!0,supportPanelV1:!0,exportCenterV1:!0,ownershipPanelV1:!0},Vo="agentDirector.analytics.events.v1",Jo="agentDirector.featureFlags.v1",pu=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;function mu(e){const n=e.dataSource.trim(),s=e.importPath.trim(),o=e.inviteEmails.split(",").map(u=>u.trim()).filter(Boolean).filter(u=>!pu.test(u)),d=n?null:"Select a data source.",c=s?null:"Import path is required.",m=o.length?`Invalid invite email(s): ${o.join(", ")}`:null;return{dataSourceError:d,importPathError:c,inviteEmailsError:m,isValid:!d&&!c&&!m}}function hu(e,n){const s=n.updatedAt??Date.now(),r={...n,updatedAt:s},o=e.findIndex(c=>c.id===r.id);if(o===-1)return[r,...e].slice(0,12);const d=[...e];return d[o]={...d[o],...r},d.sort((c,m)=>m.updatedAt-c.updatedAt),d.slice(0,12)}function fu(e){try{const n=JSON.parse(e.getItem(Vo)??"[]");return Array.isArray(n)?n.filter(s=>{if(!s||typeof s!="object")return!1;const r=s;return typeof r.name=="string"&&typeof r.at=="string"&&typeof r.metadata=="object"}).slice(-250):[]}catch{return[]}}function gu(e,n){const r=[...fu(e),n].slice(-250);return e.setItem(Vo,JSON.stringify(r)),r}function bu(e){var n,s;return{capturedAt:new Date().toISOString(),app:"agent-director",mode:e.mode,traceId:((n=e.trace)==null?void 0:n.id)??null,traceStatus:((s=e.trace)==null?void 0:s.status)??null,stepCount:e.stepCount,selectedStepId:e.selectedStepId,workspaceId:e.workspaceId,workspaceRole:e.workspaceRole,safeExport:e.safeExport,timeToFirstSuccessMs:e.timeToFirstSuccessMs??null,userAgent:typeof navigator<"u"?navigator.userAgent:"unknown",online:typeof navigator<"u"?navigator.onLine:!0,recentNotifications:e.notifications.slice(-6),asyncActions:e.actions.slice(0,8),stuckSignals:(e.stuckSignals??[]).slice(0,6)}}function yu(e){try{const n=JSON.parse(e.getItem(Jo)??"{}");if(!n||typeof n!="object")return{...xs};const s=n;return{setupWizardV1:s.setupWizardV1!==!1,supportPanelV1:s.supportPanelV1!==!1,exportCenterV1:s.exportCenterV1!==!1,ownershipPanelV1:s.ownershipPanelV1!==!1}}catch{return{...xs}}}function xu(e,n){e.setItem(Jo,JSON.stringify(n))}function Co(e,n,s){return e.filter(r=>n-r<=s)}function vu(e,n=4){return e.length>=n}function wu(e,n){return Math.max(0,n-e)}const ju={overview:1200,triage:1300,diagnose:1500,coordinate:1300,settings:1e3};function ku(e,n){const s=ju[e],r=Math.max(0,Math.round(n)),o=Math.max(0,r-s);return{route:e,durationMs:r,budgetMs:s,overBudgetByMs:o,withinBudget:o===0}}const Ko="agentDirector.analytics.journey.v1",Qo=500,Su=["journey.first_meaningful_interaction","journey.first_success","journey.onboarding.exit","journey.onboarding.first_value","journey.onboarding.abandon"];function Nu(e){return typeof e=="string"&&Su.includes(e)}function Cu(e){try{const n=JSON.parse(e.getItem(Ko)??"[]");return Array.isArray(n)?n.filter(s=>{if(!s||typeof s!="object")return!1;const r=s;return Nu(r.name)&&typeof r.at=="string"&&r.metadata!=null&&typeof r.metadata=="object"}).slice(-Qo):[]}catch{return[]}}function Mu(e,n){const s=[...Cu(e),n].slice(-Qo);return e.setItem(Ko,JSON.stringify(s)),s}function Yo(e,n,s={}){return Mu(e,{name:n,at:new Date().toISOString(),metadata:s})}function Eu(e,n,s,r,o={}){return n[s]?!1:(n[s]=!0,Yo(e,r,o),!0)}const Iu=["overview","triage","diagnose","coordinate","settings"],vs="overview",Es="route",Is="routes",_u="agentDirector.uxReboot.routes.v1",Tu=[{id:"overview",label:"Overview",intent:"Understand status quickly."},{id:"triage",label:"Triage",intent:"Resolve the most urgent issue."},{id:"diagnose",label:"Diagnose",intent:"Perform deep analysis."},{id:"coordinate",label:"Coordinate",intent:"Align team responders."},{id:"settings",label:"Settings",intent:"Configure workspace defaults."}];function ws(e){if(!e)return vs;const n=e.trim().toLowerCase();return Iu.includes(n)?n:vs}function Ru({routeLabel:e,completed:n,total:s,lastCompletedAction:r}){const o=s>0?Math.round(n/s*100):0;return t.jsxs("section",{className:"route-progress-strip","aria-label":"Route progress",children:[t.jsx("h3",{children:"Route progress"}),t.jsxs("div",{className:"route-progress-header",children:[t.jsxs("strong",{children:[e," progress"]}),t.jsxs("span",{children:[n," of ",s," complete"]})]}),t.jsx("div",{className:"route-progress-bar",role:"progressbar","aria-label":`${e} completion`,"aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":o,children:t.jsx("span",{className:"route-progress-fill",style:{width:`${o}%`}})}),r?t.jsxs("p",{className:"route-progress-resume",children:["Resume here: ",r.label]}):null]})}function Fe({title:e,outcome:n,why:s,ctaLabel:r,onCta:o,disabled:d=!1,tone:c="default",resume:m=!1}){return t.jsxs("article",{className:`journey-action-card tone-${c}`,children:[t.jsxs("div",{className:"journey-action-card-header",children:[t.jsx("h3",{children:e}),m?t.jsx("span",{className:"status-badge",children:"Resume here"}):null]}),t.jsxs("p",{className:"journey-action-outcome",children:["Outcome: ",n]}),t.jsxs("p",{className:"journey-action-why",children:["Why this matters: ",s]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:o,disabled:d,children:r})]})}function Du({status:e,runOwner:n,handoffOwner:s,snapshots:r,activityFeed:o,actionHistory:d,lastCompletedActionId:c,onRunOwnerChange:m,onHandoffOwnerChange:u,onRouteAction:f}){return t.jsxs("div",{className:"workspace-context-grid route-context-grid","data-route-panel":"coordinate",children:[t.jsxs("article",{className:"workspace-card route-state-card",children:[t.jsx("h3",{children:"Coordinate state"}),e===null?t.jsxs(t.Fragment,{children:[t.jsx("p",{children:"No run context loaded yet. Set owners and share live context before action starts."}),t.jsxs("div",{className:"route-state-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>f("coordinate-share-live"),children:"Share live context"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>f("coordinate-copy-handoff"),children:"Copy handoff digest"})]})]}):null,e==="failed"?t.jsxs(t.Fragment,{children:[t.jsx("p",{children:"Run is in failure state. Keep ownership aligned and preserve exact handoff evidence."}),t.jsxs("div",{className:"route-state-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>f("coordinate-copy-handoff"),children:"Copy handoff digest"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>f("coordinate-capture-snapshot"),children:"Capture handoff snapshot"})]})]}):null,e==="completed"?t.jsxs(t.Fragment,{children:[t.jsx("p",{children:"Coordination complete. Confirm ownership and preserve final handoff context."}),t.jsx("p",{className:"route-state-summary",children:"What changed: run ownership, handoff summary, and route snapshot trail are aligned."}),t.jsxs("div",{className:"route-state-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>f("coordinate-capture-snapshot"),children:"Capture handoff snapshot"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>f("coordinate-copy-handoff"),children:"Copy handoff digest"})]})]}):null,e==="running"?t.jsx("p",{children:"Run is active. Keep ownership current and checkpoint snapshots as context evolves."}):null]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Ownership and handoff"}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("input",{className:"search-input",value:n,onChange:h=>m(h.target.value),"aria-label":"Run owner",placeholder:"Run owner"}),t.jsx("input",{className:"search-input",value:s,onChange:h=>u(h.target.value),"aria-label":"Handoff owner",placeholder:"Handoff owner"})]})]}),t.jsx(Fe,{title:"Share live context",outcome:"Generate a live collaboration link for responders.",why:"Live links align responders on one source of truth.",ctaLabel:"Share live context",onCta:()=>f("coordinate-share-live"),resume:c==="coordinate-share-live"}),t.jsx(Fe,{title:"Copy handoff digest",outcome:"Publish concise ownership and decision summary.",why:"Digest handoffs reduce repeated clarifications.",ctaLabel:"Copy handoff digest",onCta:()=>f("coordinate-copy-handoff"),resume:c==="coordinate-copy-handoff"}),t.jsx(Fe,{title:"Capture handoff snapshot",outcome:"Freeze route state as handoff-ready checkpoint.",why:"Snapshots preserve exact decision context for async teams.",ctaLabel:"Capture snapshot",onCta:()=>f("coordinate-capture-snapshot"),resume:c==="coordinate-capture-snapshot"}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Action history"}),d.length===0?t.jsx("p",{children:"No route actions recorded yet."}):null,t.jsx("div",{className:"workspace-feed",children:d.slice(0,8).map(h=>t.jsxs("div",{className:"workspace-feed-item",children:[t.jsx("span",{children:new Date(h.at).toLocaleTimeString()}),t.jsx("span",{children:h.label})]},h.id))})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Handoff snapshots"}),r.length===0?t.jsx("p",{children:"No snapshots yet. Capture one before handoff."}):null,t.jsx("div",{className:"workspace-feed",children:r.slice(0,6).map(h=>t.jsxs("div",{className:"workspace-feed-item",children:[t.jsx("span",{children:new Date(h.at).toLocaleTimeString()}),t.jsx("span",{children:h.summary})]},h.id))})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Collaboration activity"}),o.length===0?t.jsx("p",{children:"No collaboration events yet."}):null,t.jsx("div",{className:"workspace-feed",children:o.slice(0,8).map(h=>t.jsxs("div",{className:"workspace-feed-item",children:[t.jsx("span",{children:new Date(h.timestamp).toLocaleTimeString()}),t.jsx("span",{children:h.message})]},h.id))})]})]})}function Ou({items:e,onRetryAsyncAction:n,onResumeAsyncAction:s,onRetryExportTask:r}){return e.length===0?t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Execution timeline"}),t.jsx("p",{children:"No async or export actions yet."})]}):t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Execution timeline"}),t.jsx("div",{className:"route-execution-timeline",children:e.map(o=>t.jsxs("div",{className:`route-execution-item status-${o.status}`,children:[t.jsxs("div",{children:[t.jsx("strong",{children:o.label}),t.jsx("p",{children:o.detail})]}),t.jsxs("div",{className:"route-execution-meta",children:[t.jsx("span",{className:`status-badge status-source-${o.source}`,children:o.source}),t.jsx("span",{children:new Date(o.updatedAt).toLocaleTimeString()})]}),t.jsxs("div",{className:"route-execution-actions",children:[o.retryable?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>o.source==="async"?n(o.id):r(o.id),children:"Retry"}):null,o.resumable?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>s(o.id),children:"Resume"}):null]})]},o.id))})]})}function Au({status:e,lastCompletedActionId:n,timelineItems:s,onRouteAction:r,onRetryAsyncAction:o,onResumeAsyncAction:d,onRetryExportTask:c}){return t.jsxs("div",{className:"workspace-context-grid route-context-grid","data-route-panel":"diagnose",children:[t.jsxs("article",{className:"workspace-card route-state-card",children:[t.jsx("h3",{children:"Diagnose state"}),e===null?t.jsxs(t.Fragment,{children:[t.jsx("p",{children:"No run context yet. Start by observing baseline behavior, then isolate causal chain."}),t.jsxs("div",{className:"route-state-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>r("diagnose-observe-baseline"),children:"Observe baseline"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>r("diagnose-isolate-cause"),children:"Isolate causal chain"})]})]}):null,e==="failed"?t.jsxs(t.Fragment,{children:[t.jsx("p",{children:"Diagnosis blocked by current failures. Follow observe, isolate, validate, then share."}),t.jsxs("div",{className:"route-state-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>r("diagnose-observe-baseline"),children:"Observe baseline"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>r("diagnose-isolate-cause"),children:"Isolate causal chain"})]})]}):null,e==="completed"?t.jsxs(t.Fragment,{children:[t.jsx("p",{children:"Diagnosis complete. Capture findings and publish the narrative."}),t.jsx("p",{className:"route-state-summary",children:"What changed: hypothesis validation and evidence export are ready for team handoff."}),t.jsxs("div",{className:"route-state-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>r("diagnose-share-findings"),children:"Share findings"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>r("diagnose-validate-hypothesis"),children:"Re-validate hypothesis"})]})]}):null,e==="running"?t.jsx("p",{children:"Run is live. Update diagnosis checkpoints as evidence changes."}):null]}),t.jsx(Fe,{title:"Observe baseline",outcome:"Anchor diagnosis on timeline evidence before branching.",why:"A baseline avoids speculative debugging paths.",ctaLabel:"Observe baseline",onCta:()=>r("diagnose-observe-baseline"),resume:n==="diagnose-observe-baseline"}),t.jsx(Fe,{title:"Isolate causal chain",outcome:"Map dependency path that explains the failure pattern.",why:"Causal isolation narrows root-cause candidates quickly.",ctaLabel:"Isolate causal chain",onCta:()=>r("diagnose-isolate-cause"),resume:n==="diagnose-isolate-cause"}),t.jsx(Fe,{title:"Validate hypothesis",outcome:"Prove or falsify hypothesis with replay matrix evidence.",why:"Validation protects against overfitting to one run.",ctaLabel:"Validate hypothesis",onCta:()=>r("diagnose-validate-hypothesis"),resume:n==="diagnose-validate-hypothesis"}),t.jsx(Fe,{title:"Share findings",outcome:"Export concise narrative and recommended next action.",why:"Shared findings keep response aligned across teams.",ctaLabel:"Share findings",onCta:()=>r("diagnose-share-findings"),resume:n==="diagnose-share-findings"}),t.jsx(Ou,{items:s,onRetryAsyncAction:o,onResumeAsyncAction:d,onRetryExportTask:c})]})}function $u({status:e,runHealthScore:n,lastCompletedActionId:s,onRouteAction:r}){const o=s,d=Math.max(0,Math.min(100,Math.round(n)));return t.jsxs("div",{className:"workspace-context-grid route-context-grid","data-route-panel":"overview",children:[t.jsxs("article",{className:"workspace-card route-state-card",children:[t.jsx("h3",{children:"Overview state"}),e===null?t.jsxs(t.Fragment,{children:[t.jsx("p",{children:"No run loaded yet. Start with run health, then inspect top risk."}),t.jsxs("div",{className:"route-state-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>r("overview-review-health"),children:"Review run health"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>r("overview-inspect-risk"),children:"Inspect top risk"})]})]}):null,e==="failed"?t.jsxs(t.Fragment,{children:[t.jsx("p",{children:"Current run failed. Recover with risk inspection and immediate handoff."}),t.jsxs("div",{className:"route-state-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>r("overview-inspect-risk"),children:"Inspect top risk"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>r("overview-share-handoff"),children:"Share handoff digest"})]})]}):null,e==="completed"?t.jsxs(t.Fragment,{children:[t.jsx("p",{children:"Run completed. Confirm health and share a concise handoff."}),t.jsxs("p",{className:"route-state-summary",children:["What changed: run health stabilized at ",d,"/100 with final completion status."]}),t.jsxs("div",{className:"route-state-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>r("overview-share-handoff"),children:"Share handoff digest"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>r("overview-inspect-risk"),children:"Re-check top risk"})]})]}):null,e==="running"?t.jsxs(t.Fragment,{children:[t.jsx("p",{children:"Run is active. Keep an eye on health and top-risk movement."}),t.jsxs("div",{className:"route-state-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>r("overview-review-health"),children:"Review run health"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>r("overview-inspect-risk"),children:"Inspect top risk"})]})]}):null,t.jsxs("p",{children:["Health score: ",t.jsx("strong",{children:d})]})]}),t.jsx(Fe,{title:"Review run health",outcome:"Confirm current run stability and risk posture.",why:"A clear health read prevents reactive context switching.",ctaLabel:"Review run health",onCta:()=>r("overview-review-health"),resume:o==="overview-review-health",tone:n>=80?"success":"warning"}),t.jsx(Fe,{title:"Inspect top risk",outcome:"Open the highest-risk step and verify impact scope.",why:"Fast risk inspection shortens time to triage decision.",ctaLabel:"Inspect top risk",onCta:()=>r("overview-inspect-risk"),resume:o==="overview-inspect-risk"}),t.jsx(Fe,{title:"Share handoff digest",outcome:"Publish what changed, why, and recommended next move.",why:"Stakeholders need one clear status update, not a raw trace.",ctaLabel:"Share handoff digest",onCta:()=>r("overview-share-handoff"),resume:o==="overview-share-handoff"})]})}function Pu({workspaceRole:e,themeMode:n,motionMode:s,densityMode:r,appLocale:o,gameplayLocale:d,safeExport:c,gamepadEnabled:m,windowed:u,rolloutCohort:f,featureFlags:h,onThemeModeChange:g,onMotionModeChange:v,onDensityModeChange:w,onAppLocaleChange:j,onGameplayLocaleChange:b,onToggleSafeExport:S,onToggleGamepadEnabled:C,onToggleWindowed:R,onRolloutCohortChange:K,onToggleFeatureFlag:_}){const O=c?"Safe export is enabled. Raw payload controls are redacted by default.":"Safe export is disabled. Raw payload controls may expose sensitive context.",q=e==="viewer"?"Viewer role can inspect but cannot mutate sensitive workflow actions.":e==="operator"?"Operator role can execute route actions with confirmation on high-risk changes.":"Admin role can manage all workspace controls and feature switches.";return t.jsxs("div",{className:"workspace-context-grid route-context-grid","data-route-panel":"settings",children:[t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Interface defaults"}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsxs("label",{children:["Theme",t.jsxs("select",{className:"search-select",value:n,onChange:P=>g(P.target.value),children:[t.jsx("option",{value:"studio",children:"Studio"}),t.jsx("option",{value:"focus",children:"Focus"}),t.jsx("option",{value:"contrast",children:"Contrast"})]})]}),t.jsxs("label",{children:["Motion",t.jsxs("select",{className:"search-select",value:s,onChange:P=>v(P.target.value),children:[t.jsx("option",{value:"cinematic",children:"Cinematic"}),t.jsx("option",{value:"balanced",children:"Balanced"}),t.jsx("option",{value:"minimal",children:"Minimal"})]})]}),t.jsxs("label",{children:["Density",t.jsxs("select",{className:"search-select",value:r,onChange:P=>w(P.target.value),children:[t.jsx("option",{value:"auto",children:"Auto"}),t.jsx("option",{value:"comfortable",children:"Comfortable"}),t.jsx("option",{value:"compact",children:"Compact"})]})]})]})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Localization and controls"}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsxs("label",{children:["App language",t.jsxs("select",{className:"search-select",value:o,onChange:P=>j(P.target.value),children:[t.jsx("option",{value:"en",children:"English"}),t.jsx("option",{value:"es",children:"Espanol"})]})]}),t.jsxs("label",{children:["Gameplay language",t.jsxs("select",{className:"search-select",value:d,onChange:P=>b(P.target.value),children:[t.jsx("option",{value:"en",children:"English"}),t.jsx("option",{value:"es",children:"Espanol"})]})]})]}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:c,onChange:S}),"Safe export"]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:m,onChange:C}),"Gamepad enabled"]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:u,onChange:R}),"Timeline windowing"]})]})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Feature controls"}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:h.setupWizardV1,onChange:()=>_("setupWizardV1")}),"Setup wizard"]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:h.supportPanelV1,onChange:()=>_("supportPanelV1")}),"Support diagnostics"]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:h.exportCenterV1,onChange:()=>_("exportCenterV1")}),"Export center"]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:h.ownershipPanelV1,onChange:()=>_("ownershipPanelV1")}),"Ownership panel"]})]}),t.jsx("div",{className:"workspace-inline-form",children:t.jsxs("label",{children:["UX reboot cohort",t.jsxs("select",{className:"search-select",value:f,onChange:P=>K(P.target.value),children:[t.jsx("option",{value:"off",children:"Off"}),t.jsx("option",{value:"internal",children:"Internal"}),t.jsx("option",{value:"pilot",children:"Pilot"}),t.jsx("option",{value:"ga",children:"General availability"})]})]})})]}),t.jsxs("article",{className:"workspace-card route-state-card","aria-live":"polite",children:[t.jsx("h3",{children:"Trust and access state"}),t.jsx("p",{children:O}),t.jsxs("p",{className:"route-state-summary",children:["Role constraints: ",q]})]})]})}function Lu({status:e,supportEnabled:n,lastCompletedActionId:s,onRouteAction:r}){return t.jsxs("div",{className:"workspace-context-grid route-context-grid","data-route-panel":"triage",children:[t.jsxs("article",{className:"workspace-card route-state-card",children:[t.jsx("h3",{children:"Triage state"}),e===null?t.jsxs(t.Fragment,{children:[t.jsx("p",{children:"No failure signal selected. Start with incident observation and isolate the likely cause."}),t.jsxs("div",{className:"route-state-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>r("triage-observe-incident"),children:"Observe now"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>r("triage-isolate-cause"),children:"Isolate cause"})]})]}):null,e==="failed"?t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("p",{children:"Failure detected. Run recovery in this order: observe, isolate, validate, share."}),t.jsx("button",{className:"primary-button",type:"button",onClick:()=>r("triage-observe-incident"),children:"Observe now"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>r("triage-isolate-cause"),children:"Isolate cause"}),n?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>r("triage-open-support"),children:"Open support diagnostics"}):null]}):null,e==="completed"?t.jsxs(t.Fragment,{children:[t.jsx("p",{children:"Triage complete. Validate final state and package a clean handoff."}),t.jsx("p",{className:"route-state-summary",children:"What changed: the active incident path moved from failure to recovered handoff readiness."}),t.jsxs("div",{className:"route-state-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>r("triage-share-handoff"),children:"Share handoff"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>r("triage-validate-fix"),children:"Re-validate fix"})]})]}):null,e==="running"?t.jsx("p",{children:"Use the task sequence below to keep triage deterministic and handoff-ready."}):null]}),t.jsx(Fe,{title:"Observe the incident",outcome:"Lock onto the failing or slowest step immediately.",why:"Problem-first ordering prevents wasted analysis loops.",ctaLabel:"Observe incident",onCta:()=>r("triage-observe-incident"),resume:s==="triage-observe-incident"}),t.jsx(Fe,{title:"Isolate the cause",outcome:"Switch to dependency flow and isolate causal path.",why:"Isolation narrows the fix candidate set quickly.",ctaLabel:"Isolate cause",onCta:()=>r("triage-isolate-cause"),resume:s==="triage-isolate-cause"}),t.jsx(Fe,{title:"Validate the fix",outcome:"Run compare or matrix validation before declaring recovery.",why:"Validation catches false positives before handoff.",ctaLabel:"Validate fix",onCta:()=>r("triage-validate-fix"),resume:s==="triage-validate-fix"}),t.jsx(Fe,{title:"Share the handoff",outcome:"Publish the action trail and recommended ownership handoff.",why:"Handoff clarity lowers repeat triage load.",ctaLabel:"Share handoff",onCta:()=>r("triage-share-handoff"),resume:s==="triage-share-handoff"})]})}const Fu={overview:"Understand run health, risk, and the next decision in under a minute.",triage:"Resolve urgent failures with a deterministic problem-first workflow.",diagnose:"Produce evidence-backed root-cause findings and validated next actions.",coordinate:"Keep ownership, handoff, and collaboration continuity aligned.",settings:"Configure safe defaults and controls for predictable operation."},Mo={overview:"Overview",triage:"Triage",diagnose:"Diagnose",coordinate:"Coordinate",settings:"Settings"};function Bu({route:e,status:n,runHealthScore:s,workspaceRole:r,runOwner:o,handoffOwner:d,routeProgress:c,lastCompletedAction:m,actionHistory:u,snapshots:f,activityFeed:h,asyncTimeline:g,themeMode:v,motionMode:w,densityMode:j,appLocale:b,gameplayLocale:S,safeExport:C,gamepadEnabled:R,windowed:K,rolloutCohort:_,featureFlags:O,onRouteAction:q,onRetryAsyncAction:P,onResumeAsyncAction:L,onRetryExportTask:J,onRunOwnerChange:le,onHandoffOwnerChange:N,onThemeModeChange:T,onMotionModeChange:D,onDensityModeChange:U,onAppLocaleChange:M,onGameplayLocaleChange:ae,onToggleSafeExport:be,onToggleGamepadEnabled:re,onToggleWindowed:Q,onRolloutCohortChange:Ee,onToggleFeatureFlag:Re}){const xe=l.useMemo(()=>u.filter(Y=>Y.route===e),[u,e]),x=`workspace-route-${e}`;return t.jsxs("section",{className:"workspace-route-shell","aria-labelledby":x,children:[t.jsxs("h2",{id:x,className:"sr-only",children:[Mo[e]," route workspace"]}),t.jsxs("article",{className:"workspace-card route-outcome-card",children:[t.jsx("h3",{children:"Route outcome"}),t.jsx("p",{children:Fu[e]}),t.jsxs("p",{className:"route-outcome-subcopy",children:["Role context: ",r,". Keep one intent active until complete."]})]}),t.jsx(Ru,{routeLabel:Mo[e],completed:c.completed,total:c.total,lastCompletedAction:m}),xe.length>0?t.jsxs("article",{className:"workspace-card route-history-strip","aria-label":"Route action history",children:[t.jsx("h3",{children:"Recent route actions"}),t.jsx("div",{className:"workspace-feed",children:xe.slice(0,6).map(Y=>t.jsxs("div",{className:"workspace-feed-item",children:[t.jsx("span",{children:new Date(Y.at).toLocaleTimeString()}),t.jsx("span",{children:Y.label})]},Y.id))})]}):null,e==="overview"?t.jsx($u,{status:n,runHealthScore:s,lastCompletedActionId:(m==null?void 0:m.id)??null,onRouteAction:q}):null,e==="triage"?t.jsx(Lu,{status:n,supportEnabled:O.supportPanelV1,lastCompletedActionId:(m==null?void 0:m.id)??null,onRouteAction:q}):null,e==="diagnose"?t.jsx(Au,{status:n,lastCompletedActionId:(m==null?void 0:m.id)??null,timelineItems:g,onRouteAction:q,onRetryAsyncAction:P,onResumeAsyncAction:L,onRetryExportTask:J}):null,e==="coordinate"?t.jsx(Du,{status:n,runOwner:o,handoffOwner:d,snapshots:f,activityFeed:h,actionHistory:u,lastCompletedActionId:(m==null?void 0:m.id)??null,onRunOwnerChange:le,onHandoffOwnerChange:N,onRouteAction:q}):null,e==="settings"?t.jsx(Pu,{workspaceRole:r,themeMode:v,motionMode:w,densityMode:j,appLocale:b,gameplayLocale:S,safeExport:C,gamepadEnabled:R,windowed:K,rolloutCohort:_,featureFlags:O,onThemeModeChange:T,onMotionModeChange:D,onDensityModeChange:U,onAppLocaleChange:M,onGameplayLocaleChange:ae,onToggleSafeExport:be,onToggleGamepadEnabled:re,onToggleWindowed:Q,onRolloutCohortChange:Ee,onToggleFeatureFlag:Re}):null]})}const qu=l.memo(Bu),Eo=220,Io=120,js="agentDirector.presence.v1",zu=2e4,Gu=5e3,ra="agentDirector.collab.cursors.v1",ps="agentDirector.collab.annotations.v1",ms="agentDirector.collab.activity.v1",Uu=6e3,Hu=1600,Wu=4,Vu=2e4,Ju=12e4,Ku=3,Qu={journey:{title:"Understand this run",description:"Track progression and save the exact view you need to return to quickly."},analysis:{title:"Diagnose root cause",description:"Run exports and async diagnostics to isolate what changed and why."},collaboration:{title:"Coordinate responders",description:"Set ownership, create handoffs, and keep the team aligned in real time."},operations:{title:"Configure workspace",description:"Manage setup, support access, and release-safe feature controls."}},Yu={cinema:"Timeline playback",flow:"Flow graph",compare:"Compare runs",matrix:"Scenario matrix",gameplay:"Gameplay command"},_o=[{id:"personal",label:"Personal"},{id:"operations",label:"Operations"},{id:"executive",label:"Executive"}],Xu={overview:"journey",triage:"analysis",diagnose:"analysis",coordinate:"collaboration",settings:"operations"},It={overview:"Review",triage:"Triage",diagnose:"Diagnose",coordinate:"Coordinate",settings:"Configure"},Zu={overview:null,triage:null,diagnose:null,coordinate:null,settings:null},ep={evaluate:"executive",operate:"operator",investigate:"builder"},tp=l.lazy(()=>dt(()=>import("./index-C18ZUr6w.js"),__vite__mapDeps([0,1,2,3]))),ap=l.lazy(()=>dt(()=>import("./index-CpbCZ8DM.js"),__vite__mapDeps([4,1,2,3]))),np=l.lazy(()=>dt(()=>import("./index-CgPEnHJd.js"),__vite__mapDeps([5,1,2,3]))),sp=l.lazy(()=>dt(()=>import("./index-D1nEiSPm.js"),__vite__mapDeps([6,1,2,3]))),rp=l.lazy(()=>dt(()=>import("./index-Cm6o9e9V.js"),__vite__mapDeps([7,1,2,3])));function Ya(){return`scenario-${Math.random().toString(36).slice(2,9)}`}function op(e){return e.filter(n=>n.parentStepId).map(n=>({source:n.parentStepId,target:n.id}))}function ip(e){const n=[...e].sort((s,r)=>s.index-r.index);return n.slice(1).map((s,r)=>({source:n[r].id,target:s.id}))}function lp(e){const n={},s=e.getBoundingClientRect();return e.querySelectorAll(".step-card").forEach(o=>{const d=o.dataset.stepId;if(!d)return;const c=o.getBoundingClientRect();n[d]={left:c.left-s.left,top:c.top-s.top,width:c.width,height:c.height}}),n}function cp(e,n,s){const r=[...op(e),...ip(e),...zd(e).map(j=>({source:j.source,target:j.target}))],o=Fd(e,r,s),d=n.getBoundingClientRect(),c=Math.min(...o.map(j=>j.position.x)),m=Math.min(...o.map(j=>j.position.y)),u=Math.max(...o.map(j=>j.position.x)),f=Math.max(...o.map(j=>j.position.y)),h=u-c+Eo,g=f-m+Io,v=Math.max(32,(d.width-h)/2),w=Math.max(24,(d.height-g)/2);return o.reduce((j,b)=>(j[b.id]={left:b.position.x-c+v,top:b.position.y-m+w,width:Eo,height:Io},j),{})}function To(e,n,s){const r=n.trim().toLowerCase();return e.filter(o=>{var c,m,u;return s!=="all"&&o.type!==s?!1:r?[o.name,(c=o.preview)==null?void 0:c.title,(m=o.preview)==null?void 0:m.outputPreview,(u=o.preview)==null?void 0:u.inputPreview].filter(Boolean).join(" ").toLowerCase().includes(r):!0})}function dp(e,n,s){var f,h,g,v,w,j,b,S,C,R,K,_,O,q,P,L,J,le,N,T,D,U,M,ae,be,re,Q,Ee,Re,xe;const r=e.profiles[n]??e.profiles[((f=e.players[0])==null?void 0:f.player_id)??""]??Object.values(e.profiles)[0],o=e.players.reduce((x,Y)=>(x[Y.player_id]=Y.role,x),{}),d=Object.entries(e.narrative.nodes).map(([x,Y])=>({id:x,title:Y.title,body:Y.title,choices:Y.choices.map(ee=>({id:ee.id,label:ee.id,nextNodeId:ee.next,tensionDelta:ee.tension,mutator:ee.modifier}))})),c=e.pvp.winner??null,u=e.telemetry.failures>0?"failure":c?"success":"mixed";return{seed:e.seed,raid:{party:e.players.map(x=>x.player_id),roles:o,objectives:e.raid.objectives.map(x=>({id:x.id,label:x.label,progress:x.progress,target:x.target,completed:x.completed})),completed:e.raid.completed},campaign:{depth:e.campaign.depth,lives:e.campaign.lives,currentMission:{id:e.campaign.current_mission.id,title:e.campaign.current_mission.title,difficulty:e.campaign.current_mission.difficulty,hazards:e.campaign.current_mission.hazards,rewardCredits:e.campaign.current_mission.reward_tokens,missionSeed:e.campaign.current_mission.mission_seed??s.campaign.currentMission.missionSeed??e.seed,blueprint:e.campaign.current_mission.blueprint??s.campaign.currentMission.blueprint??`seed=${e.seed};depth=${e.campaign.depth}`,templateId:e.campaign.current_mission.template_id??s.campaign.currentMission.templateId,archetype:e.campaign.current_mission.archetype??s.campaign.currentMission.archetype,qualityScore:e.campaign.current_mission.quality_score??s.campaign.currentMission.qualityScore,noveltyScore:e.campaign.current_mission.novelty_score??s.campaign.currentMission.noveltyScore,repetitionPenalty:e.campaign.current_mission.repetition_penalty??s.campaign.currentMission.repetitionPenalty,launchPackSize:e.campaign.current_mission.launch_pack_size??s.campaign.currentMission.launchPackSize},completedMissionIds:e.campaign.completed_missions,missionHistory:((h=e.campaign.mission_history)==null?void 0:h.map(x=>({missionId:x.mission_id,templateId:x.template_id??"legacy-template",archetype:x.archetype??"legacy",hazards:x.hazards??[],qualityScore:x.quality_score??50,noveltyScore:x.novelty_score??50,repetitionPenalty:x.repetition_penalty??0,outcome:x.outcome==="success"||x.outcome==="failure"?x.outcome:"unknown"})))??s.campaign.missionHistory,mutators:[...e.campaign.modifiers,...e.campaign.unlocked_modifiers]},narrative:{currentNodeId:e.narrative.current_node_id,nodes:d.length>0?d:s.narrative.nodes,history:e.narrative.history.map(x=>({nodeId:x.node_id,choiceId:x.choice_id})),tension:e.narrative.tension},skills:{points:(r==null?void 0:r.skill_points)??s.skills.points,nodes:s.skills.nodes.map(x=>({...x,unlocked:!!(r!=null&&r.unlocked_skills.includes(x.id))})),loadout:{capacity:(r==null?void 0:r.loadout_capacity)??s.skills.loadout.capacity,equipped:(r==null?void 0:r.loadout)??[],slotCaps:s.skills.loadout.slotCaps}},pvp:{round:e.pvp.round,stability:e.pvp.operator_stability,sabotage:e.pvp.sabotage_pressure,fog:e.pvp.fog,winner:c},time:{activeForkId:e.time.active_fork_id,forks:e.time.forks.map(x=>({id:x.id,label:x.label,playheadMs:x.playhead_ms,history:x.history}))},boss:{name:e.boss.name,phase:e.boss.phase,hp:e.boss.hp,maxHp:e.boss.max_hp,enraged:e.boss.enraged,phaseMechanic:e.boss.phase_mechanic??(e.boss.phase===1?"Phase 1: Shield lattice destabilization":e.boss.phase===2?"Phase 2: Mirror clones absorb exploit damage":"Phase 3: Enrage pulse; shield counters become lethal"),vulnerability:e.boss.vulnerability==="strike"||e.boss.vulnerability==="shield"||e.boss.vulnerability==="exploit"?e.boss.vulnerability:e.boss.phase===1?"exploit":e.boss.phase===2?"strike":"shield"},director:{risk:e.director.risk,hint:e.director.hint,recommendedModifier:e.director.hazard_bias,lastOutcome:u},economy:{credits:e.economy.tokens,materials:e.economy.materials,crafted:e.economy.crafted,reserveTarget:((g=e.economy.policy)==null?void 0:g.target_reserve)??s.economy.reserveTarget??320,inflationIndex:e.economy.inflation_index??Number((e.economy.tokens/(((v=e.economy.policy)==null?void 0:v.target_reserve)??s.economy.reserveTarget??320)).toFixed(3))},rewards:{dailyClaimedOn:((w=e.rewards)==null?void 0:w.daily_claimed_date)??((j=s.rewards)==null?void 0:j.dailyClaimedOn)??null,streakDays:((b=e.rewards)==null?void 0:b.streak_days)??((S=s.rewards)==null?void 0:S.streakDays)??0,sessionClaimed:((C=e.rewards)==null?void 0:C.session_claimed)??((R=s.rewards)==null?void 0:R.sessionClaimed)??!1,streakClaimedFor:((K=e.rewards)==null?void 0:K.streak_claimed_for)??((_=s.rewards)==null?void 0:_.streakClaimedFor)??0,masteryClaims:((O=e.rewards)==null?void 0:O.mastery_claims)??((q=s.rewards)==null?void 0:q.masteryClaims)??[],history:((L=(P=e.rewards)==null?void 0:P.history)==null?void 0:L.map(x=>({id:x.id,kind:x.kind==="daily"||x.kind==="session"||x.kind==="streak"||x.kind==="mastery"?x.kind:"daily",amount:x.amount,at:Date.parse(x.at)||Date.now(),details:x.details?Object.fromEntries(Object.entries(x.details).map(([Y,ee])=>[Y,String(ee)])):{}})))??((J=s.rewards)==null?void 0:J.history)??[]},guild:{name:e.guild.guild_id??"Trace Guild",members:e.players.length,operationsScore:e.guild.operations_score,eventsCompleted:e.guild.events_completed},cinematic:{queue:e.cinematic.events.map(x=>({id:x.id,type:x.type==="critical"||x.type==="success"||x.type==="warning"||x.type==="twist"?x.type:"warning",message:x.message,intensity:x.intensity||1,at:Date.parse(x.at)||Date.now()}))},liveops:{season:e.liveops.season,week:e.liveops.week,challenge:{id:e.liveops.challenge.id,title:e.liveops.challenge.title,goal:e.liveops.challenge.goal,progress:e.liveops.challenge.progress,rewardCredits:e.liveops.challenge.reward,completed:e.liveops.challenge.completed},difficultyFactor:e.liveops.telemetry.difficultyFactor??s.liveops.difficultyFactor??1,rewardMultiplier:e.liveops.telemetry.rewardMultiplier??s.liveops.rewardMultiplier??1,tuningHistory:((le=e.liveops.tuning_history)==null?void 0:le.map(x=>({id:x.id,changedAt:Date.parse(x.changed_at)||Date.now(),difficultyFactor:x.difficultyFactor,rewardMultiplier:x.rewardMultiplier,note:x.note})))??s.liveops.tuningHistory??[]},teamComms:{pings:((T=(N=e.team_comms)==null?void 0:N.pings)==null?void 0:T.map(x=>({id:x.id,fromPlayerId:x.from_player_id,intent:x.intent==="focus"||x.intent==="assist"||x.intent==="defend"||x.intent==="rotate"?x.intent:"focus",targetObjectiveId:x.target_objective_id??null,createdAt:Date.parse(x.created_at)||Date.now()})))??s.teamComms.pings??[]},safety:{mutedPlayerIds:((D=e.safety)==null?void 0:D.muted_player_ids)??s.safety.mutedPlayerIds??[],blockedPlayerIds:((U=e.safety)==null?void 0:U.blocked_player_ids)??s.safety.blockedPlayerIds??[],reports:((ae=(M=e.safety)==null?void 0:M.reports)==null?void 0:ae.map(x=>({id:x.id,targetPlayerId:x.target_player_id,reason:x.reason,createdAt:Date.parse(x.created_at)||Date.now()})))??s.safety.reports??[]},outcome:e.status==="completed"?{status:e.telemetry.successes>=e.telemetry.failures?"win":"loss",reason:e.telemetry.successes>=e.telemetry.failures?"Session completed with positive outcomes.":"Session completed with unresolved failures.",updatedAt:Date.now()}:e.telemetry.failures>0?{status:"partial",reason:`${e.telemetry.failures} failure signals observed; run still active.`,updatedAt:Date.now()}:s.outcome??{status:"in_progress",reason:"Run in progress.",updatedAt:Date.now()},sandbox:{enabled:((be=e.sandbox)==null?void 0:be.enabled)??((re=s.sandbox)==null?void 0:re.enabled)??!1},progression:{xp:(r==null?void 0:r.xp)??((Q=s.progression)==null?void 0:Q.xp)??0,level:(r==null?void 0:r.level)??((Ee=s.progression)==null?void 0:Ee.level)??1,nextLevelXp:((r==null?void 0:r.level)??((Re=s.progression)==null?void 0:Re.level)??1)*200,milestones:(r==null?void 0:r.milestones)??((xe=s.progression)==null?void 0:xe.milestones)??[]}}}function up(){const e=window.sessionStorage.getItem("agentDirector.sessionId");if(e)return e;const n=`session-${Math.random().toString(36).slice(2,10)}`;return window.sessionStorage.setItem("agentDirector.sessionId",n),n}function hs(){try{const e=window.localStorage.getItem(js);if(!e)return{};const n=JSON.parse(e),s={};return Object.entries(n).forEach(([r,o])=>{typeof o=="number"&&(s[r]=o)}),s}catch{return{}}}function fs(e,n=Date.now()){return Object.fromEntries(Object.entries(e).filter(([,s])=>n-s<zu))}function Ro(){var zr,Gr,Ur,Hr;const{trace:e,insights:n,loading:s,error:r,reload:o,traces:d,selectedTraceId:c,setSelectedTraceId:m}=Pd(),[u,f]=V("agentDirector.mode","cinema"),[h,g]=V("agentDirector.workspaceSection.v1","journey"),[v,w]=l.useState(!1),[j,b]=V("agentDirector.workspacePanelOpen.v1",!1),[S,C]=l.useState(""),R=l.useDeferredValue(S),[K,_]=l.useState("all"),[O,q]=l.useState(""),[P,L]=l.useState(null),[J,le]=l.useState(null),[N,T]=V("agentDirector.toolbarAdvanced.v1",!1),[D,U]=l.useState(null),[M,ae]=l.useState([]),[be,re]=l.useState(""),[Q,Ee]=l.useState(null),[Re,xe]=l.useState(!1),[x,Y]=l.useState(null),[ee,z]=V("agentDirector.safeExport",!1),[ge,ne]=V("agentDirector.syncPlayback",!0),[B,zt]=l.useState(null),[Be,je]=l.useState(!1),[E,se]=l.useState(0),[Ne,De]=V("agentDirector.speed",1),[Oe,We]=V("agentDirector.windowed",!1),[an,nn]=l.useState(2e4),[Xo,pt]=l.useState(!1),[sn,mt]=l.useState(!1),[ia,qe]=V("agentDirector.overlayEnabled",!1),[Zo,ei]=V("agentDirector.onboarded",!1),[,Gt]=V("agentDirector.tourCompleted",!1),[Ke,Qe]=V("agentDirector.explainMode",!1),[rn,on]=V("agentDirector.heroDismissed",!1),[ti,ln]=V("agentDirector.dockOpen",!1),[ve,cn]=V("agentDirector.introPersona","builder"),[me,ai]=V("agentDirector.onboarding.path.v1","evaluate"),[Me,tt]=V("agentDirector.onboarding.stage.v1","select"),[Ye,dn]=V("agentDirector.launchPath","rapid_triage"),[Ut,un]=V("agentDirector.themeMode","studio"),[la,pn]=V("agentDirector.motionMode","balanced"),[Ca,_s]=V("agentDirector.densityMode.v1","auto"),[Ma,ni]=V("agentDirector.uxReboot.cohort.v1","off"),[si,ri]=l.useState(typeof window>"u"?1280:window.innerWidth),Ts=l.useMemo(()=>{if(typeof window>"u")return{enabled:!1,route:ws(null),cohort:Ma};const a=new URLSearchParams(window.location.search),i=a.get(Is)==="1",p=ws(a.get(Es)),y=a.get("cohort"),I=(y==="internal"||y==="pilot"||y==="ga"||y==="off"?y:null)??Ma,F=I==="internal"||I==="pilot"||I==="ga";let $=!1;try{$=JSON.parse(window.localStorage.getItem(_u)??"false")===!0}catch{$=!1}return{enabled:!0||i||$||F,route:p,cohort:I}},[Ma]),W=Ts.enabled,mn=Ts.route,[oe,Ht]=l.useState(mn),[Ea,oi]=V("agentDirector.workspaceId.v1",_o[0].id),[Wt,ii]=V("agentDirector.workspaceRole.v1","operator"),[Rs,Ds]=V("agentDirector.sessionExpiresAt.v1",Date.now()+1e3*60*60*4),[ke,Os]=V("agentDirector.timelineLaneStrategy","type"),[As,Vt]=V("agentDirector.timelineStudioConfig",ja),[Ia,Ae]=V("agentDirector.missions",{playback:!1,flow:!1,inspect:!1,matrix:!1,replay:!1,annotate:!1,collaborate:!1}),_a=!1,[Jt,Ta]=V("agentDirector.introDismissed",_a),[hn,ht]=l.useState(!1),[ft,fn]=l.useState("source"),[gt,gn]=V("agentDirector.setupWizardDraft.v1",{dataSource:"",importPath:"",inviteEmails:""}),[$s,Ps]=V("agentDirector.setupWizardComplete.v1",!1),[Ls,Fs]=V("agentDirector.setupWizardPrompted.v1",!1),[bn,Ie]=l.useState(!1),[ue,Ra]=l.useState(null),[Da,yn]=l.useState([]),[xn,vn]=l.useState(null),[li,Bs]=l.useState(null),[wn,jn]=l.useState(""),[kn,_t]=l.useState([{id:Ya(),name:"Prompt tighter",strategy:"hybrid",modificationsText:'{"prompt":"Return concise response"}'},{id:Ya(),name:"Recorded baseline",strategy:"recorded",modificationsText:"{}"}]),[bt,Sn]=l.useState(null),[_e,qs]=l.useState(null),[ci,Oa]=l.useState(!1),[Aa,ca]=l.useState(null),[he,da]=V("agentDirector.gameplayState.v1",wo("bootstrap")),[Z,zs]=V("agentDirector.gameplayTraceId.v1",""),[ze]=V("agentDirector.gameplayPlayerId.v1",`player-${Math.random().toString(36).slice(2,8)}`),[Pe,yt]=V("agentDirector.gameplaySessionId.v1",""),[ye,Xe]=l.useState(null),[$a,ce]=l.useState(null),[di,Kt]=l.useState(null),[ui,Pa]=l.useState(null),[Gs,Us]=V("agentDirector.locale.v1","en"),[Nn,Cn]=V("agentDirector.gameplayLocale.v1","en"),[Tt,Mn]=V("agentDirector.gamepad.enabled.v1",!0),[En,pi]=V("agentDirector.gamepad.preset.v1","standard"),[La,Fa]=V("agentDirector.shortcuts.bindings.v1",gc),[mi,Hs]=l.useState(typeof navigator>"u"?!0:navigator.onLine),[hi,Ws]=l.useState(null),[fi,Vs]=l.useState(null),[ua,Js]=l.useState(1),[Qt,In]=l.useState(null),[st,_n]=l.useState(null),[Ze,Tn]=l.useState([]),[gi,xt]=l.useState(""),[vt,bi]=l.useState([]),[Yt,Rn]=l.useState([]),[et,Ba]=V("agentDirector.savedViews.v1",[]),[Rt,Ks]=l.useState(""),[rt,qa]=l.useState(""),[Dn,Qs]=l.useState(!1),[pa,Ys]=l.useState(""),[at,yi]=l.useState(null),[Ge,xi]=l.useState([]),[wt,Xs]=V("agentDirector.runOwner.v1","on-call-operator"),[jt,Zs]=V("agentDirector.handoffOwner.v1",""),[ie,er]=l.useState(xs),[za,On]=l.useState(null),[ma,An]=l.useState(null),[tr,$n]=l.useState({}),[ar,Pn]=l.useState([]),[vi,nr]=V("agentDirector.route.lastCompleted.v1",Zu),[wi,sr]=V("agentDirector.route.actionHistory.v1",[]),[Ln,rr]=V("agentDirector.route.snapshots.v1",[]);l.useEffect(()=>{const a=()=>ri(window.innerWidth);return a(),window.addEventListener("resize",a),()=>window.removeEventListener("resize",a)},[]);const[Ga,Fn]=l.useState([]),[ha,Bn]=l.useState(800),[ji,ki]=l.useState(0),qn=l.useRef(null),or=l.useRef(null),ir=l.useRef(null),we=l.useRef(up()),lr=l.useRef(0),cr=l.useRef(null),dr=l.useRef({}),ur=l.useRef(0),zn=l.useRef(!1),pr=l.useRef({}),Si=l.useRef({}),Ua=l.useRef({}),Ni=l.useRef(Date.now()),mr=l.useRef(!1),hr=l.useRef({}),fr=l.useRef([]),gr=l.useRef({}),br=l.useRef({}),yr=l.useRef({}),Gn=l.useRef({}),Un=l.useRef({}),xr=l.useRef({}),vr=l.useRef(""),wr=l.useRef(()=>{}),jr=l.useRef(typeof performance<"u"?performance.now():Date.now()),kr=l.useRef(""),Sr=l.useRef(""),Ci=l.useRef(So(typeof window>"u"?"":window.location.search)),Ha=l.useRef(!1),Dt=l.useMemo(()=>gs(La),[La]),Wa=l.useMemo(()=>ko(Gs),[Gs]),te=l.useCallback(a=>iu(Wa,a),[Wa]),ot=l.useMemo(()=>{if(!e)return[];const a=performance.now(),i=To(e.steps,R,K);return ur.current=performance.now()-a,i},[e,R,K]),Hn=l.useMemo(()=>ot.slice(0,Math.min(ot.length,ha)),[ha,ot]),Nr=l.useMemo(()=>{if(!P)return Hn;const a=new Set(P.matchedStepIds);return Hn.filter(i=>a.has(i.id))},[Hn,P]),Mi=l.useMemo(()=>B?To(B.steps,R,K).slice(0,Math.min(B.steps.length,ha)):[],[B,R,K,ha]),Cr=l.useMemo(()=>e?Gd(e.startedAt,e.endedAt,e.steps):[],[e]),Ei=l.useMemo(()=>!e||!B?null:Lo(e,B),[e,B]),Mr=l.useMemo(()=>e?e.steps.find(a=>a.id===x)??null:null,[e,x]),Ot=l.useMemo(()=>du(h,u,!!B),[h,u,B]),fa=l.useMemo(()=>uu((e==null?void 0:e.steps)??[],x),[e==null?void 0:e.steps,x]),Wn=l.useMemo(()=>fa.join("|"),[fa]),ga=l.useMemo(()=>e?tc(e.steps,ke):[],[e,ke]),Xt=l.useMemo(()=>{const a=As[ke]??ja[ke];return Kr(ga,a.order,a.hidden)},[ga,ke,As]),Ii=l.useMemo(()=>Xt.order.filter(a=>!Xt.hidden.includes(a)),[Xt.hidden,Xt.order]),Va=l.useMemo(()=>{if(ua<2)return[];const a=we.current,i=fs(hs());return Object.values(tr).filter(p=>p.sessionId!==a).filter(p=>!!i[p.sessionId]).filter(p=>p.traceId===((e==null?void 0:e.id)??"none")).sort((p,y)=>y.updatedAt-p.updatedAt)},[ua,tr,e==null?void 0:e.id]),_i=l.useMemo(()=>Va.map(a=>a.playheadMs),[Va]),Ti=l.useMemo(()=>ar.filter(a=>a.traceId===(e==null?void 0:e.id)),[ar,e==null?void 0:e.id]),Er=l.useMemo(()=>{const a=Object.keys(Ia).length,i=Object.values(Ia).filter(Boolean).length;return{done:i,total:a,pct:a>0?Math.round(i/a*100):0}},[Ia]),kt=l.useMemo(()=>{var I;if(!e)return 100;const a=100,i=Math.min(60,((n==null?void 0:n.errors)??0)*16),p=Math.min(24,((n==null?void 0:n.retries)??0)*6),y=e.metadata.wallTimeMs>6e4?12:e.metadata.wallTimeMs>3e4?6:0,k=(I=n==null?void 0:n.timing)!=null&&I.degraded?8:0;return Math.max(0,Math.min(100,Math.round(a-i-p-y-k)))},[n==null?void 0:n.errors,n==null?void 0:n.retries,(zr=n==null?void 0:n.timing)==null?void 0:zr.degraded,e]),Ri=l.useMemo(()=>u==="flow"?"F / C / Space":u==="compare"?"C / Space / ← →":u==="matrix"?"G / C / Cmd+K":u==="gameplay"?"G / S / Cmd+K":"C / F / Space",[u]),At=l.useMemo(()=>{const a=Rs-Date.now(),i=Math.max(0,Math.ceil(a/6e4));return{expired:a<=0,remainingMinutes:i,label:a<=0?"Expired":`${i}m left`}},[Rs]),it=l.useMemo(()=>mu(gt),[gt]),$t=l.useMemo(()=>Rt.trim()?et.some(i=>i.name.toLowerCase()===Rt.trim().toLowerCase())?"Saved view name already exists.":null:"Saved view name is required.",[Rt,et]),Ja=l.useMemo(()=>bu({trace:e,selectedStepId:x,mode:u,workspaceId:Ea,workspaceRole:Wt,safeExport:ee,notifications:Ze.map(a=>({message:a.message,level:a.level})),actions:vt,stepCount:(e==null?void 0:e.steps.length)??0,timeToFirstSuccessMs:at,stuckSignals:Ge.map(a=>({kind:a.kind,detail:a.detail,at:a.at}))}),[vt,u,Ze,ee,x,Ge,at,e,Ea,Wt]),X=l.useCallback((a,i="info")=>{const p=a.trim();if(!p)return;const y=Date.now();Tn(k=>k.some(F=>F.message===p&&F.level===i)?k:[...k,{id:`notif-${y}-${Math.random().toString(36).slice(2,8)}`,message:p,level:i,expiresAt:y+Uu}].slice(-6))},[]),A=l.useCallback((a,i={})=>{try{gu(window.localStorage,{name:a,at:new Date().toISOString(),metadata:i})}catch{}},[]),Te=l.useCallback((a,i={})=>{try{Yo(window.localStorage,a,i)}catch{}},[]),Ve=l.useCallback((a,i,p={})=>{try{Eu(window.localStorage,Si.current,a,i,p)}catch{}},[]),Ka=l.useCallback((a,i,p={})=>{const y=Date.now(),k=`${a}:${String(p.target??"global")}`,I=gr.current[k]??0;y-I<Vu||(gr.current[k]=y,xi(F=>[{id:`stuck-${y}-${Math.random().toString(36).slice(2,8)}`,kind:a,detail:i,at:y},...F].slice(0,8)),X("Looks like you might be stuck. Use Need help now for guided recovery.","warning"),A("ux.error.window",{signal:a,detail:i,...p}))},[X,A]);l.useEffect(()=>{const a=i=>{const p=i.target instanceof HTMLElement?i.target:null;if(!p)return;const y=p.closest('button, a, [role="button"]');if(!y)return;const I=(y.getAttribute("aria-label")??y.getAttribute("data-help-title")??y.textContent??"").trim().replace(/\s+/g," ").slice(0,60).toLowerCase();if(!I)return;Ve("session:first-meaningful-interaction","journey.first_meaningful_interaction",{label:I,mode:u,section:h,traceId:(e==null?void 0:e.id)??null,sessionId:we.current});const F=Date.now(),$=`click:${I}`,pe=hr.current[$]??[],Se=[...Co(pe,F,Hu),F];hr.current[$]=Se,vu(Se,Wu)&&Ka("rage_click",`Rapid repeated clicks on "${I}".`,{target:I,count:Se.length})};return window.addEventListener("click",a,!0),()=>window.removeEventListener("click",a,!0)},[h,u,Ka,e==null?void 0:e.id,Ve]),l.useEffect(()=>{const a=Ze[Ze.length-1];if(!a)return;const i=Date.now();if(!mr.current&&a.level==="success"){const p=wu(Ni.current,i);mr.current=!0,yi(p),A("ux.action.confirmed",{source:"time_to_first_success",elapsedMs:p,message:a.message}),Ve("session:first-success","journey.first_success",{elapsedMs:p,message:a.message,mode:u,section:h,traceId:(e==null?void 0:e.id)??null,sessionId:we.current})}if(a.level==="error"){const p=[...Co(fr.current,i,Ju),i];fr.current=p,p.length>=Ku&&Ka("dead_end_actions","Multiple error outcomes detected in a short period.",{count:p.length})}},[h,u,Ze,Ka,e==null?void 0:e.id,Ve,A]);const Zt=l.useCallback(a=>{bi(i=>hu(i,a))},[]),ba=l.useCallback(async a=>{Gn.current[a.id]=()=>{ba(a)},Rn(i=>{const p=i.find(k=>k.id===a.id),y={id:a.id,label:a.label,status:"running",detail:"Running",updatedAt:Date.now(),retryable:!1};return p?[y,...i.filter(k=>k.id!==a.id)].slice(0,8):[y,...i].slice(0,8)}),A("ux.export.queued",{taskId:a.id,label:a.label});try{a.run(),Rn(i=>i.map(p=>p.id===a.id?{...p,status:"success",detail:"Completed",updatedAt:Date.now(),retryable:!1}:p)),A("ux.export.completed",{taskId:a.id,label:a.label})}catch(i){const p=i instanceof Error?i.message:"Export failed";Rn(y=>y.map(k=>k.id===a.id?{...k,status:"error",detail:p,updatedAt:Date.now(),retryable:!0}:k)),X(`Export failed: ${a.label}`,"error"),A("ux.export.failed",{taskId:a.id,label:a.label,detail:p})}},[X,A]),Je=l.useCallback((a,i,p)=>{const y=`confirm-${Math.random().toString(36).slice(2,9)}`;Un.current[y]=p,On({id:y,title:a,message:i})},[]),ea=l.useCallback((a,i)=>{const p=`undo-${Math.random().toString(36).slice(2,9)}`;xr.current[p]=i,An({id:p,label:a})},[]),Ir=Wt!=="viewer"&&!At.expired,fe=l.useCallback(a=>Ir?!0:(At.expired?X(`Session expired. Renew session to ${a}.`,"warning"):X(`Viewer role cannot ${a}. Switch role to operator or admin.`,"warning"),!1),[X,Ir,At.expired]),Di=l.useCallback(a=>{Tn(i=>i.filter(p=>p.id!==a))},[]),Oi=l.useCallback(()=>{Ds(Date.now()+1e3*60*60*4),X("Session renewed for 4 hours.","success")},[X,Ds]);l.useEffect(()=>{er(yu(window.localStorage))},[]),l.useEffect(()=>{ie.setupWizardV1&&window.localStorage.getItem("agentDirector.setupWizardAuto")==="1"&&(!Jt||$s||hn||Ls||(ht(!0),Fs(!0),A("ux.setup.opened",{source:"auto"})))},[ie.setupWizardV1,Jt,Fs,$s,hn,Ls,A]),l.useEffect(()=>{if(!ma)return;const a=window.setTimeout(()=>{An(null)},6e3);return()=>window.clearTimeout(a)},[ma]),l.useEffect(()=>{const a=p=>{A("ux.error.window",{message:p.message,filename:p.filename,line:p.lineno})},i=p=>{const y=p.reason instanceof Error?p.reason.message:String(p.reason??"unknown");A("ux.error.window",{kind:"unhandledrejection",reason:y})};return window.addEventListener("error",a),window.addEventListener("unhandledrejection",i),()=>{window.removeEventListener("error",a),window.removeEventListener("unhandledrejection",i)}},[A]),l.useEffect(()=>{if(Ha.current)return;const a=Ci.current;if(!a.mode&&!a.traceId&&!a.stepId){Ha.current=!0;return}if(a.mode&&(a.mode!==u&&f(a.mode),a.mode=void 0),a.traceId){if(!d.length)return;if(!d.some(p=>p.id===a.traceId)){a.traceId=void 0,a.stepId=void 0,Ha.current=!0;return}if(c!==a.traceId){m(a.traceId);return}a.traceId=void 0}a.stepId&&(e!=null&&e.steps.some(i=>i.id===a.stepId))&&(x!==a.stepId&&Y(a.stepId),a.stepId=void 0),Ha.current=!0},[u,x,c,f,m,e==null?void 0:e.steps,d]),l.useEffect(()=>{W&&Ht(mn)},[W,mn]),l.useEffect(()=>{if(!W)return;const a=Xu[oe];a!==h&&g(a)},[h,oe,W,g]),l.useEffect(()=>{if(!W)return;const a=ep[me];a!==ve&&cn(a)},[ve,me,W,cn]),l.useEffect(()=>{if(typeof window>"u")return;const a=cu(window.location.href,{mode:u,traceId:c??void 0,stepId:x??void 0});a!==window.location.href&&window.history.replaceState(null,"",a)},[u,x,c]),l.useEffect(()=>{if(!Ze.length)return;const a=window.setInterval(()=>{const i=Date.now();Tn(p=>p.filter(y=>y.expiresAt>i))},1e3);return()=>{window.clearInterval(a)}},[Ze.length]),l.useEffect(()=>{if(!v)return;const a=p=>{var y;(y=or.current)!=null&&y.contains(p.target)||w(!1)},i=p=>{p.key==="Escape"&&w(!1)};return window.addEventListener("mousedown",a),window.addEventListener("keydown",i),()=>{window.removeEventListener("mousedown",a),window.removeEventListener("keydown",i)}},[v]),l.useEffect(()=>{w(!1)},[h,u]),l.useEffect(()=>{const a=Ze[Ze.length-1];a&&a.id!==cr.current&&(cr.current=a.id,xt(a.message))},[Ze]),l.useEffect(()=>{var k;const a=vt[0];if(!a||dr.current[a.id]===a.status)return;dr.current[a.id]=a.status;const p=(k=a.detail)==null?void 0:k.trim(),y=a.status==="running"?"running":a.status;xt(p?`${a.label}: ${y}. ${p}`:`${a.label}: ${y}.`)},[vt]),l.useEffect(()=>{Qt&&X(Qt,"success")},[X,Qt]),l.useEffect(()=>{sn&&A("ux.palette.opened",{section:h,mode:u})},[h,u,sn,A]),l.useEffect(()=>{st&&X(st,"success")},[X,st]),l.useEffect(()=>{Aa&&X(Aa,"error")},[X,Aa]),l.useEffect(()=>{J&&X(J,"warning")},[X,J]),l.useEffect(()=>{$a&&X($a,"warning")},[X,$a]),l.useEffect(()=>{At.expired&&X("Workspace session expired. Renew to continue write actions.","warning")},[X,At.expired]),l.useEffect(()=>{e&&e.id!==Z&&(da(wo(e.id)),zs(e.id))},[Z,da,zs,e]),l.useEffect(()=>{let a=!1;if(!Pe){Xe(null);return}return cs().then(i=>{a||(Xe(i),i||ce("Gameplay session not found."))}),()=>{a=!0}},[Pe]),l.useEffect(()=>{if(!Pe)return;const a=$d();return()=>a()},[Pe]),l.useEffect(()=>{ye&&da(a=>dp(ye,ze,a))},[ze,ye,da]),l.useEffect(()=>{let a=!1;if(!(ye==null?void 0:ye.guild.guild_id)){Kt(null);return}return Rd().then(p=>{a||Kt(p)}),()=>{a=!0}},[ye==null?void 0:ye.guild.guild_id]),l.useEffect(()=>{let a=!1;return po().then(i=>{a||i&&Pa(i)}),()=>{a=!0}},[ze,ye==null?void 0:ye.id]),l.useEffect(()=>{if(typeof window>"u")return;const a=()=>Hs(!0),i=()=>Hs(!1);return window.addEventListener("online",a),window.addEventListener("offline",i),()=>{window.removeEventListener("online",a),window.removeEventListener("offline",i)}},[]),l.useEffect(()=>{if(!Tt){Ua.current={};return}if(typeof navigator>"u"||typeof navigator.getGamepads!="function")return;const a=En==="lefty"?{playPause:1,palette:3,modeCycle:2,speedDown:6,speedUp:7}:{playPause:0,palette:2,modeCycle:3,speedDown:4,speedUp:5},i=["cinema","flow","compare","matrix","gameplay"];let p=0;const y=(I,F,$)=>{const pe=!!Ua.current[F];I&&!pe&&$(),Ua.current[F]=I},k=()=>{var F,$,pe,Se,Wr;const I=navigator.getGamepads()[0];I&&(y(!!((F=I.buttons[a.playPause])!=null&&F.pressed),"playPause",()=>je(Bt=>!Bt)),y(!!(($=I.buttons[a.palette])!=null&&$.pressed),"palette",()=>mt(!0)),y(!!((pe=I.buttons[a.modeCycle])!=null&&pe.pressed),"modeCycle",()=>{f(Bt=>{const Ol=i.indexOf(Bt);return i[(Ol+1)%i.length]})}),y(!!((Se=I.buttons[a.speedDown])!=null&&Se.pressed),"speedDown",()=>{De(Bt=>Math.max(.25,Number((Bt-.25).toFixed(2))))}),y(!!((Wr=I.buttons[a.speedUp])!=null&&Wr.pressed),"speedUp",()=>{De(Bt=>Math.min(3,Number((Bt+.25).toFixed(2))))})),p=window.requestAnimationFrame(k)};return p=window.requestAnimationFrame(k),()=>{window.cancelAnimationFrame(p),Ua.current={}}},[Tt,En,f,De]),l.useEffect(()=>{let a=!1;const i=async()=>{const[y,k]=await Promise.all([mo(),ho()]);a||(y&&Ws(y),k&&Vs(k))};i();const p=window.setInterval(()=>{i()},3e4);return()=>{a=!0,window.clearInterval(p)}},[]),l.useEffect(()=>{L(null),le(null)},[e==null?void 0:e.id]),l.useEffect(()=>{const a=Math.round(ur.current);ki(a),a>0&&A("ux.perf.filter_ms",{ms:a,steps:ot.length})},[ot,A]),l.useEffect(()=>{if(!e)return;const a=ot.length;if(a<=1200){Bn(a);return}Bn(800);const i=window.setInterval(()=>{Bn(p=>p>=a?(window.clearInterval(i),a):Math.min(a,p+1e3))},70);return()=>window.clearInterval(i)},[ot.length,e]),l.useEffect(()=>{e&&(e.steps.length<450||Oe||(We(!0),nn(a=>Math.min(a,15e3)),X("Enabled windowed playback automatically for large traces.","info")))},[X,e,Oe,We]),l.useEffect(()=>{let a=!1;if(!(e!=null&&e.id)){U(null);return}return gd(e.id).then(i=>{a||U(i)}),()=>{a=!0}},[e==null?void 0:e.id]),l.useEffect(()=>{let a=!1;return bd().then(i=>{a||(ae(i),!be&&i.length>0&&re(i[0].id))}),()=>{a=!0}},[be]),l.useEffect(()=>{ir.current=B},[B]),l.useEffect(()=>(document.body.dataset.theme=Ut,()=>{delete document.body.dataset.theme}),[Ut]),l.useEffect(()=>(document.body.dataset.motion=la,()=>{delete document.body.dataset.motion}),[la]),l.useEffect(()=>{const a=we.current,i=($=!1)=>{const pe=Date.now(),Se=fs(hs(),pe);$?delete Se[a]:Se[a]=pe,window.localStorage.setItem(js,JSON.stringify(Se)),Js(Math.max(1,Object.keys(Se).length))},p=()=>{const $=fs(hs(),Date.now());Js(Math.max(1,Object.keys($).length))};i();const y=window.setInterval(()=>i(),Gu),k=$=>{$.key===js&&p()},I=()=>{document.visibilityState==="visible"&&i()},F=()=>i(!0);return window.addEventListener("storage",k),document.addEventListener("visibilitychange",I),window.addEventListener("beforeunload",F),()=>{window.clearInterval(y),i(!0),window.removeEventListener("storage",k),document.removeEventListener("visibilitychange",I),window.removeEventListener("beforeunload",F)}},[]),l.useEffect(()=>{u==="compare"&&ln(!1)},[u,ln]),l.useEffect(()=>{ga.length!==0&&Vt(a=>{const i=a[ke]??ja[ke],p=Kr(ga,i.order,i.hidden);return p.order.join("|")===i.order.join("|")&&p.hidden.join("|")===i.hidden.join("|")?a:{...a,[ke]:p}})},[ga,ke,Vt]),l.useEffect(()=>{$n(Et(window.localStorage.getItem(ra),{})),Pn(Et(window.localStorage.getItem(ps),[])),Fn(Et(window.localStorage.getItem(ms),[]))},[]),l.useEffect(()=>{const a=Date.now();if(a-lr.current<120&&Be)return;lr.current=a;const i=we.current,p={sessionId:i,traceId:(e==null?void 0:e.id)??"none",mode:u,playheadMs:Math.round(E),selectedStepId:x,updatedAt:a},k={...Et(window.localStorage.getItem(ra),{}),[i]:p};window.localStorage.setItem(ra,JSON.stringify(k)),$n(k)},[Be,u,E,x,e==null?void 0:e.id]),l.useEffect(()=>{const a=we.current;return()=>{const i=Et(window.localStorage.getItem(ra),{});if(!i[a])return;const p={...i};delete p[a],window.localStorage.setItem(ra,JSON.stringify(p))}},[]),l.useEffect(()=>{const a=i=>{if(i.key===ra&&$n(Et(i.newValue,{})),i.key===ps){const p=Et(i.newValue,[]);Pn(y=>bo(y,p))}i.key===ms&&Fn(yo(Et(i.newValue,[])))};return window.addEventListener("storage",a),()=>window.removeEventListener("storage",a)},[]);const G=l.useCallback(a=>{const i={id:`activity-${Math.random().toString(36).slice(2,9)}`,sessionId:we.current,message:a,timestamp:Date.now()};Fn(p=>{const y=yo([i,...p]);return window.localStorage.setItem(ms,JSON.stringify(y)),y})},[]),$e=l.useCallback((a,i,p)=>{pr.current[a]||(pr.current[a]=!0,qd(i,p))},[]),St=l.useCallback(async function(i){i.retry&&(br.current[i.id]=i.retry),i.resume&&(yr.current[i.id]=i.resume),Zt({id:i.id,label:i.label,status:"running",detail:"Running",retryable:!1,resumable:!1});try{const p=await i.run();return Zt({id:i.id,label:i.label,status:"success",detail:i.successDetail??"Completed",retryable:!1,resumable:!1}),p}catch(p){const y=p instanceof Error?p.message:"Action failed";throw Zt({id:i.id,label:i.label,status:"error",detail:y,retryable:!!i.retry,resumable:!!i.resume}),p}},[Zt]),_r=l.useCallback(a=>{const i=br.current[a];i&&(A("ux.action.retry",{id:a}),i())},[A]),Tr=l.useCallback(a=>{const i=yr.current[a];i&&(A("ux.action.resume",{id:a}),i())},[A]),lt=l.useCallback(async a=>{if(!e||!fe("run replay"))return;const i=await xd(e.id,a,"hybrid",{note:"UI replay"},e);i&&(zt(i),qe(!0),f("flow"),Ae(p=>p.replay?p:{...p,replay:!0}),G(`Created replay from ${a}`))},[G,fe,Ae,e,zt,f,qe]),Ai=l.useCallback(async()=>{if(e){if(!O.trim()){L(null),le(null);return}try{const a=await St({id:"trace-query",label:"TraceQL query",run:async()=>fd(e.id,O.trim()),successDetail:"Query complete"});if(!a){le("TraceQL query failed"),L(null);return}L(a),le(null);const i=a.matchedStepIds[0];i&&(Y(i),u!=="cinema"&&f("cinema"))}catch{le("TraceQL query failed"),L(null)}}},[St,u,f,e,O]),$i=l.useCallback(async()=>{if(!(!e||!be)){xe(!0);try{const a=await St({id:"run-extension",label:"Run extension",run:async()=>yd(be,e.id),successDetail:"Extension output ready"});if(!a)return;Ee(a.result)}finally{xe(!1)}}},[St,be,e]),Ce=l.useCallback(()=>{if(!e)return;const a=[...e.steps].sort((i,p)=>(p.durationMs??0)-(i.durationMs??0))[0];a&&(Y(a.id),f("cinema"))},[e,f]),Rr=l.useCallback(()=>{if(!e||e.steps.length===0)return null;const a=[...e.steps].sort((i,p)=>(p.durationMs??0)-(i.durationMs??0))[0];return(a==null?void 0:a.id)??null},[e]),Ue=l.useCallback(()=>{if(!e)return;const a=e.steps.find(i=>i.status==="failed");a&&(Y(a.id),f("cinema"))},[e,f]),Nt=l.useCallback(async()=>{if(!e)return;const a=new URL(window.location.href);a.searchParams.set("trace",c??e.id),a.searchParams.set("mode",u),x?a.searchParams.set("step",x):a.searchParams.delete("step");try{await navigator.clipboard.writeText(a.toString()),In("Live link copied")}catch{window.prompt("Copy live session link",a.toString()),In("Live link ready")}window.setTimeout(()=>In(null),1800)},[u,x,c,e]),Pi=l.useCallback(a=>{Os(a),G(`Switched lane strategy to ${a}`)},[G,Os]),Li=l.useCallback(a=>{Vt(i=>{const p=i[ke]??ja[ke],y=p.hidden.includes(a)?p.hidden.filter(k=>k!==a):[...p.hidden,a];return{...i,[ke]:{...p,hidden:y}}}),G(`Toggled lane visibility for ${a}`)},[G,ke,Vt]),Fi=l.useCallback(async a=>{if(!e||!fe("create gameplay sessions"))return;const i=await Sd({traceId:e.id,name:a.trim()||"Night Ops"});if(!i){ce("Failed to create gameplay session.");return}Xe(i),yt(i.id),ce(null),G(`Created gameplay session ${i.id}`)},[G,ze,fe,yt,e]),Bi=l.useCallback(async()=>{if(!e||!fe("matchmake gameplay sessions"))return;const a=await Nd({traceId:e.id});if(!a){ce("Failed to matchmake gameplay session.");return}Xe(a.session),yt(a.session.id),ce(null),G(`${a.match.type==="created"?"Created":"Matched"} gameplay session ${a.session.id} as ${a.match.assigned_role}`)},[G,ze,fe,yt,e]),qi=l.useCallback(async(a,i,p)=>{if(!fe("join gameplay sessions"))return;if(!a.trim()){ce("Session id is required.");return}const y=await Cd({sessionId:a.trim(),playerId:i.trim()});if(!y){ce("Failed to join gameplay session.");return}Xe(y),yt(y.id),ce(null),G(`Joined gameplay session ${y.id} as ${i}`)},[G,fe,yt]),zi=l.useCallback(async()=>{Pe&&fe("leave gameplay sessions")&&Je("Leave gameplay session",`Leave session ${Pe}?`,()=>{(async()=>{if(!await Md()){ce("Failed to leave gameplay session.");return}Xe(null),yt(""),ce(null),G(`Left gameplay session ${Pe}`),A("ux.action.confirmed",{action:"leave_gameplay_session",sessionId:Pe})})()})},[G,ze,Pe,Je,fe,yt,A]),Gi=l.useCallback(async()=>{if(!Pe)return;const a=await Ed();if(!a){ce("Failed to reconnect gameplay session.");return}Xe(a),ce(null),G(`Reconnected gameplay session ${Pe}`)},[G,ze,Pe]),Ui=l.useCallback(async(a,i)=>{if(!(ye!=null&&ye.id)||!fe(`run gameplay action ${a}`))return;const p=await uo({sessionId:ye.id,expectedVersion:ye.version});if(p.session){Xe(p.session),ce(null),G(`Gameplay action: ${a}`);return}if(p.conflict){const y=await cs(ye.id);y&&Xe(y),ce("Session changed by another player. Synced latest state.");return}ce(p.error??"Gameplay action failed.")},[G,ze,ye,fe]),Hi=l.useCallback(async(a,i)=>{if(!fe("create guilds"))return;if(!a.trim()||!i.trim()){ce("Guild id and name are required.");return}const p=await Td({guildId:a.trim(),name:i.trim()});if(!p){ce("Failed to create guild.");return}if(Kt(p),ye){const y=await uo({sessionId:ye.id,payload:{guild_id:p.id},expectedVersion:ye.version});y.session&&Xe(y.session)}ce(null),G(`Created guild ${p.id}`)},[G,ze,ye,fe]),Wi=l.useCallback(async(a,i)=>{if(!fe("join guilds"))return;if(!a.trim()||!i.trim()){ce("Guild id and player id are required.");return}const p=await Dd(a.trim(),i.trim());if(!p){ce("Failed to join guild.");return}Kt(p),ce(null),G(`Joined guild ${p.id} as ${i}`)},[G,fe]),Vi=l.useCallback(async(a,i,p)=>{if(!fe("schedule guild events"))return;if(!a.trim()||!i.trim()||!p.trim()){ce("Guild id, title, and schedule are required.");return}const y=await Od({guildId:a.trim(),title:i.trim(),scheduledAt:p.trim()});if(!y){ce("Failed to schedule guild event.");return}Kt(y.guild),ce(null),G(`Scheduled guild event ${y.event.id}`)},[G,fe]),Ji=l.useCallback(async(a,i,p)=>{if(!fe("complete guild events"))return;const y=await Ad();if(!y){ce("Failed to complete guild event.");return}Kt(y),ce(null),G(`Completed guild event ${i}`)},[G,fe]),Ki=l.useCallback(async a=>{if(!fe("send friend invites"))return;const i=await Id({toPlayerId:a.trim().toLowerCase()});if(!i){ce("Failed to send friend invite.");return}Pa(i.social),ce(null),G(`Sent friend invite to ${a}`)},[G,ze,fe]),Qi=l.useCallback(async a=>{if(!fe("accept friend invites"))return;const i=await _d();if(!i){ce("Failed to accept friend invite.");return}Pa(i),ce(null),G(`Accepted friend invite ${a}`)},[G,ze,fe]),Dr=l.useCallback(()=>{St({id:"retry-connectivity",label:"Retry connectivity",retry:()=>Dr(),run:async()=>{if(ce(null),o(),Pe){const y=await cs();y&&Xe(y)}const[a,i,p]=await Promise.all([po(),mo(),ho()]);return a&&Pa(a),i&&Ws(i),p&&Vs(p),G("Retried connectivity sync"),!0},successDetail:"Connectivity synced"}).catch(()=>{ce("Retry connectivity failed.")})},[G,St,ze,Pe,o]),Yi=l.useCallback((a,i)=>{Vt(p=>{const y=p[ke]??ja[ke],k=[...y.order],I=k.indexOf(a);if(I===-1)return p;const F=i==="up"?I-1:I+1;if(F<0||F>=k.length)return p;const[$]=k.splice(I,1);return k.splice(F,0,$),{...p,[ke]:{...y,order:k}}}),G(`Moved lane group ${a} ${i}`)},[G,ke,Vt]),Xi=l.useCallback(()=>{Ae({playback:!1,flow:!1,inspect:!1,matrix:!1,replay:!1,annotate:!1,collaborate:!1}),G("Reset onboarding missions")},[G,Ae]),Zi=l.useCallback((a,i)=>{if(!e||!a.trim())return;const p=Date.now(),y={id:`annotation-${Math.random().toString(36).slice(2,9)}`,traceId:e.id,stepId:i,body:a.trim(),authorSessionId:we.current,createdAt:p,updatedAt:p};Pn(k=>{const I=bo(k,[y]);return window.localStorage.setItem(ps,JSON.stringify(I)),I}),Ae(k=>k.annotate?k:{...k,annotate:!0}),G(i?`Added annotation on step ${i}`:"Added trace annotation")},[G,Ae,e]),el=l.useCallback((a,i)=>{_t(p=>p.map(y=>y.id===a?{...y,...i}:y))},[]),tl=l.useCallback(a=>{_t(a)},[]),al=l.useCallback(()=>{_t(a=>[...a,{id:Ya(),name:`Scenario ${a.length+1}`,strategy:"hybrid",modificationsText:"{}"}])},[]),nl=l.useCallback(a=>{kn.length<=1||Je("Remove scenario","Remove this scenario from the matrix run?",()=>{let i=null,p=-1;_t(y=>(p=y.findIndex(k=>k.id===a),p===-1||y.length<=1?y:(i=y[p]??null,y.filter(k=>k.id!==a)))),!(!i||p===-1)&&(ea("Scenario removed",()=>{_t(y=>{const k=[...y];return k.splice(Math.min(p,k.length),0,i),k}),A("ux.action.undone",{action:"matrix_scenario_remove",scenarioId:a})}),A("ux.action.confirmed",{action:"matrix_scenario_remove",scenarioId:a}))})},[kn.length,ea,Je,A]),sl=l.useCallback(a=>{_t(i=>{const p=i.findIndex(F=>F.id===a);if(p===-1)return i;const y=i[p],k={...y,id:Ya(),name:`${y.name} copy`},I=[...i];return I.splice(p+1,0,k),I})},[]),rl=l.useCallback((a,i)=>{_t(p=>{const y=p.findIndex($=>$.id===a);if(y===-1)return p;const k=i==="up"?y-1:y+1;if(k<0||k>=p.length)return p;const I=[...p],[F]=I.splice(y,1);return I.splice(k,0,F),I})},[]),Vn=l.useCallback(async a=>{var p;if(!e||!fe("run replay matrix"))return;const i=wn||x||((p=e.steps[0])==null?void 0:p.id);if(!i){ca("Select an anchor step before running the matrix.");return}try{Oa(!0),ca(null),await St({id:"matrix-run",label:"Replay matrix run",retry:()=>{Vn(a)},resume:()=>{Vn(a)},run:async()=>{const y=await vd({traceId:e.id,stepId:i,scenarios:a});if(!y)throw new Error("Failed to create replay job.");Sn(y);let k=y;for(let F=0;F<30&&!(k.status!=="queued"&&k.status!=="running");F+=1){const $=Jd(F);await new Promise(Se=>window.setTimeout(Se,$));const pe=await wd(y.id);if(!pe)break;k=pe,Sn(pe)}const I=await co(y.id);if(!I)throw new Error("Replay job finished but matrix summary is unavailable.");return qs(I),f("matrix"),G(`Ran matrix with ${a.length} scenario(s) from ${i}`),I},successDetail:`${a.length} scenario(s) complete`})}catch(y){ca(y instanceof Error?y.message:"Failed to run replay matrix.")}finally{Oa(!1)}},[G,St,wn,fe,x,e,f]),ol=l.useCallback(async()=>{bt&&fe("cancel replay matrix jobs")&&Je("Cancel matrix job",`Cancel replay job ${bt.id}?`,()=>{(async()=>{Oa(!0);try{const a=await jd(bt.id);if(!a){ca("Failed to cancel replay job.");return}Sn(a),Zt({id:"matrix-run",label:"Replay matrix run",status:"canceled",detail:`Canceled ${bt.id}`,resumable:!0,retryable:!0});const i=await co(a.id);i&&qs(i),G(`Canceled matrix job ${bt.id}`),A("ux.action.cancel",{id:bt.id})}finally{Oa(!1)}})()})},[G,bt,Je,fe,Zt,A]),il=l.useCallback(async a=>{const i=await Fo();if(!(i!=null&&i.trace)){ca("Could not load replay trace for compare view.");return}zt(i.trace),qe(!0),f("compare"),G(`Opened matrix compare trace ${a}`)},[G,f,qe]),H=l.useCallback(a=>{if(!(a===u||!e)){if((a==="flow"||a==="matrix"||a==="gameplay")&&je(!1),a==="flow"&&u==="cinema"&&qn.current){const i=qn.current,p=lp(i),y=cp(e.steps,i,e.id);Bs({steps:e.steps,fromRects:p,toRects:y}),G("Morphed cinema to flow");return}f(a),G(`Switched mode to ${a}`)}},[G,u,e,je,f]),ya=l.useCallback(async a=>{if(dn(a),a==="rapid_triage"){H("cinema"),Ue(),e!=null&&e.steps.some(i=>i.status==="failed")||Ce(),G("Started rapid triage launch path");return}if(a==="deep_diagnosis"){H("flow"),G("Started deep diagnosis launch path");return}ne(!0),H("matrix"),await Nt(),G("Started team sync launch path")},[G,H,Ce,Ue,dn,ne,Nt,e]),Jn=l.useCallback(()=>{u==="flow"&&H("cinema"),je(a=>!a)},[u,H]),Ct=l.useCallback(()=>{Ra(null),yn([]),vn(null),je(!1)},[je]),Or=l.useCallback(a=>[{id:"setup",label:"Opening the reel",duration:1100,action:()=>{Qe(!0),je(!1),se(0),Y(null),qe(!1),De(1),e&&e.steps.length<500&&We(!1),H("cinema")}},{id:"pace",label:"Pacing the timeline",duration:2200,action:()=>{H("cinema"),je(!0),De(1.1)}},{id:"bottleneck",label:"Freeze on the bottleneck",duration:1600,action:()=>{je(!1),Ce()}},{id:"inspect",label:"Inspect the moment",duration:1600,action:()=>{a&&Y(a)}},{id:"flow",label:"Morph into flow",duration:2100,action:()=>{H("flow")}},{id:"replay",label:"Director’s Cut replay",duration:2200,action:async()=>{if(!e)return;!ir.current&&a&&await lt(a),qe(!0),f("compare")}},{id:"compare",label:"Compare the cut",duration:2e3,action:()=>{je(!0),De(1)}},{id:"finale",label:"Final frame",duration:1100,action:()=>{je(!1)}}],[H,lt,Ce,Qe,je,f,qe,se,Y,De,We,e]),ta=l.useCallback(()=>{var i;if(!e)return;const a=x??Rr()??((i=e.steps[0])==null?void 0:i.id)??null;yn(Or(a)),Ra({active:!0,step:0}),vn(e.id),Ie(!1),pt(!1),mt(!1)},[Or,Rr,x,e,mt,pt,yn,Ra,vn,Ie]),xa=l.useCallback(()=>{if(ue!=null&&ue.active){Ct();return}ta()},[ta,Ct,ue==null?void 0:ue.active]),ll=l.useMemo(()=>{const i=[{id:"header",title:"Mission control",body:`Confirm run status and metadata. ${{builder:"Focus on payload flow, tool-call sequencing, and replay-ready steps.",executive:"Focus on bottlenecks, risk signals, and run-level outcome changes.",operator:"Focus on failure patterns, retries, and runtime reliability posture."}[ve]}`,target:'[data-tour="header"]',placement:"bottom"}];return rn||i.push({id:"hero",title:"Director briefing",body:"Choose Tour, Story mode, or Explain to ramp up quickly.",target:'[data-tour="hero"]',placement:"bottom"}),i.push({id:"insights",title:"Fast diagnosis",body:ve==="executive"?"Jump straight to bottlenecks and high-cost segments for fast executive readouts.":ve==="operator"?"Jump to failures and retries first, then inspect impacted steps.":"Jump straight to bottlenecks, errors, and high-cost steps with one click.",target:'[data-tour="insights"]',placement:"bottom"},{id:"journey",title:"Director journey",body:"A narrative path that teaches how to watch, inspect, and direct a better run.",target:'[data-tour="journey"]',placement:"bottom"},{id:"toolbar",title:"Filters + modes",body:"Search, filter, and switch between Cinema, Flow, and Compare as the story evolves.",target:'[data-tour="toolbar"]',placement:"bottom"},{id:"quick-actions",title:"Quick actions",body:"Launch Story Mode, open the command palette, or jump to bottlenecks instantly.",target:'[data-tour="quick-actions"]',placement:"left"},{id:"stage",title:"Cinema stage",body:"The timeline shows every step as a scene. Scrub to see pacing and concurrency.",target:'[data-tour="stage"]',placement:"top"},{id:"inspector",title:"Inspector",body:ve==="executive"?"Open key moments to validate outcome impact and communication-ready summaries.":"Open any step to read payloads, apply redaction, and replay from that moment.",target:'[data-tour="inspector"]',placement:"left"},{id:"compare",title:"Compare runs",body:B?"Compare is live. Review deltas in cost, steps, and wall time side by side.":"Replay from a step to unlock compare mode and validate improvements.",target:'[data-tour="compare"]',placement:"top"}),i},[B,rn,ve]),cl=l.useCallback(()=>{Bs(null),f("flow")},[f]),nt=l.useMemo(()=>{var y,k,I,F;if(!e)return[];const a=[],i=[...e.steps].sort(($,pe)=>(pe.durationMs??0)-($.durationMs??0))[0],p=e.steps.find($=>$.status==="failed");if(p&&x!==p.id&&a.push({id:"jump-error",title:"Investigate first failure",body:`${p.name} failed and should be inspected before optimization work.`,actionLabel:"Open failed step",tone:"warning",action:Ue}),i&&x!==i.id&&a.push({id:"jump-bottleneck",title:"Tackle latency bottleneck",body:`${i.name} is the slowest scene in this run and the best optimization target.`,actionLabel:"Open bottleneck",tone:"priority",action:Ce}),(y=D==null?void 0:D.hypotheses)!=null&&y[0]){const $=D.hypotheses[0];a.push({id:"investigate-hypothesis",title:$.title,body:$.summary,actionLabel:"Inspect evidence",tone:"info",action:()=>{const pe=$.evidenceStepIds[0];pe&&(Y(pe),u!=="cinema"&&f("cinema"))}})}if(u!=="matrix"&&a.push({id:"matrix-experiment",title:"Run scenario matrix",body:"Compare prompt and strategy alternatives from one anchor step to rank causal impact.",actionLabel:"Open matrix",tone:"info",action:()=>{var $;jn(x??(($=e.steps[0])==null?void 0:$.id)??""),f("matrix")}}),!B&&(x||(k=e.steps[0])!=null&&k.id)){const $=x??((I=e.steps[0])==null?void 0:I.id)??null;$&&a.push({id:"run-replay",title:"Create director replay",body:"Branch a replay trace and validate whether your change improves the run.",actionLabel:"Replay from step",tone:"info",action:()=>{lt($)}})}if((F=_e==null?void 0:_e.causalRanking)!=null&&F.length){const $=_e.causalRanking[0];a.push({id:"causal-factor",title:`Top causal factor: ${$.factor}`,body:`Confidence ${($.confidence*100).toFixed(0)}% across ${$.evidence.samples} sample(s).`,actionLabel:"View matrix",tone:"priority",action:()=>f("matrix")})}return a.slice(0,4)},[B,lt,D,Ce,Ue,u,_e,x,e,f]),dl=l.useMemo(()=>nt.map((a,i)=>{const p=a.tone==="warning"?"high":a.tone==="priority"?"medium":"low";return{id:`priority-${a.id}`,title:a.title,detail:a.body,severity:p,actionLabel:a.actionLabel,onAction:a.action,done:i===0?a.id==="jump-error"&&!!x||a.id==="jump-bottleneck"&&!!x:!1}}),[nt,x]),Pt=l.useMemo(()=>{var I,F;if(!e)return"No trace loaded.";const a=[...e.steps].sort(($,pe)=>(pe.durationMs??0)-($.durationMs??0))[0],i=e.steps.filter($=>$.status==="failed").length,p=(I=D==null?void 0:D.hypotheses)==null?void 0:I[0],y=(F=_e==null?void 0:_e.causalRanking)==null?void 0:F[0];return[`Run ${e.id} completed with ${e.steps.length} steps across ${e.metadata.wallTimeMs}ms.`,a?`Primary latency driver: ${a.name} (${a.durationMs??0}ms).`:null,i>0?`Observed ${i} failed step(s), indicating reliability risk.`:"No failed steps observed.",p?`Top investigation hypothesis: ${p.title} (${p.severity}).`:null,y?`Highest ranked causal factor from matrix: ${y.factor} (${(y.confidence*100).toFixed(0)}% confidence).`:null,"Recommended plan: inspect bottleneck evidence, validate with replay matrix, and lock in mitigations."].filter(Boolean).join(" ")},[D,_e==null?void 0:_e.causalRanking,e]),ul=l.useCallback(a=>{var p,y;const i=a.toLowerCase();if(!e)return"No trace is loaded yet.";if(i.includes("bottleneck")||i.includes("slow")){const k=[...e.steps].sort((I,F)=>(F.durationMs??0)-(I.durationMs??0))[0];return k?`The primary bottleneck is ${k.name} at ${k.durationMs??0}ms. Prioritize this step for optimization and replay validation.`:"No bottleneck could be determined from current trace data."}if(i.includes("risk")||i.includes("failure")||i.includes("error")){const k=e.steps.filter(I=>I.status==="failed");return k.length?`Risk is concentrated in ${k.length} failed step(s), starting at ${((p=k[0])==null?void 0:p.name)??"unknown"}.`:"Failure risk appears low for this run; no failed steps were observed."}return i.includes("cost")?`Recorded run cost is ${(e.metadata.totalCostUsd??0).toFixed(4)} USD. Use matrix scenarios to evaluate cheaper prompt/strategy options.`:i.includes("next")||i.includes("action")?nt.length?`Next action: ${((y=nt[0])==null?void 0:y.title)??"Open matrix"}.`:"Next action: open Cinema mode, inspect bottleneck, then run the matrix.":Pt},[Pt,nt,e]),aa=l.useCallback(()=>{e&&ba({id:"export-director-narrative",label:"Director narrative markdown",run:()=>{const a=`# Director Narrative

${Pt}

## Recommended Actions
${nt.map(i=>`- ${i.title}: ${i.body}`).join(`
`)}`;ns(`agent-director-narrative-${e.id}.md`,a,"text/markdown")}})},[Pt,nt,ba,e]),Mt=l.useCallback(async()=>{if(!e)return;const a=nt[0],i=e.steps.filter(k=>k.status==="failed").length,y=[`Session handoff (${new Date().toISOString()})`,`Trace: ${e.id}`,`Owner: ${wt}`,`Handoff owner: ${jt||"unassigned"}`,`Mode: ${u}`,`Selected step: ${x??"none"}`,`Run health: ${kt}/100`,`Failures: ${i}`,`Wall time: ${e.metadata.wallTimeMs}ms`,`Top recommendation: ${a?`${a.title} -> ${a.actionLabel}`:"None"}`,`Narrative: ${Pt}`].join(`
`);try{await navigator.clipboard.writeText(y),_n("Handoff digest copied"),A("ux.support.payload_copied",{kind:"handoff_digest"})}catch{window.prompt("Copy handoff digest",y),_n("Handoff digest ready")}window.setTimeout(()=>_n(null),2200)},[Pt,nt,jt,u,kt,wt,x,e,A]),va=l.useCallback(a=>{const i=ie[a],p=!i,y=I=>{er(F=>{const $={...F,[a]:I};return xu(window.localStorage,$),A("ux.feature_flag.toggled",{flag:a,enabled:I}),$})},k=()=>{y(p),X(`${p?"Enabled":"Disabled"} ${a}.`,p?"success":"warning"),ea(`${a} ${p?"enabled":"disabled"}.`,()=>y(i))};if(!p){Je("Disable feature control?",`Turning off ${a} can remove a workflow control from the active route. Continue?`,k);return}k()},[X,ie,ea,Je,A]),wa=l.useCallback(()=>{const a=!ee,i=y=>{z(y),A("ux.action.confirmed",{action:"safe_export_toggle",enabled:y})},p=()=>{i(a),X(a?"Safe export enabled. Sensitive payloads remain redacted.":"Safe export disabled. Raw payload controls are now available.",a?"success":"warning"),ea(`Safe export ${a?"enabled":"disabled"}.`,()=>i(!a))};if(!a){Je("Disable safe export?","Disabling safe export may expose raw payload data. Continue?",p);return}p()},[X,ea,Je,ee,z,A]),pl=l.useCallback(()=>{it.isValid&&(Ps(!0),ht(!1),fn("source"),X("Workspace setup complete.","success"),A("ux.setup.completed",{dataSource:gt.dataSource,hasInvites:!!gt.inviteEmails.trim()}))},[X,it.isValid,gt,A,Ps]),Lt=l.useCallback(a=>{const i=Ge[0],p=x??"none",y=(e==null?void 0:e.id)??"none",k=[`Need-help escalation (${new Date().toISOString()})`,`Trace: ${y}`,`Mode: ${u}`,`Selected step: ${p}`,`Signal: ${i?`${i.kind} - ${i.detail}`:"manual escalation request"}`,`Time to first success: ${at??"not yet achieved"} ms`,"What happened: ","Expected outcome: ","What blocked progress: "].join(`
`);Ys(I=>I.trim()?I:k),Qs(!0),X("Guided support opened with contextual diagnostics.","info"),A("ux.support.opened",{source:a,escalated:!0,signal:(i==null?void 0:i.kind)??null,timeToFirstSuccessMs:at})},[X,u,x,Ge,at,e,A]),ml=l.useCallback(async()=>{const a=JSON.stringify({diagnostics:Ja,note:pa,owner:wt,handoffOwner:jt||null},null,2);try{await navigator.clipboard.writeText(a),X("Support payload copied.","success"),A("ux.support.payload_copied",{bytes:a.length})}catch{window.prompt("Copy support payload",a)}},[X,jt,wt,Ja,pa,A]),Kn=l.useCallback(()=>{const a=Rt.trim();if(!a||$t)return;const i={id:`view-${Math.random().toString(36).slice(2,9)}`,name:a,state:{mode:u,query:S,typeFilter:K,selectedStepId:x,safeExport:ee,windowed:Oe,syncPlayback:ge,explainMode:Ke,section:h}};Ba(p=>[i,...p].slice(0,20)),Ks(""),qa(i.id),A("ux.saved_view.created",{viewId:i.id,name:a}),X(`Saved view: ${a}`,"success")},[h,X,Ke,u,S,ee,Rt,$t,x,Ba,ge,A,K,Oe]),Qn=l.useCallback(a=>{const i=et.find(p=>p.id===a);i&&(f(i.state.mode),C(i.state.query),_(i.state.typeFilter),Y(i.state.selectedStepId),z(i.state.safeExport),We(i.state.windowed),ne(i.state.syncPlayback),Qe(i.state.explainMode),g(i.state.section),qa(i.id),A("ux.saved_view.applied",{viewId:i.id,name:i.name}),X(`Applied view: ${i.name}`,"info"))},[X,et,g,Qe,f,z,ne,We,A]),hl=l.useCallback(()=>{if(!rt)return;const a=et.find(i=>i.id===rt);a&&Je("Delete saved view",`Delete saved view "${a.name}"?`,()=>{Ba(i=>i.filter(p=>p.id!==rt)),qa(""),A("ux.saved_view.deleted",{viewId:a.id,name:a.name}),X(`Deleted view: ${a.name}`,"warning")})},[X,Je,et,rt,Ba,A]);l.useEffect(()=>{var p;if(!e)return;hd(),se(0),je(!1);const a=Math.min(Math.max((e.metadata.wallTimeMs||1)*.2,5e3),6e4);nn(a),e.steps.length>500&&We(!0),B||qe(!1),u==="compare"&&!B&&f("cinema");const i=x&&e.steps.some(y=>y.id===x)?x:((p=e.steps[0])==null?void 0:p.id)??"";jn(y=>y&&e.steps.some(k=>k.id===y)?y:i)},[e,B,u,x,f,We,qe]),l.useEffect(()=>(document.body.classList.toggle("explain-mode",Ke),()=>{document.body.classList.remove("explain-mode")}),[Ke]),l.useEffect(()=>(document.body.classList.toggle("story-mode",!!(ue!=null&&ue.active)),()=>{document.body.classList.remove("story-mode")}),[ue==null?void 0:ue.active]),l.useEffect(()=>{if(!(ue!=null&&ue.active))return;const a=Da[ue.step];if(!a){Ct();return}Promise.resolve(a.action());const i=window.setTimeout(()=>{Ra(p=>p&&p.active?{...p,step:p.step+1}:p)},a.duration);return()=>window.clearTimeout(i)},[Da,Ct,ue]),l.useEffect(()=>{ue!=null&&ue.active&&(!e||!xn||e.id!==xn&&Ct())},[ue==null?void 0:ue.active,e,xn,Ct]),l.useEffect(()=>{W||Jt||_a||$e(`tutorial_start:${(e==null?void 0:e.id)||Z||he.seed}`,"funnel.tutorial_start",{traceId:(e==null?void 0:e.id)||Z||"unknown",persona:ve,launchPath:Ye})},[$e,he.seed,Z,Jt,ve,Ye,W,_a,e==null?void 0:e.id]),l.useEffect(()=>{E>0&&Ae(a=>a.playback?a:{...a,playback:!0})},[E,Ae]),l.useEffect(()=>{u==="flow"&&Ae(a=>a.flow?a:{...a,flow:!0}),u==="matrix"&&Ae(a=>a.matrix?a:{...a,matrix:!0})},[u,Ae]),l.useEffect(()=>{x&&Ae(a=>a.inspect?a:{...a,inspect:!0})},[x,Ae]),l.useEffect(()=>{ua>1&&Ae(a=>a.collaborate?a:{...a,collaborate:!0})},[ua,Ae]),l.useEffect(()=>{$e(`session_start:${Z||he.seed}`,"funnel.session_start",{traceId:Z||(e==null?void 0:e.id)||"unknown",seed:he.seed})},[$e,he.seed,Z,e==null?void 0:e.id]),l.useEffect(()=>{he.raid.objectives.some(i=>i.progress>0)&&$e(`objective_progress:${Z||he.seed}`,"funnel.first_objective_progress",{traceId:Z||(e==null?void 0:e.id)||"unknown"})},[$e,he.raid.objectives,he.seed,Z,e==null?void 0:e.id]),l.useEffect(()=>{he.outcome.status!=="in_progress"&&($e(`first_outcome:${Z||he.seed}`,"funnel.first_mission_outcome",{status:he.outcome.status,reason:he.outcome.reason}),(he.outcome.status==="win"||he.outcome.status==="loss")&&$e(`run_outcome:${Z||he.seed}`,"funnel.run_outcome",{status:he.outcome.status,reason:he.outcome.reason}))},[$e,he.outcome.reason,he.outcome.status,he.seed,Z]),l.useEffect(()=>{if(!ge||Be||zn.current)return;const a=Va[0];if(!a||a.traceId!==(e==null?void 0:e.id))return;const i=Math.abs(a.playheadMs-E),p=a.mode!==u,y=(a.selectedStepId??null)!==(x??null);i<600&&!p&&!y||(zn.current=!0,se(a.playheadMs),(a.mode==="cinema"||a.mode==="flow"||a.mode==="compare"||a.mode==="matrix"||a.mode==="gameplay")&&f(a.mode),Y(a.selectedStepId??null),window.setTimeout(()=>{zn.current=!1},180))},[Be,u,E,Va,x,f,ge,e==null?void 0:e.id]),l.useEffect(()=>{if(!e)return;const i=Date.parse(e.startedAt)+E;let p=0,y=Number.POSITIVE_INFINITY;e.steps.forEach((I,F)=>{const $=Date.parse(I.startedAt),pe=Date.parse(I.endedAt??I.startedAt);if(i>=$&&i<=pe){p=F,y=0;return}const Se=Math.min(Math.abs(i-$),Math.abs(i-pe));Se<y&&(y=Se,p=F)}),[p,p-1,p+1].filter(I=>I>=0&&I<e.steps.length).forEach(I=>{const F=e.steps[I];F&&ls(e.id,F.id,ee)})},[e,E,ee]),l.useEffect(()=>{if(!e||!Wn)return;const a=`${e.id}:${Ot}:${(B==null?void 0:B.id)??"none"}:${ee?"safe":"raw"}:${Wn}`;if(vr.current===a)return;vr.current=a;const i=window.setTimeout(()=>{fa.forEach(p=>{ls(e.id,p,ee)}),Ot==="compare"&&B&&fa.forEach(p=>{ls(B.id,p,ee)}),Ot==="flow"?dt(()=>import("./index-C18ZUr6w.js"),__vite__mapDeps([0,1,2,3])):Ot==="matrix"?dt(()=>import("./index-D1nEiSPm.js"),__vite__mapDeps([6,1,2,3])):Ot==="compare"&&B?dt(()=>import("./index-CpbCZ8DM.js"),__vite__mapDeps([4,1,2,3])):Ot==="gameplay"&&dt(()=>import("./index-Cm6o9e9V.js"),__vite__mapDeps([7,1,2,3]))},160);return()=>window.clearTimeout(i)},[B,Ot,fa,Wn,ee,e]),l.useEffect(()=>{if(!e||!Be||u!=="cinema"&&u!=="compare")return;const a=(B==null?void 0:B.metadata.wallTimeMs)??0,i=u==="compare"?Math.max(e.metadata.wallTimeMs||1,a||1):e.metadata.wallTimeMs||1;let p=0,y=performance.now();const k=I=>{const F=(I-y)*Ne;y=I,se($=>{const pe=$+F;return pe>=i?(je(!1),i):pe}),p=requestAnimationFrame(k)};return p=requestAnimationFrame(k),()=>cancelAnimationFrame(p)},[e,B,Be,Ne,u]),l.useEffect(()=>{const a=JSON.stringify(La),i=JSON.stringify(Dt);a!==i&&Fa(Dt)},[Dt,Fa,La]);const fl=l.useCallback((a,i)=>{Fa(p=>yc(p,a,i)),A("ux.settings.shortcut.updated",{shortcut:a,key:i.toLowerCase()})},[Fa,A]);l.useEffect(()=>{const a=i=>{var F;const p=$=>!i.metaKey&&!i.ctrlKey&&!i.altKey&&i.key.toLowerCase()===Dt[$],y=i.target,k=(F=y==null?void 0:y.tagName)==null?void 0:F.toLowerCase();if(!(k==="input"||k==="textarea"||k==="select"||y!=null&&y.isContentEditable)){if((i.metaKey||i.ctrlKey)&&i.key.toLowerCase()==="k"){i.preventDefault(),mt($=>!$);return}if(i.key==="?"||i.key==="/"&&i.shiftKey){i.preventDefault(),pt(!0);return}if(p("toggleStory")){i.preventDefault(),xa();return}if(p("toggleExplain")){i.preventDefault(),Qe($=>!$);return}if(p("startTour")){i.preventDefault(),Ie(!0);return}if(i.key==="Escape"){if(bn){Ie(!1),Gt(!0);return}pt(!1),mt(!1),Y(null);return}if(i.key===" "){i.preventDefault(),(u==="cinema"||u==="compare")&&je($=>!$);return}if(p("toggleFlow")){i.preventDefault(),u==="flow"?f("cinema"):u==="cinema"&&H("flow");return}if(p("toggleCinema")){i.preventDefault(),u!=="cinema"&&f("cinema");return}if(p("toggleGameplay")){i.preventDefault(),H("gameplay");return}if(p("toggleInspector")){i.preventDefault(),x?Y(null):e!=null&&e.steps.length&&Y(e.steps[0].id);return}if(i.key==="ArrowLeft"||i.key==="ArrowRight"){if(i.preventDefault(),!e)return;const $=e.metadata.wallTimeMs||1;if(i.shiftKey){se(i.key==="ArrowLeft"?0:$),je(!1),f("cinema");return}const pe=i.key==="ArrowRight"?1:-1,Se=Ud(Cr,E,pe);Se!=null&&(se(Se),je(!1),f("cinema"))}}};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[u,Dt,x,e,E,Cr,H,f,Qe,mt,Ie,Gt,bn,xa]),l.useEffect(()=>{if(!W||oe!=="triage"&&oe!=="diagnose")return;const a=p=>{const y=p;if(!y)return!1;const k=y.tagName;return k==="INPUT"||k==="TEXTAREA"||k==="SELECT"||y.isContentEditable},i=p=>{if(a(p.target)||p.metaKey||p.ctrlKey||p.altKey)return;const F=(oe==="triage"?{1:"triage-observe-incident",2:"triage-isolate-cause",3:"triage-validate-fix",4:"triage-share-handoff"}:{1:"diagnose-observe-baseline",2:"diagnose-isolate-cause",3:"diagnose-validate-hypothesis",4:"diagnose-share-findings"})[p.key];F&&(p.preventDefault(),wr.current(F),xt(oe==="triage"?`Triage step ${p.key} executed.`:`Diagnose step ${p.key} executed.`))};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[oe,W,xt]);const Ar=l.useMemo(()=>{if(!e||!Oe||S)return null;const a=e.metadata.wallTimeMs||1,i=Math.min(Math.max(an,5e3),a);let p=Math.max(0,E-i/2);const y=Math.min(a,p+i);return y-p<i&&(p=Math.max(0,y-i)),{startMs:p,endMs:y}},[e,Oe,E,S,an]),na=!!(ue!=null&&ue.active),$r=(ue==null?void 0:ue.step)??0,gl=((Gr=Da[$r])==null?void 0:Gr.label)??"Wrapping up",bl=Da.length,yl=S!==R,xl=`${Math.min(ot.length,ha)}/${ot.length}`,Ft=l.useMemo(()=>me==="evaluate"?[{id:"evaluate-health",label:"Review run health",done:kt>=80,hint:"Check run score and summary."},{id:"evaluate-risk",label:"Inspect top risk",done:!!x,hint:"Open the highest-risk step."},{id:"evaluate-share",label:"Share handoff digest",done:!!st,hint:"Send a concise handoff update."}]:me==="operate"?[{id:"operate-failure",label:"Open failed step",done:!!x,hint:"Focus on the failing step first."},{id:"operate-replay",label:"Run replay",done:!!B,hint:"Validate with a replay compare run."},{id:"operate-support",label:"Use support diagnostics",done:Dn||!!pa.trim(),hint:"Capture guided recovery diagnostics."}]:[{id:"investigate-flow",label:"Open flow graph",done:u==="flow",hint:"Switch to flow mode for graph context."},{id:"investigate-matrix",label:"Run matrix scenario",done:!!_e,hint:"Launch one what-if scenario."},{id:"investigate-save",label:"Save a reusable view",done:et.length>0,hint:"Save this setup for the next run."}],[B,st,u,me,_e,kt,et.length,x,pa,Dn]),Pr=Ft.filter(a=>a.done).length>=Ft.length,sa=l.useMemo(()=>{var a;return((a=Ge[0])==null?void 0:a.kind)??(at===null?"no_success_yet":"none")},[Ge,at]),Yn=l.useMemo(()=>me==="evaluate"?{label:"Open top risk",run:()=>{g("analysis"),Ue(),e!=null&&e.steps.some(a=>a.status==="failed")||Ce()}}:me==="operate"?{label:"Open incident triage",run:()=>{g("analysis"),Ue(),e!=null&&e.steps.some(a=>a.status==="failed")||Ce()}}:{label:"Open flow mode",run:()=>{g("analysis"),H("flow")}},[H,Ce,Ue,me,g,e==null?void 0:e.steps]),vl=l.useMemo(()=>Ft.map(a=>({label:a.label,done:a.done})),[Ft]),wl=l.useCallback(()=>{Yn.run(),Me==="skipped"&&tt("active")},[Yn,Me,tt]),jl=l.useCallback(()=>{tt("active"),Te("journey.onboarding.exit",{source:"start_first_win",path:me,traceId:(e==null?void 0:e.id)??Z??null,sessionId:we.current})},[Z,me,tt,e==null?void 0:e.id,Te]),kl=l.useCallback(()=>{tt("skipped"),Te("journey.onboarding.exit",{source:"skip_safely",path:me,traceId:(e==null?void 0:e.id)??Z??null,sessionId:we.current}),Ve(`session:onboarding-abandon:skip:${me}`,"journey.onboarding.abandon",{reason:"skip_for_now",friction:sa,path:me,stage:Me,traceId:(e==null?void 0:e.id)??Z??null,sessionId:we.current})},[Z,sa,me,Me,tt,e==null?void 0:e.id,Te,Ve]),Xn=l.useCallback(()=>{tt("select"),Te("journey.onboarding.exit",{source:"start_over",path:me,traceId:(e==null?void 0:e.id)??Z??null,sessionId:we.current})},[Z,me,tt,e==null?void 0:e.id,Te]);l.useEffect(()=>{W&&Me==="active"&&Pr&&(tt("completed"),Te("journey.onboarding.exit",{source:"first_win_complete",path:me,traceId:(e==null?void 0:e.id)??Z??null,sessionId:we.current}))},[Z,Pr,me,Me,W,tt,e==null?void 0:e.id,Te]),l.useEffect(()=>{if(!W||Me==="select"||Me==="skipped")return;const a=Ft.find(i=>i.done);a&&Ve(`session:onboarding-first-value:${me}`,"journey.onboarding.first_value",{path:me,stepId:a.id,traceId:(e==null?void 0:e.id)??Z??null,sessionId:we.current})},[Z,me,Me,Ft,W,e==null?void 0:e.id,Ve]),l.useEffect(()=>{if(!W)return;const a=()=>{Me==="completed"||Me==="skipped"||Ve(`session:onboarding-abandon:pagehide:${me}`,"journey.onboarding.abandon",{reason:"session_exit",friction:sa,path:me,stage:Me,traceId:(e==null?void 0:e.id)??Z??null,sessionId:we.current})};return window.addEventListener("pagehide",a),()=>window.removeEventListener("pagehide",a)},[Z,sa,me,Me,W,e==null?void 0:e.id,Ve]);const Lr=l.useCallback((a,i,p,y={})=>{const k=new Date().toISOString();nr(I=>({...I,[a]:{id:i,label:p,at:k}})),sr(I=>[{id:`${a}-${i}-${k}`,route:a,label:p,at:k},...I].slice(0,24)),A("ux.route.checkpoint",{route:a,actionId:i,label:p,traceId:(e==null?void 0:e.id)??null,sessionId:we.current,...y})},[sr,nr,e==null?void 0:e.id,A]),Fr=l.useCallback((a,i)=>{const p=new Date().toISOString(),y={id:`${a}-${p}`,route:a,summary:i,at:p};return rr(k=>[y,...k].slice(0,20)),y},[rr]),Zn=l.useMemo(()=>[...vt.map(a=>({id:a.id,source:"async",label:a.label,status:a.status==="idle"?"queued":a.status,detail:a.detail,updatedAt:a.updatedAt,retryable:!!a.retryable,resumable:!!a.resumable})),...Yt.map(a=>({id:a.id,source:"export",status:a.status==="queued"?"queued":a.status,label:a.label,detail:a.detail,updatedAt:a.updatedAt,retryable:a.retryable,resumable:!1}))].sort((a,i)=>i.updatedAt-a.updatedAt).slice(0,16),[vt,Yt]),Sl=l.useMemo(()=>({overview:{completed:[kt>=80,!!x,!!st].filter(Boolean).length,total:3},triage:{completed:[!!x,u==="flow",!!B||u==="matrix",!!st].filter(Boolean).length,total:4},diagnose:{completed:[u==="cinema",u==="flow",!!_e,!!Yt.length].filter(Boolean).length,total:4},coordinate:{completed:[!!wt.trim(),!!jt.trim(),!!Qt,!!Ln.length].filter(Boolean).length,total:4},settings:{completed:[ee,Tt,Oe,ie.setupWizardV1||ie.supportPanelV1].filter(Boolean).length,total:4}}),[B,Yt.length,ie.setupWizardV1,ie.supportPanelV1,Tt,jt,st,u,_e,Ln.length,kt,wt,ee,x,Qt,Oe]);l.useEffect(()=>{W&&(jr.current=typeof performance<"u"?performance.now():Date.now(),xt(`Opened ${It[oe]} route.`),A("ux.route.entered",{route:oe,traceId:(e==null?void 0:e.id)??null,sessionId:we.current}))},[oe,W,xt,e==null?void 0:e.id,A]),l.useEffect(()=>{if(!W||!j)return;const a=`${oe}:${(e==null?void 0:e.id)??"none"}`;if(kr.current===a)return;kr.current=a;const i=typeof performance<"u"?performance.now():Date.now(),p=ku(oe,i-jr.current);A("ux.route.perf_budget",{route:p.route,durationMs:p.durationMs,budgetMs:p.budgetMs,overBudgetByMs:p.overBudgetByMs,withinBudget:p.withinBudget,traceId:(e==null?void 0:e.id)??null}),p.withinBudget||X(`${It[p.route]} route exceeded budget by ${p.overBudgetByMs}ms.`,"warning")},[X,oe,W,e==null?void 0:e.id,A,j]),l.useEffect(()=>{if(!W)return;const a=Zn.find(y=>y.status==="error"||y.status==="success"||y.status==="running");if(!a)return;const i=`${a.id}:${a.status}:${a.updatedAt}`;if(Sr.current===i)return;Sr.current=i;const p=a.status==="error"?"failed and needs attention":a.status==="success"?"completed successfully":"is running";xt(`${a.label} ${p}.`)},[Zn,W,xt]);const Le=l.useCallback(async a=>{if(!W)return;const i=oe,p=(y,k={})=>Lr(i,a,y,k);switch(a){case"overview-review-health":g("journey"),p("Review run health");return;case"overview-inspect-risk":g("analysis"),Ue(),e!=null&&e.steps.some(y=>y.status==="failed")||Ce(),p("Inspect top risk");return;case"overview-share-handoff":await Mt(),p("Share handoff digest");return;case"triage-observe-incident":g("analysis"),Ue(),e!=null&&e.steps.some(y=>y.status==="failed")||Ce(),p("Observe the incident");return;case"triage-isolate-cause":g("analysis"),H("flow"),p("Isolate the cause");return;case"triage-validate-fix":g("analysis"),H(B?"compare":"matrix"),p("Validate the fix");return;case"triage-share-handoff":await Mt(),p("Share the handoff");return;case"triage-open-support":Lt("triage_route"),p("Open support diagnostics",{source:"triage_route"});return;case"diagnose-observe-baseline":g("analysis"),H("cinema"),p("Observe baseline");return;case"diagnose-isolate-cause":g("analysis"),H("flow"),p("Isolate causal chain");return;case"diagnose-validate-hypothesis":g("analysis"),H("matrix"),p("Validate hypothesis");return;case"diagnose-share-findings":aa(),p("Share findings");return;case"coordinate-share-live":await Nt(),p("Share live context");return;case"coordinate-copy-handoff":await Mt(),p("Copy handoff digest");return;case"coordinate-capture-snapshot":{const y=`${i.toUpperCase()} snapshot • mode=${u} • step=${x??"none"} • trace=${(e==null?void 0:e.id)??"unknown"}`,k=Fr(i,y);X("Captured handoff snapshot.","success"),p("Capture handoff snapshot",{snapshotId:k.id});return}default:return}},[X,Fr,B,Mt,aa,H,Ce,Ue,u,Lt,Lr,oe,W,x,g,Nt,e]);l.useEffect(()=>{wr.current=Le},[Le]);const Br=l.useMemo(()=>W?oe==="overview"?[{id:"route-overview-review-health",label:"Route: review run health",description:"Checkpoint 1 for Overview route.",group:"Route",onTrigger:()=>void Le("overview-review-health")},{id:"route-overview-inspect-risk",label:"Route: inspect top risk",description:"Checkpoint 2 for Overview route.",group:"Route",onTrigger:()=>void Le("overview-inspect-risk")}]:oe==="triage"?[{id:"route-triage-observe",label:"Route: observe incident",description:"Checkpoint 1 for Triage route.",group:"Route",onTrigger:()=>void Le("triage-observe-incident")},{id:"route-triage-isolate",label:"Route: isolate cause",description:"Checkpoint 2 for Triage route.",group:"Route",onTrigger:()=>void Le("triage-isolate-cause")},{id:"route-triage-validate",label:"Route: validate fix",description:"Checkpoint 3 for Triage route.",group:"Route",onTrigger:()=>void Le("triage-validate-fix")}]:oe==="diagnose"?[{id:"route-diagnose-observe",label:"Route: observe baseline",description:"Checkpoint 1 for Diagnose route.",group:"Route",onTrigger:()=>void Le("diagnose-observe-baseline")},{id:"route-diagnose-isolate",label:"Route: isolate causal chain",description:"Checkpoint 2 for Diagnose route.",group:"Route",onTrigger:()=>void Le("diagnose-isolate-cause")},{id:"route-diagnose-validate",label:"Route: validate hypothesis",description:"Checkpoint 3 for Diagnose route.",group:"Route",onTrigger:()=>void Le("diagnose-validate-hypothesis")}]:oe==="coordinate"?[{id:"route-coordinate-share",label:"Route: share live context",description:"Checkpoint 1 for Coordinate route.",group:"Route",onTrigger:()=>void Le("coordinate-share-live")},{id:"route-coordinate-snapshot",label:"Route: capture snapshot",description:"Checkpoint 2 for Coordinate route.",group:"Route",onTrigger:()=>void Le("coordinate-capture-snapshot")}]:[]:[],[oe,W,Le]),es=l.useMemo(()=>[...Br,{id:"macro-rapid-triage",label:"Run rapid triage launch path",description:"Jump to the highest-risk step and start mitigation.",group:"Macros",onTrigger:()=>{ya("rapid_triage")}},{id:"macro-deep-diagnosis",label:"Run deep diagnosis launch path",description:"Open flow analysis with optional guidance.",group:"Macros",onTrigger:()=>{ya("deep_diagnosis")}},{id:"macro-team-sync",label:"Run team sync launch path",description:"Enable sync mode and generate shareable context.",group:"Macros",onTrigger:()=>{ya("team_sync")}},{id:"story-toggle",label:na?"Stop story mode":"Start story mode",description:"Auto-runs a cinematic walkthrough.",group:"Story",keys:"S",onTrigger:xa},{id:"tour-start",label:"Help me around",description:"Open the optional guided tour.",group:"Onboarding",keys:"T",onTrigger:()=>Ie(!0)},{id:"onboarding-start-over",label:"Start over onboarding",description:"Reset first-run setup and choose a path again.",group:"Onboarding",onTrigger:Xn},{id:"explain-toggle",label:Ke?"Disable explain mode":"Enable explain mode",description:"Toggle contextual overlays.",group:"Onboarding",keys:"E",onTrigger:()=>Qe(a=>!a)},{id:"shortcuts",label:"Show shortcuts",description:"Open the keyboard map.",group:"Onboarding",keys:"?",onTrigger:()=>pt(!0)},{id:"playback-toggle",label:Be?"Pause playback":"Play playback",description:"Start or stop the run.",group:"Playback",keys:"Space",onTrigger:Jn},{id:"mode-cinema",label:"Switch to Cinema",description:"Timeline playback view.",group:"Modes",keys:"C",onTrigger:()=>H("cinema")},{id:"mode-flow",label:"Switch to Flow",description:"Graph dependency view.",group:"Modes",keys:"F",onTrigger:()=>H("flow")},{id:"mode-compare",label:"Open Compare",description:"Side-by-side diff view.",group:"Modes",onTrigger:()=>H("compare"),disabled:!B},{id:"mode-matrix",label:"Open Matrix",description:"Counterfactual replay matrix view.",group:"Modes",onTrigger:()=>H("matrix")},{id:"mode-gameplay",label:"Open Gameplay",description:"World-class gameplay mechanics control center.",group:"Modes",keys:"G",onTrigger:()=>H("gameplay")},{id:"jump-bottleneck",label:"Jump to bottleneck",description:"Select the slowest step.",group:"Navigation",onTrigger:Ce},{id:"jump-error",label:"Jump to error",description:"Select the first failed step.",group:"Navigation",onTrigger:Ue},{id:"replay-step",label:"Replay from selected step",description:"Branch a Director’s Cut.",group:"Tools",onTrigger:()=>x&&lt(x),disabled:!x},{id:"overlay-toggle",label:ia?"Hide overlay":"Show overlay",description:"Ghost diff in Cinema/Flow.",group:"Tools",onTrigger:()=>qe(a=>!a),disabled:!B},{id:"safe-export",label:ee?"Disable safe export":"Enable safe export",description:"Redact sensitive payloads.",group:"Safety",onTrigger:wa},{id:"reload",label:"Reload traces",description:"Refresh trace data.",group:"Meta",onTrigger:o},{id:"handoff-digest",label:"Copy handoff digest",description:"Capture mode, risk summary, and next actions for teammates.",group:"Meta",keys:"H",onTrigger:()=>{Mt()}},{id:"section-journey",label:"Open journey workspace",description:"Show journey presets and persona progression.",group:"Workspace",onTrigger:()=>g("journey")},{id:"section-analysis",label:"Open analysis workspace",description:"Show async action health and export queue.",group:"Workspace",onTrigger:()=>g("analysis")},{id:"section-collaboration",label:"Open collaboration workspace",description:"Ownership, handoff, and activity timeline.",group:"Workspace",onTrigger:()=>g("collaboration")},{id:"section-operations",label:"Open operations workspace",description:"Setup, support, and feature flags.",group:"Workspace",onTrigger:()=>g("operations")},{id:"open-setup-wizard",label:"Open setup wizard",description:"Connect source, import context, and invite teammates.",group:"Workspace",onTrigger:()=>{ht(!0),A("ux.setup.opened",{source:"command_palette"})},disabled:!ie.setupWizardV1},{id:"open-support-panel",label:"Open support diagnostics",description:"Collect support payload and copy handoff diagnostics.",group:"Workspace",onTrigger:()=>{Lt("command_palette")},disabled:!ie.supportPanelV1||W},...et.slice(0,5).map(a=>({id:`saved-view-${a.id}`,label:`Apply saved view: ${a.name}`,description:"Restore a saved journey configuration.",group:"Workspace",onTrigger:()=>Qn(a.id)}))],[Qn,Mt,ie.setupWizardV1,ie.supportPanelV1,Lt,Br,W,na,xa,Ke,Be,Jn,H,B,Ce,Ue,x,lt,ia,ee,o,Qe,qe,pt,ht,Ie,g,et,ya,Xn,wa,A]),Nl=l.useMemo(()=>{if(!W)return es;const a=i=>{switch(i){case"Route":return"Current route";case"Mode":return"View";case"Tools":case"Workspace":return"Workflows";case"Safety":return"Trust";case"Meta":return"System";default:return i??"Workflows"}};return es.map(i=>({...i,group:a(i.group)}))},[es,W]),Cl=l.useCallback(()=>{$e(`tutorial_skip:intro:${(e==null?void 0:e.id)||Z||he.seed}`,"funnel.tutorial_skip",{traceId:(e==null?void 0:e.id)||Z||"unknown",source:"intro_overlay"}),Te("journey.onboarding.exit",{source:"skip_intro",persona:ve,launchPath:Ye,traceId:(e==null?void 0:e.id)??Z??null,sessionId:we.current}),Ta(!0)},[$e,he.seed,Z,ve,Ye,Ta,e==null?void 0:e.id,Te]),Ml=l.useCallback(()=>{Te("journey.onboarding.exit",{source:"start_guided_tour",persona:ve,launchPath:Ye,traceId:(e==null?void 0:e.id)??Z??null,sessionId:we.current}),Ta(!0),Ie(!0)},[Z,ve,Ye,Ta,Ie,e==null?void 0:e.id,Te]),El=l.useCallback(()=>{$e(`tutorial_skip:tour:${(e==null?void 0:e.id)||Z||he.seed}`,"funnel.tutorial_skip",{traceId:(e==null?void 0:e.id)||Z||"unknown",source:"guided_tour"}),Te("journey.onboarding.exit",{source:"guided_tour_skip",persona:ve,launchPath:Ye,traceId:(e==null?void 0:e.id)??Z??null,sessionId:we.current}),Ve(`session:onboarding-abandon:guided-tour:${me}`,"journey.onboarding.abandon",{reason:"guided_tour_skip",friction:sa,path:me,stage:Me,traceId:(e==null?void 0:e.id)??Z??null,sessionId:we.current}),Ie(!1),Gt(!0)},[$e,he.seed,Z,ve,Ye,sa,me,Me,Gt,e==null?void 0:e.id,Te,Ve]),Il=l.useCallback(()=>{$e(`tutorial_complete:${(e==null?void 0:e.id)||Z||he.seed}`,"funnel.tutorial_complete",{traceId:(e==null?void 0:e.id)||Z||"unknown"}),Te("journey.onboarding.exit",{source:"guided_tour_complete",persona:ve,launchPath:Ye,traceId:(e==null?void 0:e.id)??Z??null,sessionId:we.current}),Ie(!1),Gt(!0)},[$e,he.seed,Z,ve,Ye,Gt,e==null?void 0:e.id,Te]),qr=t.jsxs("div",{className:"palette support-panel",children:[t.jsxs("div",{className:"palette-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"palette-title",children:"Support diagnostics"}),t.jsx("div",{className:"palette-subtitle",children:"Capture environment, friction signals, and handoff payload for rapid triage."})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Qs(!1),children:"Close"})]}),t.jsxs("div",{className:"support-guided-recovery",children:[t.jsx("strong",{children:"Guided recovery context"}),t.jsx("p",{children:Ge.length?`Latest signal: ${(Ur=Ge[0])==null?void 0:Ur.kind.replace("_"," ")}. ${(Hr=Ge[0])==null?void 0:Hr.detail}`:"No explicit friction signal detected. This panel still captures full context for proactive support."}),t.jsxs("p",{children:["Time to first success:"," ",at===null?"not yet recorded in this session":`${at}ms`]})]}),t.jsxs("label",{children:["Support note",t.jsx("textarea",{className:"search-input",value:pa,onChange:a=>Ys(a.target.value),rows:3,placeholder:"Describe the issue, reproduction path, expected behavior, and where the user got stuck."})]}),t.jsx("pre",{className:"support-diagnostics-preview",children:JSON.stringify(Ja,null,2)}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>void ml(),children:"Copy diagnostics payload"}),t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer",children:"Open help"})]})]});if(s)return t.jsx(is,{variant:"loading",title:"Loading trace...",message:"Preparing timeline, graph, and replay context."});if(!r&&!e&&d.length===0)return t.jsx(is,{variant:"empty",title:"No traces yet",message:"Ingest your first trace, then reload to begin the Observe → Inspect → Direct workflow.",actions:[{id:"retry",label:"Retry",node:t.jsx("button",{className:"primary-button",type:"button",onClick:o,children:"Retry"})},{id:"help",label:"Open help",node:t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer",children:"Open help"})}]});if(r||!e)return t.jsx(is,{variant:"error",title:"Trace load failed",message:r??"Failed to load trace.",actions:[{id:"retry",label:"Retry",node:t.jsx("button",{className:"primary-button",type:"button",onClick:o,children:"Retry"})},{id:"help",label:"Open help",node:t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer",children:"Open help"})}]});const ts=Qu[h],_l=!!(O.trim()||P||J||be||Re),as=(()=>{switch(h){case"journey":return{label:"Save current view",onClick:()=>Kn(),disabled:!!$t};case"analysis":return{label:"Queue narrative export",onClick:()=>aa(),disabled:!e||!ie.exportCenterV1};case"collaboration":return{label:"Share live link",onClick:()=>{Nt()},disabled:!ie.ownershipPanelV1};case"operations":default:return{label:te("open_setup_wizard"),onClick:()=>{ht(!0),A("ux.setup.opened",{source:"workspace_primary"})},disabled:!ie.setupWizardV1}}})(),Tl=Yu[u],Rl=Ca==="auto"?si<=980?"compact":"comfortable":Ca,Dl=`Workspace / ${W?It[oe]:ts.title} / ${Tl}`,Qa=h==="journey"?u!=="cinema"?{summary:"Switch back to timeline playback to inspect sequence order before you save or share.",label:"Open timeline playback",onClick:()=>H("cinema"),disabled:!1}:{summary:"Save this viewpoint so you can return to the exact context during handoff.",label:"Save current view",onClick:()=>Kn(),disabled:!!$t}:h==="analysis"?u!=="flow"?{summary:"Open the flow graph to inspect causal edges before running deeper diagnostics.",label:"Open flow graph",onClick:()=>H("flow"),disabled:!1}:{summary:"Queue a director narrative so root-cause evidence is ready for reporting.",label:"Queue narrative export",onClick:()=>aa(),disabled:!ie.exportCenterV1}:h==="collaboration"?ge?{summary:"Share a live session link so responders open this exact context immediately.",label:"Share live link",onClick:()=>{Nt()},disabled:!ie.ownershipPanelV1}:{summary:"Enable sync playback so collaborators stay aligned on the same investigation moment.",label:"Enable sync playback",onClick:()=>ne(!0),disabled:!1}:{summary:"Run setup checks before demo and release handoff to avoid surprises.",label:te("open_setup_wizard"),onClick:()=>{ht(!0),A("ux.setup.opened",{source:"workspace_next_action"})},disabled:!ie.setupWizardV1};return t.jsxs("div",{className:`app theme-${Ut} density-${Rl} ${Ke?"explain-mode":""} ${u==="compare"?"mode-compare":""} ${u==="matrix"?"mode-matrix":""} ${u==="gameplay"?"mode-gameplay":""} ${W?"route-shell-enabled":""}`,children:[t.jsx("h1",{className:"sr-only",children:"Workspace"}),t.jsx("div",{className:"live-region",role:"status","aria-live":"polite","aria-atomic":"true",children:gi}),t.jsx(ql,{trace:e,traces:d,selectedTraceId:c,onSelectTrace:m,onReload:o,onStartTour:()=>Ie(!0),onToggleStory:xa,onOpenPalette:()=>mt(!0),onToggleExplain:()=>Qe(a=>!a),onShareSession:Nt,onCreateHandoffDigest:()=>void Mt(),onOpenSupport:()=>{Lt("header")},onThemeChange:un,onMotionChange:pn,densityMode:Ca,onDensityChange:_s,themeMode:Ut,motionMode:la,activeSessions:ua,shareStatus:Qt,handoffStatus:st,explainMode:Ke,storyActive:na,mode:u,missionCompletion:Er,runHealthScore:kt,modeHotkeys:Ri,workspaces:_o,workspaceId:Ea,onWorkspaceChange:oi,workspaceRole:Wt,onWorkspaceRoleChange:ii,sessionLabel:At.label,sessionExpired:At.expired,onRenewSession:Oi,routeShellEnabled:W}),t.jsx(Vc,{notifications:Ze.map(({id:a,message:i,level:p})=>({id:a,message:i,level:p})),onDismiss:Di}),!W&&(Ge.length>0||at===null)?t.jsxs("section",{className:"help-escalation-banner","aria-live":"polite",children:[t.jsxs("div",{className:"help-escalation-copy",children:[t.jsx("strong",{children:"Need help now?"}),t.jsx("p",{children:Ge.length>0?`Detected ${Ge.length} potential friction signal${Ge.length===1?"":"s"} in this session.`:"No successful action recorded yet in this session. Start guided recovery to avoid guesswork."})]}),t.jsxs("div",{className:"help-escalation-actions",children:[t.jsx("button",{className:"primary-button",type:"button",onClick:()=>Lt("escalation_banner"),children:"Need help now"}),t.jsx("a",{className:"ghost-button",href:"/help.html",target:"_blank",rel:"noreferrer",children:"Open quick help"})]})]}):null,ma?t.jsxs("div",{className:"undo-banner",role:"status","aria-live":"polite",children:[t.jsx("span",{children:ma.label}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{var a,i;(i=(a=xr.current)[ma.id])==null||i.call(a),An(null)},children:"Undo"})]}):null,za?t.jsx("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true","aria-label":"Confirm action",children:t.jsxs("div",{className:"palette confirm-dialog",children:[t.jsx("div",{className:"palette-header",children:t.jsxs("div",{children:[t.jsx("div",{className:"palette-title",children:za.title}),t.jsx("div",{className:"palette-subtitle",children:za.message})]})}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>On(null),children:"Cancel"}),t.jsx("button",{className:"primary-button",type:"button",onClick:()=>{var i,p;const a=za.id;A("ux.action.confirmed",{confirmationId:a}),(p=(i=Un.current)[a])==null||p.call(i),delete Un.current[a],On(null)},children:"Confirm"})]})]})}):null,hn&&ie.setupWizardV1?t.jsx("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true","aria-label":"First-run setup wizard",children:t.jsxs("div",{className:"palette setup-wizard",children:[t.jsxs("div",{className:"palette-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"palette-title",children:"First-run setup wizard"}),t.jsx("div",{className:"palette-subtitle",children:"Connect source, import context, invite teammates."})]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>ht(!1),children:"Close"})]}),t.jsxs("div",{className:"setup-stepper",children:[t.jsx("span",{className:ft==="source"?"active":"",children:"1. Source"}),t.jsx("span",{className:ft==="import"?"active":"",children:"2. Import"}),t.jsx("span",{className:ft==="invite"?"active":"",children:"3. Invite"})]}),ft==="source"?t.jsxs("div",{className:"workspace-card",children:[t.jsxs("label",{children:["Data source",t.jsxs("select",{className:"search-select",value:gt.dataSource,onChange:a=>gn(i=>({...i,dataSource:a.target.value})),children:[t.jsx("option",{value:"",children:"Select source"}),t.jsx("option",{value:"api",children:"Live API"}),t.jsx("option",{value:"file",children:"Trace file import"}),t.jsx("option",{value:"hybrid",children:"Hybrid replay baseline"})]})]}),it.dataSourceError?t.jsx("p",{className:"workspace-error",children:it.dataSourceError}):null]}):null,ft==="import"?t.jsxs("div",{className:"workspace-card",children:[t.jsxs("label",{children:["Import path or URI",t.jsx("input",{className:"search-input",value:gt.importPath,onChange:a=>gn(i=>({...i,importPath:a.target.value})),placeholder:"/data/traces/latest.json"})]}),it.importPathError?t.jsx("p",{className:"workspace-error",children:it.importPathError}):null]}):null,ft==="invite"?t.jsxs("div",{className:"workspace-card",children:[t.jsxs("label",{children:["Invite emails (comma-separated)",t.jsx("input",{className:"search-input",value:gt.inviteEmails,onChange:a=>gn(i=>({...i,inviteEmails:a.target.value})),placeholder:"ops@example.com, qa@example.com"})]}),it.inviteEmailsError?t.jsx("p",{className:"workspace-error",children:it.inviteEmailsError}):null]}):null,t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>fn(a=>a==="invite"?"import":"source"),disabled:ft==="source",children:"Back"}),ft!=="invite"?t.jsx("button",{className:"primary-button",type:"button",onClick:()=>fn(a=>a==="source"?"import":"invite"),children:"Continue"}):t.jsx("button",{className:"primary-button",type:"button",disabled:!it.isValid,onClick:pl,children:"Complete setup"})]})]})}):null,Dn&&ie.supportPanelV1?W?t.jsx("aside",{className:"support-inline-panel",role:"complementary","aria-label":"Support diagnostics",children:qr}):t.jsx("div",{className:"modal-backdrop",role:"dialog","aria-modal":"true","aria-label":"Support diagnostics",children:qr}):null,W?t.jsx(Hc,{stage:Me,path:me,steps:Ft,explainEnabled:Ke,recommendedActionLabel:Yn.label,onPathChange:ai,onStart:jl,onSkipSafely:kl,onStartOver:Xn,onStartTour:()=>Ie(!0),onToggleExplain:()=>Qe(a=>!a),onRecommendedAction:wl}):null,!W&&!Jt&&!_a?t.jsx(Pc,{onComplete:Cl,onStartTour:Ml,onStartStory:ta,persona:ve,onPersonaChange:cn,launchPath:Ye,onLaunchPathChange:dn,onStartLaunchPath:a=>void ya(a)}):null,!W&&Jt&&!rn?t.jsx(Lc,{explainMode:Ke,storyActive:na,onStartTour:()=>{on(!0),Ie(!0)},onStartStory:()=>{on(!0),ta()},onToggleExplain:()=>Qe(a=>!a),onDismiss:()=>on(!0)}):null,t.jsx(Dc,{steps:ll,open:bn,onClose:El,onComplete:Il}),t.jsx(Oc,{enabled:Ke&&(!W||Me!=="select")}),t.jsx(Wc,{active:na,label:gl,step:$r,total:bl,onStop:Ct,onRestart:ta}),t.jsx(zl,{insights:n,investigation:D,onSelectStep:a=>{Y(a),u!=="cinema"&&f("cinema")},onJumpToError:Ue,onJumpToBottleneck:Ce}),W?null:t.jsx(Cc,{trace:e,mode:u==="matrix"||u==="gameplay"?"cinema":u,playheadMs:E,selectedStepId:x,compareTrace:B,collapsed:Zo,onToggleCollapsed:()=>ei(a=>!a),onModeChange:H,onSelectStep:a=>{Y(a),u!=="cinema"&&f("cinema")},onJumpToBottleneck:Ce,onReplay:lt,onStartTour:()=>Ie(!0),priorityQueue:dl}),t.jsx("nav",{className:`workspace-nav ${W?"route-shell":""}`,"aria-label":"Workspace navigation",children:W?t.jsxs(t.Fragment,{children:[t.jsx("button",{className:`ghost-button ${oe==="overview"?"active":""}`,type:"button","aria-pressed":oe==="overview","aria-label":"Review workspace route",onClick:()=>Ht("overview"),children:It.overview}),t.jsx("button",{className:`ghost-button ${oe==="triage"?"active":""}`,type:"button","aria-pressed":oe==="triage","aria-label":"Triage workspace route",onClick:()=>Ht("triage"),children:It.triage}),t.jsx("button",{className:`ghost-button ${oe==="diagnose"?"active":""}`,type:"button","aria-pressed":oe==="diagnose","aria-label":"Diagnose workspace route",onClick:()=>Ht("diagnose"),children:It.diagnose}),t.jsx("button",{className:`ghost-button ${oe==="coordinate"?"active":""}`,type:"button","aria-pressed":oe==="coordinate","aria-label":"Coordinate workspace route",onClick:()=>Ht("coordinate"),children:It.coordinate}),t.jsx("button",{className:`ghost-button ${oe==="settings"?"active":""}`,type:"button","aria-pressed":oe==="settings","aria-label":"Configure workspace route",onClick:()=>Ht("settings"),children:It.settings})]}):t.jsxs(t.Fragment,{children:[t.jsx("button",{className:`ghost-button ${h==="journey"?"active":""}`,type:"button","aria-pressed":h==="journey","aria-label":"Understand this run workspace section",onClick:()=>g("journey"),children:"Understand"}),t.jsx("button",{className:`ghost-button ${h==="analysis"?"active":""}`,type:"button","aria-pressed":h==="analysis","aria-label":"Diagnose root cause workspace section",onClick:()=>g("analysis"),children:"Diagnose"}),t.jsx("button",{className:`ghost-button ${h==="collaboration"?"active":""}`,type:"button","aria-pressed":h==="collaboration","aria-label":"Coordinate responders workspace section",onClick:()=>g("collaboration"),children:"Coordinate"}),t.jsx("button",{className:`ghost-button ${h==="operations"?"active":""}`,type:"button","aria-pressed":h==="operations","aria-label":"Configure workspace section",onClick:()=>g("operations"),children:"Configure"}),t.jsx("button",{className:`ghost-button ${u==="compare"||u==="matrix"?"active":""}`,type:"button","aria-pressed":u==="compare"||u==="matrix","aria-label":"Validate outcome intent",onClick:()=>{g("analysis"),H(B?"compare":"matrix")},children:"Validate"})]})}),t.jsxs("div",{className:"workspace-orientation","aria-live":"polite",children:[t.jsx("p",{className:"workspace-breadcrumb","aria-label":"Current location",children:Dl}),t.jsxs("div",{className:"workspace-orientation-meta",children:[t.jsxs("span",{className:"status-badge",children:["Workspace: ",Ea]}),t.jsxs("span",{className:"status-badge",children:["Role: ",Wt]})]})]}),t.jsxs("div",{className:"workspace-section-header",children:[t.jsxs("div",{className:"workspace-section-meta",children:[t.jsx("p",{className:"workspace-section-eyebrow",children:"Workspace"}),t.jsx("h2",{id:"workspace-section-title",children:ts.title}),t.jsx("p",{children:ts.description}),t.jsxs("div",{className:"workspace-next-action",children:[t.jsx("p",{className:"workspace-next-action-eyebrow",children:"Next best action"}),t.jsx("p",{className:"workspace-next-action-summary",children:Qa.summary}),t.jsx("button",{className:"ghost-button",type:"button",onClick:Qa.onClick,disabled:Qa.disabled,children:Qa.label})]}),W&&h==="analysis"?t.jsxs("div",{className:"analysis-tools-mode-switcher",role:"group","aria-label":"Analysis tools mode switcher",children:[t.jsx("button",{className:`ghost-button ${u==="cinema"?"active":""}`,type:"button","aria-pressed":u==="cinema",onClick:()=>H("cinema"),children:te("mode_cinema")}),t.jsx("button",{className:`ghost-button ${u==="flow"?"active":""}`,type:"button","aria-pressed":u==="flow",onClick:()=>H("flow"),children:te("mode_flow")}),t.jsx("button",{className:`ghost-button ${u==="compare"?"active":""}`,type:"button","aria-pressed":u==="compare",onClick:()=>H("compare"),disabled:!B,children:te("mode_compare")}),t.jsx("button",{className:`ghost-button ${u==="matrix"?"active":""}`,type:"button","aria-pressed":u==="matrix",onClick:()=>H("matrix"),children:te("mode_matrix")}),t.jsx("button",{className:`ghost-button ${u==="gameplay"?"active":""}`,type:"button","aria-pressed":u==="gameplay",onClick:()=>H("gameplay"),children:te("mode_gameplay")})]}):null]}),t.jsxs("div",{className:"workspace-section-actions",children:[t.jsx("button",{className:"primary-button workspace-primary-button",type:"button",onClick:as.onClick,disabled:as.disabled,children:as.label}),t.jsxs("div",{className:"workspace-secondary-actions",ref:or,children:[t.jsx("button",{className:`ghost-button ${v?"active":""}`,type:"button",onClick:()=>w(a=>!a),"aria-expanded":v,"aria-controls":"workspace-actions-menu",children:"More actions"}),v?t.jsxs("div",{className:"workspace-actions-menu",id:"workspace-actions-menu",role:"menu","aria-label":"Workspace secondary actions",children:[t.jsx("button",{className:"ghost-button",type:"button",role:"menuitem",onClick:()=>{b(a=>!a),w(!1)},"aria-controls":"workspace-context-panel","aria-expanded":j,children:j?"Hide workspace tools":"Show workspace tools"}),W?null:t.jsx("button",{className:"ghost-button",type:"button",role:"menuitem",onClick:()=>{Ie(!0),w(!1)},children:"Open guide"})]}):null]})]})]}),j?W?t.jsx(qu,{route:oe,status:e.status??null,runHealthScore:kt,workspaceRole:Wt,runOwner:wt,handoffOwner:jt,routeProgress:Sl[oe],lastCompletedAction:vi[oe],actionHistory:wi,snapshots:Ln,activityFeed:Ga,asyncTimeline:Zn,themeMode:Ut,motionMode:la,densityMode:Ca,appLocale:Wa,gameplayLocale:Nn,safeExport:ee,gamepadEnabled:Tt,windowed:Oe,rolloutCohort:Ma,featureFlags:ie,onRouteAction:a=>{Le(a)},onRetryAsyncAction:_r,onResumeAsyncAction:Tr,onRetryExportTask:a=>{var i,p;A("ux.export.retried",{taskId:a}),(p=(i=Gn.current)[a])==null||p.call(i)},onRunOwnerChange:Xs,onHandoffOwnerChange:Zs,onThemeModeChange:un,onMotionModeChange:pn,onDensityModeChange:_s,onAppLocaleChange:Us,onGameplayLocaleChange:Cn,onToggleSafeExport:wa,onToggleGamepadEnabled:()=>Mn(a=>!a),onToggleWindowed:()=>We(a=>!a),onRolloutCohortChange:ni,onToggleFeatureFlag:va}):t.jsxs("section",{className:"workspace-context-panel",id:"workspace-context-panel","aria-labelledby":"workspace-section-title",children:[h==="journey"?t.jsxs("div",{className:"workspace-context-grid",children:[t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Track persona progress"}),t.jsx("p",{children:ve==="executive"?"Executive mission path":ve==="operator"?"Operator mission path":"Builder mission path"}),t.jsx("div",{className:"workspace-checklist",children:vl.map(a=>t.jsxs("div",{className:`workspace-check ${a.done?"done":""}`,children:[t.jsx("span",{children:a.done?"✓":"○"}),t.jsx("span",{children:a.label})]},a.label))})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Save and restore views"}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("input",{className:"search-input",placeholder:"Saved view name",value:Rt,onChange:a=>Ks(a.target.value),"aria-label":"Saved view name"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:Kn,disabled:!!$t,children:"Save view"})]}),$t&&Rt.trim()?t.jsx("p",{className:"workspace-error",children:$t}):null,t.jsxs("div",{className:"workspace-inline-form",children:[t.jsxs("select",{className:"search-select",value:rt,onChange:a=>qa(a.target.value),"aria-label":"Saved views",children:[t.jsx("option",{value:"",children:"Select saved view"}),et.map(a=>t.jsx("option",{value:a.id,children:a.name},a.id))]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>rt&&Qn(rt),disabled:!rt,children:"Apply"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:hl,disabled:!rt,children:"Delete"})]})]})]}):null,h==="analysis"?t.jsxs("div",{className:"workspace-context-grid",children:[t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Track async actions"}),vt.length===0?t.jsx("p",{children:"No tracked async actions yet."}):null,vt.map(a=>t.jsxs("div",{className:`async-action-row status-${a.status}`,"data-status":a.status,children:[t.jsxs("div",{children:[t.jsx("strong",{children:a.label}),t.jsx("p",{children:a.detail})]}),t.jsxs("div",{className:"async-action-actions",children:[a.retryable?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>_r(a.id),children:"Retry"}):null,a.resumable?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>Tr(a.id),children:"Resume"}):null]})]},a.id))]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Run exports"}),ie.exportCenterV1?null:t.jsx("p",{children:"Export center is disabled by feature flag."}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>aa(),disabled:!e||!ie.exportCenterV1,children:"Queue narrative export"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{ba({id:"export-support-diagnostics",label:"Support diagnostics JSON",run:()=>ns("agent-director-support-diagnostics.json",JSON.stringify(Ja,null,2),"application/json")})},disabled:!ie.exportCenterV1,children:"Queue diagnostics export"})]}),ie.exportCenterV1&&Yt.length===0?t.jsx("p",{children:"No exports queued."}):null,Yt.map(a=>t.jsxs("div",{className:`export-task-row status-${a.status}`,"data-status":a.status,children:[t.jsx("span",{children:a.label}),t.jsx("span",{children:a.detail}),a.retryable?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{var i,p;A("ux.export.retried",{taskId:a.id}),(p=(i=Gn.current)[a.id])==null||p.call(i)},children:"Retry"}):null]},a.id))]})]}):null,h==="collaboration"?t.jsxs("div",{className:"workspace-context-grid",children:[ie.ownershipPanelV1?null:t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Enable ownership to continue"}),t.jsx("p",{children:"Enable the ownership panel feature flag in Operations to configure handoff ownership."})]}),ie.ownershipPanelV1?t.jsxs(t.Fragment,{children:[t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Assign ownership and handoff"}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("input",{className:"search-input",value:wt,onChange:a=>Xs(a.target.value),"aria-label":"Run owner",placeholder:"Run owner"}),t.jsx("input",{className:"search-input",value:jt,onChange:a=>Zs(a.target.value),"aria-label":"Handoff owner",placeholder:"Handoff owner"})]}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void Nt(),children:"Share live link"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void Mt(),children:"Copy handoff digest"})]})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:"Review collaboration activity"}),Ga.length===0?t.jsx("p",{children:"No collaboration activity yet."}):null,t.jsx("div",{className:"workspace-feed",children:Ga.slice(0,8).map(a=>t.jsxs("div",{className:"workspace-feed-item",children:[t.jsx("span",{children:new Date(a.timestamp).toLocaleTimeString()}),t.jsx("span",{children:a.message})]},a.id))})]})]}):null]}):null,h==="operations"?t.jsxs("div",{className:"workspace-context-grid",children:[t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:te("setup_support_title")}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{ht(!0),A("ux.setup.opened",{source:"operations_panel"})},disabled:!ie.setupWizardV1,children:te("open_setup_wizard")}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{Lt("operations_panel")},disabled:!ie.supportPanelV1,children:te("open_support_panel")})]}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:ie.setupWizardV1,onChange:()=>va("setupWizardV1")}),"Enable setup wizard"]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:ie.supportPanelV1,onChange:()=>va("supportPanelV1")}),"Enable support panel"]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:ie.exportCenterV1,onChange:()=>va("exportCenterV1")}),"Enable export center"]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:ie.ownershipPanelV1,onChange:()=>va("ownershipPanelV1")}),"Enable ownership panel"]})]})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:te("telemetry_summary_title")}),t.jsx("p",{children:te("telemetry_summary_body")}),t.jsx("div",{className:"workspace-inline-form",children:t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{const a=window.localStorage.getItem("agentDirector.analytics.events.v1")??"[]";ba({id:"export-analytics-events",label:"Frontend analytics events",run:()=>ns("agent-director-frontend-events.json",a,"application/json")})},children:te("export_event_queue")})})]}),t.jsxs("article",{className:"workspace-card",children:[t.jsx("h3",{children:te("settings_center_title")}),t.jsx("p",{children:te("settings_center_body")}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:ee,onChange:wa}),te("safe_export")]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:Tt,onChange:()=>Mn(a=>!a)}),te("gamepad_enabled")]}),t.jsxs("label",{className:"toggle",children:[t.jsx("input",{type:"checkbox",checked:Oe,onChange:()=>We(a=>!a)}),te("timeline_windowing")]})]}),t.jsxs("div",{className:"workspace-inline-form",children:[t.jsxs("label",{children:[te("theme_label"),t.jsxs("select",{className:"search-select",value:Ut,onChange:a=>un(a.target.value),children:[t.jsx("option",{value:"studio",children:"Studio"}),t.jsx("option",{value:"focus",children:"Focus"}),t.jsx("option",{value:"contrast",children:"Contrast"})]})]}),t.jsxs("label",{children:[te("motion_label"),t.jsxs("select",{className:"search-select",value:la,onChange:a=>pn(a.target.value),children:[t.jsx("option",{value:"cinematic",children:"Cinematic"}),t.jsx("option",{value:"balanced",children:"Balanced"}),t.jsx("option",{value:"minimal",children:"Minimal"})]})]}),t.jsxs("label",{children:[te("app_language_label"),t.jsx("select",{className:"search-select",value:Wa,onChange:a=>Us(ko(a.target.value)),children:ou.map(a=>t.jsx("option",{value:a.value,children:a.label},a.value))})]}),t.jsxs("label",{children:[te("gameplay_locale_label"),t.jsxs("select",{className:"search-select",value:Nn,onChange:a=>Cn(a.target.value),children:[t.jsx("option",{value:"en",children:"English"}),t.jsx("option",{value:"es",children:"Espanol"})]})]})]}),t.jsx("div",{className:"workspace-feed",children:Sa.map(a=>t.jsxs("label",{className:"workspace-inline-form",children:[t.jsx("span",{children:a.label}),t.jsx("select",{className:"search-select",value:Dt[a.id],onChange:i=>fl(a.id,i.target.value),"aria-label":`${a.label} shortcut`,children:Ss.map(i=>t.jsx("option",{value:i,children:i.toUpperCase()},i))})]},a.id))})]})]}):null]}):t.jsx("p",{className:"workspace-panel-collapsed",id:"workspace-context-panel",children:"Workspace tools are hidden to reduce clutter. Use “Show workspace tools” when you need deeper controls."}),t.jsxs("section",{className:"toolbar","data-help":!0,"data-help-indicator":!0,"data-tour":"toolbar","data-help-title":"Search + filters","data-help-body":"Core controls stay visible. Open Advanced controls for TraceQL and extension diagnostics.","data-help-placement":"bottom","aria-labelledby":"workspace-toolbar-heading",children:[t.jsx("h2",{id:"workspace-toolbar-heading",className:"sr-only",children:"Controls"}),t.jsxs("div",{className:"toolbar-primary",children:[t.jsx(Ul,{query:S,typeFilter:K,onQueryChange:C,onTypeFilterChange:_}),W?null:t.jsxs("div",{className:"toolbar-mode-switcher",children:[t.jsx("button",{className:`ghost-button ${u==="cinema"?"active":""}`,type:"button","aria-pressed":u==="cinema",title:"Timeline playback",onClick:()=>H("cinema"),"data-help":!0,"data-help-title":"Cinema mode","data-help-body":"Timeline view with step cards ordered by time.","data-help-placement":"bottom",children:te("mode_cinema")}),t.jsx("button",{className:`ghost-button ${u==="flow"?"active":""}`,type:"button","aria-pressed":u==="flow",title:"Graph view",onClick:()=>H("flow"),"data-help":!0,"data-help-title":"Flow mode","data-help-body":"Dependency graph of steps and tool calls.","data-help-placement":"bottom",children:te("mode_flow")}),t.jsx("button",{className:`ghost-button ${u==="compare"?"active":""}`,type:"button","aria-pressed":u==="compare",title:B?"Side-by-side compare":"Run a replay to enable compare",onClick:()=>H("compare"),disabled:!B,"data-tour":"compare","data-help":!0,"data-help-title":"Compare mode","data-help-body":"Side-by-side view after a replay. Enabled once you replay.","data-help-placement":"bottom",children:te("mode_compare")}),t.jsx("button",{className:`ghost-button ${u==="matrix"?"active":""}`,type:"button","aria-pressed":u==="matrix",title:"Counterfactual replay matrix",onClick:()=>H("matrix"),"data-help":!0,"data-help-title":"Matrix mode","data-help-body":"Run multiple replay scenarios and rank likely causal factors.","data-help-placement":"bottom",children:te("mode_matrix")}),t.jsx("button",{className:`ghost-button ${u==="gameplay"?"active":""}`,type:"button","aria-pressed":u==="gameplay",title:"Gameplay mechanics command center",onClick:()=>H("gameplay"),"data-help":!0,"data-help-title":"Gameplay mode","data-help-body":"Command raids, campaign, pvp, time forks, boss runs, economy, and liveops.","data-help-placement":"bottom",children:te("mode_gameplay")})]})]}),t.jsxs("div",{className:"toolbar-utility",children:[t.jsxs("div",{className:"toolbar-toggle-group",children:[t.jsxs("label",{className:"toggle",title:"Redact payloads and disable raw views for safe sharing","data-help":!0,"data-help-title":"Safe export","data-help-body":"Redacts secrets and disables raw payload views for safe sharing.","data-help-placement":"bottom",children:[t.jsx("input",{type:"checkbox",checked:ee,onChange:wa}),te("safe_export")]}),e.steps.length>200||Oe?t.jsxs("label",{className:"toggle",title:"Window steps around the playhead for large traces","data-help":!0,"data-help-title":"Windowed mode","data-help-body":"Limits rendering to a playhead window for large traces.","data-help-placement":"bottom",children:[t.jsx("input",{type:"checkbox",checked:Oe,onChange:()=>We(a=>!a)}),te("windowed")]}):null,B?t.jsxs("label",{className:"toggle",title:"Show ghost overlay of replay in Cinema/Flow","data-help":!0,"data-help-title":"Overlay replay","data-help-body":"Layer the replay over the base run to spot differences.","data-help-placement":"bottom",children:[t.jsx("input",{type:"checkbox",checked:ia,onChange:()=>qe(a=>!a)}),te("overlay")]}):null,t.jsxs("label",{className:"toggle",title:"Follow active collaborator cursor and mode updates",children:[t.jsx("input",{type:"checkbox",checked:ge,onChange:()=>ne(a=>!a)}),te("sync_playback")]})]}),t.jsxs("div",{className:"toolbar-advanced-controls",children:[!N&&_l?t.jsx("span",{className:"status-badge",children:"Advanced controls active"}):null,t.jsx("button",{className:`ghost-button ${N?"active":""}`,type:"button",onClick:()=>T(a=>!a),"aria-expanded":N,"aria-controls":"advanced-toolbar-panel",children:N?"Hide advanced controls":"Show advanced controls"})]})]}),N?t.jsxs("div",{className:"toolbar-advanced-panel",id:"advanced-toolbar-panel",children:[t.jsxs("div",{className:"toolbar-advanced-group",children:[t.jsx("input",{className:"search-input",value:O,onChange:a=>q(a.target.value),placeholder:te("traceql_placeholder"),"aria-label":"TraceQL query"}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void Ai(),children:te("run_traceql")}),P?t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>{q(""),L(null),le(null)},children:te("clear_traceql")}):null]}),t.jsxs("div",{className:"toolbar-advanced-group",children:[t.jsxs("select",{className:"search-select",value:be,onChange:a=>re(a.target.value),"aria-label":"Extension selector",children:[t.jsx("option",{value:"",children:te("select_extension")}),M.map(a=>t.jsx("option",{value:a.id,children:a.name},a.id))]}),t.jsx("button",{className:"ghost-button",type:"button",onClick:()=>void $i(),disabled:!e||!be||Re,children:te(Re?"running_extension":"run_extension")})]}),t.jsxs("div",{className:"toolbar-advanced-status",children:[P?t.jsxs("span",{className:"status-badge",children:[P.matchCount," match(es)"]}):null,yl?t.jsx("span",{className:"status-badge",children:"Filtering..."}):null,t.jsxs("span",{className:"status-badge",children:["Hydration ",xl]}),t.jsxs("span",{className:"status-badge",children:["Filter ",ji,"ms"]}),J?t.jsx("span",{className:"status-badge warn",children:J}):null]})]}):null]}),Q?t.jsxs("div",{className:"inspector-section",children:[t.jsx("div",{className:"inspector-section-title",children:"Extension output"}),t.jsx("pre",{className:"inspector-json",children:JSON.stringify(Q,null,2)})]}):null,u==="cinema"?t.jsxs("div",{className:"playback-stack","data-tour":"playback",children:[t.jsx("div",{"data-help":!0,"data-help-title":"Playback controls","data-help-body":"Play, pause, scrub, and adjust speed to feel the rhythm of the run.","data-help-placement":"bottom",children:t.jsx(Yr,{playheadMs:E,wallTimeMs:e.metadata.wallTimeMs||1,isPlaying:Be,speed:Ne,onToggle:()=>je(a=>!a),onScrub:a=>se(a),onSpeedChange:De})}),t.jsx("div",{"data-help":!0,"data-help-title":"Density map","data-help-body":"Zoom into hotspots and keep long traces readable with windowing.","data-help-placement":"bottom",children:t.jsx(hc,{traceStart:e.startedAt,traceEnd:e.endedAt,steps:e.steps,playheadMs:E,windowRange:Ar,windowed:Oe,spanMs:an,onSpanChange:nn,onToggleWindowed:We,onScrub:a=>se(a),persistenceKey:e.id,laneStrategy:ke,visibleLaneGroups:Ii,remotePlayheads:_i})})]}):null,u==="compare"&&B?t.jsx("div",{"data-help":!0,"data-help-title":"Compare playback","data-help-body":"Sync both runs to evaluate improvements at identical timestamps.","data-help-placement":"bottom",children:t.jsx(Yr,{playheadMs:E,wallTimeMs:Math.max(e.metadata.wallTimeMs||1,B.metadata.wallTimeMs||1),isPlaying:Be,speed:Ne,onToggle:()=>je(a=>!a),onScrub:a=>se(a),onSpeedChange:De})}):null,t.jsxs("main",{className:`stage ${u==="compare"?"stage-compare":""} motion-fade-in`,role:"main",children:[t.jsx("div",{className:"main motion-slide-up",ref:qn,"data-help":!0,"data-help-indicator":!0,"data-tour":"stage","data-help-title":"Trace stage","data-help-body":"Every step becomes a scene. Hover or click to open deep inspection.","data-help-placement":"top",children:t.jsx(Kc,{morph:li,onComplete:cl,children:t.jsxs(l.Suspense,{fallback:t.jsx("div",{className:"loading",children:te("loading_view")}),children:[u==="cinema"?t.jsx(lc,{trace:e,steps:Nr,selectedStepId:x,onSelectStep:a=>Y(a),playheadMs:E,windowRange:Ar,timing:n==null?void 0:n.timing,ghostTrace:ia?B:null,diff:Ei,laneStrategy:ke,laneGroupsOrder:Xt.order,hiddenLaneGroups:Xt.hidden,onLaneStrategyChange:Pi,onToggleLaneGroupVisibility:Li,onMoveLaneGroup:Yi}):null,u==="flow"?t.jsx(tp,{steps:Nr,selectedStepId:x,onSelectStep:a=>Y(a),baseTrace:e,compareTrace:B,compareSteps:Mi,overlayEnabled:ia,onToggleOverlay:()=>qe(a=>!a)}):null,u==="compare"&&B?t.jsx(ap,{baseTrace:e,compareTrace:B,playheadMs:E,safeExport:ee,onExit:()=>{f("cinema"),zt(null)}}):null,u==="matrix"?t.jsx(sp,{steps:e.steps,anchorStepId:wn,onAnchorStepChange:jn,scenarios:kn,onScenarioChange:el,onDuplicateScenario:sl,onMoveScenario:rl,onAddScenario:al,onRemoveScenario:nl,onRun:Vn,onCancel:ol,onReplaceScenarios:tl,loading:ci,error:Aa,job:bt,matrix:_e,safeExport:ee,onOpenCompare:il}):null,u==="gameplay"?t.jsx(rp,{state:he,playheadMs:E,onUpdate:a=>da(i=>a(i)),session:ye,playerId:ze,sessionError:$a,onCreateSession:Fi,onQuickMatchSession:Bi,onJoinSession:qi,onLeaveSession:zi,onReconnectSession:Gi,onDispatchAction:Ui,guild:di,social:ui,onInviteFriend:Ki,onAcceptFriendInvite:Qi,locale:Nn,onLocaleChange:Cn,gamepadEnabled:Tt,onToggleGamepad:Mn,gamepadPreset:En,onGamepadPresetChange:pi,isOnline:mi,onRetryConnectivity:Dr,onCreateGuild:Hi,onJoinGuild:Wi,onScheduleGuildEvent:Vi,onCompleteGuildEvent:Ji,observability:hi,analytics:fi}):null]})})}),t.jsx(l.Suspense,{fallback:t.jsx("div",{className:"loading",children:te("loading_panel")}),children:u==="compare"||u==="matrix"||u==="gameplay"?null:Mr?t.jsx(np,{traceId:e.id,step:Mr,safeExport:ee,onClose:()=>Y(null),onReplay:lt}):t.jsx(Rc,{trace:e,mode:u,selectedStepId:x,onModeChange:H,onSelectStep:a=>Y(a),onJumpToBottleneck:Ce,onReplay:lt,recommendations:nt,persona:ve,annotations:Ti,activityFeed:Ga,onAddAnnotation:Zi,missionProgress:Ia,missionCompletion:Er,onResetMissions:Xi,narrative:Pt,onAskDirector:ul,onExportNarrative:aa})})]}),t.jsxs("div",{className:"mobile-quick-rail","aria-label":"Mobile quick actions",children:[t.jsx("button",{className:`ghost-button ${u==="cinema"?"active":""}`,type:"button",onClick:()=>H("cinema"),"aria-label":"Open timeline mode",children:"Timeline"}),t.jsx("button",{className:`ghost-button ${u==="flow"?"active":""}`,type:"button",onClick:()=>H("flow"),"aria-label":"Open flow graph mode",children:"Flow"}),t.jsx("button",{className:`ghost-button ${u==="compare"||u==="matrix"?"active":""}`,type:"button",onClick:()=>{g("analysis"),H(B?"compare":"matrix")},"aria-label":"Open validation mode",children:"Validate"})]}),t.jsx(Fc,{mode:u==="matrix"||u==="gameplay"?"cinema":u,isPlaying:Be,storyActive:na,hidden:u==="compare",open:ti,onToggleOpen:()=>ln(a=>!a),hideOnboardingActions:W,onTogglePlay:Jn,onStartStory:ta,onStopStory:Ct,onShowShortcuts:()=>pt(!0),onJumpToBottleneck:Ce}),t.jsx(Sc,{open:sn,onClose:()=>mt(!1),actions:Nl,context:{section:h,mode:u,persona:ve},onActionRun:a=>A("ux.palette.command_run",{id:a.id,group:a.group??null})}),t.jsx(vc,{open:Xo,onClose:()=>pt(!1),bindings:Dt})]})}const pp=!0;function mp(){if(typeof window>"u")return{enabled:!1,route:null};const e=new URLSearchParams(window.location.search);return{enabled:e.get(Is)==="1",route:e.get(Es)}}function hp(){const e=mp(),n=pp,s=ws(e.route??vs);return{enabled:n,activeRoute:s}}function fp(){const e=hp();return e.enabled?t.jsxs("div",{className:"route-ready-shell","data-route-shell":"enabled","data-active-route":e.activeRoute,children:[t.jsx("nav",{className:"sr-only","aria-label":"UX reboot routes",children:Tu.map(n=>t.jsx("a",{href:`/?${Es}=${n.id}&${Is}=1`,children:n.label},n.id))}),t.jsx(Ro,{})]}):t.jsx(Ro,{})}Al.createRoot(document.getElementById("root")).render(t.jsx($l.StrictMode,{children:t.jsx(fp,{})}));"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js")});export{Op as A,Fp as B,Ap as C,$p as D,Pp as E,Lp as F,Bp as G,Gp as H,Up as I,zp as J,ec as S,oc as T,Fd as a,zd as b,uc as c,Lo as d,vp as e,xp as f,pd as g,ns as h,eu as i,jp as j,tu as k,au as l,wp as m,kp as n,qp as o,Sp as p,Np as q,Mp as r,Wl as s,Ep as t,Cp as u,Ip as v,_p as w,Tp as x,Rp as y,Dp as z};
