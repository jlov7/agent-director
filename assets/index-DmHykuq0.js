import{j as o,r as l}from"./vendor-react-D4yGots9.js";import{R as J,M as K,B as Q,C as Z}from"./vendor-DClHNS3s.js";import{s as T,S as ee,b as N,a as Y,d as te}from"./index-BvIs192N.js";function se(s,t,a=200){const i=s.zoom||1,n=(0-s.x)/i-a,d=(0-s.y)/i-a,c=(t.width-s.x)/i+a,p=(t.height-s.y)/i+a;return{minX:n,minY:d,maxX:c,maxY:p}}function oe(s,t,a,i=200){if(a.width<=0||a.height<=0)return s;const n=se(t,a,i);return s.filter(d=>{const c=d.x,p=d.y,h=d.x+d.width,m=d.y+d.height;return!(h<n.minX||c>n.maxX||m<n.minY||p>n.maxY)})}function ne({layers:s,onChange:t}){return o.jsxs("div",{className:"edge-toggles",children:[o.jsxs("label",{title:"Parent/child span edges","data-help":!0,"data-help-title":"Structure edges","data-help-body":"Shows parent-child spans to reveal hierarchy.","data-help-placement":"top",children:[o.jsx("input",{type:"checkbox",checked:s.structure,onChange:a=>t({...s,structure:a.target.checked})}),"Structure"]}),o.jsxs("label",{title:"Chronological sequence edges","data-help":!0,"data-help-title":"Sequence edges","data-help-body":"Shows chronological ordering of steps.","data-help-placement":"top",children:[o.jsx("input",{type:"checkbox",checked:s.sequence,onChange:a=>t({...s,sequence:a.target.checked})}),"Sequence"]}),o.jsxs("label",{title:"Tool call I/O binding edges","data-help":!0,"data-help-title":"I/O edges","data-help-body":"Connects tool calls to their inputs and outputs.","data-help-placement":"top",children:[o.jsx("input",{type:"checkbox",checked:s.io,onChange:a=>t({...s,io:a.target.checked})}),"I/O Binding"]})]})}function ae({data:s}){var f,x,w,v;const t=s.step,a=T(t),i=s.diffStatus?`diff-${s.diffStatus}`:"",n=s.ghost?"ghost-node":"",d=t.type.replace("_"," ").toUpperCase(),c=((f=t.metrics)==null?void 0:f.tokensTotal)!=null?`${t.metrics.tokensTotal} tokens`:null,p=t.durationMs!=null?`${t.durationMs}ms`:null,h=[c,p,a].filter(Boolean).join(" · "),m=`Click to inspect or replay this step.${h?` ${h}.`:""}`;return o.jsxs("div",{className:`flow-node step-${t.type} ${i} ${n}`,"data-help":!0,"data-help-title":`${t.name} · ${d}`,"data-help-body":m,"data-help-placement":"right",children:[o.jsxs("div",{className:"flow-node-header",children:[o.jsxs("div",{className:"flow-node-title",children:[o.jsx(ee,{type:t.type}),o.jsx("span",{children:t.name})]}),o.jsx("span",{className:`status-pill status-${t.status}`,children:t.status})]}),o.jsx("div",{className:"flow-node-preview",children:((x=t.preview)==null?void 0:x.outputPreview)??((w=t.preview)==null?void 0:w.inputPreview)}),o.jsxs("div",{className:"flow-node-metrics",children:[((v=t.metrics)==null?void 0:v.tokensTotal)!=null?o.jsxs("span",{children:[t.metrics.tokensTotal," tok"]}):null,t.durationMs!=null?o.jsxs("span",{children:[t.durationMs,"ms"]}):null,a?o.jsx("span",{children:a}):null]})]})}const ie={stepNode:ae},re={structure:!0,sequence:!1,io:!0};function $(s){return s.filter(t=>t.parentStepId).map(t=>({id:`structure_${t.parentStepId}_${t.id}`,source:t.parentStepId,target:t.id,kind:"structure"}))}function C(s){const t=[...s].sort((i,n)=>i.index-n.index),a=[];for(let i=1;i<t.length;i+=1)a.push({id:`sequence_${t[i-1].id}_${t[i].id}`,source:t[i-1].id,target:t[i].id,kind:"sequence"});return a}function le({steps:s,onSelectStep:t,selectedStepId:a,baseTrace:i,compareTrace:n,compareSteps:d=[],overlayEnabled:c,onToggleOverlay:p}){var W,X;const[h,m]=l.useState(re),[f,x]=l.useState(s.length>500),[w,v]=l.useState({x:0,y:0,zoom:1}),S=l.useRef(null),E=l.useRef(w),y=l.useRef(null);l.useEffect(()=>{s.length<=500&&x(!1)},[s.length]),l.useEffect(()=>()=>{y.current&&cancelAnimationFrame(y.current)},[]);const O=l.useMemo(()=>{const e=$(s),u=C(s),g=N(s),k=[];return h.structure&&k.push(...e),h.sequence&&k.push(...u),h.io&&k.push(...g),k},[s,h]),q=l.useMemo(()=>{const e=$(s),u=C(s),g=N(s);return[...e,...u,...g]},[s]),P=l.useMemo(()=>Y(s,q.map(e=>({source:e.source,target:e.target})),i.id),[s,q,i.id]),r=l.useMemo(()=>n?te(i,n):null,[i,n]),B=l.useMemo(()=>new Set((r==null?void 0:r.addedSteps)??[]),[r]),V=l.useMemo(()=>new Set((r==null?void 0:r.changedSteps)??[]),[r]),z=l.useMemo(()=>new Set((r==null?void 0:r.removedSteps)??[]),[r]),A=new Map(P.map(e=>[e.id,e.position])),M=s.map(e=>({id:e.id,type:"stepNode",position:A.get(e.id)??{x:0,y:0},data:{step:e,diffStatus:V.has(e.id)?"changed":z.has(e.id)?"removed":null,ghost:!1}})),D=M.map(e=>({id:e.id,x:e.position.x,y:e.position.y,width:220,height:120})),H={width:((W=S.current)==null?void 0:W.clientWidth)??0,height:((X=S.current)==null?void 0:X.clientHeight)??0},I=new Map(M.map(e=>[e.id,e]));let b=f?oe(D,w,H,300).map(e=>I.get(e.id)):[...M];const j=new Set(b.filter(Boolean).map(e=>e.id));if(a&&!j.has(a)){const e=I.get(a);e&&(j.add(e.id),b=[...b,e])}const U=O.filter(e=>j.has(e.source)&&j.has(e.target)).map(e=>({id:e.id,source:e.source,target:e.target,type:"smoothstep",animated:e.kind==="io",style:e.kind==="io"?{stroke:"var(--accent-io)",strokeWidth:2}:e.kind==="sequence"?{stroke:"var(--accent-sequence)",strokeDasharray:"6 6"}:{stroke:"var(--accent-structure)"}})),L=b.filter(Boolean).map(e=>({...e})),R=l.useMemo(()=>{if(!n)return[];const e=$(n.steps),u=C(n.steps),g=N(n.steps);return[...e,...u,...g]},[n]),F=l.useMemo(()=>n?Y(n.steps,R.map(e=>({source:e.source,target:e.target})),n.id):[],[n,R]),_=l.useMemo(()=>new Map(F.map(e=>[e.id,e.position])),[F]),G=l.useMemo(()=>!n||!c?[]:d.filter(e=>B.has(e.id)).map(e=>({id:`ghost-${e.id}`,type:"stepNode",position:_.get(e.id)??{x:0,y:0},data:{step:e,diffStatus:"added",ghost:!0}})),[n,d,_,B,c]);return o.jsxs("div",{className:"flow-mode",children:[o.jsxs("div",{className:"flow-controls","data-help":!0,"data-help-title":"Flow controls","data-help-body":"Toggle edge layers and windowing for high-density graphs.","data-help-placement":"bottom",children:[o.jsx(ne,{layers:h,onChange:m}),s.length>500?o.jsxs("label",{className:"toggle",title:"Window nodes based on viewport for large graphs","data-help":!0,"data-help-title":"Windowed flow","data-help-body":"Limits the graph to the visible region for performance.","data-help-placement":"bottom",children:[o.jsx("input",{type:"checkbox",checked:f,onChange:()=>x(e=>!e)}),"Windowed"]}):null,n?o.jsxs("button",{className:"ghost-button",type:"button",onClick:p,title:"Show or hide ghost overlay from replay","data-help":!0,"data-help-title":"Overlay diff","data-help-body":"Layer the replay on top to see what changed.","data-help-placement":"bottom",children:[c?"Hide overlay":"Show overlay"," (",(r==null?void 0:r.addedSteps.length)??0,"/",(r==null?void 0:r.removedSteps.length)??0,"/",(r==null?void 0:r.changedSteps.length)??0,")"]}):null]}),o.jsx("div",{className:"flow-canvas",ref:S,"data-help":!0,"data-help-indicator":!0,"data-help-title":"Flow canvas","data-help-body":"A spatial map of step dependencies. Click nodes to inspect.","data-help-placement":"top",children:o.jsxs(J,{nodes:c?[...L,...G]:L,edges:U,nodeTypes:ie,onNodeClick:(e,u)=>{const g=u.id.startsWith("ghost-")?u.id.replace("ghost-",""):u.id;t(g)},onMove:(e,u)=>{E.current=u,!y.current&&(y.current=requestAnimationFrame(()=>{v(E.current),y.current=null}))},fitView:!0,children:[o.jsx(K,{nodeColor:e=>{switch(e.data.step.type){case"llm_call":return"var(--accent-llm)";case"tool_call":return"var(--accent-tool)";case"decision":return"var(--accent-decision)";case"handoff":return"var(--accent-handoff)";case"guardrail":return"var(--accent-guardrail)";default:return"var(--accent-structure)"}},maskColor:"rgba(15, 17, 21, 0.6)"}),o.jsx(Q,{gap:20}),o.jsx(Z,{position:"bottom-right"})]})})]})}function he({steps:s,onSelectStep:t,selectedStepId:a,baseTrace:i,compareTrace:n,compareSteps:d,overlayEnabled:c,onToggleOverlay:p}){return o.jsx("section",{className:"flow-mode-wrapper","aria-label":"Flow mode",children:o.jsx(le,{steps:s,selectedStepId:a,onSelectStep:t,baseTrace:i,compareTrace:n,compareSteps:d,overlayEnabled:c,onToggleOverlay:p})})}export{he as default};
